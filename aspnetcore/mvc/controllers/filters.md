---
title: "Фильтры"
author: ardalis
description: "Узнайте, как *фильтры* работы и способ их использования в ASP.NET Core MVC."
ms.author: tdykstra
manager: wpickett
ms.date: 12/12/2016
ms.topic: article
ms.technology: aspnet
ms.prod: asp.net-core
uid: mvc/controllers/filters
ms.openlocfilehash: 32bfddde48f5e5de9c06cb159493eb9ba6ede8be
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2018
---
# <a name="filters"></a><span data-ttu-id="10d0a-103">Фильтры</span><span class="sxs-lookup"><span data-stu-id="10d0a-103">Filters</span></span>

<span data-ttu-id="10d0a-104">По [Tom Dykstra](https://github.com/tdykstra/) и [Стив Смит](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="10d0a-104">By [Tom Dykstra](https://github.com/tdykstra/) and [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="10d0a-105">*Фильтры* в ASP.NET Core MVC позволяют выполнить код до или после определенных этапов в конвейер обработки запросов.</span><span class="sxs-lookup"><span data-stu-id="10d0a-105">*Filters* in ASP.NET Core MVC allow you to run code before or after certain stages in the request processing pipeline.</span></span>

 <span data-ttu-id="10d0a-106">Встроенные фильтры дескриптор задач, таких как авторизации (ограничивая его доступ к ресурсам, которые пользователь не имеет разрешения для), гарантируя, что все запросы использовать HTTPS и ответ, кэширование (сокращенные вычисления конвейер обработки запросов для возврата кэшированного ответа).</span><span class="sxs-lookup"><span data-stu-id="10d0a-106">Built-in filters handle tasks such as authorization (preventing access to resources a user isn't authorized for), ensuring that all requests use HTTPS, and response caching (short-circuiting the request pipeline to return a cached response).</span></span> 

<span data-ttu-id="10d0a-107">Можно создать пользовательские фильтры для обработки проблем с перекрестными приложения.</span><span class="sxs-lookup"><span data-stu-id="10d0a-107">You can create custom filters to handle cross-cutting concerns for your application.</span></span> <span data-ttu-id="10d0a-108">Каждый раз, когда вы хотите избежать дублирования кода для действий, фильтры являются решением.</span><span class="sxs-lookup"><span data-stu-id="10d0a-108">Anytime you want to avoid duplicating code across actions, filters are the solution.</span></span> <span data-ttu-id="10d0a-109">Например можно объединить код обработки ошибок в фильтр исключений.</span><span class="sxs-lookup"><span data-stu-id="10d0a-109">For example, you can consolidate error handling code in a exception filter.</span></span>

<span data-ttu-id="10d0a-110">[Просмотреть или загрузить пример из GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span><span class="sxs-lookup"><span data-stu-id="10d0a-110">[View or download sample from GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span></span>

## <a name="how-do-filters-work"></a><span data-ttu-id="10d0a-111">Как работают фильтры</span><span class="sxs-lookup"><span data-stu-id="10d0a-111">How do filters work?</span></span>

<span data-ttu-id="10d0a-112">Фильтры выполняются в рамках *конвейера вызова действия MVC*, которые иногда называются *конвейера фильтра*.</span><span class="sxs-lookup"><span data-stu-id="10d0a-112">Filters run within the *MVC action invocation pipeline*, sometimes referred to as the *filter pipeline*.</span></span>  <span data-ttu-id="10d0a-113">Фильтр-конвейер запускается после MVC выбирает действие для выполнения.</span><span class="sxs-lookup"><span data-stu-id="10d0a-113">The filter pipeline runs after MVC selects the action to execute.</span></span>

![Запрос обрабатывается через другие по промежуточного слоя, маршрутизация по промежуточного слоя, Выбор действия и конвейера вызова действия MVC.](filters/_static/filter-pipeline-1.png)

### <a name="filter-types"></a><span data-ttu-id="10d0a-116">Типы фильтров</span><span class="sxs-lookup"><span data-stu-id="10d0a-116">Filter types</span></span>

<span data-ttu-id="10d0a-117">Каждый тип фильтра выполняется на различных этапах конвейера фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-117">Each filter type is executed at a different stage in the filter pipeline.</span></span>

* <span data-ttu-id="10d0a-118">[Фильтры авторизации](#authorization-filters) выполняются первыми, а также используются для определения, является ли текущий пользователь имеет права для текущего запроса.</span><span class="sxs-lookup"><span data-stu-id="10d0a-118">[Authorization filters](#authorization-filters) run first and are used to determine whether the current user is authorized for the current request.</span></span> <span data-ttu-id="10d0a-119">Они могут сокращенным конвейера, если запрос не авторизован.</span><span class="sxs-lookup"><span data-stu-id="10d0a-119">They can short-circuit the pipeline if a request is unauthorized.</span></span> 

* <span data-ttu-id="10d0a-120">[Фильтры ресурсов](#resource-filters) применяются в первую очередь для обработки запроса после авторизации.</span><span class="sxs-lookup"><span data-stu-id="10d0a-120">[Resource filters](#resource-filters) are the first to handle a request after authorization.</span></span>  <span data-ttu-id="10d0a-121">Они могут выполняться код перед rest конвейера фильтра, а после завершения оставшуюся часть конвейера.</span><span class="sxs-lookup"><span data-stu-id="10d0a-121">They can run code before the rest of the filter pipeline, and after the rest of the pipeline has completed.</span></span> <span data-ttu-id="10d0a-122">Они используются для реализации кэширования или в противном случае краткой записи конвейера фильтра для повышения производительности.</span><span class="sxs-lookup"><span data-stu-id="10d0a-122">They're useful to implement caching or otherwise short-circuit the filter pipeline for performance reasons.</span></span> <span data-ttu-id="10d0a-123">Так как они выполняться до привязки модели, они полезны для все, что необходимо для оказания влияния на привязки модели.</span><span class="sxs-lookup"><span data-stu-id="10d0a-123">Since they run before model binding, they're useful for anything that needs to influence model binding.</span></span>

* <span data-ttu-id="10d0a-124">[Фильтры действий](#action-filters) может выполнять код непосредственно перед и после вызова метода отдельные действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-124">[Action filters](#action-filters) can run code immediately before and after an individual action method is called.</span></span> <span data-ttu-id="10d0a-125">Они могут использоваться для управления аргументы, передаваемые в действие и результат, возвращаемый из действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-125">They can be used to manipulate the arguments passed into an action and the result returned from the action.</span></span>

* <span data-ttu-id="10d0a-126">[Фильтры исключений](#exception-filters) применяются для глобальных политик для необработанных исключений, возникающих до ничего записан в тексте ответа.</span><span class="sxs-lookup"><span data-stu-id="10d0a-126">[Exception filters](#exception-filters) are used to apply global policies to unhandled exceptions that occur before anything has been written to the response body.</span></span>

* <span data-ttu-id="10d0a-127">[Привести фильтры](#result-filters) можно запустить код непосредственно перед и после выполнения результаты отдельных действий.</span><span class="sxs-lookup"><span data-stu-id="10d0a-127">[Result filters](#result-filters) can run code immediately before and after the execution of individual action results.</span></span> <span data-ttu-id="10d0a-128">Они только при успешном выполнении метода действия и полезны для логики, необходимо заключать выполнения представления или модуля форматирования.</span><span class="sxs-lookup"><span data-stu-id="10d0a-128">They run only when the action method has executed successfully and are useful for logic that must surround view or formatter execution.</span></span>

<span data-ttu-id="10d0a-129">На следующей диаграмме показан, как взаимодействуют эти типы фильтров в конвейере фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-129">The following diagram shows how these filter types interact in the filter pipeline.</span></span>

![Запрос обрабатывается через фильтры авторизации, фильтры ресурсов, привязки модели, фильтры действий, выполнение действия и преобразование результата действия, фильтры исключений, фильтры результатов и результат выполнения.](filters/_static/filter-pipeline-2.png)

## <a name="implementation"></a><span data-ttu-id="10d0a-132">Реализация</span><span class="sxs-lookup"><span data-stu-id="10d0a-132">Implementation</span></span>

<span data-ttu-id="10d0a-133">Фильтры поддерживает синхронные и асинхронные реализации, посредством определения другой интерфейс.</span><span class="sxs-lookup"><span data-stu-id="10d0a-133">Filters support both synchronous and asynchronous implementations through different interface definitions.</span></span> <span data-ttu-id="10d0a-134">Выберите вариант async или синхронизации в зависимости от типа задачи, которую необходимо выполнить.</span><span class="sxs-lookup"><span data-stu-id="10d0a-134">Choose either the sync or async variant depending on the kind of task you need to perform.</span></span> 

<span data-ttu-id="10d0a-135">Код синхронной фильтры, которые могут выполняться оба до и после их этап конвейера определить на*рабочей области*выполнение и на*этапа*выполнения методов.</span><span class="sxs-lookup"><span data-stu-id="10d0a-135">Synchronous filters that can run code both before and after their pipeline stage define On*Stage*Executing and On*Stage*Executed methods.</span></span> <span data-ttu-id="10d0a-136">Например `OnActionExecuting` вызывается перед вызовом метода действия и `OnActionExecuted` вызывается после метода действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-136">For example, `OnActionExecuting` is called before the action method is called, and `OnActionExecuted` is called after the action method returns.</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleActionFilter.cs?highlight=6,8,13)]

<span data-ttu-id="10d0a-137">Асинхронные фильтры определяют один на*этапа*ExecutionAsync метод.</span><span class="sxs-lookup"><span data-stu-id="10d0a-137">Asynchronous filters define a single On*Stage*ExecutionAsync method.</span></span> <span data-ttu-id="10d0a-138">Этот метод принимает *FilterType*ExecutionDelegate делегат, который выполняет этап конвейера фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-138">This method takes a *FilterType*ExecutionDelegate delegate which executes the filter's pipeline stage.</span></span> <span data-ttu-id="10d0a-139">Например `ActionExecutionDelegate` вызовы метода действия и могут выполнять код до и после его вызова.</span><span class="sxs-lookup"><span data-stu-id="10d0a-139">For example, `ActionExecutionDelegate` calls the action method, and you can execute code before and after you call it.</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleAsyncActionFilter.cs?highlight=6,8-10,13)]

<span data-ttu-id="10d0a-140">Для нескольких этапов фильтр в одном классе могут реализовывать интерфейсы.</span><span class="sxs-lookup"><span data-stu-id="10d0a-140">You can implement interfaces for multiple filter stages in a single class.</span></span> <span data-ttu-id="10d0a-141">Например [ActionFilterAttribute](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionfilterattribute) абстрактный класс реализует интерфейс `IActionFilter` и `IResultFilter`, а также их асинхронные эквиваленты.</span><span class="sxs-lookup"><span data-stu-id="10d0a-141">For example, the [ActionFilterAttribute](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionfilterattribute) abstract class implements both `IActionFilter` and `IResultFilter`, as well as their async equivalents.</span></span>

> [!NOTE]
> <span data-ttu-id="10d0a-142">Реализуйте **либо** синхронной или асинхронной версии интерфейса фильтр, который не оба.</span><span class="sxs-lookup"><span data-stu-id="10d0a-142">Implement **either** the synchronous or the async version of a filter interface, not both.</span></span> <span data-ttu-id="10d0a-143">Платформа сначала проверяет ли фильтр реализует асинхронный интерфейс, и если да, он вызывает.</span><span class="sxs-lookup"><span data-stu-id="10d0a-143">The framework checks first to see if the filter implements the async interface, and if so, it calls that.</span></span> <span data-ttu-id="10d0a-144">В противном случае она вызывает интерфейс синхронные методы.</span><span class="sxs-lookup"><span data-stu-id="10d0a-144">If not, it calls the synchronous interface's method(s).</span></span> <span data-ttu-id="10d0a-145">Если для реализации обоих интерфейсов на один класс, называется асинхронного метода.</span><span class="sxs-lookup"><span data-stu-id="10d0a-145">If you were to implement both interfaces on one class, only the async method would be called.</span></span> <span data-ttu-id="10d0a-146">При использовании абстрактных классов, таких как [ActionFilterAttribute](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionfilterattribute) нужно переопределить только синхронных методов или асинхронного метода для каждого типа.</span><span class="sxs-lookup"><span data-stu-id="10d0a-146">When using abstract classes like [ActionFilterAttribute](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionfilterattribute) you would override only the synchronous methods or the async method for each filter type.</span></span>

### <a name="ifilterfactory"></a><span data-ttu-id="10d0a-147">IFilterFactory</span><span class="sxs-lookup"><span data-stu-id="10d0a-147">IFilterFactory</span></span>

<span data-ttu-id="10d0a-148">Объект `IFilterFactory` реализует интерфейс `IFilter`.</span><span class="sxs-lookup"><span data-stu-id="10d0a-148">`IFilterFactory` implements `IFilter`.</span></span> <span data-ttu-id="10d0a-149">Таким образом `IFilterFactory` экземпляр можно использовать в качестве `IFilter` экземпляра в любом месте конвейера фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-149">Therefore, an `IFilterFactory` instance can be used as an `IFilter` instance anywhere in the filter pipeline.</span></span> <span data-ttu-id="10d0a-150">Когда платформа готовится для вызова фильтра, попытается выполнить приведение к типу `IFilterFactory`.</span><span class="sxs-lookup"><span data-stu-id="10d0a-150">When the framework prepares to invoke the filter, it attempts to cast it to an `IFilterFactory`.</span></span> <span data-ttu-id="10d0a-151">Если этот приведение выполнено успешно, `CreateInstance` вызов метода для создания `IFilter` экземпляр, который будет вызываться.</span><span class="sxs-lookup"><span data-stu-id="10d0a-151">If that cast succeeds, the `CreateInstance` method is called to create the `IFilter` instance that will be invoked.</span></span> <span data-ttu-id="10d0a-152">Это обеспечивает очень гибким, поскольку конвейера точный фильтр не должно быть задано явным образом при запуске приложения.</span><span class="sxs-lookup"><span data-stu-id="10d0a-152">This provides a very flexible design, since the precise filter pipeline doesn't need to be set explicitly when the application starts.</span></span>

<span data-ttu-id="10d0a-153">Можно реализовать `IFilterFactory` в реализациях атрибут как другой подход к созданию фильтров:</span><span class="sxs-lookup"><span data-stu-id="10d0a-153">You can implement `IFilterFactory` on your own attribute implementations as another approach to creating filters:</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/AddHeaderWithFactoryAttribute.cs?name=snippet_IFilterFactory&highlight=1,4,5,6,7)]

### <a name="built-in-filter-attributes"></a><span data-ttu-id="10d0a-154">Встроенный фильтр атрибутов</span><span class="sxs-lookup"><span data-stu-id="10d0a-154">Built-in filter attributes</span></span>

<span data-ttu-id="10d0a-155">Платформа включает встроенные фильтры на основе атрибутов, можно создать подкласс и настройки.</span><span class="sxs-lookup"><span data-stu-id="10d0a-155">The framework includes built-in attribute-based filters that you can subclass and customize.</span></span> <span data-ttu-id="10d0a-156">Например следующий результат фильтр добавляет заголовок ответа.</span><span class="sxs-lookup"><span data-stu-id="10d0a-156">For example, the following Result filter adds a header to the response.</span></span>

<a name="add-header-attribute"></a>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/AddHeaderAttribute.cs?highlight=5,16)]

<span data-ttu-id="10d0a-157">Атрибуты позволяют фильтры, чтобы принимать аргументы, как показано в приведенном выше примере.</span><span class="sxs-lookup"><span data-stu-id="10d0a-157">Attributes allow filters to accept arguments, as shown in the example above.</span></span> <span data-ttu-id="10d0a-158">Бы добавить этот атрибут к контроллеру или методу действия и укажите имя и значение заголовка HTTP.</span><span class="sxs-lookup"><span data-stu-id="10d0a-158">You would add this attribute to a controller or action method and specify the name and value of the HTTP header:</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Controllers/SampleController.cs?name=snippet_AddHeader&highlight=1)]

<span data-ttu-id="10d0a-159">Результат `Index` действия приведен ниже — на нижнем правом углу отображаются заголовки ответа.</span><span class="sxs-lookup"><span data-stu-id="10d0a-159">The result of the `Index` action is shown below - the response headers are displayed on the bottom right.</span></span>

![Разработчик от средства из Microsoft Edge отображение заголовки ответа, включая автор Стив Смит@ardalis](filters/_static/add-header.png)

<span data-ttu-id="10d0a-161">Некоторые из интерфейсов фильтра имеют соответствующих атрибутов, которые могут использоваться как базовые классы для пользовательских реализаций.</span><span class="sxs-lookup"><span data-stu-id="10d0a-161">Several of the filter interfaces have corresponding attributes that can be used as base classes for custom implementations.</span></span>

<span data-ttu-id="10d0a-162">Атрибуты фильтра:</span><span class="sxs-lookup"><span data-stu-id="10d0a-162">Filter attributes:</span></span>

* `ActionFilterAttribute`
* `ExceptionFilterAttribute`
* `ResultFilterAttribute`
* `FormatFilterAttribute`
* `ServiceFilterAttribute`
* `TypeFilterAttribute`

<span data-ttu-id="10d0a-163">`TypeFilterAttribute`и `ServiceFilterAttribute` объясняются [далее в этой статье](#dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="10d0a-163">`TypeFilterAttribute` and `ServiceFilterAttribute` are explained [later in this article](#dependency-injection).</span></span>

## <a name="filter-scopes-and-order-of-execution"></a><span data-ttu-id="10d0a-164">Фильтр области и порядок выполнения</span><span class="sxs-lookup"><span data-stu-id="10d0a-164">Filter scopes and order of execution</span></span>

<span data-ttu-id="10d0a-165">Фильтр можно добавить в конвейер, в одном из трех *областей*.</span><span class="sxs-lookup"><span data-stu-id="10d0a-165">A filter can be added to the pipeline at one of three *scopes*.</span></span> <span data-ttu-id="10d0a-166">Можно добавить фильтр к методу определенного действия или в класс контроллера с помощью атрибута.</span><span class="sxs-lookup"><span data-stu-id="10d0a-166">You can add a filter to a particular action method or to a controller class by using an attribute.</span></span> <span data-ttu-id="10d0a-167">Или можно зарегистрировать фильтр глобально (для всех контроллеров и действий) путем добавления его в `MvcOptions.Filters` коллекции в `ConfigureServices` метод `Startup` класса:</span><span class="sxs-lookup"><span data-stu-id="10d0a-167">Or you can register a filter globally (for all controllers and actions) by adding it to the `MvcOptions.Filters` collection in the `ConfigureServices` method in the `Startup` class:</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Startup.cs?name=snippet_ConfigureServices&highlight=5-8)]

### <a name="default-order-of-execution"></a><span data-ttu-id="10d0a-168">По умолчанию порядок выполнения</span><span class="sxs-lookup"><span data-stu-id="10d0a-168">Default order of execution</span></span>

<span data-ttu-id="10d0a-169">При наличии нескольких фильтров для определенного этапа конвейера, область определяет порядок выполнения фильтров по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="10d0a-169">When there are multiple filters for a particular stage of the pipeline, scope determines the default order of filter execution.</span></span>  <span data-ttu-id="10d0a-170">Глобальные фильтры заключить классов фильтров, которые в свою очередь заключить метод фильтры.</span><span class="sxs-lookup"><span data-stu-id="10d0a-170">Global filters surround class filters, which in turn surround method filters.</span></span> <span data-ttu-id="10d0a-171">Это иногда называется вложенности «Русский фигурку», как любое такое расширение области окружает предыдущей области, например [вложенности фигурку](https://wikipedia.org/wiki/Matryoshka_doll).</span><span class="sxs-lookup"><span data-stu-id="10d0a-171">This is sometimes referred to as "Russian doll" nesting, as each increase in scope is wrapped around the previous scope, like a [nesting doll](https://wikipedia.org/wiki/Matryoshka_doll).</span></span> <span data-ttu-id="10d0a-172">Обычно вы получаете требуемого поведения переопределения без необходимости явно определить упорядочение.</span><span class="sxs-lookup"><span data-stu-id="10d0a-172">You generally get the desired overriding behavior without having to explicitly determine ordering.</span></span>

<span data-ttu-id="10d0a-173">В результате такая вложенность *после* код фильтров выполняется в порядке, обратном порядку *перед* кода.</span><span class="sxs-lookup"><span data-stu-id="10d0a-173">As a result of this nesting, the *after* code of filters runs in the reverse order of the *before* code.</span></span> <span data-ttu-id="10d0a-174">Последовательность выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="10d0a-174">The sequence looks like this:</span></span>

* <span data-ttu-id="10d0a-175">*Перед* кода глобально фильтров</span><span class="sxs-lookup"><span data-stu-id="10d0a-175">The *before* code of filters applied globally</span></span>
  * <span data-ttu-id="10d0a-176">*Перед* кода фильтров, применяемых к контроллерам</span><span class="sxs-lookup"><span data-stu-id="10d0a-176">The *before* code of filters applied to controllers</span></span>
    * <span data-ttu-id="10d0a-177">*Перед* код фильтров, примененных к методам действий</span><span class="sxs-lookup"><span data-stu-id="10d0a-177">The *before* code of filters applied to action methods</span></span>
    * <span data-ttu-id="10d0a-178">*После* код фильтров, примененных к методам действий</span><span class="sxs-lookup"><span data-stu-id="10d0a-178">The *after* code of filters applied to action methods</span></span>
  * <span data-ttu-id="10d0a-179">*После* кода фильтров, применяемых к контроллерам</span><span class="sxs-lookup"><span data-stu-id="10d0a-179">The *after* code of filters applied to controllers</span></span>
* <span data-ttu-id="10d0a-180">*После* кода глобально фильтров</span><span class="sxs-lookup"><span data-stu-id="10d0a-180">The *after* code of filters applied globally</span></span>
  
<span data-ttu-id="10d0a-181">Ниже приведен пример, в котором показан порядок вызова методов какой фильтр синхронной фильтров действий.</span><span class="sxs-lookup"><span data-stu-id="10d0a-181">Here's an example that illustrates the order in which filter methods are called for synchronous Action filters.</span></span>

| <span data-ttu-id="10d0a-182">Sequence</span><span class="sxs-lookup"><span data-stu-id="10d0a-182">Sequence</span></span> | <span data-ttu-id="10d0a-183">Область фильтра</span><span class="sxs-lookup"><span data-stu-id="10d0a-183">Filter scope</span></span> | <span data-ttu-id="10d0a-184">Метод Filter</span><span class="sxs-lookup"><span data-stu-id="10d0a-184">Filter method</span></span> |
|:--------:|:------------:|:-------------:|
| <span data-ttu-id="10d0a-185">1</span><span class="sxs-lookup"><span data-stu-id="10d0a-185">1</span></span> | <span data-ttu-id="10d0a-186">Global</span><span class="sxs-lookup"><span data-stu-id="10d0a-186">Global</span></span> | `OnActionExecuting` |
| <span data-ttu-id="10d0a-187">2</span><span class="sxs-lookup"><span data-stu-id="10d0a-187">2</span></span> | <span data-ttu-id="10d0a-188">Контроллер</span><span class="sxs-lookup"><span data-stu-id="10d0a-188">Controller</span></span> | `OnActionExecuting` |
| <span data-ttu-id="10d0a-189">3</span><span class="sxs-lookup"><span data-stu-id="10d0a-189">3</span></span> | <span data-ttu-id="10d0a-190">Метод</span><span class="sxs-lookup"><span data-stu-id="10d0a-190">Method</span></span> | `OnActionExecuting` |
| <span data-ttu-id="10d0a-191">4</span><span class="sxs-lookup"><span data-stu-id="10d0a-191">4</span></span> | <span data-ttu-id="10d0a-192">Метод</span><span class="sxs-lookup"><span data-stu-id="10d0a-192">Method</span></span> | `OnActionExecuted` |
| <span data-ttu-id="10d0a-193">5</span><span class="sxs-lookup"><span data-stu-id="10d0a-193">5</span></span> | <span data-ttu-id="10d0a-194">Контроллер</span><span class="sxs-lookup"><span data-stu-id="10d0a-194">Controller</span></span> | `OnActionExecuted` |
| <span data-ttu-id="10d0a-195">6</span><span class="sxs-lookup"><span data-stu-id="10d0a-195">6</span></span> | <span data-ttu-id="10d0a-196">Global</span><span class="sxs-lookup"><span data-stu-id="10d0a-196">Global</span></span> | `OnActionExecuted` |

<span data-ttu-id="10d0a-197">Эта последовательность показывает, что метод фильтра, вложенные в контроллер фильтр, и вложенный фильтр контроллера в глобальный фильтр.</span><span class="sxs-lookup"><span data-stu-id="10d0a-197">This sequence shows that the method filter is nested within the controller filter, and the controller filter is nested within the global filter.</span></span> <span data-ttu-id="10d0a-198">Вставить другой способом, если вы внутри фильтр async,*этапа*метод ExecutionAsync все фильтры с более тесную областью время выполнения кода в стеке.</span><span class="sxs-lookup"><span data-stu-id="10d0a-198">To put it another way, if you're inside an async filter's On*Stage*ExecutionAsync method, all of the filters with a tighter scope run while your code is on the stack.</span></span>

> [!NOTE]
> <span data-ttu-id="10d0a-199">Каждый контроллер, который наследует от `Controller` базового класса включает `OnActionExecuting` и `OnActionExecuted` методы.</span><span class="sxs-lookup"><span data-stu-id="10d0a-199">Every controller that inherits from the `Controller` base class includes `OnActionExecuting` and `OnActionExecuted` methods.</span></span> <span data-ttu-id="10d0a-200">Эти методы wrap фильтров, запустите для выполнения данного действия: `OnActionExecuting` вызывается перед любые фильтры, и `OnActionExecuted` вызывается после все фильтры.</span><span class="sxs-lookup"><span data-stu-id="10d0a-200">These methods wrap the filters that run for a given action:  `OnActionExecuting` is called before any of the filters, and `OnActionExecuted` is called after all of the filters.</span></span>

### <a name="overriding-the-default-order"></a><span data-ttu-id="10d0a-201">Переопределение порядок по умолчанию</span><span class="sxs-lookup"><span data-stu-id="10d0a-201">Overriding the default order</span></span>

<span data-ttu-id="10d0a-202">Последовательность выполнения по умолчанию можно переопределить путем реализации `IOrderedFilter`.</span><span class="sxs-lookup"><span data-stu-id="10d0a-202">You can override the default sequence of execution by implementing `IOrderedFilter`.</span></span> <span data-ttu-id="10d0a-203">Этот интерфейс предоставляет `Order` свойство, которое имеет приоритет над областью для определения порядка выполнения.</span><span class="sxs-lookup"><span data-stu-id="10d0a-203">This interface exposes an `Order` property that takes precedence over scope to determine the order of execution.</span></span> <span data-ttu-id="10d0a-204">Фильтр с более низким `Order` будет иметь значение его *перед* код, выполняемый до, фильтр с более высокого значения `Order`.</span><span class="sxs-lookup"><span data-stu-id="10d0a-204">A filter with a lower `Order` value will have its *before* code executed before that of a filter with a higher value of `Order`.</span></span> <span data-ttu-id="10d0a-205">Фильтр с более низким `Order` будет иметь значение его *после* код, выполняемый после этого фильтра с более высоким `Order` значение.</span><span class="sxs-lookup"><span data-stu-id="10d0a-205">A filter with a lower `Order` value will have its *after* code executed after that of a filter with a higher `Order` value.</span></span> <span data-ttu-id="10d0a-206">Можно задать `Order` свойства с помощью параметра конструктора:</span><span class="sxs-lookup"><span data-stu-id="10d0a-206">You can set the `Order` property by using a constructor parameter:</span></span>

```csharp
[MyFilter(Name = "Controller Level Attribute", Order=1)]
```

<span data-ttu-id="10d0a-207">Если же 3 показано в предыдущем примере, но набор фильтров `Order` свойства контроллера и глобальные фильтры, 1 и 2 соответственно, применяются в зеркальном отображении порядок выполнения.</span><span class="sxs-lookup"><span data-stu-id="10d0a-207">If you have the same 3 Action filters shown in the preceding example but set the `Order` property of the controller and global filters to 1 and 2 respectively, the order of execution would be reversed.</span></span>

| <span data-ttu-id="10d0a-208">Sequence</span><span class="sxs-lookup"><span data-stu-id="10d0a-208">Sequence</span></span> | <span data-ttu-id="10d0a-209">Область фильтра</span><span class="sxs-lookup"><span data-stu-id="10d0a-209">Filter scope</span></span> | <span data-ttu-id="10d0a-210">Свойство `Order`</span><span class="sxs-lookup"><span data-stu-id="10d0a-210">`Order` property</span></span> | <span data-ttu-id="10d0a-211">Метод Filter</span><span class="sxs-lookup"><span data-stu-id="10d0a-211">Filter method</span></span> |
|:--------:|:------------:|:-----------------:|:-------------:|
| <span data-ttu-id="10d0a-212">1</span><span class="sxs-lookup"><span data-stu-id="10d0a-212">1</span></span> | <span data-ttu-id="10d0a-213">Метод</span><span class="sxs-lookup"><span data-stu-id="10d0a-213">Method</span></span> | <span data-ttu-id="10d0a-214">0</span><span class="sxs-lookup"><span data-stu-id="10d0a-214">0</span></span> | `OnActionExecuting` |
| <span data-ttu-id="10d0a-215">2</span><span class="sxs-lookup"><span data-stu-id="10d0a-215">2</span></span> | <span data-ttu-id="10d0a-216">Контроллер</span><span class="sxs-lookup"><span data-stu-id="10d0a-216">Controller</span></span> | <span data-ttu-id="10d0a-217">1</span><span class="sxs-lookup"><span data-stu-id="10d0a-217">1</span></span>  | `OnActionExecuting` |
| <span data-ttu-id="10d0a-218">3</span><span class="sxs-lookup"><span data-stu-id="10d0a-218">3</span></span> | <span data-ttu-id="10d0a-219">Global</span><span class="sxs-lookup"><span data-stu-id="10d0a-219">Global</span></span> | <span data-ttu-id="10d0a-220">2</span><span class="sxs-lookup"><span data-stu-id="10d0a-220">2</span></span>  | `OnActionExecuting` |
| <span data-ttu-id="10d0a-221">4</span><span class="sxs-lookup"><span data-stu-id="10d0a-221">4</span></span> | <span data-ttu-id="10d0a-222">Global</span><span class="sxs-lookup"><span data-stu-id="10d0a-222">Global</span></span> | <span data-ttu-id="10d0a-223">2</span><span class="sxs-lookup"><span data-stu-id="10d0a-223">2</span></span>  | `OnActionExecuted` |
| <span data-ttu-id="10d0a-224">5</span><span class="sxs-lookup"><span data-stu-id="10d0a-224">5</span></span> | <span data-ttu-id="10d0a-225">Контроллер</span><span class="sxs-lookup"><span data-stu-id="10d0a-225">Controller</span></span> | <span data-ttu-id="10d0a-226">1</span><span class="sxs-lookup"><span data-stu-id="10d0a-226">1</span></span>  | `OnActionExecuted` |
| <span data-ttu-id="10d0a-227">6</span><span class="sxs-lookup"><span data-stu-id="10d0a-227">6</span></span> | <span data-ttu-id="10d0a-228">Метод</span><span class="sxs-lookup"><span data-stu-id="10d0a-228">Method</span></span> | <span data-ttu-id="10d0a-229">0</span><span class="sxs-lookup"><span data-stu-id="10d0a-229">0</span></span>  | `OnActionExecuted` |

<span data-ttu-id="10d0a-230">`Order` Свойство важнее области при определении порядка выполнения фильтров.</span><span class="sxs-lookup"><span data-stu-id="10d0a-230">The `Order` property trumps scope when determining the order in which filters will run.</span></span> <span data-ttu-id="10d0a-231">Фильтры сортируются сначала по порядку, то область используется для разорвать связи.</span><span class="sxs-lookup"><span data-stu-id="10d0a-231">Filters are sorted first by order, then scope is used to break ties.</span></span> <span data-ttu-id="10d0a-232">Все встроенные фильтры реализуют `IOrderedFilter` и задать значение по умолчанию `Order` значение 0, поэтому области определяет порядок, если не задать `Order` ненулевое значение.</span><span class="sxs-lookup"><span data-stu-id="10d0a-232">All of the built-in filters implement `IOrderedFilter` and set the default `Order` value to 0, so scope determines order unless you set `Order` to a non-zero value.</span></span>

## <a name="cancellation-and-short-circuiting"></a><span data-ttu-id="10d0a-233">Отмена и сокращенное вычисление</span><span class="sxs-lookup"><span data-stu-id="10d0a-233">Cancellation and short circuiting</span></span>

<span data-ttu-id="10d0a-234">Краткой записи конвейера фильтра в любой момент, задав `Result` свойство `context` указанный параметр в метод фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-234">You can short-circuit the filter pipeline at any point by setting the `Result` property on the `context` parameter provided to the filter method.</span></span> <span data-ttu-id="10d0a-235">Для экземпляра следующий фильтр ресурсов предотвращает выполнение оставшуюся часть конвейера.</span><span class="sxs-lookup"><span data-stu-id="10d0a-235">For instance, the following Resource filter prevents the rest of the pipeline from executing.</span></span>

<a name="short-circuiting-resource-filter"></a>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/ShortCircuitingResourceFilterAttribute.cs?highlight=12,13,14,15)]

<span data-ttu-id="10d0a-236">В следующем коде показано как `ShortCircuitingResourceFilter` и `AddHeader` целевой фильтр `SomeResource` метода действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-236">In the following code, both the `ShortCircuitingResourceFilter` and the `AddHeader` filter target the `SomeResource` action method.</span></span> <span data-ttu-id="10d0a-237">Тем не менее так как `ShortCircuitingResourceFilter` выполняется первой (так как он является фильтром ресурсов и `AddHeader` имеет фильтр действий) и игнорирует оставшуюся часть конвейера, `AddHeader` фильтра никогда не будет работать для `SomeResource` действие.</span><span class="sxs-lookup"><span data-stu-id="10d0a-237">However, because the `ShortCircuitingResourceFilter` runs first (because it's a Resource Filter and `AddHeader` is an Action Filter) and short-circuits the rest of the pipeline, the `AddHeader` filter never runs for the `SomeResource` action.</span></span> <span data-ttu-id="10d0a-238">Это поведение останется таким же, если оба фильтра применяются на уровне метода действия, предоставляемые `ShortCircuitingResourceFilter` вначале (из-за его тип фильтра или явное использование `Order` свойства, например).</span><span class="sxs-lookup"><span data-stu-id="10d0a-238">This behavior would be the same if both filters were applied at the action method level, provided the `ShortCircuitingResourceFilter` ran first (because of its filter type, or explicit use of `Order` property, for instance).</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Controllers/SampleController.cs?name=snippet_AddHeader&highlight=1,9)]

## <a name="dependency-injection"></a><span data-ttu-id="10d0a-239">Внедрение зависимостей</span><span class="sxs-lookup"><span data-stu-id="10d0a-239">Dependency injection</span></span>

<span data-ttu-id="10d0a-240">Фильтры можно добавлять по типу или экземпляр.</span><span class="sxs-lookup"><span data-stu-id="10d0a-240">Filters can be added by type or by instance.</span></span> <span data-ttu-id="10d0a-241">При добавлении экземпляра, что экземпляр будет использоваться для каждого запроса.</span><span class="sxs-lookup"><span data-stu-id="10d0a-241">If you add an instance, that instance will be used for every request.</span></span> <span data-ttu-id="10d0a-242">При добавлении типа, он будет иметь тип активации, то есть экземпляр создается для каждого запроса и все зависимости конструктор будет взят из [внедрения зависимостей](../../fundamentals/dependency-injection.md) (DI).</span><span class="sxs-lookup"><span data-stu-id="10d0a-242">If you add a type, it will be type-activated, meaning an instance will be created for each request and any constructor dependencies will be populated by [dependency injection](../../fundamentals/dependency-injection.md) (DI).</span></span> <span data-ttu-id="10d0a-243">Добавление фильтра по типу эквивалентно `filters.Add(new TypeFilterAttribute(typeof(MyFilter)))`.</span><span class="sxs-lookup"><span data-stu-id="10d0a-243">Adding a filter by type is equivalent to `filters.Add(new TypeFilterAttribute(typeof(MyFilter)))`.</span></span>

<span data-ttu-id="10d0a-244">Фильтры, которые реализованы в виде атрибутов и добавляются непосредственно на контроллере классы или методы действия не может иметь конструктор зависимостей, предоставляемые [внедрения зависимостей](../../fundamentals/dependency-injection.md) (DI).</span><span class="sxs-lookup"><span data-stu-id="10d0a-244">Filters that are implemented as attributes and added directly to controller classes or action methods cannot have constructor dependencies provided by [dependency injection](../../fundamentals/dependency-injection.md) (DI).</span></span> <span data-ttu-id="10d0a-245">Это так, как атрибуты должны иметь их указано, где они применены параметры конструктора.</span><span class="sxs-lookup"><span data-stu-id="10d0a-245">This is because attributes must have their constructor parameters supplied where they're applied.</span></span> <span data-ttu-id="10d0a-246">Это ограничение принципов работы атрибутов.</span><span class="sxs-lookup"><span data-stu-id="10d0a-246">This is a limitation of how attributes work.</span></span>

<span data-ttu-id="10d0a-247">Если фильтры имеют зависимости, которые следует получить доступ с DI, существует несколько поддерживаемых подходов.</span><span class="sxs-lookup"><span data-stu-id="10d0a-247">If your filters have dependencies that you need to access from DI, there are several supported approaches.</span></span> <span data-ttu-id="10d0a-248">Можно применить фильтр методу класса или действие, с помощью одного из следующих:</span><span class="sxs-lookup"><span data-stu-id="10d0a-248">You can apply your filter to a class or action method using one of the following:</span></span>

* `ServiceFilterAttribute`
* `TypeFilterAttribute`
* <span data-ttu-id="10d0a-249">`IFilterFactory`реализован в атрибуте</span><span class="sxs-lookup"><span data-stu-id="10d0a-249">`IFilterFactory` implemented on your attribute</span></span>

> [!NOTE]
> <span data-ttu-id="10d0a-250">Одну зависимость, можно получить из DI — средство ведения журнала.</span><span class="sxs-lookup"><span data-stu-id="10d0a-250">One dependency you might want to get from DI is a logger.</span></span> <span data-ttu-id="10d0a-251">Однако следует избегать создания и использования фильтров исключительно в целях ведения журнала, поскольку [ведение журналов встроенная функция](xref:fundamentals/logging/index) уже всеми необходимыми.</span><span class="sxs-lookup"><span data-stu-id="10d0a-251">However, avoid creating and using filters purely for logging purposes, since the [built-in framework logging features](xref:fundamentals/logging/index) may already provide what you need.</span></span> <span data-ttu-id="10d0a-252">Если вы собираетесь добавить фильтры ведения журнала, следует обращать внимание на домен в бизнесе или поведение, характерное для фильтра, вместо действия MVC или другие события framework.</span><span class="sxs-lookup"><span data-stu-id="10d0a-252">If you're going to add logging to your filters, it should focus on business domain concerns or behavior specific to your filter, rather than MVC actions or other framework events.</span></span>

### <a name="servicefilterattribute"></a><span data-ttu-id="10d0a-253">ServiceFilterAttribute</span><span class="sxs-lookup"><span data-stu-id="10d0a-253">ServiceFilterAttribute</span></span>

<span data-ttu-id="10d0a-254">Объект `ServiceFilter` извлекает из DI экземпляр фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-254">A `ServiceFilter` retrieves an instance of the filter from DI.</span></span> <span data-ttu-id="10d0a-255">Добавить фильтр к контейнеру в `ConfigureServices`и ссылаться на него в `ServiceFilter` атрибута</span><span class="sxs-lookup"><span data-stu-id="10d0a-255">You add the filter to the container in `ConfigureServices`, and reference it in a `ServiceFilter` attribute</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Startup.cs?name=snippet_ConfigureServices&highlight=11)]

[!code-csharp[Main](../../mvc/controllers/filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_ServiceFilter&highlight=1)]

<span data-ttu-id="10d0a-256">С помощью `ServiceFilter` без регистрации результаты типа фильтра в исключение:</span><span class="sxs-lookup"><span data-stu-id="10d0a-256">Using `ServiceFilter` without registering the filter type results in an exception:</span></span>

```
System.InvalidOperationException: No service for type
'FiltersSample.Filters.AddHeaderFilterWithDI' has been registered.
```

<span data-ttu-id="10d0a-257">`ServiceFilterAttribute`реализует `IFilterFactory`, которая предоставляет один метод для создания `IFilter` экземпляра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-257">`ServiceFilterAttribute` implements `IFilterFactory`, which exposes a single method for creating an `IFilter` instance.</span></span> <span data-ttu-id="10d0a-258">В случае использования `ServiceFilterAttribute`, `IFilterFactory` интерфейса `CreateInstance` метод реализуется для загрузки указанного типа из контейнера служб (DI).</span><span class="sxs-lookup"><span data-stu-id="10d0a-258">In the case of `ServiceFilterAttribute`, the `IFilterFactory` interface's `CreateInstance` method is implemented to load the specified type from the services container (DI).</span></span>

### <a name="typefilterattribute"></a><span data-ttu-id="10d0a-259">TypeFilterAttribute</span><span class="sxs-lookup"><span data-stu-id="10d0a-259">TypeFilterAttribute</span></span>

<span data-ttu-id="10d0a-260">`TypeFilterAttribute`очень похоже на `ServiceFilterAttribute` (а также реализует `IFilterFactory`), но его тип не разрешается напрямую из DI контейнера.</span><span class="sxs-lookup"><span data-stu-id="10d0a-260">`TypeFilterAttribute` is very similar to `ServiceFilterAttribute` (and also implements `IFilterFactory`), but its type isn't resolved directly from the DI container.</span></span> <span data-ttu-id="10d0a-261">Вместо этого он создает экземпляр типа с помощью `Microsoft.Extensions.DependencyInjection.ObjectFactory`.</span><span class="sxs-lookup"><span data-stu-id="10d0a-261">Instead, it instantiates the type by using `Microsoft.Extensions.DependencyInjection.ObjectFactory`.</span></span>

<span data-ttu-id="10d0a-262">Из-за этого различия типов, на которые ссылаются с помощью `TypeFilterAttribute` не нужно сначала зарегистрировать в контейнере (но они по-прежнему будут иметь их зависимости, выполненные с помощью контейнера).</span><span class="sxs-lookup"><span data-stu-id="10d0a-262">Because of this difference, types that are referenced using the `TypeFilterAttribute` don't need to be registered with the container first (but they will still have their dependencies fulfilled by the container).</span></span> <span data-ttu-id="10d0a-263">Кроме того `TypeFilterAttribute` при необходимости может принимать аргументы конструктора для типа.</span><span class="sxs-lookup"><span data-stu-id="10d0a-263">Also, `TypeFilterAttribute` can optionally accept constructor arguments for the type in question.</span></span> <span data-ttu-id="10d0a-264">Следующий пример демонстрирует передавать аргументы типа с помощью `TypeFilterAttribute`:</span><span class="sxs-lookup"><span data-stu-id="10d0a-264">The following example demonstrates how to pass arguments to a type using `TypeFilterAttribute`:</span></span>

[!code-csharp[Main](../../mvc/controllers/filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_TypeFilter&highlight=1,2)]

<span data-ttu-id="10d0a-265">Если у вас есть фильтр, который не требует никаких аргументов, но которого есть конструктор зависимости, которые должны заполняться DI, можно использовать собственные атрибута с заданным именем на классы и методы, а не `[TypeFilter(typeof(FilterType))]`).</span><span class="sxs-lookup"><span data-stu-id="10d0a-265">If you have a filter that doesn't require any arguments, but which has constructor dependencies that need to be filled by DI, you can use your own named attribute on classes and methods instead of `[TypeFilter(typeof(FilterType))]`).</span></span> <span data-ttu-id="10d0a-266">Фильтр показывает, как это можно реализовать:</span><span class="sxs-lookup"><span data-stu-id="10d0a-266">The following filter shows how this can be implemented:</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleActionFilterAttribute.cs?name=snippet_TypeFilterAttribute&highlight=1,3,7)]

<span data-ttu-id="10d0a-267">Этот фильтр может применяться к классы или методы, используя `[SampleActionFilter]` синтаксис, вместо того чтобы использовать `[TypeFilter]` или `[ServiceFilter]`.</span><span class="sxs-lookup"><span data-stu-id="10d0a-267">This filter can be applied to classes or methods using the `[SampleActionFilter]` syntax, instead of having to use `[TypeFilter]` or `[ServiceFilter]`.</span></span>

## <a name="authorization-filters"></a><span data-ttu-id="10d0a-268">Фильтры авторизации</span><span class="sxs-lookup"><span data-stu-id="10d0a-268">Authorization filters</span></span>

<span data-ttu-id="10d0a-269">*Фильтры авторизации* управления доступом к методам действий и первый фильтры для выполнения в рамках конвейера фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-269">*Authorization filters* control access to action methods and are the first filters to be executed within the filter pipeline.</span></span> <span data-ttu-id="10d0a-270">Они имеют только перед методом, в отличие от большинства фильтров, которые поддерживают до и после методы.</span><span class="sxs-lookup"><span data-stu-id="10d0a-270">They have only a before method, unlike most filters that support before and after methods.</span></span> <span data-ttu-id="10d0a-271">При создании собственных инфраструктуры авторизации следует только написать фильтр настраиваемой авторизации.</span><span class="sxs-lookup"><span data-stu-id="10d0a-271">You should only write a custom authorization filter if you are writing your own authorization framework.</span></span> <span data-ttu-id="10d0a-272">Предпочитаете настройку политик авторизации или написание пользовательской политики авторизации по сравнению с написанием пользовательского фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-272">Prefer configuring your authorization policies or writing a custom authorization policy over writing a custom filter.</span></span> <span data-ttu-id="10d0a-273">Встроенный фильтр реализации просто отвечает за вызов система авторизации.</span><span class="sxs-lookup"><span data-stu-id="10d0a-273">The built-in filter implementation is just responsible for calling the authorization system.</span></span>

<span data-ttu-id="10d0a-274">Обратите внимание, вы не должны исключений в фильтры авторизации, так как ничего не будет обрабатывать исключение (фильтры исключений не будет обрабатывать их).</span><span class="sxs-lookup"><span data-stu-id="10d0a-274">Note that you shouldn't throw exceptions within authorization filters, since nothing will handle the exception (exception filters won't handle them).</span></span> <span data-ttu-id="10d0a-275">Вместо этого запрос и выполнить поиск другим способом.</span><span class="sxs-lookup"><span data-stu-id="10d0a-275">Instead, issue a challenge or find another way.</span></span>

<span data-ttu-id="10d0a-276">Дополнительные сведения о [авторизации](../../security/authorization/index.md).</span><span class="sxs-lookup"><span data-stu-id="10d0a-276">Learn more about [Authorization](../../security/authorization/index.md).</span></span>

## <a name="resource-filters"></a><span data-ttu-id="10d0a-277">Фильтры ресурсов</span><span class="sxs-lookup"><span data-stu-id="10d0a-277">Resource filters</span></span>

<span data-ttu-id="10d0a-278">*Фильтры ресурсов* реализации `IResourceFilter` или `IAsyncResourceFilter` интерфейс и их выполнение включает большую часть конвейера фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-278">*Resource filters* implement either the `IResourceFilter` or `IAsyncResourceFilter` interface, and their execution wraps most of the filter pipeline.</span></span> <span data-ttu-id="10d0a-279">(Только [фильтры авторизации](#authorization-filters) выполняются перед их.) Фильтры ресурсов особенно полезны в тех случаях, если вам нужно краткой записи большую часть работы, который выполняет запрос.</span><span class="sxs-lookup"><span data-stu-id="10d0a-279">(Only [Authorization filters](#authorization-filters) run before them.) Resource filters are especially useful if you need to short-circuit most of the work a request is doing.</span></span> <span data-ttu-id="10d0a-280">Например при ответе уже находится в кэше кэширования фильтра можно избежать оставшуюся часть конвейера.</span><span class="sxs-lookup"><span data-stu-id="10d0a-280">For example, a caching filter can avoid the rest of the pipeline if the response is already in the cache.</span></span>

<span data-ttu-id="10d0a-281">[Короткие сокращенного вычисления фильтр ресурсов](#short-circuiting-resource-filter) выше является примером фильтра ресурсов.</span><span class="sxs-lookup"><span data-stu-id="10d0a-281">The [short circuiting resource filter](#short-circuiting-resource-filter) shown earlier is one example of a resource filter.</span></span> <span data-ttu-id="10d0a-282">Еще один пример — [DisableFormValueModelBindingAttribute](https://github.com/aspnet/Entropy/blob/rel/1.1.1/samples/Mvc.FileUpload/Filters/DisableFormValueModelBindingAttribute.cs), что запрещает привязки модели, доступ к данным формы.</span><span class="sxs-lookup"><span data-stu-id="10d0a-282">Another example is [DisableFormValueModelBindingAttribute](https://github.com/aspnet/Entropy/blob/rel/1.1.1/samples/Mvc.FileUpload/Filters/DisableFormValueModelBindingAttribute.cs), which prevents model binding from accessing the form data.</span></span> <span data-ttu-id="10d0a-283">Это полезно в случаях, когда вы знаете, ты получать передачи больших файлов и должны запускаться формы, считываемых в память.</span><span class="sxs-lookup"><span data-stu-id="10d0a-283">It's useful for cases where you know that you're going to receive large file uploads and want to prevent the form from being read into memory.</span></span>

## <a name="action-filters"></a><span data-ttu-id="10d0a-284">Фильтры действий</span><span class="sxs-lookup"><span data-stu-id="10d0a-284">Action filters</span></span>

<span data-ttu-id="10d0a-285">*Фильтры действий* реализации `IActionFilter` или `IAsyncActionFilter` интерфейс и их выполнение окружает выполнение методов действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-285">*Action filters* implement either the `IActionFilter` or `IAsyncActionFilter` interface, and their execution surrounds the execution of action methods.</span></span>

<span data-ttu-id="10d0a-286">Ниже приведен пример действия фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-286">Here's a sample action filter:</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleActionFilter.cs?name=snippet_ActionFilter)]

<span data-ttu-id="10d0a-287">[ActionExecutingContext](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionexecutingcontext) содержит следующие свойства:</span><span class="sxs-lookup"><span data-stu-id="10d0a-287">The [ActionExecutingContext](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionexecutingcontext) provides the following properties:</span></span>

* <span data-ttu-id="10d0a-288">`ActionArguments`-позволяет управлять входные данные для действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-288">`ActionArguments` - lets you manipulate the inputs to the action.</span></span>
* <span data-ttu-id="10d0a-289">`Controller`-позволяет управлять экземпляр контроллера.</span><span class="sxs-lookup"><span data-stu-id="10d0a-289">`Controller` - lets you manipulate the controller instance.</span></span> 
* <span data-ttu-id="10d0a-290">`Result`-Это игнорирует выполнения метода действия и фильтры последующих действий.</span><span class="sxs-lookup"><span data-stu-id="10d0a-290">`Result` - setting this short-circuits execution of the action method and subsequent action filters.</span></span> <span data-ttu-id="10d0a-291">Также создает исключение предотвращает выполнение метода действия и последующие фильтры, но рассматривается как сбой вместо успешного результата.</span><span class="sxs-lookup"><span data-stu-id="10d0a-291">Throwing an exception also prevents execution of the action method and subsequent filters, but is treated as a failure instead of a successful result.</span></span>

<span data-ttu-id="10d0a-292">[ActionExecutedContext](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionexecutedcontext) предоставляет `Controller` и `Result` плюс следующие свойства:</span><span class="sxs-lookup"><span data-stu-id="10d0a-292">The [ActionExecutedContext](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionexecutedcontext) provides `Controller` and `Result` plus the following properties:</span></span>

* <span data-ttu-id="10d0a-293">`Canceled`-будет иметь значение true, если выполнение действия была сокращенное другим фильтром.</span><span class="sxs-lookup"><span data-stu-id="10d0a-293">`Canceled` - will be true if the action execution was short-circuited by another filter.</span></span>
* <span data-ttu-id="10d0a-294">`Exception`-будет иметь значение null, если действие или фильтр последующих действий вызвал исключение.</span><span class="sxs-lookup"><span data-stu-id="10d0a-294">`Exception` - will be non-null if the action or a subsequent action filter threw an exception.</span></span> <span data-ttu-id="10d0a-295">Задание этого свойства значение null, эффективно «handles» исключение, и `Result` будет выполняться, как если бы он были возвращены обычно из метода действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-295">Setting this property to null effectively 'handles' an exception, and `Result` will be executed as if it were returned from the action method normally.</span></span>

<span data-ttu-id="10d0a-296">Для `IAsyncActionFilter`, вызов `ActionExecutionDelegate` выполняет все последующие действия фильтры и метод действия, возвращая `ActionExecutedContext`.</span><span class="sxs-lookup"><span data-stu-id="10d0a-296">For an `IAsyncActionFilter`, a call to the `ActionExecutionDelegate` executes any subsequent action filters and the action method, returning an `ActionExecutedContext`.</span></span> <span data-ttu-id="10d0a-297">Для краткой записи, назначьте `ActionExecutingContext.Result` некоторые результату экземпляра и не вызывайте `ActionExecutionDelegate`.</span><span class="sxs-lookup"><span data-stu-id="10d0a-297">To short-circuit, assign `ActionExecutingContext.Result` to some result instance and don't call the `ActionExecutionDelegate`.</span></span>

<span data-ttu-id="10d0a-298">Платформа предоставляет абстрактный `ActionFilterAttribute` , можно создать подкласс.</span><span class="sxs-lookup"><span data-stu-id="10d0a-298">The framework provides an abstract `ActionFilterAttribute` that you can subclass.</span></span> 

<span data-ttu-id="10d0a-299">Автоматически проверять состояние модели и возвращает все ошибки, если недопустимое состояние, можно использовать фильтр действий:</span><span class="sxs-lookup"><span data-stu-id="10d0a-299">You can use an action filter to automatically validate model state and return any errors if the state is invalid:</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/ValidateModelAttribute.cs)]

<span data-ttu-id="10d0a-300">`OnActionExecuted` Выполняется метод после метода действия и может см и работа с результатами действия через `ActionExecutedContext.Result` свойство.</span><span class="sxs-lookup"><span data-stu-id="10d0a-300">The `OnActionExecuted` method runs after the action method and can see and manipulate the results of the action through the `ActionExecutedContext.Result` property.</span></span> <span data-ttu-id="10d0a-301">`ActionExecutedContext.Canceled`будет присвоено значение true, если выполнение действия была сокращенное другим фильтром.</span><span class="sxs-lookup"><span data-stu-id="10d0a-301">`ActionExecutedContext.Canceled` will be set to true if the action execution was short-circuited by another filter.</span></span> <span data-ttu-id="10d0a-302">`ActionExecutedContext.Exception`будет присвоено значение отличное от null, если действие или фильтр последующих действий вызвал исключение.</span><span class="sxs-lookup"><span data-stu-id="10d0a-302">`ActionExecutedContext.Exception` will be set to a non-null value if the action or a subsequent action filter threw an exception.</span></span> <span data-ttu-id="10d0a-303">Установка `ActionExecutedContext.Exception` значение null, эффективно «handles» исключение, и `ActionExectedContext.Result` затем будет выполняться, как если бы он были возвращены обычно из метода действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-303">Setting `ActionExecutedContext.Exception` to null effectively 'handles' an exception, and `ActionExectedContext.Result` will then be executed as if it were returned from the action method normally.</span></span>

## <a name="exception-filters"></a><span data-ttu-id="10d0a-304">Фильтры исключений</span><span class="sxs-lookup"><span data-stu-id="10d0a-304">Exception filters</span></span>

<span data-ttu-id="10d0a-305">*Фильтры исключений* реализации `IExceptionFilter` или `IAsyncExceptionFilter` интерфейса.</span><span class="sxs-lookup"><span data-stu-id="10d0a-305">*Exception filters* implement either the `IExceptionFilter` or `IAsyncExceptionFilter` interface.</span></span> <span data-ttu-id="10d0a-306">Они могут использоваться для реализации распространенных ошибок при обработке политики для приложения.</span><span class="sxs-lookup"><span data-stu-id="10d0a-306">They can be used to implement common error handling policies for an app.</span></span> 

<span data-ttu-id="10d0a-307">Следующий образец фильтр исключения используется представление ошибки пользовательского разработчика для отображения сведений об исключениях, возникающих, когда приложение находится в разработке:</span><span class="sxs-lookup"><span data-stu-id="10d0a-307">The following sample exception filter uses a custom developer error view to display details about exceptions that occur when the application is in development:</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/CustomExceptionFilterAttribute.cs?name=snippet_ExceptionFilter&highlight=1,14)]

<span data-ttu-id="10d0a-308">Фильтры исключений не имеют два события (для перед и после) — только реализовать `OnException` (или `OnExceptionAsync`).</span><span class="sxs-lookup"><span data-stu-id="10d0a-308">Exception filters don't have two events (for before and after) - they only implement `OnException` (or `OnExceptionAsync`).</span></span> 

<span data-ttu-id="10d0a-309">Фильтры исключений обработки необработанных исключений, возникающих при создании контроллера [привязки модели](../models/model-binding.md), фильтры действий или методам действий.</span><span class="sxs-lookup"><span data-stu-id="10d0a-309">Exception filters handle unhandled exceptions that occur in controller creation, [model binding](../models/model-binding.md), action filters, or action methods.</span></span> <span data-ttu-id="10d0a-310">Они не будет перехватывать исключения, возникающие в фильтры ресурсов, фильтры результатов или MVC результат выполнения.</span><span class="sxs-lookup"><span data-stu-id="10d0a-310">They won't catch exceptions that occur in Resource filters, Result filters, or MVC Result execution.</span></span>

<span data-ttu-id="10d0a-311">Для обработки исключения, задайте `ExceptionContext.ExceptionHandled` свойство значение true или записывать ответ.</span><span class="sxs-lookup"><span data-stu-id="10d0a-311">To handle an exception, set the `ExceptionContext.ExceptionHandled` property to true or write a response.</span></span> <span data-ttu-id="10d0a-312">Это предотвратит распространение исключения.</span><span class="sxs-lookup"><span data-stu-id="10d0a-312">This stops propagation of the exception.</span></span> <span data-ttu-id="10d0a-313">Обратите внимание, что фильтр исключений нельзя включить исключение в «успешно».</span><span class="sxs-lookup"><span data-stu-id="10d0a-313">Note that an Exception filter can't turn an exception into a "success".</span></span> <span data-ttu-id="10d0a-314">Фильтр действий можно сделать.</span><span class="sxs-lookup"><span data-stu-id="10d0a-314">Only an Action filter can do that.</span></span>

> [!NOTE]
> <span data-ttu-id="10d0a-315">В ASP.NET версии 1.1 не отправлен ответ, если задать `ExceptionHandled` значение true **и** записи ответа.</span><span class="sxs-lookup"><span data-stu-id="10d0a-315">In ASP.NET 1.1, the response isn't sent if you set `ExceptionHandled` to true **and** write a response.</span></span> <span data-ttu-id="10d0a-316">В этом случае ASP.NET Core 1.0 отправки ответа и ASP.NET Core 1.1.2 вернется к 1.0 поведение.</span><span class="sxs-lookup"><span data-stu-id="10d0a-316">In that scenario, ASP.NET Core 1.0 does send the response, and ASP.NET Core 1.1.2 will return to the 1.0 behavior.</span></span> <span data-ttu-id="10d0a-317">Дополнительные сведения см. в разделе [выдавать #5594](https://github.com/aspnet/Mvc/issues/5594) в репозитории GitHub.</span><span class="sxs-lookup"><span data-stu-id="10d0a-317">For more information, see [issue #5594](https://github.com/aspnet/Mvc/issues/5594) in the GitHub repository.</span></span> 

<span data-ttu-id="10d0a-318">Фильтры исключений подходят для перехвата исключений, возникающих в рамках действия MVC, но они не обладает такой гибкостью, как по промежуточного слоя обработки ошибок.</span><span class="sxs-lookup"><span data-stu-id="10d0a-318">Exception filters are good for trapping exceptions that occur within MVC actions, but they're not as flexible as error handling middleware.</span></span> <span data-ttu-id="10d0a-319">Предпочтение по промежуточного слоя в общем случае и использовать фильтры, только когда нужен для обработки ошибок *по-разному* основании действие MVC, которое было выбрано.</span><span class="sxs-lookup"><span data-stu-id="10d0a-319">Prefer middleware for the general case, and use filters only where you need to do error handling *differently* based on which MVC action was chosen.</span></span> <span data-ttu-id="10d0a-320">Например приложение может иметь методы действий для обеих конечных точек API, а также для представления или HTML.</span><span class="sxs-lookup"><span data-stu-id="10d0a-320">For example, your app might have action methods for both API endpoints and for views/HTML.</span></span> <span data-ttu-id="10d0a-321">Конечные точки API может вернуть сведения об ошибке, как JSON, во время действия на основе представления может вернуть страницу ошибки, как HTML.</span><span class="sxs-lookup"><span data-stu-id="10d0a-321">The API endpoints could return error information as JSON, while the view-based actions could return an error page as HTML.</span></span>

<span data-ttu-id="10d0a-322">Платформа предоставляет абстрактный `ExceptionFilterAttribute` , можно создать подкласс.</span><span class="sxs-lookup"><span data-stu-id="10d0a-322">The framework provides an abstract `ExceptionFilterAttribute` that you can subclass.</span></span> 

## <a name="result-filters"></a><span data-ttu-id="10d0a-323">Фильтры результатов</span><span class="sxs-lookup"><span data-stu-id="10d0a-323">Result filters</span></span>

<span data-ttu-id="10d0a-324">*Привести фильтры* реализации `IResultFilter` или `IAsyncResultFilter` интерфейс и их выполнение окружает выполнения результатов действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-324">*Result filters* implement either the `IResultFilter` or `IAsyncResultFilter` interface, and their execution surrounds the execution of action results.</span></span> 

<span data-ttu-id="10d0a-325">Ниже приведен пример результата фильтра, который добавляет заголовок НТТР.</span><span class="sxs-lookup"><span data-stu-id="10d0a-325">Here's an example of a Result filter that adds an HTTP header.</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/LoggingAddHeaderFilter.cs?name=snippet_ResultFilter)]

<span data-ttu-id="10d0a-326">Тип выполняемой результат зависит от рассматриваемой действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-326">The kind of result being executed depends on the action in question.</span></span> <span data-ttu-id="10d0a-327">Действие MVC, возвращение представления будет включать все razor обработки как часть `ViewResult` при выполнении.</span><span class="sxs-lookup"><span data-stu-id="10d0a-327">An MVC action returning a view would include all razor processing as part of the `ViewResult` being executed.</span></span> <span data-ttu-id="10d0a-328">Метод API может выполнять некоторые сериализации как часть выполнения результата.</span><span class="sxs-lookup"><span data-stu-id="10d0a-328">An API method might perform some serialization as part of the execution of the result.</span></span> <span data-ttu-id="10d0a-329">Дополнительные сведения о [результаты действий](actions.md)</span><span class="sxs-lookup"><span data-stu-id="10d0a-329">Learn more about [action results](actions.md)</span></span>

<span data-ttu-id="10d0a-330">Фильтры результатов выполняются только для результаты успешных тестов — Если действие или фильтров действий выдают результат действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-330">Result filters are only executed for successful results - when the action or action filters produce an action result.</span></span> <span data-ttu-id="10d0a-331">Фильтры результатов не выполняются, когда фильтры исключений обработки исключения.</span><span class="sxs-lookup"><span data-stu-id="10d0a-331">Result filters are not executed when exception filters handle an exception.</span></span>

<span data-ttu-id="10d0a-332">`OnResultExecuting` Метод может прерывания выполнения результата действия и последующие результирующие фильтры, задав `ResultExecutingContext.Cancel` значение true.</span><span class="sxs-lookup"><span data-stu-id="10d0a-332">The `OnResultExecuting` method can short-circuit execution of the action result and subsequent result filters by setting `ResultExecutingContext.Cancel` to true.</span></span> <span data-ttu-id="10d0a-333">Обычно следует писать объект ответа, когда сокращенного вычисления для предотвращения создания пустой ответ.</span><span class="sxs-lookup"><span data-stu-id="10d0a-333">You should generally write to the response object when short-circuiting to avoid generating an empty response.</span></span> <span data-ttu-id="10d0a-334">Исключение предотвратит выполнения результата действия и последующие фильтры, но будет рассматриваться как сбой вместо успешного результата.</span><span class="sxs-lookup"><span data-stu-id="10d0a-334">Throwing an exception will also prevent execution of the action result and subsequent filters, but will be treated as a failure instead of a successful result.</span></span>

<span data-ttu-id="10d0a-335">Когда `OnResultExecuted` выполняется метод, ответ скорее всего отправляются на клиент и их нельзя изменить дальнейшей (если не возникло исключение).</span><span class="sxs-lookup"><span data-stu-id="10d0a-335">When the `OnResultExecuted` method runs, the response has likely been sent to the client and cannot be changed further (unless an exception was thrown).</span></span> <span data-ttu-id="10d0a-336">`ResultExecutedContext.Canceled`будет присвоено значение true, если результат выполнения действия была сокращенное другим фильтром.</span><span class="sxs-lookup"><span data-stu-id="10d0a-336">`ResultExecutedContext.Canceled` will be set to true if the action result execution was short-circuited by another filter.</span></span>

<span data-ttu-id="10d0a-337">`ResultExecutedContext.Exception`будет присвоено значение отличное от null, если результат действия или последующие результирующие Фильтр вызвал исключение.</span><span class="sxs-lookup"><span data-stu-id="10d0a-337">`ResultExecutedContext.Exception` will be set to a non-null value if the action result or a subsequent result filter threw an exception.</span></span> <span data-ttu-id="10d0a-338">Параметр `Exception` для null эффективно обрабатывает исключение и предотвращает исключения повторно вызывается MVC более поздней версии в конвейере.</span><span class="sxs-lookup"><span data-stu-id="10d0a-338">Setting `Exception` to null effectively 'handles' an exception and prevents the exception from being rethrown by MVC later in the pipeline.</span></span> <span data-ttu-id="10d0a-339">Когда обработка исключений в фильтре результата, может не быть может записывать любые данные в ответ.</span><span class="sxs-lookup"><span data-stu-id="10d0a-339">When you're handling an exception in a result filter, you might not be able to write any data to the response.</span></span> <span data-ttu-id="10d0a-340">Если результат действия вызывает исключение во время до его выполнения и заголовки уже были записаны на клиент, отсутствует надежный механизм для отправки, то код сбоя.</span><span class="sxs-lookup"><span data-stu-id="10d0a-340">If the action result throws partway through its execution, and the headers have already been flushed to the client, there's no reliable mechanism to send a failure code.</span></span>

<span data-ttu-id="10d0a-341">Для `IAsyncResultFilter` вызов `await next()` на `ResultExecutionDelegate` выполняет все последующие результирующие фильтры и результата действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-341">For an `IAsyncResultFilter` a call to `await next()` on the `ResultExecutionDelegate` executes any subsequent result filters and the action result.</span></span> <span data-ttu-id="10d0a-342">Чтобы краткой записи, задайте `ResultExecutingContext.Cancel` в значение true и не вызывайте `ResultExectionDelegate`.</span><span class="sxs-lookup"><span data-stu-id="10d0a-342">To short-circuit, set `ResultExecutingContext.Cancel` to true and don't call the `ResultExectionDelegate`.</span></span>

<span data-ttu-id="10d0a-343">Платформа предоставляет абстрактный `ResultFilterAttribute` , можно создать подкласс.</span><span class="sxs-lookup"><span data-stu-id="10d0a-343">The framework provides an abstract `ResultFilterAttribute` that you can subclass.</span></span> <span data-ttu-id="10d0a-344">[AddHeaderAttribute](#add-header-attribute) приведенный выше класс является примером атрибут фильтра результатов.</span><span class="sxs-lookup"><span data-stu-id="10d0a-344">The [AddHeaderAttribute](#add-header-attribute) class shown earlier is an example of a result filter attribute.</span></span>

## <a name="using-middleware-in-the-filter-pipeline"></a><span data-ttu-id="10d0a-345">С помощью по промежуточного слоя в конвейере фильтра</span><span class="sxs-lookup"><span data-stu-id="10d0a-345">Using middleware in the filter pipeline</span></span>

<span data-ttu-id="10d0a-346">Фильтры ресурсов работают как [по промежуточного слоя](../../fundamentals/middleware.md) в том, что они заключить выполнения все данные, поступающие в конвейере.</span><span class="sxs-lookup"><span data-stu-id="10d0a-346">Resource filters work like [middleware](../../fundamentals/middleware.md) in that they surround the execution of everything that comes later in the pipeline.</span></span> <span data-ttu-id="10d0a-347">Однако фильтры отличаются от по промежуточного слоя, что они являются частью MVC, это означает, что они имеют доступ к контекст MVC и конструкции.</span><span class="sxs-lookup"><span data-stu-id="10d0a-347">But filters differ from middleware in that they're part of MVC, which means that they have access to MVC context and constructs.</span></span>

<span data-ttu-id="10d0a-348">В ASP.NET Core 1.1 можно использовать по промежуточного слоя в конвейере фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-348">In ASP.NET Core 1.1, you can use middleware in the filter pipeline.</span></span> <span data-ttu-id="10d0a-349">Вы можете делать, если у вас есть компонент по промежуточного слоя, которому требуется доступ к маршрутизации MVC данных или пакет, который следует запустить только для некоторых контроллеров или действия.</span><span class="sxs-lookup"><span data-stu-id="10d0a-349">You might want to do that if you have a middleware component that needs access to MVC route data, or one that should run only for certain controllers or actions.</span></span>

<span data-ttu-id="10d0a-350">Чтобы использовать в качестве фильтра по промежуточного слоя, создайте тип с `Configure` метод, который задает по промежуточного слоя, который необходимо внедрить в конвейере фильтра.</span><span class="sxs-lookup"><span data-stu-id="10d0a-350">To use middleware as a filter, create a type with a `Configure` method that specifies the middleware that you want to inject into the filter pipeline.</span></span> <span data-ttu-id="10d0a-351">Ниже приведен пример использования по промежуточного слоя локализации для установления текущего языка и региональных параметров для запроса:</span><span class="sxs-lookup"><span data-stu-id="10d0a-351">Here's an example that uses the localization middleware to establish the current culture for a request:</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/LocalizationPipeline.cs?name=snippet_MiddlewareFilter&highlight=3,21)]

<span data-ttu-id="10d0a-352">Затем можно использовать `MiddlewareFilterAttribute` для запуска по промежуточного слоя для выбранного контроллера или действия или глобально:</span><span class="sxs-lookup"><span data-stu-id="10d0a-352">You can then use the `MiddlewareFilterAttribute` to run the middleware for a selected controller or action or globally:</span></span>

[!code-csharp[Main](./filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_MiddlewareFilter&highlight=2)]

<span data-ttu-id="10d0a-353">Фильтры по промежуточного слоя, выполняются на одном этапе конвейера фильтра как фильтры ресурсов до привязки модели и после оставшуюся часть конвейера.</span><span class="sxs-lookup"><span data-stu-id="10d0a-353">Middleware filters run at the same stage of the filter pipeline as Resource filters, before model binding and after the rest of the pipeline.</span></span>

## <a name="next-actions"></a><span data-ttu-id="10d0a-354">Дальнейшие действия</span><span class="sxs-lookup"><span data-stu-id="10d0a-354">Next actions</span></span>

<span data-ttu-id="10d0a-355">Для экспериментов с фильтрами, [загрузки, тестирования и изменить пример](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span><span class="sxs-lookup"><span data-stu-id="10d0a-355">To experiment with filters, [download, test and modify the sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span></span>

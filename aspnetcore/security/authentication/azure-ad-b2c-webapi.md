---
title: Облачной проверки подлинности в веб-API с Azure Active Directory B2C в ASP.NET Core
author: camsoper
description: Узнайте, как настроить проверку подлинности Azure Active Directory B2C с веб-API ASP.NET Core. Протестируйте проверку подлинности веб-API с почтальон.
ms.author: casoper
ms.date: 01/25/2018
ms.custom: mvc
uid: security/authentication/azure-ad-b2c-webapi
ms.openlocfilehash: c56efda28c668b8f88d28334705b4c26f288870f
ms.sourcegitcommit: e22097b84d26a812cd1380a6b2d12c93e522c125
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/22/2018
ms.locfileid: "36314166"
---
# <a name="cloud-authentication-in-web-apis-with-azure-active-directory-b2c-in-aspnet-core"></a>Облачной проверки подлинности в веб-API с Azure Active Directory B2C в ASP.NET Core

Автор [Кэм Сопер (Cam Soper)](https://twitter.com/camsoper)

[Azure Active Directory B2C](/azure/active-directory-b2c/active-directory-b2c-overview) (Azure AD B2C) — это Облачное решение управления удостоверения для веб- и мобильных приложений. Служба обеспечивает проверку подлинности для приложений, размещенных в облаке и в локальной среде. Типы проверки подлинности включают отдельные учетные записи, учетные записи социальных сетей и федеративные учетные записи предприятия. Кроме того Azure AD B2C можно указать многофакторной проверки подлинности с минимальной конфигурацией.

> [!TIP]
> Azure Active Directory (Azure AD) и Azure AD B2C являются отдельные продукты. Клиент Azure AD представляет организации, а клиент Azure AD B2C представляет коллекцию удостоверений для использования с приложениями проверяющей стороны. Дополнительные сведения см. в разделе [Azure AD B2C: часто задаваемые вопросы (FAQ)](/azure/active-directory-b2c/active-directory-b2c-faqs).

Поскольку веб-API не имеют пользовательского интерфейса, они не удается перенаправить пользователя для службы маркеров безопасности как Azure AD B2C. Вместо этого API-интерфейса, передается токен носителя из вызывающего приложения уже прошел проверку подлинности пользователя с Azure AD B2C. API-Интерфейс затем проверяет токен без прямого взаимодействия с пользователем.

В этом учебнике показано, как:

> [!div class="checklist"]
> * Создание клиента Azure Active Directory B2C.
> * Регистрация веб-API в Azure AD B2C.
> * Visual Studio можно используйте для создания веб-API, настроен для использования проверки подлинности клиента Azure AD B2C.
> * Настройка политик управления поведением клиента Azure AD B2C.
> * Используйте почтальон для имитации веб-приложения, который представляет диалоговое окно входа, получает маркер и использует его для выполнения запроса к веб-API.

## <a name="prerequisites"></a>Предварительные требования

Ниже приведены для данного пошагового руководства требуется:

* [Подписка на Microsoft Azure](https://azure.microsoft.com/free/?ref=microsoft.com&utm_source=microsoft.com&utm_medium=docs&utm_campaign=visualstudio)
* [Visual Studio 2017 г](https://aka.ms/vsdownload?utm_source=mscom&utm_campaign=msdocs) (любой выпуск)
* [Postman](https://www.getpostman.com/postman)

## <a name="create-the-azure-active-directory-b2c-tenant"></a>Создание клиента Azure Active Directory B2C

Создание клиента Azure AD B2C [как описано в документации по](/azure/active-directory-b2c/active-directory-b2c-get-started). При появлении запроса связь клиента с подпиской Azure является необязательным для этого учебника.

## <a name="configure-a-sign-up-or-sign-in-policy"></a>Настройка политики регистрации или входа в систему

Следуйте инструкциям в документации по Azure AD B2C для [создать политику регистрации или входа в](/azure/active-directory-b2c/active-directory-b2c-reference-policies#create-a-sign-up-or-sign-in-policy). Имя политики **SiUpIn**.  Использовать пример значения, предоставленные в документации по **Поставщики удостоверений**, **регистрации атрибуты**, и **утверждений приложения**. С помощью **запустить сейчас** кнопку для проверки политики, как описано в документации является необязательным.

## <a name="register-the-api-in-azure-ad-b2c"></a>Зарегистрировать API в Azure AD B2C

В только что созданный клиента Azure AD B2C, зарегистрируйте API с помощью [действия, описанные в документации по](/azure/active-directory-b2c/active-directory-b2c-app-registration#register-a-web-api) под **зарегистрировать веб-API** раздела.

Используйте следующие значения:

| Параметр                       | Значение               | Примечания                                                                                  |
|-------------------------------|---------------------|----------------------------------------------------------------------------------------|
| **Name**                      | *&lt;Имя API&gt;*  | Введите **имя** для приложения, описывающих приложение пользователям.                     |
| **Включить веб-приложения или веб-API** | Да                 |                                                                                        |
| **Разрешить неявного потока**       | Да                 |                                                                                        |
| **URL-адрес ответа**                 | `https://localhost` | URL-адреса ответа, конечные точки, где Azure AD B2C возвращает токенами, которые запрашивает приложение. |
| **URI ИД приложения**                | *API-интерфейс*               | URI не нужно преобразовать физический адрес. Он должен быть уникальным.     |
| **Включить собственный клиент**     | Нет                  |                                                                                        |

После регистрации API отображается список приложений и API-интерфейсы в клиенте. Выберите API, который был только что зарегистрирован. Выберите **копирования** значок справа от **идентификатор приложения** поле, чтобы скопировать его в буфер обмена. Выберите **публикации областей** и проверьте значение по умолчанию *user_impersonation* присутствует область.

## <a name="create-an-aspnet-core-app-in-visual-studio-2017"></a>Создание приложения ASP.NET Core в Visual Studio 2017 г.

Шаблон веб-приложения Visual Studio можно настроить для использования проверки подлинности клиента Azure AD B2C.

В Visual Studio:

1. Создайте новое веб-приложение ASP.NET Core. 
2. Выберите **веб-API** из списка шаблонов.
3. Выберите **изменить аутентификацию** кнопки.

    ![Кнопка изменения проверки подлинности](./azure-ad-b2c-webapi/change-auth-button.png)

4. В **изменить проверку подлинности** диалогового окна выберите **отдельных учетных записей пользователей**, а затем выберите **подключиться к существующему хранилищу пользователей в облаке** в раскрывающемся списке. 

    ![Диалоговое окно Изменение проверки подлинности](./azure-ad-b2c-webapi/change-auth-dialog.png)

5. Заполните форму со следующими значениями:

    | Параметр                       | Значение                                                 |
    |-------------------------------|-------------------------------------------------------|
    | **Имя домена**               | *&lt;имя домена клиента B2C&gt;*          |
    | **Идентификатор приложения**            | *&lt;Вставьте идентификатор приложения из буфера обмена&gt;* |
    | **Политики регистрации или входа в систему** | `B2C_1_SiUpIn`                                        |

    Выберите **ОК** закрыть **изменить аутентификацию** диалогового окна. Выберите **ОК** для создания веб-приложения.

Visual Studio создает веб-API с помощью контроллера с именем *ValuesController.cs* , возвращающий жестко закодированные значения для запросов GET. Класс снабжен [авторизовать атрибут](xref:security/authorization/simple), поэтому все запросы требуют проверки подлинности.

## <a name="run-the-web-api"></a>Запуск веб-API

В Visual Studio запустите API. Visual Studio запускает браузер указывали на URL-адрес корня API-Интерфейсов. Запишите URL-адрес в адресной строке, а также оставить API в фоновом режиме.

> [!NOTE]
> Поскольку ни один контроллер, определенные для корневой URL-адрес, браузер отображает ошибку 404 (страница не найдена). Это нормальная ситуация.

## <a name="use-postman-to-get-a-token-and-test-the-api"></a>Использование почтальон для получения маркера и проверки API

[Почтальон](https://getpostman.com/postman) это средство для тестирования веб-API. В этом учебнике почтальон имитирует веб-приложение, которое обращается к веб-API от имени пользователя.

### <a name="register-postman-as-a-web-app"></a>Зарегистрировать почтальон как веб-приложения

Поскольку почтальон имитирует веб-приложения, могут получить токены из клиента Azure AD B2C, он должны быть зарегистрированы в клиенте как веб-приложения. Регистрация с помощью почтальон [действия, описанные в документации по](/azure/active-directory-b2c/active-directory-b2c-app-registration#register-a-web-app) под **зарегистрировать веб-приложение** раздела. Остановиться на **создать секрет клиента приложения web** раздела. В этом учебнике секрета клиента не требуется. 

Используйте следующие значения:

| Параметр                       | Значение                            | Примечания                           |
|-------------------------------|----------------------------------|---------------------------------|
| **Name**                      | Почтальон                          |                                 |
| **Включить веб-приложения или веб-API** | Да                              |                                 |
| **Разрешить неявного потока**       | Да                              |                                 |
| **URL-адрес ответа**                 | `https://getpostman.com/postman` |                                 |
| **URI ИД приложения**                | *&lt;не указывайте&gt;*            | Не требуется для этого учебника. |
| **Включить собственный клиент**     | Нет                               |                                 |

Вновь зарегистрированного веб-приложения необходимо предоставить разрешение на доступ к веб-API от имени пользователя.  

1. Выберите **почтальон** в списке приложений, а затем выберите **доступ к API** в меню слева.
2. Выберите **+ добавить**.
3. В **выберите API** раскрывающийся список, выберите имя веб-API.
4. В **областей выберите** раскрывающийся список, установите флажки всех областей.
5. Выберите **ОК**.

Обратите внимание приложения почтальон идентификатор приложения, как это необходимо для получения токена носителя.

### <a name="create-a-postman-request"></a>Создание запроса на почтальон

Запустите почтальон. По умолчанию отображает почтальон **создать** диалоговое окно при запуске. Если диалоговое окно не отображается, выберите **+ создать** кнопка в верхнем левом углу.

Из **создать** диалоговое окно:

1. Выберите **запроса**.

    ![Кнопка запроса](./azure-ad-b2c-webapi/postman-create-new.png)

2. Введите *получить значения* в **имя запроса** поле.
3. Выберите **+ создать коллекцию** для создания новой коллекции для хранения запроса. Присвоение имени коллекции *учебники ASP.NET Core* и затем установите флажок.

    ![Создание новой коллекции](./azure-ad-b2c-webapi/postman-create-collection.png)

4. Выберите **сохранить на обучающие ASP.NET Core** кнопки.

### <a name="test-the-web-api-without-authentication"></a>Тестирование веб-API без проверки подлинности

Чтобы убедиться, что веб-API требует проверки подлинности, сначала следует сделать запрос без проверки подлинности.

1. В **введите URL-адрес запроса** введите URL-адрес для `ValuesController`. URL-адрес является так же, как отображается в браузере с **api или значений** добавляется. Примером может служить `https://localhost:44375/api/values`.
2. Выберите **отправки** кнопки.
3. Обратите внимание, состояние ответа *проверки подлинности 401*.

    ![401 Нет ответа](./azure-ad-b2c-webapi/postman-401-status.png)

### <a name="obtain-a-bearer-token"></a>Получение токена носителя

Чтобы сделать запрос с проверкой подлинности в веб-API, требуется токен носителя. Почтальон упрощает процесс входа Azure AD B2C и получить маркер.

1. На **авторизации** вкладке **тип** раскрывающийся список, выберите **OAuth 2.0**. В **данные авторизации, чтобы добавить** раскрывающийся список, выберите **заголовки запроса**. Выберите **получение токена доступа для нового**.

    ![На вкладке авторизация с параметрами](./azure-ad-b2c-webapi/postman-auth-tab.png)

2. Завершить **получить новый ТОКЕН доступа** диалоговое окно следующим образом:


   |                Параметр                 |                                             Значение                                             |                                                                                                                                    Примечания                                                                                                                                     |
   |----------------------------------------|-----------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   |      <strong>Имя токена</strong>       |                                  <em>&lt;Имя токена&gt;</em>                                  |                                                                                                                   Введите описательное имя для маркера.                                                                                                                    |
   |      <strong>Тип предоставления</strong>       |                                           Неявные                                            |                                                                                                                                                                                                                                                                              |
   |     <strong>URL-адрес обратного вызова</strong>      |                               `https://getpostman.com/postman`                                |                                                                                                                                                                                                                                                                              |
   |       <strong>URL-адрес проверки подлинности</strong>        | `https://login.microsoftonline.com/tfp/<tenant domain name>/B2C_1_SiUpIn/oauth2/v2.0/authorize` |                                                                                                  Замените <em>&lt;доменное имя клиента&gt;</em> с доменное имя клиента.                                                                                                  |
   |       <strong>Идентификатор клиента</strong>       |                <em>&lt;Введите приложения почтальон <b>идентификатор приложения</b>&gt;</em>                 |                                                                                                                                                                                                                                                                              |
   |     <strong>Секрет клиента</strong>     |                                 <em>&lt;не указывайте&gt;</em>                                  |                                                                                                                                                                                                                                                                              |
   |         <strong>Область</strong>         |         `https://<tenant domain name>/<api>/user_impersonation openid offline_access`         | Замените <em>&lt;доменное имя клиента&gt;</em> с доменное имя клиента. Замените <em>&lt;api&gt;</em> с именем проекта веб-API. Можно также использовать идентификатор приложения. Схема URL-адрес выглядит следующим образом: <em>https://{tenant}.onmicrosoft.com/{app_name_or_id}/{scope имя}</em>. |
   | <strong>Проверка подлинности клиента</strong> |                                Отправлять учетные данные клиента в текст                                |                                                                                                                                                                                                                                                                              |


3. Выберите **запроса маркера** кнопки.

4. Почтальон открывает новое окно, содержащее знак клиента Azure AD B2C в диалоговом окне. Войдите с помощью существующей учетной записи (если один создан тестирования политики) или выберите **Зарегистрируйтесь сейчас** для создания новой учетной записи. **Забыли пароль?** связь используется для сброса забытого пароля.

5. После успешного входа в систему, окно закрывается и **УПРАВЛЕНИЕ ТОКЕНЫ доступа** откроется диалоговое окно. Прокрутите список вниз до нижней и выберите **использование маркеров** кнопки.

    ![Где находятся кнопки «Использования маркеров»](./azure-ad-b2c-webapi/postman-access-token.png)

### <a name="test-the-web-api-with-authentication"></a>Тестирование веб-API с помощью проверки подлинности

Выберите **отправки** кнопку, чтобы отправить запрос еще раз. Состояние ответа на этот раз будет *200 ОК* , и полезные данные JSON в ответе **текст** вкладки.

![Полезные данные и успешно состояния](./azure-ad-b2c-webapi/postman-success.png)

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы узнали, как:

> [!div class="checklist"]
> * Создание клиента Azure Active Directory B2C.
> * Регистрация веб-API в Azure AD B2C.
> * Visual Studio можно используйте для создания веб-API, настроен для использования проверки подлинности клиента Azure AD B2C.
> * Настройка политик управления поведением клиента Azure AD B2C.
> * Используйте почтальон для имитации веб-приложения, который представляет диалоговое окно входа, получает маркер и использует его для выполнения запроса к веб-API.

Продолжать разработку API, обучение, чтобы:

* [Защита с помощью Azure AD B2C веб-приложения ASP.NET Core](xref:security/authentication/azure-ad-b2c).
* [Вызов веб-API .NET из веб-приложения .NET с помощью Azure AD B2C](/azure/active-directory-b2c/active-directory-b2c-devquickstarts-web-api-dotnet).
* [Настройка пользовательского интерфейса Azure AD B2C](/azure/active-directory-b2c/active-directory-b2c-reference-ui-customization).
* [Настройте требования к сложности пароля](/azure/active-directory-b2c/active-directory-b2c-reference-password-complexity).
* [Включение многофакторной проверки подлинности](/azure/active-directory-b2c/active-directory-b2c-reference-mfa).
* Настройка дополнительных поставщиков, такие как [Microsoft](/azure/active-directory-b2c/active-directory-b2c-setup-msa-app), [Facebook](/azure/active-directory-b2c/active-directory-b2c-setup-fb-app), [Google](/azure/active-directory-b2c/active-directory-b2c-setup-goog-app), [Amazon](/azure/active-directory-b2c/active-directory-b2c-setup-amzn-app), [Twitter ](/azure/active-directory-b2c/active-directory-b2c-setup-twitter-app)и др.
* [Использовать API Azure AD Graph](/azure/active-directory-b2c/active-directory-b2c-devquickstarts-graph-dotnet) для получения дополнительных сведений, таких как членство в группе из клиента Azure AD B2C.

---
title: "Управление ключами"
author: rick-anderson
description: "В этом документе перечислены сведения о реализации ASP.NET Core данных защиты ключа API управления."
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.technology: aspnet
ms.prod: asp.net-core
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: 53adb067751917a9539a310bb7d91e599696f213
ms.sourcegitcommit: 3e303620a125325bb9abd4b2d315c106fb8c47fd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/19/2018
---
# <a name="key-management"></a><span data-ttu-id="e2562-103">Управление ключами</span><span class="sxs-lookup"><span data-stu-id="e2562-103">Key Management</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="e2562-104">Система защиты данных автоматически управляет временем существования главные ключи, используемые для установки и снятия защиты полезных данных.</span><span class="sxs-lookup"><span data-stu-id="e2562-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="e2562-105">Каждый раздел может существовать в одном из четырех этапов:</span><span class="sxs-lookup"><span data-stu-id="e2562-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="e2562-106">Создана - ключ существует в ключ обмена, но еще не активирована.</span><span class="sxs-lookup"><span data-stu-id="e2562-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="e2562-107">Ключ не должны использоваться для новых операций защитить пока не истечет время, достаточное, что ключ имели возможность распространить на все компьютеры, использующие этот ключ обмена.</span><span class="sxs-lookup"><span data-stu-id="e2562-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="e2562-108">Активный — ключ существует в ключ обмена и должен использоваться для всех новых операций защитить.</span><span class="sxs-lookup"><span data-stu-id="e2562-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="e2562-109">Срок действия истек - ключ был выполнен существования естественным и больше не должен использоваться для новых операций защитить.</span><span class="sxs-lookup"><span data-stu-id="e2562-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="e2562-110">Был отозван - ключ скомпрометирован и не должны использоваться для новых операций защитить.</span><span class="sxs-lookup"><span data-stu-id="e2562-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="e2562-111">Ключи созданный active и истекшим сроком действия может использовать для снятия защиты входящих полезных данных.</span><span class="sxs-lookup"><span data-stu-id="e2562-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="e2562-112">Отозванные ключей по умолчанию не может использоваться для снятия защиты полезных данных, но разработчик приложения может [переопределить это поведение](../consumer-apis/dangerous-unprotect.md#data-protection-consumer-apis-dangerous-unprotect) при необходимости.</span><span class="sxs-lookup"><span data-stu-id="e2562-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](../consumer-apis/dangerous-unprotect.md#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="e2562-113">Разработчик может возникнуть желание удаления ключа из ключа обмена (например, при удалении соответствующего файла из файловой системы).</span><span class="sxs-lookup"><span data-stu-id="e2562-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="e2562-114">На этом этапе окончательно получить все данные, защищенные с помощью ключа и не аварийный переопределение как отозванных ключи.</span><span class="sxs-lookup"><span data-stu-id="e2562-114">At that point, all data protected by the key is permanently undecipherable, and there is no emergency override like there is with revoked keys.</span></span> <span data-ttu-id="e2562-115">Удаление ключа является действительно разрушительных поведение и в результате система защиты данных обеспечивает доступ без первого класса API для выполнения данной операции.</span><span class="sxs-lookup"><span data-stu-id="e2562-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="e2562-116">Выбор ключа по умолчанию</span><span class="sxs-lookup"><span data-stu-id="e2562-116">Default key selection</span></span>

<span data-ttu-id="e2562-117">Когда система защиты данных считывает кольцо ключ из резервного хранилища, он предпринимает попытки найти ключ «default» из ключ обмена.</span><span class="sxs-lookup"><span data-stu-id="e2562-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="e2562-118">Ключ по умолчанию используется для новых операций защитить.</span><span class="sxs-lookup"><span data-stu-id="e2562-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="e2562-119">Общие эвристики является, система защиты данных выбирает ключ с самой последней даты активации в качестве ключа по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="e2562-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="e2562-120">(Нет небольшой настроечным параметром, чтобы предусмотреть наклона часов сервера на сервер). Если ключ просрочен или отозван, создания ключа и если приложение не отключил автоматическое, то будет создан новый ключ с немедленного активации на [ключа истечение срока действия и накат](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) политики ниже.</span><span class="sxs-lookup"><span data-stu-id="e2562-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="e2562-121">По причине система защиты данных немедленно формирует новый ключ, а не возврата к другой ключ, создание нового ключа должно рассматриваться как неявные истечение срока действия всех ключей, которые были активированы до нового ключа.</span><span class="sxs-lookup"><span data-stu-id="e2562-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="e2562-122">Общая идея заключается в новые ключи были настроены с различных алгоритмов или механизмы шифрования статических более старые ключи, что система должна предпочтение возврата текущей конфигурации.</span><span class="sxs-lookup"><span data-stu-id="e2562-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="e2562-123">Существует одно исключение.</span><span class="sxs-lookup"><span data-stu-id="e2562-123">There is an exception.</span></span> <span data-ttu-id="e2562-124">Если разработчик приложения должен [отключено автоматическое создание ключа](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), то система защиты данных необходимо выбрать что-либо ключ по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="e2562-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="e2562-125">В этом случае резервная системой будет выбран ключ не отозван с самая поздняя дата активации с предпочтением в ключи, для которых времени для распространения на других компьютерах в кластере.</span><span class="sxs-lookup"><span data-stu-id="e2562-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="e2562-126">Система резервного использования может оказаться в результате выбора ключ с истекшим сроком действия по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="e2562-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="e2562-127">Система резервного использования никогда не будет выбирать отозванных ключ как ключ по умолчанию, и если кольцо ключ является пустым или каждый ключ был отозван система будет создавать ошибку при инициализации.</span><span class="sxs-lookup"><span data-stu-id="e2562-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="e2562-128">Срок действия ключа и накат</span><span class="sxs-lookup"><span data-stu-id="e2562-128">Key expiration and rolling</span></span>

<span data-ttu-id="e2562-129">Если создать ключ, он автоматически присваивается Дата активации {now + 2 дня} и дату окончания срока действия {теперь + 90 дней}.</span><span class="sxs-lookup"><span data-stu-id="e2562-129">When a key is created, it is automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="e2562-130">Задержка 2 дня до активации дает ключевое время для распространения через систему.</span><span class="sxs-lookup"><span data-stu-id="e2562-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="e2562-131">Т. е он позволяет другим приложениям, навести указатель мыши на резервное хранилище позволяет продемонстрировать ключ их следующего автоматического обновления период, таким образом хотите максимально повысить вероятность того, что при ключ кольцо может стать активно, его завершения распространения для всех приложений, которые может потребоваться использовать его.</span><span class="sxs-lookup"><span data-stu-id="e2562-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="e2562-132">Если ключ по умолчанию истекает в течение 2 дней и кольцо ключ еще не содержит ключ, который будет активна по истечении срока действия ключа по умолчанию, система защиты данных автоматически будет сохранен новый ключ для ключей.</span><span class="sxs-lookup"><span data-stu-id="e2562-132">If the default key will expire within 2 days and if the key ring does not already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="e2562-133">Этот новый ключ имеет Дата активации {ключ по умолчанию Дата истечения срока действия} и дату окончания срока действия {теперь + 90 дней}.</span><span class="sxs-lookup"><span data-stu-id="e2562-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="e2562-134">Это позволяет системе автоматически развертывания ключей на регулярной основе без прерывания работы службы.</span><span class="sxs-lookup"><span data-stu-id="e2562-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="e2562-135">Могут возникнуть обстоятельства с активацией немедленно, в котором будет создана ключа.</span><span class="sxs-lookup"><span data-stu-id="e2562-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="e2562-136">Примером может служить, когда приложение не выполнялось в течение времени и завершаются все ключи в ключ обмена.</span><span class="sxs-lookup"><span data-stu-id="e2562-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="e2562-137">В этом случае ключ предоставляется Дата активации {сейчас} без задержки активации обычный 2 дня.</span><span class="sxs-lookup"><span data-stu-id="e2562-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="e2562-138">Время жизни ключа по умолчанию составляет 90 дней, хотя это можно настроить, как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="e2562-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="e2562-139">Администратор также может изменять всей системы по умолчанию, если явный вызов `SetDefaultKeyLifetime` переопределяет любую политику во всей системе.</span><span class="sxs-lookup"><span data-stu-id="e2562-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="e2562-140">По умолчанию срок жизни ключа не может быть менее 7 дней.</span><span class="sxs-lookup"><span data-stu-id="e2562-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="e2562-141">Обновление автоматического ключей</span><span class="sxs-lookup"><span data-stu-id="e2562-141">Automatic key ring refresh</span></span>

<span data-ttu-id="e2562-142">При инициализации системы защиты данных считывает кольцо ключ из базового хранилища и кэширует его в памяти.</span><span class="sxs-lookup"><span data-stu-id="e2562-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="e2562-143">Этот кэш позволяет защитить и Unprotect операций для продолжения работы без прерывания в резервное хранилище.</span><span class="sxs-lookup"><span data-stu-id="e2562-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="e2562-144">Система автоматически проверит резервного хранилища для изменения примерно каждые 24 часа или по истечении срока действия текущего ключа по умолчанию наступит раньше.</span><span class="sxs-lookup"><span data-stu-id="e2562-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="e2562-145">Разработчикам следует очень редко (почти никогда) должны использовать ключа API управления напрямую.</span><span class="sxs-lookup"><span data-stu-id="e2562-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="e2562-146">Система защиты данных выполнит автоматическое управление ключами, как описано выше.</span><span class="sxs-lookup"><span data-stu-id="e2562-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="e2562-147">Система защиты данных предоставляет интерфейс `IKeyManager` может использоваться для проверки и внести изменения в кольцевой ключ.</span><span class="sxs-lookup"><span data-stu-id="e2562-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="e2562-148">Система DI, предоставленный экземпляр `IDataProtectionProvider` также можно указать экземпляр `IKeyManager` для потребления.</span><span class="sxs-lookup"><span data-stu-id="e2562-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="e2562-149">Кроме того, вы можете извлечь `IKeyManager` прямо из `IServiceProvider` как в примере ниже.</span><span class="sxs-lookup"><span data-stu-id="e2562-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="e2562-150">Любая операция, изменяющего ключей (Создание нового ключа явным образом или выполнение отзыв) станут недействительными кэш в памяти.</span><span class="sxs-lookup"><span data-stu-id="e2562-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="e2562-151">При следующем вызове `Protect` или `Unprotect` система защиты данных, повторное считывание ключей и повторное создание кэша.</span><span class="sxs-lookup"><span data-stu-id="e2562-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="e2562-152">В следующем примере показано использование `IKeyManager` интерфейса для проверки и обработки ключей, включая отзыв существующие ключи и создание нового ключа вручную.</span><span class="sxs-lookup"><span data-stu-id="e2562-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[Main](key-management/samples/key-management.cs)]

## <a name="key-storage"></a><span data-ttu-id="e2562-153">Хранение ключей</span><span class="sxs-lookup"><span data-stu-id="e2562-153">Key storage</span></span>

<span data-ttu-id="e2562-154">Система защиты данных имеет эвристики, при котором он пытается автоматически определить расположение соответствующего хранилища ключей и шифрование на механизм rest.</span><span class="sxs-lookup"><span data-stu-id="e2562-154">The data protection system has a heuristic whereby it tries to deduce an appropriate key storage location and encryption at rest mechanism automatically.</span></span> <span data-ttu-id="e2562-155">Это также можно настроить разработчиком приложения.</span><span class="sxs-lookup"><span data-stu-id="e2562-155">This is also configurable by the app developer.</span></span> <span data-ttu-id="e2562-156">Следующие документы рассматриваются в реализации этих механизмов:</span><span class="sxs-lookup"><span data-stu-id="e2562-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* [<span data-ttu-id="e2562-157">Поле поставщиков хранилища ключей</span><span class="sxs-lookup"><span data-stu-id="e2562-157">In-box key storage providers</span></span>](key-storage-providers.md#data-protection-implementation-key-storage-providers)

* [<span data-ttu-id="e2562-158">В поле ключа шифрования поставщиков rest</span><span class="sxs-lookup"><span data-stu-id="e2562-158">In-box key encryption at rest providers</span></span>](key-encryption-at-rest.md#data-protection-implementation-key-encryption-at-rest-providers)

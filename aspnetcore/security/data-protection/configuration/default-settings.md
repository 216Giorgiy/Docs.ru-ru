---
title: "Управление ключами и время существования"
author: rick-anderson
description: "Описывает управление ключами и временем существования."
keywords: "ASP.NET Core ключа управления DPAPI, DataProtection"
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.assetid: ef7dad2a-7029-4ae5-8f06-1fbebedccaa4
ms.technology: aspnet
ms.prod: asp.net-core
uid: security/data-protection/configuration/default-settings
ms.openlocfilehash: 913eda69f88ef05a990d9465024f4fa6b08cd1b7
ms.sourcegitcommit: 0b6c8e6d81d2b3c161cd375036eecbace46a9707
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2017
---
# <a name="key-management-and-lifetime"></a><span data-ttu-id="734df-104">Управление ключами и время существования</span><span class="sxs-lookup"><span data-stu-id="734df-104">Key management and lifetime</span></span>

<a name=data-protection-default-settings></a>

## <a name="key-management"></a><span data-ttu-id="734df-105">Управление ключами</span><span class="sxs-lookup"><span data-stu-id="734df-105">Key Management</span></span>

<span data-ttu-id="734df-106">Система пытается обнаружить его в рабочей среде и обеспечивают хорошей настройки поведения значения по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="734df-106">The system tries to detect its operational environment and provide good zero-configuration behavioral defaults.</span></span> <span data-ttu-id="734df-107">Используемая эвристика выглядит следующим образом.</span><span class="sxs-lookup"><span data-stu-id="734df-107">The heuristic used is as follows.</span></span>

1. <span data-ttu-id="734df-108">Если система размещенный в веб-сайтов Azure, ключи сохраняются в папку «% HOME%\ASP.NET\DataProtection-Keys».</span><span class="sxs-lookup"><span data-stu-id="734df-108">If the system is being hosted in Azure Web Sites, keys are persisted to the "%HOME%\ASP.NET\DataProtection-Keys" folder.</span></span> <span data-ttu-id="734df-109">Эта папка поддерживаемый сети хранения данных и синхронизации на всех компьютерах, где размещено приложение.</span><span class="sxs-lookup"><span data-stu-id="734df-109">This folder is backed by network storage and is synchronized across all machines hosting the application.</span></span> <span data-ttu-id="734df-110">Ключи не защищены при хранении.</span><span class="sxs-lookup"><span data-stu-id="734df-110">Keys are not protected at rest.</span></span> <span data-ttu-id="734df-111">Эта папка предоставляет ключей ко всем экземплярам приложения в одного слота развертывания.</span><span class="sxs-lookup"><span data-stu-id="734df-111">This folder supplies the key ring to all instances of an application in a single deployment slot.</span></span> <span data-ttu-id="734df-112">Слоты отдельное развертывание, например промежуточной и производственной сред, не будут совместно использовать ключ кольцо.</span><span class="sxs-lookup"><span data-stu-id="734df-112">Separate deployment slots, such as Staging and Production, will not share a key ring.</span></span> <span data-ttu-id="734df-113">При переключении между слотами развертывания, например Смена промежуточного хранения в рабочей среде или с использованием / B тестирование, любой системе с помощью защиты данных не будет иметь возможность расшифровать хранимым данным с помощью ключей в предыдущей области памяти.</span><span class="sxs-lookup"><span data-stu-id="734df-113">When you swap between deployment slots, for example swapping Staging to Production or using A/B testing, any system using data protection will not be able to decrypt stored data using the key ring inside the previous slot.</span></span> <span data-ttu-id="734df-114">Это приведет к пользователям, выполняется выход из приложения ASP.NET, использующего стандартный ASP.NET cookie по промежуточного слоя, как оно использует защиты данных, чтобы защитить свои файлы cookie.</span><span class="sxs-lookup"><span data-stu-id="734df-114">This will lead to users being logged out of an ASP.NET application that uses the standard ASP.NET cookie middleware, as it uses data protection to protect its cookies.</span></span> <span data-ttu-id="734df-115">При желании колец ключ слот независимый поставщик внешних ключей, такие как хранилище больших двоичных объектов Azure, хранилище ключей Azure, хранилище SQL, или кэш Redis.</span><span class="sxs-lookup"><span data-stu-id="734df-115">If you desire slot-independent key rings, use an external key ring provider, such as Azure Blob Storage, Azure Key Vault, a SQL store, or Redis cache.</span></span>

2. <span data-ttu-id="734df-116">Если профиль пользователя, ключи, сохраняются в папке «% LOCALAPPDATA%\ASP.NET\DataProtection-Keys».</span><span class="sxs-lookup"><span data-stu-id="734df-116">If the user profile is available, keys are persisted to the "%LOCALAPPDATA%\ASP.NET\DataProtection-Keys" folder.</span></span> <span data-ttu-id="734df-117">Кроме того Если операционная система Windows, они будут зашифрованы при хранении с помощью DPAPI.</span><span class="sxs-lookup"><span data-stu-id="734df-117">Additionally, if the operating system is Windows, they'll be encrypted at rest using DPAPI.</span></span>

3. <span data-ttu-id="734df-118">Если приложение размещается в службах IIS, ключи, сохраняются в реестре HKLM в специальный раздел реестра, ACLed только для учетной записи рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="734df-118">If the application is hosted in IIS, keys are persisted to the HKLM registry in a special registry key that is ACLed only to the worker process account.</span></span> <span data-ttu-id="734df-119">Они шифруются при хранении с помощью DPAPI.</span><span class="sxs-lookup"><span data-stu-id="734df-119">Keys are encrypted at rest using DPAPI.</span></span>

4. <span data-ttu-id="734df-120">Если ни одно из этих условий совпадает, ключи не сохраняются за пределами текущего процесса.</span><span class="sxs-lookup"><span data-stu-id="734df-120">If none of these conditions matches, keys are not persisted outside of the current process.</span></span> <span data-ttu-id="734df-121">Когда процесс завершится, все созданные ключи будут потеряны.</span><span class="sxs-lookup"><span data-stu-id="734df-121">When the process shuts down, all generated keys will be lost.</span></span>

<span data-ttu-id="734df-122">Разработчик получает полный контроль над всегда и можно переопределить, как и где хранятся ключи.</span><span class="sxs-lookup"><span data-stu-id="734df-122">The developer is always in full control and can override how and where keys are stored.</span></span> <span data-ttu-id="734df-123">Первые три параметра выше должен хорошо значения по умолчанию для большинства приложений, подобно тому, как ASP.NET <machineKey> работал для автоматического создания процедуры.</span><span class="sxs-lookup"><span data-stu-id="734df-123">The first three options above should good defaults for most applications similar to how the ASP.NET <machineKey> auto-generation routines worked in the past.</span></span> <span data-ttu-id="734df-124">Конечный, параметр обратной попадают — единственный сценарий, действительно требуется разработчику указать [конфигурации](overview.md) переднего плана, если им нужен сохраняемость ключа, но этот план должен встречаться только в тех редких случаях.</span><span class="sxs-lookup"><span data-stu-id="734df-124">The final, fall back option is the only scenario that truly requires the developer to specify [configuration](overview.md) upfront if they want key persistence, but this fall-back would only occur in rare situations.</span></span>

>[!WARNING]
> <span data-ttu-id="734df-125">Если разработчик переопределяет этот эвристический алгоритм и указывает система защиты данных на определенный репозиторий ключа, автоматическое шифрование ключей при хранении, будут отключены.</span><span class="sxs-lookup"><span data-stu-id="734df-125">If the developer overrides this heuristic and points the data protection system at a specific key repository, automatic encryption of keys at rest will be disabled.</span></span> <span data-ttu-id="734df-126">Неактивные защиту можно включить с помощью [конфигурации](overview.md).</span><span class="sxs-lookup"><span data-stu-id="734df-126">At rest protection can be re-enabled via [configuration](overview.md).</span></span>

## <a name="key-lifetime"></a><span data-ttu-id="734df-127">Время жизни ключа</span><span class="sxs-lookup"><span data-stu-id="734df-127">Key Lifetime</span></span>

<span data-ttu-id="734df-128">Ключи по умолчанию имеют жизни 90 дней.</span><span class="sxs-lookup"><span data-stu-id="734df-128">Keys by default have a 90-day lifetime.</span></span> <span data-ttu-id="734df-129">После истечения срока действия ключа, система автоматически создать новый ключ и назначить новый ключ активным ключом.</span><span class="sxs-lookup"><span data-stu-id="734df-129">When a key expires, the system will automatically generate a new key and set the new key as the active key.</span></span> <span data-ttu-id="734df-130">При условии, что удалено ключи остаются в системе вы по-прежнему сможете расшифровать данные, защищенные с их.</span><span class="sxs-lookup"><span data-stu-id="734df-130">As long as retired keys remain on the system you will still be able to decrypt any data protected with them.</span></span> <span data-ttu-id="734df-131">В разделе [управление ключами](../implementation/key-management.md#data-protection-implementation-key-management-expiration) для получения дополнительной информации.</span><span class="sxs-lookup"><span data-stu-id="734df-131">See [key management](../implementation/key-management.md#data-protection-implementation-key-management-expiration) for more information.</span></span>

## <a name="default-algorithms"></a><span data-ttu-id="734df-132">Алгоритмы по умолчанию</span><span class="sxs-lookup"><span data-stu-id="734df-132">Default Algorithms</span></span>

<span data-ttu-id="734df-133">Алгоритм защиты полезных данных по умолчанию, используемый — AES-256-CBC по конфиденциальности и HMACSHA256 подлинность.</span><span class="sxs-lookup"><span data-stu-id="734df-133">The default payload protection algorithm used is AES-256-CBC for confidentiality and HMACSHA256 for authenticity.</span></span> <span data-ttu-id="734df-134">512-разрядный главный ключ, откатывается каждые 90 дней, используется для формирования двух вложенных ключей, используемых для этих алгоритмов на основе каждого полезных данных.</span><span class="sxs-lookup"><span data-stu-id="734df-134">A 512-bit master key, rolled every 90 days, is used to derive the two sub-keys used for these algorithms on a per-payload basis.</span></span> <span data-ttu-id="734df-135">В разделе [подраздел производного](../implementation/subkeyderivation.md#data-protection-implementation-subkey-derivation-aad) для получения дополнительной информации.</span><span class="sxs-lookup"><span data-stu-id="734df-135">See [subkey derivation](../implementation/subkeyderivation.md#data-protection-implementation-subkey-derivation-aad) for more information.</span></span>

---
title: "Поставщик конфигурации Azure хранилища ключей"
author: guardrex
description: "Узнайте, как использовать поставщик конфигурации хранилища ключей Azure для настройки приложения с помощью пары имя значение во время выполнения."
manager: wpickett
ms.author: riande
ms.date: 08/09/2017
ms.prod: asp.net-core
ms.topic: article
uid: security/key-vault-configuration
ms.openlocfilehash: 1318ae855154dd8fc91ff0c19b0ab111d86c71e6
ms.sourcegitcommit: a510f38930abc84c4b302029d019a34dfe76823b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/30/2018
---
# <a name="azure-key-vault-configuration-provider"></a><span data-ttu-id="78ca0-103">Поставщик конфигурации Azure хранилища ключей</span><span class="sxs-lookup"><span data-stu-id="78ca0-103">Azure Key Vault configuration provider</span></span>

<span data-ttu-id="78ca0-104">По [Latham Люк](https://github.com/guardrex) и [Эндрю Stanton сиделка](https://github.com/anurse)</span><span class="sxs-lookup"><span data-stu-id="78ca0-104">By [Luke Latham](https://github.com/guardrex) and [Andrew Stanton-Nurse](https://github.com/anurse)</span></span>

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[<span data-ttu-id="78ca0-105">ASP.NET Core 2.x</span><span class="sxs-lookup"><span data-stu-id="78ca0-105">ASP.NET Core 2.x</span></span>](#tab/aspnetcore2x)

<span data-ttu-id="78ca0-106">Просмотреть или загрузить образец кода для 2.x:</span><span class="sxs-lookup"><span data-stu-id="78ca0-106">View or download sample code for 2.x:</span></span>

* <span data-ttu-id="78ca0-107">[Пример базового](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) ([загрузке](xref:tutorials/index#how-to-download-a-sample))-считывает значения секрета в приложение.</span><span class="sxs-lookup"><span data-stu-id="78ca0-107">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/2.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values into an app.</span></span>
* <span data-ttu-id="78ca0-108">[Образец префикс имени ключа](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) ([загрузке](xref:tutorials/index#how-to-download-a-sample)) — значения секрета операций чтения с помощью префикса имя ключа, представляющую версию приложения, который позволяет загрузить другой набор секретного значения для каждой версии приложения.</span><span class="sxs-lookup"><span data-stu-id="78ca0-108">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/2.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span>

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[<span data-ttu-id="78ca0-109">ASP.NET Core 1.x</span><span class="sxs-lookup"><span data-stu-id="78ca0-109">ASP.NET Core 1.x</span></span>](#tab/aspnetcore1x)

<span data-ttu-id="78ca0-110">Просмотреть или загрузить образец кода для 1.x:</span><span class="sxs-lookup"><span data-stu-id="78ca0-110">View or download sample code for 1.x:</span></span>

* <span data-ttu-id="78ca0-111">[Пример базового](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) ([загрузке](xref:tutorials/index#how-to-download-a-sample))-считывает значения секрета в приложение.</span><span class="sxs-lookup"><span data-stu-id="78ca0-111">[Basic sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/basic-sample/1.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values into an app.</span></span>
* <span data-ttu-id="78ca0-112">[Образец префикс имени ключа](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) ([загрузке](xref:tutorials/index#how-to-download-a-sample)) — значения секрета операций чтения с помощью префикса имя ключа, представляющую версию приложения, который позволяет загрузить другой набор секретного значения для каждой версии приложения.</span><span class="sxs-lookup"><span data-stu-id="78ca0-112">[Key name prefix sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples/key-name-prefix-sample/1.x) ([how to download](xref:tutorials/index#how-to-download-a-sample)) - Reads secret values using a key name prefix that represents the version of an app, which allows you to load a different set of secret values for each app version.</span></span> 

---

<span data-ttu-id="78ca0-113">В этом документе описывается использование [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) поставщик конфигурации для загрузки значения конфигурации из хранилища ключей Azure секретные данные.</span><span class="sxs-lookup"><span data-stu-id="78ca0-113">This document explains how to use the [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) configuration provider to load application configuration values from Azure Key Vault secrets.</span></span> <span data-ttu-id="78ca0-114">Хранилище ключей Azure является облачная служба, которая помогает защитить криптографических ключей и используемые приложения и службы.</span><span class="sxs-lookup"><span data-stu-id="78ca0-114">Azure Key Vault is a cloud-based service that helps you safeguard cryptographic keys and secrets used by apps and services.</span></span> <span data-ttu-id="78ca0-115">Обычные сценарии включают управление доступом к конфиденциальные данные конфигурации и удовлетворения требования для FIPS 140-2 уровня 2 проверяется аппаратные модули безопасности (HSM) во время хранения данных конфигурации.</span><span class="sxs-lookup"><span data-stu-id="78ca0-115">Common scenarios include controlling access to sensitive configuration data and meeting the requirement for FIPS 140-2 Level 2 validated Hardware Security Modules (HSM's) when storing configuration data.</span></span> <span data-ttu-id="78ca0-116">Эта функция предназначена для приложений, предназначенных для ASP.NET Core 1.1 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="78ca0-116">This feature is available for applications that target ASP.NET Core 1.1 or higher.</span></span>

## <a name="package"></a><span data-ttu-id="78ca0-117">Пакет</span><span class="sxs-lookup"><span data-stu-id="78ca0-117">Package</span></span>
<span data-ttu-id="78ca0-118">Чтобы использовать поставщик, добавьте ссылку на [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) пакета.</span><span class="sxs-lookup"><span data-stu-id="78ca0-118">To use the provider, add a reference to the [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span></span>

## <a name="application-configuration"></a><span data-ttu-id="78ca0-119">Настройка приложения</span><span class="sxs-lookup"><span data-stu-id="78ca0-119">Application configuration</span></span>
<span data-ttu-id="78ca0-120">Вы можете просматривать поставщика с [образец приложения](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span><span class="sxs-lookup"><span data-stu-id="78ca0-120">You can explore the provider with the [sample apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span></span> <span data-ttu-id="78ca0-121">После установления хранилища ключей и создать секреты в хранилище, в примерах приложений безопасно загрузить значения секрета в своей конфигурации и отобразить их на веб-страницах.</span><span class="sxs-lookup"><span data-stu-id="78ca0-121">Once you establish a key vault and create secrets in the vault, the sample apps securely load the secret values into their configurations and display them in webpages.</span></span>

<span data-ttu-id="78ca0-122">Поставщик добавляется `ConfigurationBuilder` с `AddAzureKeyVault` расширения.</span><span class="sxs-lookup"><span data-stu-id="78ca0-122">The provider is added to the `ConfigurationBuilder` with the `AddAzureKeyVault` extension.</span></span> <span data-ttu-id="78ca0-123">В примерах приложений, расширение использует три значения конфигурации, загруженного из *appsettings.json* файла.</span><span class="sxs-lookup"><span data-stu-id="78ca0-123">In the sample apps, the extension uses three configuration values loaded from the *appsettings.json* file.</span></span>

| <span data-ttu-id="78ca0-124">Параметры приложения</span><span class="sxs-lookup"><span data-stu-id="78ca0-124">App Setting</span></span>    | <span data-ttu-id="78ca0-125">Описание:</span><span class="sxs-lookup"><span data-stu-id="78ca0-125">Description</span></span>                    | <span data-ttu-id="78ca0-126">Пример</span><span class="sxs-lookup"><span data-stu-id="78ca0-126">Example</span></span>                                      |
| -------------- | ------------------------------ | -------------------------------------------- |
| `Vault`        | <span data-ttu-id="78ca0-127">Имя хранилища ключей Azure</span><span class="sxs-lookup"><span data-stu-id="78ca0-127">Azure Key Vault name</span></span>           | <span data-ttu-id="78ca0-128">contosovault</span><span class="sxs-lookup"><span data-stu-id="78ca0-128">contosovault</span></span>                                 |
| `ClientId`     | <span data-ttu-id="78ca0-129">Идентификатор приложения Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="78ca0-129">Azure Active Directory App Id</span></span>  | <span data-ttu-id="78ca0-130">627e911e-43cc-61d4-992e-12db9c81b413</span><span class="sxs-lookup"><span data-stu-id="78ca0-130">627e911e-43cc-61d4-992e-12db9c81b413</span></span>         |
| `ClientSecret` | <span data-ttu-id="78ca0-131">Ключ приложения Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="78ca0-131">Azure Active Directory App Key</span></span> | <span data-ttu-id="78ca0-132">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span><span class="sxs-lookup"><span data-stu-id="78ca0-132">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span></span> |

[!code-csharp[Program](key-vault-configuration/samples/basic-sample/2.x/Program.cs?name=snippet1&highlight=2,7-10)]

## <a name="creating-key-vault-secrets-and-loading-configuration-values-basic-sample"></a><span data-ttu-id="78ca0-133">Создание хранилища ключей секреты и загрузки значений конфигурации (basic образец)</span><span class="sxs-lookup"><span data-stu-id="78ca0-133">Creating key vault secrets and loading configuration values (basic-sample)</span></span>
1. <span data-ttu-id="78ca0-134">Создание хранилища ключей и настроить Azure Active Directory (Azure AD) для приложения согласно инструкциям в [приступить к работе с хранилищем ключей Azure](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="78ca0-134">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="78ca0-135">Добавьте секреты в хранилище ключей с использованием [модуль AzureRM ключ хранилища PowerShell](/powershell/module/azurerm.keyvault) доступны из [коллекции PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), [API REST хранилища ключей Azure](/rest/api/keyvault/), или [Портал azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="78ca0-135">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="78ca0-136">Секреты создаются как *вручную* или *сертификат* секретные данные.</span><span class="sxs-lookup"><span data-stu-id="78ca0-136">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="78ca0-137">*Сертификат* секретные данные, сертификаты для использования приложений и служб, но не поддерживаются поставщиком конфигурации.</span><span class="sxs-lookup"><span data-stu-id="78ca0-137">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="78ca0-138">Следует использовать *вручную* параметр, чтобы создать секреты пары "имя значение" для использования с поставщиком конфигурации.</span><span class="sxs-lookup"><span data-stu-id="78ca0-138">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="78ca0-139">Простой секреты, создаются в виде пар "имя значение".</span><span class="sxs-lookup"><span data-stu-id="78ca0-139">Simple secrets are created as name-value pairs.</span></span> <span data-ttu-id="78ca0-140">Azure имена секрета хранилища ключей, ограничены буквы, цифры и дефисы.</span><span class="sxs-lookup"><span data-stu-id="78ca0-140">Azure Key Vault secret names are limited to alphanumeric characters and dashes.</span></span>
    * <span data-ttu-id="78ca0-141">Используйте иерархическими значениями (разделы конфигурации) `--` (двух дефисов) в качестве разделителя в образце.</span><span class="sxs-lookup"><span data-stu-id="78ca0-141">Hierarchical values (configuration sections) use `--` (two dashes) as a separator in the sample.</span></span> <span data-ttu-id="78ca0-142">Имена, которые обычно используются для разделения раздел из подраздела в [конфигурации ASP.NET Core](xref:fundamentals/configuration/index), не разрешены в именах секрета.</span><span class="sxs-lookup"><span data-stu-id="78ca0-142">Colons, which are normally used to delimit a section from a subkey in [ASP.NET Core configuration](xref:fundamentals/configuration/index), aren't allowed in secret names.</span></span> <span data-ttu-id="78ca0-143">Таким образом используются и при загрузке секреты в конфигурации приложения для двоеточие местами двух дефисов.</span><span class="sxs-lookup"><span data-stu-id="78ca0-143">Therefore, two dashes are used and swapped for a colon when the secrets are loaded into the app's configuration.</span></span>
    * <span data-ttu-id="78ca0-144">Создайте два *вручную* секреты с помощью следующих пар имя значение.</span><span class="sxs-lookup"><span data-stu-id="78ca0-144">Create two *Manual* secrets with the following name-value pairs.</span></span> <span data-ttu-id="78ca0-145">Первый секретный код является простым именем и значением и второй секретный код создает секретное значение с раздел и раздел имя секрета:</span><span class="sxs-lookup"><span data-stu-id="78ca0-145">The first secret is a simple name and value, and the second secret creates a secret value with a section and subkey in the secret name:</span></span>
      * <span data-ttu-id="78ca0-146">`SecretName`: `secret_value_1`</span><span class="sxs-lookup"><span data-stu-id="78ca0-146">`SecretName`: `secret_value_1`</span></span>
      * <span data-ttu-id="78ca0-147">`Section--SecretName`: `secret_value_2`</span><span class="sxs-lookup"><span data-stu-id="78ca0-147">`Section--SecretName`: `secret_value_2`</span></span>
  * <span data-ttu-id="78ca0-148">Регистрация примера приложения в Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="78ca0-148">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="78ca0-149">Разрешить приложению доступ к хранилища ключей.</span><span class="sxs-lookup"><span data-stu-id="78ca0-149">Authorize the app to access the key vault.</span></span> <span data-ttu-id="78ca0-150">При использовании `Set-AzureRmKeyVaultAccessPolicy` командлет PowerShell, чтобы разрешить приложению доступ к хранилища ключей, обеспечивают `List` и `Get` доступ к секретной информации с `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="78ca0-150">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>
2. <span data-ttu-id="78ca0-151">Обновление приложения *appsettings.json* файл со значениями `Vault`, `ClientId`, и `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="78ca0-151">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="78ca0-152">Запустите пример приложения, который получает свои значения конфигурации `IConfigurationRoot` с тем же именем, как имя секрета.</span><span class="sxs-lookup"><span data-stu-id="78ca0-152">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the secret name.</span></span>
  * <span data-ttu-id="78ca0-153">Не иерархическими значениями: значение для `SecretName` получен с `config["SecretName"]`.</span><span class="sxs-lookup"><span data-stu-id="78ca0-153">Non-hierarchical values: The value for `SecretName` is obtained with `config["SecretName"]`.</span></span>
  * <span data-ttu-id="78ca0-154">Иерархическими значениями (разделов): используйте `:` нотации (двоеточие) или `GetSection` метода расширения.</span><span class="sxs-lookup"><span data-stu-id="78ca0-154">Hierarchical values (sections): Use `:` (colon) notation or the `GetSection` extension method.</span></span> <span data-ttu-id="78ca0-155">Выполните один из этих подходов, чтобы получить значение конфигурации.</span><span class="sxs-lookup"><span data-stu-id="78ca0-155">Use either of these approaches to obtain the configuration value:</span></span>
    * `config["Section:SecretName"]`
    * `config.GetSection("Section")["SecretName"]`

<span data-ttu-id="78ca0-156">При запуске приложения, загруженного секретного значения показаны веб-страницы:</span><span class="sxs-lookup"><span data-stu-id="78ca0-156">When you run the app, a webpage shows the loaded secret values:</span></span>

![Окно обозревателя, показывающее значения секрета, загруженного с помощью поставщика конфигурации хранилища ключей Azure](key-vault-configuration/_static/sample1.png)

## <a name="creating-prefixed-key-vault-secrets-and-loading-configuration-values-key-name-prefix-sample"></a><span data-ttu-id="78ca0-158">Создание секреты с префиксом хранилища ключей и загрузки значений конфигурации (ключ имя префикс образец)</span><span class="sxs-lookup"><span data-stu-id="78ca0-158">Creating prefixed key vault secrets and loading configuration values (key-name-prefix-sample)</span></span>
<span data-ttu-id="78ca0-159">`AddAzureKeyVault`также предоставляет перегрузку, которая принимает реализацию `IKeyVaultSecretManager`, позволяет управлять как ключевые хранилище секретов, преобразуются в конфигурации ключи.</span><span class="sxs-lookup"><span data-stu-id="78ca0-159">`AddAzureKeyVault` also provides an overload that accepts an implementation of `IKeyVaultSecretManager`, which allows you to control how key vault secrets are converted into configuration keys.</span></span> <span data-ttu-id="78ca0-160">Например можно реализовать интерфейс для загрузки значения секрета, на основе значения префикс вами при запуске приложения.</span><span class="sxs-lookup"><span data-stu-id="78ca0-160">For example, you can implement the interface to load secret values based on a prefix value you provide at app startup.</span></span> <span data-ttu-id="78ca0-161">Это позволит, например, загрузить секреты, в зависимости от версии приложения.</span><span class="sxs-lookup"><span data-stu-id="78ca0-161">This allows you, for example, to load secrets based on the version of the app.</span></span>

> [!WARNING]
> <span data-ttu-id="78ca0-162">Поместите секретных сведений для нескольких приложений в одном хранилище ключа или размещение среды секретов не используйте префиксы секреты в хранилище ключей (например, *разработки* verus *рабочей* секреты) в один хранилище.</span><span class="sxs-lookup"><span data-stu-id="78ca0-162">Don't use prefixes on key vault secrets to place secrets for multiple apps into the same key vault or to place environmental secrets (for example, *development* verus *production* secrets) into the same vault.</span></span> <span data-ttu-id="78ca0-163">Мы рекомендуем различных приложений и разработки и рабочих средах использовать отдельный ключа хранилища для изоляции приложения среды для самого высокого уровня безопасности.</span><span class="sxs-lookup"><span data-stu-id="78ca0-163">We recommend that different apps and development/production environments use separate key vaults to isolate app environments for the highest level of security.</span></span>

<span data-ttu-id="78ca0-164">С помощью второй пример приложения создайте секрета в хранилище ключей для `5000-AppSecret` (периоды не разрешены в именах секрета хранилища ключей) представляющий секрет приложения для версии 5.0.0.0 приложения.</span><span class="sxs-lookup"><span data-stu-id="78ca0-164">Using the second sample app, you create a secret in the key vault for `5000-AppSecret` (periods aren't allowed in key vault secret names) representing an app secret for version 5.0.0.0 of your app.</span></span> <span data-ttu-id="78ca0-165">Для другой версии, 5.1.0.0, создать секрет для `5100-AppSecret`.</span><span class="sxs-lookup"><span data-stu-id="78ca0-165">For another version, 5.1.0.0, you create a secret for `5100-AppSecret`.</span></span> <span data-ttu-id="78ca0-166">Каждая версия приложения загружает собственные секретное значение в его конфигурации как `AppSecret`, чередует off версии при загрузке секрета.</span><span class="sxs-lookup"><span data-stu-id="78ca0-166">Each app version loads its own secret value into its configuration as `AppSecret`, stripping off the version as it loads the secret.</span></span> <span data-ttu-id="78ca0-167">Ниже приводится пример реализации.</span><span class="sxs-lookup"><span data-stu-id="78ca0-167">The sample's implementation is shown below:</span></span>

[!code-csharp[Configuration builder](key-vault-configuration/samples/key-name-prefix-sample/2.x/Program.cs?name=snippet1&highlight=12)]

[!code-csharp[PrefixKeyVaultSecretManager](key-vault-configuration/samples/key-name-prefix-sample/2.x/Startup.cs?name=snippet1)]

<span data-ttu-id="78ca0-168">`Load` Метод вызывается с помощью алгоритма поставщик, выполняющий перебор элементов хранилище секретов, чтобы найти те, которые имеют префикс версии.</span><span class="sxs-lookup"><span data-stu-id="78ca0-168">The `Load` method is called by a provider algorithm that iterates through the vault secrets to find the ones that have the version prefix.</span></span> <span data-ttu-id="78ca0-169">Если найдена версия префикс с `Load`, алгоритм использует `GetKey` метод для возврата имени конфигурации имя секрета.</span><span class="sxs-lookup"><span data-stu-id="78ca0-169">When a version prefix is found with `Load`, the algorithm uses the `GetKey` method to return the configuration name of the secret name.</span></span> <span data-ttu-id="78ca0-170">Он отсекает версии префикс из имени секрета и возвращает остальные имя секрета для загрузки в конфигурации приложения пары "имя значение".</span><span class="sxs-lookup"><span data-stu-id="78ca0-170">It strips off the version prefix from the secret's name and returns the rest of the secret name for loading into the app's configuration name-value pairs.</span></span>

<span data-ttu-id="78ca0-171">При реализации этого подхода:</span><span class="sxs-lookup"><span data-stu-id="78ca0-171">When you implement this approach:</span></span>

1. <span data-ttu-id="78ca0-172">Загружаются секреты хранилища ключей.</span><span class="sxs-lookup"><span data-stu-id="78ca0-172">The key vault secrets are loaded.</span></span>
2. <span data-ttu-id="78ca0-173">Строка секрет для `5000-AppSecret` совпадении.</span><span class="sxs-lookup"><span data-stu-id="78ca0-173">The string secret for `5000-AppSecret` is matched.</span></span>
3. <span data-ttu-id="78ca0-174">Версия `5000` (на тире), исключается из оставить имя ключа `AppSecret` для загрузки с секретное значение в конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="78ca0-174">The version, `5000` (with the dash), is stripped off of the key name leaving `AppSecret` to load with the secret value into the app's configuration.</span></span>

> [!NOTE]
> <span data-ttu-id="78ca0-175">Можно также предоставить собственную `KeyVaultClient` реализации `AddAzureKeyVault`.</span><span class="sxs-lookup"><span data-stu-id="78ca0-175">You can also provide your own `KeyVaultClient` implementation to `AddAzureKeyVault`.</span></span> <span data-ttu-id="78ca0-176">Предоставление пользовательских клиентских позволяет совместно использовать один экземпляр клиента между поставщика конфигурации и другие части приложения.</span><span class="sxs-lookup"><span data-stu-id="78ca0-176">Supplying a custom client allows you to share a single instance of the client between the configuration provider and other parts of your app.</span></span>

1. <span data-ttu-id="78ca0-177">Создание хранилища ключей и настроить Azure Active Directory (Azure AD) для приложения согласно инструкциям в [приступить к работе с хранилищем ключей Azure](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="78ca0-177">Create a key vault and set up Azure Active Directory (Azure AD) for the application following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
  * <span data-ttu-id="78ca0-178">Добавьте секреты в хранилище ключей с использованием [модуль AzureRM ключ хранилища PowerShell](/powershell/module/azurerm.keyvault) доступны из [коллекции PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), [API REST хранилища ключей Azure](/rest/api/keyvault/), или [Портал azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="78ca0-178">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="78ca0-179">Секреты создаются как *вручную* или *сертификат* секретные данные.</span><span class="sxs-lookup"><span data-stu-id="78ca0-179">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="78ca0-180">*Сертификат* секретные данные, сертификаты для использования приложений и служб, но не поддерживаются поставщиком конфигурации.</span><span class="sxs-lookup"><span data-stu-id="78ca0-180">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="78ca0-181">Следует использовать *вручную* параметр, чтобы создать секреты пары "имя значение" для использования с поставщиком конфигурации.</span><span class="sxs-lookup"><span data-stu-id="78ca0-181">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
    * <span data-ttu-id="78ca0-182">Используйте иерархическими значениями (разделы конфигурации) `--` (двух дефисов) в качестве разделителя.</span><span class="sxs-lookup"><span data-stu-id="78ca0-182">Hierarchical values (configuration sections) use `--` (two dashes) as a separator.</span></span>
    * <span data-ttu-id="78ca0-183">Создайте два *вручную* секреты с помощью следующих пар имя значение:</span><span class="sxs-lookup"><span data-stu-id="78ca0-183">Create two *Manual* secrets with the following name-value pairs:</span></span>
      * <span data-ttu-id="78ca0-184">`5000-AppSecret`: `5.0.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="78ca0-184">`5000-AppSecret`: `5.0.0.0_secret_value`</span></span>
      * <span data-ttu-id="78ca0-185">`5100-AppSecret`: `5.1.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="78ca0-185">`5100-AppSecret`: `5.1.0.0_secret_value`</span></span>
  * <span data-ttu-id="78ca0-186">Регистрация примера приложения в Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="78ca0-186">Register the sample app with Azure Active Directory.</span></span>
  * <span data-ttu-id="78ca0-187">Разрешить приложению доступ к хранилища ключей.</span><span class="sxs-lookup"><span data-stu-id="78ca0-187">Authorize the app to access the key vault.</span></span> <span data-ttu-id="78ca0-188">При использовании `Set-AzureRmKeyVaultAccessPolicy` командлет PowerShell, чтобы разрешить приложению доступ к хранилища ключей, обеспечивают `List` и `Get` доступ к секретной информации с `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="78ca0-188">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>
2. <span data-ttu-id="78ca0-189">Обновление приложения *appsettings.json* файл со значениями `Vault`, `ClientId`, и `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="78ca0-189">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="78ca0-190">Запустите пример приложения, который получает свои значения конфигурации `IConfigurationRoot` с тем же именем, как имя с префиксом секрета.</span><span class="sxs-lookup"><span data-stu-id="78ca0-190">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the prefixed secret name.</span></span> <span data-ttu-id="78ca0-191">В этом образце используется префикс версию приложения, что вы указали `PrefixKeyVaultSecretManager` при добавлении поставщика хранилища ключей Azure конфигурации.</span><span class="sxs-lookup"><span data-stu-id="78ca0-191">In this sample, the prefix is the app's version, which you provided to the `PrefixKeyVaultSecretManager` when you added the Azure Key Vault configuration provider.</span></span> <span data-ttu-id="78ca0-192">Значение для `AppSecret` получен с `config["AppSecret"]`.</span><span class="sxs-lookup"><span data-stu-id="78ca0-192">The value for `AppSecret` is obtained with `config["AppSecret"]`.</span></span> <span data-ttu-id="78ca0-193">Веб-страницы, созданный приложением показано загруженное значение.</span><span class="sxs-lookup"><span data-stu-id="78ca0-193">The webpage generated by the app shows the loaded value:</span></span>

   ![Окно обозревателя, показывающее секретное значение, загруженного с помощью поставщика конфигурации хранилища ключей Azure при 5.0.0.0 версии приложения](key-vault-configuration/_static/sample2-1.png)

4. <span data-ttu-id="78ca0-195">Изменить версию сборки приложения в файле проекта из `5.0.0.0` для `5.1.0.0` и снова запустите приложение.</span><span class="sxs-lookup"><span data-stu-id="78ca0-195">Change the version of the app assembly in the project file from `5.0.0.0` to `5.1.0.0` and run the app again.</span></span> <span data-ttu-id="78ca0-196">На этот раз секретный возвращаемое значение `5.1.0.0_secret_value`.</span><span class="sxs-lookup"><span data-stu-id="78ca0-196">This time, the secret value returned is `5.1.0.0_secret_value`.</span></span> <span data-ttu-id="78ca0-197">Веб-страницы, созданный приложением показано загруженное значение.</span><span class="sxs-lookup"><span data-stu-id="78ca0-197">The webpage generated by the app shows the loaded value:</span></span>

   ![Окно обозревателя, показывающее секретное значение, загруженного с помощью поставщика конфигурации хранилища ключей Azure при 5.1.0.0 версии приложения](key-vault-configuration/_static/sample2-2.png)

## <a name="controlling-access-to-the-clientsecret"></a><span data-ttu-id="78ca0-199">Управление доступом к ClientSecret</span><span class="sxs-lookup"><span data-stu-id="78ca0-199">Controlling access to the ClientSecret</span></span>
<span data-ttu-id="78ca0-200">Используйте [секрет диспетчера](xref:security/app-secrets) для поддержания `ClientSecret` вне дерева исходного проекта.</span><span class="sxs-lookup"><span data-stu-id="78ca0-200">Use the [Secret Manager tool](xref:security/app-secrets) to maintain the `ClientSecret` outside of your project source tree.</span></span> <span data-ttu-id="78ca0-201">С помощью диспетчера секрет связывается с конкретным проектом секрета приложения и использовать их совместно в нескольких проектах.</span><span class="sxs-lookup"><span data-stu-id="78ca0-201">With Secret Manager, you associate app secrets with a specific project and share them across multiple projects.</span></span>

<span data-ttu-id="78ca0-202">При разработке приложения .NET Framework в среде, поддерживающей сертификаты, можно проверить подлинность в хранилище ключей Azure с помощью сертификата X.509.</span><span class="sxs-lookup"><span data-stu-id="78ca0-202">When developing a .NET Framework app in an environment that supports certificates, you can authenticate to Azure Key Vault with an X.509 certificate.</span></span> <span data-ttu-id="78ca0-203">Операционная система управляет закрытый ключ сертификата X.509.</span><span class="sxs-lookup"><span data-stu-id="78ca0-203">The X.509 certificate's private key is managed by the OS.</span></span> <span data-ttu-id="78ca0-204">Дополнительные сведения см. в разделе [проверка подлинности с помощью сертификата, вместо секрет клиента](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span><span class="sxs-lookup"><span data-stu-id="78ca0-204">For more information, see [Authenticate with a Certificate instead of a Client Secret](https://docs.microsoft.com/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span></span> <span data-ttu-id="78ca0-205">Используйте `AddAzureKeyVault` перегрузку, которая принимает `X509Certificate2`.</span><span class="sxs-lookup"><span data-stu-id="78ca0-205">Use the `AddAzureKeyVault` overload that accepts an `X509Certificate2`.</span></span>

```csharp
var store = new X509Store(StoreLocation.CurrentUser);
store.Open(OpenFlags.ReadOnly);
var cert = store.Certificates.Find(X509FindType.FindByThumbprint, config["CertificateThumbprint"], false);

builder.AddAzureKeyVault(
    config["Vault"],
    config["ClientId"],
    cert.OfType<X509Certificate2>().Single(),
    new EnvironmentSecretManager(env.ApplicationName));
store.Close();

Configuration = builder.Build();
```

## <a name="reloading-secrets"></a><span data-ttu-id="78ca0-206">Повторная загрузка секретов</span><span class="sxs-lookup"><span data-stu-id="78ca0-206">Reloading secrets</span></span>
<span data-ttu-id="78ca0-207">Секретные данные кэшируются до `IConfigurationRoot.Reload()` вызывается.</span><span class="sxs-lookup"><span data-stu-id="78ca0-207">Secrets are cached until `IConfigurationRoot.Reload()` is called.</span></span> <span data-ttu-id="78ca0-208">Истек, отключена, и приложению, пока не учитываются обновленные секреты в хранилище ключей `Reload` выполняется.</span><span class="sxs-lookup"><span data-stu-id="78ca0-208">Expired, disabled, and updated secrets in the key vault are not respected by the application until `Reload` is executed.</span></span>

```csharp
Configuration.Reload();
```

## <a name="disabled-and-expired-secrets"></a><span data-ttu-id="78ca0-209">Секреты отключено и устаревших записей</span><span class="sxs-lookup"><span data-stu-id="78ca0-209">Disabled and expired secrets</span></span>
<span data-ttu-id="78ca0-210">Секреты отключено и устаревших throw `KeyVaultClientException`.</span><span class="sxs-lookup"><span data-stu-id="78ca0-210">Disabled and expired secrets throw a `KeyVaultClientException`.</span></span> <span data-ttu-id="78ca0-211">Чтобы избежать возникновения приложения, замените приложение или обновление секрета отключена или истек срок действия.</span><span class="sxs-lookup"><span data-stu-id="78ca0-211">To prevent your app from throwing, replace your app or update the disabled/expired secret.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="78ca0-212">Устранение неполадок</span><span class="sxs-lookup"><span data-stu-id="78ca0-212">Troubleshooting</span></span>
<span data-ttu-id="78ca0-213">Если приложению не удается загрузить конфигурацию с помощью поставщика, сообщение об ошибке записывается [инфраструктуры ASP.NET ведения журнала](xref:fundamentals/logging/index).</span><span class="sxs-lookup"><span data-stu-id="78ca0-213">When the application fails to load configuration using the provider, an error message is written to the [ASP.NET Logging infrastructure](xref:fundamentals/logging/index).</span></span> <span data-ttu-id="78ca0-214">Следующие условия не позволит конфигурации загрузки:</span><span class="sxs-lookup"><span data-stu-id="78ca0-214">The following conditions will prevent configuration from loading:</span></span>
* <span data-ttu-id="78ca0-215">Приложения не настроен правильно в Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="78ca0-215">The app isn't configured correctly in Azure Active Directory.</span></span>
* <span data-ttu-id="78ca0-216">Хранилище ключей не существует в хранилище ключей Azure.</span><span class="sxs-lookup"><span data-stu-id="78ca0-216">The key vault doesn't exist in Azure Key Vault.</span></span>
* <span data-ttu-id="78ca0-217">Приложение не имеет разрешения доступа к хранилищу ключей.</span><span class="sxs-lookup"><span data-stu-id="78ca0-217">The app isn't authorized to access the key vault.</span></span>
* <span data-ttu-id="78ca0-218">Политика доступа не включает `Get` и `List` разрешения.</span><span class="sxs-lookup"><span data-stu-id="78ca0-218">The access policy doesn't include `Get` and `List` permissions.</span></span>
* <span data-ttu-id="78ca0-219">В хранилище ключей данных конфигурации (пара «имя значение») неправильно называется, отсутствует, отключена или истек срок действия.</span><span class="sxs-lookup"><span data-stu-id="78ca0-219">In the key vault, the configuration data (name-value pair) is incorrectly named, missing, disabled, or expired.</span></span>
* <span data-ttu-id="78ca0-220">Приложение имеет имя неверного ключа хранилища (`Vault`), идентификатор приложения Azure AD (`ClientId`), или ключ Azure AD (`ClientSecret`).</span><span class="sxs-lookup"><span data-stu-id="78ca0-220">The app has the wrong key vault name (`Vault`), Azure AD App Id (`ClientId`), or Azure AD Key (`ClientSecret`).</span></span>
* <span data-ttu-id="78ca0-221">Ключ Azure AD (`ClientSecret`) истек срок действия.</span><span class="sxs-lookup"><span data-stu-id="78ca0-221">The Azure AD Key (`ClientSecret`) is expired.</span></span>
* <span data-ttu-id="78ca0-222">В приложении для значение, которое вы пытаетесь загрузить неверный ключ конфигурации (имя).</span><span class="sxs-lookup"><span data-stu-id="78ca0-222">The configuration key (name) is incorrect in the app for the value you're trying to load.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="78ca0-223">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="78ca0-223">Additional resources</span></span>
* [<span data-ttu-id="78ca0-224">Конфигурация</span><span class="sxs-lookup"><span data-stu-id="78ca0-224">Configuration</span></span>](xref:fundamentals/configuration/index)
* [<span data-ttu-id="78ca0-225">Microsoft Azure: Хранилище ключей</span><span class="sxs-lookup"><span data-stu-id="78ca0-225">Microsoft Azure: Key Vault</span></span>](https://azure.microsoft.com/services/key-vault/)
* [<span data-ttu-id="78ca0-226">Microsoft Azure: Документации хранилища ключей</span><span class="sxs-lookup"><span data-stu-id="78ca0-226">Microsoft Azure: Key Vault Documentation</span></span>](https://docs.microsoft.com/azure/key-vault/)
* [<span data-ttu-id="78ca0-227">Описание способов создания и передачи, защищенных HSM ключей для хранилища ключей Azure</span><span class="sxs-lookup"><span data-stu-id="78ca0-227">How to generate and transfer HSM-protected keys for Azure Key Vault</span></span>](https://docs.microsoft.com/azure/key-vault/key-vault-hsm-protected-keys)
* [<span data-ttu-id="78ca0-228">Класс KeyVaultClient</span><span class="sxs-lookup"><span data-stu-id="78ca0-228">KeyVaultClient Class</span></span>](https://docs.microsoft.com/dotnet/api/microsoft.azure.keyvault.keyvaultclient)

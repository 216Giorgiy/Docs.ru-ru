---
title: "Работа с несколькими средами в ASP.NET Core"
author: ardalis
description: "Узнайте, как ASP.NET Core предоставляет поддержку для управления поведением приложения в нескольких средах."
keywords: "ASP.NET Core, параметры среды, ASPNETCORE_ENVIRONMENT"
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.assetid: b5bba985-be12-4464-9a01-df3599b2a6f1
ms.technology: aspnet
ms.prod: asp.net-core
uid: fundamentals/environments
ms.openlocfilehash: becdfa647acb6483b39f5421ab881c4817f31c40
ms.sourcegitcommit: e3b1726cc04e80dc28464c35259edbd3bc39a438
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/12/2017
---
# <a name="working-with-multiple-environments"></a>Работа с несколькими средами

По [Стив Смит](https://ardalis.com/)

ASP.NET Core обеспечивает поддержку для управления поведением приложения в нескольких средах, например разработки, промежуточной и производственной. Переменные среды используются для указания среды выполнения, что позволяет приложению должны быть настроены для этой среды.

[Просмотреть или скачать образец кода](https://github.com/aspnet/Docs/tree/master/aspnetcore/fundamentals/environments/sample) ([как скачивать](xref:tutorials/index#how-to-download-a-sample))

## <a name="development-staging-production"></a>Разработка решений, промежуточное хранение производства

ASP.NET Core ссылается на переменную среды, `ASPNETCORE_ENVIRONMENT` для описания приложения в данный момент работает в среде. Эту переменную можно задать любое значение, например, но по соглашению используются три значения: `Development`, `Staging`, и `Production`. Вы найдете следующие значения, используемые в примерах и шаблоны в ASP.NET Core.

Текущее значение параметра среде могут быть обнаружены программным образом из в приложении. Кроме того, можно использовать среду [тег вспомогательный](../mvc/views/tag-helpers/index.md) для включения определенных разделов в вашей [представление](../mvc/views/index.md) в зависимости от текущей среды приложения.

Обратите внимание: В Windows и macOS, заданным именем среды регистр не учитывается. Является ли значение переменной `Development` или `development` или `DEVELOPMENT` результаты будут одинаковыми. Тем не менее, является Linux **регистра** ОС по умолчанию. Переменные среды, имена файлов и параметры требуют чувствительность к регистру.

### <a name="development"></a>Разработка

Это должна быть среды, используемые при разработке приложения. Обычно он используется для включения возможностей, которые вы не должны быть доступны при запуске приложения в рабочей среде, такие как [страницы разработчик исключений](xref:fundamentals/error-handling#the-developer-exception-page).

Если вы используете Visual Studio, можно настроить среду в профилей отладки проекта. Отладка профилей укажите [сервера](xref:fundamentals/servers/index) для использования при запуске приложения и любых переменных окружения требуется задать. Проект может иметь несколько профилей отладки, которые по-разному задать переменные среды. С помощью управления этими профилями **отладки** вкладке проекта веб-приложения **свойства** меню. Значения, заданные в свойствах проекта сохраняются в *launchSettings.json* файла и можно также настроить профили путем непосредственного изменения этого файла.

Профиль для IIS Express показан ниже:

![Переменные среды параметр свойства проекта](environments/_static/project-properties-debug.png)

Вот `launchSettings.json` файл, который включает профили для `Development` и `Staging`:

[!code-json[Main](../fundamentals/environments/sample/src/Environments/Properties/launchSettings.json?highlight=15,22)]

Изменения, внесенные в проект профилей могут не вступили в силу только после перезапуска веб-сервера используется (в частности, Kestrel необходимо перезагрузить перед он обнаруживает изменения, внесенные в своей среде).

>[!WARNING]
> Переменные среды сохраняются в *launchSettings.json* не защищены каким-либо образом и будет входить в состав репозиторий исходного кода для проекта, если используется один. **Никогда не храните учетные данные или другие секретные данные в этот файл.** Если вам требуется место для хранения таких данных, используйте *секрет диспетчер* средство описано в [безопасного хранения секрета приложения во время разработки](xref:security/app-secrets).

### <a name="staging"></a>Промежуточный

По соглашению `Staging` среда находится в предварительной рабочей среде для окончательного тестирования перед развертыванием в рабочей среде. В идеальном случае его физических характеристик, должны быть зеркально производства, чтобы все проблемы, которые могут возникнуть в рабочей среде, сначала выполнялись в промежуточной среде, где они обращаться не окажет влияния на пользователей.

### <a name="production"></a>Производство

`Production` Среда — это среда, в которой выполняется приложение после его запуска и используется конечными пользователями. Эта среда должны быть настроены для повышения безопасности, производительности и надежности приложений. Ниже перечислены некоторые общие параметры, которые, возможно, в производственную среду, будут отличаться от разработки.

* Включить кэширование

* Убедитесь, объединяются в один пакет, уменьшено и потенциально полученном из CDN все ресурсы на стороне клиента

* Отключить ErrorPages диагностики

* Включите страницы с сообщением об ошибке

* Включить производства, ведение журнала и мониторинг (например, [Application Insights](https://azure.microsoft.com/documentation/articles/app-insights-asp-net-five/))

Это ни в коем случае должен быть полный список. Лучше избегать рассеивания проверки среды во многих частях приложения. Вместо этого рекомендуется для выполнения таких проверок в приложении `Startup` классов там, где возможно

## <a name="setting-the-environment"></a>Настройка среды

Метод для настройки среды, зависит от операционной системы.

### <a name="windows"></a>Windows
Чтобы задать `ASPNETCORE_ENVIRONMENT` для текущего сеанса, если приложение запускается с помощью `dotnet run`, используются следующие команды

**командная строка;**
```
set ASPNETCORE_ENVIRONMENT=Development
```
**PowerShell**
```
$Env:ASPNETCORE_ENVIRONMENT = "Development"
```

Эти команды вступают в силу только для текущего окна. При закрытии окна параметр ASPNETCORE_ENVIRONMENT возвращается по умолчанию или значение машины. Чтобы установить значение глобально при открытии Windows **панели управления** > **системы** > **расширенных параметров системы** и добавление или изменение `ASPNETCORE_ENVIRONMENT` значение.

![Дополнительные свойства системы](environments/_static/systemsetting_environment.png)

![Переменная среды ASPNET Core](environments/_static/windows_aspnetcore_environment.png) 

**файл Web.config**

В разделе *задание переменных среды* раздел [Справочник по конфигурации модуля ASP.NET Core](xref:hosting/aspnet-core-module#setting-environment-variables) раздела.

**На пул приложений IIS**

Если нужно задать переменные среды для отдельных приложений, выполняющихся в изолированных пулах приложений (такая возможность поддерживается в службах IIS 10.0 и более поздних версий), см. подраздел, посвященный *команде AppCmd.exe*, в разделе [Переменные среды \<environmentVariables>](/iis/configuration/system.applicationHost/applicationPools/add/environmentVariables/#appcmdexe) справочной документации по службам IIS.

### <a name="macos"></a>MacOS
Установка текущей среды для macOS можно сделать в строки при запуске приложения;

```bash
ASPNETCORE_ENVIRONMENT=Development dotnet run
```
или с помощью `export` задайте его перед запуском приложения.

```bash
export ASPNETCORE_ENVIRONMENT=Development
``` 
Переменные среды уровня машины задаются *.bashrc* или *.bash_profile* файла. Измените файл, используя любой текстовый редактор и добавьте следующий оператор.

```
export ASPNETCORE_ENVIRONMENT=Development
```  

### <a name="linux"></a>Linux
Дистрибутивы Linux, используйте `export` команды из командной строки для параметров переменных на основе сеансов и *bash_profile* файла параметров уровня среды компьютера.

## <a name="determining-the-environment-at-runtime"></a>Определение среды во время выполнения

`IHostingEnvironment` Служба предоставляет основная абстракция для работы со средами. Эта служба предоставляется с ASP.NET Размещение слоя и могут быть внесены в логику запуска через [внедрения зависимостей](dependency-injection.md). Шаблон веб-сайта ASP.NET Core в Visual Studio использует этот подход для загрузки файлов конфигурации, относящиеся к среде (при его наличии) и настроить параметры обработки ошибок приложения. В обоих случаях это достигается с помощью ссылки на среду в настоящее время путем вызова `EnvironmentName` или `IsEnvironment` на экземпляре `IHostingEnvironment` переданные в соответствующий метод.

> [!NOTE]
> Если необходимо проверить, выполняется ли приложение в конкретной среде, используйте `env.IsEnvironment("environmentname")` , так как он правильно не учитывать регистр (вместо проверки `env.EnvironmentName == "Development"` например).

Например можно использовать следующий код в методе Настройка для настройки среды обработки определенных ошибок:

[!code-csharp[Main](environments/sample/src/Environments/Startup.cs?range=19-30)]

Если приложение выполняется `Development` среде, а затем она включает поддержку среды выполнения, необходимо использовать функцию «BrowserLink» в Visual Studio, страницы ошибки разработки (которые обычно не должны выполняться в рабочей среде) и ошибка специальная база данных страницы (которые предоставляют способ примените миграции и поэтому можно использовать только при разработке). В противном случае если приложение не выполняется в среде разработки, страница Стандартная ошибка обработки настроена для отображения в ответ на необработанные исключения.

Необходимо определить, какое содержимое для отправки клиенту во время выполнения, в зависимости от текущей среды. Например в среде разработки вы обычно служат не свернуто сценариев и стилей, которые облегчает процесс отладки. Уменьшенная версий должна использоваться в производственной среде и тестовых средах и обычно из CDN. Это можно сделать с помощью среды [тег вспомогательный](../mvc/views/tag-helpers/intro.md). Вспомогательный тега среды будет отображать его содержимое, только если текущая среда соответствует одному из среды, заданные с помощью `names` атрибута.

[!code-html[Main](environments/sample/src/Environments/Views/Shared/_Layout.cshtml?range=13-22)]

Чтобы начать работу с помощью вспомогательных функций тегов см. в разделе вашего приложения [Общие сведения о вспомогательных функций тегов](../mvc/views/tag-helpers/intro.md).

## <a name="startup-conventions"></a>При запуске соглашения

ASP.NET Core поддерживает подход, основанный на соглашение, с настройкой запуска приложения, в зависимости от текущей среды. Можно также программно управлять поведение приложения в соответствии с какой среде он находится, позволяя создавать и управлять ими свои собственные соглашения.

При запуске приложения ASP.NET Core `Startup` класс используется для начальной загрузки приложения и загрузите его параметры конфигурации, т. д. ([Дополнительные сведения о запуске ASP.NET](startup.md)). Тем не менее, если существует класс с именем `Startup{EnvironmentName}` (например `StartupDevelopment`) и `ASPNETCORE_ENVIRONMENT` соответствует переменной среды, имя, а затем, `Startup` вместо него используется класс. Таким образом, можно настроить `Startup` для разработки, но имеют отдельные `StartupProduction` , будет использоваться при запуске приложения в рабочей среде. И наоборот.

> [!NOTE]
> Вызов `WebHostBuilder.UseStartup<TStartup>()` переопределяет разделы конфигурации.

Помимо использования совершенно разные `Startup` класса, в зависимости от текущей среды, также можно внести изменения в настройки приложения в `Startup` класса. `Configure()` И `ConfigureServices()` методы поддерживают конкретных версий аналогично `Startup` класса формы `Configure{EnvironmentName}()` и `Configure{EnvironmentName}Services()`. Если определить метод `ConfigureDevelopment()` он будет вызван вместо `Configure()` Если имеет значение среды разработки. Аналогичным образом `ConfigureDevelopmentServices()` вызывается вместо `ConfigureServices()` в той же среде.

## <a name="summary"></a>Сводка

ASP.NET Core предоставляет ряд функций и соглашения, которые позволяют разработчикам легко управлять работой своих приложений в различных средах. При публикации приложения из среды разработки для промежуточного хранения в рабочей среде, заданных переменных среды соответствующим образом для среды позволяет оптимизировать приложения для отладки, тестирования или рабочей среде используйте соответствующим образом.

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Конфигурация](configuration.md)

* [Общие сведения о вспомогательных функциях тегов](../mvc/views/tag-helpers/intro.md)

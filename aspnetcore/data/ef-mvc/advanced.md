---
title: "Основные ASP.NET MVC с основными EF - Дополнительно - 10 из 10"
author: tdykstra
description: "В этом учебнике рассказывается несколько разделов, которые необходимо иметь в виду при переходе расширенные возможности разработки веб-приложений ASP.NET, использующие Entity Framework Core."
ms.author: tdykstra
manager: wpickett
ms.date: 03/15/2017
ms.topic: get-started-article
ms.technology: aspnet
ms.prod: asp.net-core
uid: data/ef-mvc/advanced
ms.openlocfilehash: b1d1cb8710595acd72bd5a0786bf1b1fed8b1d79
ms.sourcegitcommit: 09b342b45e7372ba9ebf17f35eee331e5a08fb26
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/26/2018
---
# <a name="advanced-topics---ef-core-with-aspnet-core-mvc-tutorial-10-of-10"></a>Дополнительные разделы - Core EF учебнику ASP.NET Core MVC (10, 10)

По [Tom Dykstra](https://github.com/tdykstra) и [Рик Андерсон](https://twitter.com/RickAndMSFT)

Contoso университета примера веб-приложения показано, как создавать веб-приложения ASP.NET MVC ядра с помощью основного Entity Framework и Visual Studio. Сведения о учебника серии см [в первом учебнике ряда](intro.md).

В предыдущем учебнике реализован таблица на иерархию наследования. В этом учебнике рассказывается несколько разделов, которые необходимо иметь в виду при переходе расширенные возможности разработки веб-приложений ASP.NET Core, использующие Entity Framework Core.

## <a name="raw-sql-queries"></a>Необработанный SQL-запросов

Одним из преимуществ использования платформы Entity Framework является позволяет избежать прерывания кода слишком близко к конкретного метода хранения данных. Это делается путем создания SQL-запросов и команд, который избавляет от необходимости записывать их. Но существуют исключительных случаях, когда необходимо запустить конкретных запросов SQL, созданных вручную. В этих сценариях API первый Entity Framework кода включает методы, которые позволяют передавать команды SQL непосредственно к базе данных. В версии 1.0 Core EF доступны следующие варианты:

* Используйте `DbSet.FromSql` метод для запросов, возвращающих типы сущностей. Возвращаемые объекты должно относится к типу, ожидаемому `DbSet` объекта, а также выполняется автоматически отслеживаются контекстом контекст базы данных пока не вы [отключить отслеживание](crud.md#no-tracking-queries).

* Используйте `Database.ExecuteSqlCommand` для команды без запроса.

Если необходимо выполнить запрос, возвращающий типы, которые не являются сущностями, можно использовать ADO.NET с помощью подключения к базе данных, предоставляемые EF. Возвращаемые данные не отслеживается контекст базы данных, даже при использовании этого метода на получение типов сущностей.

Как всегда имеет значение true при выполнении команды SQL для веб-приложения, необходимо принять меры предосторожности, чтобы защитить сайт от атак путем внедрения кода SQL. Один из способов сделать это является использование параметризованных запросов, чтобы убедиться в том, что строки, отправленных веб-страницы не может интерпретироваться как команды SQL. В этом учебнике будет использоваться параметризованные запросы при интеграции ввод данных пользователем в запросе.

## <a name="call-a-query-that-returns-entities"></a>Вызовите запрос, возвращающий сущностей

`DbSet<TEntity>` Класс предоставляет метод, который можно использовать для выполнения запроса, возвращающее сущность типа `TEntity`. Чтобы увидеть, как это работает, можно будет изменить код в `Details` метод контроллера отдела.

В *DepartmentsController.cs*в `Details` метод, замените код, который извлекает отдел с `FromSql` вызова метода, как показано в следующий выделенный код:

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?name=snippet_RawSQL&highlight=8,9,10,13)]

Чтобы убедиться, что новый код работает неправильно, выберите **отделы** tab и затем **сведения** для одного из отделов.

![Сведения об отделе](advanced/_static/department-details.png)

## <a name="call-a-query-that-returns-other-types"></a>Вызовите запрос, возвращающий других типов

Ранее вы создали сетку статистики студента страницу о программе показано число учеников для каждой даты регистрации. Получить данные из набора сущностей учащихся (`_context.Students`) и использовать LINQ проецировать результаты в список `EnrollmentDateGroup` просматривать объекты модели. Предположим, что вы планируете написать SQL себя, а не с помощью LINQ. Для выполнения, необходимо выполнить SQL-запрос, который возвращает нечто, отличное от объектов сущностей. В версии 1.0 Core EF один из способов сделать это — писать код ADO.NET и получить из EF подключения к базе данных.

В *HomeController.cs*, замените `About` метод следующим кодом:

[!code-csharp[Main](intro/samples/cu/Controllers/HomeController.cs?name=snippet_UseRawSQL&highlight=3-32)]

Добавить с помощью инструкции:

[!code-csharp[Main](intro/samples/cu/Controllers/HomeController.cs?name=snippet_Usings2)]

Запустите приложение и перейти на страницу о программе. Он отображает те же данные, которые раньше.

![О странице](advanced/_static/about.png)

## <a name="call-an-update-query"></a>Вызовите запрос на обновление

Предположим, что администраторы университета Contoso требуется для выполнения глобальных изменений в базе данных, например изменение количества кредиты для каждого курса. Если университета имеет большое количество курсов, было бы неэффективно, извлекать их все как сущности и измените их по отдельности. В этом разделе будет реализован веб-страницы, которая позволяет пользователю указать коэффициент, используемый для изменения номера кредиты для всех курсов и вносятся изменения, выполнив инструкцию SQL UPDATE. Веб-страница будет выглядеть как на следующем рисунке:

![Страница «обновление» отзывы о курсе](advanced/_static/update-credits.png)

В *CoursesContoller.cs*, добавьте методы UpdateCourseCredits HttpGet и HttpPost:

[!code-csharp[Main](intro/samples/cu/Controllers/CoursesController.cs?name=snippet_UpdateGet)]

[!code-csharp[Main](intro/samples/cu/Controllers/CoursesController.cs?name=snippet_UpdatePost)]

Когда контроллер обрабатывает запрос HttpGet, ничего не возвращается в `ViewData["RowsAffected"]`, и в представлении отображаются пустые текстовые поля и кнопки "Отправить", как показано на предыдущем рисунке.

Когда **обновление** кнопки, вызывается метод HttpPost и множитель имеет значение, введенное в текстовом поле. Затем выполняется код SQL, которая обновляет курсы и возвращает количество задействованных строк в представление `ViewData`. Если представление получает `RowsAffected` значение, отображается количество обновленных строк.

В **обозревателе решений**, щелкните правой кнопкой мыши *представления и курсов* папки, а затем щелкните **Добавить > новый элемент**.

В **Добавление нового элемента** диалоговое окно, нажмите кнопку **ASP.NET** под **установленные** в левой области щелкните **страница представления MVC**и имя нового представления  *UpdateCourseCredits.cshtml*.

В *Views/Courses/UpdateCourseCredits.cshtml*, замените код шаблона в следующий код:

[!code-html[Main](intro/samples/cu/Views/Courses/UpdateCourseCredits.cshtml)]

Запустите `UpdateCourseCredits` метод, выбрав **курсы** вкладку, затем добавляется «/ UpdateCourseCredits» в конец URL-адрес в адресной строке браузера (например: `http://localhost:5813/Courses/UpdateCourseCredits`). Введите число в текстовом поле:

![Страница «обновление» отзывы о курсе](advanced/_static/update-credits.png)

Нажмите кнопку **Обновить**. Количество строк, затронутых просмотреть:

![Отзывы о курсе обновления страницы измененных строк](advanced/_static/update-credits-rows-affected.png)

Нажмите кнопку **списка** для просмотра списка курсов с измененный номер кредиты.

Обратите внимание, что рабочий код будет убедитесь, что всегда, обновляющий результат в допустимые данные. Упрощенная приведенный ниже код может умножить число кредиты достаточно приводят к номера больше 5. ( `Credits` Имеет свойство `[Range(0, 5)]` атрибута.) Запрос на обновление будет работать, но недопустимых данных может привести к непредвиденным результатам в других частях системы, предположим, что количество кредиты пять или меньше.

Дополнительные сведения о необработанных запросов SQL см. в разделе [необработанные запросы SQL](https://docs.microsoft.com/ef/core/querying/raw-sql).

## <a name="examine-sql-sent-to-the-database"></a>Проверьте, отправляемые в базу данных SQL

Иногда бывает полезно иметь возможность просматривать фактические запросы SQL, которые отправляются в базу данных. Функциональные возможности встроенного ведения журнала для ASP.NET Core автоматически используется ядром EF для записи файлы журналов, содержащие SQL для запросов и обновлений. В этом разделе вы увидите некоторые примеры ведения журнала SQL.

Откройте *StudentsController.cs* и `Details` метод установить точку останова на `if (student == null)` инструкции.

Запустить приложение в режиме отладки и перейти к странице сведений для учащихся.

Последовательно выберите пункты **вывода** вывода окна, показывающая отладки и появится запрос:

```
Microsoft.EntityFrameworkCore.Database.Command:Information: Executed DbCommand (56ms) [Parameters=[@__id_0='?'], CommandType='Text', CommandTimeout='30']
SELECT TOP(2) [s].[ID], [s].[Discriminator], [s].[FirstName], [s].[LastName], [s].[EnrollmentDate]
FROM [Person] AS [s]
WHERE ([s].[Discriminator] = N'Student') AND ([s].[ID] = @__id_0)
ORDER BY [s].[ID]
Microsoft.EntityFrameworkCore.Database.Command:Information: Executed DbCommand (122ms) [Parameters=[@__id_0='?'], CommandType='Text', CommandTimeout='30']
SELECT [s.Enrollments].[EnrollmentID], [s.Enrollments].[CourseID], [s.Enrollments].[Grade], [s.Enrollments].[StudentID], [e.Course].[CourseID], [e.Course].[Credits], [e.Course].[DepartmentID], [e.Course].[Title]
FROM [Enrollment] AS [s.Enrollments]
INNER JOIN [Course] AS [e.Course] ON [s.Enrollments].[CourseID] = [e.Course].[CourseID]
INNER JOIN (
    SELECT TOP(1) [s0].[ID]
    FROM [Person] AS [s0]
    WHERE ([s0].[Discriminator] = N'Student') AND ([s0].[ID] = @__id_0)
    ORDER BY [s0].[ID]
) AS [t] ON [s.Enrollments].[StudentID] = [t].[ID]
ORDER BY [t].[ID]
```

Обратите внимание, что здесь могут оказаться неожиданными: SQL выбирает строки до 2 (`TOP(2)`) из таблицы Person. `SingleOrDefaultAsync` Метод не разрешается в одну строку на сервере. Вот почему:

* Если запрос будет возвращать несколько строк, метод возвращает значение null.
* Чтобы определить, является ли запрос будет возвращать несколько строк, EF должен проверить, если он возвращает по крайней мере 2.

Обратите внимание, что не нужно использовать режим отладки и точку останова, чтобы получить выходные данные журнала в **вывода** окна. Это просто удобный способ остановить ведение журнала, в момент, который вы хотите посмотреть на вывод. Если этого не сделать, продолжает ведение журнала, и необходимо вернуться к найти нужные элементы, которые вас интересуют.

## <a name="repository-and-unit-of-work-patterns"></a>Репозиторий и единицы шаблонов рабочих элементов

Многие разработчики написать код для реализации репозитория и единицы шаблонов рабочих элементов как оболочка для кода, который работает с платформой Entity Framework. Эти шаблоны предназначены для создания уровень абстракции между уровня доступа к данным и бизнес-логики приложения. Реализация этих шаблонов для изоляции приложения от изменений в хранилище данных и может упростить автоматических модульного тестирования или разработки через тестирование (TDD). Тем не менее написать дополнительный код для реализации этих шаблонов не всегда подходит для приложений, использующих EF, по следующим причинам:

* EF контекста класса изолирует кода из кода на конкретных хранилища данных.

* Класс EF контекста может выступать как единица работы класса для базы данных обновляет это сделать с помощью EF.

* EF включает возможности для реализации TDD без написания кода репозитория.

Сведения о реализации репозитория и единицы шаблонов рабочих элементов см. в разделе [версию Entity Framework 5 этого учебника ряда](https://docs.microsoft.com/aspnet/mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application).

Entity Framework Core реализует поставщик баз данных в памяти, который может использоваться для тестирования. Дополнительные сведения см. в разделе [тестирование с помощью InMemory](https://docs.microsoft.com/ef/core/miscellaneous/testing/in-memory).

## <a name="automatic-change-detection"></a>Изменение автоматического обнаружения

Платформа Entity Framework определяет изменении сущности (и поэтому обновления, которые необходимо передать в базу данных), путем сравнения значений текущей сущности с исходными значениями. Исходные значения хранятся в том случае, когда сущность запрос или присоединенного. Ниже перечислены некоторые методы, которые вызывают изменение автоматического обнаружения.

* DbContext.SaveChanges

* DbContext.Entry

* ChangeTracker.Entries

Если вы отслеживаете большого числа сущностей и вызовите один из этих методов много раз в цикле, может появиться значительное повышение производительности, временно отключив автоматическое изменение отслеживания с помощью `ChangeTracker.AutoDetectChangesEnabled` свойство. Пример:

```csharp
_context.ChangeTracker.AutoDetectChangesEnabled = false;
```

## <a name="entity-framework-core-source-code-and-development-plans"></a>Entity Framework Core исходного кода и разработки планов

Entity Framework Core исходный код доступен по [https://github.com/aspnet/EntityFrameworkCore](https://github.com/aspnet/EntityFrameworkCore). Репозиторий EF Core содержит Ночные построения отслеживания проблемы, технические характеристики функции, конструктора собраний, и [стратегия для будущих разработок](https://github.com/aspnet/EntityFrameworkCore/wiki/Roadmap). Файл или поиск ошибок и участие.

Несмотря на то, что исходный код открыт, Entity Framework Core полностью поддерживается как продуктов корпорации Майкрософт. Команда Microsoft Entity Framework поддерживает элемент управления, по которому принимаются вклад и проверяет все изменения кода, чтобы обеспечить его качество каждого выпуска.

## <a name="reverse-engineer-from-existing-database"></a>В реконструировании из существующей базы данных

Чтобы реконструировать модель данных, включая классы сущностей из существующей базы данных, используйте [dbcontext формирования шаблонов](https://docs.microsoft.com/ef/core/miscellaneous/cli/powershell#scaffold-dbcontext) команды. В разделе [Приступая к работе учебника](https://docs.microsoft.com/ef/core/get-started/aspnetcore/existing-db).

<a id="dynamic-linq"></a>
## <a name="use-dynamic-linq-to-simplify-sort-selection-code"></a>Использовать динамические LINQ для упрощения кода Выбор сортировки

[Третьем учебнике этой серии](sort-filter-page.md) показано, как писать код LINQ, жестко запрограммированные имена столбцов в `switch` инструкции. С двумя столбцами для выбора это работает отлично, но если имеется много столбцов код давало подробных сведений. Чтобы устранить эту проблему, можно использовать `EF.Property` метод для указания имени свойства в виде строки. Чтобы проверить этот подход, замените `Index` метод `StudentsController` следующим кодом.

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DynamicLinq)]

## <a name="next-steps"></a>Следующие шаги

На этом завершается, серию учебники по использованию основного Entity Framework в приложении ASP.NET MVC.

Дополнительные сведения об основных EF см. в разделе [документации по Entity Framework Core](https://docs.microsoft.com/ef/core). Доступна также книги: [Entity Framework Core в действии](https://www.manning.com/books/entity-framework-core-in-action).

Сведения о развертывании веб-приложения см. в разделе [узла и развернуть](xref:host-and-deploy/index).

Сведения о других разделов, связанных с ASP.NET MVC основных компонентов, таких как проверка подлинности и авторизации, в разделе [документации ASP.NET Core](https://docs.microsoft.com/aspnet/core/).

## <a name="acknowledgments"></a>Подтверждения

Tom Dykstra и Рик Андерсон (twitter @RickAndMSFT) написал этого учебника. Роуэном Миллер, слово Диего и другими членами команды Entity Framework вспомогательная с проверками кода и помогли отладки проблем, возникших во время мы написание кода для учебников.

## <a name="common-errors"></a>Распространенные ошибки  

### <a name="contosouniversitydll-used-by-another-process"></a>ContosoUniversity.dll используется другим процессом

Сообщение об ошибке:

> Не удается открыть "... bin\Debug\netcoreapp1.0\ContosoUniversity.dll" для записи — "Нет доступа к файлу"... \bin\Debug\netcoreapp1.0\ContosoUniversity.dll ", так как он используется другим процессом.

Решение:

Остановите сайт в IIS Express. На панели задач Windows найти IIS Express и щелкните ее значок правой кнопкой мыши, выберите сайт Contoso университета и затем нажмите кнопку **остановить узел**.

### <a name="migration-scaffolded-with-no-code-in-up-and-down-methods"></a>Формирования шаблонов без кода в методы "вверх" и миграции

Возможная причина:

Команды EF CLI не автоматически закрыть и сохранить файлы кода. Если у вас есть несохраненные изменения при выполнении `migrations add` команды EF не найдет изменения.

Решение:

Запустите `migrations remove` команды, сохранить изменения кода и снова запустите `migrations add` команды.

### <a name="errors-while-running-database-update"></a>Ошибок во время выполнения обновления базы данных

Можно получить другие ошибки при внесении изменений схемы в базу данных с существующие данные. Если возникли ошибки миграции, которые не удается устранить, можно изменить имя базы данных в строке соединения или удалить базу данных. Нет данных для миграции с новой базой данных, и команду update-database гораздо больше шансов завершиться без ошибок.

Самым простым подходом является переименовать базу данных, в *appsettings.json*. При очередном запуске `database update`, создается новая база данных.

Удалить базу данных в SSOX, щелкните правой кнопкой мыши базу данных, нажмите кнопку **удаление**, а затем в **удаление базы данных** диалогового окна выберите **закрыть существующие соединения** и нажмите кнопку  **ОК**.

Чтобы удалить базу данных с помощью CLI, запустите `database drop` команду CLI:

```console
dotnet ef database drop
```

### <a name="error-locating-sql-server-instance"></a>Ошибка поиску экземпляра SQL Server

Сообщение об ошибке:

> Связанные с сетью или с определенным экземпляром ошибка при установлении соединения с SQL Server. Сервер не найден или недоступен. Проверьте правильность имени экземпляра и настройку сервера SQL Server для удаленных подключений. (поставщик: сетевые интерфейсы SQL, ошибка: 26: ошибка поиске указанного сервера/экземпляра)

Решение:

Проверьте строку подключения. Если файл базы данных был удален вручную, измените имя базы данных в строке построения, чтобы начать заново с новой базы данных.

>[!div class="step-by-step"]
[Назад](inheritance.md)

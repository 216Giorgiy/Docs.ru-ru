---
title: "Основные ASP.NET MVC с основными EF - сортировки, фильтрации, разбиение на страницы: 3 из 10"
author: tdykstra
description: "В этом учебнике предстоит добавить сортировку, фильтрацию и разбиение по страницам функциональные возможности для разбиения на страницы с помощью ASP.NET Core и Entity Framework Core."
keywords: "ASP.NET Core Entity Framework Core, сортировки, фильтрации, разбиение на страницы, группирование"
ms.author: tdykstra
ms.date: 03/15/2017
ms.topic: get-started-article
ms.assetid: e6c1ff3c-5673-43bf-9c2d-077f6ada1f29
ms.technology: aspnet
ms.prod: asp.net-core
uid: data/ef-mvc/sort-filter-page
ms.openlocfilehash: 59fff4dbf4736f0776aac4072f3f4e2d40119842
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/10/2017
---
# <a name="sorting-filtering-paging-and-grouping---ef-core-with-aspnet-core-mvc-tutorial-3-of-10"></a>Сортировка, фильтрация, разбиение по страницам и группирование - Core EF учебнику ASP.NET Core MVC (3 из 10)

По [Tom Dykstra](https://github.com/tdykstra) и [Рик Андерсон](https://twitter.com/RickAndMSFT)

Contoso университета примера веб-приложения показано, как создавать веб-приложения ASP.NET MVC ядра с помощью основного Entity Framework и Visual Studio. Сведения о учебника серии см [в первом учебнике ряда](intro.md).

В предыдущем учебнике реализован ряд веб-страниц для основные операции CRUD для сущностей студента. В этом учебнике вы добавите сортировку, фильтрацию и разбиения по страницам на страницу индекса учащихся. Здесь также создается страница, выполняющий простым группированием.

Ниже показано, как будет выглядеть страница после завершения. Заголовки столбцов являются ссылками, пользователь может щелкнуть для сортировки по этому столбцу. При щелчке заголовка многократно переключается между сортировкой по возрастанию и убыванию.

![Страница индекса студентов](sort-filter-page/_static/paging.png)

## <a name="add-column-sort-links-to-the-students-index-page"></a>Добавить столбец сортировки ссылки на страницы индекса для учащихся

Для добавления, страница индекса студента сортировки, мы изменим `Index` метод контроллера студентов и добавьте код в представлении индекса студента.

### <a name="add-sorting-functionality-to-the-index-method"></a>Добавление возможности сортировки в метод индекса

В *StudentsController.cs*, замените `Index` метод следующим кодом:

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_SortOnly)]

Этот код получает `sortOrder` параметра из строки запроса в URL-АДРЕСЕ. Значение строки запроса, предоставляемые ASP.NET Core MVC как параметр методу действия. Параметр будет строка, являющаяся «Name» или «Date» последовать знак подчеркивания и строку «desc», чтобы указать порядок по убыванию. По умолчанию используется порядок сортировки по возрастанию.

При первом запросе страницы индекса имеется строка запроса отсутствует. Студенты отображаются в порядке возрастания по фамилии, используемом по умолчанию, установленные с проходом регистром `switch` инструкции. Когда пользователь щелкает гиперссылку заголовок столбца, соответствующего `sortOrder` значение указано в строке запроса.

Два `ViewData` элементы (NameSortParm и DateSortParm) используются в представлении для настройки гиперссылки заголовок столбца со строковыми значениями соответствующий запрос.

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_SortOnly&highlight=3-4)]

Это троичный инструкции. Указывает, что если первый `sortOrder` параметр имеет значение null или пусто, NameSortParm должно быть равно «name_desc»; в противном случае оно должно быть присвоено пустая строка. Следующие два оператора включите представление для задания гиперссылки заголовка столбца следующим образом:

|  Текущий порядок сортировки  | Последнее имя гиперссылки | Дата гиперссылки |
|:--------------------:|:-------------------:|:--------------:|
| Последняя имени: по возрастанию  | по убыванию          | по возрастанию      |
| Последняя имени: по убыванию | по возрастанию           | по возрастанию      |
| По возрастанию даты       | по возрастанию           | по убыванию     |
| Дата по убыванию      | по возрастанию           | по возрастанию      |

Метод использует LINQ to Entities позволяет выбрать столбец для сортировки. Код создает `IQueryable` переменной перед оператора switch, выполняется его изменение в операторе switch и вызовы `ToListAsync` метод после `switch` инструкции. После создания и изменения `IQueryable` переменные, не отправляется запрос базы данных. Запрос не выполняется до преобразования `IQueryable` объект в коллекции, такие как вызов метода `ToListAsync`. Таким образом, этот код вызывает один запрос, который не выполняется до `return View` инструкции.

Этот код может получить подробный с большим числом столбцов. [Последний учебнике этой серии](advanced.md#dynamic-linq) показано, как написать код, который позволяет передать имя `OrderBy` столбца в строковой переменной.

### <a name="add-column-heading-hyperlinks-to-the-student-index-view"></a>Добавление гиперссылок заголовок столбца в представлении студента индекса

Замените код в *Views/Students/Index.cshtml*, добавление гиперссылок заголовка столбца следующим кодом. Измененные строки будут выделены.

[!code-html[](intro/samples/cu/Views/Students/Index2.cshtml?highlight=16,22)]

Этот код использует эти сведения в `ViewData` свойства для настройки гиперссылки с соответствующего запроса строковые значения.

Запустите приложение, выберите **учащихся** и нажмите кнопку **Фамилия** и **Дата регистрации** заголовки столбцов, чтобы проверить, Сортировка работает.

![Страница индекса студентов в порядке по имени](sort-filter-page/_static/name-order.png)

## <a name="add-a-search-box-to-the-students-index-page"></a>Добавить поле поиска на страницу индекса студентов

Добавление фильтрации на страницу индекса учащихся, мы добавим текстовое поле и кнопку отправки для представления и внесите соответствующие изменения в `Index` метод. Текстовое поле можно ввести строку для поиска в полями имени и имени.

### <a name="add-filtering-functionality-to-the-index-method"></a>Добавьте функцию фильтра в метод индекса

В *StudentsController.cs*, замените `Index` метод (изменения выделены) следующим кодом.

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_SortFilter&highlight=1,5,9-13)]

Вы добавили `searchString` параметр `Index` метода. Строковое значение поиска получается из текстового поля, который вам предстоит добавить в представление индекс. Вы также добавили в инструкции LINQ where предложение, которое выбирает только студентов, имя или фамилия содержит строку поиска. Инструкцию, которая добавляет where предложение выполняется только в том случае, если значение для поиска.

> [!NOTE]
> Здесь вы вызываете `Where` метод `IQueryable` объекта и фильтр будет обрабатываться на сервере. В некоторых сценариях может вызов вы `Where` метод как метод расширения для коллекции в памяти. (Например, предположим, что изменить ссылку на `_context.Students` таким образом, чтобы вместо объекта EF `DbSet` оно ссылается на метод репозитория, который возвращает `IEnumerable` коллекции.) Результат обычно останется прежним, но в некоторых случаях могут различаться.
>
>Например, реализация .NET Framework `Contains` метод выполняет сравнение с учетом регистра по умолчанию, но в SQL Server это определяется параметров сортировки экземпляра SQL Server. Эту настройку по умолчанию с учетом регистра. Вы можете вызвать `ToUpper` метод производится проверка явно без учета регистра: *где (s = > s.LastName.ToUpper(). CONTAINS(searchString.ToUpper())*. Гарантирует, что результаты остаются теми же при изменении кода позже в репозиторий, который возвращает `IEnumerable` коллекции вместо `IQueryable` объекта. (При вызове `Contains` метод `IEnumerable` коллекции, получить реализации .NET Framework; при его вызове на `IQueryable` объекта, вы получаете реализации поставщика базы данных.) Тем не менее является снижение производительности для этого решения. `ToUpper` Поместить код функции в предложении WHERE инструкции TSQL SELECT. Оптимизатор, не с помощью индекса. Учитывая, что SQL главным образом установлен без учета регистра, рекомендуется избежать `ToUpper` кода до переноса хранилища данных с учетом регистра.

### <a name="add-a-search-box-to-the-student-index-view"></a>Добавить поле поиска в представление индекс студента

В *Views/Student/Index.cshtml*, добавьте выделенный код непосредственно перед открывающий тег таблицы для создания заголовка и текстовое поле и **поиска** кнопку.

[!code-html[](intro/samples/cu/Views/Students/Index3.cshtml?range=9-23&highlight=5-13)]

Этот код использует `<form>` [тег вспомогательный](xref:mvc/views/tag-helpers/intro) Добавление поиска текстовое поле и кнопку. По умолчанию `<form>` тег вспомогательный отправки данных с помощью запроса POST, это означает, что параметры передаются в тексте сообщения HTTP, а не в URL-адрес как строки запросов. При указании HTTP GET, данные формы переданный URL-адрес как строки запроса, который позволяет пользователям bookmark URL-адрес. Получение рекомендуется рекомендации W3C, который следует использовать действие не приводит к появлению обновления.

Запустите приложение, выберите **учащихся** введите строку поиска и нажмите кнопку поиска, чтобы проверить работоспособность фильтрации.

![Страница индекса учащихся с фильтрацией](sort-filter-page/_static/filtering.png)

Обратите внимание, что URL-адрес содержит строку поиска.

```html
http://localhost:5813/Students?SearchString=an
```

Если вы установите закладку эту страницу, вы сможете получить отфильтрованный список при использовании закладки. Добавление `method="get"` для `form` тег является причину строке запроса должен быть создан.

На этом этапе, если по ссылке сортировки в заголовок столбца, будут потеряны значение фильтра, введенного в **поиска** поле. Это будет исправлено в следующем разделе.

## <a name="add-paging-functionality-to-the-students-index-page"></a>Добавить на страницу индекса учащихся разбиения по страницам

Чтобы добавить на страницу индекса учащихся разбиения на страницы, следует создать `PaginatedList` класс, который использует `Skip` и `Take` инструкций для фильтрации данных на сервере, а не всегда быть получение всех строк таблицы. Затем будет вносить дополнительные изменения в `Index` метод и добавить кнопки разбиения по страницам для `Index` представления. На следующем рисунке кнопки разбиения по страницам.

![Студенты индексная страница со ссылками на разбиение на страницы](sort-filter-page/_static/paging.png)

Создайте в папке проекта `PaginatedList.cs`, а затем замените код шаблона с помощью следующего кода.

[!code-csharp[Main](intro/samples/cu/PaginatedList.cs)]

`CreateAsync` Метод в этом коде принимает размер страницы и номер страницы и применяет соответствующие `Skip` и `Take` инструкции, чтобы `IQueryable`. Когда `ToListAsync` будет вызван на `IQueryable`, он возвращает список, содержащий только запрошенную страницу. Свойства `HasPreviousPage` и `HasNextPage` может использоваться для включения или отключения **Назад** и **Далее** разбиение по страницам кнопок.

Объект `CreateAsync` метод вместо конструктор используется для создания `PaginatedList<T>` объекта, так как конструкторы не могут выполнять асинхронный код.

## <a name="add-paging-functionality-to-the-index-method"></a>Добавьте в метод индекс разбиения по страницам

В *StudentsController.cs*, замените `Index` метод следующим кодом.

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_SortFilterPage&highlight=1-5,7,11-18,45-46)]

Этот код добавляет числовой параметр страницы, текущий параметр порядка сортировки и текущий параметр фильтра к сигнатуре метода.

```csharp
public async Task<IActionResult> Index(
    string sortOrder,
    string currentFilter,
    string searchString,
    int? page)
```

Первый раз, когда страница отображается или если пользователь не щелкнет подкачки или сортировки ссылку, все параметры будут иметь значение null.  Если щелкнуть ссылку подкачки переменной страницы будет содержать номер страницы для отображения.

`ViewData` Элемента с именем CurrentSort обеспечивает представление определения порядка сортировки, так как это должны быть включены в ссылки разбиения на страницы для сохранит порядок сортировки при разбиении по страницам.

`ViewData` Элемента с именем ТекущийФильтр обеспечивает представление с текущей строки фильтра. Это значение должны быть включены в ссылки разбиения на страницы для поддержки настройки фильтра во время разбиения на страницы, и она должна быть восстановлена к текстовому полю, когда отобразится страница.

Если строка поиска, которая изменяется во время разбиения на страницы, страницы должен быть равным 1, так как новый фильтр может показать различные данные. Строка поиска, которая изменяется при нажатии кнопки "Отправить", если ввести значение в текстовом поле. В этом случае `searchString` параметра не равно null.

```csharp
if (searchString != null)
{
    page = 1;
}
else
{
    searchString = currentFilter;
}
```

В конце `Index` метода `PaginatedList.CreateAsync` метод преобразует запрос студента на одной странице учеников в тип коллекции, который поддерживает разбиение по страницам. Страницы учащихся затем передается в представление.

```csharp
return View(await PaginatedList<Student>.CreateAsync(students.AsNoTracking(), page ?? 1, pageSize));
```

`PaginatedList.CreateAsync` Метод принимает номер страницы. Два вопросительные знаки представления оператора объединения с null. Оператор объединения с null определяет значение по умолчанию для типа значения NULL; выражение `(page ?? 1)` означает возвращают значение `page` если он имеет значение, или возвращает 1, если `page` имеет значение null.

## <a name="add-paging-links-to-the-student-index-view"></a>Добавить разбиение на страницы ссылки на представление Index студента

В *Views/Students/Index.cshtml*, замените существующий код следующим кодом. Изменения выделены.

[!code-html[](intro/samples/cu/Views/Students/Index.cshtml?highlight=1,27,30,33,61-79)]

`@model` В верхней части страницы указывает теперь возвращает представление `PaginatedList<T>` объекта вместо `List<T>` объекта.

Ссылки в заголовках столбцов использовать строку запроса для передачи текущей искомой строки к контроллеру, чтобы пользователь может сортировать в результаты фильтрации:

```html
<a asp-action="Index" asp-route-sortOrder="@ViewData["DateSortParm"]" asp-route-currentFilter ="@ViewData["CurrentFilter"]">Enrollment Date</a>
```

По вспомогательных функций тегов отображаются кнопки разбиения на страницы:

```html
<a asp-action="Index"
   asp-route-sortOrder="@ViewData["CurrentSort"]"
   asp-route-page="@(Model.PageIndex - 1)"
   asp-route-currentFilter="@ViewData["CurrentFilter"]"
   class="btn btn-default @prevDisabled">
   Previous
</a>
```

Запустите приложение и перейти на страницу учащихся.

![Студенты индексная страница со ссылками на разбиение на страницы](sort-filter-page/_static/paging.png)

По ссылкам разбиения на страницы в различными порядками сортировки, чтобы убедиться, что работает разбиения на страницы. Затем введите строку поиска и повторите подкачки еще раз, чтобы проверить правильность разбиения на страницы также с сортировкой и фильтрацией.

## <a name="create-an-about-page-that-shows-student-statistics"></a>Создайте страницу о программе, отображается статистика студента

Для веб-сайта компании Contoso университета **о** страницы, как отображать количество студентов регистрации для каждой даты регистрации. Для этого простого группировки и выполнения расчетов по группам. Для выполнения этой задачи вы выполните следующее:

* Создание класса модели представления для данных, которые нужно передать в представление.

* Измените метод "о программе" в контроллер Home.

* Измените представление о программе.

### <a name="create-the-view-model"></a>Создание модели представления

Создание *SchoolViewModels* папки в *моделей* папки.

В новой папке, добавьте файл класса *EnrollmentDateGroup.cs* и замените код шаблона с помощью следующего кода:

[!code-csharp[Main](intro/samples/cu/Models/SchoolViewModels/EnrollmentDateGroup.cs)]

### <a name="modify-the-home-controller"></a>Контроллер Home

В *HomeController.cs*, добавьте следующие операторы using в верхней части файла:

[!code-csharp[Main](intro/samples/cu/Controllers/HomeController.cs?name=snippet_Usings1)]

Добавление переменной класса для контекста базы данных сразу же после открывающей фигурной скобки для класса и получить экземпляр контекста из ASP.NET Core DI:

[!code-csharp[Main](intro/samples/cu/Controllers/HomeController.cs?name=snippet_AddContext&highlight=3,5,7)]

Замените метод `About` следующим кодом:

[!code-csharp[Main](intro/samples/cu/Controllers/HomeController.cs?name=snippet_UseDbSet)]

Инструкции LINQ группирует учащихся сущностей, Дата регистрации, вычисляет число сущностей в каждой группе и сохраняет результаты в коллекцию `EnrollmentDateGroup` просматривать объекты модели.
> [!NOTE] 
> В версии 1.0 Entity Framework Core весь результирующий набор возвращается клиенту, и группированием на стороне клиента. В некоторых случаях это может создать проблемы с производительностью. Убедитесь, что для тестирования производительности с помощью объемов данных в рабочей среде и при необходимости использовать необработанные SQL для выполнения группирования на сервере. Сведения об использовании необработанные SQL см. в разделе [последнего учебнике этой серии](advanced.md).

### <a name="modify-the-about-view"></a>Изменить представление

Замените код в *Views/Home/About.cshtml* файла следующим кодом:

[!code-html[](intro/samples/cu/Views/Home/About.cshtml)]

Запустите приложение и перейти на страницу о программе. Количества учащихся для каждой даты регистрации отображается в таблице.

![О странице](sort-filter-page/_static/about.png)

## <a name="summary"></a>Сводка

В этом учебнике вы знаете, как выполнять сортировку, фильтрацию, разбиение на страницы и группирования. В следующем уроке вы узнаете, как обрабатывать изменения в модели данных с помощью миграций.

>[!div class="step-by-step"]
[Назад](crud.md)
[Вперед](migrations.md)  

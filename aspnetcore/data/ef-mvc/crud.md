---
title: "Основные ASP.NET MVC с основными EF - CRUD - 2 из 10"
author: tdykstra
description: 
ms.author: tdykstra
manager: wpickett
ms.date: 03/15/2017
ms.topic: get-started-article
ms.technology: aspnet
ms.prod: asp.net-core
uid: data/ef-mvc/crud
ms.openlocfilehash: 873e4592ba668bbcb22f761c2a547a2a27d7e443
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2018
---
# <a name="create-read-update-and-delete---ef-core-with-aspnet-core-mvc-tutorial-2-of-10"></a><span data-ttu-id="8e75b-102">Создания, чтения, обновления и удаления - Core EF учебнику Core ASP.NET MVC (часть 2 из 10)</span><span class="sxs-lookup"><span data-stu-id="8e75b-102">Create, Read, Update, and Delete - EF Core with ASP.NET Core MVC tutorial (2 of 10)</span></span>

<span data-ttu-id="8e75b-103">По [Tom Dykstra](https://github.com/tdykstra) и [Рик Андерсон](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="8e75b-103">By [Tom Dykstra](https://github.com/tdykstra) and [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="8e75b-104">Contoso университета примера веб-приложения показано, как создавать веб-приложения ASP.NET MVC ядра с помощью основного Entity Framework и Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="8e75b-104">The Contoso University sample web application demonstrates how to create ASP.NET Core MVC web applications using Entity Framework Core and Visual Studio.</span></span> <span data-ttu-id="8e75b-105">Сведения о учебника серии см [в первом учебнике ряда](intro.md).</span><span class="sxs-lookup"><span data-stu-id="8e75b-105">For information about the tutorial series, see [the first tutorial in the series](intro.md).</span></span>

<span data-ttu-id="8e75b-106">В предыдущем учебнике вы создали приложение MVC, хранит и отображает данные с помощью платформы Entity Framework и SQL Server LocalDB.</span><span class="sxs-lookup"><span data-stu-id="8e75b-106">In the previous tutorial, you created an MVC application that stores and displays data using the Entity Framework and SQL Server LocalDB.</span></span> <span data-ttu-id="8e75b-107">В этом учебнике предстоит просмотреть и настроить CRUD (Создание, чтение, обновление и удаление) код, который MVC функции формирования шаблонов автоматически создает для вас в контроллеры и представления.</span><span class="sxs-lookup"><span data-stu-id="8e75b-107">In this tutorial, you'll review and customize the CRUD (create, read, update, delete) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE] 
> <span data-ttu-id="8e75b-108">Он часто используется для реализации шаблона репозитория, чтобы создать уровень абстракции между контроллер и уровня доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="8e75b-108">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="8e75b-109">Чтобы сохранить эти учебники проста и заключается в учит способы использования платформы Entity Framework сам, они не используйте репозиториев.</span><span class="sxs-lookup"><span data-stu-id="8e75b-109">To keep these tutorials simple and focused on teaching how to use the Entity Framework itself, they don't use repositories.</span></span> <span data-ttu-id="8e75b-110">Сведения о репозитории с EF см. в разделе [последнего учебнике этой серии](advanced.md).</span><span class="sxs-lookup"><span data-stu-id="8e75b-110">For information about repositories with EF, see [the last tutorial in this series](advanced.md).</span></span>

<span data-ttu-id="8e75b-111">В этом учебнике вы будете работать с на следующих сайтах:</span><span class="sxs-lookup"><span data-stu-id="8e75b-111">In this tutorial, you'll work with the following web pages:</span></span>

![Страница сведений для учащихся](crud/_static/student-details.png)

![Страница создания студента](crud/_static/student-create.png)

![Страница изменения студента](crud/_static/student-edit.png)

![Страница удаления студента](crud/_static/student-delete.png)

## <a name="customize-the-details-page"></a><span data-ttu-id="8e75b-116">Настройка страницы сведений</span><span class="sxs-lookup"><span data-stu-id="8e75b-116">Customize the Details page</span></span>

<span data-ttu-id="8e75b-117">Опущены формирования шаблонов код страницы индекса учащихся `Enrollments` свойства, так как это свойство содержит коллекцию.</span><span class="sxs-lookup"><span data-stu-id="8e75b-117">The scaffolded code for the Students Index page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="8e75b-118">В **сведения** страницы, как отображать содержимое коллекции в HTML-таблицу.</span><span class="sxs-lookup"><span data-stu-id="8e75b-118">In the **Details** page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="8e75b-119">В *Controllers/StudentsController.cs*, метод действия для сведений о режиме `SingleOrDefaultAsync` метод для извлечения одной `Student` сущности.</span><span class="sxs-lookup"><span data-stu-id="8e75b-119">In *Controllers/StudentsController.cs*, the action method for the Details view uses the `SingleOrDefaultAsync` method to retrieve a single `Student` entity.</span></span> <span data-ttu-id="8e75b-120">Добавьте код, вызывающий `Include`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-120">Add code that calls `Include`.</span></span> <span data-ttu-id="8e75b-121">`ThenInclude`, и `AsNoTracking` методов, как показано в следующий выделенный код.</span><span class="sxs-lookup"><span data-stu-id="8e75b-121">`ThenInclude`,  and `AsNoTracking` methods, as shown in the following highlighted code.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Details&highlight=8-12)]

<span data-ttu-id="8e75b-122">`Include` И `ThenInclude` методы, которые вызывают контекст загрузки `Student.Enrollments` свойство навигации и в пределах каждой регистрации `Enrollment.Course` свойство навигации.</span><span class="sxs-lookup"><span data-stu-id="8e75b-122">The `Include` and `ThenInclude` methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span>  <span data-ttu-id="8e75b-123">Дополнительные сведения об этих методах в [чтение связанных данных](read-related-data.md) учебника.</span><span class="sxs-lookup"><span data-stu-id="8e75b-123">You'll learn more about these methods in the [reading related data](read-related-data.md) tutorial.</span></span>

<span data-ttu-id="8e75b-124">`AsNoTracking` Метод повышает производительность в сценариях, где сущностей, возвращаемых не будут обновлены в течение срока службы в текущем контексте.</span><span class="sxs-lookup"><span data-stu-id="8e75b-124">The `AsNoTracking` method improves performance in scenarios where the entities returned won't be updated in the current context's lifetime.</span></span> <span data-ttu-id="8e75b-125">Дополнительные сведения о `AsNoTracking` в конце этого учебника.</span><span class="sxs-lookup"><span data-stu-id="8e75b-125">You'll learn more about `AsNoTracking` at the end of this tutorial.</span></span>

### <a name="route-data"></a><span data-ttu-id="8e75b-126">Данные о маршруте</span><span class="sxs-lookup"><span data-stu-id="8e75b-126">Route data</span></span>

<span data-ttu-id="8e75b-127">Значение ключа, который передается `Details` метод поступают из *маршрутизации данных*.</span><span class="sxs-lookup"><span data-stu-id="8e75b-127">The key value that's passed to the `Details` method comes from *route data*.</span></span> <span data-ttu-id="8e75b-128">Данные маршрута — это данные, найти связыватель модели в сегменте URL-адреса.</span><span class="sxs-lookup"><span data-stu-id="8e75b-128">Route data is data that the model binder found in a segment of the URL.</span></span> <span data-ttu-id="8e75b-129">Например маршрут по умолчанию задает контроллера, действия и идентификатор сегментов:</span><span class="sxs-lookup"><span data-stu-id="8e75b-129">For example, the default route specifies controller, action, and id segments:</span></span>

[!code-csharp[Main](intro/samples/cu/Startup.cs?name=snippet_Route&highlight=5)]

<span data-ttu-id="8e75b-130">В следующий URL-адрес маршрута по умолчанию соответствует инструктора как контроллер, индекс как действие и 1 в качестве идентификатора; Это значения данных маршрута.</span><span class="sxs-lookup"><span data-stu-id="8e75b-130">In the following URL, the default route maps Instructor as the controller, Index as the action, and 1 as the id; these are route data values.</span></span>

```
http://localhost:1230/Instructor/Index/1?courseID=2021
```

<span data-ttu-id="8e75b-131">Последняя часть URL-адрес ("? courseID = 2021») — это строковый параметр запроса.</span><span class="sxs-lookup"><span data-stu-id="8e75b-131">The last part of the URL ("?courseID=2021") is a query string value.</span></span> <span data-ttu-id="8e75b-132">Связыватель модели также будет передавать значение идентификатора для `Details` метод `id` параметра, если он передается как значение строки запроса:</span><span class="sxs-lookup"><span data-stu-id="8e75b-132">The model binder will also pass the ID value to the `Details` method `id` parameter if you pass it as a query string value:</span></span>

```
http://localhost:1230/Instructor/Index?id=1&CourseID=2021
```

<span data-ttu-id="8e75b-133">Страницы индекса URL-адреса гиперссылок создаются вспомогательные инструкциями тег представления Razor.</span><span class="sxs-lookup"><span data-stu-id="8e75b-133">In the Index page, hyperlink URLs are created by tag helper statements in the Razor view.</span></span> <span data-ttu-id="8e75b-134">В следующем коде Razor `id` параметр соответствует маршрут по умолчанию, поэтому `id` добавляется в данные маршрута.</span><span class="sxs-lookup"><span data-stu-id="8e75b-134">In the following Razor code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

```html
<a asp-action="Edit" asp-route-id="@item.ID">Edit</a>
```

<span data-ttu-id="8e75b-135">Этот код создает следующий код HTML при `item.ID` — 6:</span><span class="sxs-lookup"><span data-stu-id="8e75b-135">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit/6">Edit</a>
```

<span data-ttu-id="8e75b-136">В следующем коде Razor `studentID` не совпадает с параметром в маршрут по умолчанию, он добавляется в виде строки запроса.</span><span class="sxs-lookup"><span data-stu-id="8e75b-136">In the following Razor code, `studentID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

```html
<a asp-action="Edit" asp-route-studentID="@item.ID">Edit</a>
```

<span data-ttu-id="8e75b-137">Этот код создает следующий код HTML при `item.ID` — 6:</span><span class="sxs-lookup"><span data-stu-id="8e75b-137">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit?studentID=6">Edit</a>
```

<span data-ttu-id="8e75b-138">Дополнительные сведения о вспомогательных функций тегов см. в разделе [вспомогательных функций тегов в ASP.NET Core](xref:mvc/views/tag-helpers/intro).</span><span class="sxs-lookup"><span data-stu-id="8e75b-138">For more information about tag helpers, see [Tag helpers in ASP.NET Core](xref:mvc/views/tag-helpers/intro).</span></span>

### <a name="add-enrollments-to-the-details-view"></a><span data-ttu-id="8e75b-139">Добавить в представлении сведений о регистрации</span><span class="sxs-lookup"><span data-stu-id="8e75b-139">Add enrollments to the Details view</span></span>

<span data-ttu-id="8e75b-140">Откройте *Views/Students/Details.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="8e75b-140">Open *Views/Students/Details.cshtml*.</span></span> <span data-ttu-id="8e75b-141">Каждое поле отображается с помощью `DisplayNameFor` и `DisplayFor` вспомогательные объекты, как показано в следующем примере:</span><span class="sxs-lookup"><span data-stu-id="8e75b-141">Each field is displayed using `DisplayNameFor` and `DisplayFor` helpers, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=13-18&highlight=2,5)]

<span data-ttu-id="8e75b-142">После последнего поля и непосредственно перед закрывающим тегом `</dl>` , добавьте следующий код, чтобы отобразить список регистраций:</span><span class="sxs-lookup"><span data-stu-id="8e75b-142">After the last field and immediately before the closing `</dl>` tag, add the following code to display a list of enrollments:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=31-52)]

<span data-ttu-id="8e75b-143">Если коду отступ неправильный после вставки кода, нажмите клавиши CTRL-K-D, чтобы исправить его.</span><span class="sxs-lookup"><span data-stu-id="8e75b-143">If code indentation is wrong after you paste the code, press CTRL-K-D to correct it.</span></span>

<span data-ttu-id="8e75b-144">Этот код выполняет цикл по сущности в `Enrollments` свойство навигации.</span><span class="sxs-lookup"><span data-stu-id="8e75b-144">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="8e75b-145">Для каждой регистрации отображает название курса и уровень.</span><span class="sxs-lookup"><span data-stu-id="8e75b-145">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="8e75b-146">Название курса извлекается из курса сущность, которая хранится в `Course` свойства навигации сущности регистраций.</span><span class="sxs-lookup"><span data-stu-id="8e75b-146">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="8e75b-147">Запустите приложение, выберите **учащихся** и нажмите кнопку **сведения** ссылку для учащихся.</span><span class="sxs-lookup"><span data-stu-id="8e75b-147">Run the app, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="8e75b-148">Просмотреть список курсов и оценок для выбранного учащегося:</span><span class="sxs-lookup"><span data-stu-id="8e75b-148">You see the list of courses and grades for the selected student:</span></span>

![Страница сведений для учащихся](crud/_static/student-details.png)

## <a name="update-the-create-page"></a><span data-ttu-id="8e75b-150">Обновление страницы создания</span><span class="sxs-lookup"><span data-stu-id="8e75b-150">Update the Create page</span></span>

<span data-ttu-id="8e75b-151">В *StudentsController.cs*, изменить HttpPost `Create` метод блок try-catch добавляя и удаляя идентификатор из `Bind` атрибута.</span><span class="sxs-lookup"><span data-stu-id="8e75b-151">In *StudentsController.cs*, modify the HttpPost `Create` method by adding a try-catch block and removing ID from the `Bind` attribute.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=4,6-7,14-21)]

<span data-ttu-id="8e75b-152">Этот код добавляет студента сущности, созданной связывателя модели ASP.NET MVC в сущность учащихся набор и затем сохраняет изменения в базе данных.</span><span class="sxs-lookup"><span data-stu-id="8e75b-152">This code adds the Student entity created by the ASP.NET MVC model binder to the Students entity set and then saves the changes to the database.</span></span> <span data-ttu-id="8e75b-153">(Связыватель модели ссылается на функциональные возможности ASP.NET MVC, упрощающее работу с данными, отправленных в форму, связыватель модели преобразует значения из отправленной формы с типами среды CLR и передает их в параметры метода действия.</span><span class="sxs-lookup"><span data-stu-id="8e75b-153">(Model binder refers to the ASP.NET MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="8e75b-154">В данном случае связывателя модели создается экземпляр сущности студента с использованием значения свойства из коллекции форм.)</span><span class="sxs-lookup"><span data-stu-id="8e75b-154">In this case, the model binder instantiates a Student entity for you using property values from the Form collection.)</span></span>

<span data-ttu-id="8e75b-155">Вы удалены `ID` из `Bind` атрибут, так как код имеет значение первичного ключа, который SQL Server будет автоматически устанавливать при вставке строки.</span><span class="sxs-lookup"><span data-stu-id="8e75b-155">You removed `ID` from the `Bind` attribute because ID is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="8e75b-156">Входные данные пользователя не задает значение идентификатора.</span><span class="sxs-lookup"><span data-stu-id="8e75b-156">Input from the user doesn't set the ID value.</span></span>

<span data-ttu-id="8e75b-157">Кроме `Bind` блок try-catch-атрибут имеет значение только изменения, внесенные в код формирования шаблонов.</span><span class="sxs-lookup"><span data-stu-id="8e75b-157">Other than the `Bind` attribute, the try-catch block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="8e75b-158">Если исключение, которое является производным от `DbUpdateException` будет обработано, пока сохраняются изменения, отображаются сообщения об ошибке.</span><span class="sxs-lookup"><span data-stu-id="8e75b-158">If an exception that derives from `DbUpdateException` is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="8e75b-159">`DbUpdateException`исключения иногда вызываются объекты, внешние приложения, а не наличие программной ошибки, поэтому пользователю предлагается повторите попытку.</span><span class="sxs-lookup"><span data-stu-id="8e75b-159">`DbUpdateException` exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="8e75b-160">Несмотря на то, что не реализована в этом образце, производственного качества приложения будет занесения исключения.</span><span class="sxs-lookup"><span data-stu-id="8e75b-160">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="8e75b-161">Дополнительные сведения см. в разделе **подробные сведения в журнале** статьи [мониторинг и данные телеметрии (облака реальных построение приложений с Azure)](https://docs.microsoft.com/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span><span class="sxs-lookup"><span data-stu-id="8e75b-161">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](https://docs.microsoft.com/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span></span>

<span data-ttu-id="8e75b-162">`ValidateAntiForgeryToken` Атрибут помогает предотвратить атаки подделки межсайтовых запросов.</span><span class="sxs-lookup"><span data-stu-id="8e75b-162">The `ValidateAntiForgeryToken` attribute helps prevent cross-site request forgery (CSRF) attacks.</span></span> <span data-ttu-id="8e75b-163">Токен автоматически вставляется в представлении по [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) и включается при отправке формы пользователем.</span><span class="sxs-lookup"><span data-stu-id="8e75b-163">The token is automatically injected into the view by the [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) and is included when the form is submitted by the user.</span></span> <span data-ttu-id="8e75b-164">Маркер проверяется с `ValidateAntiForgeryToken` атрибута.</span><span class="sxs-lookup"><span data-stu-id="8e75b-164">The token is validated by the `ValidateAntiForgeryToken` attribute.</span></span> <span data-ttu-id="8e75b-165">Дополнительные сведения о CSRF см. в разделе [запрос защиты от подделки](../../security/anti-request-forgery.md).</span><span class="sxs-lookup"><span data-stu-id="8e75b-165">For more information about CSRF, see [Anti-Request Forgery](../../security/anti-request-forgery.md).</span></span>

<a id="overpost"></a>
### <a name="security-note-about-overposting"></a><span data-ttu-id="8e75b-166">Примечание по безопасности о overposting</span><span class="sxs-lookup"><span data-stu-id="8e75b-166">Security note about overposting</span></span>

<span data-ttu-id="8e75b-167">`Bind` Атрибут, который включает в себя код формирования шаблонов на `Create` метод является одним из способов защиты от overposting в создавать сценарии.</span><span class="sxs-lookup"><span data-stu-id="8e75b-167">The `Bind` attribute that the scaffolded code includes on the `Create` method is one way to protect against overposting in create scenarios.</span></span> <span data-ttu-id="8e75b-168">Предположим, например, сущность Student включает `Secret` свойство, которое необходимо исключить из этой веб-страницы для задания.</span><span class="sxs-lookup"><span data-stu-id="8e75b-168">For example, suppose the Student entity includes a `Secret` property that you don't want this web page to set.</span></span>

```csharp
public class Student
{
    public int ID { get; set; }
    public string LastName { get; set; }
    public string FirstMidName { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public string Secret { get; set; }
}
```

<span data-ttu-id="8e75b-169">Даже при отсутствии `Secret` поля на веб-странице, злоумышленник может использовать такое средство, как Fiddler или написать сценарий JavaScript для учета `Secret` формирования значения.</span><span class="sxs-lookup"><span data-stu-id="8e75b-169">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="8e75b-170">Без `Bind` , будет окрашена атрибутов, ограничивая поля, которые использует связыватель модели при создании экземпляра студента, связывателя модели `Secret` форму значение и использовать его для создания экземпляра сущности студента.</span><span class="sxs-lookup"><span data-stu-id="8e75b-170">Without the `Bind` attribute limiting the fields that the model binder uses when it creates a Student instance, the model binder would pick up that `Secret` form value and use it to create the Student entity instance.</span></span> <span data-ttu-id="8e75b-171">Выберите любое другое значение злоумышленнику, указанный для `Secret` поля формы будет обновлено в базе данных.</span><span class="sxs-lookup"><span data-stu-id="8e75b-171">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="8e75b-172">На следующем рисунке показано добавление средство Fiddler `Secret` поле (со значением «OverPost») для значения из отправленной формы.</span><span class="sxs-lookup"><span data-stu-id="8e75b-172">The following image shows the Fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

![При добавлении секретный поля Fiddler](crud/_static/fiddler.png)

<span data-ttu-id="8e75b-174">Значение «OverPost» был бы затем успешно добавлен `Secret` свойство вставленных строк, несмотря на то, что вы никогда не предназначен, что веб-страницы можно задать это свойство.</span><span class="sxs-lookup"><span data-stu-id="8e75b-174">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

<span data-ttu-id="8e75b-175">Можно предотвратить, overposting в сценариях редактирования сначала чтение сущности из базы данных и последующего вызова `TryUpdateModel`, передавая список разрешенных явных свойств.</span><span class="sxs-lookup"><span data-stu-id="8e75b-175">You can prevent overposting in edit scenarios by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="8e75b-176">Это метод, используемый в этих учебниках.</span><span class="sxs-lookup"><span data-stu-id="8e75b-176">That's the method used in these tutorials.</span></span>

<span data-ttu-id="8e75b-177">Альтернативный способ предотвратить overposting, который является предпочтительным, многие разработчики — использовать Просмотр моделей, а не классы сущностей с использованием привязки модели.</span><span class="sxs-lookup"><span data-stu-id="8e75b-177">An alternative way to prevent overposting that's preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="8e75b-178">Включить только те свойства, необходимые для обновления в модели представления.</span><span class="sxs-lookup"><span data-stu-id="8e75b-178">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="8e75b-179">После завершения процесса связывателя модели MVC, скопируйте свойства модели представления экземпляра сущности, при необходимости с помощью такого средства, как AutoMapper.</span><span class="sxs-lookup"><span data-stu-id="8e75b-179">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as AutoMapper.</span></span> <span data-ttu-id="8e75b-180">Используйте `_context.Entry` на экземпляр сущности для задания его состояния `Unchanged`и задайте `Property("PropertyName").IsModified` значение true для каждого свойства объекта, включенного в модель представления.</span><span class="sxs-lookup"><span data-stu-id="8e75b-180">Use `_context.Entry` on the entity instance to set its state to `Unchanged`, and then set `Property("PropertyName").IsModified` to true on each entity property that's included in the view model.</span></span> <span data-ttu-id="8e75b-181">Этот метод работает в обоих изменять и создавать сценарии.</span><span class="sxs-lookup"><span data-stu-id="8e75b-181">This method works in both edit and create scenarios.</span></span>

### <a name="test-the-create-page"></a><span data-ttu-id="8e75b-182">Страница создания тестов</span><span class="sxs-lookup"><span data-stu-id="8e75b-182">Test the Create page</span></span>

<span data-ttu-id="8e75b-183">Код в *Views/Students/Create.cshtml* использует `label`, `input`, и `span` (для проверки сообщений) вспомогательных функций для каждого поля тегов.</span><span class="sxs-lookup"><span data-stu-id="8e75b-183">The code in *Views/Students/Create.cshtml* uses `label`, `input`, and `span` (for validation messages) tag helpers for each field.</span></span>

<span data-ttu-id="8e75b-184">Запустите приложение, выберите **учащихся** и нажмите кнопку **создать новый**.</span><span class="sxs-lookup"><span data-stu-id="8e75b-184">Run the app, select the **Students** tab, and click **Create New**.</span></span>

<span data-ttu-id="8e75b-185">Введите имена и даты.</span><span class="sxs-lookup"><span data-stu-id="8e75b-185">Enter names and a date.</span></span> <span data-ttu-id="8e75b-186">Попробуйте ввести недопустимую дату, если браузер позволяет сделать.</span><span class="sxs-lookup"><span data-stu-id="8e75b-186">Try entering an invalid date if your browser lets you do that.</span></span> <span data-ttu-id="8e75b-187">(Некоторые браузеры заставляет использовать элемент выбора даты.) Нажмите кнопку **создать** для сообщения об ошибке.</span><span class="sxs-lookup"><span data-stu-id="8e75b-187">(Some browsers force you to use a date picker.) Then click **Create** to see the error message.</span></span>

![Ошибка при проверке даты](crud/_static/date-error.png)

<span data-ttu-id="8e75b-189">Это проверка на стороне сервера, получения по умолчанию; в этом руководстве вы увидите, как добавлять атрибуты, которые также создают код для проверки на стороне клиента.</span><span class="sxs-lookup"><span data-stu-id="8e75b-189">This is server-side validation that you get by default; in a later tutorial you'll see how to add attributes that will generate code for client-side validation also.</span></span> <span data-ttu-id="8e75b-190">Следующий выделенный код показывает проверки модели в `Create` метод.</span><span class="sxs-lookup"><span data-stu-id="8e75b-190">The following highlighted code shows the model validation check in the `Create` method.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=8)]

<span data-ttu-id="8e75b-191">Измените значение на допустимое Дата и нажмите кнопку **создать** для просмотра нового студента, которые отображаются в **индекс** страницы.</span><span class="sxs-lookup"><span data-stu-id="8e75b-191">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

## <a name="update-the-edit-page"></a><span data-ttu-id="8e75b-192">Обновление страницы правки</span><span class="sxs-lookup"><span data-stu-id="8e75b-192">Update the Edit page</span></span>

<span data-ttu-id="8e75b-193">В *StudentController.cs*, HttpGet `Edit` метод (один без `HttpPost` атрибут) использует `SingleOrDefaultAsync` метод для извлечения выбранную сущность Student, как видно из `Details` метод.</span><span class="sxs-lookup"><span data-stu-id="8e75b-193">In *StudentController.cs*, the HttpGet `Edit` method (the one without the `HttpPost` attribute) uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="8e75b-194">Измените этот метод не требуется.</span><span class="sxs-lookup"><span data-stu-id="8e75b-194">You don't need to change this method.</span></span>

### <a name="recommended-httppost-edit-code-read-and-update"></a><span data-ttu-id="8e75b-195">Рекомендуется изменить HttpPost кода: чтения и обновления</span><span class="sxs-lookup"><span data-stu-id="8e75b-195">Recommended HttpPost Edit code: Read and update</span></span>

<span data-ttu-id="8e75b-196">Замените метод действия HttpPost изменить следующий код.</span><span class="sxs-lookup"><span data-stu-id="8e75b-196">Replace the HttpPost Edit action method with the following code.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_ReadFirst)]

<span data-ttu-id="8e75b-197">Эти изменения реализовать рекомендации безопасности, чтобы предотвратить overposting.</span><span class="sxs-lookup"><span data-stu-id="8e75b-197">These changes implement a security best practice to prevent overposting.</span></span> <span data-ttu-id="8e75b-198">Scaffolder создан `Bind` атрибута и добавлены сущности, созданные связыватель модели для сущности с `Modified` флаг.</span><span class="sxs-lookup"><span data-stu-id="8e75b-198">The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a `Modified` flag.</span></span> <span data-ttu-id="8e75b-199">Что кода не рекомендуется для многих сценариев, так как `Bind` атрибут очищает все существующие данные в поля, которые не перечислены в `Include` параметра.</span><span class="sxs-lookup"><span data-stu-id="8e75b-199">That code isn't recommended for many scenarios because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span>

<span data-ttu-id="8e75b-200">Новый код считывает существующую сущность и вызовы `TryUpdateModel` обновить поля в полученную сущность [на основе ввода пользователя в отправленной формы данных](xref:mvc/models/model-binding#how-model-binding-works).</span><span class="sxs-lookup"><span data-stu-id="8e75b-200">The new code reads the existing entity and calls `TryUpdateModel` to update fields in the retrieved entity [based on user input in the posted form data](xref:mvc/models/model-binding#how-model-binding-works).</span></span> <span data-ttu-id="8e75b-201">Платформа Entity Framework автоматическое отслеживание наборов изменений `Modified` флаг для поля, которые были изменены с помощью входных данных формы.</span><span class="sxs-lookup"><span data-stu-id="8e75b-201">The Entity Framework's automatic change tracking sets the `Modified` flag on the fields that are changed by form input.</span></span> <span data-ttu-id="8e75b-202">Когда `SaveChanges` вызывается метод, Entity Framework создает инструкции SQL для обновления строки базы данных.</span><span class="sxs-lookup"><span data-stu-id="8e75b-202">When the `SaveChanges` method is called, the Entity Framework creates SQL statements to update the database row.</span></span> <span data-ttu-id="8e75b-203">Конфликты параллелизма учитываются, а только столбцов таблицы, которые были обновлены пользователем обновляются в базе данных.</span><span class="sxs-lookup"><span data-stu-id="8e75b-203">Concurrency conflicts are ignored, and only the table columns that were updated by the user are updated in the database.</span></span> <span data-ttu-id="8e75b-204">(Этом руководстве показано, как обрабатывать конфликты параллелизма.)</span><span class="sxs-lookup"><span data-stu-id="8e75b-204">(A later tutorial shows how to handle concurrency conflicts.)</span></span>

<span data-ttu-id="8e75b-205">Рекомендуется для предотвращения оверпостинга, поля, которые должны быть обновляемым, **изменить** страницы, входят в `TryUpdateModel` параметров.</span><span class="sxs-lookup"><span data-stu-id="8e75b-205">As a best practice to prevent overposting, the fields that you want to be updateable by the **Edit** page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="8e75b-206">(Является пустой строкой, предшествующий список полей в списке параметров префикс для имен полей формы.) В настоящее время нет дополнительных полей, вы защищаете, но список полей, которые должны связыватель модели для привязки гарантирует, что при добавлении поля в модели данных в будущем, автоматически защищены ли они пока не будут добавлены явно здесь.</span><span class="sxs-lookup"><span data-stu-id="8e75b-206">(The empty string preceding the list of fields in the parameter list is for a prefix to use with the form fields names.) Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

<span data-ttu-id="8e75b-207">В результате этих изменений в сигнатуре метода HttpPost `Edit` метод совпадает со значением HttpGet `Edit` метода; таким образом вы переименовали метод `EditPost`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-207">As a result of these changes, the method signature of the HttpPost `Edit` method is the same as the HttpGet `Edit` method; therefore you've renamed the method `EditPost`.</span></span>

### <a name="alternative-httppost-edit-code-create-and-attach"></a><span data-ttu-id="8e75b-208">Альтернативный образец программного кода редактирования HttpPost: Создание и присоединение</span><span class="sxs-lookup"><span data-stu-id="8e75b-208">Alternative HttpPost Edit code: Create and attach</span></span>

<span data-ttu-id="8e75b-209">Рекомендуется изменить код HttpPost гарантирует, что только измененные столбцы обновляются и сохраняет данные в свойствах, которые необходимо исключить включены для привязки модели.</span><span class="sxs-lookup"><span data-stu-id="8e75b-209">The recommended HttpPost edit code ensures that only changed columns get updated and preserves data in properties that you don't want included for model binding.</span></span> <span data-ttu-id="8e75b-210">Однако чтения первый подход требует дополнительных баз данных чтения и может привести к более сложный код для обработки конфликтов параллелизма.</span><span class="sxs-lookup"><span data-stu-id="8e75b-210">However, the read-first approach requires an extra database read, and can result in more complex code for handling concurrency conflicts.</span></span> <span data-ttu-id="8e75b-211">Альтернативой является присоединить сущность, созданные связывателя модели к контексту EF и пометьте его как измененный.</span><span class="sxs-lookup"><span data-stu-id="8e75b-211">An alternative is to attach an entity created by the model binder to the EF context and mark it as modified.</span></span> <span data-ttu-id="8e75b-212">(Не обновить проект, этот код, он показаны только для иллюстрации необязательно подход.)</span><span class="sxs-lookup"><span data-stu-id="8e75b-212">(Don't update your project with this code, it's only shown to illustrate an optional approach.)</span></span> 

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_CreateAndAttach)]

<span data-ttu-id="8e75b-213">Этот подход можно использовать при веб-страницы пользовательского интерфейса включает все поля в сущности и можно обновить любой из них.</span><span class="sxs-lookup"><span data-stu-id="8e75b-213">You can use this approach when the web page UI includes all of the fields in the entity and can update any of them.</span></span>

<span data-ttu-id="8e75b-214">Используется подход, создать и присоединить формирования шаблонов кода, но только перехватывает `DbUpdateConcurrencyException` исключения и возвращает 404 коды ошибок.</span><span class="sxs-lookup"><span data-stu-id="8e75b-214">The scaffolded code uses the create-and-attach approach but only catches `DbUpdateConcurrencyException` exceptions and returns 404 error codes.</span></span>  <span data-ttu-id="8e75b-215">В примере показано перехватывает все исключения обновления базы данных и отображает сообщение об ошибке.</span><span class="sxs-lookup"><span data-stu-id="8e75b-215">The example shown catches any database update exception and displays an error message.</span></span>

### <a name="entity-states"></a><span data-ttu-id="8e75b-216">Состояния сущностей</span><span class="sxs-lookup"><span data-stu-id="8e75b-216">Entity States</span></span>

<span data-ttu-id="8e75b-217">Отслеживает отслеживания объекта контекст базы данных, будут ли сущностей в памяти, в соответствии с их соответствующих строк в базе данных, и эта информация определяет, что происходит при вызове `SaveChanges` метода.</span><span class="sxs-lookup"><span data-stu-id="8e75b-217">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="8e75b-218">Например, при передаче новую сущность, `Add` метод, который присваивается состояние сущности `Added`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-218">For example, when you pass a new entity to the `Add` method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="8e75b-219">Затем при вызове `SaveChanges` метода, контекст базы данных отдает команду SQL INSERT.</span><span class="sxs-lookup"><span data-stu-id="8e75b-219">Then when you call the `SaveChanges` method, the database context issues a SQL INSERT command.</span></span>

<span data-ttu-id="8e75b-220">Сущность может иметь одно из следующих состояний:</span><span class="sxs-lookup"><span data-stu-id="8e75b-220">An entity may be in one of the following states:</span></span>

* <span data-ttu-id="8e75b-221">`Added`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-221">`Added`.</span></span> <span data-ttu-id="8e75b-222">Сущность еще не существует в базе данных.</span><span class="sxs-lookup"><span data-stu-id="8e75b-222">The entity doesn't yet exist in the database.</span></span> <span data-ttu-id="8e75b-223">`SaveChanges` Метод выдает инструкции INSERT.</span><span class="sxs-lookup"><span data-stu-id="8e75b-223">The `SaveChanges` method issues an INSERT statement.</span></span>

* <span data-ttu-id="8e75b-224">`Unchanged`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-224">`Unchanged`.</span></span> <span data-ttu-id="8e75b-225">Не нужно ничего сделать с помощью этой сущности, `SaveChanges` метод.</span><span class="sxs-lookup"><span data-stu-id="8e75b-225">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="8e75b-226">При чтении из базы данных сущности, сущность начинается с этим состоянием.</span><span class="sxs-lookup"><span data-stu-id="8e75b-226">When you read an entity from the database, the entity starts out with this status.</span></span>

* <span data-ttu-id="8e75b-227">`Modified`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-227">`Modified`.</span></span> <span data-ttu-id="8e75b-228">Были изменены некоторые или все значения свойств сущности.</span><span class="sxs-lookup"><span data-stu-id="8e75b-228">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="8e75b-229">`SaveChanges` Метод выдает инструкции UPDATE.</span><span class="sxs-lookup"><span data-stu-id="8e75b-229">The `SaveChanges` method issues an UPDATE statement.</span></span>

* <span data-ttu-id="8e75b-230">`Deleted`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-230">`Deleted`.</span></span> <span data-ttu-id="8e75b-231">Сущность была помечена для удаления.</span><span class="sxs-lookup"><span data-stu-id="8e75b-231">The entity has been marked for deletion.</span></span> <span data-ttu-id="8e75b-232">`SaveChanges` Метод выполняет инструкцию DELETE.</span><span class="sxs-lookup"><span data-stu-id="8e75b-232">The `SaveChanges` method issues a DELETE statement.</span></span>

* <span data-ttu-id="8e75b-233">`Detached`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-233">`Detached`.</span></span> <span data-ttu-id="8e75b-234">Сущность не отслеживается контекст базы данных.</span><span class="sxs-lookup"><span data-stu-id="8e75b-234">The entity isn't being tracked by the database context.</span></span>

<span data-ttu-id="8e75b-235">В приложении для настольных систем изменения состояния обычно устанавливаются автоматически.</span><span class="sxs-lookup"><span data-stu-id="8e75b-235">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="8e75b-236">Чтение сущности и изменить некоторые значения свойств.</span><span class="sxs-lookup"><span data-stu-id="8e75b-236">You read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="8e75b-237">В результате состояние сущности автоматически меняется на `Modified`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-237">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="8e75b-238">Затем при вызове `SaveChanges`, Entity Framework создает инструкцию SQL UPDATE, обновляет только фактические свойства, которые были изменены.</span><span class="sxs-lookup"><span data-stu-id="8e75b-238">Then when you call `SaveChanges`, the Entity Framework generates a SQL UPDATE statement that updates only the actual properties that you changed.</span></span>

<span data-ttu-id="8e75b-239">В веб-приложении `DbContext` , изначально считывает сущности и отображает данные для редактирования удаляется после отрисовки страницы.</span><span class="sxs-lookup"><span data-stu-id="8e75b-239">In a web app, the `DbContext` that initially reads an entity and displays its data to be edited is disposed after a page is rendered.</span></span> <span data-ttu-id="8e75b-240">Когда HttpPost `Edit` вызывается метод действия, новый веб-запроса, и у вас есть новый экземпляр `DbContext`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-240">When the HttpPost `Edit` action method is called,  a new web request is made and you have a new instance of the `DbContext`.</span></span> <span data-ttu-id="8e75b-241">Если перечитать сущности в этот новый контекст моделируются обработки рабочего стола.</span><span class="sxs-lookup"><span data-stu-id="8e75b-241">If you re-read the entity in that new context, you simulate desktop processing.</span></span>

<span data-ttu-id="8e75b-242">Но если вы не хотите выполнять дополнительные операции чтения, необходимо использовать объект сущности, созданные связывателя модели.</span><span class="sxs-lookup"><span data-stu-id="8e75b-242">But if you don't want to do the extra read operation, you have to use the entity object created by the model binder.</span></span>  <span data-ttu-id="8e75b-243">Для этого проще всего присвоено состояние сущности изменено, поскольку выполняется в альтернативных приведенный выше код HttpPost редактирования.</span><span class="sxs-lookup"><span data-stu-id="8e75b-243">The simplest way to do this is to set the entity state to Modified as is done in the alternative HttpPost Edit code shown earlier.</span></span> <span data-ttu-id="8e75b-244">Затем при вызове `SaveChanges`, Entity Framework, обновляет все столбцы строки базы данных, так как контекст никак не может знать, какие свойства были изменены.</span><span class="sxs-lookup"><span data-stu-id="8e75b-244">Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>

<span data-ttu-id="8e75b-245">Если вы хотите избежать чтения первый подход, но также требуется, чтобы инструкция SQL UPDATE для обновления только поля, которые пользователь действительно были изменены, код является более сложным.</span><span class="sxs-lookup"><span data-stu-id="8e75b-245">If you want to avoid the read-first approach, but you also want the SQL UPDATE statement to update only the fields that the user actually changed, the code is more complex.</span></span> <span data-ttu-id="8e75b-246">Необходимо сохранить первоначальные значения иным образом (например, с помощью скрытые поля), чтобы они были доступны при HttpPost `Edit` вызывается метод.</span><span class="sxs-lookup"><span data-stu-id="8e75b-246">You have to save the original values in some way (such as by using hidden fields) so that they're available when the HttpPost `Edit` method is called.</span></span> <span data-ttu-id="8e75b-247">Затем вы можете создать сущность Student, с помощью исходных значений, вызов `Attach` с этой версией исходной сущности, обновления значений сущности с новыми значениями и затем вызвать `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-247">Then you can create a Student entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges`.</span></span>

### <a name="test-the-edit-page"></a><span data-ttu-id="8e75b-248">Тестовая страница редактирования</span><span class="sxs-lookup"><span data-stu-id="8e75b-248">Test the Edit page</span></span>

<span data-ttu-id="8e75b-249">Запустите приложение, выберите **учащихся** , затем щелкните **изменить** гиперссылки.</span><span class="sxs-lookup"><span data-stu-id="8e75b-249">Run the app, select the **Students** tab, then click an **Edit** hyperlink.</span></span>

![Страница изменения студентов](crud/_static/student-edit.png)

<span data-ttu-id="8e75b-251">Изменить некоторые данные, и нажмите кнопку **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="8e75b-251">Change some of the data and click **Save**.</span></span> <span data-ttu-id="8e75b-252">**Индекс** открывает страницу и увидеть измененные данные.</span><span class="sxs-lookup"><span data-stu-id="8e75b-252">The **Index** page opens and you see the changed data.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="8e75b-253">Обновление страницы удаления</span><span class="sxs-lookup"><span data-stu-id="8e75b-253">Update the Delete page</span></span>

<span data-ttu-id="8e75b-254">В *StudentController.cs*, код шаблона для HttpGet `Delete` использует метод `SingleOrDefaultAsync` метод для извлечения выбранную сущность Student, как видно в представлениях данных и изменить методы.</span><span class="sxs-lookup"><span data-stu-id="8e75b-254">In *StudentController.cs*, the template code for the HttpGet `Delete` method uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the Details and Edit methods.</span></span> <span data-ttu-id="8e75b-255">Тем не менее, для реализации пользовательской ошибки сообщение при вызове `SaveChanges` завершается ошибкой, мы добавим некоторые функциональные возможности этого метода и его соответствующее представление.</span><span class="sxs-lookup"><span data-stu-id="8e75b-255">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="8e75b-256">Как показано для обновления и создания операций, операций удаления может потребоваться два метода действия.</span><span class="sxs-lookup"><span data-stu-id="8e75b-256">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="8e75b-257">Метод, который вызывается в ответ на запрос GET отображает представление, которое дает пользователю возможность утверждения или отменить операцию удаления.</span><span class="sxs-lookup"><span data-stu-id="8e75b-257">The method that's called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="8e75b-258">Если пользователь утверждает его, создается запрос POST.</span><span class="sxs-lookup"><span data-stu-id="8e75b-258">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="8e75b-259">Когда это происходит, HttpPost `Delete` вызывается метод, а затем этот метод фактически выполняет операцию удаления.</span><span class="sxs-lookup"><span data-stu-id="8e75b-259">When that happens, the HttpPost `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="8e75b-260">Вы добавите блок try-catch HttpPost `Delete` метод для обработки всех ошибок, которые могут возникнуть при обновлении базы данных.</span><span class="sxs-lookup"><span data-stu-id="8e75b-260">You'll add a try-catch block to the HttpPost `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="8e75b-261">При возникновении ошибки метод HttpPost Delete вызывает метод HttpGet Delete, передав параметр, указывающий, что произошла ошибка.</span><span class="sxs-lookup"><span data-stu-id="8e75b-261">If an error occurs, the HttpPost Delete method calls the HttpGet Delete method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="8e75b-262">Метод HttpGet Delete, затем повторно отображает страница подтверждения, а также сообщение об ошибке, предоставляя пользователю возможность отменить или повторить.</span><span class="sxs-lookup"><span data-stu-id="8e75b-262">The HttpGet Delete method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

<span data-ttu-id="8e75b-263">Замените HttpGet `Delete` метод действия с следующий код, который управляет отчеты об ошибках.</span><span class="sxs-lookup"><span data-stu-id="8e75b-263">Replace the HttpGet `Delete` action method with the following code, which manages error reporting.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteGet&highlight=1,9,16-21)]

<span data-ttu-id="8e75b-264">Этот код принимает необязательный параметр, который указывает, является ли метод был вызван после сбоя, чтобы сохранить изменения.</span><span class="sxs-lookup"><span data-stu-id="8e75b-264">This code accepts an optional parameter that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="8e75b-265">Этот параметр имеет значение false при HttpGet `Delete` метод вызывается без предыдущего сбоя.</span><span class="sxs-lookup"><span data-stu-id="8e75b-265">This parameter is false when the HttpGet `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="8e75b-266">При вызове HttpPost `Delete` метода в ответ на ошибку обновления базы данных параметр имеет значение true, и сообщение об ошибке передается в представление.</span><span class="sxs-lookup"><span data-stu-id="8e75b-266">When it's called by the HttpPost `Delete` method in response to a database update error, the parameter is true and an error message is passed to the view.</span></span>

### <a name="the-read-first-approach-to-httppost-delete"></a><span data-ttu-id="8e75b-267">Подход с использованием первого чтения для удаления HttpPost</span><span class="sxs-lookup"><span data-stu-id="8e75b-267">The read-first approach to HttpPost Delete</span></span>

<span data-ttu-id="8e75b-268">Замените HttpPost `Delete` метода действия (с именем `DeleteConfirmed`) следующим кодом, который выполняет операцию удаления фактическое и перехватывает все ошибки обновления базы данных.</span><span class="sxs-lookup"><span data-stu-id="8e75b-268">Replace the HttpPost `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithReadFirst&highlight=6,8-11,13-14,18-23)]

<span data-ttu-id="8e75b-269">Этот код извлекает выбранной сущности, а затем вызывает `Remove` метод, чтобы задать состояния сущности `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-269">This code retrieves the selected entity, then calls the `Remove` method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="8e75b-270">При `SaveChanges` вызове SQL DELETE команда создается.</span><span class="sxs-lookup"><span data-stu-id="8e75b-270">When `SaveChanges` is called, a SQL DELETE command is generated.</span></span>

### <a name="the-create-and-attach-approach-to-httppost-delete"></a><span data-ttu-id="8e75b-271">Создание и присоединение способ удаления HttpPost</span><span class="sxs-lookup"><span data-stu-id="8e75b-271">The create-and-attach approach to HttpPost Delete</span></span>

<span data-ttu-id="8e75b-272">Если приоритетом является повышение производительности в приложении большого объема, поможет избежать ненужных SQL-запроса путем создания экземпляра студента сущности, используя только первичного ключа значение и затем присвоить состояние сущности `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="8e75b-272">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query by instantiating a Student entity using only the primary key value and then setting the entity state to `Deleted`.</span></span> <span data-ttu-id="8e75b-273">Это все, что платформа Entity Framework требуется, чтобы удалить сущность.</span><span class="sxs-lookup"><span data-stu-id="8e75b-273">That's all that the Entity Framework needs in order to delete the entity.</span></span> <span data-ttu-id="8e75b-274">(Этот код не следует размещать в проекте; именно здесь исключительно для демонстрации альтернативы).</span><span class="sxs-lookup"><span data-stu-id="8e75b-274">(Don't put this code in your project; it's here just to illustrate an alternative.)</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithoutReadFirst&highlight=7-8)]

<span data-ttu-id="8e75b-275">Если сущность имеет связанные данные, которые также будут удалены, убедитесь, что каскадное удаление настроен в базе данных.</span><span class="sxs-lookup"><span data-stu-id="8e75b-275">If the entity has related data that should also be deleted, make sure that cascade delete is configured in the database.</span></span> <span data-ttu-id="8e75b-276">В этом случае для удаления сущности EF могут не узнать, что имеются связанные сущности для удаления.</span><span class="sxs-lookup"><span data-stu-id="8e75b-276">With this approach to entity deletion, EF might not realize there are related entities to be deleted.</span></span>

### <a name="update-the-delete-view"></a><span data-ttu-id="8e75b-277">Обновление представления удаления</span><span class="sxs-lookup"><span data-stu-id="8e75b-277">Update the Delete view</span></span>

<span data-ttu-id="8e75b-278">В *Views/Student/Delete.cshtml*, добавить сообщение об ошибке между заголовком h2 и заголовок h3, как показано в следующем примере:</span><span class="sxs-lookup"><span data-stu-id="8e75b-278">In *Views/Student/Delete.cshtml*, add an error message between the h2 heading and the h3 heading, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Delete.cshtml?range=7-9&highlight=2)]

<span data-ttu-id="8e75b-279">Запустите приложение, выберите **учащихся** и нажмите кнопку **удалить** гиперссылки:</span><span class="sxs-lookup"><span data-stu-id="8e75b-279">Run the app, select the **Students** tab, and click a **Delete** hyperlink:</span></span>

![Удалить страницу подтверждения](crud/_static/student-delete.png)

<span data-ttu-id="8e75b-281">Нажмите кнопку **удалить**.</span><span class="sxs-lookup"><span data-stu-id="8e75b-281">Click **Delete**.</span></span> <span data-ttu-id="8e75b-282">Без удаленных студента отображается страница индекса.</span><span class="sxs-lookup"><span data-stu-id="8e75b-282">The Index page is displayed without the deleted student.</span></span> <span data-ttu-id="8e75b-283">(Вы увидите пример код обработки ошибок в действие в учебнике параллелизмом.)</span><span class="sxs-lookup"><span data-stu-id="8e75b-283">(You'll see an example of the error handling code in action in the concurrency tutorial.)</span></span>

## <a name="closing-database-connections"></a><span data-ttu-id="8e75b-284">Закрытие подключения к базе данных</span><span class="sxs-lookup"><span data-stu-id="8e75b-284">Closing database connections</span></span>

<span data-ttu-id="8e75b-285">Чтобы освободить ресурсы, занятые подключения к базе данных, экземпляр контекста должен быть удален как можно быстрее после завершения с ним.</span><span class="sxs-lookup"><span data-stu-id="8e75b-285">To free up the resources that a database connection holds, the context instance must be disposed as soon as possible when you are done with it.</span></span> <span data-ttu-id="8e75b-286">Встроенная ASP.NET Core [внедрения зависимостей](../../fundamentals/dependency-injection.md) берет на себя эту задачу для вас.</span><span class="sxs-lookup"><span data-stu-id="8e75b-286">The ASP.NET Core built-in [dependency injection](../../fundamentals/dependency-injection.md) takes care of that task for you.</span></span>

<span data-ttu-id="8e75b-287">В *файла Startup.cs*, можно вызвать [метод расширения AddDbContext](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) для подготовки `DbContext` класс в контейнере ASP.NET DI.</span><span class="sxs-lookup"><span data-stu-id="8e75b-287">In *Startup.cs*, you call the [AddDbContext extension method](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) to provision the `DbContext` class in the ASP.NET DI container.</span></span> <span data-ttu-id="8e75b-288">Что метод задает время существования службы `Scoped` по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="8e75b-288">That method sets the service lifetime to `Scoped` by default.</span></span> <span data-ttu-id="8e75b-289">`Scoped`означает время существования объекта контекста совпадает с временем жизни запроса web, и `Dispose` метод автоматически вызывается в конце веб-запроса.</span><span class="sxs-lookup"><span data-stu-id="8e75b-289">`Scoped` means the context object lifetime coincides with the web request life time, and the `Dispose` method will be called automatically at the end of the web request.</span></span>

## <a name="handling-transactions"></a><span data-ttu-id="8e75b-290">Обработка транзакций</span><span class="sxs-lookup"><span data-stu-id="8e75b-290">Handling Transactions</span></span>

<span data-ttu-id="8e75b-291">По умолчанию платформа Entity Framework неявно реализует транзакции.</span><span class="sxs-lookup"><span data-stu-id="8e75b-291">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="8e75b-292">В сценариях, где можно внести изменения в несколько строк или таблиц, а затем вызвать `SaveChanges`, Entity Framework автоматически гарантирует, что все изменения, внесенные завершится успехом или на всех остальных.</span><span class="sxs-lookup"><span data-stu-id="8e75b-292">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or they all fail.</span></span> <span data-ttu-id="8e75b-293">Если сначала выполняются некоторые изменения, а затем происходит ошибка, эти изменения автоматически происходит возврат.</span><span class="sxs-lookup"><span data-stu-id="8e75b-293">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="8e75b-294">См. в сценариях, где требуется дополнительный контроль — например, если вы хотите включить действия, выполненные за пределами платформы Entity Framework транзакции-- [транзакции](https://docs.microsoft.com/ef/core/saving/transactions).</span><span class="sxs-lookup"><span data-stu-id="8e75b-294">For scenarios where you need more control -- for example, if you want to include operations done outside of Entity Framework in a transaction -- see [Transactions](https://docs.microsoft.com/ef/core/saving/transactions).</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="8e75b-295">Нет отслеживания запросов</span><span class="sxs-lookup"><span data-stu-id="8e75b-295">No-tracking queries</span></span>

<span data-ttu-id="8e75b-296">Если контекст базы данных получает строки таблицы и создает объекты сущности, представляющие их, по умолчанию он хранит информацию о ли сущностей в памяти синхронизированы с папкой базы данных.</span><span class="sxs-lookup"><span data-stu-id="8e75b-296">When a database context retrieves table rows and creates entity objects that represent them, by default it keeps track of whether the entities in memory are in sync with what's in the database.</span></span> <span data-ttu-id="8e75b-297">Данные в памяти действует как кэш и используется, если вы обновили сущность.</span><span class="sxs-lookup"><span data-stu-id="8e75b-297">The data in memory acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="8e75b-298">Это кэширование необязательно, часто в веб-приложение, так как контекста экземпляров обычно кратковременных (новый один создается и удаляется для каждого запроса), а в контексте, осуществляющий чтение сущности обычно удаляется, прежде чем снова используется этой сущности.</span><span class="sxs-lookup"><span data-stu-id="8e75b-298">This caching is often unnecessary in a web application because context instances are typically short-lived (a new one is created and disposed for each request) and the context that reads an entity is typically disposed before that entity is used again.</span></span>

<span data-ttu-id="8e75b-299">Отслеживание объектов сущностей в памяти можно отключить путем вызова `AsNoTracking` метод.</span><span class="sxs-lookup"><span data-stu-id="8e75b-299">You can disable tracking of entity objects in memory by calling the `AsNoTracking` method.</span></span> <span data-ttu-id="8e75b-300">Ниже приведены типичные сценарии, в которых может потребоваться сделать:</span><span class="sxs-lookup"><span data-stu-id="8e75b-300">Typical scenarios in which you might want to do that include the following:</span></span>

* <span data-ttu-id="8e75b-301">Во время существования контекста не нужно обновлять все сущности, и не нужны EF для [автоматически загружать свойства навигации с сущностями, полученные путем отдельных запросов](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="8e75b-301">During the context lifetime you don't need to update any entities, and you don't need EF to [automatically load navigation properties with  entities retrieved by separate queries](read-related-data.md).</span></span> <span data-ttu-id="8e75b-302">Часто эти условия будут выполнены в методы действий контроллера HttpGet.</span><span class="sxs-lookup"><span data-stu-id="8e75b-302">Frequently these conditions are met in a controller's HttpGet action methods.</span></span>

* <span data-ttu-id="8e75b-303">Выполняется запрос, получающий большого объема данных, а лишь малую часть возвращаемых данных будет обновляться.</span><span class="sxs-lookup"><span data-stu-id="8e75b-303">You are running a query that retrieves a large volume of data, and only a small portion of the returned data will be updated.</span></span> <span data-ttu-id="8e75b-304">Может быть более эффективным, чтобы отключить отслеживания для большого запроса и выполнить запрос позже для некоторых объектов, которые должны быть обновлены.</span><span class="sxs-lookup"><span data-stu-id="8e75b-304">It may be more efficient to turn off tracking for the large query, and run a query later for the few entities that need to be updated.</span></span>

* <span data-ttu-id="8e75b-305">Необходимо присоединить сущности, чтобы обновить его, но ранее получить той же сущности для другой цели.</span><span class="sxs-lookup"><span data-stu-id="8e75b-305">You want to attach an entity in order to update it, but earlier you retrieved the same entity for a different purpose.</span></span> <span data-ttu-id="8e75b-306">Поскольку сущность уже отслеживается контекстом базы данных, не удается присоединить сущности, который требуется изменить.</span><span class="sxs-lookup"><span data-stu-id="8e75b-306">Because the entity is already being tracked by the database context, you can't attach the entity that you want to change.</span></span> <span data-ttu-id="8e75b-307">Один из способов обработки этой ситуации является вызов `AsNoTracking` в предыдущем запросе.</span><span class="sxs-lookup"><span data-stu-id="8e75b-307">One way to handle this situation is to call `AsNoTracking` on the earlier query.</span></span>

<span data-ttu-id="8e75b-308">Дополнительные сведения см. в разделе [отслеживания vs. Нет отслеживания](https://docs.microsoft.com/ef/core/querying/tracking).</span><span class="sxs-lookup"><span data-stu-id="8e75b-308">For more information, see [Tracking vs. No-Tracking](https://docs.microsoft.com/ef/core/querying/tracking).</span></span>

## <a name="summary"></a><span data-ttu-id="8e75b-309">Сводка</span><span class="sxs-lookup"><span data-stu-id="8e75b-309">Summary</span></span>

<span data-ttu-id="8e75b-310">Теперь у вас есть полный набор страниц, которые выполняют простые операции CRUD для сущностей студента.</span><span class="sxs-lookup"><span data-stu-id="8e75b-310">You now have a complete set of pages that perform simple CRUD operations for Student entities.</span></span> <span data-ttu-id="8e75b-311">В следующем уроке будет расширяют функциональные возможности **индекс** страницы путем добавления сортировку, фильтрацию и разбиение по страницам.</span><span class="sxs-lookup"><span data-stu-id="8e75b-311">In the next tutorial you'll expand the functionality of the **Index** page by adding sorting, filtering, and paging.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="8e75b-312">[Назад](intro.md)
[Вперед](sort-filter-page.md)</span><span class="sxs-lookup"><span data-stu-id="8e75b-312">[Previous](intro.md)
[Next](sort-filter-page.md)</span></span>  

---
title: "Страниц Razor с Entity Framework Core - учебник № 1 по 8."
author: rick-anderson
description: "Показано, как создать приложение страниц Razor с помощью Entity Framework Core"
ms.author: riande
manager: wpickett
ms.date: 11/15/2017
ms.topic: get-started-article
ms.technology: aspnet
ms.prod: asp.net-core
uid: data/ef-rp/intro
ms.openlocfilehash: bea3b12ebe476c4b59abe117393b0ec8bb7f0306
ms.sourcegitcommit: 3e303620a125325bb9abd4b2d315c106fb8c47fd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/19/2018
---
# <a name="getting-started-with-razor-pages-and-entity-framework-core-using-visual-studio-1-of-8"></a>Приступая к работе со страницами Razor и Entity Framework Core, с помощью Visual Studio (1, 8)

По [Tom Dykstra](https://github.com/tdykstra) и [Рик Андерсон](https://twitter.com/RickAndMSFT)

Contoso университета образец веб-приложения показано, как создавать веб-приложения ASP.NET MVC 2.0 ядра с помощью основных Entity Framework (EF) 2.0 и Visual Studio 2017 г.

Пример приложения является веб-сайт для вымышленной компании Contoso университета. Он включает функции, такие как допуском студента, создание курса и инструктора назначения. Эта страница является первой в серию учебников, в которых объясняется, как для создания примера приложения Contoso университета.

[Загрузить или просмотреть завершенное приложение.](https://github.com/aspnet/Docs/tree/master/aspnetcore/data/ef-rp/intro/samples) [Инструкции по загрузке](xref:tutorials/index#how-to-download-a-sample).

## <a name="prerequisites"></a>Предварительные требования

[!INCLUDE[install 2.0](../../includes/install2.0.md)]

Знакомство с [страниц Razor](xref:mvc/razor-pages/index). Новый программисты должны заполнить [приступить к работе со страницами Razor](xref:tutorials/razor-pages/razor-pages-start) перед запуском этой серии.

## <a name="troubleshooting"></a>Устранение неполадок

Если возникли проблемы, не удается устранить, обычно можно найти решения путем сравнения код, чтобы [завершения этапа](https://github.com/aspnet/Docs/tree/master/aspnetcore/data/ef-rp/intro/samples/StageSnapShots) или [завершенного проекта](https://github.com/aspnet/Docs/tree/master/aspnetcore/data/ef-rp/intro/samples/cu-final). Список распространенных ошибок и способы их устранения см. в разделе [раздел "Устранение неполадок" последнего учебника в серии](xref:data/ef-mvc/advanced#common-errors). Если вы не нашли нужную информацию существует, можно разместить вопрос на [StackOverflow.com](https://stackoverflow.com/questions/tagged/asp.net-core) для [ASP.NET Core](https://stackoverflow.com/questions/tagged/asp.net-core) или [EF Core](https://stackoverflow.com/questions/tagged/entity-framework-core).

> [!TIP]
> Эта серия учебников основан на выполняемые операции в предыдущих учебниках. Рекомендуется сохранить копию проекта после каждого успешного завершения учебника. Если возникли проблемы, можно начать сначала из предыдущего учебника вместо вернуться в начало. Кроме того, вы можете загрузить [завершения этапа](https://github.com/aspnet/Docs/tree/master/aspnetcore/data/ef-rp/intro/samples/StageSnapShots) и начать заново с помощью завершенной рабочей области.

## <a name="the-contoso-university-web-app"></a>Contoso университета веб-приложения

Приложения, созданного в этих учебниках является веб-сайта основные университета.

Пользователи могут просматривать и обновлять студента курса и инструктора сведения. Ниже представлены несколько экранов, созданный в учебнике.

![Страница индекса студентов](intro/_static/students-index.png)

![Страница изменения студентов](intro/_static/student-edit.png)

Приближается к создаваемой с помощью встроенных шаблонов стиля пользовательского интерфейса этого сайта. Учебник основное внимание уделяется Core EF со страницами Razor не пользовательского интерфейса.

## <a name="create-a-razor-pages-web-app"></a>Создание страниц Razor веб-приложения

* В меню **Файл** Visual Studio откройте меню **Создать** > **Проект**.
* Создайте новое веб-приложение ASP.NET Core. Назовите проект **ContosoUniversity**. Очень важно для проекта имя *ContosoUniversity* , пространства имен совпадение, если код является скопированные и вставленные.
 ![Новое веб-приложение ASP.NET Core](intro/_static/np.png)
* Выберите в раскрывающемся списке **ASP.NET Core 2.0**, а затем **Веб-приложение**.
 ![Веб-приложение (Razor Pages)](../../mvc/razor-pages/index/_static/np2.png)

Нажмите клавишу **F5**, чтобы запустить приложение в режиме отладки, или **CTRL-F5**, чтобы запустить его без подключения отладчика.

## <a name="set-up-the-site-style"></a>Настройка стиля узла

Некоторые изменения настройки сайта меню, макета и домашнюю страницу.

Откройте *Pages/_Layout.cshtml* и внесите следующие изменения:

* Изменить все вхождения «ContosoUniversity» на «Contoso University». Нет трех экземпляров.

* Добавление пунктов меню для **учащихся**, **курсы**, **инструкторов**, и **отделы**и удалите **контакт** меню.

Изменения выделены. (Разметка является *не* отображается.)

[!code-html[](intro/samples/cu/Pages/_Layout.cshtml?highlight=6,29,35-38,47&range=1-50)]

В *Pages/Index.cshtml*, замените содержимое файла следующим кодом, чтобы заменить текст о ASP.NET и MVC на текст об этом приложении:

[!code-html[](intro/samples/cu/Pages/Index.cshtml)]

Нажмите клавиши CTRL+F5, чтобы запустить проект. Домашняя страница отображается с вкладками, созданные в следующих учебниках:

![Домашняя страница университета Contoso](intro/_static/home-page.png)

## <a name="create-the-data-model"></a>Создание модели данных

Создание классов сущностей для приложения Contoso университета. Начните со следующих трех сущностей:

![Схема модели курса регистрации студента данных](intro/_static/data-model-diagram.png)

Имеется отношение "один ко многим" между `Student` и `Enrollment` сущности. Имеется отношение "один ко многим" между `Course` и `Enrollment` сущности. Студент может зарегистрироваться в любое количество курсов. Курс может иметь любое количество студентов, зарегистрированных в нем.

В следующих разделах создается класс для каждого из этих сущностей.

### <a name="the-student-entity"></a>Сущность Student

![Схема entity студента](intro/_static/student-entity.png)

Создание *моделей* папки. В *моделей* папки, создайте файл класса с именем *Student.cs* следующим кодом:

[!code-csharp[Main](intro/samples/cu/Models/Student.cs?name=snippet_Intro)]

`ID` Свойство становится столбец первичного ключа таблицы базы данных (DB), соответствующий этому классу. По умолчанию основные EF интерпретирует свойство, которое называется `ID` или `classnameID` как первичный ключ.

`Enrollments` Свойство является свойством навигации. Свойства ссылки навигации к другим сущностям, которые относятся к этой сущности. В этом случае `Enrollments` свойство `Student entity` хранит все `Enrollment` сущностей, которые относятся к, `Student`. Например, если строка студента в базе данных имеет две связанные строки регистрации `Enrollments` свойства навигации содержит этих двух `Enrollment` сущностей. Связанный с ним `Enrollment` строка является строкой, содержащей этого студента значение первичного ключа в `StudentID` столбца. Например, предположим, что студента с Идентификатором = 1 имеет две строки `Enrollment` таблицы. `Enrollment` Таблица содержит две строки с `StudentID` = 1. `StudentID`является внешним ключом в `Enrollment` , указывающее студента в таблицу `Student` таблицы.

Если свойство навигации может содержать несколько сущностей, свойства навигации должен быть тип списка, например `ICollection<T>`. `ICollection<T>`можно указать, или тип, такой как `List<T>` или `HashSet<T>`. Когда `ICollection<T>` —, EF Core создает `HashSet<T>` коллекции по умолчанию. Свойства навигации, которые содержат несколько сущностей исходят от отношений "многие ко многим" и один ко многим.

### <a name="the-enrollment-entity"></a>Сущность регистрации

![Схема entity регистрации](intro/_static/enrollment-entity.png)

В *моделей* папке создайте *«Enrollment.cs» в качестве* следующим кодом:

[!code-csharp[Main](intro/samples/cu/Models/Enrollment.cs?name=snippet_Intro)]

`EnrollmentID` Свойство является первичным ключом. Использует эту сущность `classnameID` шаблона вместо `ID` как `Student` сущности. Обычно разработчики выбрать один шаблон и использовать его во всей модели данных. В этом руководстве с помощью идентификатора без classname отображается для упрощения реализации наследования в модели данных.

`Grade` Свойство `enum`. Знак вопроса после `Grade` объявление типа указывает, что `Grade` свойство имеет значение NULL. Степень, которую имеет значение null отличается от нуля оценку — значение null означает оценку не известен или еще не назначена.

`StudentID` Свойство внешнего ключа, и соответствующее свойство навигации `Student`. `Enrollment` Сущности связан с одним `Student` сущности, поэтому свойство содержит один `Student` сущности. `Student` Сущности отличается от `Student.Enrollments` свойство навигации, которое содержит несколько `Enrollment` сущностей.

`CourseID` Свойство внешнего ключа, и соответствующее свойство навигации `Course`. `Enrollment` Сущности связан с одним `Course` сущности.

EF Core интерпретирует свойство как внешний ключ, если он имеет имя `<navigation property name><primary key property name>`. Например`StudentID` для `Student` свойство навигации, поскольку `Student` первичного ключа сущности является `ID`. Свойства внешнего ключа может также называться `<primary key property name>`. Например `CourseID` с момента `Course` первичного ключа сущности является `CourseID`.

### <a name="the-course-entity"></a>Сущность курса

![Схема entity курса](intro/_static/course-entity.png)

В *моделей* папке создайте *Course.cs* следующим кодом:

[!code-csharp[Main](intro/samples/cu/Models/Course.cs?name=snippet_Intro)]

`Enrollments` Свойство является свойством навигации. Объект `Course` сущности могут быть связаны с любым количеством `Enrollment` сущностей.

`DatabaseGenerated` Атрибут позволяет приложению указать первичный ключ, а не наличие базы данных он сформирован.

## <a name="create-the-schoolcontext-db-context"></a>Создать контекст базы данных SchoolContext

Основной класс, который координирует EF основные функциональные возможности для заданной модели данных — класс контекста базы данных. Контекст данных является производным от `Microsoft.EntityFrameworkCore.DbContext`. Контекст данных указывает, какие сущности включаются в модель данных. В этом проекте класс с именем `SchoolContext`.

В папку проекта, создайте папку с именем *данные*.

В *данные* создания папок *SchoolContext.cs* следующим кодом:

[!code-csharp[Main](intro/samples/cu/Data/SchoolContext.cs?name=snippet_Intro)]

Этот код создает `DbSet` свойство для каждого набора сущностей. В терминологии EF основных компонентов:

* Обычно набор сущностей соответствует таблице базы данных.
* Сущность соответствует строке таблицы.

`DbSet<Enrollment>`и `DbSet<Course>` можно опустить. EF ядро включает их неявно поскольку `Student` ссылки на сущности `Enrollment` сущности и `Enrollment` ссылки на сущности `Course` сущности. Для этого учебника оставьте `DbSet<Enrollment>` и `DbSet<Course>` в `SchoolContext`.

При создании базы данных основной EF создает таблицы, которые имеют имена, то же, что `DbSet` имена свойств. Имена свойств для коллекций, обычно во множественном числе (учащихся вместо студента). Разработчики используют различные ли имена таблиц должны быть во множественном числе. Для этих учебников по умолчанию переопределяется путем указания имен таблиц в единственном числе в класс DbContext. Чтобы указать имена таблиц в единственном числе, добавьте следующий выделенный код:

[!code-csharp[Main](intro/samples/cu/Data/SchoolContext.cs?name=snippet_TableNames&highlight=16-21)]

## <a name="register-the-context-with-dependency-injection"></a>Регистрация контекста с помощью внедрения зависимости

Включает ASP.NET Core [внедрения зависимостей](xref:fundamentals/dependency-injection). Службы (такие как контекста данных Entity FRAMEWORK Core) регистрируются с помощью внедрения зависимости во время запуска приложения. Компоненты, которые требуют этих служб (например, страниц Razor) предоставляются этим службам через параметры конструктора. Далее в этом учебнике показан конструктор код, который возвращает экземпляр контекста базы данных.

Чтобы зарегистрировать `SchoolContext` как служба, откройте *файла Startup.cs*и добавьте выделенные строки к `ConfigureServices` метод.

[!code-csharp[Main](intro/samples/cu/Startup.cs?name=snippet_SchoolContext&highlight=3-4)]

Имя строки подключения передается в контекст путем вызова метода на `DbContextOptionsBuilder` объекта. Для локальной разработки [система конфигурации ASP.NET Core](xref:fundamentals/configuration/index) считывает строку подключения из *appsettings.json* файла.

Добавить `using` инструкции для `ContosoUniversity.Data` и `Microsoft.EntityFrameworkCore` пространства имен. Выполните построение проекта.

[!code-csharp[Main](intro/samples/cu/Startup.cs?name=snippet_Usings)]

Откройте *appsettings.json* и добавьте строку подключения, как показано в следующем коде:

[!code-json[](./intro/samples/cu/appsettings1.json?highlight=2-4)]

Предыдущий строка соединения использует `ConnectRetryCount=0` для предотвращения [SQLClient](https://docs.microsoft.com/dotnet/framework/data/adonet/ef/sqlclient-for-the-entity-framework) прекратит.

### <a name="sql-server-express-localdb"></a>SQL Server Express LocalDB

В строке соединения указывается база данных LocalDB SQL Server. LocalDB — это облегченная версия SQL Server Express Database Engine и предназначен для разработки приложений, а не использования в рабочей среде. LocalDB запускается по требованию в пользовательском режиме, поэтому настройки не слишком сложны. По умолчанию создает LocalDB *.mdf* DB файлы в `C:/Users/<user>` каталога.

## <a name="add-code-to-initialize-the-db-with-test-data"></a>Добавьте код для инициализации базы данных с тестовыми данными

EF Core создает пустой базы данных. В этом разделе *начальное значение* метод создается его заполнение тестовых данных.

В *данные* папки, создайте новый файл класса с именем *DbInitializer.cs* и добавьте следующий код:

[!code-csharp[Main](intro/samples/cu/Data/DbInitializer.cs?name=snippet_Intro)]

Код проверяет наличие любого студентов в базе данных. Если в базе данных нет учащихся, базы данных запускается с тестовыми данными. Он загружает тестовых данных в массивы вместо `List<T>` коллекций для оптимизации производительности.

`EnsureCreated` Метод автоматически создает базу данных для контекста базы данных. Если существует база данных, `EnsureCreated` возвращает без изменения базы данных.

В *Program.cs*, изменить `Main` метод делать следующее:

* Получите экземпляр контекста DB контейнер внедрения зависимостей.
* Вызовите метод инициализации, передав ему контекст.
* Dispose контекст при завершении метода начальное значение.

В следующем коде показано обновленное *Program.cs* файла.

[!code-csharp[Main](intro/samples/cu/ProgramOriginal.cs?name=snippet)]

При первом запуске приложения создается и заполняется тестовыми данными базы данных. При обновлении модели данных:
* Удаление базы данных.
* Обновите метод начальное значение.
* Запустите приложение и создать новые базы данных для задания начальных значений. 

На следующих занятиях рассматривается базы данных обновляется при изменений, без удаления и повторного создания базы данных в модели данных.

<a name="pmc"></a>
## <a name="add-scaffold-tooling"></a>Добавление средств формирования шаблонов

В этом разделе консоли диспетчера пакетов (PMC) используется для добавления кода создания Visual Studio веб-пакета. Этот пакет необходим для работы ядра формирования шаблонов.

В меню **Сервис** последовательно выберите пункты **Диспетчер пакетов NuGet** > **Консоль диспетчера пакетов**.

В пакет Диспетчер консоли (PMC), введите следующие команды:

```powershell
Install-Package Microsoft.VisualStudio.Web.CodeGeneration.Design
Install-Package Microsoft.VisualStudio.Web.CodeGeneration.Utils
```

Предыдущая команда добавляет в файл *.csproj пакеты NuGet:

[!code-csharp[Main](intro/samples/cu/ContosoUniversity1_csproj.txt?highlight=7-8)]

<a name="scaffold"></a>
## <a name="scaffold-the-model"></a>Формировать модели

* Откройте окно командной строки в папке проекта (папке, где находятся файлы *Program.cs*, *Startup.cs* и *.csproj* файлов).
* Выполните следующие команды:


 ```console
dotnet restore
dotnet aspnet-codegenerator razorpage -m Student -dc SchoolContext -udl -outDir Pages\Students --referenceScriptLibraries
 ```
 
Если создается следующая ошибка:

```text
Unhandled Exception: System.IO.FileNotFoundException: 
Could not load file or assembly 
'Microsoft.VisualStudio.Web.CodeGeneration.Utils, 
Version=2.0.0.0, Culture=neutral, PublicKeyToken=adb9793829ddae60'.
The system cannot find the file specified.
```

Выполните команду еще раз и оставьте комментарий в нижней части страницы.

Если возникает ошибка.
  ```
No executable found matching command "dotnet-aspnet-codegenerator"
  ```

Откройте окно командной строки в папке проекта (папке, где находятся файлы *Program.cs*, *Startup.cs* и *.csproj* файлов).


Выполните построение проекта. Сборки приводит к возникновению ошибки следующим образом:

 `1>Pages\Students\Index.cshtml.cs(26,38,26,45): error CS1061: 'SchoolContext' does not contain a definition for 'Student'`

 Глобальная замена `_context.Student` для `_context.Students` (то есть, добавить «s» `Student`). 7 вхождений обнаружены и обновлены. Мы надеемся, что исправление [этой ошибки](https://github.com/aspnet/Scaffolding/issues/633) в следующем выпуске.

[!INCLUDE[model4tbl](../../includes/RP/model4tbl.md)]

 <a name="test"></a>
### <a name="test-the-app"></a>Тестирование приложения

Запустите приложение и выберите **учащихся** ссылку. В зависимости от ширины обозревателя **учащихся** ссылка появляется в верхней части страницы. Если **учащихся** ссылка не отображается, щелкните значок навигации в правом верхнем углу.

![Домашняя страница Contoso университета узкий](intro/_static/home-page-narrow.png)

Тест **создать**, **изменить**, и **сведения** ссылки.

## <a name="view-the-db"></a>Представление базы данных

При запуске приложения, `DbInitializer.Initialize` вызовов `EnsureCreated`. `EnsureCreated`Определяет, существует ли базы данных и при необходимости создает один. Если в базе данных нет учащихся `Initialize` метод добавляет учащихся.

Откройте **обозреватель объектов SQL Server** (SSOX) из **представление** меню в Visual Studio.
В SSOX, щелкните **(localdb) \MSSQLLocalDB > базы данных > ContosoUniversity1**.

Разверните **таблиц** узла.

Щелкните правой кнопкой мыши **студента** и нажмите кнопку **данные представления** создания столбцов и строк, вставляемых в таблицу.

*.Mdf* и *.ldf* файлы базы данных находятся в *C:\Users\\ <yourusername>*  папки.

`EnsureCreated`вызывается при запуске приложения, что позволяет следующий рабочий процесс:

* Удаление базы данных.
* Изменения схемы базы данных (например, добавить `EmailAddress` поля).
* Запустите приложение.

`EnsureCreated`Создает базы данных с`EmailAddress` столбца.

## <a name="conventions"></a>Соглашения

Объем кода, написанного в порядке для основных компонентов EF Создание завершения DB сводится к минимуму из-за использования соглашения или предположения, что делает EF Core.

* Имена `DbSet` свойства используются в качестве имен таблиц. Для сущностей, не ссылается `DbSet` свойство класса сущности, имена используются в качестве имен таблиц.

* Имена свойств сущности используются для имен столбцов.

* Свойства сущности, которые называются Идентификатором или classnameID распознаются как свойства основного ключа.

* Свойство интерпретируется как свойство внешнего ключа, если он называется  *<navigation property name> <primary key property name>*  (например, `StudentID` для `Student` свойство навигации с момента `Student` — первичный ключ сущности `ID`). Свойства внешнего ключа, можно назвать  *<primary key property name>*  (например, `EnrollmentID` с момента `Enrollment` первичного ключа сущности является `EnrollmentID`).

Можно переопределить обычным образом. Например имена таблиц можно явно указать, как показано выше в этом учебнике. Можно явно задать имена столбцов. Первичные и внешние ключи могут задаваться явным образом.

## <a name="asynchronous-code"></a>Асинхронный код

Асинхронное программирование является режимом по умолчанию для ASP.NET Core и EF Core.

Ограниченное число потоков, доступных на веб-сервере, и в случае высокой загрузки все доступные потоки быть используется. В этом случае сервер может обработать новые запросы, пока не освободятся потоков. С синхронным кодом большое количество потоков может блокировали они не выполняя фактически действия из-за ожидания завершения ввода-вывода. Асинхронный код когда процесс ожидает ввода-вывода завершить, свой поток освобождается для сервера, используемые для обработки других запросов. В результате асинхронного кода обеспечивает более эффективное использование ресурсов сервера и что сервер включен для обработки большего объема трафика без задержек.

Во время выполнения асинхронного кода вызвать небольшого количества временных затрат. В ситуациях, сниженным трафиком снижение производительности незначительно, при в ситуациях с высоким трафиком, является существенным потенциальное улучшение производительности.

В следующем коде `async` ключевое слово, `Task<T>` возвращаемое значение, `await` ключевое слово, и `ToListAsync` метод делает код более асинхронного выполнения.

[!code-csharp[Main](intro/samples/cu/Pages/Students/Index.cshtml.cs?name=snippet_ScaffoldedIndex)]

* `async` Ключевое слово указывает компилятору:

  * Создает обратные вызовы для части тела метода.
  * Автоматически создавать [задачи](https://docs.microsoft.com/dotnet/api/system.threading.tasks.task?view=netframework-4.7) возвращаемый объект. Дополнительные сведения см. в разделе [тип возвращаемого значения задачи](https://docs.microsoft.com/dotnet/csharp/programming-guide/concepts/async/async-return-types#BKMK_TaskReturnType).

* Тип возвращаемого значения неявный `Task` представляет выполняющуюся работу.

* `await` Ключевое слово указывает компилятору на необходимость разделить на две части метода. Первая часть завершается с операцией, которая запускается в асинхронном режиме. Вторая часть переводится в метод обратного вызова, вызываемый после завершения операции.

* `ToListAsync`асинхронная версия `ToList` метода расширения.

Некоторые аспекты, которые следует учитывать при написании асинхронного кода, использующего EF ядра:

* Только инструкции, вызывающие запросов или команд, отправляемых в базе данных выполняются асинхронно. Содержащий, `ToListAsync`, `SingleOrDefaultAsync`, `FirstOrDefaultAsync`, и `SaveChangesAsync`. Сюда не входят инструкции, которые просто изменить `IQueryable`, такие как `var students = context.Students.Where(s => s.LastName == "Davolio")`.

* EF контекста не является однопоточным безопасный: не пытайтесь выполнить несколько операций параллельно. 

* Чтобы воспользоваться преимуществами повышение производительности для асинхронного кода, убедитесь, что библиотека пакетов (например, для разбиения на страницы) используют async вызывающие EF основные методы, которые отправляют запросы к базе данных.

Дополнительные сведения об асинхронном программировании в .NET см. в разделе [Обзор Async](https://docs.microsoft.com/dotnet/articles/standard/async).

В следующем уроке основные CRUD (Создание, чтение, обновление и удаление) операции проверяются.

>[!div class="step-by-step"]
[Вперед](xref:data/ef-rp/crud)

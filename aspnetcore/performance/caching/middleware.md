---
title: "Кэширование по промежуточного слоя в ASP.NET Core ответов"
author: guardrex
description: "Дополнительные сведения о настройке и использованию по промежуточного слоя, кэширование ответа в ASP.NET Core."
manager: wpickett
ms.author: riande
ms.custom: mvc
ms.date: 01/26/2017
ms.prod: asp.net-core
ms.topic: article
uid: performance/caching/middleware
ms.openlocfilehash: 29ef3cf3d8bcd6b4ebbf08d831dc146e830fa1ac
ms.sourcegitcommit: b83a5f731a9c02bdb1cc1e3f9a8bf273eb5b33e0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/11/2018
---
# <a name="response-caching-middleware-in-aspnet-core"></a>Кэширование по промежуточного слоя в ASP.NET Core ответов

По [Latham Люк](https://github.com/guardrex) и [Джон Luo](https://github.com/JunTaoLuo)

[Просмотреть или скачать образец кода](https://github.com/aspnet/Docs/tree/master/aspnetcore/performance/caching/middleware/sample) ([как скачивать](xref:tutorials/index#how-to-download-a-sample))

В этой статье описывается настройка по промежуточного слоя, кэширование ответа в приложении ASP.NET Core. По промежуточного слоя определяет, когда ответов может быть кэширован, ответы на магазины и служит ответы из кэша. Основные сведения о кэшировании HTTP и `ResponseCache` см. в разделе [кэширование ответов](xref:performance/caching/response).

## <a name="package"></a>Пакет

Чтобы включить по промежуточного слоя в проекте, добавьте ссылку на [ `Microsoft.AspNetCore.ResponseCaching` ](https://www.nuget.org/packages/Microsoft.AspNetCore.ResponseCaching/) пакета или использовать [ `Microsoft.AspNetCore.All` ](https://www.nuget.org/packages/Microsoft.AspNetCore.All/) пакета (ядро ASP.NET 2.0 или более поздней версии, при разработке для .NET Core).

## <a name="configuration"></a>Конфигурация

В `ConfigureServices`, добавление в коллекцию службы по промежуточного слоя.

[!code-csharp[Main](middleware/sample/Startup.cs?name=snippet1&highlight=3)]

Настройка приложения для использования по промежуточного слоя с `UseResponseCaching` метод расширения, который добавляет по промежуточного слоя в конвейер обработки запросов. Добавляет в пример приложения [ `Cache-Control` ](https://tools.ietf.org/html/rfc7234#section-5.2) заголовок в ответ, который кэширует кэшируемых ответов на срок до 10 секунд. Образец отправляет [ `Vary` ](https://tools.ietf.org/html/rfc7231#section-7.1.4) заголовок для настройки по промежуточного слоя для обслуживания только если кэшированный ответ [ `Accept-Encoding` ](https://tools.ietf.org/html/rfc7231#section-5.3.4) заголовок последующих запросов таковыми исходного запроса.

[!code-csharp[Main](middleware/sample/Startup.cs?name=snippet2&highlight=3,7-12)]

По промежуточного слоя, кэширование ответа только кэширует ответы сервера, которые приводят к код состояния 200 (ОК). Все другие ответы, включая [страницы ошибок](xref:fundamentals/error-handling), учитываются по промежуточного слоя.

> [!WARNING]
> Ответы с содержимым для авторизованных клиентов должен быть помечен как не может быть кэширован, чтобы предотвратить по промежуточного слоя в хранении и обслуживании этих ответов. В разделе [условия для кэширования](#conditions-for-caching) сведения о том, как по промежуточного слоя определяет, является ли ответ может быть кэширован.

## <a name="options"></a>Параметры

По промежуточного слоя предоставляет три варианта управлении кэшем ответа.

| Параметр                | Значение по умолчанию |
| --------------------- | ------------- |
| UseCaseSensitivePaths | Определяет, если ответы кэшируются на пути с учетом регистра.</p><p>Значение по умолчанию — `false`. |
| MaximumBodySize       | Максимальный размер кэшируемого текст ответа в байтах.</p>Значение по умолчанию — `64 * 1024 * 1024` (64 МБ). |
| Значение SizeLimit             | Предельный размер для по промежуточного слоя кэша ответа в байтах. Значение по умолчанию — `100 * 1024 * 1024` (100 МБ). |

В следующем примере настраивается по промежуточного слоя для:

* Кэшировать ответы, меньше или равна 1024 байт.
* Сохранить ответы, с учетом регистра пути (например, `/page1` и `/Page1` хранятся отдельно).

```csharp
services.AddResponseCaching(options =>
{
    options.UseCaseSensitivePaths = true;
    options.MaximumBodySize = 1024;
});
```

## <a name="varybyquerykeys"></a>VaryByQueryKeys

При использовании контроллеров MVC или веб-API или модели страниц страниц Razor, `ResponseCache` атрибут задает параметры, необходимые для установки соответствующие заголовки для кэширования ответа. Единственным параметром `ResponseCache` атрибут, строго требует по промежуточного слоя — `VaryByQueryKeys`, которой не соответствует фактическое заголовка HTTP. Дополнительные сведения см. в разделе [ResponseCache атрибут](xref:performance/caching/response#responsecache-attribute).

Если не используется `ResponseCache` атрибут, кэширование ответов можно изменять с `VaryByQueryKeys` компонентов. Используйте `ResponseCachingFeature` непосредственно из `IFeatureCollection` из `HttpContext`:

```csharp
var responseCachingFeature = context.HttpContext.Features.Get<IResponseCachingFeature>();
if (responseCachingFeature != null)
{
    responseCachingFeature.VaryByQueryKeys = new[] { "MyKey" };
}
```

С помощью одно значение, равное `*` в `VaryByQueryKeys` зависит от параметров всех запросов кэша.

## <a name="http-headers-used-by-response-caching-middleware"></a>Заголовки HTTP, используемые по промежуточного слоя кэширования ответа

Кэширование ответов по промежуточного слоя настраивается с помощью заголовков HTTP.

| Header | Подробные сведения |
| ------ | ------- |
| Авторизация | Ответ не кэшируется. Если заголовок существует. |
| Cache-Control | По промежуточного слоя рассматривает только кэширование ответов, отмеченные `public` директива кэша. Управлять кэшированием со следующими параметрами:<ul><li>max-age</li><li>Устаревшая max &#8224;</li><li>Min нуля</li><li>должен revalidate</li><li>Нет-cache</li><li>нет хранилища</li><li>только если кэширования</li><li>private</li><li>public</li><li>s-maxage</li><li>Proxy-revalidate &#8225;</li></ul>&#8224; Если указано без ограничений `max-stale`, по промежуточного слоя не выполняет никаких действий.<br>&#8225; `proxy-revalidate` действует так же, как `must-revalidate`.<br><br>Дополнительные сведения см. в разделе [RFC 7231: запрос директивы управления кэшем](https://tools.ietf.org/html/rfc7234#section-5.2.1). |
| Директивы pragma | Объект `Pragma: no-cache` заголовка в запросе дает тот же эффект, что `Cache-Control: no-cache`. Этот заголовок переопределяется соответствующей директивы в `Cache-Control` заголовка, если он имеется. Для обеспечения обратной совместимости с HTTP/1.0 во внимание. |
| Set-Cookie | Ответ не кэшируется. Если заголовок существует. |
| Различаются | `Vary` Заголовок используется другой заголовок для изменения кэшированного ответа. Например, кэшировать ответы от кодировки, включая `Vary: Accept-Encoding` заголовок, который кэширует ответы для запросов с заголовками `Accept-Encoding: gzip` и `Accept-Encoding: text/plain` отдельно. Значение заголовка ответа `*` никогда не хранится. |
| Срок действия истекает | Как устаревшие средством этот заголовок ответа не хранятся или получить, если не переопределено другим `Cache-Control` заголовки. |
| If-None-Match | Полный ответ подано из кэша, если значение не `*` и `ETag` ответа не соответствует ни одному из предлагаемых значений. В противном случае выдается в отклике 304 (не изменено). |
| If-Modified-Since | Если `If-None-Match` заголовок отсутствует, полный ответ подано из кэша, если дата кэшированного ответа новее, чем указанное значение. В противном случае выдается в отклике 304 (не изменено). |
| Дата | При выполнении из кэша, `Date` задать заголовок по промежуточного слоя, если он не указан исходный ответа. |
| Content-Length | При выполнении из кэша, `Content-Length` задать заголовок по промежуточного слоя, если он не указан исходный ответа. |
| Срок действия | `Age` Заголовок, отправляемый в ответ исходного игнорируется. По промежуточного слоя вычисляет новое значение, при выполнении кэшированного ответа. |

## <a name="caching-respects-request-cache-control-directives"></a>Кэширование соблюдает директивы управления кэшем запроса

По промежуточного слоя соблюдает правилами [кэширования HTTP 1.1 спецификации](https://tools.ietf.org/html/rfc7234#section-5.2). Правила требуют кэша соблюдать является допустимым для `Cache-Control` заголовок, отправленных клиентом. В спецификации, клиент может выполнять запросы с `no-cache` значение заголовка и force которого сервер создает новый ответ для каждого запроса. В настоящее время нет не контроль разработчика над этот режим кэширования при использовании по промежуточного слоя, так как по промежуточного слоя соответствует спецификации официальный кэширования.

Для усиления контроля над поведение кэширования изучение других функций кэширования ASP.NET Core. См. указанные ниже разделы.

* [Кэширование в памяти](xref:performance/caching/memory)
* [Работа с распределенным кэшем](xref:performance/caching/distributed)
* [Кэшировать вспомогательный тег в ядре ASP.NET MVC](xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper)
* [Вспомогательная функция тега распределенного кэша](xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper)

## <a name="troubleshooting"></a>Устранение неполадок

Если режим кэширования не должным образом, подтвердите, что ответы кэшируемый и может обслуживать из кэша. Проверьте запрос заголовков входящих и исходящих заголовки ответа. Включить [ведение журнала](xref:fundamentals/logging/index) в процессе отладки.

При тестирование и устранение неполадок поведение кэширования, браузер может задать заголовки запроса, влияющих на кэширование нежелательно способами. Например, браузер может задать `Cache-Control` заголовок `no-cache` или `max-age=0` при обновлении страницы. Следующие средства можно явно задать заголовки запроса и являются предпочтительными для тестирования кэширования:

* [Fiddler](https://www.telerik.com/fiddler)
* [Postman](https://www.getpostman.com/)

### <a name="conditions-for-caching"></a>Условия для кэширования

* Запрос необходимо привести в ответе сервера с кодом состояния 200 (ОК).
* Метод запроса должно быть GET или HEAD.
* Терминалов по промежуточного слоя, таких как [по промежуточного слоя статических файлов](xref:fundamentals/static-files), не должен обработать ответ перед по промежуточного слоя кэширования ответа.
* `Authorization` Заголовок не должен присутствовать.
* `Cache-Control`Параметры заголовка должен быть допустимым, а ответ должен быть помечен `public` и не помечен `private`.
* `Pragma: no-cache` Заголовок не должно быть Если `Cache-Control` заголовок отсутствует, как `Cache-Control` переопределяет заголовок `Pragma` заголовка, если они есть.
* `Set-Cookie` Заголовок не должен присутствовать.
* `Vary`Параметры заголовка должно быть допустимым и не равно `*`.
* `Content-Length` Значение заголовка (если задать) должно соответствовать размеру текста ответа.
* [IHttpSendFileFeature](/aspnet/core/api/microsoft.aspnetcore.http.features.ihttpsendfilefeature) не используется.
* Ответ не должно быть устаревшей в соответствии с `Expires` заголовок и `max-age` и `s-maxage` кэшировать директивы.
* Буферизация требуется успешное выполнение, и размер ответа должно быть меньше, чем настроенное или по умолчанию `SizeLimit`.
* Требуется ответ может быть кэширован в соответствии с [RFC 7234](https://tools.ietf.org/html/rfc7234) спецификации. Например `no-store` директива не должен существовать в поля заголовка запроса или ответа. В разделе *раздел 3: хранение ответы в кэше* из [RFC 7234](https://tools.ietf.org/html/rfc7234) подробные сведения.

> [!NOTE]
> Сложные системы, для создания токенов безопасности для предотвращения подделки межсайтовых запросов (CSRF) атак наборы `Cache-Control` и `Pragma` заголовки `no-cache` , чтобы ответы не кэшируются.

## <a name="additional-resources"></a>Дополнительные ресурсы

* [Запуск приложения](xref:fundamentals/startup)
* [ПО промежуточного слоя](xref:fundamentals/middleware/index)
* [Кэширование в памяти](xref:performance/caching/memory)
* [Работа с распределенным кэшем](xref:performance/caching/distributed)
* [Обнаружение изменений с помощью маркеров изменений](xref:fundamentals/primitives/change-tokens)
* [Кэширование ответов](xref:performance/caching/response)
* [Вспомогательная функция тега кэша](xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper)
* [Вспомогательная функция тега распределенного кэша](xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper)

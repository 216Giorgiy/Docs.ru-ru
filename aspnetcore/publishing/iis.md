---
title: "Размещение ASP.NET Core в Windows со службами IIS"
author: guardrex
description: "Настройка служб IIS в Windows Server и развертывание приложений ASP.NET Core."
keywords: "ASP.NET Core, службы iis, iis, windows server, пакет размещения, модуль asp.net core, веб-развертывание"
ms.author: riande
manager: wpickett
ms.date: 03/13/2017
ms.topic: article
ms.assetid: a4449ad3-5bad-410c-afa7-dc32d832b552
ms.technology: aspnet
ms.prod: asp.net-core
uid: publishing/iis
ms.openlocfilehash: 75fc1edec9050a4690a39d37307f2f95f5d534a5
ms.sourcegitcommit: 6e83c55eb0450a3073ef2b95fa5f5bcb20dbbf89
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/28/2017
---
# <a name="host-aspnet-core-on-windows-with-iis"></a>Размещение ASP.NET Core в Windows со службами IIS

Авторы: [Люк Лэтэм](https://github.com/guardrex) (Luke Latham) и [Рик Андерсон](https://twitter.com/RickAndMSFT) (Rick Anderson)

## <a name="supported-operating-systems"></a>Поддерживаемые операционные системы

Поддерживаются следующие операционные системы:

* Windows 7 и более поздних версий;
* Windows Server 2008 R2 и более поздних версий.

&#8224;В принципе, конфигурация IIS, описываемая в этом документе, также применима при размещении приложений ASP.NET Core в службах IIS Nano Server, однако более точные инструкции см. в статье [ASP.NET Core со службами IIS в Nano Server](xref:tutorials/nano-server).

[Сервер HTTP.sys](xref:fundamentals/servers/httpsys) (который ранее назывался [WebListener](xref:fundamentals/servers/weblistener)) не будет работать в конфигурации обратного прокси-сервера со службами IIS. Необходимо использовать [сервер Kestrel](xref:fundamentals/servers/kestrel).

## <a name="iis-configuration"></a>Конфигурация IIS

Включите роль **Веб-сервер (IIS)** и создайте службы роли.

### <a name="windows-desktop-operating-systems"></a>Операционные системы Windows для настольных компьютеров

Последовательно выберите **Панель управления** > **Программы** > **Программы и компоненты** > **Включение или отключение компонентов Windows** (в левой части экрана). Откройте группу **Службы IIS**, а затем — **Средства управления веб-сайтом**. Установите флажок **Консоль управления IIS**. Установите флажок **Службы Интернета**. В группе **Службы Интернета** оставьте компоненты по умолчанию или настройте компоненты IIS согласно потребностям.

![Группы "Консоль управления IIS" и "Службы Интернета" выбраны в окне "Компоненты Windows".](iis/_static/windows-features-win10.png)

### <a name="windows-server-operating-systems"></a>Операционные системы семейства Windows Server

В серверной операционной системе используйте мастер **добавления ролей и компонентов**, который можно вызвать в меню **Управление** или по ссылке в **диспетчере сервера**. На этапе **Роли сервера** установите флажок **Веб-сервер (IIS)**.

![Роль "Веб-сервер (IIS)" выбрана на странице "Выбор ролей сервера".](iis/_static/server-roles-ws2016.png)

На этапе **Службы роли** выберите нужные службы роли IIS или оставьте службы по умолчанию.

![Службы роли по умолчанию, выбранные на странице "Выбор служб ролей".](iis/_static/role-services-ws2016.png)

Пройдите этап **Подтверждение**, чтобы установить роль и службы веб-сервера. После установки роли "Веб-сервер (IIS)" перезагружать сервер или службы IIS не требуется.

## <a name="install-the-net-core-windows-server-hosting-bundle"></a>Установка пакета размещения .NET Core для Windows Server

1. Установите [пакет размещения .NET Core для Windows Server](https://aka.ms/dotnetcore.2.0.0-windowshosting) в размещающей системе. В составе пакета устанавливаются среда выполнения .NET Core, библиотека .NET Core и [модуль ASP.NET Core](xref:fundamentals/servers/aspnet-core-module). Модуль создает обратный прокси-сервер между службами IIS и сервером Kestrel. Если система не подключена к Интернету, перед установкой пакета размещения .NET Core для Windows Server получите и установите [Распространяемый компонент Microsoft Visual C++ 2015](https://www.microsoft.com/download/details.aspx?id=53840).

2. Перезапустите систему или выполните в командной строке команду **net stop was /y**, а затем команду **net start w3svc**, чтобы изменение системной переменной PATH вступило в силу.

> [!NOTE]
> Если вы используете общую конфигурацию IIS, см. раздел [Модуль ASP.NET Core с общей конфигурацией IIS](xref:hosting/aspnet-core-module#aspnet-core-module-with-an-iis-shared-configuration).

## <a name="install-web-deploy-when-publishing-with-visual-studio"></a>Установка веб-развертывания при публикации с помощью Visual Studio

Если вы планируете развертывать приложения с помощью [веб-развертывания](/iis/publish/using-web-deploy/introduction-to-web-deploy) в [Visual Studio](https://www.visualstudio.com/vs/), установите последнюю версию веб-развертывания в размещающей системе. Чтобы установить веб-развертывание, можно использовать [установщик веб-платформы (WebPI)](https://www.microsoft.com/web/downloads/platform.aspx) или получить установщик непосредственно в [Центре загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=43717). Предпочтительный метод — использовать WebPI. WebPI обеспечивает автономную установку и настройку поставщиков размещения.

## <a name="application-configuration"></a>Настройка приложения

### <a name="enabling-the-iisintegration-components"></a>Включение компонентов IISIntegration

# <a name="aspnet-core-2xtabaspnetcore2x"></a>[ASP.NET Core 2.x](#tab/aspnetcore2x)

Обычно *Program.cs* вызывает [CreateDefaultBuilder](/dotnet/api/microsoft.aspnetcore.webhost.createdefaultbuilder), чтобы начать настройку узла. `CreateDefaultBuilder` настраивает [Kestrel](xref:fundamentals/servers/kestrel) в качестве веб-сервера и активирует интеграцию IIS, задавая базовый путь и порт для [модуля ASP.NET Core](xref:fundamentals/servers/aspnet-core-module):

```csharp
public static IWebHost BuildWebHost(string[] args) =>
    WebHost.CreateDefaultBuilder(args)
        ...
```

# <a name="aspnet-core-1xtabaspnetcore1x"></a>[ASP.NET Core 1.x](#tab/aspnetcore1x)

Включите в зависимости приложения зависимость от пакета [Microsoft.AspNetCore.Server.IISIntegration](https://www.nuget.org/packages/Microsoft.AspNetCore.Server.IISIntegration/). Включите в приложение ПО промежуточного слоя для интеграции IIS, добавив метод расширения *UseIISIntegration* в *WebHostBuilder*.

```csharp
var host = new WebHostBuilder()
    .UseKestrel()
    .UseIISIntegration()
    ...
```

`UseKestrel` и `UseIISIntegration` являются обязательными элементами. Код, вызывающий *UseIISIntegration*, не влияет на переносимость кода. Если приложение запускается не в IIS (например, запускается непосредственно в Kestrel), то в `UseIISIntegration` нет операций.

---

Дополнительные сведения о размещении см. в разделе [Размещение в ASP.NET Core](xref:fundamentals/hosting).

### <a name="iis-options"></a>Параметры служб IIS

Чтобы настроить параметры службы *IISIntegration*, включите конфигурацию службы для *IISOptions* в *ConfigureServices*:

```csharp
services.Configure<IISOptions>(options => 
{
    ...
});
```

| Параметр                         | По умолчанию | Параметр |
| ------------------------------ | ------- | ------- |
| `AutomaticAuthentication`      | `true`  | Если значение — `true`, ПО промежуточного слоя для проверки подлинности задаст значение `HttpContext.User` и будет отвечать на общие запросы. Если значение — `false`, ПО промежуточного слоя для проверки подлинности только предоставит идентификатор (`HttpContext.User`) и будет отвечать только на явные запросы от `AuthenticationScheme`. Для работы `AutomaticAuthentication` необходимо включить в службах IIS проверку подлинности Windows. |
| `AuthenticationDisplayName`    | `null`  | Задает отображаемое имя для пользователей на страницах входа. |
| `ForwardClientCertificate`     | `true`  | Если значение — `true` и если присутствует заголовок запроса `MS-ASPNETCORE-CLIENTCERT`, происходит заполнение `HttpContext.Connection.ClientCertificate`. |

### <a name="webconfig"></a>web.config.

Файл *web.config* служит для настройки модуля ASP.NET Core и предоставляет другие параметры конфигурации IIS. Создание, преобразование и публикация файла *web.config* осуществляются с помощью пакета `Microsoft.NET.Sdk.Web`, который включается при указании SDK проекта в начале файла проекта *CSPROJ*: `<Project Sdk="Microsoft.NET.Sdk.Web">`. Чтобы целевой объект MSBuild не преобразовывал файл *web.config*, добавьте в файл проекта свойство **\<IsTransformWebConfigDisabled>** со значением `true`.

```xml
<PropertyGroup>
  <IsTransformWebConfigDisabled>true</IsTransformWebConfigDisabled>
</PropertyGroup>
```

Если при публикации с помощью команды *dotnet publish* или функции публикации в Visual Studio в проекте нет файла *web.config*, он создается автоматически в [публикуемых выходных данных](xref:hosting/directory-structure). Если в проекте есть файл *web.config*, он преобразуется с использованием соответствующих аргументов *processPath* и *arguments* для настройки [модуля ASP.NET Core](xref:fundamentals/servers/aspnet-core-module) и переносится в опубликованные выходные данные. Преобразование не затрагивает параметры конфигурации IIS, включенные в файл.

## <a name="create-the-iis-website"></a>Создание веб-сайта IIS

1. В целевой системе IIS создайте папку для опубликованных папок и файлов приложения, которые описываются в статье [Структура каталогов](xref:hosting/directory-structure).

2. В созданной папке создайте папку *logs* для журналов StdOut (если вы планируете включить ведение журналов для устранения неполадок при запуске). Если вы планируете развернуть приложение с папкой *logs* в полезных данных, этот шаг можно пропустить. Существует [нерешенная проблема с автоматическим созданием папки](https://github.com/aspnet/AspNetCoreModule/issues/30). Если вы хотите, чтобы система MSBuild самостоятельно создала папку *log*, добавьте в файл проекта следующий объект `Target`.

   ```xml
   <Target Name="CreateLogsFolder" AfterTargets="AfterPublish">
     <MakeDir Directories="$(PublishDir)logs" Condition="!Exists('$(PublishDir)logs')" />
     <MakeDir Directories="$(PublishUrl)logs" Condition="!Exists('$(PublishUrl)logs')" />
   </Target>
   ```

3. В **диспетчере IIS** создайте веб-сайт. Укажите **Имя сайта** и задайте **Физический путь** к созданной папке развертывания приложения. Укажите конфигурацию **привязки** и создайте веб-сайт.

4. Для пула приложений выберите **Без управляемого кода**. ASP.NET Core выполняется в отдельном процессе и управляет средой выполнения.

5. Откройте окно **Добавить веб-сайт**.

   ![В контекстном меню узла "Сайты" выберите пункт "Добавить веб-сайт".](iis/_static/add-website-context-menu-ws2016.png)

6. Настройте веб-сайт.

   ![В окне "Добавить веб-сайт" укажите имя сайта, физический путь и имя узла.](iis/_static/add-website-ws2016.png)

7. На панели **Пулы приложений** откройте окно **Изменение пула приложений**, щелкнув пул приложений веб-сайта правой кнопкой мыши и выбрав в контекстном меню пункт **Основные параметры...**

   ![В контекстном меню пула приложений выберите пункт "Основные настройки".](iis/_static/apppools-basic-settings-ws2016.png)

8. Для параметра **Версия среды CLR .NET** выберите значение **Без управляемого кода**.

   ![Выберите "Без управляемого кода" для параметра "Версия среды CLR .NET".](iis/_static/edit-apppool-ws2016.png)
     
    Примечание. Задавать для параметра **Версия среды CLR .NET** значение **Без управляемого кода** необязательно. Для ASP.NET Core не требуется загрузка классической среды CLR.

9. Убедитесь в том, что удостоверение модели процесса имеет соответствующие разрешения.

   Если вы изменяете удостоверение по умолчанию для пула приложений (**Модель процесса** > **Удостоверение**) с **ApplicationPoolIdentity** на другое, убедитесь, что у нового удостоверения есть соответствующие разрешения для доступа к папке приложения, базе данных и другим необходимым ресурсам.
   
## <a name="deploy-the-application"></a>Развертывание приложения
Разверните приложение в папке, созданной в целевой системе IIS. Рекомендуемый механизм развертывания — [веб-развертывание](/iis/publish/using-web-deploy/introduction-to-web-deploy). Альтернативы ему описываются ниже.

Убедитесь в том, что приложение, публикуемое для развертывания, не запущено. Во время выполнения приложения файлы в папке *publish* блокируются. Заблокированные файлы нельзя скопировать, так что развертывание в этом случае не произойдет.

### <a name="web-deploy-with-visual-studio"></a>Веб-развертывание с помощью Visual Studio
Сведения о создании профиля публикации для веб-развертывания см. в статье [Создание профилей публикации для Visual Studio и MSBuild с целью развертывания приложений ASP.NET Core](xref:publishing/web-publishing-vs#publish-profiles). Если ваш поставщик услуг размещения предоставляет профиль публикации или поддерживает его создание, скачайте этот профиль и импортируйте его с помощью диалогового окна **Публикация** в Visual Studio.

![Диалоговое окно "Публикация"](iis/_static/pub-dialog.png)

### <a name="web-deploy-outside-of-visual-studio"></a>Веб-развертывание вне Visual Studio
[Веб-развертывание](/iis/publish/using-web-deploy/introduction-to-web-deploy) можно также использовать вне Visual Studio с помощью командной строки. Дополнительные сведения см. в статье [Средство веб-развертывания](/iis/publish/using-web-deploy/use-the-web-deployment-tool).

### <a name="alternatives-to-web-deploy"></a>Альтернативы веб-развертыванию
Если вы не хотите применять веб-развертывание или не используете Visual Studio, вы можете прибегнуть к одному из методов переноса приложения в систему размещения, например Xcopy, Robocopy или PowerShell. Пользователи Visual Studio могут применять [образцы публикации](https://github.com/aspnet/vsweb-publish/blob/master/samples/samples.md).

## <a name="browse-the-website"></a>Обзор веб-сайта
![Начальная страница IIS, загруженная в браузере Microsoft Edge.](iis/_static/browsewebsite.png)
   
> [!WARNING]
> Приложения .NET Core размещаются посредством обратного прокси-сервера между службами IIS и сервером Kestrel. Для создания обратного прокси-сервера файл *web.config* должен находиться по корневому пути к содержимому развернутого приложения (как правило, это основной путь приложения). Это физический путь к веб-сайту, указанный в службах IIS. По физическому пути приложения находятся важные файлы, включая такие вложенные папки, как *мое_приложение.runtimeconfig.json*, *мое_приложение.xml* (комментарии к документам XML) и *мое_приложение.deps.json*. Файл *web.config* необходим для создания обратного прокси-сервера для Kestrel, который запрещает службам IIS предоставлять эти и другие важные файлы. **Поэтому важно следить за тем, чтобы файл *web.config* не был случайно переименован или удален из развертывания**.

## <a name="data-protection"></a>Защита данных

Приложение ASP.NET Core хранит набор ключей в памяти при выполнении указанных ниже условий.

* Веб-сайт размещается за службами IIS.
* В стеке защиты данных не настроено хранение набора ключей в постоянном хранилище.

Если набор ключей хранится в памяти, то при перезапуске приложения происходит следующее.

* Все токены проверки подлинности на основе форм становятся недействительными. 
* При выполнении следующего запроса пользователю требуется выполнить вход снова. 
* Все данные, защищенные с помощью набора ключей, становятся незащищенными.

> [!WARNING]
> Защита данных используется некоторым программным обеспечением промежуточного слоя ASP.NET, в том числе применяемым для проверки подлинности. Даже если вы не вызываете интерфейсы API защиты данных из своего кода, следует настроить защиту данных с помощью скрипта развертывания или в собственном коде. Если вы не настраиваете защиту данных, ключи по умолчанию хранятся в памяти и удаляются при перезапуске приложения. При перезапуске все файлы cookie, записанные ПО промежуточного слоя для проверки подлинности, становятся недействительными, а пользователям требуется выполнить вход повторно.

Чтобы настроить защиту данных в службах IIS, следует использовать один из описанных ниже подходов.

* Запустите [скрипт PowerShell](https://github.com/aspnet/DataProtection/blob/dev/Provision-AutoGenKeys.ps1), чтобы создать соответствующие записи в реестре (например, `.\Provision-AutoGenKeys.ps1 DefaultAppPool`). В результате ключи сохраняются в реестре и защищаются посредством API защиты данных с использованием ключа на уровне компьютера.
* Настройте пул приложений IIS для загрузки профиля пользователя. Этот параметр находится на странице **Дополнительные параметры** пула приложений в разделе **Модель процесса**. Задайте для параметра **Загрузить профиль пользователя** значение `True`. В результате ключи сохраняются в каталоге профиля пользователя и защищаются посредством API защиты данных с использованием ключа на уровне учетной записи пользователя, применяемой для пула приложений.
* Измените код приложения так, чтобы [в качестве хранилища набора ключей использовалась файловая система](xref:security/data-protection/configuration/overview). Используйте сертификат X509 для защиты набора ключей, причем это должен быть доверенный сертификат. Если сертификат является самозаверяющим, его следует поместить в доверенное корневое хранилище.

При использовании служб IIS в веб-ферме:

* используйте общую папку, которая доступна всем компьютерам;
* разверните сертификат X509 на каждом компьютере; настройте [защиту данных в коде](https://docs.microsoft.com/aspnet/core/security/data-protection/configuration/overview).

### <a name="1-create-a-data-protection-registry-hive"></a>1. Создание куста реестра для защиты данных

Ключи защиты данных, используемые приложениями ASP.NET, хранятся в кустах реестра, являющихся внешними для приложений. Чтобы сохранять эти ключи для определенного приложения, нужно создать куст реестра для пула приложений, к которому относится данное приложение.

При автономной установке служб IIS следует выполнить [скрипт PowerShell Provision-AutoGenKeys.ps1 для защиты данных](https://github.com/aspnet/DataProtection/blob/dev/Provision-AutoGenKeys.ps1) применительно к каждому пулу приложений, в который входит приложение ASP.NET Core. Этот скрипт создает специальный раздел в реестре HKLM, который будет доступен только учетной записи рабочего процесса. Неактивные ключи шифруются с помощью API защиты данных.

В веб-ферме приложение можно настроить так, чтобы для хранения набора ключей защиты данных использовался UNC-путь. По умолчанию ключи защиты данных не шифруются. Разрешения на доступ к файлам в общей папке должны быть предоставлены только учетной записи Windows, от имени которой выполняется приложение. Помимо этого, для защиты неактивных ключей можно использовать сертификат X509. При этом может потребоваться реализовать механизм, позволяющий пользователям отправлять сертификаты: поместить сертификаты в хранилище доверенных сертификатов пользователя и обеспечивать их доступность на всех компьютерах, где выполняется приложение. Подробные сведения см. в разделе [Настройка защиты данных](xref:security/data-protection/configuration/overview#data-protection-configuring).

### <a name="2-configure-the-iis-application-pool-to-load-the-user-profile"></a>2. Настройка пула приложений IIS для загрузки профиля пользователя

Этот параметр находится на странице **Дополнительные параметры** пула приложений в разделе **Модель процесса**. Задайте для параметра "Загрузить профиль пользователя" значение `True`. В результате ключи сохраняются в каталоге профиля пользователя и защищаются посредством API защиты данных с использованием ключа на уровне учетной записи пользователя, применяемой для пула приложений.

### <a name="3-machine-wide-policy-for-data-protection"></a>3. Политика защиты данных на уровне компьютера

Система защиты данных обеспечивает ограниченную поддержку задания [политики по умолчанию на уровне компьютера](xref:security/data-protection/configuration/machine-wide-policy#data-protection-configuration-machinewidepolicy) для всех приложений, использующих интерфейсы API защиты данных. Дополнительные сведения см. в документации по [защите данных](xref:security/data-protection/index).

## <a name="configuration-of-sub-applications"></a>Настройка дочерних приложений

Дочерние приложения, добавленные в корневое приложение, не должны включать в себя модуль ASP.NET Core в качестве обработчика. Если вы добавите модуль в качестве обработчика в файл *web.config* дочернего приложения, то при попытке работы с этим приложением получите ошибку 500.19 (внутренняя ошибка сервера) с указанием некорректного файла конфигурации. В приведенном ниже примере показано содержимое опубликованного файла *web.config* для дочернего приложения ASP.NET Core.

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <aspNetCore processPath="dotnet" 
      arguments=".\MyApp.dll" 
      stdoutLogEnabled="false" 
      stdoutLogFile=".\logs\stdout" />
  </system.webServer>
</configuration>
```

Если вы планируете размещать дочернее приложение не на основе ASP.NET Core в приложении ASP.NET Core, нужно явным образом удалить унаследованный обработчик из файла *web.config* дочернего приложения.

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <handlers>
      <remove name="aspNetCore"/>
    </handlers>
    <aspNetCore processPath="dotnet" 
      arguments=".\MyApp.dll" 
      stdoutLogEnabled="false" 
      stdoutLogFile=".\logs\stdout" />
  </system.webServer>
</configuration>
```

Дополнительные сведения о настройке модуля ASP.NET Core с помощью файла *web.config* см. в статье [Введение в модуль ASP.NET Core Module](xref:fundamentals/servers/aspnet-core-module) и в [справочнике по настройке модуля ASP.NET Core](xref:hosting/aspnet-core-module).

## <a name="configuration-of-iis-with-webconfig"></a>Настройка служб IIS с помощью файла web.config

Раздел `<system.webServer>` файла *web.config* по-прежнему действует для тех компонентов IIS, которые относятся к конфигурации прокси-сервера. Например, на уровне системы в службах IIS может быть настроено динамическое сжатие, однако для приложения этот параметр можно отключить с помощью элемента `<urlCompression>` в файле *web.config* приложения. Дополнительные сведения см. в [справочнике по настройке `<system.webServer>`](https://docs.microsoft.com/iis/configuration/system.webServer/), [справочнике по настройке модуля ASP.NET Core](xref:hosting/aspnet-core-module) и статье [Использование модулей IIS с ASP.NET Core](xref:hosting/iis-modules). Если нужно задать переменные среды для отдельных приложений, выполняющихся в изолированных пулах приложений (такая возможность поддерживается в службах IIS 10.0 и более поздних версий), см. подраздел, посвященный *команде AppCmd.exe*, в разделе [Переменные среды \<environmentVariables>](/iis/configuration/system.applicationHost/applicationPools/add/environmentVariables/#appcmdexe) справочной документации по службам IIS.

## <a name="configuration-sections-of-webconfig"></a>Разделы конфигурации файла web.config

В отличие от приложений .NET Framework, которые настраиваются с помощью элементов `<system.web>`, `<appSettings>`, `<connectionStrings>` и `<location>` в файле *web.config*, приложения ASP.NET Core настраиваются с помощью других поставщиков конфигурации. Дополнительные сведения см. в разделе [Конфигурация](xref:fundamentals/configuration).

## <a name="application-pools"></a>Пулы приложений

Если в одной системе размещается несколько веб-сайтов, приложения следует изолировать друг от друга, запуская каждое из них в отдельном пуле приложений. В диалоговом окне **Добавить веб-сайт** служб IIS такое поведение задано по умолчанию. Если вы указываете **имя сайта**, оно автоматически переносится в текстовое поле **Пул приложений**. При добавлении веб-сайта создается пул приложений с именем сайта.

## <a name="application-pool-identity"></a>Удостоверение пула приложений

Учетная запись удостоверения пула приложений позволяет запускать приложение от имени уникальной учетной записи, не создавая домены или локальные учетные записи и не управляя ими. В службах IIS 8.0 и более поздних версий рабочий процесс администратора IIS (WAS) создает виртуальную учетную запись с именем нового пула приложений и по умолчанию выполняет рабочие процессы пула приложений с этой учетной записью. В консоли управления IIS в окне **Дополнительные параметры** для пула приложений должно быть выбрано **Удостоверение** **ApplicationPoolIdentity**, как показано на рисунке ниже.

![Диалоговое окно дополнительных параметров для пула приложений](iis/_static/apppool-identity.png)

Процесс управления IIS создает в системе безопасности Windows безопасный идентификатор с именем пула приложений. С помощью этого удостоверения можно защищать ресурсы, но оно не представляет реальную учетную запись пользователя и не отображается в консоли управления Windows пользователя.

Если рабочему процессу IIS требуется предоставить доступ к приложению с повышенными правами, нужно изменить список управления доступом (ACL) для каталога, содержащего приложение.

1. Откройте проводник и перейдите к каталогу.

2. Щелкните каталог правой кнопкой мыши и выберите пункт **Свойства**.

3. На вкладке **Безопасность** нажмите кнопку **Изменить**, а затем кнопку **Добавить**.

4. Нажмите кнопку **Размещение** и выберите свою систему.

5. В текстовом поле **Введите имена выбираемых объектов** введите **IIS AppPool\DefaultAppPool**.

  ![Диалоговое окно "Введите имена выбираемых объектов" для папки приложения](iis/_static/select-users-or-groups-1.png)

6. Нажмите кнопку **Проверить имена**, а затем — кнопку **ОК**.

  ![Диалоговое окно "Введите имена выбираемых объектов" для папки приложения](iis/_static/select-users-or-groups-2.png)

Это также можно сделать в командной строке с помощью программы **ICACLS**:

```console
ICACLS C:\sites\MyWebApp /grant "IIS AppPool\DefaultAppPool":F
```

## <a name="troubleshooting-tips"></a>Советы по устранению неполадок

Процедура диагностики проблем для развертываний IIS

* Изучите выходные данные браузера.
* Просмотрите системный **приложения** с помощью средства **Просмотр событий**.
* Включите ведение журнала `stdout`. Журнал **модуля ASP.NET Core** находится по пути, указанном в атрибуте *stdoutLogFile* элемента `<aspNetCore>` в файле *web.config*. Все папки по пути, указанному в значении этого атрибута, должны существовать в развертывании. Кроме того, необходимо задать *stdoutLogEnabled="true"*. Во всех приложениях, использующих пакет SDK `Microsoft.NET.Sdk.Web` для создания файла *web.config*, параметр *stdoutLogEnabled* по умолчанию имеет значение *false*, поэтому файл *web.config* нужно предоставить вручную или изменить его, включив ведение журналов `stdout`.

Некоторые распространенные ошибки не приводятся в браузере, журнале приложений и журнале модуля ASP.NET Core, пока не будут достигнуты значения *startupTimeLimit* (по умолчанию 120 секунд) и *startupRetryCount* (по умолчанию 2). Поэтому прежде чем делать вывод о том, что модулю не удалось запустить процесс приложения, подождите шесть минут.

Один из простых способов определить, правильно ли работает приложение, — запустить его непосредственно в Kestrel. Если приложение было опубликовано как зависящее от платформы развертывание (FDD), выполните команду `dotnet my_application.dll` в папке развертывания, которая представляет собой физический путь к приложению в IIS. Если приложение было опубликовано как автономное развертывание (SCD), запустите его исполняемый файл (`my_application.exe`) в папке развертывания непосредственно из командной строки. Если Kestrel прослушивает порт по умолчанию с номером 5000, приложение должно быть доступно по адресу `http://localhost:5000/`. Если приложение отвечает на запросы по адресу конечной точки Kestrel, проблема, вероятнее всего, связана с конфигурацией служб IIS, модуля ASP.NET Core и Kestrel, а не с самим приложением.

Один из способов определить, правильно ли работает обратный прокси-сервер между службами IIS и сервером Kestrel, — выполнить простой запрос статического файла, которым может быть таблица стилей, скрипт или изображение из каталога *wwwroot*, с помощью [ПО промежуточного слоя для статических файлов](xref:fundamentals/static-files). Если приложение может предоставлять статические файлы, но представления MVC и другие конечные точки не работают, проблема, скорее всего, связана с самим приложением (например, маршрутизацией MVC или внутренней ошибкой сервера 500), а не с конфигурацией служб IIS, модуля ASP.NET Core и Kestrel.

Если Kestrel нормально работает за службами IIS, но приложение не запускается в системе, хотя успешно выполняется локально, вы можете временно добавить в файл *web.config* переменную среды `ASPNETCORE_ENVIRONMENT` со значением `Development`. Пока среда не переопределена в параметрах запуска приложения, при выполнении приложения в системе выводится [страница исключения для разработчика](xref:fundamentals/error-handling). Задавать таким образом переменную среды `ASPNETCORE_ENVIRONMENT` рекомендуется только в промежуточных и тестовых системах, доступ к которым из Интернета закрыт. По завершении обязательно удалите эту переменную среды из файла *web.config*. Сведения о задании переменных среды для обратного прокси-сервера с помощью файла *web.config* см. в разделе, посвященном [дочернему элементу environmentVariables aspNetCore](xref:hosting/aspnet-core-module#setting-environment-variables).

В большинстве случаев включение журнала приложений помогает находить и устранять проблемы, связанные с приложением или обратным прокси-сервером. Дополнительные сведения см. в статье, посвященной [ведению журналов](xref:fundamentals/logging).

Последняя рекомендация по устранению неполадок касается приложений, которые не запускаются после обновления пакета SDK для .NET Core на компьютере разработки или версий пакета в приложении. В некоторых случаях в результате важного обновления несогласованные версии пакетов могут привести к нарушению работы приложения. Большинство таких неполадок можно устранить, удалив папки `bin` и `obj` из проекта, очистив кэши пакетов в каталогах `%UserProfile%\.nuget\packages\` и `%LocalAppData%\Nuget\v3-cache`, восстановив проект и полностью удалив предыдущее развертывание в системе перед повторным развертыванием приложения.

> [!TIP]
> Чтобы упростить очистку кэшей пакетов, можно получить средство *NuGet.exe* с сайта [NuGet.org](https://www.nuget.org/), добавить его в каталог PATH системы и выполнить в командной строке команду `nuget locals all -clear`. Также можно выполнить команду `dotnet nuget locals all --clear` из командной строки без получения *NuGet.exe*.

## <a name="common-errors"></a>Распространенные ошибки

Приведенный ниже перечень ошибок не является исчерпывающим. Если у вас возникла другая ошибка, приведите сообщение о ней в разделе комментариев ниже.

### <a name="installer-unable-to-obtain-vc-redistributable"></a>Установщику не удается получить распространяемый компонент VC++

* **Исключение установщика:** 0x80072efd or 0x80072f76 — неопределенная ошибка

* **Исключение журнала установщика&#8224;:** ошибка 0x80072efd или 0x80072f76: не удалось выполнить пакет EXE

  &#8224;Журнал находится в папке C:\Users\\{ПОЛЬЗОВАТЕЛЬ}\AppData\Local\Temp\dd_DotNetCoreWinSvrHosting__{метка_времени}.log.

Устранение неполадок:

* Если при установке пакета размещения сервера у системы нет доступа к Интернету, это исключение возникает, когда у установщика нет возможности получить *Распространяемый компонент Microsoft Visual C++ 2015*. Получить установщик можно в [Центре загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=53840). Если работа установщика завершается сбоем, возможно, вы не сможете получить среду выполнения .NET Core, необходимую для размещения зависимых от платформы развертываний (FDD). Если вы планируете размещать зависимые от платформы развертывания, убедитесь в том, что среда выполнения установлена, в окне "Программы и компоненты". Получить установщик среды выполнения можно на [странице загрузки .NET](https://www.microsoft.com/net/download/core). После установки среды выполнения перезагрузите систему или перезапустите службы IIS, выполнив в командной строке команду **net stop was /y**, а затем — команду **net start w3svc**.

### <a name="os-upgrade-removed-the-32-bit-aspnet-core-module"></a>При обновлении ОС был удален 32-разрядный модуль ASP.NET Core

* **Журнал приложений:** не удалось загрузить модуль DLL **C:\WINDOWS\system32\inetsrv\aspnetcore.dll**. Ошибочные данные.

Устранение неполадок:

* Не относящиеся к ОС файлы в каталоге **C:\Windows\SysWOW64\inetsrv** не сохраняются при обновлении ОС. Если вы установили модуль ASP.NET Core до обновления ОС, а после обновления пытаетесь запустить любой пул приложений в 32-разрядном режиме, возникает эта ошибка. После обновления ОС восстановите модуль ASP.NET Core. См. раздел [Установка пакета размещения .NET Core для Windows Server](#install-the-net-core-windows-server-hosting-bundle). При запуске установщика выберите вариант **Восстановить**.

### <a name="platform-conflicts-with-rid"></a>Конфликты платформы с относительным идентификатором

* **Браузер:** ошибка HTTP 502.5 — сбой процесса

* **Журнал приложений:** приложению MACHINE/WEBROOT/APPHOST/MY_APPLICATION с физическим корневым каталогом C:\{PATH}\' не удалось запустить процесс с помощью команды "C:\\{PATH}\my_application.{exe|dll}"; код ошибки = 0x80004005 : ff.

* **Журнал модуля ASP.NET Core:** необработанное исключение System.BadImageFormatException: не удалось загрузить файл или сборку my_application.dll. Была сделана попытка загрузить программу, имеющую неверный формат.

Устранение неполадок:

* Убедитесь в том, что приложение выполняется локально в Kestrel. Сбой процесса может быть результатом проблемы в приложении. Дополнительные сведения см. в разделе [Советы по устранению неполадок](#troubleshooting-tips).

* Убедитесь в том, что в файле *CSPROJ* не задано значение `<PlatformTarget>`, конфликтующее с относительным идентификатором (RID). Например, не указывайте `<PlatformTarget>` со значением `x86`, если вы выполняете публикацию с идентификатором RID `win10-x64` с помощью команды *dotnet publish -c Release -r win10-x64* или задавая `<RuntimeIdentifiers>` в файле *CSPROJ* равным `win10-x64`. Проект публикуется без предупреждения или сообщения об ошибке, но при запуске в системе происходит сбой, а в журнале регистрируются указанные выше исключения.

* Если это исключение возникает для развертывания приложений Azure при обновлении приложения и развертывании более новых сборок, вручную удалите все файлы предыдущего развертывания. Если останутся несовместимые сборки, то при развертывании обновленного приложения это может привести к исключению `System.BadImageFormatException`.

### <a name="uri-endpoint-wrong-or-stopped-website"></a>Неправильная конечная точка URI, либо веб-сайт остановлен

* **Браузер:** ERR_CONNECTION_REFUSED

* **Журнал приложений:** нет записи

* **Журнал модуля ASP.NET Core:** файл журнала не создан

Устранение неполадок:

* Убедитесь в том, что для приложения используется правильная конечная точка URI. Проверьте привязки.

* Проверьте, не находится ли веб-сайт IIS в состоянии *Остановлен*.

### <a name="corewebengine-or-w3svc-server-features-disabled"></a>Компонент сервера CoreWebEngine или W3SVC отключен

* **Исключение ОС:** для использования модуля ASP.NET Core должны быть установлены компоненты IIS 7.0 CoreWebEngine и W3SVC.

Устранение неполадок:

* Убедитесь в том, что включена соответствующая роль и компоненты. См. раздел [Конфигурация IIS](#iis-configuration).

### <a name="incorrect-website-physical-path-or-application-missing"></a>Неправильный физический путь к веб-сайту, либо отсутствует приложение

* **Браузер:** 403 — запрещено. В доступе отказано **--ИЛИ--** 403.14 — запрещено. Веб-сервер настроен таким образом, чтобы не формировать список содержимого каталога.

* **Журнал приложений:** нет записи

* **Журнал модуля ASP.NET Core:** файл журнала не создан

Устранение неполадок:

* Проверьте **основные настройки** веб-сайта IIS и физическую папку приложения. Убедитесь в том, что приложение находится в папке по **физическому пути** веб-сайта IIS.

### <a name="incorrect-role-module-not-installed-or-incorrect-permissions"></a>Неправильная роль, модуль не установлен либо неверные разрешения

* **Браузер:** 500.19 — внутренняя ошибка сервера. Запрашиваемая страница недоступна из-за неверной конфигурации данных для этой страницы.

* **Журнал приложений:** нет записи

* **Журнал модуля ASP.NET Core:** файл журнала не создан

Устранение неполадок:

* Убедитесь в том, что включена соответствующая роль. См. раздел [Конфигурация IIS](#iis-configuration).

* На странице **Программы и компоненты** убедитесь в том, что установлен **модуль Microsoft ASP.NET Core**. Если **модуль Microsoft ASP.NET Core** отсутствует в списке установленных программ, установите его. См. раздел [Установка пакета размещения .NET Core для Windows Server](#install-the-net-core-windows-server-hosting-bundle).

* Убедитесь, что параметр **Пул приложений** > **Модель процесса** > **Удостоверение** имеет значение **ApplicationPoolIdentity** или что у пользовательского удостоверения есть нужные разрешения на доступ к папке развертывания приложения.

### <a name="incorrect-processpath-missing-path-variable-hosting-bundle-not-installed-systemiis-not-restarted-vc-redistributable-not-installed-or-dotnetexe-access-violation"></a>Неправильное значение processPath, отсутствует переменная PATH, пакет размещения не установлен, система или службы IIS не перезапущены, не установлен распространяемый компонент VC++ либо нарушены права доступа к dotnet.exe

* **Браузер:** ошибка HTTP 502.5 — сбой процесса

* **Журнал приложений:** приложению MACHINE/WEBROOT/APPHOST/MY_APPLICATION с физическим корневым каталогом C:\\{PATH}\' не удалось запустить процесс с помощью команды ".\my_application.exe"; код ошибки = 0x80070002 : 0.

* **Журнал модуля ASP.NET Core:** файл журнала создан, но пуст

Устранение неполадок:

* Убедитесь в том, что приложение выполняется локально в Kestrel. Сбой процесса может быть результатом проблемы в приложении. Дополнительные сведения см. в разделе [Советы по устранению неполадок](#troubleshooting-tips).

* Проверьте атрибут *processPath* элемента `<aspNetCore>` в файле *web.config*. Он должен иметь значение *dotnet* для зависимого от платформы развертывания (FDD) или *.\my_application.exe* для автономного развертывания (SCD).

* Для зависимого от платформы развертывания файл *dotnet.exe* может быть недоступен по пути, указанному в переменной PATH. Убедитесь в том, что папка *C:\Program Files\dotnet\* существует в системных параметрах PATH.

* В случае с зависимым от платформы развертыванием файл *dotnet.exe* может быть недоступен для удостоверения пользователя, используемого для пула приложений. Убедитесь в том, что удостоверение пользователя AppPool имеет доступ к каталогу *C:\Program Files\dotnet*. Убедитесь в отсутствии запрещающих правил для удостоверения пользователя AppPool в каталоге *C:\Program Files\dotnet* и каталоге приложения.

* Возможно, вы произвели зависимое от платформы развертывание и установили .NET Core, не перезапустив после этого службы IIS. Перезагрузите сервер или перезапустите службы IIS, выполнив в командной строке команду **net stop was /y**, а затем — команду **net start w3svc**.

* Возможно, вы произвели зависимое от платформы развертывание, не установив среду выполнения .NET Core в размещающей системе. Если вы пытаетесь выполнить зависимое от платформы развертывание, не установив среду выполнения .NET Core, запустите в системе **установщик пакета размещения .NET Core для Windows Server**. См. раздел [Установка пакета размещения .NET Core для Windows Server](#install-the-net-core-windows-server-hosting-bundle). Если вы пытаетесь установить среду выполнения .NET Core в системе, не имеющей подключения к Интернету, получите среду выполнения на [странице скачивания .NET](https://www.microsoft.com/net/download/core) и запустите установщик пакета размещения, чтобы установить модуль ASP.NET Core. Завершите установку, перезагрузив систему или перезапустив службы IIS. Для этого выполните в командной строке команду **net stop was /y**, а затем — команду **net start w3svc**.

* Возможно, вы произвели зависимое от платформы развертывание и установили .NET Core, не перезапустив после этого систему или службы IIS. Перезагрузите систему или перезапустите службы IIS, выполнив в командной строке команду **net stop was /y**, а затем — команду **net start w3svc**.

* Возможно, вы произвели зависимое от платформы развертывание, не установив в системе *Распространяемый компонент Microsoft Visual C++ 2015 (64-разрядный)*. Получить установщик можно в [Центре загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=53840).

### <a name="incorrect-arguments-of-aspnetcore-element"></a>Неверные аргументы элемента \<aspNetCore\>

* **Браузер:** ошибка HTTP 502.5 — сбой процесса

* **Журнал приложений:** приложению MACHINE/WEBROOT/APPHOST/MY_APPLICATION с физическим корневым каталогом C:\\{PATH}\' не удалось запустить процесс с помощью команды ""dotnet" \my_application.dll"; код ошибки = 0x80004005 : 80008081.

* **Журнал модуля ASP.NET Core:** Выполняемое приложение не существует: "PATH\my_application.dll"

Устранение неполадок:

* Убедитесь в том, что приложение выполняется локально в Kestrel. Сбой процесса может быть результатом проблемы в приложении. Дополнительные сведения см. в разделе [Советы по устранению неполадок](#troubleshooting-tips).

* Проверьте атрибут *arguments* элемента `<aspNetCore>` в файле *web.config* и удостоверьтесь, что его значение: а) имеет вид *.\my_application.dll* для развертывания, зависящего от платформы (FDD); б) отсутствует, содержит пустую строку (*arguments=""*) или список аргументов вашего приложения (*arguments="arg1, arg2, ..."*) для автономного развертывания (SCD).

### <a name="missing-net-framework-version"></a>Отсутствует версия платформы .NET Framework

* **Браузер:** 502.3 — неверный шлюз. При попытке маршрутизации запроса произошла ошибка подключения.

* **Журнал приложений:** Код ошибки = приложению MACHINE/WEBROOT/APPHOST/MY_APPLICATION с физическим корневым каталогом C:\\{PATH}\' не удалось запустить процесс с помощью команды ""dotnet" \my_application.dll"; код ошибки = 0x80004005 : 80008081.

* **Журнал модуля ASP.NET Core:** Исключение из-за отсутствия метода, файла или сборки. Метод, файл или сборка, указанные в исключении, представляют собой метод, файл или сборку .NET Framework.

Устранение неполадок:

* Установите версию .NET Framework, отсутствующую в системе.

* В случае с зависимым от платформы развертыванием (FDD) убедитесь в том, что в системе установлена нужная среда выполнения. Если вы обновляете проект с версии 1.1 до версии 2.0, развертываете его в размещающей системе, а затем получаете это исключение, проверьте, установлена ли в системе платформа версии 2.0.

### <a name="stopped-application-pool"></a>Пул приложений остановлен

* **Браузер:** 503 — служба недоступна

* **Журнал приложений:** нет записи

* **Журнал модуля ASP.NET Core:** файл журнала не создан

Устранение неполадок

* Проверьте, не находится ли пул приложений в состоянии *Остановлен*.

### <a name="iis-integration-middleware-not-implemented"></a>ПО промежуточного слоя для интеграции IIS не внедрено

* **Браузер:** ошибка HTTP 502.5 — сбой процесса

* **Журнал приложений:** приложение MACHINE/WEBROOT/APPHOST/MY_APPLICATION с физическим корневым каталогом C:\\{PATH}\' создало процесс с помощью команды "C:\\{PATH}\my_application.{exe|dll}", однако при этом либо произошел сбой, либо не был получен ответ, либо не прослушивался указанный порт {PORT}; код ошибки = 0x800705b4

* **Журнал модуля ASP.NET Core:** файл журнала создан, и в нем нет сведений о неправильной работе.

Устранение неполадок

* Убедитесь в том, что приложение выполняется локально в Kestrel. Сбой процесса может быть результатом проблемы в приложении. Дополнительные сведения см. в разделе [Советы по устранению неполадок](#troubleshooting-tips).

* Убедитесь в том, что вы правильно указали ПО промежуточного слоя для интеграции IIS, вызвав метод *.UseIISIntegration()* для объекта *WebHostBuilder()* приложения (ASP.NET Core 1.x), или использовали метод `CreateDefaultBuilder` (ASP.NET Core 2.x). Дополнительные сведения см. в статье [Размещение в ASP.NET Core](xref:fundamentals/hosting).

### <a name="sub-application-includes-a-handlers-section"></a>Дочернее приложение имеет раздел \<handlers\>

* **Браузер:** ошибка HTTP 500.19 — внутренняя ошибка сервера

* **Журнал приложений:** нет записи

* **Журнал модуля ASP.NET Core:** файл журнала создан для корневого приложения, и в нем нет сведений о неправильной работе. Файл журнала для дочернего приложения не создан.

Устранение неполадок

* В файле *web.config* дочернего приложения не должно быть раздела `<handlers>`.

### <a name="application-configuration-general-issue"></a>Общая проблема с конфигурацией приложения

* **Браузер:** ошибка HTTP 502.5 — сбой процесса

* **Журнал приложений:** приложение MACHINE/WEBROOT/APPHOST/MY_APPLICATION с физическим корневым каталогом C:\\{PATH}\' создало процесс с помощью команды "C:\\{PATH}\my_application.{exe|dll}", однако при этом либо произошел сбой, либо не был получен ответ, либо не прослушивался указанный порт {PORT}; код ошибки = 0x800705b4

* **Журнал модуля ASP.NET Core:** файл журнала создан, но пуст

Устранение неполадок

* Это общее исключение указывает на то, что процесс не удалось запустить, скорее всего, из-за проблемы с конфигурацией приложения. Обратитесь к статье [Структура каталогов](xref:hosting/directory-structure) и убедитесь в том, что развернуты надлежащие файлы и папки приложения, имеются его файлы конфигурации и в них содержатся правильные параметры для приложения и среды. Дополнительные сведения см. в разделе [Советы по устранению неполадок](#troubleshooting-tips).

## <a name="resources"></a>Ресурсы

* [Введение в модуль ASP.NET Core](xref:fundamentals/servers/aspnet-core-module)
* [Справочник по конфигурации модуля ASP.NET Core](xref:hosting/aspnet-core-module)
* [Использование модулей IIS с ASP.NET Core](xref:hosting/iis-modules)
* [Введение в ASP.NET Core](../index.md)
* [Официальный веб-сайт Microsoft IIS](https://www.iis.net/)
* [Библиотека Microsoft TechNet: Windows Server](https://docs.microsoft.com/windows-server/windows-server-versions)

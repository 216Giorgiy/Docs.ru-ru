---
uid: web-pages/overview/ui-layouts-and-themes/18-customizing-site-wide-behavior
title: Настройка поведения сайта для веб-страниц ASP.NET (Razor) узлов | Документы Microsoft
author: tfitzmac
description: В этой главе объясняется, как сделать параметры вашего веб-сайты или всю папку, а не только страницы.
ms.author: aspnetcontent
manager: wpickett
ms.date: 02/17/2014
ms.topic: article
ms.assetid: e158bed7-226f-4275-b02e-7553bd58c669
ms.technology: dotnet-webpages
ms.prod: .net-framework
msc.legacyurl: /web-pages/overview/ui-layouts-and-themes/18-customizing-site-wide-behavior
msc.type: authoredcontent
ms.openlocfilehash: 4457318bcf1d2886eb8ed68fdd795eea7905368b
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
<a name="customizing-site-wide-behavior-for-aspnet-web-pages-razor-sites"></a>Настройка поведения сайта для веб-страниц (Razor) узлов ASP.NET
====================
по [Tom FitzMacken](https://github.com/tfitzmac)

> В этой статье объясняется, как делать параметров на стороне узла для страниц веб-сайте ASP.NET Web Pages (Razor).
> 
> Что вы узнаете следующее.
> 
> - Как для выполнения кода, которая позволяет вам набор значений (глобальные переменные или параметры поддержки) для всех страниц на сайте.
> - Как выполнять код, который позволяет задавать значения для всех страниц в папке.
> - Загружает выполнение кода до и после страницы.
> - Как отправить ошибки на странице центра ошибки.
> - Инструкции по добавлению проверки подлинности для всех страниц в папке.
>   
> 
> ## <a name="software-versions-used-in-the-tutorial"></a>Версии программного обеспечения, используемая в этом учебнике
> 
> 
> - Веб-страниц ASP.NET (Razor) 2
> - WebMatrix 3
> - Библиотека вспомогательных методов ASP.NET Web (пакет NuGet)
>   
> 
> Этот учебник также работает с 3 веб-страниц ASP.NET и Visual Studio 2013 (или Visual Studio Express 2013 для веб-сайта), за исключением того, вы не может использовать библиотека вспомогательных методов ASP.NET Web.


<a id="Adding_Website_Startup_Code"></a>
## <a name="adding-website-startup-code-for-aspnet-web-pages"></a>Добавление кода для запуска веб-сайт веб-страниц ASP.NET

Большую часть кода, написанного в веб-страницах ASP.NET, для отдельной страницы может содержать весь код, необходимый для данной страницы. Например если страница отправляет сообщение электронной почты, можно поместить весь код для этой операции на одну страницу. Это может включать код, чтобы инициализировать параметры для отправки электронной почты (то есть для SMTP-сервера) и для отправки сообщений электронной почты.

Однако в некоторых ситуациях может потребоваться выполнять определенный код перед выполнением любой страницы на сайте. Это полезно при задании значения, которые могут использоваться в любом месте на сайте (называют *глобальные значения*.) Например некоторые вспомогательные методы требуют предоставления значения, такие как параметры электронной почты или ключи учетной записи. Он может оказаться удобным для сохранения этих параметров в глобальные значения.

Это можно сделать путем создания страницы с именем  *\_AppStart.cshtml* в корневом узле. Если эта страница существует, оно выполняется при первом запросе любой страницы на сайте. Таким образом это хорошая возможность запустить код, чтобы задать глобальные значения. (Поскольку  *\_AppStart.cshtml* имеют префикс подчеркивания ASP.NET не будет отправлять страницы в браузер, даже если он напрямую запрашивать пользователей.)

На следующей схеме показано как  *\_AppStart.cshtml* страница работает. При поступлении запроса на странице, и если это первый запрос любой страницы на сайте ASP.NET сначала проверяет ли  *\_AppStart.cshtml* страница существует. Если Да, какой-либо код  *\_AppStart.cshtml* выполняется страница, а затем запускает запрошенной страницы.

![[image]](18-customizing-site-wide-behavior/_static/image1.jpg)

## <a name="setting-global-values-for-your-website"></a>Установка глобальных значений для веб-сайта

1. В корневой папке веб-сайта в WebMatrix, создайте файл с именем  *\_AppStart.cshtml*. Файл должен быть в корневом узле.
2. Замените существующее содержимое следующим кодом: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample1.cshtml)]

    Этот код сохраняет значение в `AppState` словаря, который автоматически доступны для всех страниц на сайте. Обратите внимание, что  *\_AppStart.cshtml* файл имеет разметку в нем. Запускается код и затем перенаправление на страницу, первоначально запрошенной страницы.

    > [!NOTE]
    > Следует соблюдать осторожность при добавлении кода в  *\_AppStart.cshtml* файла. При появлении ошибок в коде в  *\_AppStart.cshtml* файла, веб-сайт не запускается.
3. В корневой папке создайте новую страницу с именем *AppName.cshtml*.
4. Замените по умолчанию разметка и код следующим кодом: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample2.html)]

    Этот код извлекает значение из `AppState` объекта, который задается в  *\_AppStart.cshtml* страницы.
5. Запустите *AppName.cshtml* страницы в браузере. (Убедитесь, что выбран страницы **файлы** рабочей области, прежде чем запускать его.) На странице отображается глобальное значение. 

    ![[image]](18-customizing-site-wide-behavior/_static/image2.jpg)

<a id="Setting_Values_For_Helpers"></a>
## <a name="setting-values-for-helpers"></a>Значения параметра для помощников

Рекомендуется использовать для  *\_AppStart.cshtml* файла является установка значений для вспомогательных методов, которые используется в веб-узла и который нужно инициализировать. Типичными примерами являются параметры электронной почты для `WebMail` вспомогательный метод и открытые и закрытые ключи для `ReCaptcha` модуля поддержки. В подобных случаях можно задать значения в один раз в  *\_AppStart.cshtml* и затем они всегда уже можно изменить для всех страниц веб-узла.

Эта процедура показывает, как задать `WebMail` параметры глобально. (Дополнительные сведения об использовании `WebMail` вспомогательного приложения, в разделе [Добавление электронной почты для узла веб-страниц ASP.NET](../getting-started/11-adding-email-to-your-web-site.md).)

1. Добавить библиотека вспомогательных методов ASP.NET Web веб-сайта, как описано в [Установка помощников в узел веб-страниц ASP.NET](https://go.microsoft.com/fwlink/?LinkId=252372), если не было добавлено.
2. Если у вас еще нет  *\_AppStart.cshtml* в корневой папке веб-сайта, создайте файл с именем  *\_AppStart.cshtml*.
3. Добавьте следующие `WebMail` параметры  *\_AppStart.cshtml* файла: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample3.cshtml?highlight=2-7)]

    Изменить связанные параметры в коде, электронной почты следующие:

   - Задать `your-SMTP-host` имя SMTP-сервера, у вас есть право.
   - Задать `your-user-name-here` к имени пользователя для учетной записи сервера SMTP.
   - Задать `your-account-password` пароль пользователя для учетной записи сервера SMTP.
   - Задать `your-email-address-here` на собственный адрес электронной почты. Это адрес электронной почты отправителя сообщения. (Некоторые поставщики электронной почты не позволяют задать другую `From` адреса и будет использовать имя пользователя как `From` адрес.)

     Дополнительные сведения о параметрах SMTP см. в разделе [Настройка параметров электронной почты](https://go.microsoft.com/fwlink/?LinkID=202899#configuring_email_settings) в статье [отправки электронной почты из веб-узла ASP.NET Web Pages (Razor)](https://go.microsoft.com/fwlink/?LinkID=202899) и [проблемы с отправкой сообщения электронной почты](https://go.microsoft.com/fwlink/?LinkId=253001#email)в [веб-страниц ASP.NET (Razor) Troubleshooting Guide](https://go.microsoft.com/fwlink/?LinkId=253001).
4. Сохранить  *\_AppStart.cshtml* файл и закройте его.
5. В корневой папке веб-сайта, создайте новую страницу с именем *TestEmail.cshtml*.
6. Замените существующее содержимое следующим кодом: 

     [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample4.cshtml)]
7. Запустите *TestEmail.cshtml* страницы в браузере.
8. Заполните поля Отправьте себе электронное сообщение, а затем нажмите кнопку **отправки**.
9. Проверьте свою электронную почту, чтобы убедиться в том, что вы получили сообщение.

Важной частью в этом примере это параметры, которые не изменяют обычно — имя SMTP-сервера и учетные данные электронной почты, например — устанавливаются в  *\_AppStart.cshtml* файла. В этом случае не нужно повторно устанавливать их на каждой странице, куда отправить по электронной почте. (Несмотря на то, что если какой-либо причине необходимо изменить эти параметры, можно задать их по отдельности на странице.) На странице только задания значений, которые обычно изменяется каждый раз, как и получателе, а текст сообщения электронной почты.

<a id="Running_Code_Before_and_After"></a>
## <a name="running-code-before-and-after-files-in-a-folder"></a>Выполнение кода до и после файлов в папке

Так же, как можно использовать  *\_AppStart.cshtml* написания кода до запуска страницы веб-узла, можно написать код, выполняемый до (и после) любой страницы в определенной папке запущена. Это полезно для таких вещей, как установка одной страницы макета для всех страниц в папке или для проверки, пользователь вошел перед запуском страницы в папке.

Для страниц, в частности папок, вы можете создать код в файле с именем  *\_PageStart.cshtml*. На следующей схеме показано как  *\_PageStart.cshtml* страница работает. При поступлении запроса для страницы ASP.NET сначала проверяет  *\_AppStart.cshtml* страницы и работает под управлением. ASP.NET проверяет, существует ли  *\_PageStart.cshtml* страницы, и если да, работает под управлением. Затем он выполняет запрошенную страницу.

Внутри  *\_PageStart.cshtml* страницы, где можно указать во время обработки требуется для запуска, включая запрошенную страницу `RunPage` метод. Это позволяет выполнять код перед выполнением запрошенной страницы и затем снова после него. Если не включить `RunPage`, весь код в  *\_PageStart.cshtml* запуски и Запрашиваемая страница запускается автоматически.

![[image]](18-customizing-site-wide-behavior/_static/image3.jpg)

ASP.NET позволяет создать иерархию  *\_PageStart.cshtml* файлов. Можно поместить  *\_PageStart.cshtml* файл в корневой каталог сайта и в любой вложенной. При запросе страницы  *\_PageStart.cshtml* файл в запусков самого верхнего уровня (ближайшего к корню сайта), за которым следует  *\_PageStart.cshtml* файла в следующем Вложенная папка, и так далее вниз структура вложенных, пока запрос не достигнет папку, содержащую запрошенной страницы. После всех применимых  *\_PageStart.cshtml* запуска файлов, выполняет запрошенную страницу.

Например, может потребоваться следующее сочетание  *\_PageStart.cshtml* файлы и *Default.cshtml* файла:

[!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample5.cshtml)]

[!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample6.cshtml)]

[!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample7.cshtml)]

При запуске */myfolder/default.cshtml*, вы увидите следующее:

[!code-console[Main](18-customizing-site-wide-behavior/samples/sample8.cmd)]

## <a name="running-initialization-code-for-all-pages-in-a-folder"></a>Выполнение кода инициализации для всех страниц в папке

Рекомендуется использовать для  *\_PageStart.cshtml* файлов: для инициализации одну страницу макета для всех файлов в одной папке.

1. В корневой папке создайте новую папку с именем *InitPages*.
2. В *InitPages* папку веб-сайта, создайте файл с именем  *\_PageStart.cshtml* и замените разметку и код следующим: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample9.cshtml)]
3. В корневом веб-сайта, создайте папку с именем *Shared*.
4. В *Shared* папки, создайте файл с именем  *\_Layout1.cshtml* и замените разметку и код следующим: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample10.cshtml)]
5. В *InitPages* папки, создайте файл с именем *Content1.cshtml* и замените существующее содержимое следующим: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample11.html)]
6. В *InitPages* папки, создайте другой файл с именем *Content2.cshtml* и замените существующую разметку следующим: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample12.html)]
7. Запустите *Content1.cshtml* в браузере. 

    ![[image]](18-customizing-site-wide-behavior/_static/image4.jpg)

    Когда *Content1.cshtml* выполняется, страница  *\_PageStart.cshtml* файл задает `Layout` , а также задается `PageData["MyBackground"]` цвет. В *Content1.cshtml*, применения макета и цвет.
8. Отображение *Content2.cshtml* в браузере. 

    Макет не изменяется, так как обе страницы использовать те же страницы макета и цвет, как инициализировать в  *\_PageStart.cshtml*.

## <a name="using-pagestartcshtml-to-handle-errors"></a>С помощью \_PageStart.cshtml для обработки ошибок

Использовать другой подходит для  *\_PageStart.cshtml* файла является создание способ обработки программирования ошибок (исключения), которые могут возникнуть в любой *.cshtml* страница в папке. В этом примере показано, как это сделать.

1. В корневой папке создайте папку с именем *InitCatch*.
2. В *InitCatch* папку веб-сайта, создайте файл с именем  *\_PageStart.cshtml* и замените существующую разметку и код следующим: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample13.cshtml)]

    В этом коде повторите запуск Запрашиваемая страница явным образом с помощью вызова `RunPage` метод внутри `try` блока. При появлении ошибок программирования в запрошенной страницы, код внутри `catch` блок. В этом случае код выполняет перенаправление на страницу (*Error.cshtml*) и передает имя файла, в которой возникла ошибка как часть URL-адрес. (Вы создадите страницы вскоре.)
3. В *InitCatch* папку веб-сайта, создайте файл с именем *Exception.cshtml* и замените существующую разметку и код следующим: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample14.cshtml)]

    Для этого примера вы всего лишь на этой странице намеренно создает ошибку при попытке открыть файл базы данных, которая не существует.
4. В корневой папке создайте файл с именем *Error.cshtml* и замените существующую разметку и код следующим: 

    [!code-html[Main](18-customizing-site-wide-behavior/samples/sample15.html)]

    На этой странице выражение `@Request["source"]` возвращает значение из URL-адрес и отображает его.
5. На панели инструментов нажмите кнопку **Сохранить**.
6. Запустите *Exception.cshtml* в браузере. 

    ![[image]](18-customizing-site-wide-behavior/_static/image5.jpg)

    Из-за ошибки в *Exception.cshtml*,  *\_PageStart.cshtml* страница выполняет перенаправление на *Error.cshtml* файл, который выводит сообщение.

    Дополнительные сведения об исключениях см. в разделе [введение в ASP.NET Web Pages программирование с использованием синтаксиса Razor](https://go.microsoft.com/fwlink/?LinkID=251587).

<a id="Using__PageStart.cshtml_to_Restrict_Folder_Access"></a>
## <a name="using-pagestartcshtml-to-restrict-folder-access"></a>С помощью \_PageStart.cshtml, чтобы ограничить доступ к папке

Можно также использовать  *\_PageStart.cshtml* файл, чтобы ограничить доступ ко всем файлам в папке.

1. В WebMatrix, создайте новый веб-сайт с помощью **сайта из шаблона** параметр.
2. В списке доступных шаблонов выберите **начального сайта**.
3. В корневой папке создайте папку с именем *AuthenticatedContent*.
4. В *AuthenticatedContent* папки, создайте файл с именем  *\_PageStart.cshtml* и замените существующую разметку и код следующим: 

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample16.cshtml)]

    Начинается код, так как все файлы в папке кэширования. (Это требуется для сценариев, таких как общедоступные компьютеры, где вы не хотите кэшированных страниц одного пользователя будут доступны для следующего пользователя.) Затем код определяет ли пользователь вход в систему сайта, прежде чем они могут просматривать какие-либо страницы в папке. Если пользователь не выполнил вход, код выполняет перенаправление на страницу входа. Страница входа можно вернуться на страницу, первоначально запрошенной при включении значение строки запроса с именем пользователя `ReturnUrl`.
5. Создание новой страницы в *AuthenticatedContent* папку с именем *Page.cshtml*.
6. Замените существующую разметку следующим:  

    [!code-cshtml[Main](18-customizing-site-wide-behavior/samples/sample17.cshtml)]
7. Запустите *Page.cshtml* в браузере. Код выполняет перенаправление на страницу входа. Перед входом необходимо зарегистрировать. После регистрации и входа, можно перейти на страницу и просмотреть его содержимое.

<a id="Additional_Resources"></a>
## <a name="additional-resources"></a>Дополнительные ресурсы

[Введение в программирование с использованием синтаксиса Razor веб-страниц ASP.NET](https://go.microsoft.com/fwlink/?LinkID=251587)

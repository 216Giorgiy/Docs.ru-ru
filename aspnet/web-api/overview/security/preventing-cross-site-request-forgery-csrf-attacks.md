---
uid: web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
title: Предотвращение атак подделки межсайтовых запросов в веб-API ASP.NET | Документы Microsoft
author: MikeWasson
description: Описывает атаки подделки межсайтовых запросов и способ реализации меры противодействия CSRF в веб-API ASP.NET.
ms.author: aspnetcontent
manager: wpickett
ms.date: 12/12/2012
ms.topic: article
ms.assetid: 81d46f14-8f48-4d8c-830d-cc8d594dc11b
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/security/preventing-cross-site-request-forgery-csrf-attacks
msc.type: authoredcontent
ms.openlocfilehash: 5e7b24c697e0bb37f388341abd89609c76f6b64c
ms.sourcegitcommit: 356c8d394aaf384c834e9c90cabab43bfe36e063
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/26/2018
ms.locfileid: "36961241"
---
<a name="preventing-cross-site-request-forgery-csrf-attacks-in-aspnet-web-api"></a>Предотвращение атак подделки межсайтовых запросов в веб-API ASP.NET
====================
по [Mike Wasson](https://github.com/MikeWasson)

Подделки межсайтовых запросов (CSRF) — это атака, при которой вредоносный сайт отправляет запрос уязвимым сайта, где пользователь вошел в настоящее время в

Ниже приведен пример атаки CSRF:

1. Пользователь выполняет вход в `www.example.com` проверки подлинности с помощью форм.
2. Сервер проверяет подлинность пользователя. Ответ от сервера включает файл cookie проверки подлинности.
3. Не выходя из пользователь посещает вредоносный веб-узел. Этот вредоносный сайт содержит следующие HTML-формы: 

    [!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample1.html)]

    Обратите внимание, что действие формы в блогах уязвимым сайте, не вредоносный сайт. Это часть CSRF «между сайтами».
4. При нажатии кнопки "Отправить". Браузер включает файл cookie проверки подлинности с запросом.
5. Запрос выполняется на сервере с контекстом проверки подлинности пользователя и делать все, что разрешено делать прошедшего проверку подлинности пользователя.

Несмотря на то, что в этом примере требует от пользователя, нажмите кнопку «форма», страницу вредоносных удалось так же, как легко запускать скрипт, который автоматически отправляет форму. Кроме того с помощью протокола SSL не запрещает атаки CSRF, так как вредоносный сайт можно отправить запрос «https://».

Как правило атаки CSRF для веб-сайтов, которые используют файлы cookie для проверки подлинности, так как браузеры отправляют все соответствующие файлы cookie в веб-узел назначения. Тем не менее атаки CSRF ограничены не использовать файлы cookie. Например Basic и дайджест-проверки подлинности также уязвимы. После входа пользователя в систему с обычная или краткая проверка подлинности. браузер автоматически отправляет учетные данные до завершения сеанса.

## <a name="anti-forgery-tokens"></a>Маркеры защиты от подделки

Чтобы предотвратить атаки CSRF, ASP.NET MVC использует маркеров защиты от подделки, также называемый *запроса маркеров проверки*.

1. Клиент запрашивает страницу HTML, содержащий форму.
2. Сервер включает два маркера в ответе. Один маркер отправляется в качестве файла cookie. Другой помещается в скрытом поле формы. Токены создаются случайным образом, чтобы злоумышленник невозможно подобрать значения.
3. Когда клиент отправляет форму, отправьте оба маркера обратно на сервер. Клиент отправляет маркер куки-файл как файл cookie и отправляет маркера формы внутри данные формы. (Браузер клиента автоматически делает это когда пользователь отправляет форму.)
4. Если запрос не содержит оба маркера, сервер запрещает запроса.

Ниже приведен пример формы HTML с помощью маркера скрытой форме:

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample2.html)]

Маркеров защиты от подделки работать, поскольку вредоносный страницы не удается прочитать токенов пользователя, из-за политики для одного источника. ([Одного источника политики](http://www.w3.org/Security/wiki/Same_Origin_Policy) предотвратить документы, размещенные на двух различных узлов из доступа к содержимому друг друга. Поэтому в предыдущем примере вредоносных страницы могут отправлять запросы example.com, но его не удалось прочитать ответ).

Для предотвращения атак CSRF воспользуйтесь маркеров защиты от подделки с любой протокол проверки подлинности, где обозреватель автоматически отправляет учетные данные после входа пользователя. Это включает в себя протоколы проверки подлинности на основе файлов cookie, такие как формы проверки подлинности, а также протоколов, таких как Basic и дайджест-проверки подлинности.

Для любых nonsafe методов (POST, PUT, DELETE) должна требовать маркеров защиты от подделки. Кроме того убедитесь, что безопасные методы (GET, HEAD) не имеют никаких побочных эффектов. Кроме того Если включена поддержка между доменами, например CORS или JSONP, затем даже безопасные методы, такие как GET потенциально уязвимой для атак CSRF, что позволит злоумышленнику читать потенциально конфиденциальных данных.

## <a name="anti-forgery-tokens-in-aspnet-mvc"></a>Маркеры защиты от подделки в ASP.NET MVC

Чтобы добавить маркеров защиты от подделки страниц Razor, используйте **HtmlHelper.AntiForgeryToken** вспомогательный метод:

[!code-cshtml[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample3.cshtml)]

Этот метод добавляет скрытое поле формы, а также задается маркер cookie.

## <a name="anti-csrf-and-ajax"></a>CSRF защиты и AJAX

Маркера формы может вызвать проблемы для запросов AJAX, так как запрос AJAX может отправить данные JSON, а не данные HTML-формы. Одним из решений является отправка токены в заголовок HTTP. Следующий код использует синтаксис Razor для создания токенов, а затем добавляет токены для AJAX-запросом. Токены созданные на сервере путем вызова **AntiForgery.GetTokens**.

[!code-html[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample4.html)]

При обработке запроса, извлеките токены из заголовка запроса. Затем вызовите **AntiForgery.Validate** метод для проверки токенов. **Проверки** метод вызывает исключение, если токены не допускаются.

[!code-csharp[Main](preventing-cross-site-request-forgery-csrf-attacks/samples/sample5.cs)]

---
uid: web-api/overview/security/authentication-filters
title: "Фильтры проверки подлинности в ASP.NET Web API 2 | Документы Microsoft"
author: MikeWasson
description: "Фильтр проверки подлинности — это компонент, который выполняет проверку подлинности HTTP-запроса. Веб-API 2 и MVC 5 и поддерживать фильтры проверки подлинности, но немного отличаться..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 09/25/2014
ms.topic: article
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: 7c704cc351876b49ec143a49b25cc0ca83876e06
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2018
---
<a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="9bb11-104">Фильтры проверки подлинности в ASP.NET Web API 2</span><span class="sxs-lookup"><span data-stu-id="9bb11-104">Authentication Filters in ASP.NET Web API 2</span></span>
====================
<span data-ttu-id="9bb11-105">по [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="9bb11-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="9bb11-106">Фильтр проверки подлинности — это компонент, который выполняет проверку подлинности HTTP-запроса.</span><span class="sxs-lookup"><span data-stu-id="9bb11-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="9bb11-107">Веб-API 2 и MVC 5 и поддерживать фильтры проверки подлинности, но они незначительно отличаются в основном соглашения об именовании для интерфейса фильтра.</span><span class="sxs-lookup"><span data-stu-id="9bb11-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="9bb11-108">В этом разделе описываются фильтры проверки подлинности веб-API.</span><span class="sxs-lookup"><span data-stu-id="9bb11-108">This topic describes Web API authentication filters.</span></span>


<span data-ttu-id="9bb11-109">Фильтры проверки подлинности позволяют задать схему проверки подлинности для отдельных контроллеров или действий.</span><span class="sxs-lookup"><span data-stu-id="9bb11-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="9bb11-110">Таким образом, приложение может поддерживать различных механизмов проверки подлинности для разных ресурсов HTTP.</span><span class="sxs-lookup"><span data-stu-id="9bb11-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="9bb11-111">В этой статье я покажу кода из [обычной проверки подлинности](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) пример [http://aspnet.codeplex.com](http://aspnet.codeplex.com). В этом примере фильтр проверки подлинности, который реализует схему HTTP, обычной проверки подлинности доступа (RFC 2617).</span><span class="sxs-lookup"><span data-stu-id="9bb11-111">In this article, I'll show code from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample on [http://aspnet.codeplex.com](http://aspnet.codeplex.com). The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="9bb11-112">Фильтр реализуется в классе с именем `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="9bb11-112">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="9bb11-113">Я не буду весь код из примера частей, которые показывают, как написать фильтр проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="9bb11-113">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="9bb11-114">Настройка фильтрации по проверки подлинности</span><span class="sxs-lookup"><span data-stu-id="9bb11-114">Setting an Authentication Filter</span></span>

<span data-ttu-id="9bb11-115">Как и другие фильтры фильтры проверки подлинности может быть применен контроллера action и глобально для всех контроллеров веб-API.</span><span class="sxs-lookup"><span data-stu-id="9bb11-115">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="9bb11-116">Чтобы применить фильтр проверки подлинности к контроллеру, декорировать класс контроллера с атрибутом фильтра.</span><span class="sxs-lookup"><span data-stu-id="9bb11-116">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="9bb11-117">Следующий код задает `[IdentityBasicAuthentication]` фильтр на класс контроллера, который включает обычную проверку подлинности для всех действий в контроллере.</span><span class="sxs-lookup"><span data-stu-id="9bb11-117">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="9bb11-118">Чтобы применить фильтр к одно действие, кодировке действие фильтра.</span><span class="sxs-lookup"><span data-stu-id="9bb11-118">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="9bb11-119">Следующий код задает `[IdentityBasicAuthentication]` фильтра на контроллере `Post` метод.</span><span class="sxs-lookup"><span data-stu-id="9bb11-119">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="9bb11-120">Чтобы применить фильтр ко всем контроллерам веб-API, добавьте его в **GlobalConfiguration.Filters**.</span><span class="sxs-lookup"><span data-stu-id="9bb11-120">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="9bb11-121">Реализация проверки подлинности API веб-фильтра</span><span class="sxs-lookup"><span data-stu-id="9bb11-121">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="9bb11-122">В веб-API проверки подлинности фильтры реализуют [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) интерфейса.</span><span class="sxs-lookup"><span data-stu-id="9bb11-122">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="9bb11-123">Они также должны наследоваться от **System.Attribute**, чтобы применить в качестве атрибутов.</span><span class="sxs-lookup"><span data-stu-id="9bb11-123">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="9bb11-124">**IAuthenticationFilter** интерфейса есть два метода:</span><span class="sxs-lookup"><span data-stu-id="9bb11-124">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="9bb11-125">**AuthenticateAsync** проверяет подлинность запроса путем проверки учетных данных в запросе, если он имеется.</span><span class="sxs-lookup"><span data-stu-id="9bb11-125">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="9bb11-126">**ChallengeAsync** добавляет запрос проверки подлинности для HTTP-ответа, при необходимости.</span><span class="sxs-lookup"><span data-stu-id="9bb11-126">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="9bb11-127">Эти методы соответствуют поток проверки подлинности, определенных в [RFC 2612](http://tools.ietf.org/html/rfc2616) и [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="9bb11-127">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="9bb11-128">Клиент отправляет учетные данные в заголовок авторизации.</span><span class="sxs-lookup"><span data-stu-id="9bb11-128">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="9bb11-129">Обычно это происходит после того, клиент получает ответ 401 (несанкционированный) с сервера.</span><span class="sxs-lookup"><span data-stu-id="9bb11-129">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="9bb11-130">Тем не менее клиент может отправлять учетные данные с любым запросом не только после получения 401.</span><span class="sxs-lookup"><span data-stu-id="9bb11-130">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="9bb11-131">Если сервер не принимает учетные данные, он возвращает ответ 401 (несанкционированный).</span><span class="sxs-lookup"><span data-stu-id="9bb11-131">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="9bb11-132">Ответ включает заголовок Www-Authenticate, который содержит один или несколько задач.</span><span class="sxs-lookup"><span data-stu-id="9bb11-132">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="9bb11-133">Каждый запрос указывает схему проверки подлинности распознана сервером.</span><span class="sxs-lookup"><span data-stu-id="9bb11-133">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="9bb11-134">Сервер также может вернуть 401 от анонимный запрос.</span><span class="sxs-lookup"><span data-stu-id="9bb11-134">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="9bb11-135">На самом деле это обычно как инициируется процесс проверки подлинности:</span><span class="sxs-lookup"><span data-stu-id="9bb11-135">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="9bb11-136">Клиент отправляет анонимный запрос.</span><span class="sxs-lookup"><span data-stu-id="9bb11-136">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="9bb11-137">Сервер возвращает 401.</span><span class="sxs-lookup"><span data-stu-id="9bb11-137">The server returns 401.</span></span>
3. <span data-ttu-id="9bb11-138">Клиенты повторно отправляет запрос с учетными данными.</span><span class="sxs-lookup"><span data-stu-id="9bb11-138">The clients resends the request with credentials.</span></span>

<span data-ttu-id="9bb11-139">Этот процесс включает в себя *проверки подлинности* и *авторизации* действия.</span><span class="sxs-lookup"><span data-stu-id="9bb11-139">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="9bb11-140">Проверка подлинности удостоверяет подлинность клиента.</span><span class="sxs-lookup"><span data-stu-id="9bb11-140">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="9bb11-141">Авторизация определяет, может ли клиент доступ к конкретному ресурсу.</span><span class="sxs-lookup"><span data-stu-id="9bb11-141">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="9bb11-142">В веб-API фильтры проверки подлинности обработки проверки подлинности, но не авторизации.</span><span class="sxs-lookup"><span data-stu-id="9bb11-142">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="9bb11-143">Авторизации должен сделать фильтра авторизации или внутри действия контроллера.</span><span class="sxs-lookup"><span data-stu-id="9bb11-143">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="9bb11-144">Ниже приведена последовательность действий в конвейере веб-API 2:</span><span class="sxs-lookup"><span data-stu-id="9bb11-144">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="9bb11-145">До вызова действия, веб-API создает список фильтров проверки подлинности для этого действия.</span><span class="sxs-lookup"><span data-stu-id="9bb11-145">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="9bb11-146">Сюда входят фильтры области действия, контроллера, область и глобальной области.</span><span class="sxs-lookup"><span data-stu-id="9bb11-146">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="9bb11-147">Веб-вызовы API **AuthenticateAsync** на каждый фильтр в списке.</span><span class="sxs-lookup"><span data-stu-id="9bb11-147">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="9bb11-148">Каждый фильтр может проверить учетные данные, в запросе.</span><span class="sxs-lookup"><span data-stu-id="9bb11-148">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="9bb11-149">Если фильтр успешно проверяет учетные данные, создает фильтр **IPrincipal** и присоединяет его к запросу.</span><span class="sxs-lookup"><span data-stu-id="9bb11-149">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="9bb11-150">Фильтр может также вызывать ошибку на этом этапе.</span><span class="sxs-lookup"><span data-stu-id="9bb11-150">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="9bb11-151">В этом случае оставшуюся часть конвейера не выполняется.</span><span class="sxs-lookup"><span data-stu-id="9bb11-151">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="9bb11-152">Если ошибки отсутствуют, запрос проходит через оставшуюся часть конвейера.</span><span class="sxs-lookup"><span data-stu-id="9bb11-152">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="9bb11-153">Наконец, веб-API вызывает каждый фильтр проверки подлинности **ChallengeAsync** метод.</span><span class="sxs-lookup"><span data-stu-id="9bb11-153">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="9bb11-154">Этот метод использовать фильтры для добавьте запрос в ответ, при необходимости.</span><span class="sxs-lookup"><span data-stu-id="9bb11-154">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="9bb11-155">Обычно (но не всегда), может произойти в ответ на ошибку 401.</span><span class="sxs-lookup"><span data-stu-id="9bb11-155">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="9bb11-156">Ниже приведены два возможных варианта.</span><span class="sxs-lookup"><span data-stu-id="9bb11-156">The following diagrams show two possible cases.</span></span> <span data-ttu-id="9bb11-157">В первом фильтр проверки подлинности успешно проходит проверку подлинности запроса, фильтра авторизации авторизует запрос и действия контроллера возвращает код 200 (ОК).</span><span class="sxs-lookup"><span data-stu-id="9bb11-157">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="9bb11-158">Во втором примере фильтр проверки подлинности проверяет подлинность запроса, но фильтр авторизации возвращает 401 (не санкционировано).</span><span class="sxs-lookup"><span data-stu-id="9bb11-158">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="9bb11-159">В этом случае действия контроллера не вызывается.</span><span class="sxs-lookup"><span data-stu-id="9bb11-159">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="9bb11-160">Фильтр проверки подлинности добавляет заголовок Www-Authenticate в ответ.</span><span class="sxs-lookup"><span data-stu-id="9bb11-160">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="9bb11-161">Другие комбинации&mdash;к примеру, если действие контроллера допускает анонимные запросы, может потребоваться фильтр проверки подлинности, но без авторизации.</span><span class="sxs-lookup"><span data-stu-id="9bb11-161">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="9bb11-162">Реализация метода AuthenticateAsync</span><span class="sxs-lookup"><span data-stu-id="9bb11-162">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="9bb11-163">**AuthenticateAsync** метод пытается проверить подлинность запроса.</span><span class="sxs-lookup"><span data-stu-id="9bb11-163">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="9bb11-164">Ниже представлена подпись метода:</span><span class="sxs-lookup"><span data-stu-id="9bb11-164">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="9bb11-165">**AuthenticateAsync** метода необходимо выполнить одно из следующих действий:</span><span class="sxs-lookup"><span data-stu-id="9bb11-165">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="9bb11-166">Nothing (ничего).</span><span class="sxs-lookup"><span data-stu-id="9bb11-166">Nothing (no-op).</span></span>
2. <span data-ttu-id="9bb11-167">Создание **IPrincipal** и задайте его в запросе.</span><span class="sxs-lookup"><span data-stu-id="9bb11-167">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="9bb11-168">Задайте результат ошибки.</span><span class="sxs-lookup"><span data-stu-id="9bb11-168">Set an error result.</span></span>

<span data-ttu-id="9bb11-169">Параметра (1) означает запрос не содержал никаких учетных данных, которые понимает фильтр.</span><span class="sxs-lookup"><span data-stu-id="9bb11-169">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="9bb11-170">Параметра (2) означает фильтр успешно прошел проверку подлинности запроса.</span><span class="sxs-lookup"><span data-stu-id="9bb11-170">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="9bb11-171">Параметра (3) означает запрос имеет недействительные учетные данные (например, неверный пароль), активизирующий ответ с ошибкой.</span><span class="sxs-lookup"><span data-stu-id="9bb11-171">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="9bb11-172">Вот общую структуру для реализации **AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="9bb11-172">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="9bb11-173">Поиск учетных данных в запросе.</span><span class="sxs-lookup"><span data-stu-id="9bb11-173">Look for credentials in the request.</span></span>
2. <span data-ttu-id="9bb11-174">Если никакие учетные данные, не выполняют никаких действий и возвращают (холостой).</span><span class="sxs-lookup"><span data-stu-id="9bb11-174">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="9bb11-175">Если учетные данные, но фильтр не удается распознать схему проверки подлинности, не выполняют никаких действий и возвращают (холостой).</span><span class="sxs-lookup"><span data-stu-id="9bb11-175">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="9bb11-176">Еще одним фильтром в конвейере может понять схему.</span><span class="sxs-lookup"><span data-stu-id="9bb11-176">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="9bb11-177">Если учетные данные, которые понимает фильтр, попробуйте проверить их подлинность.</span><span class="sxs-lookup"><span data-stu-id="9bb11-177">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="9bb11-178">Если учетные данные являются неисправными, возврата 401, задав `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="9bb11-178">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="9bb11-179">Если учетные данные являются допустимыми, создайте **IPrincipal** и задайте `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="9bb11-179">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="9bb11-180">В коде показано выполните **AuthenticateAsync** метода из [обычной проверки подлинности](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) образца.</span><span class="sxs-lookup"><span data-stu-id="9bb11-180">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) sample.</span></span> <span data-ttu-id="9bb11-181">Комментарии указывают каждого шага.</span><span class="sxs-lookup"><span data-stu-id="9bb11-181">The comments indicate each step.</span></span> <span data-ttu-id="9bb11-182">В примере несколько типов ошибок: заголовок Authorization без учетных данных, имеет неправильный формат учетные данные и неверные имя пользователя и пароль.</span><span class="sxs-lookup"><span data-stu-id="9bb11-182">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="9bb11-183">Параметр результат ошибки</span><span class="sxs-lookup"><span data-stu-id="9bb11-183">Setting an Error Result</span></span>

<span data-ttu-id="9bb11-184">Если учетные данные недействительны, необходимо задать фильтр `context.ErrorResult` для **IHttpActionResult** , создает ответ с ошибкой.</span><span class="sxs-lookup"><span data-stu-id="9bb11-184">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="9bb11-185">Дополнительные сведения о **IHttpActionResult**, в разделе [результаты действий в веб-API 2](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="9bb11-185">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="9bb11-186">Обычная проверка подлинности пример включает `AuthenticationFailureResult` класс, который подходит для этой цели.</span><span class="sxs-lookup"><span data-stu-id="9bb11-186">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="9bb11-187">Реализация ChallengeAsync</span><span class="sxs-lookup"><span data-stu-id="9bb11-187">Implementing ChallengeAsync</span></span>

<span data-ttu-id="9bb11-188">Назначение **ChallengeAsync** метод является добавление запросов проверки подлинности в ответ, при необходимости.</span><span class="sxs-lookup"><span data-stu-id="9bb11-188">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="9bb11-189">Ниже представлена подпись метода:</span><span class="sxs-lookup"><span data-stu-id="9bb11-189">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="9bb11-190">Метод вызывается для каждого фильтра проверки подлинности в конвейере.</span><span class="sxs-lookup"><span data-stu-id="9bb11-190">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="9bb11-191">Важно понимать, что **ChallengeAsync** называется *перед* HTTP-ответа создан и возможно даже до выполнения действия контроллера.</span><span class="sxs-lookup"><span data-stu-id="9bb11-191">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="9bb11-192">Когда **ChallengeAsync** вызове `context.Result` содержит **IHttpActionResult**, который впоследствии используется для создания HTTP-ответа.</span><span class="sxs-lookup"><span data-stu-id="9bb11-192">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="9bb11-193">Поэтому если **ChallengeAsync** будет вызван, ничего не известно о HTTP-ответа еще.</span><span class="sxs-lookup"><span data-stu-id="9bb11-193">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="9bb11-194">**ChallengeAsync** метод заменяют исходное значение `context.Result` с новым **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="9bb11-194">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="9bb11-195">Это **IHttpActionResult** необходимо заключить исходного `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="9bb11-195">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="9bb11-196">Мы будем называть исходного **IHttpActionResult** *внутренний результирующий*и новый **IHttpActionResult** *внешнего результат*.</span><span class="sxs-lookup"><span data-stu-id="9bb11-196">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="9bb11-197">Внешнее результат необходимо сделать следующее.</span><span class="sxs-lookup"><span data-stu-id="9bb11-197">The outer result must do the following:</span></span>

1. <span data-ttu-id="9bb11-198">Вызов внутреннего результата для создания HTTP-ответа.</span><span class="sxs-lookup"><span data-stu-id="9bb11-198">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="9bb11-199">Изучите этот ответ.</span><span class="sxs-lookup"><span data-stu-id="9bb11-199">Examine the response.</span></span>
3. <span data-ttu-id="9bb11-200">Добавьте запрос проверки подлинности в ответ, при необходимости.</span><span class="sxs-lookup"><span data-stu-id="9bb11-200">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="9bb11-201">Следующий пример взят из примера обычной проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="9bb11-201">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="9bb11-202">Он определяет **IHttpActionResult** для внешнего результата.</span><span class="sxs-lookup"><span data-stu-id="9bb11-202">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="9bb11-203">`InnerResult` Свойство содержит внутренний **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="9bb11-203">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="9bb11-204">`Challenge` Свойство представляет заголовок Www-Authentication.</span><span class="sxs-lookup"><span data-stu-id="9bb11-204">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="9bb11-205">Обратите внимание, что **ExecuteAsync** сначала вызывает `InnerResult.ExecuteAsync` для создания HTTP-ответа и при необходимости добавляет в запрос.</span><span class="sxs-lookup"><span data-stu-id="9bb11-205">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="9bb11-206">Перед добавлением на запрос проверки кода ответа.</span><span class="sxs-lookup"><span data-stu-id="9bb11-206">Check the response code before adding the challenge.</span></span> <span data-ttu-id="9bb11-207">Большинство схем проверки подлинности только добавить запрос в случае ответ 401, как показано ниже.</span><span class="sxs-lookup"><span data-stu-id="9bb11-207">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="9bb11-208">Однако некоторые схемы проверки подлинности добавить запрос в сообщение об успешном выполнении.</span><span class="sxs-lookup"><span data-stu-id="9bb11-208">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="9bb11-209">Например, в разделе [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="9bb11-209">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="9bb11-210">Получает `AddChallengeOnUnauthorizedResult` класса фактический код в **ChallengeAsync** является простым.</span><span class="sxs-lookup"><span data-stu-id="9bb11-210">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="9bb11-211">Просто создать результат и присоединить его к `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="9bb11-211">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="9bb11-212">Примечание: В образце обычной проверки подлинности абстрагирует эту логику немного, путем помещения его в метод расширения.</span><span class="sxs-lookup"><span data-stu-id="9bb11-212">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="9bb11-213">Объединение фильтры проверки подлинности с помощью проверки подлинности на уровне узла</span><span class="sxs-lookup"><span data-stu-id="9bb11-213">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="9bb11-214">«Проверка подлинности на уровне узла» является проверки подлинности, выполняемая узлом (например IIS), прежде чем платформа запрос достигает веб-API.</span><span class="sxs-lookup"><span data-stu-id="9bb11-214">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="9bb11-215">Часто можно включить проверку подлинности на уровне узла для остальной части приложения, но отключить ее для контроллеров веб-API.</span><span class="sxs-lookup"><span data-stu-id="9bb11-215">Often, you may want to to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="9bb11-216">Например типичный сценарий — включить проверку подлинности форм на уровне узла, но использовать токены проверки подлинности для веб-API.</span><span class="sxs-lookup"><span data-stu-id="9bb11-216">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="9bb11-217">Чтобы отключить проверку подлинности на уровне узла в конвейер веб-API, вызвать `config.SuppressHostPrincipal()` в конфигурации.</span><span class="sxs-lookup"><span data-stu-id="9bb11-217">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="9bb11-218">В результате веб-API удалить **IPrincipal** из любого запроса, которое поступает в конвейер веб-API.</span><span class="sxs-lookup"><span data-stu-id="9bb11-218">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="9bb11-219">По сути, оно &quot;un-проверяет подлинность&quot; запроса.</span><span class="sxs-lookup"><span data-stu-id="9bb11-219">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="9bb11-220">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="9bb11-220">Additional Resources</span></span>

<span data-ttu-id="9bb11-221">[Фильтры безопасности ASP.NET Web API](https://msdn.microsoft.com/magazine/dn781361.aspx) (журнал MSDN)</span><span class="sxs-lookup"><span data-stu-id="9bb11-221">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>

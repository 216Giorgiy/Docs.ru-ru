---
uid: web-api/overview/security/authentication-filters
title: "Фильтры проверки подлинности в ASP.NET Web API 2 | Документы Microsoft"
author: MikeWasson
description: "Фильтр проверки подлинности — это компонент, который выполняет проверку подлинности HTTP-запроса. Веб-API 2 и MVC 5 и поддерживать фильтры проверки подлинности, но немного отличаться..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 09/25/2014
ms.topic: article
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: 16e451f52799625983368bc938091eff47019b52
ms.sourcegitcommit: 016f4d58663bcd442930227022de23fb3abee0b3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/12/2018
---
<a name="authentication-filters-in-aspnet-web-api-2"></a>Фильтры проверки подлинности в ASP.NET Web API 2
====================
по [Mike Wasson](https://github.com/MikeWasson)

> Фильтр проверки подлинности — это компонент, который выполняет проверку подлинности HTTP-запроса. Веб-API 2 и MVC 5 и поддерживать фильтры проверки подлинности, но они незначительно отличаются в основном соглашения об именовании для интерфейса фильтра. В этом разделе описываются фильтры проверки подлинности веб-API.


Фильтры проверки подлинности позволяют задать схему проверки подлинности для отдельных контроллеров или действий. Таким образом, приложение может поддерживать различных механизмов проверки подлинности для разных ресурсов HTTP.

В этой статье я покажу кода из [обычной проверки подлинности](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) пример [http://aspnet.codeplex.com](http://aspnet.codeplex.com). В этом примере фильтр проверки подлинности, который реализует схему HTTP, обычной проверки подлинности доступа (RFC 2617). Фильтр реализуется в классе с именем `IdentityBasicAuthenticationAttribute`. Я не буду весь код из примера частей, которые показывают, как написать фильтр проверки подлинности.

## <a name="setting-an-authentication-filter"></a>Настройка фильтрации по проверки подлинности

Как и другие фильтры фильтры проверки подлинности может быть применен контроллера action и глобально для всех контроллеров веб-API.

Чтобы применить фильтр проверки подлинности к контроллеру, декорировать класс контроллера с атрибутом фильтра. Следующий код задает `[IdentityBasicAuthentication]` фильтр на класс контроллера, который включает обычную проверку подлинности для всех действий в контроллере.

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

Чтобы применить фильтр к одно действие, кодировке действие фильтра. Следующий код задает `[IdentityBasicAuthentication]` фильтра на контроллере `Post` метод.

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

Чтобы применить фильтр ко всем контроллерам веб-API, добавьте его в **GlobalConfiguration.Filters**.

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a>Реализация проверки подлинности API веб-фильтра

В веб-API проверки подлинности фильтры реализуют [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) интерфейса. Они также должны наследоваться от **System.Attribute**, чтобы применить в качестве атрибутов.

**IAuthenticationFilter** интерфейса есть два метода:

- **AuthenticateAsync** проверяет подлинность запроса путем проверки учетных данных в запросе, если он имеется.
- **ChallengeAsync** добавляет запрос проверки подлинности для HTTP-ответа, при необходимости.

Эти методы соответствуют поток проверки подлинности, определенных в [RFC 2612](http://tools.ietf.org/html/rfc2616) и [RFC 2617](http://tools.ietf.org/html/rfc2617):

1. Клиент отправляет учетные данные в заголовок авторизации. Обычно это происходит после того, клиент получает ответ 401 (несанкционированный) с сервера. Тем не менее клиент может отправлять учетные данные с любым запросом не только после получения 401.
2. Если сервер не принимает учетные данные, он возвращает ответ 401 (несанкционированный). Ответ включает заголовок Www-Authenticate, который содержит один или несколько задач. Каждый запрос указывает схему проверки подлинности распознана сервером.

Сервер также может вернуть 401 от анонимный запрос. На самом деле это обычно как инициируется процесс проверки подлинности:

1. Клиент отправляет анонимный запрос.
2. Сервер возвращает 401.
3. Клиенты повторно отправляет запрос с учетными данными.

Этот процесс включает в себя *проверки подлинности* и *авторизации* действия.

- Проверка подлинности удостоверяет подлинность клиента.
- Авторизация определяет, может ли клиент доступ к конкретному ресурсу.

В веб-API фильтры проверки подлинности обработки проверки подлинности, но не авторизации. Авторизации должен сделать фильтра авторизации или внутри действия контроллера.

Ниже приведена последовательность действий в конвейере веб-API 2:

1. До вызова действия, веб-API создает список фильтров проверки подлинности для этого действия. Сюда входят фильтры области действия, контроллера, область и глобальной области.
2. Веб-вызовы API **AuthenticateAsync** на каждый фильтр в списке. Каждый фильтр может проверить учетные данные, в запросе. Если фильтр успешно проверяет учетные данные, создает фильтр **IPrincipal** и присоединяет его к запросу. Фильтр может также вызывать ошибку на этом этапе. В этом случае оставшуюся часть конвейера не выполняется.
3. Если ошибки отсутствуют, запрос проходит через оставшуюся часть конвейера.
4. Наконец, веб-API вызывает каждый фильтр проверки подлинности **ChallengeAsync** метод. Этот метод использовать фильтры для добавьте запрос в ответ, при необходимости. Обычно (но не всегда), может произойти в ответ на ошибку 401.

Ниже приведены два возможных варианта. В первом фильтр проверки подлинности успешно проходит проверку подлинности запроса, фильтра авторизации авторизует запрос и действия контроллера возвращает код 200 (ОК).

![](authentication-filters/_static/image1.png)

Во втором примере фильтр проверки подлинности проверяет подлинность запроса, но фильтр авторизации возвращает 401 (не санкционировано). В этом случае действия контроллера не вызывается. Фильтр проверки подлинности добавляет заголовок Www-Authenticate в ответ.

![](authentication-filters/_static/image2.png)

Другие комбинации&mdash;к примеру, если действие контроллера допускает анонимные запросы, может потребоваться фильтр проверки подлинности, но без авторизации.

## <a name="implementing-the-authenticateasync-method"></a>Реализация метода AuthenticateAsync

**AuthenticateAsync** метод пытается проверить подлинность запроса. Ниже представлена подпись метода:

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

**AuthenticateAsync** метода необходимо выполнить одно из следующих действий:

1. Nothing (ничего).
2. Создание **IPrincipal** и задайте его в запросе.
3. Задайте результат ошибки.

Параметра (1) означает запрос не содержал никаких учетных данных, которые понимает фильтр. Параметра (2) означает фильтр успешно прошел проверку подлинности запроса. Параметра (3) означает запрос имеет недействительные учетные данные (например, неверный пароль), активизирующий ответ с ошибкой.

Вот общую структуру для реализации **AuthenticateAsync**.

1. Поиск учетных данных в запросе.
2. Если никакие учетные данные, не выполняют никаких действий и возвращают (холостой).
3. Если учетные данные, но фильтр не удается распознать схему проверки подлинности, не выполняют никаких действий и возвращают (холостой). Еще одним фильтром в конвейере может понять схему.
4. Если учетные данные, которые понимает фильтр, попробуйте проверить их подлинность.
5. Если учетные данные являются неисправными, возврата 401, задав `context.ErrorResult`.
6. Если учетные данные являются допустимыми, создайте **IPrincipal** и задайте `context.Principal`.

В коде показано выполните **AuthenticateAsync** метода из [обычной проверки подлинности](http://aspnet.codeplex.com/sourcecontrol/latest#Samples/WebApi/BasicAuthentication/ReadMe.txt) образца. Комментарии указывают каждого шага. В примере несколько типов ошибок: заголовок Authorization без учетных данных, имеет неправильный формат учетные данные и неверные имя пользователя и пароль.

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a>Параметр результат ошибки

Если учетные данные недействительны, необходимо задать фильтр `context.ErrorResult` для **IHttpActionResult** , создает ответ с ошибкой. Дополнительные сведения о **IHttpActionResult**, в разделе [результаты действий в веб-API 2](../getting-started-with-aspnet-web-api/action-results.md).

Обычная проверка подлинности пример включает `AuthenticationFailureResult` класс, который подходит для этой цели.

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a>Реализация ChallengeAsync

Назначение **ChallengeAsync** метод является добавление запросов проверки подлинности в ответ, при необходимости. Ниже представлена подпись метода:

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

Метод вызывается для каждого фильтра проверки подлинности в конвейере.

Важно понимать, что **ChallengeAsync** называется *перед* HTTP-ответа создан и возможно даже до выполнения действия контроллера. Когда **ChallengeAsync** вызове `context.Result` содержит **IHttpActionResult**, который впоследствии используется для создания HTTP-ответа. Поэтому если **ChallengeAsync** будет вызван, ничего не известно о HTTP-ответа еще. **ChallengeAsync** метод заменяют исходное значение `context.Result` с новым **IHttpActionResult**. Это **IHttpActionResult** необходимо заключить исходного `context.Result`.

![](authentication-filters/_static/image3.png)

Мы будем называть исходного **IHttpActionResult** *внутренний результирующий*и новый **IHttpActionResult** *внешнего результат*. Внешнее результат необходимо сделать следующее.

1. Вызов внутреннего результата для создания HTTP-ответа.
2. Изучите этот ответ.
3. Добавьте запрос проверки подлинности в ответ, при необходимости.

Следующий пример взят из примера обычной проверки подлинности. Он определяет **IHttpActionResult** для внешнего результата.

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

`InnerResult` Свойство содержит внутренний **IHttpActionResult**. `Challenge` Свойство представляет заголовок Www-Authentication. Обратите внимание, что **ExecuteAsync** сначала вызывает `InnerResult.ExecuteAsync` для создания HTTP-ответа и при необходимости добавляет в запрос.

Перед добавлением на запрос проверки кода ответа. Большинство схем проверки подлинности только добавить запрос в случае ответ 401, как показано ниже. Однако некоторые схемы проверки подлинности добавить запрос в сообщение об успешном выполнении. Например, в разделе [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).

Получает `AddChallengeOnUnauthorizedResult` класса фактический код в **ChallengeAsync** является простым. Просто создать результат и присоединить его к `context.Result`.

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

Примечание: В образце обычной проверки подлинности абстрагирует эту логику немного, путем помещения его в метод расширения.

## <a name="combining-authentication-filters-with-host-level-authentication"></a>Объединение фильтры проверки подлинности с помощью проверки подлинности на уровне узла

«Проверка подлинности на уровне узла» является проверки подлинности, выполняемая узлом (например IIS), прежде чем платформа запрос достигает веб-API.

Часто можно включить проверку подлинности на уровне узла для остальной части приложения, но отключить контроллеров веб-API. Например типичный сценарий — включить проверку подлинности форм на уровне узла, но использовать токены проверки подлинности для веб-API.

Чтобы отключить проверку подлинности на уровне узла в конвейер веб-API, вызвать `config.SuppressHostPrincipal()` в конфигурации. В результате веб-API удалить **IPrincipal** из любого запроса, которое поступает в конвейер веб-API. По сути, оно &quot;un-проверяет подлинность&quot; запроса.

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a>Дополнительные ресурсы

[Фильтры безопасности ASP.NET Web API](https://msdn.microsoft.com/magazine/dn781361.aspx) (журнал MSDN)

---
uid: web-api/overview/data/using-web-api-with-entity-framework/part-4
title: Обработка отношениями сущностей | Документы Microsoft
author: MikeWasson
description: ''
ms.author: aspnetcontent
manager: wpickett
ms.date: 06/16/2014
ms.topic: article
ms.assetid: d2f5710c-23c7-40a5-9cd9-5d0516570cba
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/data/using-web-api-with-entity-framework/part-4
msc.type: authoredcontent
ms.openlocfilehash: 3c82724739b8ccb7c6b13788a5420af1e61c990b
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
ms.locfileid: "30872693"
---
<a name="handling-entity-relations"></a>Обработка отношениями сущностей
====================
по [Mike Wasson](https://github.com/MikeWasson)

[Загрузка завершенного проекта](https://github.com/MikeWasson/BookService)

В этом разделе приводятся некоторые сведения, как EF загружает связанные сущности и как обрабатывать циклических переходов свойства в классах модели. (Этот раздел предоставляет фундаментальных знаний и не требуется для завершения работы с учебником. Если вы предпочитаете, перейдите к [. часть 5.](part-5.md).)

## <a name="eager-loading-versus-lazy-loading"></a>Eager загрузка сравнению отложенная загрузка

При использовании EF с реляционной базой данных, важно понимать, каким образом EF загружает связанные данные.

Также полезно для просмотра запросов SQL, EF приводит к возникновению ошибки. Для трассировки SQL, добавьте следующую строку кода, `BookServiceContext` конструктор:

[!code-csharp[Main](part-4/samples/sample1.cs)]

При отправке запроса GET для /api/books, он возвращает JSON следующим образом:

[!code-console[Main](part-4/samples/sample2.cmd)]

Вы увидите в свойстве Author пуст, несмотря на то, что в книге содержатся допустимые AuthorId. Это потому, что EF не загружает связанные сущности автора. Это подтверждается журнал трассировки SQL-запроса:

[!code-console[Main](part-4/samples/sample3.sql)]

Инструкция SELECT принимает из электронной таблицы и не ссылаются на таблицу автора.

Для справки ниже приведен метод в `BooksController` класс, который возвращает список книг.

[!code-csharp[Main](part-4/samples/sample4.cs)]

Давайте посмотрим, как может возвращать автора как часть данных JSON. Существует три способа загрузки связанных данных в Entity Framework: упреждающую отложенную загрузку и явная загрузка. Существуют преимущества и недостатки, с помощью каждого метода, поэтому очень важно понять, как они работают.

### <a name="eager-loading"></a>Активная загрузка

С *упреждающую*, EF загружает связанные сущности как часть запроса начальную базу данных. Чтобы выполнить упреждающую, используйте **System.Data.Entity.Include** метода расширения.

[!code-csharp[Main](part-4/samples/sample5.cs)]

Это заставляет EF, чтобы включить данные автора в запросе. Если этого не сделать и запустить приложение, теперь данные JSON выглядит следующим образом:

[!code-console[Main](part-4/samples/sample6.cmd)]

Журнал трассировки показывает, что EF выполняется соединение таблиц книги и автор.

[!code-console[Main](part-4/samples/sample7.cmd)]

### <a name="lazy-loading"></a>Отложенная загрузка

С отложенной загрузкой EF автоматически загружает связанные сущности при разыменовании свойство навигации для этой сущности. Чтобы включить отложенную загрузку, создать виртуальный свойства навигации. Например в класс книги:

[!code-csharp[Main](part-4/samples/sample8.cs?highlight=6)]

Теперь рассмотрим следующий код:

[!code-csharp[Main](part-4/samples/sample9.cs)]

Если отложенная загрузка включена, доступ к `Author` свойство `books[0]` вызывает EF запросов к базе данных для автора.

Отложенная загрузка требует несколько обмена базы данных, так как EF отправляет запрос каждый раз, он извлекает связанной сущности. Как правило требуется отложенная загрузка отключена для объектов, которые можно сериализовать. Сериализатор должен читать все свойства в модели, которая запускает загрузка связанных сущностей. Например ниже приведено SQL-запросы, когда EF сериализует список книг с отложенной загрузкой включена. Вы увидите, что EF делает три разных запросов для авторов три.

[!code-console[Main](part-4/samples/sample10.sql)]

Существует еще раз, когда может потребоваться использовать отложенную загрузку. Безотложная загрузка может привести к EF для создания очень сложные соединения. Связанные сущности, которые могут потребоваться для небольшого подмножества данных и отложенная загрузка будет более эффективным.

Сериализовать объекты передачи данных (DTO) вместо сущности является одним из способов избежать проблем при сериализации. Далее в этой статье мы рассмотрим этот подход.

### <a name="explicit-loading"></a>Явная загрузка

Явная загрузка похожа на отложенную загрузку, за исключением того, что явным образом получать взаимосвязанные данные в коде; Это не происходит автоматически при доступе к свойству навигации. Явная загрузка обеспечивает больший контроль над тем, когда для загрузки связанных данных, но требует дополнительного кода. Дополнительные сведения о явная загрузка см. в разделе [загрузка связанных сущностей](https://msdn.microsoft.com/data/jj574232#explicit).

## <a name="navigation-properties-and-circular-references"></a>Свойства навигации и циклические ссылки

Когда определены в моделях книги и автор, определены свойством навигации на `Book` класс для связи автор книги, но в обратном направлении не я определял свойство навигации.

Что произойдет, если добавить соответствующее свойство навигации для `Author` класса?

[!code-csharp[Main](part-4/samples/sample11.cs?highlight=7)]

К сожалению это создает проблему при сериализации модели. При загрузке связанных данных, он создает граф объекта.

![](part-4/_static/image1.png)

Когда модуль форматирования в формате JSON или XML пытается сериализации графа, он вызовет исключение. Двумя модулями форматирования вызывают исключение другого сообщения. Ниже приведен пример форматирования JSON:

[!code-console[Main](part-4/samples/sample12.cmd)]

Вот модуль форматирования XML.

[!code-xml[Main](part-4/samples/sample13.xml)]

Одним из решений является использование DTO, описывающие в следующем разделе. Кроме того можно настроить форматирования данных JSON и XML для обработки графа циклов. Дополнительные сведения см. в разделе [обработки циклических ссылок объекта](../../formats-and-model-binding/json-and-xml-serialization.md#handling_circular_object_references).

В этом учебнике не требуется `Author.Book` свойство навигации, поэтому его можно опустить.

> [!div class="step-by-step"]
> [Назад](part-3.md)
> [Вперед](part-5.md)

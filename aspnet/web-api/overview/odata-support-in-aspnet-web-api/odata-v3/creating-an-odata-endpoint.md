---
uid: web-api/overview/odata-support-in-aspnet-web-api/odata-v3/creating-an-odata-endpoint
title: "Создание конечной точки OData v3 с веб-API 2 | Документы Microsoft"
author: MikeWasson
description: "Протокол Open Data Protocol (OData) — это протокол доступа к данным для веб. OData предоставляет единообразный способ структуру данных, запроса данных и работы с данными..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 02/25/2014
ms.topic: article
ms.assetid: 262843d6-43a2-4f1c-82d9-0b90ae6df0cf
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/odata-support-in-aspnet-web-api/odata-v3/creating-an-odata-endpoint
msc.type: authoredcontent
ms.openlocfilehash: 33fe4d764bf9bf64c852f1269255925b5cc42536
ms.sourcegitcommit: 016f4d58663bcd442930227022de23fb3abee0b3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/12/2018
---
<a name="creating-an-odata-v3-endpoint-with-web-api-2"></a>Создание конечной точки OData v3 с веб-API 2
====================
по [Mike Wasson](https://github.com/MikeWasson)

[Загрузка завершенного проекта](http://code.msdn.microsoft.com/ASPNET-Web-API-OData-cecdb524)

> [Open Data Protocol](http://www.odata.org/) (OData) — это протокол доступа к данным для веб. OData предоставляет единообразный способ структуру данных, запрашивать данные и управлять набором данных посредством операций CRUD (Создание, чтение, обновление и удаление). OData поддерживает AtomPub (XML) и форматах JSON. OData также определяет способ предоставления метаданных о данных. Клиенты могут использовать метаданные для обнаружения информации о типе и связи в наборе данных.
> 
> Веб-API ASP.NET позволяет легко создать конечную точку OData для набора данных. Можно управлять, конечная точка поддерживает только операции, которые OData. Можно разместить несколько конечных точек OData, наряду с конечными точками не OData. У вас есть полный контроль над вашей модели данных, серверную бизнес-логики и уровень данных.
> 
> ## <a name="software-versions-used-in-the-tutorial"></a>Версии программного обеспечения, используемая в этом учебнике
> 
> 
> - [Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/2013-downloads)
> - Веб-API 2
> - OData версии 3
> - Entity Framework 6
> - [Fiddler Web отладки прокси-сервера (необязательно)](http://www.fiddler2.com)
> 
> Поддержка API OData Web была добавлена в [ASP.NET и веб-средства 2012.2 обновление](https://go.microsoft.com/fwlink/?LinkId=282650). Однако в этом учебнике используется формирование шаблонов, который был добавлен в Visual Studio 2013.


В этом учебнике вы создадите простой конечной точки OData, клиенты могут выполнять запросы. Вы также создадите клиент C# для конечной точки. После завершения этого учебника, следующий набор учебников показывают, как добавить дополнительную функциональность, включая отношения сущностей, действия, и выберите развернуть $ $.

- [Создание проекта Visual Studio](#create-project)
- [Добавление модели сущностей](#add-model)
- [Добавить контроллер OData](#add-controller)
- [Добавление модели EDM и маршрута](#edm)
- [Начальное значение базы данных (необязательно)](#seed-db)
- [Изучение конечной точки OData](#explore)
- [Форматы сериализации OData](#formats)

<a id="create-project"></a>
## <a name="create-the-visual-studio-project"></a>Создание проекта Visual Studio

В этом учебнике создается конечная точка OData, которая поддерживает основные операции CRUD. Конечная точка будет предоставлять один ресурс, список продуктов. Учебники по более поздней версии будут добавлены дополнительные функции.

Запустите Visual Studio и выберите **новый проект** с начальной страницы. Или из **файл** последовательно выберите пункты **New** и затем **проекта**.

В **шаблоны** выберите **установленные шаблоны** и разверните узел Visual C#. В разделе **Visual C#**выберите **Web**. Выберите **веб-приложение ASP.NET** шаблона.

![](creating-an-odata-endpoint/_static/image1.png)

В **новый проект ASP.NET** диалогового окна выберите **пустой** шаблона. В разделе &quot;добавить папки и основные ссылки для... &quot;, проверьте **веб-API**. Нажмите кнопку **ОК**.

![](creating-an-odata-endpoint/_static/image2.png)

<a id="add-model"></a>
## <a name="add-an-entity-model"></a>Добавление модели сущностей

*Модель* — это объект, представляющий данные в приложении. В этом учебнике мы должны модель, которая представляет продукт. Модель соответствует нашей тип сущности OData.

В обозревателе решений щелкните правой кнопкой мыши папку модели. В контекстном меню выберите **добавить** выберите **класса**.

![](creating-an-odata-endpoint/_static/image3.png)

В **добавить новое** товара диалогового окна, задайте имя для класса &quot;продукта&quot;.

![](creating-an-odata-endpoint/_static/image4.png)

> [!NOTE]
> По соглашению классы модели, помещаются в папку Models. Нет необходимости соответствуют этому соглашению в собственных проектах, но оно будет использоваться для этого учебника.


В файле Product.cs добавьте следующее определение класса:

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample1.cs)]

Свойство идентификатора будет ключ сущности. Клиенты могут запрашивать продуктов по идентификатору. Это поле также будет первичного ключа в серверную базу данных.

Выполните построение проекта. На следующем шаге мы будем использовать некоторые формирование шаблонов Visual Studio, который использует отражение, чтобы определить тип продукта.

<a id="add-controller"></a>
## <a name="add-an-odata-controller"></a>Добавить контроллер OData

Объект *контроллера* — это класс, который обрабатывает HTTP-запросы. Можно определить отдельные контроллера для каждого набора сущностей в службы OData. В этом учебнике мы создадим одного контроллера.

В обозревателе решений щелкните правой кнопкой мыши папку Controllers. Выберите **добавить** , а затем выберите **контроллера**.

![](creating-an-odata-endpoint/_static/image5.png)

В **Добавление формирования шаблонов** диалогового окна выберите &quot;Web API 2 OData контроллер с действиями, использующий Entity Framework&quot;.

![](creating-an-odata-endpoint/_static/image6.png)

В **добавить контроллер** диалога, имя контроллера «ProductsController». Выберите &quot;использовать асинхронные действия контроллера&quot; флажок. В **модель** раскрывающегося списка выберите класс продукта.

![](creating-an-odata-endpoint/_static/image7.png)

Нажмите кнопку **новый контекст данных...**  кнопки. Оставьте имя по умолчанию для типа контекста данных и нажмите кнопку **добавить**.

![](creating-an-odata-endpoint/_static/image8.png)

В диалоговом окне Добавить контроллер Добавление контроллера нажмите кнопку "Добавить".

![](creating-an-odata-endpoint/_static/image9.png)

Примечание: Если вы получаете сообщение об ошибке с сообщением, &quot;произошла ошибка при получении типа... &quot;, убедитесь, что построение проекта Visual Studio после добавления класса Product. Формирование шаблонов использует отражение для поиска класса.

![](creating-an-odata-endpoint/_static/image10.png)

Формирование шаблонов добавляет в проект двух файлах кода:

- Products.cs определяет контроллера веб-API, который реализует конечной точкой OData.
- ProductServiceContext.cs предоставляет методы запросов к основной базе данных с помощью платформы Entity Framework.

![](creating-an-odata-endpoint/_static/image11.png)

<a id="edm"></a>
## <a name="add-the-edm-and-route"></a>Добавление модели EDM и маршрута

В обозревателе решений разверните приложение\_запустите папку и откройте файл с именем WebApiConfig.cs. Этот класс содержит код конфигурации для веб-API. Замените этот код следующим кодом:

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample2.cs)]

Этот код выполняет следующие операции:

- Создает модель данных сущности (EDM) для конечной точки OData.
- Добавляет маршрут для конечной точки.

EDM-это абстрактный модель данных. Модель EDM используется для создания документов метаданных и определения URL-адреса для службы. **ODataConventionModelBuilder** создает EDM с помощью набора соглашения об именовании по умолчанию модели EDM. Этот подход требует наименьшего объема кода. Если требуется больший контроль над модели EDM, можно использовать **ODataModelBuilder** класса для создания модели EDM, добавив явным образом свойства, ключи и свойства навигации.

**EntitySet** метод добавляет к модели EDM набор сущностей:

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample3.cs)]

Строка «Продукты» определяет имя набора сущностей. Имя контроллера, должно соответствовать имени набора сущностей. В этом учебнике набор сущностей, который называется «Продукты», именем контроллера `ProductsController`. Если вы присвоили «ProductSet» набор сущностей, будет назван контроллера `ProductSetController`. Обратите внимание, что конечная точка может иметь несколько наборов сущностей. Вызовите **EntitySet&lt;T&gt;**  для каждой сущности значение, а затем определите соответствующий контроллер.

**MapODataRoute** метод добавляет маршрут для конечной точки OData.

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample4.cs)]

Первый параметр — понятное имя для маршрута. Клиенты службы, это имя не отображается. Второй параметр — префикс URI для конечной точки. Этот код, URI для набора сущностей Products задан http://*hostname*  /odata и продуктов. Приложение может иметь более одной конечной точки OData. Для каждой конечной точки, вызовите **MapODataRoute** и укажите имя уникального маршрута и уникальный префикс URI.

<a id="seed-db"></a>
## <a name="seed-the-database-optional"></a>Начальное значение базы данных (необязательно)

На этом шаге используется Entity Framework в качестве начального базы данных с некоторые тестовые данные. Этот шаг необязателен, но он позволяет немедленно тестирование конечной точки OData.

Из **средства** последовательно выберите пункты **диспетчер пакетов библиотеки**, а затем выберите **консоль диспетчера пакетов**. В окне консоли диспетчера пакетов введите следующую команду:

[!code-console[Main](creating-an-odata-endpoint/samples/sample5.cmd)]

Это добавляет папку с именем миграция и файл кода с именем Configuration.cs.

![](creating-an-odata-endpoint/_static/image12.png)

Откройте этот файл и добавьте следующий код в `Configuration.Seed` метод.

[!code-csharp[Main](creating-an-odata-endpoint/samples/sample6.cs)]

В окне консоли диспетчера пакетов введите следующие команды:

[!code-console[Main](creating-an-odata-endpoint/samples/sample7.cmd)]

Эти команды создают код, создает базу данных, а затем выполняет этот код.

<a id="explore"></a>
## <a name="exploring-the-odata-endpoint"></a>Изучение конечной точки OData

В этом разделе мы будем использовать [отладки веб-прокси Fiddler](http://www.fiddler2.com) для отправки запросов к конечной точке и изучения ответные сообщения. Это поможет вам понять возможности конечной точки OData.

В Visual Studio нажмите клавишу F5 для запуска отладки. По умолчанию Visual Studio открывает в браузере `http://localhost:*port*`, где *порт* — номер порта, настроенного в параметрах проекта.

Можно изменить номер порта в параметрах проекта. В обозревателе решений щелкните правой кнопкой мыши проект и выберите **свойства**. В окне «Свойства» выберите **Web**. Введите номер порта в **URL-адрес проекта**.

### <a name="service-document"></a>Сервисный документ

*Сервисный документ* содержит список наборов сущностей для конечной точки OData. Чтобы получить Сервисный документ, отправка запроса GET для корневой URI службы.

С помощью Fiddler, введите следующий URI в **Composer** вкладка: `http://localhost:port/odata/`, где *порт* — номер порта.

![](creating-an-odata-endpoint/_static/image13.png)

Нажмите кнопку **Execute** кнопки. Fiddler приложение отправляет запрос HTTP GET. Должны появиться в списке веб-сеансами ответа. Если все работает, код состояния будет 200.

![](creating-an-odata-endpoint/_static/image14.png)

Дважды щелкните в списке веб-сеансами, чтобы просмотреть сведения о ответное сообщение на вкладке инспекторы ответа.

![](creating-an-odata-endpoint/_static/image15.png)

Необработанные сообщения HTTP-ответа должен выглядеть следующим образом:

[!code-console[Main](creating-an-odata-endpoint/samples/sample8.cmd)]

По умолчанию веб-API возвращает Сервисный документ в формате AtomPub. Чтобы запросить JSON, добавьте следующий заголовок HTTP-запроса:

`Accept: application/json`

![](creating-an-odata-endpoint/_static/image16.png)

Теперь в HTTP-ответе содержит полезные данные JSON:

[!code-console[Main](creating-an-odata-endpoint/samples/sample9.cmd)]

### <a name="service-metadata-document"></a>Документ метаданных службы

*Документ метаданных службы* описывается модель данных службы на языке XML вызывается язык определения концептуальной схемы (CSDL). Документ метаданных показана структура данных в службе и может использоваться для создания кода клиента.

Чтобы получить документ метаданных, отправка запроса GET к `http://localhost:port/odata/$metadata`. Вот метаданных для конечной точки, показанными в данном руководстве.

[!code-console[Main](creating-an-odata-endpoint/samples/sample10.cmd)]

### <a name="entity-set"></a>Набор сущностей

Для получения набора сущностей Products, отправьте запрос GET к `http://localhost:port/odata/Products`.

[!code-console[Main](creating-an-odata-endpoint/samples/sample11.cmd)]

### <a name="entity"></a>Объект

Для получения конкретного продукта, отправьте запрос GET к `http://localhost:port/odata/Products(1)`, где «1» — идентификатор продукта.

[!code-console[Main](creating-an-odata-endpoint/samples/sample12.cmd)]

<a id="formats"></a>
## <a name="odata-serialization-formats"></a>Форматы сериализации OData

OData поддерживает несколько форматов сериализации:

- Публикации Atom (XML)
- JSON «light» (появился в OData v3)
- JSON «verbose» (OData v2)

По умолчанию веб-API в формате AtomPubJSON «light». 

Чтобы получить формат AtomPub, задайте заголовок Accept значение «application/atom + xml». Ниже приведен пример текста ответа.

[!code-console[Main](creating-an-odata-endpoint/samples/sample13.cmd)]

Вы увидите одним из очевидных недостатков формат Atom: это гораздо более подробным по сравнению JSON light. Тем не менее если у вас есть клиент, который понимает AtomPub, клиент может предпочтение этого формата JSON.

Вот JSON облегченную версию той же сущности.

[!code-console[Main](creating-an-odata-endpoint/samples/sample14.cmd)]

Формат JSON light появилась в версии 3 протокола OData. Для обеспечения обратной совместимости клиент может запрашивать старый формат JSON «verbose». Запрос verbose JSON, задайте для заголовка Accept `application/json;odata=verbose`. Ниже приведен подробный версии.

[!code-console[Main](creating-an-odata-endpoint/samples/sample15.cmd)]

Этот формат передает дополнительные метаданные в текст ответа, который можно добавить значительную нагрузку на весь сеанс. Кроме того он добавляет уровень косвенности, заключив объект в свойство с именем «d».

## <a name="next-steps"></a>Следующие шаги

- [Добавление связей сущностей](working-with-entity-relations.md)
- [Добавление действия OData](odata-actions.md)
- [Вызов службы OData из клиента .NET](calling-an-odata-service-from-a-net-client.md)

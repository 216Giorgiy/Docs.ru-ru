---
uid: identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
title: Перенос данных универсальной поставщик членства и профили пользователей для ASP.NET Identity (C#) | Документы Microsoft
author: rustd
description: Этот учебник описывает шаги, необходимые для переноса пользователей и роли данных и данных профилей пользователей, созданные с помощью универсальные поставщики существующего приложения...
ms.author: aspnetcontent
manager: wpickett
ms.date: 12/13/2013
ms.topic: article
ms.assetid: 2e260430-d13c-4658-bd05-e256fc0d63b8
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: f65f93b20543d06ea70a9009b6921e297477c99e
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
ms.locfileid: "30871575"
---
<a name="migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity-c"></a>Перенос данных универсальной поставщик членства и профили пользователей для ASP.NET Identity (C#)
====================
по [Pranav Rastogi](https://github.com/rustd), [Рик Андерсон](https://github.com/Rick-Anderson), [Robert McMurray](https://github.com/rmcmurray), [Suhas Joshi](https://github.com/suhasj)

> Этот учебник описывает шаги, необходимые для переноса пользователя и роли данных и данных профилей пользователей, созданные с помощью универсальные поставщики, уже существующего приложения ASP.NET Identity модели. Этот подход указанные здесь, можно использовать для переноса данных профиля пользователя в приложении с членством SQL, а также.


С выпуском Visual Studio 2013, команда ASP.NET появилась новая система ASP.NET Identity и можно прочитать подробнее об этом выпуске [здесь](../../index.md). Отслеживание статьи для переноса веб-приложений из [членства SQL до новой системы удостоверений](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md), в этой статье приведены шаги для переноса существующих приложений, которые следуют модели поставщиков для управления пользователями и роль для новой модели удостоверения. Фокус этого учебника будет в первую очередь для переноса данных профиля пользователя в легко подключить его в новой системе. Перенос пользователей и сведений о ролях похоже на членства SQL. В приложении с членством SQL также можно использовать подход, а затем для переноса данных профиля.

Например мы начнем с веб-приложения, созданные с помощью Visual Studio 2012, которая использует модель поставщиков. Мы будем затем добавьте код для управления профилями, регистрации пользователя, добавить данные профиля для пользователей, переноса схемы базы данных и измените приложения для использования системы удостоверений для управления пользователями и роль. Для проверки миграции пользователей, созданных с помощью универсальные поставщики должны иметь возможность выполнить вход и новые пользователи должны иметь возможность регистрации.

> [!NOTE]
> Можно найти полный пример на [ https://github.com/suhasj/UniversalProviders-Identity-Migrations ](https://github.com/suhasj/UniversalProviders-Identity-Migrations).


## <a name="profile-data-migration-summary"></a>Сводка по миграции данных профиля

Перед началом работы с миграций, рассмотрим то же самое, что и сохранение данных профиля в модели поставщиков. Данные профилирования для приложения, которые пользователи могут храниться несколькими способами, наиболее распространенные из них выполняется с помощью поставщиков встроенных профилей, поставляемых вместе с универсальные поставщики. Включить действия

1. Добавьте класс, имеющий свойства, используемые для хранения данных профиля.
2. Добавьте класс, который расширяет «ProfileBase» и реализует методы получения выше данные профиля для пользователя.
3. Разрешить использование поставщиков профиль по умолчанию в *web.config* файла и определения класса, объявленного в шаге 2 # для использования в доступе к сведениям профиля.

Сведения о профиле сохраняется как сериализованный xml и двоичные данные в таблице «Профили» в базе данных.

После миграции приложения на использование новой системы ASP.NET Identity, сведения о профиле десериализовать и хранятся в виде свойства класса пользователя. Затем можно сопоставить каждое свойство на столбцы в пользовательской таблице. В этом случае, свойства можно работать напрямую с использованием класса пользователя в дополнение к отсутствию необходимости сведения данных сериализации и десериализации время при доступе к нему.

## <a name="getting-started"></a>Начало работы

1. Создайте новое приложение веб-форм ASP.NET 4.5 в Visual Studio 2012. Текущий образец использует шаблон веб-форм, но можно также использовать приложения MVC.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.jpg)
2. Создайте новую папку «Модели» для хранения сведений о профиле  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.png)
3. Например сообщите нам храните дату рождения, Город, высота и вес пользователя в профиле. Высоты и ширины хранятся как пользовательский класс с именем «PersonalStats». Для хранения и извлечения профиля, нам нужен класс, который расширяет «ProfileBase». Давайте создадим новый класс «AppProfile» для получения и сохранение сведений о профиле.

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample1.cs)]
4. Включить профиль в *web.config* файла. Введите имя класса, который будет использоваться для хранения или извлечения сведения о пользователе, созданный на шаге #3.

    [!code-xml[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample2.xml)]
5. Добавьте страницу web forms, в папку «Учетная запись» получение данных профиля пользователя и сохранить ее. Щелкните правой кнопкой мыши проект и выберите «Добавить новый элемент». Добавление новой страницы веб-форм с главной страницей «AddProfileData.aspx». Скопируйте следующее в разделе «Тегу».

    [!code-html[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample3.html)]

   Добавьте следующий код в коде:

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample4.cs)]

   Добавьте пространство имен, в какие AppProfile класс был определен для удаления ошибки компиляции.
6. Запустите приложение и создать нового пользователя с именем пользователя "**olduser".** Перейдите на страницу «AddProfileData» и добавить данные профиля для пользователя.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.png)

Вы можете проверить, что данные хранятся как сериализованные данные xml в таблице «Профили», с помощью окна обозревателя серверов. В Visual Studio в меню «Вид» выберите «Обозреватель серверов». Должно быть подключение к данным для базы данных, определенных в *web.config* файла. Щелкните на подключение к данным, чтобы отобразить различные подкатегории. Разверните узел «Таблицы», чтобы показать разные таблицы в базе данных, а затем щелкните правой кнопкой «Профили» и выберите «Показать таблицу данных» для просмотра профиля данных, хранящихся в таблице профилей.

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.png)

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image4.png)

## <a name="migrating-database-schema"></a>Миграция схемы базы данных

Чтобы работать с система идентификации существующей базы данных, необходимо обновить схему базы данных удостоверений для поддержки полей, которые мы добавили в исходной базе данных. Это можно сделать с помощью сценариев SQL для создания новых таблиц и скопировать информацию из существующего. В окне «Обозреватель серверов» разверните узел «DefaultConnection» для отображения таблиц. Щелкните правой кнопкой мыши таблицы и выберите пункт «Создать запрос»

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image5.png)

Вставьте скрипт SQL из [ https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt ](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt) и запустите его. Если обновляется «DefaultConnection», мы видим, что добавлены новые таблицы. Можно проверить данные в таблицах, чтобы определить, что данные были перенесены.

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image6.png)

## <a name="migrating-the-application-to-use-aspnet-identity"></a>Миграция приложения для использования ASP.NET Identity

1. Установите пакеты Nuget, необходимые для идентификации ASP.NET:

    - Microsoft.AspNet.Identity.EntityFramework
    - Microsoft.AspNet.Identity.Owin
    - Microsoft.Owin.Host.SystemWeb
    - Microsoft.Owin.Security.Facebook
    - Microsoft.Owin.Security.Google
    - Microsoft.Owin.Security.MicrosoftAccount
    - Microsoft.Owin.Security.Twitter

   Можно найти дополнительные сведения об управлении пакетами Nuget [здесь](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)
2. Для работы с существующие данные в таблице, необходимо создать классы модели, которые сопоставляются с таблицами и соединить их в системы удостоверений. Как часть контракта удостоверений классы модели должен реализовывать интерфейсы, определенные в библиотеке dll Identity.Core или расширить существующую реализацию этих интерфейсов, доступных в Microsoft.AspNet.Identity.EntityFramework. Мы будет использовать существующие классы для роли, имена входа и утверждения пользователей. Необходимо использовать настраиваемого пользователя для наших образцов. Щелкните правой кнопкой мыши проект и создать новую папку «IdentityModels». Добавьте новый класс «User», как показано ниже:

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample5.cs)]

   Обратите внимание, что ProfileInfo теперь свойство класса пользователя. Таким образом можно использовать класс пользователя напрямую работать с данными профиля.

Скопируйте файлы в **IdentityModels** и **IdentityAccount** папок из источника загрузки ( [ https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations ](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ). Они имеют остальные классы модели и новые страницы, необходимые для пользователей и управление ролями с помощью API-интерфейсы ASP.NET Identity. Этот подход используется аналогичен членства SQL, и можно найти подробное описание [здесь](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md).

## <a name="copying-profile-data-to-the-new-tables"></a>Копирование данных профиля в новые таблицы

Как упоминалось ранее, необходимо десериализовать XML-данные в таблицах профили и сохраните ее в столбцах таблицы AspNetUsers. Новые столбцы были созданы в таблице пользователей на предыдущем шаге, осталось заключается в заполнении столбцы с данными, необходимыми. Чтобы сделать это, мы будем использовать консольное приложение, в которой выполняется один раз для заполнения вновь созданный столбцов в таблице users.

1. Создайте новое консольное приложение в существующие решения.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.jpg)
2. Установите последнюю версию пакета платформы Entity Framework.
3. Добавьте веб-приложение, созданной ранее как ссылку в консольном приложении. Чтобы сделать это щелкните правой кнопкой мыши проект, а затем «Добавление ссылок», затем решения, затем щелкните кнопкой мыши проект и нажмите кнопку ОК.
4. Копировать ниже код в Program.cs классе. Эта логика считывает данные профиля для каждого пользователя, сериализует его как объект «ProfileInfo» и сохраняет его в базе данных.

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample6.cs)]

   Некоторые модели, используемые определяются в папке «IdentityModels» проекта веб-приложения, поэтому необходимо включить соответствующие пространства имен.
5. Приведенный выше код работает в файле базы данных в приложении\_папки данных проекта веб-приложения, созданные в предыдущих шагах. Для ссылки, который следует Обновите строку подключения в файле app.config консольного приложения в строке подключения в файле web.config веб-приложения. Также предоставляют полный физический путь в свойстве 'AttachDbFilename'.
6. Откройте командную строку и перейдите в папку bin выше консольного приложения. Запустите исполняемый файл и проверьте выходные данные журнала, как показано на следующем рисунке.  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.jpg)
7. Открыть таблицу «AspNetUsers» в обозревателе сервера и проверки правильности данных в новые столбцы, которые содержат свойства. Они должны обновляться значениями соответствующих свойств.

## <a name="verify-functionality"></a>Проверка работоспособности

Используйте страницы вновь добавленный членства, которые реализуются с помощью ASP.NET Identity для входа в систему пользователя из старой базы данных. Пользователь должен иметь права на вход с использованием тех же учетных данных. Функции, такие как добавление OAuth, создания нового пользователя, изменения пароля, Добавление ролей, попробуйте добавьте пользователей в роли и т. д.

Данные профиля для пользователя старых и новых пользователей, которые должны быть получены и хранится в таблице пользователей. Старую таблицу больше не должна быть ссылка.

## <a name="conclusion"></a>Заключение

Статьи описывается процесс переноса веб-приложений, которые используются с моделью поставщика для членства в ASP.NET Identity. Кроме того, статьи контура перенос данных профиля, пользователи могут связать системы удостоверений. Оставьте комментарии ниже для вопросов и проблем, возникающих при переносе приложения.

*Благодаря Рик Андерсон и Robert McMurray для просмотра статьи.*

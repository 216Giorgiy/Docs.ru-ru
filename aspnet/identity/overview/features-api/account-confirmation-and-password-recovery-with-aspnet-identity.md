---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: Подтверждение и восстановления пароля с ASP.NET Identity (C#) учетной записи | Документы Microsoft
author: HaoK
description: Перед выполнением этого учебника, следует сначала выполнить создание безопасных веб-приложения ASP.NET MVC 5 с журналом в сбросить пароль и подтверждение по электронной почте. Этот учебник...
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/26/2015
ms.topic: article
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 0167388cf6b488b72ca36f583a7794690dbf9900
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
ms.locfileid: "30876037"
---
<a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="5649e-104">Подтверждение учетной записи и пароль восстановления в ASP.NET Identity (C#)</span><span class="sxs-lookup"><span data-stu-id="5649e-104">Account Confirmation and Password Recovery with ASP.NET Identity (C#)</span></span>
====================
<span data-ttu-id="5649e-105">по [поздравить Hao](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Рик Андерсон](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="5649e-105">by [Hao Kung](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="5649e-106">Перед выполнением этого учебника вам следует изучить [создания безопасного веб-приложения ASP.NET MVC 5 с журналом в сбросить пароль и подтверждение по электронной почте](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span><span class="sxs-lookup"><span data-stu-id="5649e-106">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="5649e-107">Этот учебник содержит дополнительные сведения и будет показано, как настроить электронную почту для подтверждения локальную учетную запись и разрешить пользователям сбрасывать утраченный пароль в ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="5649e-107">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span> <span data-ttu-id="5649e-108">В этой статье было написано с Рик Андерсон ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), поздравить Hao и Suhas Joshi.</span><span class="sxs-lookup"><span data-stu-id="5649e-108">This article was written by Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung, and Suhas Joshi.</span></span> <span data-ttu-id="5649e-109">NuGet образец был написан главным образом Hao поздравить.</span><span class="sxs-lookup"><span data-stu-id="5649e-109">The NuGet sample was written primarily by Hao Kung.</span></span>


<span data-ttu-id="5649e-110">Учетную запись локального пользователя требуется создать пароль для учетной записи пользователя и пароль (безопасно) хранится в веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="5649e-110">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="5649e-111">ASP.NET Identity также поддерживает социальных учетные записи, которые не требуют от пользователя, создайте пароль для приложения.</span><span class="sxs-lookup"><span data-stu-id="5649e-111">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="5649e-112">[Учетные записи социальных](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) использования сторонних разработчиков (например, Google, Twitter, Facebook или Майкрософт) для проверки подлинности пользователей.</span><span class="sxs-lookup"><span data-stu-id="5649e-112">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook or Microsoft) to authenticate users.</span></span> <span data-ttu-id="5649e-113">В этом разделе объясняется следующее.</span><span class="sxs-lookup"><span data-stu-id="5649e-113">This topic covers the following:</span></span>

- <span data-ttu-id="5649e-114">[Создание приложения ASP.NET MVC](#createMvc) и изучение функций ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="5649e-114">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="5649e-115">Построение образца удостоверений</span><span class="sxs-lookup"><span data-stu-id="5649e-115">Building the Identity sample</span></span>](#build)
- [<span data-ttu-id="5649e-116">Настройка подтверждение по электронной почте</span><span class="sxs-lookup"><span data-stu-id="5649e-116">Set up email confirmation</span></span>](#email)

<span data-ttu-id="5649e-117">Новым пользователям зарегистрировать свои псевдоним электронной почты, который создает локальную учетную запись.</span><span class="sxs-lookup"><span data-stu-id="5649e-117">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="5649e-118">Нажав кнопку "Регистрация" отправляет сообщение с подтверждением, содержащий маркер проверки для своего адреса электронной почты.</span><span class="sxs-lookup"><span data-stu-id="5649e-118">Clicking the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="5649e-119">Пользователю отправляется сообщение электронной почты с помощью токена подтверждения для своей учетной записи.</span><span class="sxs-lookup"><span data-stu-id="5649e-119">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="5649e-120">Подтверждает учетную запись, щелкнув ссылку.</span><span class="sxs-lookup"><span data-stu-id="5649e-120">Clicking the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="5649e-121">Восстановление пароля</span><span class="sxs-lookup"><span data-stu-id="5649e-121">Password recovery/reset</span></span>

<span data-ttu-id="5649e-122">Локальные пользователи забудут пароль может иметь маркер безопасности, отправляемые свою учетную запись электронной почты, что дает им возможность сброса пароля.</span><span class="sxs-lookup"><span data-stu-id="5649e-122">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="5649e-123">Пользователь скоро получит сообщение электронной почты со ссылкой, позволяя им для сброса пароля.</span><span class="sxs-lookup"><span data-stu-id="5649e-123">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="5649e-124">Щелкнув ссылку ведет на страницу сброса.</span><span class="sxs-lookup"><span data-stu-id="5649e-124">Clicking the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="5649e-125">Щелкнув **Сброс** подтвердит кнопка сброса пароля.</span><span class="sxs-lookup"><span data-stu-id="5649e-125">Clicking the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="5649e-126">Создание веб-приложений ASP.NET</span><span class="sxs-lookup"><span data-stu-id="5649e-126">Create an ASP.NET Web app</span></span>

<span data-ttu-id="5649e-127">Начните с установки и запуска [Visual Studio Express 2013 для Web](https://go.microsoft.com/fwlink/?LinkId=299058) или [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span><span class="sxs-lookup"><span data-stu-id="5649e-127">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span> <span data-ttu-id="5649e-128">Установка Visual Studio [2013 обновление 2](https://go.microsoft.com/fwlink/?LinkId=390521) или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="5649e-128">Install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) or higher.</span></span>

> [!NOTE]
> <span data-ttu-id="5649e-129">Предупреждение: Необходимо установить Visual Studio [2013 обновление 2](https://go.microsoft.com/fwlink/?LinkId=390521) для завершения этого учебника.</span><span class="sxs-lookup"><span data-stu-id="5649e-129">Warning: You must install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) to complete this tutorial.</span></span>


1. <span data-ttu-id="5649e-130">Создайте новый проект веб-ASP.NET и выберите шаблон MVC.</span><span class="sxs-lookup"><span data-stu-id="5649e-130">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="5649e-131">Web Forms также поддерживает ASP.NET Identity, так что можно выполнить аналогичные шаги в приложении web forms.</span><span class="sxs-lookup"><span data-stu-id="5649e-131">Web Forms also supports ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="5649e-132">Оставить как проверку подлинности по умолчанию **индивидуальные учетные записи**.</span><span class="sxs-lookup"><span data-stu-id="5649e-132">Leave the default authentication as **Individual User Accounts**.</span></span>
3. <span data-ttu-id="5649e-133">Запустите приложение, нажмите кнопку **зарегистрировать** ссылку и регистрации пользователя.</span><span class="sxs-lookup"><span data-stu-id="5649e-133">Run the app, click the **Register** link and register a user.</span></span> <span data-ttu-id="5649e-134">На этом этапе является проверку только в электронном письме с [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) атрибута.</span><span class="sxs-lookup"><span data-stu-id="5649e-134">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="5649e-135">В обозревателе серверов, перейдите к **Connections\DefaultConnection\Tables\AspNetUsers данные**, щелкните правой кнопкой мыши и выберите **откройте определение таблицы**.</span><span class="sxs-lookup"><span data-stu-id="5649e-135">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right click and select **Open table definition**.</span></span>

    <span data-ttu-id="5649e-136">На следующем рисунке показана `AspNetUsers` схемы:</span><span class="sxs-lookup"><span data-stu-id="5649e-136">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="5649e-137">Щелкните правой кнопкой мыши **AspNetUsers** таблицы и выберите **Показать таблицу данных**.</span><span class="sxs-lookup"><span data-stu-id="5649e-137">Right click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="5649e-138">На этом этапе сообщение электронной почты не подтвержден.</span><span class="sxs-lookup"><span data-stu-id="5649e-138">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="5649e-139">Хранилище данных по умолчанию для ASP.NET Identity является Entity Framework, но его можно настроить для использования других хранилищ данных и добавить дополнительные поля.</span><span class="sxs-lookup"><span data-stu-id="5649e-139">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="5649e-140">В разделе [дополнительные ресурсы](#addRes) в конце данного руководства.</span><span class="sxs-lookup"><span data-stu-id="5649e-140">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="5649e-141">[Класс запуска OWIN](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *файла Startup.cs* ) вызывается, когда приложение запускается и вызывает `ConfigureAuth` метод в *приложения\_Start\Startup.Auth.cs*, который настраивает конвейер OWIN и инициализирует ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="5649e-141">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="5649e-142">Изучите `ConfigureAuth` метод.</span><span class="sxs-lookup"><span data-stu-id="5649e-142">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="5649e-143">Каждый `CreatePerOwinContext` вызов регистрирует обратный вызов (сохранен в `OwinContext`), будет вызван один раз на каждый запрос для создания экземпляра заданного типа.</span><span class="sxs-lookup"><span data-stu-id="5649e-143">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="5649e-144">Можно установить точку останова в конструкторе и `Create` метод каждого типа (`ApplicationDbContext, ApplicationUserManager`) и проверьте, они вызываются при каждом запросе.</span><span class="sxs-lookup"><span data-stu-id="5649e-144">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="5649e-145">Экземпляр `ApplicationDbContext` и `ApplicationUserManager` хранится в контекст OWIN, который можно вызвать в приложении.</span><span class="sxs-lookup"><span data-stu-id="5649e-145">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="5649e-146">ASP.NET Identity перехватчиков событий в конвейер OWIN по промежуточного слоя файлов cookie.</span><span class="sxs-lookup"><span data-stu-id="5649e-146">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="5649e-147">Дополнительные сведения см. в разделе [за управление временем существования запроса для класса UserManager в ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="5649e-147">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="5649e-148">При изменении профиля безопасности новой метки безопасности создается и сохраняется в `SecurityStamp` поле *AspNetUsers* таблицы.</span><span class="sxs-lookup"><span data-stu-id="5649e-148">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="5649e-149">Следует отметить, что `SecurityStamp` поля отличается от безопасности cookie.</span><span class="sxs-lookup"><span data-stu-id="5649e-149">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="5649e-150">Файл cookie безопасности не хранятся в `AspNetUsers` таблицы (или любом другом месте в базе данных удостоверений).</span><span class="sxs-lookup"><span data-stu-id="5649e-150">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="5649e-151">Маркер безопасности cookie самостоятельно подписывается с помощью [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) и создается `UserId, SecurityStamp` и сведения о времени истечения срока действия.</span><span class="sxs-lookup"><span data-stu-id="5649e-151">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="5649e-152">По промежуточного слоя файлов cookie проверяет куки-файл для каждого запроса.</span><span class="sxs-lookup"><span data-stu-id="5649e-152">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="5649e-153">`SecurityStampValidator` Метод в `Startup` класс обращений к базе данных и периодически проверяет метку безопасности в соответствии с `validateInterval`.</span><span class="sxs-lookup"><span data-stu-id="5649e-153">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="5649e-154">Это происходит каждые 30 минут (в нашем примере) только изменения профиля безопасности.</span><span class="sxs-lookup"><span data-stu-id="5649e-154">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="5649e-155">Чтобы свести к минимуму обращений к базе данных был выбран интервал 30 минут.</span><span class="sxs-lookup"><span data-stu-id="5649e-155">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="5649e-156">В разделе Мои [учебника двухфакторной проверки подлинности](index.md) для получения дополнительных сведений.</span><span class="sxs-lookup"><span data-stu-id="5649e-156">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="5649e-157">В комментарии в коде `UseCookieAuthentication` метод обеспечивает поддержку проверки подлинности файла cookie.</span><span class="sxs-lookup"><span data-stu-id="5649e-157">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="5649e-158">`SecurityStamp` Поля и связанного кода обеспечивает дополнительный уровень безопасности для приложения, при изменении пароля, при подключении из браузера, с которой выполнен вход.</span><span class="sxs-lookup"><span data-stu-id="5649e-158">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="5649e-159">`SecurityStampValidator.OnValidateIdentity` Метод позволяет приложению для проверки маркера безопасности при входе пользователя, применяемое, когда вы меняете пароль или использовать внешнее имя входа.</span><span class="sxs-lookup"><span data-stu-id="5649e-159">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="5649e-160">Это необходимо, чтобы убедиться, что все токены (куки-файлы), созданные со старым паролем, становятся недействительными.</span><span class="sxs-lookup"><span data-stu-id="5649e-160">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="5649e-161">В образце проекта при изменении пароля пользователя затем новый маркер создается для пользователя, не делает недействительными все предыдущие токены и `SecurityStamp` поле обновляется.</span><span class="sxs-lookup"><span data-stu-id="5649e-161">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="5649e-162">Система идентификации позволяют настроить приложения, при изменении профиля безопасности пользователей (например, когда пользователь изменяет свой пароль или изменения связанного имени входа (например, от Facebook, Google, учетной записи Майкрософт, т. д.), пользователь выполнил выход из всех экземпляры браузера.</span><span class="sxs-lookup"><span data-stu-id="5649e-162">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="5649e-163">Например, на рисунке ниже показана [образец единого выхода](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) приложение, которое пользователь может выйти из всех экземпляров браузера (в данном случае IE, Firefox и Chrome) нажатием одной кнопки.</span><span class="sxs-lookup"><span data-stu-id="5649e-163">For example, the image below shows the [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by clicking one button.</span></span> <span data-ttu-id="5649e-164">Кроме того образец можно только выйдите из экземпляра конкретного браузера.</span><span class="sxs-lookup"><span data-stu-id="5649e-164">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="5649e-165">[Образец единого выхода](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) приложение показывает, как ASP.NET Identity позволяет повторно создать токен безопасности.</span><span class="sxs-lookup"><span data-stu-id="5649e-165">The [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="5649e-166">Это необходимо, чтобы убедиться, что все токены (куки-файлы), созданные со старым паролем, становятся недействительными.</span><span class="sxs-lookup"><span data-stu-id="5649e-166">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="5649e-167">Эта функция обеспечивает дополнительный уровень безопасности для приложения; При изменении пароля, где был выполнен вход в это приложение будет выхода.</span><span class="sxs-lookup"><span data-stu-id="5649e-167">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="5649e-168">*Приложения\_Start\IdentityConfig.cs* файл содержит `ApplicationUserManager`, `EmailService` и `SmsService` классы.</span><span class="sxs-lookup"><span data-stu-id="5649e-168">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="5649e-169">`EmailService` И `SmsService` классы, реализующие каждого `IIdentityMessageService` интерфейс, поэтому имеют общие методы в каждом классе для настройки электронной почты и SMS.</span><span class="sxs-lookup"><span data-stu-id="5649e-169">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="5649e-170">Несмотря на то, что этот учебник только демонстрирует добавление уведомления по электронной почте через [SendGrid](http://sendgrid.com/), вы можете отправить по электронной почте с помощью SMTP и другие механизмы.</span><span class="sxs-lookup"><span data-stu-id="5649e-170">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="5649e-171">`Startup` Класс также содержит шаблон формы, добавление социальных имена входа (Facebook, Twitter, т. д.), см. Мои учебнике [приложения MVC 5 с Facebook, Twitter, LinkedIn и входа в Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) Дополнительные сведения.</span><span class="sxs-lookup"><span data-stu-id="5649e-171">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="5649e-172">Изучите `ApplicationUserManager` класс, который содержит данные удостоверений пользователей и настраивает следующие возможности:</span><span class="sxs-lookup"><span data-stu-id="5649e-172">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="5649e-173">Требования к надежности пароля.</span><span class="sxs-lookup"><span data-stu-id="5649e-173">Password strength requirements.</span></span>
- <span data-ttu-id="5649e-174">Блокировка пользователя (попыток и времени).</span><span class="sxs-lookup"><span data-stu-id="5649e-174">User lock out (attempts and time).</span></span>
- <span data-ttu-id="5649e-175">Двухфакторная проверка подлинности (2FA).</span><span class="sxs-lookup"><span data-stu-id="5649e-175">Two-factor authentication (2FA).</span></span> <span data-ttu-id="5649e-176">В следующем учебнике будет рассмотрена 2FA и SMS.</span><span class="sxs-lookup"><span data-stu-id="5649e-176">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="5649e-177">Подключении к электронной почте и службам SMS.</span><span class="sxs-lookup"><span data-stu-id="5649e-177">Hooking up the email and SMS services.</span></span> <span data-ttu-id="5649e-178">(SMS будет рассмотрена в следующем учебнике).</span><span class="sxs-lookup"><span data-stu-id="5649e-178">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="5649e-179">`ApplicationUserManager` Класс является производным от универсального `UserManager<ApplicationUser>` класса.</span><span class="sxs-lookup"><span data-stu-id="5649e-179">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="5649e-180">`ApplicationUser` является производным от [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span><span class="sxs-lookup"><span data-stu-id="5649e-180">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="5649e-181">`IdentityUser` является производным от универсального `IdentityUser` класса:</span><span class="sxs-lookup"><span data-stu-id="5649e-181">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="5649e-182">Указанные выше свойства совпадают со свойствами в `AspNetUsers` приведенной выше таблице.</span><span class="sxs-lookup"><span data-stu-id="5649e-182">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="5649e-183">Универсальные аргументы на `IUser` позволяют создать производный класс с помощью различных типов для первичного ключа.</span><span class="sxs-lookup"><span data-stu-id="5649e-183">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="5649e-184">В разделе [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) пример, в котором показано, как изменить первичный ключ из строки в int или GUID.</span><span class="sxs-lookup"><span data-stu-id="5649e-184">See the [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="5649e-185">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="5649e-185">ApplicationUser</span></span>

<span data-ttu-id="5649e-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) определяется в *Models\IdentityModels.cs* как:</span><span class="sxs-lookup"><span data-stu-id="5649e-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="5649e-187">Выделенный код выше приводит к возникновению ошибки [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span><span class="sxs-lookup"><span data-stu-id="5649e-187">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="5649e-188">ASP.NET Identity и проверки подлинности файла Cookie OWIN на основе утверждений, поэтому платформа требует приложение, чтобы создать `ClaimsIdentity` для пользователя.</span><span class="sxs-lookup"><span data-stu-id="5649e-188">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="5649e-189">`ClaimsIdentity` содержит сведения о всех утверждений для пользователя, такие как имя пользователя, срок действия и какие роли принадлежит пользователь.</span><span class="sxs-lookup"><span data-stu-id="5649e-189">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="5649e-190">На этом этапе также можно добавить дополнительные утверждения для пользователя.</span><span class="sxs-lookup"><span data-stu-id="5649e-190">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="5649e-191">OWIN `AuthenticationManager.SignIn` метод передает в `ClaimsIdentity` и выполняет вход пользователя:</span><span class="sxs-lookup"><span data-stu-id="5649e-191">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="5649e-192">[Приложение MVC 5 с Facebook, Twitter, LinkedIn и входа в Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) показано, как можно добавить дополнительные свойства, `ApplicationUser` класса.</span><span class="sxs-lookup"><span data-stu-id="5649e-192">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="5649e-193">Подтверждение по электронной почте</span><span class="sxs-lookup"><span data-stu-id="5649e-193">Email confirmation</span></span>

<span data-ttu-id="5649e-194">Рекомендуется подтверждение по электронной почте, зарегистрировать нового пользователя для проверки того, они не являются олицетворения кто-то другой (то есть они еще не зарегистрированы с помощью электронной почты другого пользователя).</span><span class="sxs-lookup"><span data-stu-id="5649e-194">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="5649e-195">Предположим, что у вас есть дискуссионный форум, может потребоваться запретить `"bob@example.com"` из регистрации в качестве `"joe@contoso.com"`.</span><span class="sxs-lookup"><span data-stu-id="5649e-195">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="5649e-196">Без подтверждения по электронной почте `"joe@contoso.com"` давало нежелательных электронной почты из приложения.</span><span class="sxs-lookup"><span data-stu-id="5649e-196">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="5649e-197">Предположим, что Боб случайно зарегистрирован как `"bib@example.com"` и не заметили, он не сможет использовать пароль восстановления, так как приложение не имеет правильное сообщение электронной почты.</span><span class="sxs-lookup"><span data-stu-id="5649e-197">Suppose Bob accidently registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="5649e-198">Предоставляет ограниченную защиту от программы-роботы подтверждение по электронной почте и не обеспечивает защиты от нежелательных сообщений определяется у них много рабочей электронной почты псевдонимы, которые они могут использовать для регистрации. В следующем примере нельзя будет изменить свой пароль, пока не будет подтверждена их учетная запись пользователя (путем их щелкнуть ссылку для подтверждения получения на учетную запись электронной почты, они зарегистрированы.) Этот рабочий процесс можно применять для других сценариев, например отправить ссылку для подтверждения и сбросить пароль на новые учетные записи, созданные администратором, отправка сообщения электронной почты пользователя, если они были изменены их профиль и т. д.</span><span class="sxs-lookup"><span data-stu-id="5649e-198">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them clicking on a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="5649e-199">Как правило, требуется запретить пользователям новых учетных данных для веб-узла до подтверждения по электронной почте, SMS-сообщение или другого механизма.</span><span class="sxs-lookup"><span data-stu-id="5649e-199">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="building-a-more-complete-sample"></a><span data-ttu-id="5649e-200">Более полный пример построения</span><span class="sxs-lookup"><span data-stu-id="5649e-200">Building a more complete sample</span></span>

<span data-ttu-id="5649e-201">В этом разделе будет использоваться NuGet для загрузки более полный пример, который мы работаем над.</span><span class="sxs-lookup"><span data-stu-id="5649e-201">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="5649e-202">Создайте новый ***пустой*** веб-проекте ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="5649e-202">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="5649e-203">В консоли диспетчера пакетов введите следующие команды:</span><span class="sxs-lookup"><span data-stu-id="5649e-203">In the Package Manager Console, enter the following the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="5649e-204">В этом учебнике мы будем использовать [SendGrid](http://sendgrid.com/) для отправки электронной почты.</span><span class="sxs-lookup"><span data-stu-id="5649e-204">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="5649e-205">`Identity.Samples` Пакет устанавливает код, мы будем работать с.</span><span class="sxs-lookup"><span data-stu-id="5649e-205">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="5649e-206">Задать [проекта для использования SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="5649e-206">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="5649e-207">Создания локальной учетной записи тестового путем запуска приложения, щелкнув **зарегистрировать** связь и передачу форму регистрации.</span><span class="sxs-lookup"><span data-stu-id="5649e-207">Test local account creation by running the app, clicking on the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="5649e-208">Щелкните ссылку по электронной почте Демонстрация имитирует подтверждение по электронной почте.</span><span class="sxs-lookup"><span data-stu-id="5649e-208">Click the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="5649e-209">Удалите Демонстрация по электронной почте ссылку подтверждения код из примера ( `ViewBag.Link` кода в контроллера учетных записей.</span><span class="sxs-lookup"><span data-stu-id="5649e-209">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="5649e-210">В разделе `DisplayEmail` и `ForgotPasswordConfirmation` методы действий и представления razor).</span><span class="sxs-lookup"><span data-stu-id="5649e-210">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!NOTE]
> <span data-ttu-id="5649e-211">Предупреждение: При изменении параметров безопасности в этом образце производства приложения потребуется проходить аудит безопасности, которая явно вызывает изменения.</span><span class="sxs-lookup"><span data-stu-id="5649e-211">Warning: If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>


## <a name="examine-the-code-in-appstartidentityconfigcs"></a><span data-ttu-id="5649e-212">Анализ кода в приложении\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="5649e-212">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="5649e-213">Пример показано, как создать учетную запись и добавить его в *администратора* роли.</span><span class="sxs-lookup"><span data-stu-id="5649e-213">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="5649e-214">Следует заменить сообщения электронной почты в образце с адресом электронной почты, который будет использоваться для учетной записи администратора.</span><span class="sxs-lookup"><span data-stu-id="5649e-214">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="5649e-215">Самым простым способом прямо сейчас, чтобы создать учетную запись администратора является программным способом в `Seed` метод.</span><span class="sxs-lookup"><span data-stu-id="5649e-215">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="5649e-216">Мы надеемся инструмент в будущем, дает возможность создавать и администрировать пользователей и ролей.</span><span class="sxs-lookup"><span data-stu-id="5649e-216">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="5649e-217">В образце кода позволяют создавать и управлять пользователями и ролями, но сначала необходимо иметь учетную запись администраторов для выполнения ролей и страниц администрирования пользователя.</span><span class="sxs-lookup"><span data-stu-id="5649e-217">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="5649e-218">В этом образце учетной записи администратора создается при заполнения базы данных.</span><span class="sxs-lookup"><span data-stu-id="5649e-218">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="5649e-219">Изменить пароль и измените имя на учетную запись, позволяющие получать уведомления по электронной почте.</span><span class="sxs-lookup"><span data-stu-id="5649e-219">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="5649e-220">Безопасность — никогда не конфиденциальных данных в хранилище в исходном коде.</span><span class="sxs-lookup"><span data-stu-id="5649e-220">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="5649e-221">Как упоминалось ранее, `app.CreatePerOwinContext` вызова в классе запуска добавляет обратные вызовы для `Create` метод приложения DB содержимого, пользователь manager и роль диспетчера классов.</span><span class="sxs-lookup"><span data-stu-id="5649e-221">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="5649e-222">Вызывает конвейер OWIN `Create` метод эти классы для каждого запроса и сохраняет контекст для каждого класса.</span><span class="sxs-lookup"><span data-stu-id="5649e-222">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="5649e-223">Контроллера учетных записей раскрывает диспетчера пользователей из контекста HTTP (который содержит контекст OWIN):</span><span class="sxs-lookup"><span data-stu-id="5649e-223">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="5649e-224">Когда пользователь регистрирует локальной учетной записи, `HTTP Post Register` вызывается метод:</span><span class="sxs-lookup"><span data-stu-id="5649e-224">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="5649e-225">Приведенный выше код использует данные модели для создания учетной записи пользователя с помощью электронной почты и пароль.</span><span class="sxs-lookup"><span data-stu-id="5649e-225">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="5649e-226">Если псевдоним электронной почты находится в хранилище данных, происходит сбой создания учетной записи и отображается форма.</span><span class="sxs-lookup"><span data-stu-id="5649e-226">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="5649e-227">`GenerateEmailConfirmationTokenAsync` Метод создает токен безопасности подтверждения и сохраняет его в хранилище данных ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="5649e-227">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="5649e-228">[Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) метод Создание ссылки, содержащей `UserId` и токена подтверждения.</span><span class="sxs-lookup"><span data-stu-id="5649e-228">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="5649e-229">Эта ссылка затем отправляется сообщение для пользователя, пользователь может щелкнуть ссылку в свое приложение электронной почты, чтобы подтвердить свою учетную запись.</span><span class="sxs-lookup"><span data-stu-id="5649e-229">This link is then emailed to the user, the user can click on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="5649e-230">Настройка подтверждение по электронной почте</span><span class="sxs-lookup"><span data-stu-id="5649e-230">Set up email confirmation</span></span>

<span data-ttu-id="5649e-231">Последовательно выберите пункты [страницу регистрации Azure SendGrid](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) и зарегистрировать для получения бесплатной учетной записи.</span><span class="sxs-lookup"><span data-stu-id="5649e-231">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="5649e-232">Добавьте код, аналогичный приведенному ниже, чтобы настроить SendGrid:</span><span class="sxs-lookup"><span data-stu-id="5649e-232">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="5649e-233">Клиенты электронной почты часто принимают только текстовые сообщения (HTML).</span><span class="sxs-lookup"><span data-stu-id="5649e-233">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="5649e-234">Необходимо предоставить сообщение в текст или HTML.</span><span class="sxs-lookup"><span data-stu-id="5649e-234">You should provide the message in text and HTML.</span></span> <span data-ttu-id="5649e-235">В приведенном выше примере SendGrid это делается с `myMessage.Text` и `myMessage.Html` приведенного выше кода.</span><span class="sxs-lookup"><span data-stu-id="5649e-235">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>


<span data-ttu-id="5649e-236">Ниже показано, как отправить по электронной почте с помощью [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) класса where `message.Body` возвращает только по ссылке.</span><span class="sxs-lookup"><span data-stu-id="5649e-236">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="5649e-237">Безопасность — никогда не конфиденциальных данных в хранилище в исходном коде.</span><span class="sxs-lookup"><span data-stu-id="5649e-237">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="5649e-238">Учетная запись и учетные данные хранятся в appSetting.</span><span class="sxs-lookup"><span data-stu-id="5649e-238">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="5649e-239">В Azure, можно безопасно хранить эти значения на **[Настройка](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** на портале Azure.</span><span class="sxs-lookup"><span data-stu-id="5649e-239">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="5649e-240">В разделе [советы и рекомендации по развертыванию пароли и другие конфиденциальные данные в ASP.NET и Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span><span class="sxs-lookup"><span data-stu-id="5649e-240">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>


<span data-ttu-id="5649e-241">Введите учетные данные SendGrid, запустить приложение, регистрация псевдоним электронной почты можно щелкнуть ссылку подтверждение электронной почты.</span><span class="sxs-lookup"><span data-stu-id="5649e-241">Enter your SendGrid credentials, run the app, register with an email alias can click the confirm link in your email.</span></span> <span data-ttu-id="5649e-242">Чтобы узнать, как это сделать с помощью вашей [Outlook.com](http://outlook.com) учетную запись электронной почты см. в разделе Джон Atten [конфигурацию SMTP C# для узла SMTP Outlook.Com](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) и его[удостоверения ASP.NET 2.0: параметр вверх проверка учетной записи и авторизации двухфакторной](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) в блогах.</span><span class="sxs-lookup"><span data-stu-id="5649e-242">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="5649e-243">Когда пользователь щелкает **зарегистрировать** кнопку свой адрес электронной почты отправляется сообщение с подтверждением, содержащий маркер проверки.</span><span class="sxs-lookup"><span data-stu-id="5649e-243">Once a user clicks the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="5649e-244">Пользователю отправляется сообщение электронной почты с помощью токена подтверждения для своей учетной записи.</span><span class="sxs-lookup"><span data-stu-id="5649e-244">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="5649e-245">Анализ кода</span><span class="sxs-lookup"><span data-stu-id="5649e-245">Examine the code</span></span>

<span data-ttu-id="5649e-246">В следующем примере кода показан метод `POST ForgotPassword`.</span><span class="sxs-lookup"><span data-stu-id="5649e-246">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="5649e-247">Метод завершает работу, если адрес электронной почты пользователя еще не подтверждена.</span><span class="sxs-lookup"><span data-stu-id="5649e-247">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="5649e-248">Если ошибка была отправлена для недопустимый адрес электронной почты, пользователи-злоумышленники может использовать эту информацию найти допустимый идентификатор пользователя (псевдонимы электронной почты) для атаки.</span><span class="sxs-lookup"><span data-stu-id="5649e-248">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="5649e-249">В следующем коде показано `ConfirmEmail` метод, вызываемый, когда пользователь щелкает ссылку подтверждения в сообщении электронной почты, отправленных в них контроллера учетных записей:</span><span class="sxs-lookup"><span data-stu-id="5649e-249">The following code shows the `ConfirmEmail` method in the account controller that is called when the user clicks the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="5649e-250">После использует маркер забытый пароль становится недействительным.</span><span class="sxs-lookup"><span data-stu-id="5649e-250">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="5649e-251">Следующие изменения кода в `Create` метода (в *приложения\_Start\IdentityConfig.cs* файла) задает токенов истекает через 3 часа.</span><span class="sxs-lookup"><span data-stu-id="5649e-251">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="5649e-252">С приведенный выше код забытый пароль и подтверждение токены электронной почты будет действовать в 3 часа.</span><span class="sxs-lookup"><span data-stu-id="5649e-252">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="5649e-253">Значение по умолчанию `TokenLifespan` — один день.</span><span class="sxs-lookup"><span data-stu-id="5649e-253">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="5649e-254">Следующий код демонстрирует метод подтверждение по электронной почте:</span><span class="sxs-lookup"><span data-stu-id="5649e-254">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="5649e-255">Для повышения безопасности ваше приложение, ASP.NET Identity поддерживает двухфакторную проверку подлинности (2FA).</span><span class="sxs-lookup"><span data-stu-id="5649e-255">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="5649e-256">В разделе [удостоверения ASP.NET 2.0: настройки учетной записи проверки авторизации двухфакторной](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) , Джон Atten.</span><span class="sxs-lookup"><span data-stu-id="5649e-256">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="5649e-257">Несмотря на то, что при сбое попытки пароль имени входа можно задать блокировки учетной записи, такой подход делает ваше имя входа подвержен атакам с [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) блокировки.</span><span class="sxs-lookup"><span data-stu-id="5649e-257">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="5649e-258">Мы рекомендуем использовать только с 2FA блокировки учетной записи.</span><span class="sxs-lookup"><span data-stu-id="5649e-258">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="5649e-259">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="5649e-259">Additional Resources</span></span>

- [<span data-ttu-id="5649e-260">Обзор пользовательских поставщиков хранилищ для ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="5649e-260">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="5649e-261">[Приложение MVC 5 с Facebook, Twitter, LinkedIn и входа в Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) также показано, как добавить данные профиля в таблицу пользователей.</span><span class="sxs-lookup"><span data-stu-id="5649e-261">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="5649e-262">[ASP.NET MVC и удостоверение 2.0: представление об основах](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) , Джон Atten.</span><span class="sxs-lookup"><span data-stu-id="5649e-262">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="5649e-263">Введение в ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="5649e-263">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="5649e-264">[Объявляет о RTM ASP.NET удостоверения 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) по Pranav Rastogi.</span><span class="sxs-lookup"><span data-stu-id="5649e-264">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>

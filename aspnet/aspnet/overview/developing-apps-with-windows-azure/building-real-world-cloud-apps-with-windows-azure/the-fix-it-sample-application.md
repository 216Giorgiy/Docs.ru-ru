---
uid: aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/the-fix-it-sample-application
title: 'Приложение: Исправление его образец приложения (Создание реальных облачных приложений с Azure) | Документы Microsoft'
author: MikeWasson
description: Построение реального мира облачными приложениями с помощью Azure электронная книга основан на разработанный Скотт Гатри презентации. Объясняет, 13 шаблоны и рекомендации, которые он может...
ms.author: aspnetcontent
manager: wpickett
ms.date: 06/12/2014
ms.topic: article
ms.assetid: 1bc333c5-f096-4ea7-b170-779accc21c1a
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/the-fix-it-sample-application
msc.type: authoredcontent
ms.openlocfilehash: 9a1fa36b34c4783b101bb27bc6931241e9251e10
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
<a name="appendix-the-fix-it-sample-application-building-real-world-cloud-apps-with-azure"></a>Приложение: Исправление его образец приложения (Создание реальных облачных приложений с Azure)
====================
по [Mike Wasson](https://github.com/MikeWasson), [Рик Андерсон](https://github.com/Rick-Anderson), [Tom Dykstra](https://github.com/tdykstra)

[Загрузите исправление, он проекта](http://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4)

> **Построение реального мира облачными приложениями с помощью Azure** электронная книга основана на представления, разработанный Скотт Гатри. Объясняются 13 шаблоны и рекомендации, которые помогут вам быть успешной разработки веб-приложений для облака. Сведения об электронных книг см. в разделе [первой главы](introduction.md).


Это приложение для построения реального мира облачными приложениями с помощью Azure электронная книга содержит следующие разделы, предоставляющие дополнительные сведения об ее исправить образец приложения, который можно загрузить:

- [Известные проблемы](#knownissues)
- [Рекомендации](#bestpractices)
- [Запуск приложения из Visual Studio на локальном компьютере](#run-in-vs)
- [Развертывание базового приложения на веб-приложениях службы приложений Azure с помощью сценариев Windows PowerShell](#deploybase)
- [Устранение неполадок в сценариях Windows PowerShell](#troubleshooting)
- [Как развернуть приложение с очередью, обработку для веб-приложениях службы приложений Azure и облачной службы Azure](#deployqueues)

<a id="knownissues"></a>
## <a name="known-issues"></a>Известные проблемы

Чтобы проиллюстрировать быстро шаблонов, представленных в электронных книг было разработано приложение исправить. Тем не менее поскольку электронная книга о построении приложений, мы подвергается код исправления для проверки и тестирования процесса, аналогичного тому, что бы сделать для выпуска программного обеспечения. Обнаружено несколько проблем и как с любой реальных приложений некоторые из них были устранены, а некоторые из них мы отложено до более поздней версии.

В следующем списке перечислены проблемы, которые должны быть устранены в реальном приложении, но для одной из причин, или другой, мы решили не на адрес в первоначальной версии образца приложения ее исправить.

### <a name="security"></a>Безопасность

- Убедитесь, что невозможно назначить задачу владельцу несуществующий.
- Убедитесь, что вы можете только просматривать и изменять задач, созданных или назначенных вам.
- Используйте HTTPS для страницы входа и файлы cookie проверки подлинности.
- Укажите ограничение по времени для файлов cookie проверки подлинности.

### <a name="input-validation"></a>Проверка ввода

В общем случае производственного приложения может потребоваться несколько проверки ввода, чем приложения ее исправить. Например, размер изображения / image допустимый размер файла для загрузки, должны быть ограничены.

### <a name="administrator-functionality"></a>Функциональные возможности администратора

Администратор должен иметь возможность изменить владельца на существующие задачи. Например создателя задачи может остаться компании, в результате ни один центр для поддержания задачи, пока не будет включен административный доступ.

### <a name="queue-message-processing"></a>Обработка сообщений в очереди

Должен быть простым для иллюстрации шаблона ориентированное очереди рабочих с минимальным объемом кода была разработана очереди обработка сообщений в приложения ее исправить. Этот код прост не подходить для фактического производственного приложения.

- Код не гарантирует, что каждое сообщение очереди будет обрабатываться не более одного раза. При получении сообщения из очереди, имеется период времени ожидания, во время которого сообщение остается невидимым для других прослушивателей очередей. Если время ожидания истекает до удаления сообщения, сообщение снова становится видимым. Таким образом Если экземпляр роли рабочего процесса тратит много времени обработки сообщения, это теоретически возможно, для того же сообщения будут обработаны дважды, приведет к повторяющиеся задачи в базе данных. Дополнительные сведения об этой проблеме см. в разделе [с помощью очереди хранилища Azure](https://msdn.microsoft.com/library/ff803365.aspx#sec7).
- Логика опроса очереди может быть более экономически, пакетное выполнение получения сообщений. Каждый раз при вызове [CloudQueue.GetMessageAsync](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.queue.cloudqueue.getmessageasync.aspx), имеет место определенная потеря транзакций. Вместо этого можно вызвать метод [CloudQueue.GetMessagesAsync](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.queue.cloudqueue.getmessagesasync.aspx) (Обратите внимание, это множественное "), который получает несколько сообщений в одной транзакции. Затраты на транзакции для очереди хранилища Azure являются очень мало, поэтому влияние на расходы не является существенным для большинства сценариев.
- Непрерывном цикле в коде обработки сообщений очереди вызывает сходство ЦП, который не использует многоядерных виртуальных машинах эффективно. Параллелизм задач лучше использовать для параллельного выполнения нескольких асинхронных задач.
- Обработка сообщений очереди имеет обработка только элементарного исключений. Например, код не обрабатывает [сообщения о сбое](https://msdn.microsoft.com/library/ms789028.aspx). (При обработке сообщений возникает исключение, необходимо записать ошибку в журнал и удалить сообщение, или рабочей роли попытается повторно обработать и цикла будет продолжаться бесконечно.)

### <a name="sql-queries-are-unbounded"></a>SQL-запросы не имеют ограничений

Ее исправить код текущей размещает отсутствие ограничений на запросы для страниц индексов могут возвращать количество строк. Если большой объем задач вводится в базу данных, размер результирующей полученных списков могут вызывать проблемы производительности. Решение заключается в реализации подкачки. Пример см. в разделе [сортировка, фильтрация и разбиение на страницы с платформой Entity Framework в приложении MVC ASP.NET](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/sorting-filtering-and-paging-with-the-entity-framework-in-an-asp-net-mvc-application.md).

### <a name="view-models-recommended"></a>Просмотр моделей рекомендуется

Приложение исправить используется класс сущностей FixItTask для передачи данных между контроллером и представлением. Рекомендуется использовать представление модели. Модель домена (например, класс сущностей FixItTask) построена необходимые для сохранения данных модели представления может быть предназначена для представления данных. Дополнительные сведения см. в разделе [12 ASP.NET MVC рекомендаций](http://codeclimber.net.nz/archive/2009/10/27/12-asp.net-mvc-best-practices.aspx).

### <a name="secure-image-blob-recommended"></a>BLOB-объект безопасного образа рекомендуется

Магазины приложений ее исправить Отправить изображения как открытые, это означает, что кто-то находит URL-адрес изображения имеют доступ к. Изображения можно защитить вместо public.

### <a name="no-powershell-automation-scripts-for-queues"></a>Нет сценариев PowerShell автоматизации для очередей

Сценарии PowerShell автоматизации были написаны только для базовой версии ее исправить, полностью выполняется в веб-приложениях службы приложений Azure. Мы не указали скрипты для настройки и развертывания для приложения, а также среду облачной службы, необходимые для обработки очередей.

### <a name="special-handling-for-html-codes-in-user-input"></a>Специальная обработка кодов HTML, вводимые пользователем данные

ASP.NET автоматически предотвращает различными способами, в которых пользователи-злоумышленники могут попытаться межсайтовых атак с использованием сценариев, задав сценарий в полях ввода пользователя. И MVC `DisplayFor` вспомогательный метод, используемый для отображения задач заголовков и автоматически отмечает значения кодирует в формате HTML, которые он отправляет в браузер. Однако в рабочем приложении может потребоваться принять дополнительные меры. Дополнительные сведения см. в разделе [запрос проверки в ASP.NET](https://msdn.microsoft.com/library/hh882339.aspx).

<a id="bestpractices"></a>
## <a name="best-practices"></a>Рекомендации

Ниже приведены некоторые проблемы, которые были исправлены после, обнаруженных при проверке кода и тестирования исходную версию приложения ее исправить. Некоторые были вызваны исходного автору кода, не определенной рекомендуется учитывать некоторые просто потому, что код написан быстро и не предназначен для выпуска программного обеспечения. Мы вывод этой проблемы в случае, если что-то узнали из этой проверки и тестирования, могут оказаться полезными для других пользователей, также разработки веб-приложений.

### <a name="dispose-the-database-repository"></a>Удалить хранилище базы данных

`FixItTaskRepository` Класса необходимо уничтожить Entity Framework `DbContext` экземпляра. Мы сделали это, реализовав `IDisposable` в `FixItTaskRepository` класса:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample1.cs)]

Обратите внимание, что автоматически удаляет AutoFac `FixItTaskRepository` экземпляра, поэтому мы не нужно явно удалять.

Другой вариант заключается в удалении `DbContext` переменной-члена из `FixItTaskRepository`и вместо этого создать локальный `DbContext` переменных в каждый метод репозитория внутри `using` инструкции. Пример:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample2.cs)]

### <a name="register-singletons-as-such-with-di"></a>Таким образом зарегистрироваться единственных экземпляров DI

Поскольку только один экземпляр `PhotoService` класса и `Logger` требуется класс, эти классы должны быть [зарегистрирован как отдельные экземпляры для внедрения зависимости](https://code.google.com/p/autofac/wiki/InstanceScope) в *DependenciesConfig.cs*:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample3.cs?highlight=1,3)]

### <a name="security-dont-show-error-details-to-users"></a>Безопасность: Больше не показывать сведения об ошибке для пользователей

Общая ошибка страницы и просто позволить все исключения пузырьков до пользовательского интерфейса, поэтому некоторые исключения, такие как ошибки подключения базы данных может привести к полную трассировку стека отображаемая в браузере не исходное приложение ее исправить. Подробные сведения об ошибке, иногда может упростить атак злоумышленников. Решением является журнала сведения об исключении и отобразить страницу ошибки для пользователя, который не включает сведения об ошибке. Уже ведение журнала приложения ее исправить, и чтобы отобразить страницу ошибки, мы добавили `<customErrors mode=On>` в файле Web.config.

[!code-xml[Main](the-fix-it-sample-application/samples/sample4.xml?highlight=2)]

По умолчанию в результате *Views\Shared\Error.cshtml* для отображения ошибок. Вы можете настроить *Error.cshtml* или создайте собственные представления страницы ошибки и добавьте `defaultRedirect` атрибута. Можно также указать другие ошибки страниц для конкретных ошибок.

### <a name="security-only-allow-a-task-to-be-edited-by-its-creator"></a>Безопасность: разрешить только задачу, которую нужно изменить ее создатель

Страница индекса панели мониторинга отображаются только задачи, созданные вошедшего в систему пользователя, но злоумышленник может создать URL-адрес с Идентификатором задачу другим пользователем. Мы добавили код в *DashboardController.cs* для возврата в этом случае код 404:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample5.cs?highlight=9-14,24-29)]

### <a name="dont-swallow-exceptions"></a>Не проглатывания исключений

Исходное приложение ее исправить только вернул значение null после входа исключение, полученное из SQL-запроса:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample6.cs?highlight=4)]

Это сделает его выглядеть для пользователя, как в том случае, если запрос успешно выполнен, но только не возвращает ни одной строки. Решением является заново создать исключение после перехват и ведения журнала:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample7.cs)]

### <a name="catch-all-exceptions-in-worker-roles"></a>Перехватывать все исключения в рабочих ролях

Необработанные исключения в рабочей роли приведет к ВМ будет перезапущен, и поэтому необходимо поместить все в блок try-catch и обрабатывать все исключения.

### <a name="specify-length-for-string-properties-in-entity-classes"></a>Определение длины для свойства строки в классы сущностей

Для правильного отображения простого кода, исходная версия приложения исправить не был указан длины полей сущности FixItTask и в результате они не были определены как varchar(max) в базе данных. В результате любого количества входных данных принять пользовательского интерфейса. Указание ограничения длины наборы, которые применяются и к пользователю вводить данные в веб-страницы и размера столбца в базе данных:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample8.cs?highlight=4,7,10,12,14)]

### <a name="mark-private-members-as-readonly-when-they-arent-expected-to-change"></a>Пометить закрытых членов только для чтения, когда они не ожидаются для изменения

Например, в `DashboardController` класса экземпляр `FixItTaskRepository` создается и не предполагается изменять, чтобы было определено как [readonly](https://msdn.microsoft.com/library/acdd6hb7.aspx).

[!code-csharp[Main](the-fix-it-sample-application/samples/sample9.cs?highlight=3)]

### <a name="use-listany-instead-of-listcount-gt-0"></a>Используйте список. Any() вместо списка. Count() &gt; 0

Если вы важна, является ли один или несколько элементов в списке соответствуют критериям, указанным использовать [любой](https://msdn.microsoft.com/library/bb534972.aspx) метода, так как он возвращает как только обнаруживается элемент соответствует критериям, в то время как `Count` всегда имеет метод для перечисления через каждый элемент. Панели мониторинга *Index.cshtml* файл изначально содержал этот код:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample10.cshtml)]

Перейдем к этому:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample11.cshtml?highlight=1)]

### <a name="generate-urls-in-mvc-views-using-mvc-helpers"></a>Создание URL-адреса в представлений MVC с помощью вспомогательных методов MVC

Для **создать ее исправить** кнопки на домашней странице, исправьте его приложение жестких закодированных элемент привязки:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample12.cshtml)]

Для ссылки на представление или действия следующим образом лучше использовать [Url.Action](https://msdn.microsoft.com/library/system.web.mvc.urlhelper.action.aspx) вспомогательный метод HTML, например:

[!code-cshtml[Main](the-fix-it-sample-application/samples/sample13.cshtml)]

### <a name="use-taskdelay-instead-of-threadsleep-in-worker-role"></a>Используйте Task.Delay вместо Thread.Sleep в рабочей роли

Шаблон нового проекта помещает `Thread.Sleep` в образце кода для рабочей роли, но вызывает поток в спящий режим может привести к пула потоков для создания дополнительных потоков ненужные. Можно избежать, используя [Task.Delay](https://msdn.microsoft.com/library/hh139096.aspx) вместо него.

[!code-csharp[Main](the-fix-it-sample-application/samples/sample14.cs?highlight=11)]

### <a name="avoid-async-void"></a>Избегайте async void

Если асинхронный метод не нужно возвращать значение, возвращают `Task` типа вместо `void`.

Этот пример взят из `FixItQueueManager` класса: 

[!code-csharp[Main](the-fix-it-sample-application/samples/sample15.cs)]

Следует использовать `async void` только для обработчиков событий верхнего уровня. При определении метода в качестве `async void`, вызывающий объект не может **await** метода или перехватывать исключения, метод создает исключение. Дополнительные сведения см. в разделе [рекомендации в асинхронное программирование](https://msdn.microsoft.com/magazine/jj991977.aspx). 

### <a name="use-a-cancellation-token-to-break-from-worker-role-loop"></a>Использование токена отмены, чтобы прервать выполнение в цикле рабочей роли

Как правило **запуска** метод в рабочей роли содержит бесконечный цикл. При остановке рабочей роли, [RoleEntryPoint.OnStop](https://msdn.microsoft.com/library/windowsazure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx) вызывается метод. Этот метод следует использовать для отмены работы, который выполняется внутри **запуска** метод и выходе надлежащим образом. В противном случае — процесс может быть завершен в процессе выполнения операции.

### <a name="opt-out-of-automatic-mime-sniffing-procedure"></a>Отказаться от автоматической процедуры сканирование MIME

В некоторых случаях Internet Explorer сообщает тип MIME, отличается от типа, указанного в веб-сервере. Например если Internet Explorer находит HTML содержимого в файле, присутствующие в заголовке ответа HTTP Content-Type: text/plain, Internet Explorer определяет, что содержимое должна обрабатываться как HTML. К сожалению это «сканирование MIME» может также привести к проблемы безопасности для серверов размещения ненадежное содержимое. Для борьбы с этим Internet Explorer 8 внес ряд изменений в код определения типа MIME и позволяет разработчикам приложений [отказаться от сканирование MIME](https://blogs.msdn.com/b/ie/archive/2008/07/02/ie8-security-part-v-comprehensive-protection.aspx). Был добавлен следующий код *Web.config* файла.

[!code-xml[Main](the-fix-it-sample-application/samples/sample16.xml?highlight=2-7)]

### <a name="enable-bundling-and-minification"></a>Включить объединение и Минификация

Когда Visual Studio создает новый веб-проекта, объединение и Минификация файлы JavaScript не включен по умолчанию. Мы добавили в строку кода в BundleConfig.cs:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample17.cs?highlight=9)]

### <a name="set-an-expiration-time-out-for-authentication-cookies"></a>Задать время ожидания истечения срока действия для файлов cookie проверки подлинности

По умолчанию файлы cookie проверки подлинности истекает в течение двух недель. Сократить время является более безопасным. Можно изменить этот параметр в *StartupAuth.cs*:

[!code-csharp[Main](the-fix-it-sample-application/samples/sample18.cs?highlight=4-5)]

<a id="run-in-vs"></a>
## <a name="how-to-run-the-app-from-visual-studio-on-your-local-computer"></a>Запуск приложения из Visual Studio на локальном компьютере

Для запуска приложения исправить двумя способами.

- Выполнения базового приложения, которое записывает новые задачи непосредственно в базе данных SQL.
- Запустите приложение, использующее очереди, а также серверную службу для создания задачи. Шаблон очереди описывается в главе [ориентированное очереди рабочих шаблон](queue-centric-work-pattern.md).

<a id="runbase"></a>
### <a name="run-the-base-application"></a>Запустите базового приложения

1. Установка [Visual Studio 2013 или Visual Studio 2013 Express для Web](https://www.visualstudio.com/downloads).
2. Установка [Azure SDK для .NET для Visual Studio 2013.](https://go.microsoft.com/fwlink/p/?linkid=323510&amp;clcid=0x409)
3. Загрузите ZIP-файл из [коллекции кода MSDN](https://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4).
4. В проводнике щелкните правой кнопкой мыши ZIP-файл и выберите пункт Свойства, а затем в окне свойств нажмите кнопку разблокировать.
5. Распакуйте файлы.
6. Дважды щелкните файл .sln, чтобы запустить Visual Studio.
7. Из меню «Сервис» выберите диспетчер пакетов библиотеки, затем консоль диспетчера пакетов.
8. В пакет Диспетчер консоли (PMC), нажмите кнопку Восстановить.
9. Закройте Visual Studio.
10. Запуск [эмулятор хранилища Azure](https://msdn.microsoft.com/library/windowsazure/hh403989.aspx).
11. Перезапустите Visual Studio, при открытии файла решения, закрыт на предыдущем шаге.
12. Убедитесь, что проект решить задано как автозагружаемый проект и нажмите клавишу CTRL + F5, чтобы запустить проект.

<a id="queueslocal"></a>
### <a name="run-the-application-with-queue-processing"></a>Запуск приложения с обработкой очереди

1. Следуйте инструкциям для [выполнения базового приложения](#runbase), а затем закройте окно браузера и закрыть Visual Studio.
2. Запустите Visual Studio с правами администратора. (Вы будете использовать эмулятор вычислений Azure, и, требуются права администратора).
3. В приложении *Web.config* файла в *MyFixIt* проекта (веб-проекта), измените значение `appSettings/UseQueues` значение «true»: 

    [!code-console[Main](the-fix-it-sample-application/samples/sample19.cmd?highlight=3)]
4. Если [эмулятор хранилища Azure](https://msdn.microsoft.com/library/windowsazure/hh403989.aspx) не все еще выполняется, запустите его снова.
5. Одновременно запустите решить веб-проекта и MyFixItCloudService проекта.

    С помощью Visual Studio 2013:

   1. Нажмите клавишу F5 для запуска проекта решить.
   2. В **обозревателе решений**, щелкните правой кнопкой мыши проект MyFixItCloudService и нажмите кнопку **отладки** -- **запустить новый экземпляр**.

      С помощью Visual Studio 2013 Express для Web.

   3. В обозревателе решений щелкните правой кнопкой мыши решение решить и выберите **свойства**.
   4. Выберите **несколько запускаемых проектов**...
   5. В **действия** выберите раскрывающийся список в разделе MyFixIt и MyFixItCloudService, **запустить**.
   6. Нажмите кнопку **ОК**.
   7. Нажмите клавишу F5 для запуска обоих проектов.

      При запуске проекта MyFixItCloudService Visual Studio запускает эмулятор вычислений Azure. В зависимости от конфигурации брандмауэра необходимо разрешить эмулятор через брандмауэр.

<a id="deploybase"></a>
## <a name="how-to-deploy-the-base-app-to-azure-app-service-web-apps-by-using-the-windows-powershell-scripts"></a>Развертывание базового приложения на веб-приложениях службы приложений Azure с помощью сценариев Windows PowerShell

Чтобы проиллюстрировать [автоматизировать все](automate-everything.md) шаблон приложения исправить прилагается скрипты, Настройка среды в Azure и развертывание проекта в новую среду. Следующие инструкции описывают использование скриптов.

Если вы хотите запустить в Azure без использования очередей и внесения изменений, чтобы запустить его локально с очередями, убедитесь, что значение UseQueues appSetting значение false, прежде чем продолжить, следующие инструкции.

Данные инструкции предполагают уже загружены и запустите это решение исправить его локально, и у вас есть Azure учетной записи или есть подписка Azure, у вас прав на управление.

1. Установка **Azure PowerShell** консоли. Инструкции см. в разделе [описывается установка и настройка Azure PowerShell](https://docs.microsoft.com/powershell/azure/overview?view=azurermps-4.3.1).

    Это специальная консоль настроена для работы с вашей подпиской Azure. Модуль Azure устанавливается в *Program Files* directory и автоматически импортируется при использовании каждой консоли Azure PowerShell.

    Если вы предпочитаете работать в программе другой узел, например интегрированная среда Сценариев Windows PowerShell, обязательно используйте [Import-Module](https://go.microsoft.com/fwlink/?LinkID=141553) командлет, чтобы импортировать модуль Azure или используйте команды в модуле Azure для запуска автоматический импорт модуля.
2. Запустите Azure PowerShell **Запуск от имени администратора** параметр.
3. Запустите [Set-ExecutionPolicy](https://go.microsoft.com/fwlink/p/?linkid=293941) командлет, чтобы задать политику выполнения Azure PowerShell `RemoteSigned`. Введите **Y** (для подтверждения) для завершения изменения политики.

    [!code-console[Main](the-fix-it-sample-application/samples/sample20.cmd)]

    Этот параметр позволяет выполнять локальные сценарии, не имеющие цифровой подписи. (Можно также задать политику выполнения `Unrestricted`, которой будет отпадает необходимость unblock шагу позднее, но это не рекомендуется по соображениям безопасности.)
4. Запустите `Add-AzureAccount` командлет, чтобы настроить PowerShell с учетными данными для вашей учетной записи.

    [!code-console[Main](the-fix-it-sample-application/samples/sample21.cmd)]

    Эти учетные данные, срок действия истекает после определенного периода времени, и вам нужно повторно запускать `Add-AzureAccount` командлета. Записи эта электронная книга предельного времени до истечения срока действия учетных данных составляет 12 часов.
5. Если у вас несколько подписок, позволяет указать подписки, которую необходимо создать тестовую среду, в командлет Select-AzureSubscription.
6. Импортируйте сертификат управления для той же подписке Azure с помощью `Get-AzurePublishSettingsFile` и `Import-AzurePublishSettingsFile` командлетов. Первый из этих командлетов загружает файл сертификата, а во второй указать расположение этого файла, чтобы импортировать его. > [!IMPORTANT]
   > Сохранить загруженный файл в безопасном месте или удалите его после завершения, так как он содержит сертификат, который может использоваться для управления службами Azure.

    [!code-console[Main](the-fix-it-sample-application/samples/sample22.cmd)]

    Этот сертификат используется для вызова API-Интерфейс REST, который определяет IP-адреса компьютера разработки, чтобы задать правила брандмауэра на сервере базы данных SQL.
7. Запустите [Set-Location](https://go.microsoft.com/fwlink/p/?linkid=293912) командлета (псевдонимы `cd`, `chdir`, и `sl`) для перехода в каталог, содержащий скрипты. (Они находятся в *автоматизации* папку в папке решения ее исправить.) Заключите путь в кавычки, если какие-либо имена каталога содержат пробелы. Например, чтобы перейти к `c:\Sample Apps\FixIt\Automation` каталога, можно ввести следующую команду:

    [!code-console[Main](the-fix-it-sample-application/samples/sample23.cmd)]
8. Чтобы разрешить Windows PowerShell для выполнения этих сценариев, используйте [Unblock-File](https://go.microsoft.com/fwlink/p/?linkid=294021) командлета. (Сценарии заблокированы, так как они были загружены из Интернета.)

    > [!WARNING]
    > Безопасность — перед запуском `Unblock-File` на любой сценарий или исполняемый файл, откройте файл в блокноте, проверить команды и убедитесь, что они не содержат вредоносный код.

    Например, следующая команда запускает `Unblock-File` командлет на всех скриптов в текущем каталоге.

    [!code-console[Main](the-fix-it-sample-application/samples/sample24.cmd)]
9. Чтобы создать веб-приложение для базы (без обработки очередей) устранить проблему запуска сценария среды создания приложений.

    Необходимая `Name` параметр указывает имя базы данных и используется для учетной записи хранения, который создает скрипт. Имя должно быть глобально уникальным в домене azurewebsites.net. Если указать имя, которое не является уникальным, как решить или теста (или даже как в примере, fixitdemo) `New-AzureWebsite` возникла внутренняя ошибка, которая сообщает конфликт происходит сбой командлета. Скрипт имя преобразует все буквы в нижнем регистре в соответствии с требованиями имя веб-приложений, учетные записи хранения и баз данных.

    Необходимая `SqlDatabasePassword` указывает пароль для учетной записи администратора, который будет создан для базы данных SQL. Не включать специальные символы XML в пароле (&amp; &lt; &gt; ;). Это ограничение способа написания скриптов не ограничение в Azure.

    Например если вы хотите создать веб-приложения с именем «fixitdemo» и использовать пароль администратора SQL Server «Passw0rd1», можно ввести следующую команду:

    [!code-console[Main](the-fix-it-sample-application/samples/sample25.cmd)]

    Имя должно быть уникальным в домене azurewebsites.net и пароль должен соответствовать требованиям базы данных SQL к сложности паролей. (Пример Passw0rd1 соответствует требованиям).

    Обратите внимание, что команда начинается с «. \". Для предотвращения выполнения вредоносных скриптов, Windows PowerShell необходимо указать полный путь к файлу скрипта при запуске сценария. Для указания текущего каталога можно использовать точку (».\") или укажите полный путь, например:

    [!code-console[Main](the-fix-it-sample-application/samples/sample26.cmd)]

    Дополнительные сведения о сценарии использования `Get-Help` командлета.

    [!code-console[Main](the-fix-it-sample-application/samples/sample27.cmd)]

    Можно использовать `Detailed`, `Full`, `Parameters`, и `Examples` параметры командлета Get-Help фильтр справки, который возвращается.

    При сбое скрипта, или приводит к возникновению ошибки, например «New-AzureWebsite: вызов Set-AzureSubscription и Select-AzureSubscription первый,» может не завершена конфигурации Azure PowerShell.

    По завершении сценария на портале управления Azure можно использовать для просмотра ресурсов, которые были созданы, как показано в [автоматизировать все](automate-everything.md) главы.
10. Для развертывания проекта решить в новую среду Azure, используйте *AzureWebsite.ps1* сценария. Пример:

    [!code-console[Main](the-fix-it-sample-application/samples/sample28.cmd)]

    По завершении развертывания браузера откроется с ее исправить в Azure.

<a id="troubleshooting"></a>
## <a name="troubleshooting-the-windows-powershell-scripts"></a>Устранение неполадок в сценариях Windows PowerShell

Наиболее распространенные ошибки, возникшие при выполнении этих скриптов, связаны с разрешениями. Убедитесь, что `Add-AzureAccount` и `Import-AzurePublishSettingsFile` выполнены успешно, и использовать их для той же подписке Azure. Даже если `Add-AzureAccount` был успешно может потребоваться повторно запустить ее. Разрешения, добавленные `Add-AzureAccount` срок действия истекает через 12 часов.

### <a name="object-reference-not-set-to-an-instance-of-an-object"></a>Ссылка на объект не указывает на экземпляр объекта.

Если сценарий возвращает ошибки, такие как «Ссылка на объект не указывает на экземпляр объекта,» что означает, что Windows PowerShell не может найти объект процесса (это исключение null reference), запустите `Add-AzureAccount` командлета и повторите попытку скрипт.

[!code-console[Main](the-fix-it-sample-application/samples/sample29.cmd)]

### <a name="internalerror-the-server-encountered-an-internal-error"></a>InternalError: Сервер обнаружил внутреннюю ошибку.

`New-AzureWebsite` Командлет возвращает внутреннюю ошибку, если имя не является уникальным в домене azurewebsites.net. Чтобы устранить эту ошибку, используйте другое значение для имени в параметре Name *New AzureWebsiteEnv.ps1*.

[!code-console[Main](the-fix-it-sample-application/samples/sample30.cmd)]

### <a name="restarting-the-script"></a>Перезапустить сценарий

Если вам требуется перезапустить *New AzureWebsiteEnv.ps1* сценарий из-за сбоя до его вывода на печать сообщения «Сценарий завершена», может потребоваться удалить ресурсы, которые сценарий, созданные до ее остановки. Например если скрипт был создан ContosoFixItDemo веб-приложение и снова запустите скрипт с тем же именем, скрипт завершится, так как оно используется.

Чтобы определить, какие ресурсы сценария, созданных до ее остановки, используйте следующие командлеты:

- `Get-AzureWebsite`
- `Get-AzureSqlDatabaseServer`
- `Get-AzureSqlDatabase`: Чтобы запустить этот командлет, передайте имя сервера базы данных, чтобы `Get-AzureSqlDatabase`:  
    `Get-AzureSqlDatabaseServer | Get-AzureSqlDatabase.`

Чтобы удалить эти ресурсы, выполните следующие команды. Обратите внимание, что при удалении сервера базы данных, вы автоматически удалять баз данных, связанных с сервером.

- `Get-AzureWebsite -Name <WebsiteName> | Remove-AzureWebsite`
- `Get-AzureSqlDatabase -Name <DatabaseName> -ServerName <DatabaseServerName> | Remove-SqlAzureDatabase`
- `Get-AzureSqlDatabaseServer | Remove-AzureSqlDatabaseServer`

<a id="deployqueues"></a>
## <a name="how-to-deploy-the-app-with-queue-processing-to-azure-app-service-web-apps-and-an-azure-cloud-service"></a>Как развернуть приложение с очередью, обработку для веб-приложениях службы приложений Azure и облачной службы Azure

Для включения очередей, внести следующие изменения в файл MyFixIt\Web.config. В разделе `appSettings`, измените значение `UseQueues` значение «true»: 

[!code-xml[Main](the-fix-it-sample-application/samples/sample31.xml)]

Затем выполняется развертывание приложения MVC в веб-приложение в службе приложений Azure, как описано [предыдущих](#deploybase).

Создайте новую Azure облачную службу. Скрипты, входящий в состав приложения исправить не создаются и развертывание облачной службы, поэтому для этого необходимо использовать портал Azure. На портале щелкните **New** -- **вычислений** — **облачной службы** -- **быстрое создание**, а затем введите URL-адрес и расположение центра обработки данных. Используйте в одном центре обработки данных, где развернут веб-приложения.

![](the-fix-it-sample-application/_static/image1.png)

Перед развертыванием облачной службы необходимо обновить некоторые из файлов конфигурации.

В MyFixIt.WorkerRoler\app.config в разделе `connectionStrings`, замените значение `appdb` строку подключения в строке фактические подключения для базы данных SQL. Строку подключения можно получить на портале. На портале щелкните **баз данных SQL** - **appdb** - **представление базы данных SQL строки подключения для ADO .net, ODBC, PHP и JDBC**. Скопируйте строку подключения ADO.NET и вставьте значение в файле app.config. Замените «{вашей\_пароль\_здесь}» с пароль базы данных. (При условии, что используемые сценарии для развертывания приложения MVC, указанный пароль базы данных в `SqlDatabasePassword` параметр скрипта.)

Результат должен выглядеть следующим образом:

[!code-xml[Main](the-fix-it-sample-application/samples/sample32.xml)]

В том же файле MyFixIt.WorkerRoler\app.config под `appSettings`, замените значения заполнителей два учетной записи хранилища Azure.

[!code-xml[Main](the-fix-it-sample-application/samples/sample33.xml?highlight=2-3)]

Ключ доступа можно получить на портале. В разделе [управление учетными записями хранения](https://docs.microsoft.com/azure/storage/common/storage-create-storage-account).

В MyFixItCloudService\ServiceConfiguration.Cloud.cscfg замените же два значения заполнителей, для учетной записи хранилища Azure.

[!code-xml[Main](the-fix-it-sample-application/samples/sample34.xml?highlight=3)]

Теперь вы готовы к развертыванию облачной службы. В обозревателе решений, правой кнопкой мыши проект MyFixItCloudService и выберите **публикации**. Дополнительные сведения см. в разделе «[развернуть приложение в Azure](https://www.windowsazure.com/develop/net/tutorials/multi-tier-web-site/2-download-and-run/#deployAz)«, который находится во второй части [этого учебника](https://code.msdn.microsoft.com/Windows-Azure-Multi-Tier-eadceb36).

> [!div class="step-by-step"]
> [Назад](more-patterns-and-guidance.md)

---
uid: aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern
title: Ориентированное на очередь рабочих шаблон (Создание реальных облачных приложений в Azure) | Документы Microsoft
author: MikeWasson
description: Построение реального мира облачными приложениями с помощью Azure электронная книга основан на разработанный Скотт Гатри презентации. Объясняет, 13 шаблоны и рекомендации, которые он может...
ms.author: aspnetcontent
manager: wpickett
ms.date: 06/12/2014
ms.topic: article
ms.assetid: cc1ad51b-40c3-4c68-8620-9aaa0fd1f6cf
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/queue-centric-work-pattern
msc.type: authoredcontent
ms.openlocfilehash: 124e673206ecea2eac5efb8c2802a32a690fa104
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
ms.locfileid: "30875439"
---
<a name="queue-centric-work-pattern-building-real-world-cloud-apps-with-azure"></a>Ориентированное на очередь рабочих шаблон (Создание реальных облачных приложений в Azure)
====================
по [Mike Wasson](https://github.com/MikeWasson), [Рик Андерсон](https://github.com/Rick-Anderson), [Tom Dykstra](https://github.com/tdykstra)

[Загрузка решение проект](http://code.msdn.microsoft.com/Fix-It-app-for-Building-cdd80df4) или [Загрузите электронную](http://blogs.msdn.com/b/microsoft_press/archive/2014/07/23/free-ebook-building-cloud-apps-with-microsoft-azure.aspx)

> **Построение реального мира облачными приложениями с помощью Azure** электронная книга основана на представления, разработанный Скотт Гатри. Объясняются 13 шаблоны и рекомендации, которые помогут вам быть успешной разработки веб-приложений для облака. Сведения об электронных книг см. в разделе [первой главы](introduction.md).


Ранее, мы узнали, что с помощью нескольких служб может привести «составной» SLA, где действующие соглашения об уровне ОБСЛУЖИВАНИЯ приложения *продукта* отдельных соглашений об уровне обслуживания. Например приложение ее исправить использует веб-сайтов, хранилища и базы данных SQL. Если в случае сбоя одного из этих служб приложения возникает сообщение об ошибке для пользователя.

Кэширование — хороший способ обработки временных сбоев для содержимого только для чтения. Но что делать, если приложению требуется для выполнения работы? Например при отправке новую задачу ее исправить, приложение просто нельзя поместить задачу в кэш. Приложение, необходимо написать задачу ее исправить в постоянное хранилище, поэтому оно может быть обработано.

Это происходит, когда вступает в дело шаблон ориентированное очереди рабочих. Этот шаблон позволяет слабой связи между веб-уровня и серверной службы.

Шаблон работает следующим образом. Когда приложение получает запрос, он помещает рабочего элемента очереди и немедленно возвращает ответ. Затем отдельные фоновой обработки извлекает рабочие элементы из очереди и выполняет работу.

Шаблон ориентированное очереди рабочих полезна для:

- Работы, которую требуется много времени (Высокая задержка).
- Действия, требующие внешнюю службу, которая может не всегда доступны.
- Работы, интенсивно (высокой загрузки ЦП).
- Работа, извлекут заметную выгоду из скорость выравнивание (изменяться взрывообразно внезапное нагрузки).

## <a name="reduced-latency"></a>Уменьшенная задержки

Очереди полезны каждый раз, когда вы выполняете долгой работы. Если задача занимает несколько секунд или больше, вместо блокировки конечного пользователя, помещены в очередь рабочий элемент. Попросить пользователя «Мы работаем над ее» и затем использовать прослушиватель очереди для обработки задачи в фоновом режиме.

Например при покупке чего-либо в Интернет-магазине, веб-сайт подтверждает ваш заказ немедленно. Но это не значит, что у вас уже есть в грузовик доставки. Задача они помещаются в очередь, и в фоновом режиме их выполнение проверки кредита, Подготовка к поставке, элементы и так далее.

Для сценариев с задержкой короткое общее время начала до конца может занять больше, посредством очереди, по сравнению с синхронно выполнить эту задачу. Но даже в таком случае другие преимущества, могут перевесить этот недостаток.

## <a name="increased-reliability"></a>Повышенная надежность

В версии ее исправить, мы рассмотрели к текущему моменту веб-сервера, тесно связана с серверной части базы данных SQL. Если служба базы данных SQL недоступна, пользователь получает ошибку. Если повторные попытки не работают (сбоя является более одного временного), единственное, что можно сделать — сообщению об ошибке и запрашивать у пользователя и повторите попытку позже.

![Схема отображение клиентского веб-интерфейса сбоя при сбое внутренней базы данных SQL](queue-centric-work-pattern/_static/image1.png)

С помощью очереди, когда пользователь отправляет задачу ее исправить, приложение записывает сообщение в очередь. Полезные данные сообщения [JSON](http://json.org/) представление задачи. Сразу после записи сообщения в очередь, приложение возвращает и сразу же показывает сообщение об успешном создании пользователя.

Если какой-либо службы базы данных — например, база данных SQL или прослушивателя очереди--переходят в автономный режим, пользователи могут по-прежнему отправлять новые задачи ее исправить. До серверных служб, доступны только очередь сообщений. На этом этапе будет Догнать серверных служб в невыполненной работе.

![Схема, показывающая web интерфейса продолжает функционировать при ошибке базы данных SQL](queue-centric-work-pattern/_static/image2.png)

Кроме того теперь можно добавить дополнительные алгоритмы серверной части, не беспокоясь о гибкости внешнего интерфейса. Например может потребоваться для отправки электронной почты или SMS-сообщения с владельцем всякий раз, когда назначается новый ее исправить. Если адрес электронной почты или служба SMS становится недоступным, можно обрабатывать все остальные и затем поместить сообщение в отдельную очередь для отправки сообщений электронной почты и SMS.

Ранее, действующие СОГЛАШЕНИИ была веб-приложений &times; хранения &times; базы данных SQL = 99.7%. (См. [разработки выдержать сбои](design-to-survive-failures.md).)

Если мы изменили приложению использовать очереди, веб-интерфейса зависит только от веб-приложений и хранилищами для составного 99.8% соглашение об уровне ОБСЛУЖИВАНИЯ. (Обратите внимание, что очереди являются частью службы хранилища Azure, поэтому они будут включены в соглашение об уровне ОБСЛУЖИВАНИЯ, как хранилище больших двоичных объектов).

Если вам требуется даже лучше, чем 99.8%, можно создать две очереди в двух разных регионах. Назначьте один — как основной, а другая — сервер-получатель. В вашем приложении при сбое в дополнительную очередь Если основная очередь недоступна. Вероятность того, что оба недоступен в то же время очень мала.

## <a name="rate-leveling-and-independent-scaling"></a>Выравнивание скорость и независимых масштабирование

Очереди также полезны для объекта, называемого *интенсивность выравнивания* или *выравнивание нагрузки*.

Веб-приложения часто являются восприимчивым к резкому увеличению трафика. При использовании автоматического масштабирования для автоматического добавления веб-серверов для обработки повышенной веб-трафик автоматическое масштабирование не можно достаточно быстро реагировать на внезапные пиковой нагрузки. Если веб-серверов можно перенаправить работу некоторых функций, они должны делать, записав сообщение в очередь, они могут обрабатывать больше трафика. Серверная служба можно читать сообщения из очереди и обрабатывать их. Глубина очереди будет разрастании или сжатии как входящая нагрузка меняется.

С основную часть времени работы выгружаются серверную службу веб-уровень более легко может отвечать на внезапные всплески нагрузки трафика. И сократить затраты, так как для любого заданного количества трафика могло быть обработано меньшее число веб-серверов.

Можно масштабировать веб-уровня и серверной службой независимо друг от друга. Например может потребоваться три веб-сервера, но только один сервер обработка очереди сообщений. Или, если вы используете задачу с большим объемом вычислений в фоновом режиме, может потребоваться несколько внутренних серверов.

![](queue-centric-work-pattern/_static/image3.png)

Автоматическое масштабирование работает серверных служб, а также веб-уровня. Вы может масштабирования вверх и вниз число виртуальных машин, которые обрабатываются задач в очереди, в зависимости от использования ЦП виртуальных машин серверной части. Кроме того, можно автоматического масштабирования в зависимости от того, сколько элементов находятся в очереди. Например можно настроить Автомасштабирование, чтобы попытаться сохранить не более 10 элементов в очереди. Если очередь содержит более 10 элементов, автомасштабирования будет добавлять виртуальные машины. Когда они Догнать автомасштабирования завершит дополнительных виртуальных машин.

## <a name="adding-queues-to-the-fix-it-application"></a>Добавление для исправления ставит его в очередь приложения

Чтобы реализовать шаблон очереди, необходимо внести два изменения в приложение ее исправить.

- Когда пользователь отправляет новую задачу ее исправить, поместите задачи в очереди, вместо записи в базу данных.
- Создайте серверную службу, обрабатывающего сообщения в очереди.

Для очереди, мы будем использовать [службы хранилища очередей Azure](https://www.windowsazure.com/develop/net/how-to-guides/queue-service/). Другой вариант — использовать [Azure Service Bus](https://docs.microsoft.com/azure/service-bus/).

Чтобы решить, какие службы очередей для использования, рассмотрим, как ваше приложение должно отправлять и получать сообщения в очереди.

- При наличии сотрудничающих производители и конкурирующих клиентов, рассмотрите возможность использования службы хранилища очередей Azure. «Cooperating производители» означает, что несколько процессов добавляются к очереди сообщений. «Конкурирующих клиентов» означает несколько процессов извлекать сообщения из очереди, для их обработки, но любого заданного сообщения могут обрабатываться только один «потребитель». Если требуется более высокая пропускная способность, чем можно получить с помощью одной очереди, используйте дополнительные очереди и (или) дополнительные учетные записи хранения.
- Если вам требуется [модели публикации и подписки](http://en.wikipedia.org/wiki/Publish/subscribe), рассмотрите возможность использования очереди шины обслуживания Azure.

Приложение исправить соответствует сотрудничающих производители и конкурирующих потребителей модели.

Другой аспект — доступность приложения. Службы хранения очередей является частью той же службе, мы используем для хранилища больших двоичных объектов, поэтому его использование не оказывает влияния на СОГЛАШЕНИИ. Azure Service Bus является отдельной службе с свои собственные соглашения об уровне ОБСЛУЖИВАНИЯ. При использовании очереди Service Bus, придется учитывать дополнительный процент соглашения об уровне ОБСЛУЖИВАНИЯ и СОГЛАШЕНИИ составного будет ниже. При выборе службы очередей, убедитесь, что вы понимаете влияние по своему выбору на доступность приложения. Дополнительные сведения см. в разделе [ресурсов](#resources) раздела.

## <a name="creating-queue-messages"></a>Создание очереди сообщений

Чтобы помещается в очередь задачу ее исправить, веб-интерфейса выполняет следующие действия:

1. Создание [CloudQueueClient](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.queue.cloudqueueclient.aspx) экземпляра. `CloudQueueClient` Экземпляра используется для выполнения запросов к службе очередей.
2. Создайте очередь, если он еще не существует.
3. Сериализация задачи ее исправить.
4. Вызовите [CloudQueue.AddMessageAsync](https://msdn.microsoft.com/library/microsoft.windowsazure.storage.queue.cloudqueue.addmessageasync.aspx) поместить сообщение в очередь.

Мы сделаем это в конструкторе действий и `SendMessageAsync` новый метод `FixItQueueManager` класса.

[!code-csharp[Main](queue-centric-work-pattern/samples/sample1.cs?highlight=11-12,16,18-25)]

Здесь мы используем [Json.NET](https://github.com/JamesNK/Newtonsoft.Json) библиотеки для сериализации решить в формат JSON. Можно использовать независимо от выбранного подхода сериализации вы предпочитаете. JSON имеет ряд преимуществ удобной для чтения, не менее подробной, чем XML.

Производственного качества кода бы добавить логику обработки ошибок, приостанавливается, если база данных становится недоступным, обрабатывать восстановления более аккуратно, создать очередь при запуске приложения и управление»[подозрительных» сообщений](https://msdn.microsoft.com/library/ms789028(v=vs.110).aspx). (Сообщение считается подозрительным сообщение, которое не может обработать по некоторым причинам. Вы не хотите подозрительных сообщений и размещения в очереди, где рабочая роль постоянно попытается их обработки, сбой, повторите попытку, сбой и т. д.)

В интерфейсном приложении MVC необходимо обновить код, который создает новую задачу. Вместо того, чтобы задача в репозиторий, вызовите `SendMessageAsync` в приведенном выше примере.

[!code-csharp[Main](queue-centric-work-pattern/samples/sample2.cs?highlight=10)]

## <a name="processing-queue-messages"></a>Обработка сообщений в очереди

Для обработки сообщений в очереди, мы создадим серверной службы. Серверная служба будет выполняться бесконечный цикл, который выполняет следующие действия:

1. Получение следующего сообщения из очереди.
2. Десериализовать сообщение задаче ее исправить.
3. Задача исправить записи в базу данных.

Чтобы разместить во внутреннюю службу, мы создадим облачные службы, содержащий *рабочей роли*. Рабочая роль состоит из одного или нескольких виртуальных машин, которые могут выполнять обработку серверной части. Код, выполняемый в этих виртуальных машинах будет получать сообщения из очереди, как только они станут доступны. Для каждого сообщения мы десериализации полезные данные JSON и записи экземпляра сущности исправить его задача в базу данных с помощью одного репозитория, который мы использовали ранее в веб-уровня.

Ниже показано, как добавить рабочий проект роли решение, которое содержит стандартные веб-проекта. Эти шаги уже были выполнены в ее исправить проект, который можно загрузить.

Сначала добавьте в решение Visual Studio проекта облачной службы. Щелкните правой кнопкой мыши решение и выберите **добавить**, затем **новый проект**. В левой области разверните **Visual C#** и выберите **облака**.

[![](queue-centric-work-pattern/_static/image5.png)](queue-centric-work-pattern/_static/image4.png)

В **новая облачная служба Azure** диалогового окна разверните **Visual C#** узел на левой панели. Выберите **рабочей роли** и щелкните значок со стрелкой вправо.

![](queue-centric-work-pattern/_static/image6.png)

(Обратите внимание, что можно также добавить *веб-роли*. Нам удалось запустить ее исправить переднего плана в той же облачной службе вместо ее выполнения веб-сайта в Azure. Имеет некоторые преимущества в Облегчение координации соединения между внешними и серверной части. Однако для простоты в этой демонстрации мы сохранения внешнего интерфейса в веб-приложение службы приложений Azure и только под управлением серверной части в облачной службе.)

Имя по умолчанию назначается рабочей роли. Чтобы изменить имя, наведите указатель мыши рабочей роли в правой области, а затем щелкните значок карандаша.

![](queue-centric-work-pattern/_static/image7.png)

Нажмите кнопку **ОК** завершения диалогового окна. Это добавляет два проекта в решение Visual Studio.

- проект Azure, который определяет облачной службы, включая сведения о конфигурации.
- Проект рабочей роли, который определяет рабочей роли.

![](queue-centric-work-pattern/_static/image8.png)

Дополнительные сведения см. в разделе [Создание проекта Azure с помощью Visual Studio.](https://msdn.microsoft.com/library/windowsazure/ee405487.aspx)

В рабочей роли, мы извлекать сообщения путем вызова `ProcessMessageAsync` метод `FixItQueueManager` класс, который мы видели ранее.

[!code-csharp[Main](queue-centric-work-pattern/samples/sample3.cs?highlight=25)]

`ProcessMessagesAsync` Метод проверяет, существует ли ожидания сообщения. Если таковой имеется, он выполняет десериализацию сообщений в `FixItTask` сущности и сохраняет объект в базе данных. Он циклов, пока очередь пуста.

[!code-csharp[Main](queue-centric-work-pattern/samples/sample4.cs)]

Опрос очереди сообщений небольшой транзакции влечет за собой издержки, поэтому, когда нет сообщений, ожидающих обработки, рабочей роли `RunAsync` метод ожидает в течение секунды опроса повторно путем вызова `Task.Delay(1000)`.

В проекте веб-Добавление асинхронного кода можно автоматически повысит производительность, так как службы IIS управляют ограниченный потоков. Это не так, в проект рабочей роли. Для повышения масштабируемости рабочей роли, можно написать код, многопоточные или использовать асинхронный код для реализации [параллельного программирования](https://msdn.microsoft.com/library/ff963553.aspx). Образец не реализует параллельного программирования, но также показано, как сделать асинхронный код, чтобы реализовать параллельного программирования.

## <a name="summary"></a>Сводка

В этой главе вы знаете, как повысить скорость реагирования приложения, надежность и масштабируемость посредством реализации шаблона ориентированное очереди рабочих.

Это последний из 13 шаблоны, описанные в этом электронная книга, но конечно существуют другие шаблоны и рекомендации, которые помогут вам создавать приложения успешно облака. [Последней главе](more-patterns-and-guidance.md) ссылки на ресурсы разделов, которые еще не были описаны в эти шаблоны 13.

<a id="resources"></a>
## <a name="resources"></a>Ресурсы

Дополнительные сведения об очередях см. следующие ресурсы.

Документация:

- [Microsoft Azure хранилища очередей, часть 1: Приступая к работе](http://justazure.com/microsoft-azure-storage-queues-part-1-getting-started/). Статьи по Schacherl латинского.
- [Выполнение фоновых задач](https://msdn.microsoft.com/library/ff803365.aspx), главе 5 [перемещение приложения в облако, 3-е издание](https://msdn.microsoft.com/library/ff728592.aspx) из шаблонов и методов Майкрософт. (В частности, раздел [«С помощью очереди хранилища Azure»](https://msdn.microsoft.com/library/ff803365.aspx#sec7).)
- [Советы и рекомендации по достижению максимальной масштабируемости и экономической эффективности обмена сообщениями решения на основе очередей на платформе Azure](https://msdn.microsoft.com/library/windowsazure/hh697709.aspx). Технический документ по Валерий Мизонов.
- [Сравнение очередей Azure и очереди Service Bus](https://msdn.microsoft.com/magazine/jj159884.aspx). MSDN Magazine, также приводятся дополнительные сведения, которые могут помочь выбрать службы очереди. Статья указывается, что Service Bus зависит ACS для проверки подлинности, это означает, что SB очередям, будут недоступны при недоступности ACS. Тем не менее, так как статья была написана, SB был изменен на позволяют использовать [маркеры SAS](https://msdn.microsoft.com/library/windowsazure/dn170477.aspx) вместо ACS.
- [Шаблоны и методики - руководство по Azure Майкрософт](https://msdn.microsoft.com/library/dn568099.aspx). См. учебник для начинающих асинхронный обмен сообщениями, шаблон каналы и фильтры, шаблон компенсирующие транзакции, шаблон конкурирующих клиентов, шаблон CQRS.
- [Пути CQRS](https://msdn.microsoft.com/library/jj554200). Электронная книга о CQRS, шаблонов и методов Майкрософт.

Видео:

- [Отказоустойчивость: Построение масштабируемых, надежных облачные службы](https://channel9.msdn.com/Series/FailSafe). Серия видеоматериалов девять частей, Ульрих Хоманн, Marc Mercuri и Марк Симмс. Представляет высокоуровневых концепциях и принципов архитектуры в виде очень доступна и интересные истории, полученными в результате Advisory Team Microsoft клиентов (CAT) опыт работы с фактических клиентов. Основные сведения о службе хранилища Azure и очереди см. серии 5, начиная с 35:13.

> [!div class="step-by-step"]
> [Назад](distributed-caching.md)
> [Вперед](more-patterns-and-guidance.md)

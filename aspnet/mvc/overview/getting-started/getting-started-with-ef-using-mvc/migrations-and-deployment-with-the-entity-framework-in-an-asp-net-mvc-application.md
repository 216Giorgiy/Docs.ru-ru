---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
title: Сначала код миграция и развертывание с платформой Entity Framework в приложении ASP.NET MVC | Документы Microsoft
author: tdykstra
description: Contoso университета примера веб-приложения показано, как создавать приложения ASP.NET MVC 5 с помощью Entity Framework 6 Code First и Visual Studio...
ms.author: aspnetcontent
manager: wpickett
ms.date: 11/07/2014
ms.topic: article
ms.assetid: d4dfc435-bda6-4621-9762-9ba270f8de4e
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 04d393edca0469df140f06a7d083a48aa8f84b65
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
<a name="code-first-migrations-and-deployment-with-the-entity-framework-in-an-aspnet-mvc-application"></a>Сначала код миграция и развертывание с платформой Entity Framework в приложении ASP.NET MVC
====================
по [Tom Dykstra](https://github.com/tdykstra)

[Загрузка завершенного проекта](http://code.msdn.microsoft.com/ASPNET-MVC-Application-b01a9fe8) или [скачать PDF](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20Entity%20Framework%206%20Code%20First%20using%20MVC%205.pdf)

> Contoso университета примера веб-приложения показано, как создавать приложения ASP.NET MVC 5 с помощью Entity Framework 6 Code First и Visual Studio 2013. Сведения о серии руководств см. в [первом руководстве серии](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).

Пока приложение работает локально в IIS Express на компьютере разработчика. Чтобы сделать доступными для других пользователей в Интернете в реальном приложении, необходимо развернуть его на веб-поставщик услуг размещения. В этом учебнике вы развернете приложение Contoso университета в облаке в Azure.

Учебник содержит следующие разделы:

- Включите Code First Migrations. Функция миграции позволяет изменить модель данных и развертывания изменений в рабочей среде путем обновления схемы базы данных без необходимости удаления и повторного создания базы данных.
- Развертывание в Azure. Этот шаг является необязательным. оставшихся учебниках можно будет продолжить без развернут проект.

Рекомендуется использовать процесс непрерывной интеграции с системой управления версиями для развертывания, что этот учебник не охватывает разделы. Дополнительные сведения см. в разделе [система управления версиями](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) и [непрерывной интеграции](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) главах [Создание реальных облачных приложений с Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction) электронных книг.

## <a name="enable-code-first-migrations"></a>Включить Code First Migrations

При разработке нового приложения ваша модель данных часто меняется, и при каждом таком изменении она нарушает синхронизацию с базой данных. Вы настроили для автоматического удаления и повторного создания базы данных каждый раз при изменении модели данных Entity Framework. При добавлении, удалить, или изменить классы сущностей или изменить ваш `DbContext` класса, при очередном запуске приложения автоматически удаляет существующей базы данных, создает новый, который соответствует модели и заполняет его с тестовыми данными.

Этот способ для обеспечения синхронизации базы данных с моделью данных хорошо работает до развертывания приложения в рабочей среде. Когда приложение выполняется в производственной среде, он обычно хранит данные, которые требуется сохранить, и вы не хотите потерять все, что каждый раз при внесении изменения, такие как добавление нового столбца. [Code First Migrations](https://msdn.microsoft.com/data/jj591621) функция решает эту проблему, позволяя Code First обновить схему базы данных вместо удаления и повторного создания базы данных. В этом учебнике вы развернете приложение, и для подготовки, вы будете включить миграцию.

1. Отключить инициализатор, настроенные ранее, скрыв или удалив `contexts` элемент, добавленный в файл Web.config приложения.

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.xml?highlight=2,6)]
2. Также в приложении *Web.config* файл, измените имя базы данных в строке соединения на ContosoUniversity2.

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.xml?highlight=2)]

    Это изменение настраивает проект, чтобы первая миграция создала базу данных. Это необязательно, но вы увидите Далее почему он имеет смысл.
3. Из **средства** меню, нажмите кнопку **диспетчер пакетов библиотеки** и затем **консоль диспетчера пакетов**.

    ![Selecting_Package_Manager_Console](https://asp.net/media/4336350/1pm.png)
4. В `PM>` строке введите следующие команды:

    `enable-migrations`  
    `add-migration InitialCreate`

    ![команду Enable-migrations](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image1.png)

    `enable-migrations` Команда создает *миграций* папки в проект ContosoUniversity и помещает в этой папке *Configuration.cs* файл, который можно изменять для настройки миграции.

    (Если вы пропустили в предыдущем шаге, направляющее можно изменить имя базы данных, миграция будет найти существующую базу данных и автоматически `add-migration` команды. Это нормально, он просто означает, что тестирования кода миграции не запускается перед развертыванием базы данных. Позже при запуске `update-database` команды, ничего не произойдет, так как база данных уже будет существовать.)

    ![Миграция папки](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image2.png)

    Инициализатор класса, который вы видели ранее, такие как `Configuration` класс включает `Seed` метод.

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

    Назначение [начальное значение](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) проще позволяют вставлять или обновлять данные теста, после Code First создает или обновляет базу данных. Метод вызывается при создании базы данных, и каждый раз при обновлении схемы базы данных после изменения модели данных.

### <a name="set-up-the-seed-method"></a>Настройка Seed-метод

При удалении и повторного создания базы данных при каждом изменении модели данных, используется класс инициализатора `Seed` для вставки проверочных данных, так как база данных уничтожается после каждого изменения модели и проверочных данных будут потеряны. Code First Migrations, тестирования, данные сохраняются после изменения базы данных, поэтому включив тестовых данных в [начальное значение](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) метод обычно не требуется. На самом деле вы не хотите `Seed` для вставки тестовых данных, если вы будете использовать миграции для развертывания базы данных в рабочей среде, так как `Seed` метод будет выполняться в рабочей среде. В этом случае требуется `Seed` для вставки в базу данных только те данные, необходимые в рабочей среде. Например, может потребоваться базы данных, для включения отдел фактические имена в `Department` таблицы, когда приложение становится доступной в рабочей среде.

В этом учебнике вы будете использовать миграции для развертывания, а `Seed` метод все равно вставит тестовых данных позволит лучше понять, как работает функциональных возможностей приложения без необходимости вставлять большой объем данных вручную.

1. Замените содержимое *Configuration.cs* файл следующий код, который будет загружать данные теста в базе данных. 

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

    [Начальное значение](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) метод принимает объекта контекста базы данных в качестве входного параметра и кода в методе использует этот объект для добавления новых сущностей в базу данных. Для каждого типа сущности, код создает коллекцию новых сущностей, добавляет их в соответствующую [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) свойства, а затем сохраняет изменения в базе данных. Нет необходимости вызывать [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) метод после каждой группы сущностей, как показано здесь, но это поможет найти источник проблемы, если исключение возникает, когда код производит запись в базу данных.

    Некоторые операторы, которые вставляют данные с помощью [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) метод для выполнения операции «вставки-обновления». Поскольку `Seed` метод выполняется каждый раз при выполнении `update-database` команды, обычно после каждой миграции нельзя просто вставить данные, так как вы пытаетесь добавить строки уже существует после первой миграции, который создает базу данных. Операция «вставки-обновления» позволяет избежать ошибок, произойдет при попытке вставить строку, которая уже существует, но он ***переопределяет*** любые изменения данных, внесенные во время тестирования приложения. С тестовыми данными в некоторых таблицах не имеет смысла, происходит: в некоторых случаях при изменении данных во время тестирования требуется изменения после обновления базы данных. В этом случае необходимо выполнить операцию вставки условного: вставьте строку только в том случае, если он еще не существует. Seed-метод использует оба подхода.

    Первый параметр, передаваемый [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) метод задает свойство, используемое для проверки, если строки уже существует. Для тестовых данных студентов, которому предоставляется `LastName` свойство может использоваться для этой цели, так как каждый последнее имя в списке является уникальным:

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

    Данный код предполагает, что последний имена являются уникальными. Если вручную добавить студента с повторяющимся именем последней, вы получите следующее исключение при последующем выполнении миграции.

    Последовательность содержит более одного элемента

    Сведения об обработке избыточных данных, например двух учащихся с именем «Александр Carson» см. в разделе [заполнения и отладка Entity Framework (EF) БД](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) в блоге Рика Андерсона. Дополнительные сведения о `AddOrUpdate` метода, в разделе [Будьте внимательны с EF 4.3 AddOrUpdate метод](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) в блоге Джули Лерман.

    Код, который создает `Enrollment` сущностей предполагается, что имеется `ID` значение в сущностях в `students` коллекции, несмотря на то, что этого свойства не задана в коде, который создает коллекцию.

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cs?highlight=2)]

    Можно использовать `ID` свойство здесь так как `ID` значение при вызове `SaveChanges` для `students` коллекции. EF автоматически получает значение первичного ключа, если он вставляет сущность в базе данных, и обновляет `ID` свойство сущности в памяти.

    Код, который добавляет каждый `Enrollment` сущность `Enrollments` набор сущностей не использует `AddOrUpdate` метод. Проверяется, если сущность уже существует и вставляет сущность, если он не существует. Этот подход сохранит изменения, внесенные уровень регистрации с помощью пользовательского интерфейса приложения. Код выполняет цикл через каждый член `Enrollment` [список](https://msdn.microsoft.com/library/6sh2ey19.aspx) и если регистрации не найден в базе данных, он добавляет регистрацию в базу данных. При первом обновлении базы данных, база данных будет пустым, он добавляет каждый регистрации.

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs)]
2. Выполните построение проекта.

### <a name="execute-the-first-migration"></a>Выполнение первой миграции

При выполнении `add-migration` команды миграции создается код, который может создать базу данных с нуля. Этот код также можно найти в *миграций* папки в файл с именем  *&lt;timestamp&gt;\_InitialCreate.cs*. `Up` Метод `InitialCreate` класс создает таблицы базы данных, которые соответствуют наборов сущностей модели данных, и `Down` метод удаляет их.

[!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs)]

Функция миграций вызывает метод `Up`, чтобы реализовать изменения модели данных для миграции. При вводе команды для отката обновления функция миграций вызывает метод `Down`.

Это первоначальной миграции, который был создан при вводе `add-migration InitialCreate` команды. Параметр (`InitialCreate` в примере) используется для файла имя и может принимать любые необходимые; обычно выбрать слово или фразу, в которой говорится, что выполняется в процессе переноса. Например, можно назвать последующей миграции &quot;AddDepartmentTable&quot;.

Если вы создали первоначальную миграцию, когда база данных уже существовала, код для создания базы данных формируется, но выполнять его не требуется, так как база данных уже соответствует модели данных. Однако при развертывании приложения в другой среде, где база данных еще не существует, этот код будет выполняться для создания базы данных, поэтому рекомендуется сначала его протестировать. Вот почему ранее вы изменили имя базы данных в строке подключения — это позволяет функции миграций создать базу данных с нуля.

1. В **консоль диспетчера пакетов** окно, введите следующую команду:

    `update-database`

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image3.png)

    `update-database` Выполняется команда `Up` метод для создания базы данных, а затем выполняется `Seed` метод для заполнения базы данных. Тот же процесс запускается автоматически в рабочей среде после развертывания приложения, как можно будет увидеть в следующем разделе.
2. Используйте **обозревателя серверов** для проверки базы данных как в первом руководстве и запустите приложение, чтобы убедиться, что все данные по-прежнему работает так же, как и раньше.

## <a name="deploy-to-azure"></a>Развертывание в Azure

Пока приложение работает локально в IIS Express на компьютере разработчика. Чтобы сделать его доступным для других пользователей в Интернете, необходимо развернуть его на веб-поставщик услуг размещения. В этом разделе учебника будет развернуть в Azure. Этот раздел является необязательным. можно пропустить и продолжить в этом руководстве, или вы можете адаптировать инструкции в этом разделе для другого поставщика услуг размещения по своему усмотрению.

### <a name="using-code-first-migrations-to-deploy-the-database"></a>С помощью Code First Migrations развертывание базы данных

Для развертывания базы данных потребуется использовать Code First Migrations. При создании профиля публикации, который используется для настройки параметров для развертывания из Visual Studio будет предложено выбрать флажок **обновление базы данных**. Этот параметр задан, то процесс развертывания, чтобы автоматически настроить приложение *Web.config* файлов на целевом сервере, чтобы Code First использует `MigrateDatabaseToLatestVersion` класс инициализатора.

Visual Studio не выполняет никаких действий с базой данных во время развертывания, пока она копирует проекта на сервере назначения. При запуске развернутого приложения и обращается к базе данных в первый раз после развертывания, Code First проверяет, если база данных, соответствует модели данных. В случае несоответствия Code First автоматически создает базу данных (если он еще не существует) или обновляет схему базы данных до последней версии (если база данных существует, но не соответствует модели). Если приложение поддерживает миграцию `Seed` метода, метод выполняется, после создания базы данных или обновления схемы.

Миграции `Seed` метод вставляет данные теста. При развертывании в рабочей среде, необходимо изменить `Seed` метода, так что он вставляет только те данные, необходимые для вставки в рабочей базы данных. Например в текущей модели данных можно иметь реальные курсов, но вымышленной студентов в базе данных разработки. Можно написать `Seed` метод для загрузки в разработке и закомментируйте вымышленной учащихся перед развертыванием в рабочей среде. Или можно написать `Seed` для загрузки только курсы и вводить вымышленные студентов в тестовую базу данных вручную с помощью пользовательского интерфейса приложения.

### <a name="get-an-azure-account"></a>Получить учетную запись Azure

Вам потребуется учетная запись Azure. Если у вас его еще нет, но у вас есть подписка Visual Studio, вы можете [активация преимуществ подписки](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/). В противном случае можно создать бесплатную пробную учетную запись всего за несколько минут. Дополнительные сведения см. в разделе [бесплатная пробная версия](https://azure.microsoft.com/free/).

### <a name="create-a-web-site-and-a-sql-database-in-azure"></a>Создание веб-сайта и базы данных SQL в Azure

Веб-приложения в Azure будет выполняться в общей среде размещения, это означает, что он работает на виртуальных машинах (ВМ), которые являются общими с другими клиентами Azure. Способ недорогих в общей среде размещения приступить к работе в облаке. Более поздней версии увеличивается веб-трафика, удовлетворяющее потребностям, запустив на выделенных виртуальных машин можно масштабировать приложение. Дополнительные сведения о ценах параметры для службы приложений Azure, ознакомьтесь с документацией по [документации Azure](https://azure.microsoft.com/pricing/details/app-service/)

Используется для развертывания базы данных в базе данных SQL Azure. База данных SQL является службой реляционных баз данных на основе облака, основанное на технологии SQL Server. Средств и приложений, работающих с SQL Server также работают с базой данных SQL.

1. В [портала управления Azure](https://portal.azure.com), нажмите кнопку **New** на левой вкладке нажмите кнопку **все** в Новая колонка, а затем выберите **веб-приложения и SQL** в **Web** разделе и в конечном счете **создать**.

    ![Новая кнопка на портале управления](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/CreateWeb-Sql.png)

   **Новое веб-приложение и SQL - создание** откроется мастер.

2. В колонке, введите строку в **имя приложения** поле для использования в качестве уникальный URL-адрес для вашего приложения. Полный URL-адрес будет состоять из, вводимая здесь плюс домена по умолчанию службы приложений Azure (. azurewebsites.net). Если **имя приложения** уже выполнены, мастер сообщит об этом красной *имя приложения Недоступно* сообщения. Если **имя приложения** — доступны, вы получите Зеленый флажок.

    ![Создать ссылку на базу данных на портале управления](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-WebApp.png)

3. В **подписки** раскрывающийся список, выберите подписку Azure, в котором нужно **службы приложений** должна находиться.

4. В **группы ресурсов** текстовое поле, выберите группу ресурсов или создайте новую. Этот параметр указывает каком веб-сайте будет выполняться в центре обработки данных. Дополнительные сведения о группах ресурсов ознакомиться с документацией по [Azure Docs](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview#resource-groups).
5. Создайте новый **план обслуживания приложений** , щелкнув *раздела службы приложений*, **создать новый**и заполните **план служб приложений** (может быть совпадает с именем Служба приложений), **расположение**, и **Ценовая категория** (отсутствует свободное параметр).

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-AppService.png)
6. Нажмите кнопку **базы данных SQL**и выберите *создать* или выберите существующую базу данных

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-Database.png)

7. В **имя** введите имя для базы данных.
8. Нажмите кнопку **целевой сервер** выберите **Создание нового сервера**. Кроме того Если вы ранее был создан сервер, этот сервер можно выбрать из списка доступных серверов.
9. Выберите **Ценовая категория** выберите *Free*. Если требуются дополнительные ресурсы, базу данных можно масштабировать в сторону в любой момент. Дополнительные сведения о ценах для SQL Azure, ознакомьтесь с документацией по [Azure Docs](https://azure.microsoft.com/pricing/details/sql-database/).
10. Изменить [сортировки](https://docs.microsoft.com/sql/relational-databases/collations/collation-and-unicode-support) при необходимости.
11. Введите администратор **пользователя с правами администратора SQL** и **пароль администратора SQL**. Если вы выбрали **новой базы данных SQL server**, не введя существующий имя и пароль для этой учетной записи, вводите новое имя и пароль, который вы определяете теперь для последующего использования при доступе к базе данных. Если был выбран сервер, который вы создали ранее, будет введите учетные данные для этого сервера.
12. Можно включить сбор данных телеметрии для приложения службы с помощью Application Insights. Application Insights с прямым конфигурации собирает ценные события, исключения, зависимостей, запроса и сведения о трассировке. Чтобы узнать больше об Application Insights, Приступая к работе с [Azure Docs](https://azure.microsoft.com/services/application-insights/).
13. Нажмите кнопку **создать** в нижней части колонки для указания, что по завершении вы сможете.
  
    На портале управления возвращается на страницу панели мониторинга и **уведомления** показывает колонки в верхней части страницы создания сайта. Через некоторое время (обычно меньше, чем через минуту) будет уведомление об успешном завершении развертывания. На панели навигации слева новый **службы приложений** отображается в *службы приложений* раздел и новых **базы данных SQL** отображается в *баз данных SQL*  раздел.

### <a name="deploy-the-application-to-azure"></a>Развертывание приложения в Azure

1. В Visual Studio щелкните правой кнопкой мыши проект в **обозревателе решений** и выберите **публикации** в контекстном меню.
  
    ![Публикация в контекстном меню проекта](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image10.png)
2. В **профиль** вкладке **веб-публикация** мастера, нажмите кнопку **службу приложений Microsoft Azure**.
  
    ![Параметры импорта публикации](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-ChooseTarget.png)
3. Если вы не добавили ранее подписки Azure в Visual Studio, выполните действия на экране. При этом будет включен в Visual Studio для подключения к подписке Azure таким образом, список **службы приложений** будет содержать веб-сайте.
 
4. Выберите **подписки** вы добавили службы приложений, затем **план служб приложений** папку приложения службы является частью, и, наконец, **службы приложений** сам следуют **ОК**.

    ![Выберите службы приложений](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-AppService.png)
5. После настройки профиля **подключения** отображаются вкладки. Нажмите кнопку **проверить подключение** чтобы убедиться в правильности настроек

    ![Проверка подключения](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Connection.png)
6. После проверки подключения отображается рядом с зеленой галочкой **проверить подключение** кнопки. Нажмите кнопку **Далее**.
  
    ![Успешно проверенные соединения](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-SettingsValidated.png)
7. Откройте **строку подключения к удаленному** раскрывающегося списка в разделе **SchoolContext** и выберите строку подключения для базы данных, вы создали.
8. Выберите **обновление базы данных**.

    ![Вкладка "Параметры"](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Settings.png)

    Этот параметр задан, то процесс развертывания, чтобы автоматически настроить приложение *Web.config* файлов на целевом сервере, чтобы Code First использует `MigrateDatabaseToLatestVersion` класс инициализатора.
9. Нажмите кнопку **Далее**.
10. В **предварительного просмотра** щелкните **начать просмотр**.
  
    ![StartPreview кнопки на вкладке «Предварительный просмотр»](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Preview.png)
  
    Вкладка отображает список файлов, которые будут скопированы на сервер. Предварительного просмотра не требуется для публикации приложения, но полезна функция следует учитывать. В этом случае не нужно выполнять никаких действий со списком файлов, который отображается. При последующем развертывании этого приложения в этом списке будут только измененные файлы.
    ![Выходной файл StartPreview](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-PreviewLoaded.png)

11. Нажмите кнопку **Опубликовать**.
    Visual Studio начинает процесс копирования файлов на сервере Azure.
12. **Вывода** окно показывает выполненные действия развертывания и сообщает успешного завершения развертывания.
  
    ![Успешное развертывание модуля создания отчетов в окне вывода](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-BuildOutput.png)
13. После успешного развертывания браузер по умолчанию автоматически открывается на URL-адрес развернутой веб-сайта.
    Созданное приложение теперь работает в облаке. 
  
    ![Students_index_page_with_paging](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Site.png)

На этом этапе вашей *SchoolContext* база данных создана в базе данных SQL Azure, так как вы выбрали **выполнять миграции Code First (запускается при запуске приложения)**. *Web.config* файл развернутого веб-сайте был изменен, чтобы [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) инициализатора запускается в первый раз, код считывает или записывает данные в базе данных (которая возникала При выборе **учащихся** вкладка):

![](https://asp.net/media/4367421/mig.png)

Процесс развертывания также создается новая строка подключения *(SchoolContext\_DatabasePublish*) для миграции Code First для обновления схемы базы данных и заполнения базы данных.

![Строка подключения Database_Publish](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image26.png)

Можно найти в файл Web.config на локальном компьютере в развернутой версии *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. Доступ к развернутой *Web.config* самом файле по протоколу FTP. Инструкции см. в разделе [ASP.NET веб-развертывания с помощью Visual Studio: развертывание обновления кода](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update). Следуйте инструкциям, которые начинаются с «Чтобы использовать средство FTP, необходимы три вещи: URL-адрес FTP, имя пользователя и пароль.»

> [!NOTE]
> Веб-приложение не реализует безопасности, поэтому любой пользователь находит URL-адрес можно изменить данные. Инструкции по защите веб-сайта см. в разделе [развернуть приложение безопасного ASP.NET MVC с членством, OAuth и базы данных SQL на Azure](https://docs.microsoft.com/aspnet/core/security/authorization/secure-data). Отключать других пользователей, с помощью сайта с помощью портала управления Azure или **обозревателя серверов** в Visual Studio, чтобы остановить сайт.


![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Stop-Service.png)

## <a name="advanced-migrations-scenarios"></a>Сценарии миграции для дополнительных

Если развертывание базы данных, выполнив миграцию автоматически, как показано в этом учебнике, и развертываются на веб-сайт, который выполняется на нескольких серверах, можно получить несколько серверов, при попытке выполнить миграцию в то же время. Миграция атомарны, поэтому, если два сервера повторить выполнение того же миграции, один будет успешно, а другой не сможет (при условии, что не удалось выполнить дважды операции). Чтобы избежать этих проблем в этом случае можно вызывать миграции вручную и настроить собственный код, чтобы это происходит только один раз. Дополнительные сведения см. в разделе [запущена и миграция скрипта из кода](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) в блоге Роуэном Миллер и [Migrate.exe](https://msdn.microsoft.com/data/jj618307) (для выполнения миграции из командной строки) на сайте MSDN.

Сведения о других сценариях миграции см. в разделе [миграций серию](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).

## <a name="code-first-initializers"></a>Инициализаторы первого кода

В разделе «развертывание», вы видели [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) используется инициализатор. Код сначала также предоставляет другие инициализаторы, включая [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (по умолчанию), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (с использованием более ранней версии) и [ DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx). `DropCreateAlways` Инициализатор может быть полезна при настройке условий для модульных тестов. Можно также написать собственную инициализаторы и инициализатор можно вызвать явным образом, если не нужно подождать, пока приложение для чтения и записи в базу данных. Во время этого учебника записывается в ноябре 2013 г. можно использовать только инициализаторы Create и DropCreate перед включением миграции. Сделать эти инициализаторы может использоваться с миграции также работает команда Entity Framework.

Дополнительные сведения об инициализаторах см. в разделе [инициализаторы основные сведения о базе данных в Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) и Глава 6 книги [программирования платформы Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) с Джули Лерман и Миллер Роуэном.

## <a name="summary"></a>Сводка

В этом учебнике вы знаете, как включить миграция и развертывание приложения. В следующем уроке вы начнете, просмотрев более сложные вопросы, развернув модели данных.

Оставьте отзыв на том, как вам понравилось этого учебника и что можно улучшить. Можно также запросить новые разделы на [показать мне как с код](http://aspnet.uservoice.com/forums/228522-show-me-how-with-code).

Ссылки на другие ресурсы Entity Framework можно найти в [доступа к данным ASP.NET - рекомендуется использовать ресурсы](xref:whitepapers/aspnet-data-access-content-map).

> [!div class="step-by-step"]
> [Назад](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)
> [Вперед](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-a-more-complex-data-model-for-an-asp-net-mvc-application)

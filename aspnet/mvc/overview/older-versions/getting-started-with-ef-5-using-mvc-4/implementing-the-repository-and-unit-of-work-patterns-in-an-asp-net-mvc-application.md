---
uid: mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application
title: Реализация репозитория и единицы шаблонов рабочих элементов в приложении ASP.NET MVC (9, 10) | Документы Microsoft
author: tdykstra
description: Contoso университета примера веб-приложения демонстрирует создание приложения ASP.NET MVC 4, с помощью Entity Framework 5 Code First и Visual Studio...
ms.author: aspnetcontent
manager: wpickett
ms.date: 07/30/2013
ms.topic: article
ms.assetid: 44761193-04ba-4990-9f90-145d3c10a716
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/older-versions/getting-started-with-ef-5-using-mvc-4/implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 1f870b61658686769304a7809bde62e66da3bd0c
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
ms.locfileid: "30875881"
---
<a name="implementing-the-repository-and-unit-of-work-patterns-in-an-aspnet-mvc-application-9-of-10"></a><span data-ttu-id="0e2e9-103">Реализация репозитория и единицы шаблонов рабочих элементов в приложении ASP.NET MVC (9, 10)</span><span class="sxs-lookup"><span data-stu-id="0e2e9-103">Implementing the Repository and Unit of Work Patterns in an ASP.NET MVC Application (9 of 10)</span></span>
====================
<span data-ttu-id="0e2e9-104">по [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="0e2e9-104">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

[<span data-ttu-id="0e2e9-105">Загрузка завершенного проекта</span><span class="sxs-lookup"><span data-stu-id="0e2e9-105">Download Completed Project</span></span>](http://code.msdn.microsoft.com/Getting-Started-with-dd0e2ed8)

> <span data-ttu-id="0e2e9-106">Contoso университета примера веб-приложения демонстрирует создание приложения ASP.NET MVC 4, с помощью Entity Framework 5 Code First и Visual Studio 2012.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-106">The Contoso University sample web application demonstrates how to create ASP.NET MVC 4 applications using the Entity Framework 5 Code First and Visual Studio 2012.</span></span> <span data-ttu-id="0e2e9-107">Сведения о серии руководств см. в [первом руководстве серии](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span><span class="sxs-lookup"><span data-stu-id="0e2e9-107">For information about the tutorial series, see [the first tutorial in the series](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span> <span data-ttu-id="0e2e9-108">Учебник рядов можно запустить с самого начала или [загрузить начальный проект для этой главы](building-the-ef5-mvc4-chapter-downloads.md) и начните здесь.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-108">You can start the tutorial series from the beginning or [download a starter project for this chapter](building-the-ef5-mvc4-chapter-downloads.md) and start here.</span></span>
> 
> > [!NOTE] 
> > 
> > <span data-ttu-id="0e2e9-109">Если возникли проблемы, не удается устранить, [загрузить завершенного главе](building-the-ef5-mvc4-chapter-downloads.md) и попробуйте воспроизвести проблему.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-109">If you run into a problem you can't resolve, [download the completed chapter](building-the-ef5-mvc4-chapter-downloads.md) and try to reproduce your problem.</span></span> <span data-ttu-id="0e2e9-110">Обычно можно найти решение проблемы путем сравнения код для завершения кода.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-110">You can generally find the solution to the problem by comparing your code to the completed code.</span></span> <span data-ttu-id="0e2e9-111">Некоторые распространенные ошибки и способы их устранения см. в разделе [ошибок и способы их устранения.](advanced-entity-framework-scenarios-for-an-mvc-web-application.md#errors)</span><span class="sxs-lookup"><span data-stu-id="0e2e9-111">For some common errors and how to solve them, see [Errors and Workarounds.](advanced-entity-framework-scenarios-for-an-mvc-web-application.md#errors)</span></span>


<span data-ttu-id="0e2e9-112">В предыдущем учебнике используется наследование для уменьшения избыточный код в `Student` и `Instructor` классы сущностей.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-112">In the previous tutorial you used inheritance to reduce redundant code in the `Student` and `Instructor` entity classes.</span></span> <span data-ttu-id="0e2e9-113">В этом учебнике вы увидите некоторые способы использования репозитория и единицы шаблонов рабочих элементов для операций CRUD.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-113">In this tutorial you'll see some ways to use the repository and unit of work patterns for CRUD operations.</span></span> <span data-ttu-id="0e2e9-114">Как показано в предыдущем учебнике это одним вы измените как код работает со страницами вы уже создан, а не создавать новые страницы.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-114">As in the previous tutorial, in this one you'll change the way your code works with pages you already created rather than creating new pages.</span></span>

## <a name="the-repository-and-unit-of-work-patterns"></a><span data-ttu-id="0e2e9-115">Репозиторий и единицы шаблонов рабочих элементов</span><span class="sxs-lookup"><span data-stu-id="0e2e9-115">The Repository and Unit of Work Patterns</span></span>

<span data-ttu-id="0e2e9-116">Репозиторий и единицы шаблонов рабочих элементов предназначены для создания уровень абстракции между уровня доступа к данным и бизнес-логики приложения.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-116">The repository and unit of work patterns are intended to create an abstraction layer between the data access layer and the business logic layer of an application.</span></span> <span data-ttu-id="0e2e9-117">Реализация таких шаблонов позволяет изолировать приложение от изменений в хранилище данных и упрощает автоматическое модульное тестирование или разработку на основе тестирования.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-117">Implementing these patterns can help insulate your application from changes in the data store and can facilitate automated unit testing or test-driven development (TDD).</span></span>

<span data-ttu-id="0e2e9-118">В этом учебнике необходимо реализовать класс репозитория для каждого типа сущности.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-118">In this tutorial you'll implement a repository class for each entity type.</span></span> <span data-ttu-id="0e2e9-119">Для `Student` типа сущности, вы создадите интерфейс репозитория и класс репозитория.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-119">For the `Student` entity type you'll create a repository interface and a repository class.</span></span> <span data-ttu-id="0e2e9-120">При создании экземпляра репозитория в контроллере, используется интерфейс, чтобы контроллер принимает ссылку на любой объект, реализующий интерфейс репозитория.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-120">When you instantiate the repository in your controller, you'll use the interface so that the controller will accept a reference to any object that implements the repository interface.</span></span> <span data-ttu-id="0e2e9-121">Если контроллер работает в веб-сервере, он получает репозитории, которая работает с платформой Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-121">When the controller runs under a web server, it receives a repository that works with the Entity Framework.</span></span> <span data-ttu-id="0e2e9-122">Если контроллер работает в группе класс модульного теста, он получает репозитории, которая работает с данными, хранящимися в виде, которую можно легко изменять для тестирования, такие как коллекции в памяти.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-122">When the controller runs under a unit test class, it receives a repository that works with data stored in a way that you can easily manipulate for testing, such as an in-memory collection.</span></span>

<span data-ttu-id="0e2e9-123">Далее в этом учебнике вы используете несколько репозиториев и единицы работы класса для `Course` и `Department` типы сущностей в `Course` контроллера.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-123">Later in the tutorial you'll use multiple repositories and a unit of work class for the `Course` and `Department` entity types in the `Course` controller.</span></span> <span data-ttu-id="0e2e9-124">Класс рабочих единиц координирует работу нескольких репозиториев, создав класс контекста одной базы данных совместно используется всеми из них.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-124">The unit of work class coordinates the work of multiple repositories by creating a single database context class shared by all of them.</span></span> <span data-ttu-id="0e2e9-125">Если вы хотите иметь возможность выполнять автоматическое тестирование модулей, будет создавать и использовать интерфейсы для этих классов таким же образом, как это было сделано для `Student` репозитория.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-125">If you wanted to be able to perform automated unit testing, you'd create and use interfaces for these classes in the same way you did for the `Student` repository.</span></span> <span data-ttu-id="0e2e9-126">Тем не менее для упрощения работы с учебником предстоит создать и использовать эти классы без интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-126">However, to keep the tutorial simple, you'll create and use these classes without interfaces.</span></span>

<span data-ttu-id="0e2e9-127">Ниже показан один из способов представить связи между контроллером и классы контекста, по сравнению с не используется вообще репозитория или единицей работы шаблон.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-127">The following illustration shows one way to conceptualize the relationships between the controller and context classes compared to not using the repository or unit of work pattern at all.</span></span>

![Repository_pattern_diagram](https://asp.net/media/2578149/Windows-Live-Writer_8c4963ba1fa3_CE3B_Repository_pattern_diagram_1df790d3-bdf2-4c11-9098-946ddd9cd884.png)

<span data-ttu-id="0e2e9-129">В этой серии учебника не будет создавать модульные тесты.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-129">You won't create unit tests in this tutorial series.</span></span> <span data-ttu-id="0e2e9-130">Введение TDD с приложением MVC, который использует шаблон репозитория см. в разделе [Пошаговое руководство: использование TDD с ASP.NET MVC](https://msdn.microsoft.com/library/ff847525.aspx).</span><span class="sxs-lookup"><span data-stu-id="0e2e9-130">For an introduction to TDD with an MVC application that uses the repository pattern, see [Walkthrough: Using TDD with ASP.NET MVC](https://msdn.microsoft.com/library/ff847525.aspx).</span></span> <span data-ttu-id="0e2e9-131">Дополнительные сведения о шаблон репозитория см. следующие ресурсы:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-131">For more information about the repository pattern, see the following resources:</span></span>

- <span data-ttu-id="0e2e9-132">[Шаблон репозитория](https://msdn.microsoft.com/library/ff649690.aspx) на сайте MSDN.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-132">[The Repository Pattern](https://msdn.microsoft.com/library/ff649690.aspx) on MSDN.</span></span>
- <span data-ttu-id="0e2e9-133">[С помощью шаблонов репозитория и единица работы с платформой Entity Framework 4.0](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) блоге группы разработчиков платформы Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-133">[Using Repository and Unit of Work patterns with Entity Framework 4.0](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) on the Entity Framework team blog.</span></span>
- <span data-ttu-id="0e2e9-134">[Agile Entity Framework 4 репозитория](http://thedatafarm.com/blog/data-access/agile-entity-framework-4-repository-part-1-model-and-poco-classes/) последовательность записей в блоге Джули Лерман.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-134">[Agile Entity Framework 4 Repository](http://thedatafarm.com/blog/data-access/agile-entity-framework-4-repository-part-1-model-and-poco-classes/) series of posts on Julie Lerman's blog.</span></span>
- <span data-ttu-id="0e2e9-135">[Создание учетной записи в приложении HTML5/jQuery быстро](https://weblogs.asp.net/dwahlin/archive/2011/08/15/building-the-account-at-a-glance-html5-jquery-application.aspx) в блоге Дэна Wahlin.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-135">[Building the Account at a Glance HTML5/jQuery Application](https://weblogs.asp.net/dwahlin/archive/2011/08/15/building-the-account-at-a-glance-html5-jquery-application.aspx) on Dan Wahlin's blog.</span></span>

> [!NOTE]
> <span data-ttu-id="0e2e9-136">Существует много способов реализации репозитория и единицы шаблонов рабочих элементов.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-136">There are many ways to implement the repository and unit of work patterns.</span></span> <span data-ttu-id="0e2e9-137">Можно использовать классы репозитория с или без класс рабочих единиц.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-137">You can use repository classes with or without a unit of work class.</span></span> <span data-ttu-id="0e2e9-138">Вы можете реализовать один репозиторий для всех типов сущностей, или для каждого типа.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-138">You can implement a single repository for all entity types, or one for each type.</span></span> <span data-ttu-id="0e2e9-139">Если вы реализуете для каждого типа, можно использовать отдельные классы, универсального базового класса и производные классы или абстрактный базовый класс и производные классы.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-139">If you implement one for each type, you can use separate classes, a generic base class and derived classes, or an abstract base class and derived classes.</span></span> <span data-ttu-id="0e2e9-140">Может содержать бизнес-логику в репозитории или ограничить его логики доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-140">You can include business logic in your repository or restrict it to data access logic.</span></span> <span data-ttu-id="0e2e9-141">Можно также создавать уровень абстракции в класс контекста базы данных с помощью [IDbSet](https://msdn.microsoft.com/library/gg679233(v=vs.103).aspx) существует интерфейсы вместо [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) типы параметров сущности.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-141">You can also build an abstraction layer into your database context class by using [IDbSet](https://msdn.microsoft.com/library/gg679233(v=vs.103).aspx) interfaces there instead of [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) types for your entity sets.</span></span> <span data-ttu-id="0e2e9-142">Подход к реализации уровня абстракции, показанными в данном руководстве является одной из возможностей необходимо учитывать рекомендации не для всех сценариях и средах.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-142">The approach to implementing an abstraction layer shown in this tutorial is one option for you to consider, not a recommendation for all scenarios and environments.</span></span>


## <a name="creating-the-student-repository-class"></a><span data-ttu-id="0e2e9-143">Создание класса Student репозитория</span><span class="sxs-lookup"><span data-stu-id="0e2e9-143">Creating the Student Repository Class</span></span>

<span data-ttu-id="0e2e9-144">В *DAL* папки, создайте файл класса с именем *IStudentRepository.cs* и замените существующий код следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-144">In the *DAL* folder, create a class file named *IStudentRepository.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample1.cs)]

<span data-ttu-id="0e2e9-145">Этот код объявляет типичный набор методов CRUD, включая двух методов чтения — один, который возвращает все `Student` сущности и которая находит один `Student` сущности по идентификатору.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-145">This code declares a typical set of CRUD methods, including two read methods — one that returns all `Student` entities, and one that finds a single `Student` entity by ID.</span></span>

<span data-ttu-id="0e2e9-146">В *DAL* папки, создайте файл класса с именем *StudentRepository.cs* файла.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-146">In the *DAL* folder, create a class file named *StudentRepository.cs* file.</span></span> <span data-ttu-id="0e2e9-147">Замените существующий код следующим кодом, который реализует `IStudentRepository` интерфейс:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-147">Replace the existing code with the following code, which implements the `IStudentRepository` interface:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample2.cs)]

<span data-ttu-id="0e2e9-148">Контекст базы данных определяется в переменной класса и конструктор ожидает, что вызывающий объект передавать экземпляр контекста:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-148">The database context is defined in a class variable, and the constructor expects the calling object to pass in an instance of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample3.cs)]

<span data-ttu-id="0e2e9-149">Можно было создать новый контекст в репозитории, но затем при использовании нескольких репозиториев в один контроллер каждого ограничится отдельном контексте.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-149">You could instantiate a new context in the repository, but then if you used multiple repositories in one controller, each would end up with a separate context.</span></span> <span data-ttu-id="0e2e9-150">Позже вы воспользуетесь нескольких репозиториев в `Course` контроллера и вы увидите, как класс рабочих единиц убедитесь, что все репозитории использовать тот же контекст.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-150">Later you'll use multiple repositories in the `Course` controller, and you'll see how a unit of work class can ensure that all repositories use the same context.</span></span>

<span data-ttu-id="0e2e9-151">Реализует репозитории [IDisposable](https://msdn.microsoft.com/library/system.idisposable.aspx) и удаляет контекст базы данных, как было показано ранее в контроллере, и его методы CRUD выполнять вызовы контекст базы данных таким же образом, вы уже видели раньше.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-151">The repository implements [IDisposable](https://msdn.microsoft.com/library/system.idisposable.aspx) and disposes the database context as you saw earlier in the controller, and its CRUD methods make calls to the database context in the same way that you saw earlier.</span></span>

## <a name="change-the-student-controller-to-use-the-repository"></a><span data-ttu-id="0e2e9-152">Изменение контроллера студента для использования в репозиторий</span><span class="sxs-lookup"><span data-stu-id="0e2e9-152">Change the Student Controller to Use the Repository</span></span>

<span data-ttu-id="0e2e9-153">В *StudentController.cs*, замените кода класса следующим кодом.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-153">In *StudentController.cs*, replace the code currently in the class with the following code.</span></span> <span data-ttu-id="0e2e9-154">Изменения выделены.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-154">The changes are highlighted.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample4.cs?highlight=13-18,44,75,77,102-103,120,137-138,159,172-174,186)]

<span data-ttu-id="0e2e9-155">Контроллер теперь объявляет переменную для объекта, реализующего класс `IStudentRepository` интерфейс вместо класса контекста:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-155">The controller now declares a class variable for an object that implements the `IStudentRepository` interface instead of the context class:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample5.cs)]

<span data-ttu-id="0e2e9-156">По умолчанию конструктор создает новый экземпляр контекста, и необязательный конструктор позволяет вызывающему объекту передать экземпляр контекста.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-156">The default (parameterless) constructor creates a new context instance, and an optional constructor allows the caller to pass in a context instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample6.cs)]

<span data-ttu-id="0e2e9-157">(При использовании *внедрения зависимостей*, или DI, конструктор по умолчанию не требуется, так как программное обеспечение DI благодаря объекта правильный репозиторий предоставлен всегда будет.)</span><span class="sxs-lookup"><span data-stu-id="0e2e9-157">(If you were using *dependency injection*, or DI, you wouldn't need the default constructor because the DI software would ensure that the correct repository object would always be provided.)</span></span>

<span data-ttu-id="0e2e9-158">В методах CRUD репозитория теперь называется вместо контекста:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-158">In the CRUD methods, the repository is now called instead of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample7.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample8.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample9.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample10.cs)]

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample11.cs)]

<span data-ttu-id="0e2e9-159">И `Dispose` теперь освобождает репозитории, а не в контексте:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-159">And the `Dispose` method now disposes the repository instead of the context:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample12.cs)]

<span data-ttu-id="0e2e9-160">Запустите сайт и нажмите кнопку **учащихся** вкладки.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-160">Run the site and click the **Students** tab.</span></span>

![Students_Index_page](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image1.png)

<span data-ttu-id="0e2e9-162">Страница выглядит и работает так же, как и до изменения кода, чтобы использовать хранилище и другие страницы студента также работать так же.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-162">The page looks and works the same as it did before you changed the code to use the repository, and the other Student pages also work the same.</span></span> <span data-ttu-id="0e2e9-163">Однако имеется существенное различие в способе `Index` метод контроллера выполняет фильтрацию и упорядочивание.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-163">However, there's an important difference in the way the `Index` method of the controller does filtering and ordering.</span></span> <span data-ttu-id="0e2e9-164">Исходную версию этого метода содержит следующий код:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-164">The original version of this method contained the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample13.cs?highlight=1)]

<span data-ttu-id="0e2e9-165">Обновленный `Index` метод содержит следующий код:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-165">The updated `Index` method contains the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample14.cs?highlight=1)]

<span data-ttu-id="0e2e9-166">Только выделенный код был изменен.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-166">Only the highlighted code has changed.</span></span>

<span data-ttu-id="0e2e9-167">В исходной версии кода `students` типизируется как `IQueryable` объект.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-167">In the original version of the code, `students` is typed as an `IQueryable` object.</span></span> <span data-ttu-id="0e2e9-168">Запрос не отправлены в базу данных, пока не преобразуется в коллекции, такие как с помощью метода `ToList`, которой не возникает, пока представление Index обращается к модели студента.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-168">The query isn't sent to the database until it's converted into a collection using a method such as `ToList`, which doesn't occur until the Index view accesses the student model.</span></span> <span data-ttu-id="0e2e9-169">`Where` Метод в приведенный выше код становится `WHERE` предложение в запросе SQL, который отправляется в базу данных.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-169">The `Where` method in the original code above becomes a `WHERE` clause in the SQL query that is sent to the database.</span></span> <span data-ttu-id="0e2e9-170">В свою очередь, это означает, что в базе данных возвращаются только выбранные сущности.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-170">That in turn means that only the selected entities are returned by the database.</span></span> <span data-ttu-id="0e2e9-171">Тем не менее, в результате изменения `context.Students` для `studentRepository.GetStudents()`, `students` переменной после этой инструкции `IEnumerable` коллекцию, включающую всех студентов в базе данных.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-171">However, as a result of changing `context.Students` to `studentRepository.GetStudents()`, the `students` variable after this statement is an `IEnumerable` collection that includes all students in the database.</span></span> <span data-ttu-id="0e2e9-172">В результате применения `Where` метод такой же, но теперь работу в памяти на веб-сервере, а не базы данных.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-172">The end result of applying the `Where` method is the same, but now the work is done in memory on the web server and not by the database.</span></span> <span data-ttu-id="0e2e9-173">Для запросов, которые возвращают большие объемы данных это может быть неэффективным.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-173">For queries that return large volumes of data, this can be inefficient.</span></span>

> [!TIP]
> 
> <span data-ttu-id="0e2e9-174">**IQueryable vs. Интерфейс IEnumerable**</span><span class="sxs-lookup"><span data-stu-id="0e2e9-174">**IQueryable vs. IEnumerable**</span></span>
> 
> <span data-ttu-id="0e2e9-175">После реализации репозитория как показано здесь, даже если вы вводите что-то в **поиска** поле запросов, отправленных на SQL Server возвращает все строки студента, так как они не включают условия поиска:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-175">After you implement the repository as shown here, even if you enter something in the **Search** box the query sent to SQL Server returns all Student rows because it doesn't include your search criteria:</span></span>
> 
> ![](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image2.png)
> 
> [!code-sql[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample15.sql)]
> 
> <span data-ttu-id="0e2e9-176">Этот запрос возвращает все данные студента, так как репозиторий выполнения запроса, не зная о критериях поиска.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-176">This query returns all of the student data because the repository executed the query without knowing about the search criteria.</span></span> <span data-ttu-id="0e2e9-177">Процесс сортировки, применяя условия поиска и выбора подмножества данных для подкачки (в этом случае отображаются только 3 строки) выполняется в памяти более поздние версии `ToPagedList` метод будет вызван на `IEnumerable` коллекции.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-177">The process of sorting, applying search criteria, and selecting a subset of the data for paging (showing only 3 rows in this case) is done in memory later when the `ToPagedList` method is called on the `IEnumerable` collection.</span></span>
> 
> <span data-ttu-id="0e2e9-178">В предыдущей версии кода (до реализован репозитория), запрос не отправляется в базу данных до после применения условия поиска, когда `ToPagedList` будет вызван на `IQueryable` объекта.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-178">In the previous version of the code (before you implemented the repository), the query is not sent to the database until after you apply the search criteria, when `ToPagedList` is called on the `IQueryable` object.</span></span>
> 
> ![](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image3.png)
> 
> <span data-ttu-id="0e2e9-179">При вызове ToPagedList на `IQueryable` запросов, отправленных на SQL Server определяет строку поиска и в результате возвращаются только те строки, которые соответствуют критериям поиска и фильтрации необходимо сделать в памяти.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-179">When ToPagedList is called on an `IQueryable` object, the query sent to SQL Server specifies the search string, and as a result only rows that meet the search criteria are returned, and no filtering needs to be done in memory.</span></span>
> 
> [!code-sql[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample16.sql)]
> 
> <span data-ttu-id="0e2e9-180">(Этом руководстве объясняется, как для проверки запросов, отправляемых на SQL Server.)</span><span class="sxs-lookup"><span data-stu-id="0e2e9-180">(The following tutorial explains how to examine queries sent to SQL Server.)</span></span>


<span data-ttu-id="0e2e9-181">Ниже показан способ реализации репозитория методы, которые позволяют указать, что этот действия должны выполняться в базе данных.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-181">The following section shows how to implement repository methods that enable you to specify that this work should be done by the database.</span></span>

<span data-ttu-id="0e2e9-182">Теперь вы создали уровень абстракции между контроллером и контекст базы данных Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-182">You've now created an abstraction layer between the controller and the Entity Framework database context.</span></span> <span data-ttu-id="0e2e9-183">Если предполагается выполнять автоматические модульное тестирование с помощью этого приложения, можно создать в проекте модульного теста, который реализует класс альтернативных репозитория `IStudentRepository` *.*</span><span class="sxs-lookup"><span data-stu-id="0e2e9-183">If you were going to perform automated unit testing with this application, you could create an alternative repository class in a unit test project that implements `IStudentRepository`*.*</span></span> <span data-ttu-id="0e2e9-184">Вместо вызова контекста для чтения и записи данных, этот класс макета репозитория возможность управлять коллекции в памяти для функции контроллера тестирования.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-184">Instead of calling the context to read and write data, this mock repository class could manipulate in-memory collections in order to test controller functions.</span></span>

## <a name="implement-a-generic-repository-and-a-unit-of-work-class"></a><span data-ttu-id="0e2e9-185">Реализация универсального репозитория и класс рабочих единиц</span><span class="sxs-lookup"><span data-stu-id="0e2e9-185">Implement a Generic Repository and a Unit of Work Class</span></span>

<span data-ttu-id="0e2e9-186">Создание класса репозитория для каждого типа сущности может привести к большой объем избыточных кода и это может привести к частичных обновлений.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-186">Creating a repository class for each entity type could result in a lot of redundant code, and it could result in partial updates.</span></span> <span data-ttu-id="0e2e9-187">Например предположим, что необходимо обновить два разных типа сущностей в рамках одной транзакции.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-187">For example, suppose you have to update two different entity types as part of the same transaction.</span></span> <span data-ttu-id="0e2e9-188">Если каждый использует экземпляр контекста отдельной базы данных, один может завершиться успешно и другой может привести к ошибке.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-188">If each uses a separate database context instance, one might succeed and the other might fail.</span></span> <span data-ttu-id="0e2e9-189">Один из способов минимизировать избыточный код является использование универсального репозитория и один из способов убедиться, что все репозитории использовать один и тот же контекст базы данных (и таким образом обновлялись все) является использование класс рабочих единиц.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-189">One way to minimize redundant code is to use a generic repository, and one way to ensure that all repositories use the same database context (and thus coordinate all updates) is to use a unit of work class.</span></span>

<span data-ttu-id="0e2e9-190">В этом разделе учебника вы создадите `GenericRepository` класса и `UnitOfWork` класса и использовать их в `Course` контроллера для доступа к `Department` и `Course` наборов сущностей.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-190">In this section of the tutorial, you'll create a `GenericRepository` class and a `UnitOfWork` class, and use them in the `Course` controller to access both the `Department` and the `Course` entity sets.</span></span> <span data-ttu-id="0e2e9-191">Как упоминалось ранее, чтобы не усложнять этой части учебника вы не создаете интерфейсы для этих классов.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-191">As explained earlier, to keep this part of the tutorial simple, you aren't creating interfaces for these classes.</span></span> <span data-ttu-id="0e2e9-192">Но если предполагается использовать их для упрощения TDD, следует обычно реализовать их с интерфейсами так же, как `Student` репозитория.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-192">But if you were going to use them to facilitate TDD, you'd typically implement them with interfaces the same way you did the `Student` repository.</span></span>

### <a name="create-a-generic-repository"></a><span data-ttu-id="0e2e9-193">Создание универсального репозитория</span><span class="sxs-lookup"><span data-stu-id="0e2e9-193">Create a Generic Repository</span></span>

<span data-ttu-id="0e2e9-194">В *DAL* папке создайте *GenericRepository.cs* и замените существующий код следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-194">In the *DAL* folder, create *GenericRepository.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample17.cs)]

<span data-ttu-id="0e2e9-195">Переменные класса объявляются контекст базы данных и набора сущностей, хранилище создается в результате:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-195">Class variables are declared for the database context and for the entity set that the repository is instantiated for:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample18.cs)]

<span data-ttu-id="0e2e9-196">Конструктор принимает экземпляр контекста базы данных и инициализирует переменную набора сущностей:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-196">The constructor accepts a database context instance and initializes the entity set variable:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample19.cs)]

<span data-ttu-id="0e2e9-197">`Get` Метод используются лямбда-выражения, чтобы вызывающий код, чтобы указать условие фильтра и столбца для упорядочивания результатов по и строковый параметр позволяет вызывающему объекту обеспечения упреждающую разделенный запятыми список свойств навигации:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-197">The `Get` method uses lambda expressions to allow the calling code to specify a filter condition and a column to order the results by, and a string parameter lets the caller provide a comma-delimited list of navigation properties for eager loading:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample20.cs)]

<span data-ttu-id="0e2e9-198">Код `Expression<Func<TEntity, bool>> filter` означает вызывающий объект будет предоставлять лямбда-выражение на основе `TEntity` типа и это выражение возвращает значение типа Boolean.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-198">The code `Expression<Func<TEntity, bool>> filter` means the caller will provide a lambda expression based on the `TEntity` type, and this expression will return a Boolean value.</span></span> <span data-ttu-id="0e2e9-199">Например, если хранилище создается в результате `Student` тип сущности может указать код в вызывающем методе `student => student.LastName == "Smith` &quot; для `filter` параметра.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-199">For example, if the repository is instantiated for the `Student` entity type, the code in the calling method might specify `student => student.LastName == "Smith`&quot; for the `filter` parameter.</span></span>

<span data-ttu-id="0e2e9-200">Код `Func<IQueryable<TEntity>, IOrderedQueryable<TEntity>> orderBy` также означает вызывающий объект будет предоставлять лямбда-выражение.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-200">The code `Func<IQueryable<TEntity>, IOrderedQueryable<TEntity>> orderBy` also means the caller will provide a lambda expression.</span></span> <span data-ttu-id="0e2e9-201">Но в этом случае входные данные для выражения является `IQueryable` для объекта `TEntity` типа.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-201">But in this case, the input to the expression is an `IQueryable` object for the `TEntity` type.</span></span> <span data-ttu-id="0e2e9-202">Выражение вернет упорядоченный версии, `IQueryable` объекта.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-202">The expression will return an ordered version of that `IQueryable` object.</span></span> <span data-ttu-id="0e2e9-203">Например, если хранилище создается в результате `Student` тип сущности может указать код в вызывающем методе `q => q.OrderBy(s => s.LastName)` для `orderBy` параметра.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-203">For example, if the repository is instantiated for the `Student` entity type, the code in the calling method might specify `q => q.OrderBy(s => s.LastName)` for the `orderBy` parameter.</span></span>

<span data-ttu-id="0e2e9-204">Код в `Get` создает метод `IQueryable` объекта, а затем применяет критерий фильтра, если он существует:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-204">The code in the `Get` method creates an `IQueryable` object and then applies the filter expression if there is one:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample21.cs)]

<span data-ttu-id="0e2e9-205">Затем он применяется выражения eager загрузки после синтаксического анализа список с разделителями-запятыми:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-205">Next it applies the eager-loading expressions after parsing the comma-delimited list:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample22.cs)]

<span data-ttu-id="0e2e9-206">Наконец, оно применяется `orderBy` выражения, если таковой имеется и возвращает результаты; в противном случае он возвращает результаты из неупорядоченный запрос:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-206">Finally, it applies the `orderBy` expression if there is one and returns the results; otherwise it returns the results from the unordered query:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample23.cs)]

<span data-ttu-id="0e2e9-207">При вызове `Get` метод, можно выполнить фильтрацию и сортировку для `IEnumerable` коллекция, возвращаемая этим методом, вместо указания параметров для этих функций.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-207">When you call the `Get` method, you could do filtering and sorting on the `IEnumerable` collection returned by the method instead of providing parameters for these functions.</span></span> <span data-ttu-id="0e2e9-208">Однако сортировка и фильтрация рабочих затем выполняются в памяти на веб-сервере.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-208">But the sorting and filtering work would then be done in memory on the web server.</span></span> <span data-ttu-id="0e2e9-209">С помощью этих параметров, обеспечить работу базы данных, а не веб-сервер.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-209">By using these parameters, you ensure that the work is done by the database rather than the web server.</span></span> <span data-ttu-id="0e2e9-210">Альтернативой является создание производных классов для конкретной сущности типов и добавьте специализированный `Get` методы, такие как `GetStudentsInNameOrder` или `GetStudentsByName`.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-210">An alternative is to create derived classes for specific entity types and add specialized `Get` methods, such as `GetStudentsInNameOrder` or `GetStudentsByName`.</span></span> <span data-ttu-id="0e2e9-211">Однако в сложных приложениях это может привести к большому числу таких производные классы и специализированные методы, которые могут быть несколько действий для обслуживания.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-211">However, in a complex application, this can result in a large number of such derived classes and specialized methods, which could be more work to maintain.</span></span>

<span data-ttu-id="0e2e9-212">Код в `GetByID`, `Insert`, и `Update` методов аналогична видно в репозитории, не являющимися универсальными.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-212">The code in the `GetByID`, `Insert`, and `Update` methods is similar to what you saw in the non-generic repository.</span></span> <span data-ttu-id="0e2e9-213">(Не предоставляя параметром упреждающую в `GetByID` подписи, поскольку не удается выполнить упреждающую с `Find` метод.)</span><span class="sxs-lookup"><span data-stu-id="0e2e9-213">(You aren't providing an eager loading parameter in the `GetByID` signature, because you can't do eager loading with the `Find` method.)</span></span>

<span data-ttu-id="0e2e9-214">Две перегрузки предоставляются для `Delete` метод:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-214">Two overloads are provided for the `Delete` method:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample24.cs)]

<span data-ttu-id="0e2e9-215">Одно из этих позволяет передать идентификатор сущности для удаления, и одна принимает экземпляр сущности.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-215">One of these lets you pass in just the ID of the entity to be deleted, and one takes an entity instance.</span></span> <span data-ttu-id="0e2e9-216">Как видно из [обработки параллелизма](../../getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) учебника требуется обработка вы параллельности `Delete` метод, который принимает экземпляр сущности, который содержит исходное значение свойства отслеживания.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-216">As you saw in the [Handling Concurrency](../../getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application.md) tutorial, for concurrency handling you need a `Delete` method that takes an entity instance that includes the original value of a tracking property.</span></span>

<span data-ttu-id="0e2e9-217">Этот универсальный репозиторий будет обрабатывать обычные требования CRUD.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-217">This generic repository will handle typical CRUD requirements.</span></span> <span data-ttu-id="0e2e9-218">Если определенного типа сущности содержит специальные требования, такие как более сложные фильтрации или упорядочения, можно создать производный класс, имеющий дополнительные методы для этого типа.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-218">When a particular entity type has special requirements, such as more complex filtering or ordering, you can create a derived class that has additional methods for that type.</span></span>

## <a name="creating-the-unit-of-work-class"></a><span data-ttu-id="0e2e9-219">Создание класс рабочих единиц</span><span class="sxs-lookup"><span data-stu-id="0e2e9-219">Creating the Unit of Work Class</span></span>

<span data-ttu-id="0e2e9-220">Класс рабочих единиц служит одной цели: чтобы убедиться, что при использовании нескольких репозиториев, они совместно используют контекст одной базы данных.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-220">The unit of work class serves one purpose: to make sure that when you use multiple repositories, they share a single database context.</span></span> <span data-ttu-id="0e2e9-221">Таким образом, при завершении единицу работы, можно вызвать `SaveChanges` метода для этого экземпляра контекста и быть уверенным в том, все связанные изменения координироваться.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-221">That way, when a unit of work is complete you can call the `SaveChanges` method on that instance of the context and be assured that all related changes will be coordinated.</span></span> <span data-ttu-id="0e2e9-222">Все, что нужен класс `Save` методов и свойств для каждого репозитория.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-222">All that the class needs is a `Save` method and a property for each repository.</span></span> <span data-ttu-id="0e2e9-223">Каждое свойство репозиторий возвращает экземпляр репозитория, который был создан экземпляр, используя один и тот же экземпляр контекста базы данных как в других экземплярах репозитория.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-223">Each repository property returns a repository instance that has been instantiated using the same database context instance as the other repository instances.</span></span>

<span data-ttu-id="0e2e9-224">В *DAL* папки, создайте файл класса с именем *UnitOfWork.cs* и замените код шаблона с помощью следующего кода:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-224">In the *DAL* folder, create a class file named *UnitOfWork.cs* and replace the template code with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample25.cs)]

<span data-ttu-id="0e2e9-225">Код создает класс переменные для каждого репозитория и контекст базы данных.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-225">The code creates class variables for the database context and each repository.</span></span> <span data-ttu-id="0e2e9-226">Для `context` переменной, создается новый контекст:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-226">For the `context` variable, a new context is instantiated:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample26.cs)]

<span data-ttu-id="0e2e9-227">Каждое свойство репозитория проверяет, существует ли уже репозитория.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-227">Each repository property checks whether the repository already exists.</span></span> <span data-ttu-id="0e2e9-228">В противном случае он создает хранилище, передав экземпляр контекста.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-228">If not, it instantiates the repository, passing in the context instance.</span></span> <span data-ttu-id="0e2e9-229">В результате все репозитории совместно использовать один и тот же экземпляр контекста.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-229">As a result, all repositories share the same context instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample27.cs)]

<span data-ttu-id="0e2e9-230">`Save` Вызовы метода `SaveChanges` в контексте базы данных.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-230">The `Save` method calls `SaveChanges` on the database context.</span></span>

<span data-ttu-id="0e2e9-231">Как и любой класс, который создает экземпляр контекста базы данных в переменной класса `UnitOfWork` класс реализует `IDisposable` и удаляет контекст.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-231">Like any class that instantiates a database context in a class variable, the `UnitOfWork` class implements `IDisposable` and disposes the context.</span></span>

### <a name="changing-the-course-controller-to-use-the-unitofwork-class-and-repositories"></a><span data-ttu-id="0e2e9-232">Изменение контроллера для использования репозиториев и класс UnitOfWork курса</span><span class="sxs-lookup"><span data-stu-id="0e2e9-232">Changing the Course Controller to use the UnitOfWork Class and Repositories</span></span>

<span data-ttu-id="0e2e9-233">Замените код, которые отсутствуют в *CourseController.cs* следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="0e2e9-233">Replace the code you currently have in *CourseController.cs* with the following code:</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample28.cs?highlight=15,20,22,31,54-55,70,85-86,101-102,122-124,130)]

<span data-ttu-id="0e2e9-234">Этот код добавляет переменную класса для `UnitOfWork` класса.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-234">This code adds a class variable for the `UnitOfWork` class.</span></span> <span data-ttu-id="0e2e9-235">(Если вы использовали интерфейсы здесь, не инициализировать переменную здесь; вместо этого следует реализовать шаблон из двух конструкторов, как это делалось `Student` репозитория.)</span><span class="sxs-lookup"><span data-stu-id="0e2e9-235">(If you were using interfaces here, you wouldn't initialize the variable here; instead, you'd implement a pattern of two constructors just as you did for the `Student` repository.)</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample29.cs)]

<span data-ttu-id="0e2e9-236">В остальной части класса, все ссылки на контекст базы данных заменяются ссылки на соответствующие репозитория с помощью `UnitOfWork` свойства для доступа к репозиторию.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-236">In the rest of the class, all references to the database context are replaced by references to the appropriate repository, using `UnitOfWork` properties to access the repository.</span></span> <span data-ttu-id="0e2e9-237">`Dispose` Метод уничтожает `UnitOfWork` экземпляра.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-237">The `Dispose` method disposes the `UnitOfWork` instance.</span></span>

[!code-csharp[Main](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/samples/sample30.cs)]

<span data-ttu-id="0e2e9-238">Запустите сайт и нажмите кнопку **курсы** вкладки.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-238">Run the site and click the **Courses** tab.</span></span>

![Courses_Index_page](implementing-the-repository-and-unit-of-work-patterns-in-an-asp-net-mvc-application/_static/image4.png)

<span data-ttu-id="0e2e9-240">Страница выглядит и работает так же, как раньше изменения и другие страницы курса также работать так же.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-240">The page looks and works the same as it did before your changes, and the other Course pages also work the same.</span></span>

## <a name="summary"></a><span data-ttu-id="0e2e9-241">Сводка</span><span class="sxs-lookup"><span data-stu-id="0e2e9-241">Summary</span></span>

<span data-ttu-id="0e2e9-242">Теперь реализована модульных шаблонов рабочих элементов и репозитория.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-242">You have now implemented both the repository and unit of work patterns.</span></span> <span data-ttu-id="0e2e9-243">Как параметры метода в репозитории универсального используется лямбда-выражения.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-243">You have used lambda expressions as method parameters in the generic repository.</span></span> <span data-ttu-id="0e2e9-244">Дополнительные сведения о том, как использовать эти выражения с `IQueryable` см. в разделе [IQueryable(T) интерфейса (System.Linq)](https://msdn.microsoft.com/library/bb351562.aspx) в библиотеке MSDN.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-244">For more information about how to use these expressions with an `IQueryable` object, see [IQueryable(T) Interface (System.Linq)](https://msdn.microsoft.com/library/bb351562.aspx) in the MSDN Library.</span></span> <span data-ttu-id="0e2e9-245">В следующем учебнике вы узнаете, как для обработки некоторых сложных сценариях.</span><span class="sxs-lookup"><span data-stu-id="0e2e9-245">In the next tutorial you'll learn how to handle some advanced scenarios.</span></span>

<span data-ttu-id="0e2e9-246">Ссылки на другие ресурсы Entity Framework можно найти в [Карта содержимого для доступа к данным ASP.NET](../../../../whitepapers/aspnet-data-access-content-map.md).</span><span class="sxs-lookup"><span data-stu-id="0e2e9-246">Links to other Entity Framework resources can be found in the [ASP.NET Data Access Content Map](../../../../whitepapers/aspnet-data-access-content-map.md).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="0e2e9-247">[Назад](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application.md)
> [Вперед](advanced-entity-framework-scenarios-for-an-mvc-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="0e2e9-247">[Previous](implementing-inheritance-with-the-entity-framework-in-an-asp-net-mvc-application.md)
[Next](advanced-entity-framework-scenarios-for-an-mvc-web-application.md)</span></span>

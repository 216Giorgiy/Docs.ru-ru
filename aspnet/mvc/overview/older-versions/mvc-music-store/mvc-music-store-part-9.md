---
uid: mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-9
title: 'Часть 9: Регистрация и извлечение | Документы Microsoft'
author: jongalloway
description: Этот учебник ряд подробно описываются шаги, необходимые для построения образца приложения ASP.NET MVC Music Store. Часть 9 охватывает извлечения и регистрации.
ms.author: aspnetcontent
manager: wpickett
ms.date: 04/21/2011
ms.topic: article
ms.assetid: d65c5c2b-a039-463f-ad29-25cf9fb7a1ba
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-9
msc.type: authoredcontent
ms.openlocfilehash: e7e83b70f2508b6dfc0c078b992747a76e4d0ff2
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
<a name="part-9-registration-and-checkout"></a>Часть 9: Регистрация и извлечение
====================
по [Джон Гэллоуэй](https://github.com/jongalloway)

> MVC Music Store является учебное приложение, которое вводятся и описываются пошаговые способы использования Visual Studio и ASP.NET MVC для веб-разработки.  
>   
> MVC Music Store показана реализация хранилища упрощенных образец продает велосипеды через Интернет альбомы, которое реализует Администрирование сайта основные, вход пользователей и функциональные возможности корзины покупок.  
>   
> Этот учебник ряд подробно описываются шаги, необходимые для построения образца приложения ASP.NET MVC Music Store. Часть 9 охватывает извлечения и регистрации.


В этом разделе мы создадим CheckoutController, который будет собирать покупателя адрес и сведения о платеже. Нам потребуется пользователям зарегистрировать в нашем сайте перед возвратом, поэтому этот контроллер будет требовать авторизации.

Пользователи, чтобы перейти извлечение из покупательской корзины, нажав кнопку «Оформление заказа».

![](mvc-music-store-part-9/_static/image1.jpg)

Если пользователь не вошел, их работа будет предложено.

![](mvc-music-store-part-9/_static/image1.png)

После успешного входа пользователя затем отображается представление адрес "и" Оплата ".

![](mvc-music-store-part-9/_static/image2.png)

Как только они заполнения формы и подтверждением заказа, они будут показаны экране подтверждения заказа.

![](mvc-music-store-part-9/_static/image3.png)

Попытка просмотреть порядок несуществующий или заказа, который не принадлежит покажет представлении ошибок.

![](mvc-music-store-part-9/_static/image4.png)

## <a name="migrating-the-shopping-cart"></a>Миграция в корзину для покупок

Хотя процесс покупательской анонимный доступ, при нажатии на кнопку извлечения, они будут необходимы для регистрации и входа в систему. Пользователи ожидают, что необходимо поддерживать их покупательской корзины сведений между посещений, поэтому будет необходимо связать с пользователем данные покупательской корзины, завершении регистрации или входа.

Это действительно очень простой сделать, наш класс ShoppingCart уже есть метод, который будет связывать все элементы в текущем покупок с именем пользователя. Только что нам потребуется вызвать этот метод, когда пользователь завершает регистрации или входа в систему.

Откройте **AccountController** класс, который мы добавили, когда мы Настройка членства и авторизации. Добавление с помощью инструкции, ссылающиеся на MvcMusicStore.Models, затем добавьте следующий метод MigrateShoppingCart:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample1.cs)]

Затем измените действия после входа в систему для вызова MigrateShoppingCart после проверки пользователя, как показано ниже:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample2.cs)]

Внесите такие же изменения в регистр действий, выполняемых после, сразу после успешного создания учетной записи пользователя.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample3.cs)]

Вот и все — теперь анонимный корзину будет автоматически переносится на учетную запись пользователя после успешной регистрации или входа.

## <a name="creating-the-checkoutcontroller"></a>Создание CheckoutController

Щелкните правой кнопкой мыши папку Controllers и добавить новый контроллер в проект с именем CheckoutController, с помощью шаблона пустой контроллер.

![](mvc-music-store-part-9/_static/image5.png)

Во-первых добавьте атрибут Authorize, перед объявлением класса контроллера требовать от пользователей зарегистрировать до извлечения:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample4.cs)]

*Примечание: Это похоже на изменение, которое мы внесли StoreManagerController ранее, но в этом случае атрибут авторизации требуется, чтобы пользователь был в роль администратора. В контроллере извлечения мы требование входа пользователя, но не требуется, они должны администраторов.*

Для простоты мы не дело с платежную информацию в этом учебнике. Вместо этого мы, позволяя пользователям извлекать, используя код рекламной акции. Этот код рекламной акции, с помощью константу с именем PromoCode сохраняется.

Как StoreController мы будем объявления поля для хранения экземпляра класса MusicStoreEntities, с именем storeDB. Чтобы использовать класс MusicStoreEntities, вам потребуется добавить с помощью инструкции для пространства имен MvcMusicStore.Models. Появляется вверху нашей извлечения контроллера.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample5.cs)]

CheckoutController, будет содержать следующие действия контроллера.

**AddressAndPayment (метод GET)** форма позволяет пользователю вводить свои данные.

**AddressAndPayment (метод POST)** будет проверки входных данных и обработки заказа.

**Полный** будет отображаться после пользователь успешно завершил процесс извлечения. Это представление будет содержать пользователя порядковый номер, как подтверждение.

Во-первых для AddressAndPayment переименуем действие контроллера индекса (которая была создана, когда мы создавали контроллера). Это действие контроллера только отображает форму извлечения, поэтому он не требует сведений о любой модели.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample6.cs)]

Наш метод AddressAndPayment POST будут следовать шаблону, используется в StoreManagerController: он будет пытаться принять отправки формы и завершить порядок и повторного отображения формы в случае неудачи.

После проверки входных данных формы отвечает требованиям наших проверки заказа, мы будет выполнена проверка PromoCode форму напрямую. Предположим, что все работает правильно, будет сохранить обновленную информацию с порядком, указать объекту ShoppingCart для завершения процесса заказа и перенаправления для завершения действия.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample7.cs)]

После успешного завершения процесса извлечения пользователи будут перенаправляться в действие завершения контроллера. Это действие выполнит простую проверку, чтобы проверить, что порядок действительно принадлежат вошедшего в систему пользователя перед отображением порядковый номер в качестве подтверждения.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample8.cs)]

*Примечание: Ошибка представления был автоматически создан для нас в папке /Views/Shared начале проекта.*

Ниже приведен полный код CheckoutController:

[!code-csharp[Main](mvc-music-store-part-9/samples/sample9.cs)]

## <a name="adding-the-addressandpayment-view"></a>Добавление представления AddressAndPayment

Теперь давайте создадим AddressAndPayment представления. Щелкните правой кнопкой мыши на одно из действий контроллера AddressAndPayment и добавьте представление с именем AddressAndPayment, строго типизируется как заказа и использующему изменить шаблон, как показано ниже.

![](mvc-music-store-part-9/_static/image6.png)

В этом представлении сделает использование двух методов, мы рассмотрели при построении StoreManagerEdit представления:

- Мы будем использовать Html.EditorForModel() для отображения полей формы для модели заказа
- Мы будет использовать правила проверки, используя класс Order с атрибутов проверки

Мы начнем путем обновления в код формы для использования Html.EditorForModel(), следуют дополнительные textbox для этот промокод. Ниже приведен полный код для представления AddressAndPayment.

[!code-cshtml[Main](mvc-music-store-part-9/samples/sample10.cshtml)]

## <a name="defining-validation-rules-for-the-order"></a>Определение правила проверки для заказа

Теперь, когда Настройка наши представления, мы настроите правила проверки для нашей модели заказ как это делалось ранее для модели альбома. Щелкните правой кнопкой мыши в папке «Models» и добавьте класс с именем заказа. В дополнение к атрибутам проверки, использовавшегося ранее альбома будет также использоваться регулярное выражение для проверки адреса электронной почты пользователя.

[!code-csharp[Main](mvc-music-store-part-9/samples/sample11.cs)]

Попытка отправки формы с отсутствующим или недопустимых данных теперь будет отображаться сообщение об ошибке с помощью проверки на стороне клиента.

![](mvc-music-store-part-9/_static/image7.png)

Итак мы использовали большую часть тяжелой работы для процесса извлечения; только у нас есть несколько элементов и вероятность завершения. Необходимо добавить два простых представления, а нам нужны для выполнения операций передачи данных покупок при входе в систему.

## <a name="adding-the-checkout-complete-view"></a>Добавление представления завершения извлечения

Извлечение полного представления довольно прост, сколько необходимо для отображения, номер заказа. Щелкните правой кнопкой мыши на действие завершения контроллера и добавить представление с именем завершить которого строго типизируется как целочисленное значение.

![](mvc-music-store-part-9/_static/image8.png)

Теперь мы обновим просмотреть код, чтобы отобразить идентификатор заказа, как показано ниже.

[!code-cshtml[Main](mvc-music-store-part-9/samples/sample12.cshtml)]

## <a name="updating-the-error-view"></a>Обновление представления ошибки

Шаблон по умолчанию включает представление ошибки в папку Shared представления, чтобы его можно было использовать повторно в другом месте на сайте. В этом представлении ошибка содержит ошибку очень простой и не использует наш сайт макета, поэтому мы обновим.

Так как это общая ошибка страницы содержимого очень прост. Мы будем включать сообщение и ссылка для перехода на предыдущую страницу в журнале, если пользователю требуется повторить их действия.

[!code-cshtml[Main](mvc-music-store-part-9/samples/sample13.cshtml)]


> [!div class="step-by-step"]
> [Назад](mvc-music-store-part-8.md)
> [Вперед](mvc-music-store-part-10.md)

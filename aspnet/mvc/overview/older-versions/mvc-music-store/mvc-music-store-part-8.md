---
uid: mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-8
title: 'Часть 8: Корзина для покупок с Ajax-обновления | Документы Microsoft'
author: jongalloway
description: Этот учебник ряд подробно описываются шаги, необходимые для построения образца приложения ASP.NET MVC Music Store. Часть 8 охватывает корзину для покупок с Ajax-обновления.
ms.author: aspnetcontent
manager: wpickett
ms.date: 04/21/2011
ms.topic: article
ms.assetid: 26b2f55e-ed42-4277-89b0-c941eb754145
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-8
msc.type: authoredcontent
ms.openlocfilehash: 195c01ff0d71b2bfd0c00e71244d47a166330921
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
ms.locfileid: "30871289"
---
<a name="part-8-shopping-cart-with-ajax-updates"></a>Часть 8: Корзине для покупок с Ajax-обновления
====================
по [Джон Гэллоуэй](https://github.com/jongalloway)

> MVC Music Store является учебное приложение, которое вводятся и описываются пошаговые способы использования Visual Studio и ASP.NET MVC для веб-разработки.  
>   
> MVC Music Store показана реализация хранилища упрощенных образец продает велосипеды через Интернет альбомы, которое реализует Администрирование сайта основные, вход пользователей и функциональные возможности корзины покупок.  
>   
> Этот учебник ряд подробно описываются шаги, необходимые для построения образца приложения ASP.NET MVC Music Store. Часть 8 охватывает корзину для покупок с Ajax-обновления.


Мы будем разрешить пользователям поместите альбомов в их покупок без регистрации, но им необходимо зарегистрировать в качестве гостей завершения извлечения. В процессе покупки и извлечения будут разделены на два контроллера: контроллер ShoppingCart, который позволяет добавлять элементы в корзину анонимно и контроллер извлечения, который обрабатывает процесс извлечения. Мы будет начинаться с корзины в этом разделе, а затем построить процесс извлечения в следующем разделе.

## <a name="adding-the-cart-order-and-orderdetail-model-classes"></a>Добавление классов модели покупок, Order и OrderDetail

Наши процессы извлечения и Корзина сделает использовать некоторые новые классы. Щелкните правой кнопкой мыши папку модели и добавьте класс покупок (Cart.cs) следующим кодом.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample1.cs)]

Этот класс является довольно аналогично другим пользователям, мы использовали таким образом, за исключением атрибута [Key] RecordId свойства. Наш покупок элементы будут иметь строковый идентификатор, с именем CartID, чтобы разрешить анонимные покупок, но таблица содержит первичный ключ целое число со знаком, с именем RecordId. По соглашению сначала с Entity Framework код ожидает, что первичный ключ для таблицы с именем покупок будет CartId или идентификатор, что мы легко переопределить, через код или заметок при необходимости. Ниже приведен пример того, как мы можно использовать простой соглашения в Entity Framework сначала код при их соответствии нам, но мы вы не ограничены их при необходимости.

Добавьте класс Order (Order.cs) следующим кодом.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample2.cs)]

Этот класс отслеживает сведения сводки и доставки для заказа. **Он не может быть скомпилирован еще**, поскольку он имеет свойство навигации OrderDetails, зависящее от класса, мы еще не созданы. Исправим, что теперь, добавив класс с именем OrderDetail.cs, добавив следующий код.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample3.cs)]

Мы выполним одно последнее обновление с нашей MusicStoreEntities класса для включения DbSets которого предоставлять эти новые классы модели, включая DbSet также&lt;исполнителя&gt;. Обновленный MusicStoreEntities класс отображается как ниже.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample4.cs)]

## <a name="managing-the-shopping-cart-business-logic"></a>Управление бизнес-логики корзины

Далее мы создадим ShoppingCart класс в папке «Models». Модель ShoppingCart обрабатывает доступ к данным в таблице покупок. Кроме того он будет обрабатывать бизнес-логику для добавления и удаления элементов из корзины.

Так как мы не хотим требовать от пользователей зарегистрировать учетную запись только для добавления элементов в его корзине, мы назначит пользователям временные уникальный идентификатор (используя GUID или глобальный уникальный идентификатор) при обращении к покупательской корзине. Мы будем хранить этот идентификатор, с помощью класса сеанса ASP.NET.

*Примечание: Сеанс ASP.NET удобно хранить сведения о пользователе, который истекает после окончания сайта. Во время использования состояния сеанса влияют на производительность для больших сайтов, светлой использование будет хорошо подходят для демонстрационных целей.*

Класс ShoppingCart предоставляет следующие методы:

**AddToCart** принимает альбом как параметр и добавляет ее в корзину пользователя. Так как в таблице покупок, отслеживает количество для каждого альбома содержит логику при необходимости создайте новую строку, или просто увеличить количество, если пользователь уже упорядочен одной копии альбома.

**RemoveFromCart** принимает идентификатор альбома и удаляет его из корзины пользователя. Если пользователь в их покупок были только одна копия альбома, строка удаляется.

**EmptyCart** удаляет все элементы из корзины пользователя.

**GetCartItems** извлекает список CartItems для отображения и обработки.

**GetCount** возвращает общее количество альбомы пользователем в его корзине.

**GetTotal, используемую** вычисляет стоимость всех элементов в корзине.

**CreateOrder** преобразуется в корзину заказа на этапе оформления заказа.

**GetCart** имеет статический метод, который позволяет нашей контроллерах, чтобы получить объект покупок. Она использует **GetCartId** метод для обработки чтения CartId из сеанса пользователя. Метод GetCartId требует HttpContextBase, чтобы он мог читать CartId пользователя из сеанса пользователя.

Ниже приведен полный **класс ShoppingCart**:

[!code-csharp[Main](mvc-music-store-part-8/samples/sample5.cs)]

## <a name="viewmodels"></a>Модели представлений

Наш контроллер корзины покупок необходимо сообщить некоторые сложные сведения для его представления, которой не полностью сопоставлен нашей модели объектов. Мы не хотим изменить наши модели в соответствии с нашей представлений; Классы модели должно представлять нашей домена не пользовательский интерфейс. Одним из решений будет передачи сведений в нашем представления с помощью класса ViewBag, как мы сделали раскрывающийся список сведениями директор магазина, однако передача больших данных через ViewBag возвращает трудности в управлении.

Решением является использование *ViewModel* шаблон. При использовании этого шаблона создается строго типизированные классы, оптимизированных для сценариев определенных представлений, который предоставляют свойства для динамического значения или содержимого, необходимые для наших шаблонов представлений. Наши классы контроллера можно заполнить и передать нашей Просмотр шаблона для использования этих классов, оптимизированными для представления. Это позволяет безопасность типа, проверка во время компиляции и редактор IntelliSense внутри шаблонов представлений.

Мы создадим две модели представления для использования в нашем контроллер корзины: ShoppingCartViewModel будет хранить содержимое в корзину пользователя и ShoppingCartRemoveViewModel будет использоваться для отображения сведений подтверждения, когда пользователь удаляет нечто с их покупок.

Давайте создадим новую папку ViewModels в корне проекта для Систематизация. Щелкните правой кнопкой мыши проект, выберите пункт Добавить или создать папку.

![](mvc-music-store-part-8/_static/image1.jpg)

Имя папки ViewModels.

![](mvc-music-store-part-8/_static/image1.png)

Добавьте класс ShoppingCartViewModel в папке ViewModels. Он имеет два свойства: список элементов для покупок и десятичное значение для хранения совокупная стоимость для всех элементов в корзине.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample6.cs)]

Теперь добавьте ShoppingCartRemoveViewModel папке ViewModels с следующие четыре свойства.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample7.cs)]

## <a name="the-shopping-cart-controller"></a>Контроллер корзины

Контроллер корзины имеет три основные функции: Добавление элементов в корзину, удаление элементов из корзины и просмотре элементов в корзине. Это сделает использовать из трех классов, мы только что создали: ShoppingCartViewModel, ShoppingCartRemoveViewModel и ShoppingCart. Как и StoreController и StoreManagerController мы добавим поле для хранения экземпляра MusicStoreEntities.

Добавьте новый контроллер корзины в проект с помощью шаблона пустой контроллер.

![](mvc-music-store-part-8/_static/image2.png)

Ниже приведен полный ShoppingCart контроллера. Действия индекса и добавления контроллера похожа на. Удаление и CartSummary действия контроллера обрабатывать два особых случаев, которые будут рассмотрены в следующем разделе.

[!code-csharp[Main](mvc-music-store-part-8/samples/sample8.cs)]

## <a name="ajax-updates-with-jquery"></a>JQuery AJAX-обновления

Далее мы создадим страницу индекса корзину покупок, строго типизированными ShoppingCartViewModel и использует шаблон представления списка, используя тот же метод.

![](mvc-music-store-part-8/_static/image3.png)

Однако вместо Html.ActionLink для удаления элементов из корзины, мы будем использовать jQuery для «подключения» событие click для всех связей в этом представлении, имеющие класс HTML RemoveLink. Вместо того чтобы учет формы, этот обработчик событий click просто сделает обратный вызов AJAX для наших RemoveFromCart действия контроллера. RemoveFromCart возвращает результат сериализации JSON, нашей обратного вызова jQuery анализирующей и затем выполняет четыре быстрого обновления с помощью jQuery:

- 1. Удаляет из списка удаленных альбом
- 2. Обновляет счетчик для покупок в заголовке
- 3. Отображает сообщение об обновлении для пользователя
- 4. Обновляет совокупная стоимость корзины

Поскольку сценарий удаления обрабатываются обратный вызов Ajax в представлении индекса, нам не нужен дополнительного представления для RemoveFromCart действия. Ниже приведен полный код для представления /ShoppingCart/Index:

[!code-cshtml[Main](mvc-music-store-part-8/samples/sample9.cshtml)]

Чтобы убедиться, нам нужно иметь возможность добавить элементы в наш список покупок. Мы обновим наши **сведения о хранилище** представление, чтобы включить кнопку «Добавить в корзину». Хотя мы его, мы перечислены некоторые дополнительные сведения о диске, который мы добавили с момента последнего мы обновления в этом представлении: жанра, исполнителя, цены и альбома. Обновленный код представления сведения о хранилище отображается, как показано ниже.

[!code-cshtml[Main](mvc-music-store-part-8/samples/sample10.cshtml)]

Теперь мы щелкните через магазин и тестирования, добавление и удаление альбомы и из наших корзину для покупок. Запустите приложение и найдите индекс хранилища.

![](mvc-music-store-part-8/_static/image4.png)

Нажмите кнопку жанра, чтобы просмотреть список альбомов.

![](mvc-music-store-part-8/_static/image5.png)

Теперь щелкните название альбома отобразить наш обновленные сведения об альбоме представления, включая кнопку «Добавить в корзину».

![](mvc-music-store-part-8/_static/image6.png)

Нажав кнопку «Добавить в корзину» показано нашей представление индекса корзину для покупок с сводном списке корзину для покупок.

![](mvc-music-store-part-8/_static/image7.png)

После загрузки копии корзине для покупок, можно щелкнуть удалить из корзины ссылку для просмотра обновлений Ajax в корзину для покупок.

![](mvc-music-store-part-8/_static/image8.png)

Мы создали ожидания рабочего Корзина для покупок, что позволяет отменить регистрацию пользователей для добавления элементов в корзину. В следующем разделе будет разрешить им для регистрации и завершить процесс извлечения.


> [!div class="step-by-step"]
> [Назад](mvc-music-store-part-7.md)
> [Вперед](mvc-music-store-part-9.md)

---
uid: mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-5
title: "Часть 5: Изменение формы и шаблонов. | Документы Microsoft"
author: jongalloway
description: "Этот учебник ряд подробно описываются шаги, необходимые для построения образца приложения ASP.NET MVC Music Store. Часть 5 описываются изменения форм и шаблонов."
ms.author: aspnetcontent
manager: wpickett
ms.date: 04/21/2011
ms.topic: article
ms.assetid: 6b09413a-6d6a-425a-87c9-629f91b91b28
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-5
msc.type: authoredcontent
ms.openlocfilehash: cde6fe133291254531a797a434a4b2cdd226dd5f
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/10/2017
---
<a name="part-5-edit-forms-and-templating"></a>Часть 5: Изменение формы и шаблонов.
====================
по [Джон Гэллоуэй](https://github.com/jongalloway)

> MVC Music Store является учебное приложение, которое вводятся и описываются пошаговые способы использования Visual Studio и ASP.NET MVC для веб-разработки.  
>   
> MVC Music Store показана реализация хранилища упрощенных образец продает велосипеды через Интернет альбомы, которое реализует Администрирование сайта основные, вход пользователей и функциональные возможности корзины покупок.
> 
> Этот учебник ряд подробно описываются шаги, необходимые для построения образца приложения ASP.NET MVC Music Store. Часть 5 описываются изменения форм и шаблонов.


В прошлом главе мы загрузка данных из наших базы данных и его отображения. В этой главе мы будем также позволяет редактировать данные.

## <a name="creating-the-storemanagercontroller"></a>Создание StoreManagerController

Для начала нужно создать новый контроллер с именем **StoreManagerController**. Для этого контроллера мы будет преимущества формирование шаблонов функции, доступные в ASP.NET MVC 3 Tools Update. Укажите параметры в диалоговом окне Добавить контроллер, как показано ниже.

![](mvc-music-store-part-5/_static/image1.png)

При нажатии кнопки "Добавить", вы увидите, что механизм формирования шаблонов ASP.NET MVC 3 не достаточно большой объем работы для вас:

- Создает новый StoreManagerController с локальной переменной Entity Framework
- Он добавляет StoreManager папку в папке представления проекта
- Он добавляет Create.cshtml, Delete.cshtml, Details.cshtml, Edit.cshtml и Index.cshtml представление со строго типизированными в альбоме-класс

![](mvc-music-store-part-5/_static/image2.png)

Новый класс контроллера StoreManager включает CRUD (Создание, чтение, обновление и удаление) действия контроллера, которые умеют работать с альбом класс модели и использовать наш контекст Entity Framework для доступа к базе данных.

## <a name="modifying-a-scaffolded-view"></a>Изменение представления формирования шаблонов

Это важно помнить, что, хотя этот код был создан для нас, это стандартный код ASP.NET MVC, так же, как мы написание учебником. Он предназначен для сохранения будут тратить время на написание стандартный код контроллера и создание строго типизированные представления вручную, но это не тип созданного кода, вы могли увидеть предшествовало dire предупреждений в комментарии о том, как должен изменить код. Это код, и вы должны изменить его.

Итак начнем с изменением краткое представление индекса StoreManager (/ Views/StoreManager/Index.cshtml). Это представление отображает таблицу, которая перечислены альбомов в нашем хранилище с редактированием / сведений / удаление связей и включает общие свойства альбома. Мы удалим поле AlbumArtUrl, как она не очень полезен в этом окне. В &lt;таблицы&gt; раздел представление кода, удалите &lt;й&gt; и &lt;td&gt; элементы вокруг AlbumArtUrl ссылки, как указано в выделенные строки ниже:

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample1.cshtml)]

Измененный просмотреть код будет выглядеть следующим образом:

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample2.cshtml)]

## <a name="a-first-look-at-the-store-manager"></a>Первый взгляд на диспетчер хранилища

Теперь запустите приложение и найдите/StoreManager /. При этом отображаются измененную, отображая список дисках в хранилище со ссылками на, редактирования и удаления индекса диспетчер хранения.

![](mvc-music-store-part-5/_static/image3.png)

Щелкнув ссылку "Изменить" показывает изменить форму с полями альбома, включая раскрывающиеся меню для жанр и исполнитель.

![](mvc-music-store-part-5/_static/image4.png)

Щелкните ссылку внизу «Обратно в список», а затем щелкните ссылку сведений для альбома. Это отображение подробных сведений для отдельных альбома.

![](mvc-music-store-part-5/_static/image5.png)

Еще раз нажмите кнопку '' Назад в список ссылок, а затем щелкните ссылку, удалить. Откроется диалоговое окно подтверждения, показывает сведения об альбоме и запросом, если мы уверены, что мы хотим удалить его.

![](mvc-music-store-part-5/_static/image6.png)

Нажав кнопку «Удалить» в нижней удалить альбом и возврата на страницу индекса, которая показывает альбом удален.

Не готово с помощью диспетчера хранилища, но у нас есть работа контроллера и просмотр кода для операций CRUD запуск из.

## <a name="looking-at-the-store-manager-controller-code"></a>Просматривая код контроллера диспетчера хранилища

Контроллер диспетчера хранилища содержит достаточно большой объем кода. Разберем это сверху вниз. Контроллер содержит некоторые стандартные пространства имен для контроллера MVC, а также ссылку на нашем пространстве имен модели. Контроллер имеет закрытый экземпляр MusicStoreEntities, используемых каждым из действия контроллера для доступа к данным.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample3.cs)]

### <a name="store-manager-index-and-details-actions"></a>Хранить действия диспетчера индекса и подробные сведения

Представление index извлекает список альбомов, включая каждого альбома упоминаемого жанр и исполнитель сведения, как упоминалось ранее, при работе в методе Обзор хранилища. Просмотр индекса является следующие ссылки на связанные объекты, чтобы он может отображать жанр имя каждого альбома, а также имя исполнителя, контроллер, эффективность и запросов для получения этих сведений в исходном запросе.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample4.cs)]

Действие контроллера сведения контроллера StoreManager работает так же, как мы писали ранее - она запрашивает альбом действие хранилища сведений о контроллере по Идентификатору с помощью метода применения Find(), возвращается в представлении.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample5.cs)]

### <a name="the-create-action-methods"></a>Создавать методы действий

Создавать методы действий немного отличаются от те, которые мы наблюдали на данный момент, так как они обрабатывают входные данные формы. При первом посещении /StoreManager/создать/они будут показаны пустую форму. Эта страница HTML будет содержать &lt;формы&gt; элемент, который содержит раскрывающийся список и текстовое поле входных элементов, где они могут ввести сведения о диске.

После пользователь заполняет значения формы альбома, их можно нажать кнопку «Сохранить», чтобы отправить эти изменения обратно в наше приложение для сохранения в базе данных. Когда пользователь нажимает кнопку «Сохранить» &lt;формы&gt; выполнит запрос HTTP POST к /StoreManager/создать/URL-адрес и отправить &lt;формы&gt; значения как часть HTTP-запроса POST.

ASP.NET MVC позволяет легко разделить логику эти два сценария вызова URL-адрес, позволяющих реализовать два отдельных метода действия «Создать» в нашем StoreManagerController класса: один для обработки начальной Обзор HTTP-GET для /StoreManager/Create / URL-адрес, а другая — для обработки HTTP-POST отправляемых изменений.

### <a name="passing-information-to-a-view-using-viewbag"></a>Представления с помощью ViewBag передачи данных

Мы использовали ViewBag ранее в этом учебнике, но еще не говорили большая о нем. ViewBag позволяет передавать сведения в представлении без использования объекта строго типизированные модели. В этом случае необходимо передать список жанров и исполнители форму для заполнения в раскрывающихся списках наши действия контроллера изменить HTTP-GET, и для этого проще всего возврата их как элементы ViewBag.

ViewBag является динамическим объектом, это означает, что можно ввести ViewBag.Foo или ViewBag.YourNameHere без написания кода для определения этих свойств. В этом случае код контроллера использует ViewBag.GenreId и ViewBag.ArtistId так, чтобы раскрывающийся список значений, отправленные с формой GenreId и ArtistId, которые являются свойства альбома, который будет устанавливаться.

Эти значения в раскрывающемся списке возвращаются к форме с помощью объекта SelectList, который создан для этой цели. Это делается с помощью следующего кода:

[!code-csharp[Main](mvc-music-store-part-5/samples/sample6.cs)]

Как видно из кода метода действия, чтобы создать этот объект используются три параметра:

- Список элементов, которые будут применяться для отображения раскрывающегося списка. Обратите внимание, что это не является строкой - передается список жанров.
- Следующий параметр, передаваемые SelectList является выбранное значение. Этот способ SelectList знает, как предварительно выбрать элемент в списке. Это будет проще для понимания, если взглянуть на форме редактирования, которая очень похожа.
- Последний параметр является свойство для отображения. В этом случае это указывает, что свойство Genre.Name какие данные будут отображаться для пользователя.

С учетом затем очень простое действие создания HTTP-GET - ViewBag добавляются два SelectLists и ни один из объектов модели передается в форму (поскольку она не была создана ранее).

[!code-csharp[Main](mvc-music-store-part-5/samples/sample7.cs)]

### <a name="html-helpers-to-display-the-drop-downs-in-the-create-view"></a>Вспомогательные методы HTML для отображения списков Drop в Create View

Поскольку мы обсуждали как раскрывающийся список значений передаются в представление, давайте кратко рассмотрим представление, чтобы увидеть, как отображаются значения. В представлении кода (/ Views/StoreManager/Create.cshtml), вы увидите следующий вызов для отображения раскрывающегося жанр вниз.

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample8.cshtml)]

Это известно как вспомогательный метод HTML - вспомогательный метод, который выполняет типичную задачу представления. Вспомогательные методы HTML очень полезны в обеспечении наш код представление четкими и удобочитаемыми. Вспомогательный объект Html.DropDownList обеспечивается ASP.NET MVC, но как мы рассмотрим позже его можно создать собственную вспомогательные методы для представления кода, который мы будем повторно использовать в приложении.

Вызов Html.DropDownList просто должен знать две вещи - get списке для отображения и какие значения (если таковые имеются), необходимо предварительно выбрать. Первый параметр GenreId, сообщает DropDownList для поиска значения, с именем GenreId в модели или ViewBag. Второй параметр используется для указания значения, чтобы показать, как изначально выбираются в раскрывающемся списке. Так как эта форма является создание формы, не имеет смысла для предварительно выбранные и передать String.Empty.

### <a name="handling-the-posted-form-values"></a>Обработка значения отправки формы

Как уже говорилось, прежде чем существует два метода действия, связанные с каждой формы. Первый обрабатывает запрос HTTP GET и отображает форму. Вторая обрабатывает запрос HTTP POST, содержащий значения отправленной формы. Обратите внимание, что действие контроллера имеет атрибут [HttpPost], который сообщает ASP.NET MVC, он должен отвечать только на запросы HTTP POST.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample9.cs)]

Это действие имеет четыре обязанности.

- 1. Чтение значения формы
- 2. Проверьте, если значения формы передайте все правила проверки
- 3. При отправке формы являются допустимыми, сохраните данные и отображать обновленный список
- 4. При отправке формы является недопустимым, отобразите формы с ошибками проверки

#### <a name="reading-form-values-with-model-binding"></a>Считывание значений формы с привязкой модели

Обрабатывает отправки формы, который включает в себя значения GenreId и ArtistId (из раскрывающегося списка) и значения текстового поля заголовка, цену и AlbumArtUrl действия контроллера. Хотя можно получить прямой доступ к значениям формы, лучшим подходом является использование возможностей привязки модели ASP.NET MVC. Когда действие контроллера принимает тип модели в качестве параметра, ASP.NET MVC будет пытаться заполнение объекта этого типа с помощью входных (а также значения маршрута и строки запроса). Это делается путем поиска значений, имена которых соответствуют свойствам объекта модели, например при установке нового альбома объекта GenreId значения, он ищет входных данных с именем GenreId. При создании представления, используя стандартные методы в ASP.NET MVC форм всегда отображается с помощью имен свойств как имена полей ввода, поэтому это поле будет просто соответствия имен.

#### <a name="validating-the-model"></a>Проверка модели

Проверка модели выполнена с помощью простого вызова ModelState.IsValid. Мы еще не добавили все правила проверки для нашего класса альбом еще - мы сделаем, в бит — поэтому прямо сейчас эта проверка не имеет большую делать. Важно то, что эта проверка ModelStat.IsValid будет адаптировать на правила проверки, который мы поместили в нашей модели, так и изменение правила проверки не требуются никакие обновления в код действия контроллера.

#### <a name="saving-the-submitted-values"></a>Сохранение введенные значения

При отправке формы проходит проверку, пришло время для сохранения значений в базу данных. С Entity Framework, требуется добавление модели в коллекцию альбомы и вызов SaveChanges.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample10.cs)]

Entity Framework создает соответствующие команды SQL для сохранения значения. После сохранения данных, мы перенаправление обратно к списку альбомы, мы видим наши обновления. Это делается путем возвращения RedirectToAction с именем действия контроллера, который мы должны отображаться. В этом случае это метод индекса.

#### <a name="displaying-invalid-form-submissions-with-validation-errors"></a>Отображение отправок недопустимую форму с ошибками проверки

В случае ввода недопустимая форма раскрывающийся список значений добавляются ViewBag (как в случае HTTP-GET) и привязанная модель значения передаются обратно в представление для отображения. Ошибки проверки автоматически отображаются с помощью @Html.ValidationMessageFor вспомогательный метод HTML.

#### <a name="testing-the-create-form"></a>Тестирование Создание формы

Чтобы проверить это, выполнения приложения и перейдите к /StoreManager/создать / - здесь вы найдете пустую форму, который был возвращен методом StoreController создания HTTP-GET.

Заполните некоторые значения и нажмите кнопку "Создать" для отправки формы.

![](mvc-music-store-part-5/_static/image7.png)

![](mvc-music-store-part-5/_static/image8.png)

### <a name="handling-edits"></a>Обработка изменений

Пара действие редактирования (HTTP-GET и HTTP POST) очень похожи на создавать методы действий, которые мы только что рассмотрели. Так как изменить сценарий включает работу с существующие альбома, изменить HTTP-GET метод загружает альбома, на основе параметра «идентификатор», переданной через маршрут. Этот код для извлечения и альбом AlbumId рассматривается как мы ранее рассмотрели сведения при выполнении действия контроллера. Как и в случае с помощью команды Create / метода HTTP GET, раскрывающийся список значений возвращаются через ViewBag. Это позволяет вернуться альбом как нашей модели объекта в представление (которая имеет строгий тип класса альбом) во время передачи дополнительных данных (например список жанров) через ViewBag.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample11.cs)]

Изменить HTTP POST действие очень похоже на действие создания HTTP POST. Единственным различием является вместо добавления нового альбома к базе данных. Коллекции альбомы мы поиск текущего экземпляра альбом с помощью db. Entry(Album) и перевода ее в состояние Modified. Это заставляет Entity Framework, мы изменяем существующий альбом вместо создания новой.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample12.cs)]

Мы смогли проверить эту возможность, работающим с приложением и просмотр/StoreManger /, а затем щелкнуть ссылку правки для альбома.

![](mvc-music-store-part-5/_static/image9.png)

Это показанное редактирования с помощью метода изменить HTTP-GET. Заполните некоторые значения и нажмите кнопку "Сохранить".

![](mvc-music-store-part-5/_static/image10.png)

Это отправляет форму, сохраняет значения и возвращает нас к списку альбома, показывающая, что значения были обновлены.

![](mvc-music-store-part-5/_static/image11.png)

### <a name="handling-deletion"></a>Обработка удаления

Удаление следует той же схеме, как изменить и создать, с использованием одного контроллера действия для отображения формы подтверждения и другое действие контроллера для обработки отправки формы.

Действия HTTP GET и Delete контроллера точно совпадает нашей предыдущее действие контроллера сведения диспетчера хранилища.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample13.cs)]

Мы можем отобразить форму, которая является строго типизированным типу альбома, с помощью удаления представления содержимого шаблона.

![](mvc-music-store-part-5/_static/image12.png)

Удаление шаблона отображаются все поля для модели, но немного можно упростить, вниз. Измените Просмотр кода в /Views/StoreManager/Delete.cshtml следующим образом.

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample14.cshtml)]

При этом отображаются упрощенный подтверждение удаления.

![](mvc-music-store-part-5/_static/image13.png)

Нажав кнопку «Удалить» приводит к обратной передаче на сервер, который выполняет действие DeleteConfirmed формы.

[!code-csharp[Main](mvc-music-store-part-5/samples/sample15.cs)]

Наши действия контроллера HTTP POST удалить выполняет следующие действия:

- 1. Загружает альбом по Идентификатору
- 2. Удаляет его альбом и сохранить изменения
- 3. Перенаправление в индекс, показывающий, что альбом был удален из списка

Чтобы проверить это, запустите приложение и перейдите к /StoreManager. Выберите его из списка и щелкните ссылку «Удалить».

![](mvc-music-store-part-5/_static/image14.png)

При этом отображаются наш экран подтверждения удаления.

![](mvc-music-store-part-5/_static/image15.png)

Нажав кнопку "Удалить" Удаляет альбом и возвращает нам страницу индекса диспетчера хранилища, которая показывает, что альбом была удалена.

![](mvc-music-store-part-5/_static/image16.png)

### <a name="using-a-custom-html-helper-to-truncate-text"></a>С помощью пользовательских вспомогательный метод HTML для усечения текста

У нас одна возможная проблема с нашу страницу индекса диспетчера хранилища. Название альбома и имя исполнителя свойства могут быть достаточно большим, они могут сбросить нашей форматирование таблицы. Мы создадим пользовательский вспомогательный метод HTML, которые позволяют легко truncate этих и других свойств в нашем представления.

![](mvc-music-store-part-5/_static/image17.png)

В Razor @helper синтаксис представляет собой довольно легко создавать собственные вспомогательные функции для использования в представления. Откройте представление /Views/StoreManager/Index.cshtml и добавьте следующий код сразу после @model строки.

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample16.cshtml)]

Этот вспомогательный метод принимает строку и максимальную длину, чтобы разрешить. Если текст, который предоставляется короче указанной длины, вспомогательное приложение выводит его как-является. Если длина его усекает текст и отображает «...», для остальных.

Теперь можно использовать наши вспомогательные усечения для убедитесь, что свойства, имя исполнителя и название альбома, не более 25 символов. Полное представление кода, используя наш новый вспомогательный метод усечения появляется ниже.

[!code-cshtml[Main](mvc-music-store-part-5/samples/sample17.cshtml)]

Теперь когда мы Обзор /StoreManager/ URL-адрес, альбомы и заголовки хранятся ниже нашей максимальной длины.

![](mvc-music-store-part-5/_static/image18.png)

Примечание: Здесь показан простой пример создания и использования вспомогательного класса в одном представлении. Дополнительные сведения о создании вспомогательные методы, которые можно использовать в веб-узла см. в разделе Мои записи блога: [http://bit.ly/mvc3-helper-options](http://bit.ly/mvc3-helper-options)


>[!div class="step-by-step"]
[Назад](mvc-music-store-part-4.md)
[Вперед](mvc-music-store-part-6.md)

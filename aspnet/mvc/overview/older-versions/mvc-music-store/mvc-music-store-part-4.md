---
uid: mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-4
title: 'Часть 4: Модели и доступа к данным | Документы Microsoft'
author: jongalloway
description: Этот учебник ряд подробно описываются шаги, необходимые для построения образца приложения ASP.NET MVC Music Store. Часть 4 описывает моделей и доступа к данным.
ms.author: aspnetcontent
manager: wpickett
ms.date: 04/21/2011
ms.topic: article
ms.assetid: ab55ca81-ab9b-44a0-8700-dc6da2599335
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/older-versions/mvc-music-store/mvc-music-store-part-4
msc.type: authoredcontent
ms.openlocfilehash: 76671bbc7050d111b4d156c45584ba5aa4f1ea8f
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
<a name="part-4-models-and-data-access"></a>Часть 4: Модели и доступа к данным
====================
по [Джон Гэллоуэй](https://github.com/jongalloway)

> MVC Music Store является учебное приложение, которое вводятся и описываются пошаговые способы использования Visual Studio и ASP.NET MVC для веб-разработки.  
>   
> MVC Music Store показана реализация хранилища упрощенных образец продает велосипеды через Интернет альбомы, которое реализует Администрирование сайта основные, вход пользователей и функциональные возможности корзины покупок.
> 
> Этот учебник ряд подробно описываются шаги, необходимые для построения образца приложения ASP.NET MVC Music Store. Часть 4 описывает моделей и доступа к данным.


Таким образом мы только что передача «фиктивные данные» из наших контроллеров в наших шаблонов представлений. Теперь все готово для подключения к базе данных real. В этом учебнике мы будем рассматривать как использовать SQL Server Compact Edition (часто называемые SQL CE) как нашей компонента database engine. SQL CE — это бесплатная, внедренная, файловая база не требует установки ни конфигурацию, что делает его очень удобным для локальной разработки.

## <a name="database-access-with-entity-framework-code-first"></a>Доступ к базе данных с Entity Framework сначала код

Мы будем использовать поддержка Entity Framework (EF), включенный в проектах ASP.NET MVC 3 для запроса и обновления базы данных. EF является объектом гибкой реляционного сопоставления (ORM) данных API, который позволяет разработчикам запрашивать и обновлять данные, хранящиеся в базе данных в объектно ориентированным способом.

Платформа Entity Framework версии 4 поддерживает парадигмы разработки, вызывается сначала код. Сначала код позволяет создавать объект модели, написав простых классов (также известные как POCO из объектов среды CLR «plain old») и даже может создать базу данных на лету из классов.

### <a name="changes-to-our-model-classes"></a>Изменения в наших классов модели

Мы будет использование функции создания базы данных в Entity Framework в этом учебнике. Перед этим, давайте внести несколько незначительные изменения в наших классов модели для добавления в несколько действий, которые мы будем использовать позже.

#### <a name="adding-the-artist-model-classes"></a>Добавление классов модели исполнителя

Наш альбомы будут связаны с исполнители, поэтому мы добавим простой класс модели для описания художник. Добавьте новый класс в папке «модели» с именем Artist.cs, используя приведенный ниже код.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample1.cs)]

#### <a name="updating-our-model-classes"></a>Обновление наших классов модели

Обновите класс альбома, как показано ниже.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample2.cs)]

Затем выполните следующие обновления в класс жанра.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample3.cs)]

### <a name="adding-the-appdata-folder"></a>Добавление приложения\_папки данных

Мы добавим приложение\_каталог данных для нашего проекта для хранения нашей файлы базы данных SQL Server Express. Приложение\_данных представляет собой специальный каталог в ASP.NET, который уже имеет правильные права доступа для доступа к базе данных. В меню Проект выберите Добавить папку ASP.NET, то приложение\_данных.

![](mvc-music-store-part-4/_static/image1.png)

### <a name="creating-a-connection-string-in-the-webconfig-file"></a>Создание строки подключения в файле web.config

Мы добавим несколько строк в файле конфигурации веб-сайта, чтобы платформа Entity Framework известно, как подключиться к базе данных. Дважды щелкните файл Web.config, расположенный в корневой папке проекта.

![](mvc-music-store-part-4/_static/image2.png)

Прокрутите в конец этого файла и добавьте &lt;connectionStrings&gt; статьи непосредственно над последней строки, как показано ниже.

[!code-xml[Main](mvc-music-store-part-4/samples/sample4.xml)]

### <a name="adding-a-context-class"></a>Добавление класса контекста

Щелкните правой кнопкой мыши папку модели и добавьте новый класс с именем MusicStoreEntities.cs.

![](mvc-music-store-part-4/_static/image3.png)

Этот класс будет представляет контекст базы данных Entity Framework и будет обрабатывать нашей создание, чтение, обновление и операции удаления для нас. Ниже приведен код для этого класса.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample5.cs)]

Вот так - у нет другие конфигурации, специальные интерфейсы и т. д. Расширив базовый класс DbContext, наш класс MusicStoreEntities обрабатывать нам операций базы данных. Теперь, когда у нас есть, подключено, добавим несколько свойств для наших классов модели, чтобы воспользоваться преимуществами некоторых дополнительных сведений в базе данных.

### <a name="adding-our-store-catalog-data"></a>Добавление хранилища данных каталога

Мы будет использовать преимущества компонента в Entity Framework, который добавляет вновь созданную базу данных «seed». Наш каталог магазина список жанров, исполнителей и альбомам будет заполнить. Загрузка MvcMusicStore Assets.zip - которой включены файлы разработки нашей узла, использованные ранее в этом учебнике - имеет файл класса с данным начальное значение, расположенном в папке с именем кода.

В коде или в папку Models, найдите файл SampleData.cs и поместите его в папку модели в проект, как показано ниже.

![](mvc-music-store-part-4/_static/image4.png)

Теперь нужно добавить одну строку кода, чтобы сообщить о SampleData класса Entity Framework. Дважды щелкните файл Global.asax в корневой папке проекта, чтобы открыть его и добавьте следующие строки в начало приложение\_Start-метод.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample6.cs)]

На этом этапе мы выполнили действия, необходимые для настройки Entity Framework для проекта.

## <a name="querying-the-database"></a>Запрос к базе данных

Теперь давайте обновить нашей StoreController таким образом, чтобы вместо «пустой данных» вместо этого он вызывает в базу данных для запроса всех ее данных. Мы начнем посредством объявления поля в **StoreController** для хранения экземпляра класса MusicStoreEntities, с именем storeDB:

[!code-csharp[Main](mvc-music-store-part-4/samples/sample7.cs)]

### <a name="updating-the-store-index-to-query-the-database"></a>Обновление индекса хранилища запросов к базе данных

Класс MusicStoreEntities поддерживается платформой Entity Framework и предоставляет доступ к свойству коллекции для каждой таблицы в базе данных. Давайте обновить действие нашей StoreController индекса для получения всех жанров в базе данных. Ранее мы сделали это, жестко запрограммированные строки данных. Теперь мы просто воспользуйтесь контекста Entity Framework Generes коллекции:

[!code-csharp[Main](mvc-music-store-part-4/samples/sample8.cs)]

Изменения не должны проходить нашей Просмотр шаблона, так как мы по-прежнему возвращая же StoreIndexViewModel, мы возвращены до того, — мы просто возвращая динамических данных в базе данных теперь.

Когда мы снова запустите проект и посетите URL-адрес «/ хранения», мы теперь увидите список всех жанров в базе данных:

![](mvc-music-store-part-4/_static/image1.jpg)

### <a name="updating-store-browse-and-details-to-use-live-data"></a>Обновление хранилища Обзор и сведения для использования динамических данных

С/Store/обзора? жанр =*[некоторые жанр]* метод действия, мы ищем жанра по имени. Только ожидается один результат, так как мы никогда не должны иметь две записи того же имени жанра, поэтому мы можем использовать. Расширение Single() в LINQ запрос на соответствующий объект жанр следующим образом (не следует вводить это еще):

[!code-csharp[Main](mvc-music-store-part-4/samples/sample9.cs)]

Один метод принимает как параметр, который указывает, что мы объекта жанр таким образом, что его имя совпадает со значением, которое мы определили лямбда-выражения. В случае выше мы загрузке объекта жанр со значением имя сопоставления Disco.

Мы будет использовать преимущества компонента платформы Entity Framework, позволяющий указывать другие связанные сущности, нужным нам также загрузить при извлечении объекта жанра. Эта функция называется формирование результата запроса и позволило сократить число попыток, нам нужно обращаться к базе данных для получения всех сведений, которые необходимы. Мы хотим упреждающую выборку альбомы жанра, получим, поэтому мы обновим наши запрос, чтобы включить из Genres.Include("Albums"), чтобы указать, что мы также связанные альбомы. Это более эффективно, поскольку извлечет нашей жанр и альбом данные в запросе на одну базу данных.

В сторону там в этом разделе представлен нашей обновленные действие контроллера просмотра:

[!code-csharp[Main](mvc-music-store-part-4/samples/sample10.cs)]

Теперь мы можем обновить хранилище Просмотр представления для отображения альбомы, которые доступны в каждом жанре. Откройте шаблон представления (найден в /Views/Store/Browse.cshtml) и добавьте маркированный список альбомов, как показано ниже.

[!code-cshtml[Main](mvc-music-store-part-4/samples/sample11.cshtml)]

Запуск приложения и перейдите в/Store/обзора? жанр = Jazz показывает, из базы данных, отображение всех альбомов нашей выбранного жанра теперь извлекаемых результатов.

![](mvc-music-store-part-4/_static/image2.jpg)

Мы выполним те же изменения наших "/ store" / Подробности / [id] URL-адрес и замените нашей фиктивные данные запроса к базе данных, который загружает альбома, идентификатор которого соответствует значению параметра.

[!code-csharp[Main](mvc-music-store-part-4/samples/sample12.cs)]

Запуск приложения и перейдя к /Store/Details/1 показывает, что наши результаты теперь извлекаемых из базы данных.

![](mvc-music-store-part-4/_static/image5.png)

Теперь, когда Настройка нашу страницу сведения о хранилище для отображения альбом с помощью идентификатора альбома, давайте обновление **Обзор** представление для связи в представлении сведений. Мы будем использовать Html.ActionLink, точно так, как мы сделали ссылки из индекса хранилища для просмотра хранилища в конце предыдущего раздела. Исходные данные в режиме просмотра отображается ниже.

[!code-cshtml[Main](mvc-music-store-part-4/samples/sample13.cshtml)]

Мы можем Теперь перейдите из нашей странице хранилища странице жанра, которые перечислены доступные диски, и щелкнув альбом можно просмотреть подробные сведения об этом альбоме.

![](mvc-music-store-part-4/_static/image6.png)

> [!div class="step-by-step"]
> [Назад](mvc-music-store-part-3.md)
> [Вперед](mvc-music-store-part-5.md)

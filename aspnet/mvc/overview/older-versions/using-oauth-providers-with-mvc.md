---
uid: mvc/overview/older-versions/using-oauth-providers-with-mvc
title: "Использование поставщиков OAuth с MVC 4 | Документы Microsoft"
author: tfitzmac
description: "Этот учебник показывает, как для создания веб-приложения ASP.NET MVC 4, позволяющий пользователям выполнять вход с учетными данными из внешних поставщиков, например Facebo..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 06/19/2013
ms.topic: article
ms.assetid: 7a87f16f-0e19-4f15-a88a-094ae866c4a2
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/older-versions/using-oauth-providers-with-mvc
msc.type: authoredcontent
ms.openlocfilehash: 965d2e740cc76838b1b4e1c618a2a6d784672fcc
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/10/2017
---
<a name="using-oauth-providers-with-mvc-4"></a>Использование поставщиков OAuth с MVC 4
====================
по [Tom FitzMacken](https://github.com/tfitzmac)

> Этого учебника показано, как построить веб-приложение ASP.NET MVC 4, позволяющий пользователям выполнять вход с учетными данными из внешних поставщиков, например Facebook, Twitter, Microsoft или Google и последующей интеграции некоторые функциональные возможности через эти поставщики в вашей веб-приложение. Для простоты учебнике рассматривается работа с учетными данными от Facebook.
> 
> При использовании внешних учетных данных в веб-приложение ASP.NET MVC 5 см. [создать приложение ASP.NET MVC 5 с Facebook и Google OAuth2 и входа OpenID](../security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).
> 
> Включение этих учетных данных на веб-узлах обеспечивает значительное преимущество, так как миллионы пользователи уже имеют учетные записи, с помощью этих внешних поставщиков. Эти пользователи могут иметь более необходимо, чтобы зарегистрироваться для веб-узла, если они не нужно создавать и запоминать новый набор учетных данных. Кроме того после входа пользователя посредством одного из этих поставщиков, можно внедрить социальных операции от поставщика.


## <a name="what-youll-build"></a>Мы создадим

В этом учебнике существует две основных цели:

1. Разрешить пользователю вход учетных данных от поставщика OAuth.
2. Получить сведения об учетной записи, от поставщика и интеграции с Регистрация учетной записи для веб-узла.

Хотя примеры в этом учебнике связана с использованием Facebook как поставщик проверки подлинности, можно изменить код, чтобы использовать любого поставщика. Шаги по реализации любого поставщика очень похожи на шаги, которые можно найти в этом учебнике. Можно заметить только существенные различия при выполнение прямых вызовов API поставщика набор.

## <a name="prerequisites"></a>Предварительные требования

- [Microsoft Visual Studio 2012](https://www.microsoft.com/visualstudio/eng/downloads#vs) или [Microsoft Visual Studio Express 2012 для Web](https://www.microsoft.com/visualstudio/eng/downloads#d-2012-express)

Или

- Microsoft Visual Studio 2010 с пакетом обновления 1 или [Visual Web Developer Express 2010 с пакетом обновления 1](https://www.microsoft.com/visualstudio/eng/downloads#d-2010-express)
- [ASP.NET MVC 4](https://go.microsoft.com/fwlink/?LinkId=243392)

Кроме того в этом разделе предполагается, что у вас есть базовые знания о ASP.NET MVC и Visual Studio. При необходимости вводные сведения о ASP.NET MVC 4 в разделе [введение в ASP.NET MVC 4](getting-started-with-aspnet-mvc4/intro-to-aspnet-mvc-4.md).

## <a name="create-the-project"></a>Создание проекта

В Visual Studio создайте новое веб-приложение 4 ASP.NET MVC и назовите его &quot;OAuthMVC&quot;. Можно ориентироваться на платформы .NET Framework 4.5 или 4.

![Создание проекта](using-oauth-providers-with-mvc/_static/image1.png)

В окне нового проекта ASP.NET MVC 4 выберите **веб-приложение** и оставить **Razor** как обработчик представлений.

![Выберите веб-приложение](using-oauth-providers-with-mvc/_static/image2.png)

## <a name="enable-a-provider"></a>Включение поставщика

При создании веб-приложение MVC 4 с помощью шаблона веб-приложение с помощью файла с именем AuthConfig.cs в приложении создается проект\_Начальная папка.

![Файл AuthConfig](using-oauth-providers-with-mvc/_static/image3.png)

Файл AuthConfig содержит код для регистрации клиентов для внешних поставщиков аутентификации. По умолчанию этот код закомментирована, поэтому внешних поставщиков не включены.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample1.cs)]

Необходимо Раскомментируйте этот код с помощью внешней проверки подлинности клиента. Удалите метки комментария только поставщики, которые требуется включить в веб-узла. В этом учебнике будет включена только учетные данные Facebook.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample2.cs)]

Обратите внимание, в приведенном выше примере, метод включает пустые строки для параметров регистрации. При попытке запустить приложение, приложение создает исключение аргумента, так как для параметров не допускаются пустые строки. Для обеспечения допустимых значений, необходимо зарегистрировать веб-сайта с помощью внешних поставщиков, как показано в следующем разделе.

## <a name="registering-with-an-external-provider"></a>Регистрация с помощью внешнего поставщика

Для проверки подлинности пользователей с учетными данными из внешнего поставщика, необходимо зарегистрировать веб-сайте поставщика. При регистрации веб-узла, вы получите параметров (например, ключ или идентификатор и секрет) для включения при регистрации клиента. Необходимо настроить учетную запись с поставщиками, которые вы хотите использовать.

Этот учебник не содержит все шаги, которые необходимо выполнить, чтобы зарегистрироваться этих поставщиков. Действия, обычно не сложно. Чтобы успешно зарегистрировать веб-узла, следуйте инструкциям на этих сайтах. Чтобы приступить к работе с Регистрация веб-узла, см. на сайте разработчика для:

- [Facebook](https://developers.facebook.com/)
- [Google](https://developers.google.com/)
- [Корпорация Майкрософт](http://manage.dev.live.com/)
- [Twitter](https://dev.twitter.com/)

При регистрации веб-узла с Facebook, можно предоставить &quot;localhost&quot; для домена сайта и `&quot;http://localhost/&quot;` для URL-адреса, как показано на рисунке ниже. С помощью localhost работает с большинством поставщиков, но в настоящее время не работает с поставщиком Microsoft. Для поставщика необходимо включить URL-адрес допустимым веб-сайта.

![зарегистрировать узел](using-oauth-providers-with-mvc/_static/image4.png)

На предыдущем изображении значения для идентификатора приложения, секрет приложения и контактный адрес электронной почты будут удалены. При регистрации фактически веб-узла, будет присутствовать эти значения. Требуется Обратите внимание на значения идентификатор приложения и секрет приложения, так как их можно добавить в приложение.

## <a name="creating-test-users"></a>Создание тестовых пользователей

Если использование существующей учетной записи Facebook для проверки веб-узла, этот раздел можно пропустить.

Можно легко создать тестовых пользователей для приложения на странице управления приложения Facebook. Можно использовать эти тестовые учетные записи для входа веб-узла. Создание тестовых пользователей, щелкнув **ролей** ссылку в левой области навигации и щелкнув **создать** ссылку.

![Создание тестовых пользователей](using-oauth-providers-with-mvc/_static/image5.png)

На сайте Facebook автоматически создает число тестовых учетных записей, которые можно запрашивать.

## <a name="adding-application-id-and-secret-from-the-provider"></a>Добавление кода для приложения и секрет от поставщика

Теперь, когда вы получили код и секрет от Facebook, вернитесь к файлу AuthConfig и добавьте их в качестве значения параметра. Реальные значения не являются значения, как показано ниже.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample3.cs)]

## <a name="log-in-with-external-credentials"></a>Войдите с помощью внешних учетных данных

Это все, что требуется для включения внешних учетных данных на узле. Запустите приложение и щелкните ссылку входа в правом верхнем углу. Шаблон автоматически распознает зарегистрировали Facebook как поставщик и отображается кнопка для поставщика. Если зарегистрировано несколько поставщиков, кнопка для каждого из них будет автоматически включена.

![Внешнее имя входа](using-oauth-providers-with-mvc/_static/image6.png)

Этот учебник не рассматривается настройка вход кнопки для внешних поставщиков. Эти сведения в разделе [Настройка пользовательский Интерфейс входа при использовании протокола OAuth или OpenID](https://blogs.msdn.com/b/pranav_rastogi/archive/2012/08/24/customizing-the-login-ui-when-using-oauth-openid.aspx).

Нажмите кнопку выполнить вход с учетными данными Facebook Facebook. При выборе одного из внешних поставщиков, вы перенаправляются к этому сайту и приглашение службой, вход.

На рисунке показан экран входа для Facebook. Создается отметка о том, что вы используете вашу учетную запись Facebook для входа на узел с именем oauthmvcexample.

![Проверка подлинности Facebook](using-oauth-providers-with-mvc/_static/image7.png)

После входа в систему с учетными данными с Facebook, страницу пользователю, сайт будет иметь доступ к основные сведения.

![Запрос разрешений](using-oauth-providers-with-mvc/_static/image8.png)

После выбора **перейти к приложению**, пользователь должен зарегистрировать для сайта. На рисунке показана страница регистрации после входа пользователя с учетными данными с Facebook. Имя пользователя обычно предварительно заполненную имя от поставщика.

![register](using-oauth-providers-with-mvc/_static/image9.png)

Нажмите кнопку **зарегистрировать** для завершения регистрации. Закройте браузер.

Вы увидите, что новая учетная запись добавлена к базе данных. В обозревателе серверов откройте **DefaultConnection** базы данных и откройте **таблиц** папки.

![таблицы баз данных](using-oauth-providers-with-mvc/_static/image10.png)

Щелкните правой кнопкой мыши **UserProfile** таблицы и выберите **Показать таблицу данных**.

![Отображение данных](using-oauth-providers-with-mvc/_static/image11.png)

Вы увидите новую учетную запись, которую вы добавили. Просмотрите данные в **веб-страницу\_OAuthMembership** таблицы. Вы увидите дополнительные данные, связанные с внешнего поставщика для учетной записи, которую вы только что добавили.

Если требуется включить внешней проверки подлинности, больше не требуется. Тем не менее Дополнительно можно интегрировать сведения от поставщика в процесс регистрации пользователя, как показано в следующих разделах.

## <a name="create-models-for-additional-user-information"></a>Создание моделей для дополнительных сведений о пользователях

Как вы заметили в предыдущих разделах, получить дополнительные сведения для регистрации встроенной учетной записи для работы необязательно. Однако большинство внешних поставщиков передать обратно Дополнительные сведения о пользователе. Ниже показано, как сохранить эти сведения и сохраните его в базу данных. В частности сохранят значения для полного имени пользователя, URI пользователя личной веб-страницы и значение, указывающее, ли учетная запись проверена Facebook.

Вы воспользуетесь [Code First Migrations](https://msdn.microsoft.com/en-us/data/jj591621) Добавление таблицы для хранения дополнительных сведений о пользователях. Добавлении таблицы к существующей базе данных, сначала необходимо создать моментальный снимок текущей базы данных. Создать моментальный снимок текущей базы данных, можно создать позже миграции, которая содержит только новую таблицу. Чтобы создать моментальный снимок текущей базы данных:

1. Откройте **консоль диспетчера пакетов**
2. Выполните команду **enable-migrations**
3. Выполните команду **добавьте миграции начальной — IgnoreChanges**
4. Выполните команду **базы данных обновления**

Теперь можно добавить новые свойства. В папке «модели» откройте файл AccountModels.cs и найти RegisterExternalLoginModel класс. Класс RegisterExternalLoginModel содержит значения, полученных от поставщика проверки подлинности. Добавление свойства с именем FullName и связи, как показано ниже.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample4.cs?highlight=9-13)]

Также в AccountModels.cs, добавьте новый класс с именем ExtraUserInformation. Этот класс представляет новую таблицу, в которой будут созданы в базе данных.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample5.cs)]

В классе UsersContext добавьте выделенный код ниже, чтобы создать свойство DbSet для нового класса.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample6.cs?highlight=9)]

Теперь все готово для создания новой таблицы. Откройте консоль диспетчера пакетов снова и это время:

1. Выполните команду **AddExtraUserInformation добавьте миграции**
2. Выполните команду **базы данных обновления**

Теперь новая таблица существует в базе данных.

## <a name="retrieve-the-additional-data"></a>Загрузить дополнительные данные

Для получения дополнительных данных двумя способами. Первый способ — сохранить данные пользователя, который передается обратно, по умолчанию, во время проверки подлинности запроса. Второй способ является специально вызывать API поставщика и получения дополнительных сведений. Значения по FullName и связи, автоматически передаются обратно с Facebook. Значение, указывающее, ли учетная запись проверена Facebook извлекается посредством вызова Facebook API. Во-первых нужно будет заполнить значения для FullName и связь и более поздней версии, получается Проверенное значение.

Чтобы получить дополнительные пользовательские данные, откройте **AccountController.cs** файла в **контроллеров** папки.

Этот файл содержит логику для ведения журнала, регистрация и управление учетными записями. В частности, обратите внимание, методы, вызываемые **ExternalLoginCallback** и **ExternalLoginConfirmation**. В этих методов можно добавить код для настройки операций внешнее имя входа для приложения. Первая строка **ExternalLoginCallback** содержит метод:

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample7.cs)]

Дополнительные сведения о пользователях передается обратно в **ExtraData** свойство **AuthenticationResult** объект, возвращаемый из **VerifyAuthentication** метод. Клиент Facebook содержит следующие значения в **ExtraData** свойства:

- id
- имя
- связь
- Пол
- accesstoken

Другие поставщики будет иметь примерно но слегка отличающиеся данные в свойстве ExtraData.

Если пользователь является новым для сайта, будет получить некоторые дополнительные данные и передачи этих данных в представление подтверждения. Последний блок кода в методе выполняется только в том случае, если пользователь является новой возможностью в веб-узла. Замените следующую строку:

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample8.cs)]

С этой строкой:

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample9.cs)]

Это изменение просто включают значения для свойства FullName и связи.

В **ExternalLoginConfirmation** метод, измените код как показано ниже, чтобы сохранить сведения о дополнительных пользователей.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample10.cs?highlight=4,7-13)]

## <a name="adjusting-the-view"></a>Настройка изображения

На странице регистрации отображается дополнительные пользовательские данные, получаемые от поставщика.

В **представления**/**учетной записи** откройте **ExternalLoginConfirmation.cshtml**. Ниже существующего поля для имени пользователя Добавление полей для FullName, связи и PictureLink.

[!code-cshtml[Main](using-oauth-providers-with-mvc/samples/sample11.cshtml)]

Теперь почти все готово для запуска приложения и регистрации нового пользователя с дополнительными сведениями, которые сохранены. Необходимо иметь учетную запись, которая еще не зарегистрирован на сайте. Можно использовать различные тестовую учетную запись, или удаления строк в **UserProfile** и **веб-страниц\_OAuthMembership** таблиц для учетной записи, необходимо повторно использовать. Удаление тех строк, будет обеспечивает попытку регистрации учетной записи.

Запустите приложение и зарегистрировать нового пользователя. Обратите внимание, что это время страница подтверждения дополнительные значения.

![register](using-oauth-providers-with-mvc/_static/image12.png)

После завершения регистрации, закройте браузер. Найдите в базе данных Обратите внимание на новые значения в **ExtraUserInformation** таблицы.

## <a name="install-nuget-package-for-facebook-api"></a>Установка пакета NuGet для Facebook API

Предоставляет Facebook [API](https://developers.facebook.com/docs/reference/apis/) , можно вызывать для выполнения операций. Можно вызвать Facebook API, предложив отправки запросов HTTP или с помощью установки пакета NuGet, который облегчает отправки этих запросов. С помощью пакета NuGet показан в этом учебнике, но установка NuGet пакета не является необходимым. Этого учебника показано, как использовать пакет Facebook C# SDK. Существуют другие пакеты NuGet, помогая в вызовах Facebook API.

Из **управление пакетами NuGet** windows, выберите пакет Facebook C# SDK.

![установить пакет](using-oauth-providers-with-mvc/_static/image13.png)

Facebook C# SDK используется для вызова операции, требующую маркера доступа для пользователя. В следующем разделе показано, как получить маркер доступа.

## <a name="retrieve-access-token"></a>Получить маркер доступа

Большинство внешних поставщиков обратно передать маркер доступа, после проверки учетных данных пользователя. Этот маркер доступа очень важно, так как он позволяет вызывать операции, которые доступны только пользователям, прошедшим проверку. Таким образом получение и сохранение токен доступа является обязательным условием при необходимо предоставить дополнительные функциональные возможности.

В зависимости от внешнего поставщика токена доступа может не являться ограниченного промежутка времени. Чтобы убедиться, что имеется действительный маркер доступа, будет извлекать его каждый раз, пользователь выполняет вход и сохранить ее в качестве значения сеанса, а не сохранять в базе данных.

В **ExternalLoginCallback** метод, токен доступа также передается обратно в **ExtraData** свойство **AuthenticationResult** объекта. Добавьте код, выделенный для **ExternalLoginCallback** сохранить токен доступа в **сеанса** объекта. Этот код выполняется каждый раз при входе пользователя в учетную запись Facebook.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample12.cs?highlight=11-14)]

Несмотря на то, что в этом примере извлекается токен доступа от Facebook, можно получить маркер доступа из любого внешнего поставщика через тот же ключ с именем &quot;accesstoken&quot;.

## <a name="logging-off"></a>выход из системы;

Значение по умолчанию **выхода** метод осуществляет вход пользователя из приложения, но не выполняет вход пользователя из внешнего поставщика. Выход пользователя из Facebook, и предотвратить маркер от сохранения после завершения сеанса пользователя, можно добавить следующий выделенный код в **выхода** метод в AccountController.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample13.cs?highlight=6-14)]

Значения, указываемые в `next` параметр является URL-адрес после выхода пользователя Facebook. При тестировании на локальном компьютере, будет предоставлен правильный номер порта для локального узла. В рабочей среде будет предоставлен страницу по умолчанию, например contoso.com.

## <a name="retrieve-user-information-that-requires-the-access-token"></a>Получить сведения о пользователе, требующую маркера доступа

Теперь, когда хранящиеся токен доступа и установки пакета SDK Facebook C# для их можно использовать вместе для запроса дополнительных сведений от Facebook. В **ExternalLoginConfirmation** метод, создайте экземпляр класса **FacebookClient** класса, передав значение токена доступа. Запросить значение **проверить** свойств для текущего пользователя. **Проверить** свойство указывает, прошел ли Facebook учетной записи другим способом, например отправку сообщения с мобильного телефона. Сохраните это значение в базе данных.

[!code-csharp[Main](using-oauth-providers-with-mvc/samples/sample14.cs?highlight=7-18,25)]

Снова потребуется удалить записи в базе данных для пользователя или использовать другую учетную запись Facebook.

Запустите приложение и зарегистрировать нового пользователя. Посмотрите на **ExtraUserInformation** таблицу, чтобы определить значение для свойства проверено.

## <a name="conclusion"></a>Заключение

В этом учебнике вы создали сайта, который интегрирован с Facebook для проверки подлинности пользователя и регистрации данных. Вы узнали о поведении по умолчанию, настроенный для веб-приложение MVC 4 и как настроить поведение по умолчанию.

## <a name="related-topics"></a>См. также

- [Создать приложение ASP.NET MVC с помощью проверки подлинности и баз данных SQL Server и развернуть в службе приложений Azure](https://docs.microsoft.com/aspnet/core/security/authorization/secure-data)

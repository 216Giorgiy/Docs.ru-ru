---
uid: mvc/overview/performance/using-asynchronous-methods-in-aspnet-mvc-4
title: Использование асинхронных методов в ASP.NET MVC 4 | Документы Microsoft
author: Rick-Anderson
description: Этот учебник поможет узнать основы создания асинхронного MVC веб-приложения ASP.NET с помощью Visual Studio Express 2012 для Web, которая является бесплатной хранять...
ms.author: aspnetcontent
manager: wpickett
ms.date: 06/06/2012
ms.topic: article
ms.assetid: a56572ba-81c3-47af-826d-941e9c4775ec
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/performance/using-asynchronous-methods-in-aspnet-mvc-4
msc.type: authoredcontent
ms.openlocfilehash: 5b3b9b82fa64155c1dfd2a49649def10d7dae87e
ms.sourcegitcommit: 43bd79667bbdc8a07bd39fb4cd6f7ad3e70212fb
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/04/2018
ms.locfileid: "34729185"
---
<a name="using-asynchronous-methods-in-aspnet-mvc-4"></a>Использование асинхронных методов в ASP.NET MVC 4
====================
по [Рик Андерсон](https://github.com/Rick-Anderson)

> Этот учебник поможет узнать основы создания асинхронных приложений веб-ASP.NET MVC с использованием [Visual Studio Express 2012 для Web](https://www.microsoft.com/visualstudio/11), это бесплатная версия Microsoft Visual Studio. Можно также использовать [Visual Studio 2012](https://www.microsoft.com/visualstudio/11).
> 
> Полный пример приведен в этом учебнике на github  [https://github.com/RickAndMSFT/Async-ASP.NET/](https://github.com/RickAndMSFT/Async-ASP.NET/)


ASP.NET MVC 4 [контроллера](https://msdn.microsoft.com/library/system.web.mvc.controller(VS.108).aspx) класса в сочетании [.NET 4.5](https://msdn.microsoft.com/library/w0x726c2(VS.110).aspx) позволяет написать асинхронные методы действия, возвращающие объект типа [задачи&lt;ActionResult&gt; ](https://msdn.microsoft.com/library/dd321424(VS.110).aspx). .NET Framework 4 появился асинхронного программирования концепция, называемая [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) и поддерживает ASP.NET MVC 4 [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx). Задачи представляются **задачи** типа и связанных типов в [System.Threading.Tasks](https://msdn.microsoft.com/library/system.threading.tasks.aspx) пространства имен. Сборки .NET Framework 4.5 эта поддержка асинхронной с [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) и [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевые слова, которые упрощают работу с [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) гораздо проще, чем предыдущие объектов асинхронные методы. [Await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) ключевое слово является синтаксических сокращением, указывающие, фрагмент кода асинхронно ожидать другой фрагмент кода. [Async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевое слово представляет Указание, которое можно использовать для пометки методов, как асинхронные методы на основе задач. Сочетание **await**, **async**и **задачи** объекта он значительно упрощает написание асинхронного кода в .NET 4.5. Новая модель для асинхронных методов, называется *асинхронная модель на основе задач* (**КОСНИТЕСЬ**). В этом учебнике предполагается, имеющих опыт работы с помощью асинхронного программирования [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) и [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевые слова и [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) пространства имен.

Дополнительные сведения об использовании [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) и [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевые слова и [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) пространства имен, см. следующие ссылки.

- [Технический документ: Асинхронности в .NET](https://go.microsoft.com/fwlink/?LinkId=204844)
- [Часто задаваемые вопросы об Async/Await](https://blogs.msdn.com/b/pfxteam/archive/2012/04/12/10293335.aspx)
- [Асинхронное программирование в Visual Studio](https://msdn.microsoft.com/vstudio/gg316360)

## <a id="HowRequestsProcessedByTP"></a>  Способ обработки запросов пулом потоков

На веб-сервере .NET Framework поддерживается пул потоков, которые используются для обслуживания запросов ASP.NET. При получении запроса, поток из пула отправляется для обработки этого запроса. Если запрос обрабатывается синхронно, поток, обрабатывающий запрос является занят при запрос обрабатывается и что поток не может обслуживать другой запрос.   
  
Это может оказаться проблемой, так как пул потоков можно сделать достаточно большим, чтобы вместить много занятых потоков. Однако количество потоков в пуле потоков ограничено (максимум для .NET 4.5 по умолчанию — 5000). В больших приложениях, где высокого уровня параллелизма долго выполняющихся запросов все доступные потоки может быть загружен. Это состояние называется нехватка потоков. При наступлении такой ситуации веб-сервер помещает запросы в очередь. При переполнении очереди запросов веб-сервер отклоняет запросы с состоянием HTTP 503 (сервер перегружен). Пул потоков CLR имеет ограничения по включению новый поток. Если параллелизма непостоянным (то есть веб-сайте может неожиданно получить большое количество запросов) и все доступные запрос потоки заняты из-за внутренних вызовов с большой задержкой, скорость внедрения ограниченный потока можно задать для приложения очень плохо отвечать. Кроме того каждый новый поток, добавляемые в пул потоков имеет нагрузку (например, 1 МБ памяти). Веб-приложения с помощью синхронные методы для вызовов службы высокой задержкой, где пула потоков будет увеличиваться вплоть до .NET 4.5 по умолчанию максимальное число 5, 000 потоков потребует около 5 ГБ больше памяти, чем приложение может также запросы на обслуживание с помощью асинхронные методы и 50 потоков. При выполнении асинхронной работы, вы используете не всегда потока. Например, при внесении запрос асинхронного веб-службы ASP.NET не будут использоваться все потоки между **async** вызова метода и **await**. Использование пула потоков для обслуживания запросов с большой задержкой может привести к большой объем памяти и неэффективного использования серверного оборудования.

## <a name="processing-asynchronous-requests"></a>Обработка асинхронных запросов

Веб-приложения, которые разделе большое количество параллельных запросов при запуске или с непостоянным нагрузкой (где параллелизма увеличивается неожиданно) выполняющего асинхронный эти вызовы веб-службы приведет к увеличению скорости реагирования приложения. Асинхронный запрос занимает столько же времени, что запрос является синхронным. Например если запрос выполняет веб-службы, в вызове, который требует две секунды для выполнения, запрос будет обрабатываться две секунды, является ли эта задача выполняется синхронно или асинхронно. Однако при асинхронном вызове, поток не заблокирован отвечать на другие запросы во время ожидания завершения первого запроса. Таким образом асинхронные запросы предупреждают роста пула очереди и поток запроса, если существует много одновременных запросов, которые вызывают длительные операции.

## <a id="ChoosingSyncVasync"></a>  Выбор синхронного или асинхронного метода действия

В этом разделе перечислены рекомендации, когда использовать синхронные или асинхронные методы действия. Это только рекомендации. Проверьте каждое приложение, чтобы определить, является ли асинхронные методы проблем с производительностью.

В общем случае используйте синхронные методы для следующих условий:

- Операции являются простыми и кратковременными.
- Простота имеет более важной, чем эффективность.
- Операции основном являются операциями ЦП вместо операции, включающие широко используется диск или сетевые ресурсы. Использование асинхронных методов действия в операциях ЦП не дает преимущества и приводит к дополнительному издержек.

  В общем случае используйте асинхронные методы для следующих условий:

- Выполняется вызов служб, которые могут быть использованы через асинхронных методов, и вы используете .NET 4.5 или более поздней.
- Операций, связанных с сетью или ввода-вывода вместо ЦП.
- Параллелизм имеет большее значение, чем простота кода.
- Вы хотите предоставить механизм, который позволяет пользователям отменить длительные запрос.
- Когда преимущество переключение потоков перевешивают затраты на переключение контекста. В общем случае следует метод асинхронной Если синхронный метод ожидает потока запросов ASP.NET во время выполнения нет работы. Путем вызова асинхронного потока запросов ASP.NET не остановлен не выполняют никакой работы при ожидании завершения запроса веб-службой.
- Тестирование показывает, что блокировка операций приводит к ухудшению производительности сайта и что IIS может обслуживать большее количество запросов с помощью асинхронных методов для этих заблокированных вызовов.

  Загружаемый пример показано, как эффективно использовать асинхронные методы действия. Предоставленный образец был разработан для обеспечения простого демонстрацию асинхронного программирования в .NET 4.5 с помощью ASP.NET MVC 4. Образец не является ссылочной архитектуры для асинхронного программирования в ASP.NET MVC. Программа-пример вызывает [веб-API ASP.NET](../../../web-api/index.md) методы, которые в свою очередь вызывают [Task.Delay](https://msdn.microsoft.com/library/hh139096(VS.110).aspx) для имитации вызовы долго выполняющихся веб-службы. Большинство приложений не продемонстрируют такие очевидные преимущества для использования асинхронных методов действия.   
  
Некоторые приложения требуют все методы действия были асинхронными. Часто преобразование нескольких синхронных методов действия в асинхронные методы обеспечивает наилучший прирост эффективности объема работ.

## <a id="SampleApp"></a>  Образец приложения

Можно загрузить пример приложения из [ https://github.com/RickAndMSFT/Async-ASP.NET/ ](https://github.com/RickAndMSFT/Async-ASP.NET) на [GitHub](https://github.com/) сайта. Репозиторий состоит из трех проектов.

- *Mvc4Async*: проект ASP.NET MVC 4, который содержит код, используемый в этом учебнике. Он выполняет вызовы веб-API **WebAPIpgw** службы.
- *WebAPIpgw*: проект веб-API ASP.NET MVC 4, реализующий `Products, Gizmos and Widgets` контроллеров. Он предоставляет данные для *WebAppAsync* проекта и *Mvc4Async* проекта.
- *WebAppAsync*: проекта веб-форм ASP.NET, используемого в следующем учебнике.

## <a id="GizmosSynch"></a>  Барахло синхронный метод действия

 В следующем коде показано `Gizmos` синхронный метод действия, используемый для отображения списка барахло. (Для данной статьи gizmo — это вымышленная механические устройство). 

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample1.cs)]

В следующем коде показано `GetGizmos` метод gizmo службы.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample2.cs)]

`GizmoService GetGizmos` Метод передает URI службы ASP.NET Web API HTTP, который возвращает список данных барахло. *WebAPIpgw* проект содержит реализацию веб-API `gizmos, widget` и `product` контроллеров.  
На следующем рисунке представление барахло из образца проекта.

![Барахло](using-asynchronous-methods-in-aspnet-mvc-4/_static/image1.png)

## <a id="CreatingAsynchGizmos"></a>  Создание барахло асинхронный метод действия

В образце используется новый [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) и [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) ключевые слова (доступна в .NET 4.5 и Visual Studio 2012), чтобы позволить компилятору отвечает за поддержание сложные преобразования, необходимые для Асинхронное программирование. Компилятор позволяет писать код, используя создает поток синхронной управления C# и компилятор автоматически применяет преобразования, необходимые для использования обратных вызовов во избежание блокировки потоков.

В следующем коде показано `Gizmos` синхронный метод и `GizmosAsync` асинхронного метода. Если браузер поддерживает [HTML 5 `<mark>` элемент](http://www.w3.org/wiki/HTML/Elements/mark), вы увидите изменения в `GizmosAsync` в желтой выделения.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample3.cs)]

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample4.cs?highlight=1,3,5)]

 Следующие изменения были применены к возможным `GizmosAsync` выполняться асинхронно.

- Метод помечен атрибутом [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевое слово, которое указывает компилятору создавать обратные вызовы для частей текста и автоматически создавать `Task<ActionResult>` , возвращается.
- &quot;Асинхронный&quot; был добавлен к имени метода. Добавление «Async» не является обязательным, но соглашение, используемое при создании асинхронных методов.
- Возвращаемый тип был изменен с `ActionResult` для `Task<ActionResult>`. Тип возвращаемого значения `Task<ActionResult>` представляет выполняющуюся работу и предоставляет этот метод с дескриптором, через который ожидает завершения асинхронной операции. В этом случае вызывающий объект является веб-службы. `Task<ActionResult>` представляет текущую работать с результатом `ActionResult.`
- [Await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) была применена ключевое слово для вызова веб-службы.
- Был вызван API асинхронного веб-службы (`GetGizmosAsync`).

Внутри `GetGizmosAsync` метод body другого асинхронного метода, `GetGizmosAsync` вызывается. `GetGizmosAsync` немедленно возвращает `Task<List<Gizmo>>` , со временем будет выполнена, когда данные станут доступны. Поскольку вы не хотите выполнять дополнительные действия, чтобы отобразить данные gizmo, код ожидает задачу (с помощью **await** ключевое слово). Можно использовать **await** ключевое слово только в методы, помеченные **async** ключевое слово.

**Await** ключевое слово не блокирует поток до завершения задачи. Подписывает остальную часть метода как обратный вызов в задаче и немедленно возвращает. При со временем завершения выполнения ожидающей задачи, будет этот обратный вызов и таким образом возобновить выполнение метод справа, где оно было остановлено. Дополнительные сведения об использовании [await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) и [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевые слова и [задачи](https://msdn.microsoft.com/library/system.threading.tasks.task.aspx) пространства имен, в разделе [async ссылки](https://docs.microsoft.com/dotnet/csharp/language-reference/keywords/async).

В следующем коде показано `GetGizmos` и `GetGizmosAsync` методы.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample5.cs)]

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample6.cs?highlight=1,4-8)]

 Асинхронные изменения аналогичны внесенные **GizmosAsync** выше. 

- Сигнатура метода, аннотированных в [async](https://msdn.microsoft.com/library/hh156513(VS.110).aspx) ключевое слово, был изменен тип возвращаемого значения на `Task<List<Gizmo>>`, и *Async* был добавлен к имени метода.
- Асинхронная [HttpClient](https://msdn.microsoft.com/library/system.net.http.httpclient(VS.110).aspx) класс используется вместо [WebClient](https://msdn.microsoft.com/library/system.net.webclient.aspx) класса.
- [Await](https://msdn.microsoft.com/library/hh156528(VS.110).aspx) ключевое слово была применена к [HttpClient](https://msdn.microsoft.com/library/system.net.http.httpclient(VS.110).aspx) асинхронных методов.

На следующем рисунке представление асинхронной gizmo.

![async](using-asynchronous-methods-in-aspnet-mvc-4/_static/image2.png)

Представление браузеры данных барахло идентична представление, созданное с синхронный вызов. Единственное различие заключается в асинхронной версии может быть более производительным под высокой нагрузкой.

## <a id="Parallel"></a>  Параллельное выполнение нескольких операций

Асинхронные методы действия имеют значительное преимущество над синхронных методов, когда действие должно выполнить несколько независимых операций. В примере указано, синхронный метод `PWG`(для продуктов, мини-приложений и барахло) отображает результаты три вызовы веб-службы для получения списка продуктов, мини-приложений и барахло. [Веб-API ASP.NET](../../../web-api/index.md) проекта, который предоставляет эти службы использует [Task.Delay](https://msdn.microsoft.com/library/hh139096(VS.110).aspx) имитировать задержки или медленные вызовы. Если задержка равно 500 миллисекунд асинхронного `PWGasync` метод принимает немного более чем 500 миллисекунд для выполнения во время синхронного `PWG` имеет версию, чем 1 500 миллисекунд. Синхронный `PWG` метод показан в следующем коде.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample7.cs)]

Асинхронная `PWGasync` метод показан в следующем коде.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample8.cs?highlight=1,3,12)]

На следующем рисунке показано представление, возвращенные **PWGasync** метод.

![pwgAsync](using-asynchronous-methods-in-aspnet-mvc-4/_static/image3.png)

## <a id="CancelToken"></a>  Использование токена отмены

Асинхронные методы действия возвращение `Task<ActionResult>`являются можно отменить; они принимают [CancellationToken](https://msdn.microsoft.com/library/system.threading.cancellationtoken(VS.110).aspx) параметр, если он указан с [AsyncTimeout](https://msdn.microsoft.com/library/system.web.mvc.asynctimeoutattribute(VS.108).aspx) атрибута. В следующем коде показано `GizmosCancelAsync` метод с временем ожидания 150 миллисекунд.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample9.cs?highlight=1-3,5,10)]

В следующем коде показано GetGizmosAsync перегрузка, принимающая [CancellationToken](https://msdn.microsoft.com/library/system.threading.cancellationtoken(VS.110).aspx) параметра.

[!code-csharp[Main](using-asynchronous-methods-in-aspnet-mvc-4/samples/sample10.cs)]

В образце приложения, предоставляемые, выбрав *Демонстрация токена отмены* связывать вызовы `GizmosCancelAsync` метод и демонстрирует выполнение отмены асинхронного вызова.

## <a id="ServerConfig"></a>  Конфигурация сервера для вызовов веб-службы высокого уровня параллелизма и высокой задержки

Чтобы использовать преимущества асинхронного веб-приложения, может потребоваться внести некоторые изменения конфигурации сервера по умолчанию. Имейте в виду при настройке и нагрузочное тестирование асинхронного веб-приложения следующее.

- Windows 7, Windows Vista и все клиентские операционные системы Windows иметь не более 10 одновременных запросов. Вам потребуется операционной системы Windows Server, чтобы ознакомиться с преимуществами асинхронных методов в условиях высокой нагрузки.
- Зарегистрируйте .NET 4.5 с IIS из командной строки с повышенными привилегиями:  
  %windir%\Microsoft.NET\Framework64\v4.0.30319\aspnet\_regiis -i  
  В разделе [средство регистрации ASP.NET IIS (Aspnet\_regiis.exe)](https://msdn.microsoft.com/library/k6h9cz8h.aspx)
- Может потребоваться увеличить [HTTP.sys](https://www.iis.net/learn/get-started/introduction-to-iis/introduction-to-iis-architecture) предел очереди из значения по умолчанию 1000 до 5000. Если этот параметр имеет слишком мало, может появиться [HTTP.sys](https://www.iis.net/learn/get-started/introduction-to-iis/introduction-to-iis-architecture) отклонять запросы с состоянием HTTP 503. Чтобы изменить HTTP.sys предел очереди:

    - Откройте диспетчер служб IIS и перейдите в область группы приложений.
    - Щелкните целевой пул приложений правой кнопкой мыши и выберите **Дополнительные параметры**.  
        ![Дополнительно](using-asynchronous-methods-in-aspnet-mvc-4/_static/image4.png)
    - В **Дополнительные параметры** диалоговом изменение *длина очереди* от 1000 до 5 000.  
        ![Длина очереди](using-asynchronous-methods-in-aspnet-mvc-4/_static/image5.png)  
  
  Обратите внимание, на рисунках выше, .NET framework указана как версии 4.0, несмотря на то, что пул приложений использует .NET 4.5. Чтобы понять это несоответствие, см.:

    - [Управление версиями .NET и многоплатформенного нацеливания - .NET Framework 4.5 является обновление на месте до .NET 4.0](http://www.hanselman.com/blog/NETVersioningAndMultiTargetingNET45IsAnInplaceUpgradeToNET40.aspx)
    - [Настройка приложения IIS или пул приложений для использования ASP.NET 3.5, а не 2.0](http://www.hanselman.com/blog/HowToSetAnIISApplicationOrAppPoolToUseASPNET35RatherThan20.aspx)
    - [Версии и зависимости платформы .NET Framework](https://msdn.microsoft.com/library/bb822049(VS.110).aspx)
- Если приложение использует веб-службы или System.NET для взаимодействия с серверной части по протоколу HTTP можно может понадобиться увеличить [connectionManagement/maxconnection](https://msdn.microsoft.com/library/fb6y0fyc(VS.110).aspx) элемента. Для приложений ASP.NET это будет ограничена функцией автонастройки беспроводной сети в 12 раз больше число процессоров. Это означает, что в четырех proc можно иметь не более 12 \* 4 = 48 одновременных подключений к конечной точке IP. Так как это привязывается к [автонастройки](https://msdn.microsoft.com/library/7w2sway1(VS.110).aspx), самым простым способом, чтобы увеличить `maxconnection` в ASP.NET является установка приложения [System.Net.ServicePointManager.DefaultConnectionLimit](https://msdn.microsoft.com/library/system.net.servicepointmanager.defaultconnectionlimit(VS.110).aspx) программными средствами в из `Application_Start` метод в *global.asax* файла. См. в образце Загрузите пример.
- В .NET 4.5, значение по умолчанию 5000 для [MaxConcurrentRequestsPerCPU](https://blogs.msdn.com/tmarq/archive/2007/07/21/asp-net-thread-usage-on-iis-7-0-and-6-0.aspx) должно быть нормально.

---
uid: web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal
title: Извлечение и оплаты с PayPal | Документы Microsoft
author: Erikre
description: Этот учебник ряд описываются основы построения приложения веб-форм ASP.NET с помощью ASP.NET 4.5 и Microsoft Visual Studio Express 2013 для мы...
ms.author: aspnetcontent
manager: wpickett
ms.date: 09/08/2014
ms.topic: article
ms.assetid: 664ec95e-b0c9-4f43-a39f-798d0f2a7e08
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal
msc.type: authoredcontent
ms.openlocfilehash: 0dba613594686a28b82bc6d7701cda6e24b82e2e
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/10/2018
---
<a name="checkout-and-payment-with-paypal"></a><span data-ttu-id="bcfb0-103">Извлечение и оплаты с PayPal</span><span class="sxs-lookup"><span data-stu-id="bcfb0-103">Checkout and Payment with PayPal</span></span>
====================
<span data-ttu-id="bcfb0-104">по [Эрик Reitan](https://github.com/Erikre)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-104">by [Erik Reitan](https://github.com/Erikre)</span></span>

<span data-ttu-id="bcfb0-105">[Загрузите образец проекта Wingtip Toys (C#)](http://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) или [загрузить электронную (PDF)](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20ASP.NET%204.5%20Web%20Forms%20and%20Visual%20Studio%202013.pdf)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-105">[Download Wingtip Toys Sample Project (C#)](http://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) or [Download E-book (PDF)](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20ASP.NET%204.5%20Web%20Forms%20and%20Visual%20Studio%202013.pdf)</span></span>

> <span data-ttu-id="bcfb0-106">Этот учебник ряд описываются основы построения с помощью ASP.NET 4.5 и Microsoft Visual Studio Express 2013 для веб-приложения веб-форм ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-106">This tutorial series will teach you the basics of building an ASP.NET Web Forms application using ASP.NET 4.5 and Microsoft Visual Studio Express 2013 for Web.</span></span> <span data-ttu-id="bcfb0-107">Visual Studio 2013 [проект с исходным кодом C#](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) доступен по следующему этого учебника ряда.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-107">A Visual Studio 2013 [project with C# source code](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) is available to accompany this tutorial series.</span></span>


<span data-ttu-id="bcfb0-108">Этот учебник описывает изменение Wingtip Toys образец приложения для включения авторизации пользователей, регистрация и платежей, с помощью PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-108">This tutorial describes how to modify the Wingtip Toys sample application to include user authorization, registration, and payment using PayPal.</span></span> <span data-ttu-id="bcfb0-109">Только пользователи, выполнившие вход будет авторизации для покупки продуктов.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-109">Only users who are logged in will have authorization to purchase products.</span></span> <span data-ttu-id="bcfb0-110">Функциональные возможности регистрации встроенный в пользовательский шаблон проекта веб-форм ASP.NET 4.5 уже содержит большую часть необходимых.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-110">The ASP.NET 4.5 Web Forms project template's built-in user registration functionality already includes much of what you need.</span></span> <span data-ttu-id="bcfb0-111">Добавляются функции извлечения Express PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-111">You will add PayPal Express Checkout functionality.</span></span> <span data-ttu-id="bcfb0-112">В этом учебнике вы используете тестировании среде, поэтому будут передаваться без фактического средств разработчика PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-112">In this tutorial you be using the PayPal developer testing environment, so no actual funds will be transferred.</span></span> <span data-ttu-id="bcfb0-113">В конце учебника будет тестирование приложения путем выбора продуктов, чтобы добавить в корзину, нажмите кнопку извлечения и передаче данных в PayPal тестирования веб-сайта.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-113">At the end of the tutorial, you will test the application by selecting products to add to the shopping cart, clicking the checkout button, and transferring data to the PayPal testing web site.</span></span> <span data-ttu-id="bcfb0-114">На веб-сайте тестирования PayPal будет подтвердите свои сведения доставки "и" Оплата ", а затем вернитесь в локальном пример приложения Wingtip Toys для подтверждения и завершения покупки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-114">On the PayPal testing web site, you will confirm your shipping and payment information and then return to the local Wingtip Toys sample application to confirm and complete the purchase.</span></span>

<span data-ttu-id="bcfb0-115">Имеется несколько процессоров опытным оплаты сторонних разработчиков, специализирующихся на покупок в сети, адрес масштабируемости и безопасности.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-115">There are several experienced third-party payment processors that specialize in online shopping that address scalability and security.</span></span> <span data-ttu-id="bcfb0-116">Разработчики ASP.NET следует учитывать преимущества использования решения сторонних разработчиков оплаты до реализации покупок и приобретения решения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-116">ASP.NET developers should consider the advantages of utilizing a third party payment solution before implementing a shopping and purchasing solution.</span></span>

> [!NOTE] 
> 
> <span data-ttu-id="bcfb0-117">Пример приложения Wingtip Toys была разработана для показано определенные понятия ASP.NET и возможностях, доступных разработчикам веб-страниц ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-117">The Wingtip Toys sample application was designed to shown specific ASP.NET concepts and features available to ASP.NET web developers.</span></span> <span data-ttu-id="bcfb0-118">В этом образце приложения не была оптимизирована для всех возможных случаях отношении масштабируемости и безопасности.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-118">This sample application was not optimized for all possible circumstances in regard to scalability and security.</span></span>


## <a name="what-youll-learn"></a><span data-ttu-id="bcfb0-119">Что вы узнаете следующее.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-119">What you'll learn:</span></span>

- <span data-ttu-id="bcfb0-120">Как ограничить доступ на отдельные страницы в папке.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-120">How to restrict access to specific pages in a folder.</span></span>
- <span data-ttu-id="bcfb0-121">Инструкции по созданию известных корзины из анонимного корзины.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-121">How to create a known shopping cart from an anonymous shopping cart.</span></span>
- <span data-ttu-id="bcfb0-122">Как включить SSL для проекта.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-122">How to enable SSL for the project.</span></span>
- <span data-ttu-id="bcfb0-123">Инструкции по добавлению поставщика OAuth в проект.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-123">How to add an OAuth provider to the project.</span></span>
- <span data-ttu-id="bcfb0-124">Инструкции по использованию PayPal приобретать продукцию, с помощью среды тестирования PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-124">How to use PayPal to purchase products using the PayPal testing environment.</span></span>
- <span data-ttu-id="bcfb0-125">Способ отображения сведений из PayPal в **DetailsView** элемента управления.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-125">How to display details from PayPal in a **DetailsView** control.</span></span>
- <span data-ttu-id="bcfb0-126">Как обновить базу данных приложения Wingtip Toys сведения, полученные из PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-126">How to update the database of the Wingtip Toys application with details obtained from PayPal.</span></span>

## <a name="adding-order-tracking"></a><span data-ttu-id="bcfb0-127">Добавление трассировка заказа</span><span class="sxs-lookup"><span data-stu-id="bcfb0-127">Adding Order Tracking</span></span>

<span data-ttu-id="bcfb0-128">В этом учебнике вы создадите два новых класса, чтобы отслеживать данные от порядка создания пользователя.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-128">In this tutorial, you'll create two new classes to track data from the order a user has created.</span></span> <span data-ttu-id="bcfb0-129">Классы будет отслеживать данные, касающиеся сведения о доставке, всего покупки и подтверждение оплаты.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-129">The classes will track data regarding shipping information, purchase total, and payment confirmation.</span></span>

### <a name="add-the-order-and-orderdetail-model-classes"></a><span data-ttu-id="bcfb0-130">Добавление заказа и классы OrderDetail модели</span><span class="sxs-lookup"><span data-stu-id="bcfb0-130">Add the Order and OrderDetail Model Classes</span></span>

<span data-ttu-id="bcfb0-131">Ранее в данной серии учебных курсов определенные схемы для категорий продуктов, и элементы покупательской корзины, создав `Category`, `Product`, и `CartItem` классы в *моделей* папки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-131">Earlier in this tutorial series, you defined the schema for categories, products, and shopping cart items by creating the `Category`, `Product`, and `CartItem` classes in the *Models* folder.</span></span> <span data-ttu-id="bcfb0-132">Теперь добавим две новые классы для определения схемы для заказа продукта и сведения о заказе.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-132">Now you will add two new classes to define the schema for the product order and the details of the order.</span></span>

1. <span data-ttu-id="bcfb0-133">В **моделей** папки, добавьте новый класс с именем *Order.cs*.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-133">In the **Models** folder, add a new class named *Order.cs*.</span></span>   
   <span data-ttu-id="bcfb0-134">В редакторе отображается новый файл класса.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-134">The new class file is displayed in the editor.</span></span>
2. <span data-ttu-id="bcfb0-135">Замените код по умолчанию следующим:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-135">Replace the default code with the following:</span></span>   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample1.cs)]
3. <span data-ttu-id="bcfb0-136">Добавить *OrderDetail.cs* класса *моделей* папки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-136">Add an *OrderDetail.cs* class to the *Models* folder.</span></span>
4. <span data-ttu-id="bcfb0-137">Замените код по умолчанию следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-137">Replace the default code with the following code:</span></span>   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample2.cs)]

<span data-ttu-id="bcfb0-138">`Order` И `OrderDetail` классы содержат схему для определения порядка сведения, используемые для покупки и доставки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-138">The `Order` and `OrderDetail` classes contain the schema to define the order information used for purchasing and shipping.</span></span>

<span data-ttu-id="bcfb0-139">Кроме того необходимо обновить класс контекста базы данных, управляющий классы сущностей и предоставляющий доступ к базе данных.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-139">In addition, you will need to update the database context class that manages the entity classes and that provides data access to the database.</span></span> <span data-ttu-id="bcfb0-140">Для этого необходимо добавить только что созданного заказа и `OrderDetail` классов для модели `ProductContext` класса.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-140">To do this, you will add the newly created Order and `OrderDetail` model classes to `ProductContext` class.</span></span>

1. <span data-ttu-id="bcfb0-141">В **обозревателе решений**, найдите и откройте *ProductContext.cs* файла.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-141">In **Solution Explorer**, find and open the *ProductContext.cs* file.</span></span>
2. <span data-ttu-id="bcfb0-142">Добавьте код, выделенный для *ProductContext.cs* файла, как показано ниже:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-142">Add the highlighted code to the *ProductContext.cs* file as shown below:</span></span>   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample3.cs?highlight=14-15)]

<span data-ttu-id="bcfb0-143">Как упоминалось ранее в данной серии учебных курсов, код в *ProductContext.cs* добавляет файл `System.Data.Entity` пространства имен, чтобы получить доступ к основным функциям платформы Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-143">As mentioned previously in this tutorial series, the code in the *ProductContext.cs* file adds the `System.Data.Entity` namespace so that you have access to all the core functionality of the Entity Framework.</span></span> <span data-ttu-id="bcfb0-144">Эта функция включает в себя возможность запроса, вставки, обновления и удаления данных при работе со строго типизированных объектов.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-144">This functionality includes the capability to query, insert, update, and delete data by working with strongly typed objects.</span></span> <span data-ttu-id="bcfb0-145">Приведенный выше код в `ProductContext` класс добавляет Entity Framework доступа к недавно добавленному `Order` и `OrderDetail` классы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-145">The above code in the `ProductContext` class adds Entity Framework access to the newly added `Order` and `OrderDetail` classes.</span></span>

## <a name="adding-checkout-access"></a><span data-ttu-id="bcfb0-146">Добавление доступа извлечения</span><span class="sxs-lookup"><span data-stu-id="bcfb0-146">Adding Checkout Access</span></span>

<span data-ttu-id="bcfb0-147">Пример приложения Wingtip Toys позволяет анонимным пользователям для просмотра и добавляют продукты в корзину для покупок.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-147">The Wingtip Toys sample application allows anonymous users to review and add products to a shopping cart.</span></span> <span data-ttu-id="bcfb0-148">Тем не менее если анонимные пользователи покупать продукты, в котором они добавлены в корзину покупок, их необходимо войти на сайт.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-148">However, when anonymous users choose to purchase the products they added to the shopping cart, they must log on to the site.</span></span> <span data-ttu-id="bcfb0-149">Вошедшим в систему, они могут обращаться к страницы с ограниченным доступом веб-приложения, которые обрабатывают извлечение и приобрести процесса.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-149">Once they have logged on, they can access the restricted pages of the Web application that handle the checkout and purchase process.</span></span> <span data-ttu-id="bcfb0-150">Эти страницы с ограниченным доступом, содержащиеся в *извлечение* папке приложения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-150">These restricted pages are contained in the *Checkout* folder of the application.</span></span>

### <a name="add-a-checkout-folder-and-pages"></a><span data-ttu-id="bcfb0-151">Добавление папки извлечения и страниц</span><span class="sxs-lookup"><span data-stu-id="bcfb0-151">Add a Checkout Folder and Pages</span></span>

<span data-ttu-id="bcfb0-152">Теперь вы создадите *извлечение* папки и страниц в нем, которое будут видеть клиента во время процесса извлечения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-152">You will now create the *Checkout* folder and the pages in it that the customer will see during the checkout process.</span></span> <span data-ttu-id="bcfb0-153">Далее в этом учебнике, потребуется обновить эти страницы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-153">You will update these pages later in this tutorial.</span></span>

1. <span data-ttu-id="bcfb0-154">Щелкните правой кнопкой мыши имя проекта (**Wingtip Toys**) в **обозревателе решений** и выберите **добавьте новую папку**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-154">Right-click the project name (**Wingtip Toys**) in **Solution Explorer** and select **Add a New Folder**.</span></span> 

    ![Извлечение и оплаты с PayPal - новая папка](checkout-and-payment-with-paypal/_static/image1.png)
2. <span data-ttu-id="bcfb0-156">Имя новой папки *извлечения*.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-156">Name the new folder *Checkout*.</span></span>
3. <span data-ttu-id="bcfb0-157">Щелкните правой кнопкой мыши *извлечение* папки, а затем выберите **добавить**-&gt;**новый элемент**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-157">Right-click the *Checkout* folder and then select **Add**-&gt;**New Item**.</span></span> 

    ![Извлечение и оплаты с PayPal - новый элемент](checkout-and-payment-with-paypal/_static/image2.png)
4. <span data-ttu-id="bcfb0-159">Откроется диалоговое окно **Добавление нового элемента**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-159">The **Add New Item** dialog box is displayed.</span></span>
5. <span data-ttu-id="bcfb0-160">Выберите **Visual C#**  - &gt; **Web** группа шаблонов в левой части экрана.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-160">Select the **Visual C#** -&gt; **Web** templates group on the left.</span></span> <span data-ttu-id="bcfb0-161">Затем в средней области выберите **веб-форма с главной страницы**и назовите его *CheckoutStart.aspx*.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-161">Then, from the middle pane, select **Web Form with Master Page**and name it *CheckoutStart.aspx*.</span></span> 

    ![Извлечение и оплаты с PayPal - новое диалоговое окно добавления элемента](checkout-and-payment-with-paypal/_static/image3.png)
6. <span data-ttu-id="bcfb0-163">Как и ранее, выберите *Site.Master* файл в качестве главной страницы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-163">As before, select the *Site.Master* file as the master page.</span></span>
7. <span data-ttu-id="bcfb0-164">Добавьте следующие дополнительные страницы для *извлечение* папки, используя те же шаги:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-164">Add the following additional pages to the *Checkout* folder using the same steps above:</span></span>   

    - <span data-ttu-id="bcfb0-165">CheckoutReview.aspx</span><span class="sxs-lookup"><span data-stu-id="bcfb0-165">CheckoutReview.aspx</span></span>
    - <span data-ttu-id="bcfb0-166">CheckoutComplete.aspx</span><span class="sxs-lookup"><span data-stu-id="bcfb0-166">CheckoutComplete.aspx</span></span>
    - <span data-ttu-id="bcfb0-167">CheckoutCancel.aspx</span><span class="sxs-lookup"><span data-stu-id="bcfb0-167">CheckoutCancel.aspx</span></span>
    - <span data-ttu-id="bcfb0-168">CheckoutError.aspx</span><span class="sxs-lookup"><span data-stu-id="bcfb0-168">CheckoutError.aspx</span></span>

### <a name="add-a-webconfig-file"></a><span data-ttu-id="bcfb0-169">Добавьте файл Web.config</span><span class="sxs-lookup"><span data-stu-id="bcfb0-169">Add a Web.config File</span></span>

<span data-ttu-id="bcfb0-170">Путем добавления нового *Web.config* файл *извлечение* папку, вы сможете для ограничения доступа ко всем страницам, содержащиеся в папке.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-170">By adding a new *Web.config* file to the *Checkout* folder, you will be able to restrict access to all the pages contained in the folder.</span></span>

1. <span data-ttu-id="bcfb0-171">Щелкните правой кнопкой мыши *извлечение* папку и выберите **добавить**  - &gt; **новый элемент**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-171">Right-click the *Checkout* folder and select **Add** -&gt; **New Item**.</span></span>  
   <span data-ttu-id="bcfb0-172">Откроется диалоговое окно **Добавление нового элемента**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-172">The **Add New Item** dialog box is displayed.</span></span>
2. <span data-ttu-id="bcfb0-173">Выберите **Visual C#**  - &gt; **Web** группа шаблонов в левой части экрана.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-173">Select the **Visual C#** -&gt; **Web** templates group on the left.</span></span> <span data-ttu-id="bcfb0-174">Затем в средней области выберите **файл веб-конфигурации**, примите имя по умолчанию *Web.config*, а затем выберите **добавить**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-174">Then, from the middle pane, select **Web Configuration File**, accept the default name of *Web.config*, and then select **Add**.</span></span>
3. <span data-ttu-id="bcfb0-175">Замена существующего содержимого в XML *Web.config* файл со следующим:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-175">Replace the existing XML content in the *Web.config* file with the following:</span></span>  

    [!code-xml[Main](checkout-and-payment-with-paypal/samples/sample4.xml)]
4. <span data-ttu-id="bcfb0-176">Сохранить *Web.config* файла.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-176">Save the *Web.config* file.</span></span>

<span data-ttu-id="bcfb0-177">*Web.config* файл указывает, что все неизвестные пользователи веб-приложения должен быть доступ к страницам, содержащихся в *извлечение* папки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-177">The *Web.config* file specifies that all unknown users of the Web application must be denied access to the pages contained in the *Checkout* folder.</span></span> <span data-ttu-id="bcfb0-178">Тем не менее, если пользователь зарегистрировал учетную запись и войти в систему, они будут известного пользователя и будет иметь доступ к страницам в *извлечение* папки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-178">However, if the user has registered an account and is logged on, they will be a known user and will have access to the pages in the *Checkout* folder.</span></span>

<span data-ttu-id="bcfb0-179">Это важно отметить, что конфигурация ASP.NET следует иерархии, где каждый *Web.config* файл применяет параметры конфигурации в папку, в которой он находится и всех его дочерних каталогов.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-179">It's important to note that ASP.NET configuration follows a hierarchy, where each *Web.config* file applies configuration settings to the folder that it is in and to all of the child directories below it.</span></span>

<a id="SSLWebForms"></a>
## <a name="enable-ssl-for-the-project"></a><span data-ttu-id="bcfb0-180">Включить SSL для проекта</span><span class="sxs-lookup"><span data-stu-id="bcfb0-180">Enable SSL for the Project</span></span>

 <span data-ttu-id="bcfb0-181">Secure Sockets Layer (SSL) — это протокол, допускают веб-серверов и веб-клиентами для более безопасного обмена данными с помощью шифрования.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-181">Secure Sockets Layer (SSL) is a protocol defined to allow Web servers and Web clients to communicate more securely through the use of encryption.</span></span> <span data-ttu-id="bcfb0-182">Если SSL не используется, данные, которыми обмениваются клиент и сервер доступен для пакетов сканирование любой пользователь, имеющий физический доступ к сети.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-182">When SSL is not used, data sent between the client and server is open to packet sniffing by anyone with physical access to the network.</span></span> <span data-ttu-id="bcfb0-183">Кроме того некоторые распространенные схемы проверки подлинности не являются безопасными через простой HTTP.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-183">Additionally, several common authentication schemes are not secure over plain HTTP.</span></span> <span data-ttu-id="bcfb0-184">В частности Обычная проверка подлинности и проверки подлинности форм отправлять незашифрованные учетные данные.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-184">In particular, Basic authentication and forms authentication send unencrypted credentials.</span></span> <span data-ttu-id="bcfb0-185">Для обеспечения безопасности, эти схемы проверки подлинности, необходимо использовать SSL.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-185">To be secure, these authentication schemes must use SSL.</span></span> 

1. <span data-ttu-id="bcfb0-186">В **обозревателе решений**, нажмите кнопку **WingtipToys** проекта, а затем нажмите клавишу **F4** для отображения **свойства** окна.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-186">In **Solution Explorer**, click the **WingtipToys** project, then press **F4** to display the **Properties** window.</span></span>
2. <span data-ttu-id="bcfb0-187">Изменение **включен протокол SSL** для `true`.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-187">Change **SSL Enabled** to `true`.</span></span>
3. <span data-ttu-id="bcfb0-188">Копировать **URL-адрес SSL** , его можно использовать в дальнейшем.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-188">Copy the **SSL URL** so you can use it later.</span></span>   
 <span data-ttu-id="bcfb0-189">URL-адрес SSL будет `https://localhost:44300/` Если вы ранее создали веб-сайтов SSL (как показано ниже).</span><span class="sxs-lookup"><span data-stu-id="bcfb0-189">The SSL URL will be `https://localhost:44300/` unless you've previously created SSL Web Sites (as shown below).</span></span>   
    <span data-ttu-id="bcfb0-190">![Свойства проекта](checkout-and-payment-with-paypal/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-190">![Project Properties](checkout-and-payment-with-paypal/_static/image4.png)</span></span>
4. <span data-ttu-id="bcfb0-191">В **обозревателе решений**, щелкните правой кнопкой мыши **WingtipToys** проекта и нажмите кнопку **свойства**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-191">In **Solution Explorer**, right click the **WingtipToys** project and click **Properties**.</span></span>
5. <span data-ttu-id="bcfb0-192">На левой вкладке нажмите кнопку **Web**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-192">In the left tab, click **Web**.</span></span>
6. <span data-ttu-id="bcfb0-193">Изменение **URL-адрес проекта** использовать **URL-адрес SSL** сохраненный ранее.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-193">Change the **Project Url** to use the **SSL URL** that you saved earlier.</span></span>   
    <span data-ttu-id="bcfb0-194">![Веб-свойства проекта](checkout-and-payment-with-paypal/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-194">![Project Web Properties](checkout-and-payment-with-paypal/_static/image5.png)</span></span>
7. <span data-ttu-id="bcfb0-195">Сохраните страницу, нажав клавишу **CTRL + S**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-195">Save the page by pressing **CTRL+S**.</span></span>
8. <span data-ttu-id="bcfb0-196">Нажмите клавиши **CTRL+F5**, чтобы запустить приложение.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-196">Press **Ctrl+F5** to run the application.</span></span> <span data-ttu-id="bcfb0-197">Visual Studio будет отображать параметр позволяет избежать появления предупреждений SSL.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-197">Visual Studio will display an option to allow you to avoid SSL warnings.</span></span>
9. <span data-ttu-id="bcfb0-198">Нажмите кнопку **Да** доверять сертификату IIS Express SSL и продолжить работу.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-198">Click **Yes** to trust the IIS Express SSL certificate and continue.</span></span>   
    <span data-ttu-id="bcfb0-199">![Сведения о сертификате IIS Express SSL](checkout-and-payment-with-paypal/_static/image6.png)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-199">![IIS Express SSL certificate details](checkout-and-payment-with-paypal/_static/image6.png)</span></span>  
 <span data-ttu-id="bcfb0-200">Отображается предупреждение системы безопасности.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-200">A Security Warning is displayed.</span></span>
10. <span data-ttu-id="bcfb0-201">Нажмите кнопку **Да** установите сертификат для вашего localhost.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-201">Click **Yes** to install the certificate to your localhost.</span></span>   
    <span data-ttu-id="bcfb0-202">![Предупреждение системы безопасности-диалоговое окно](checkout-and-payment-with-paypal/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-202">![Security Warning dialog box](checkout-and-payment-with-paypal/_static/image7.png)</span></span>  
 <span data-ttu-id="bcfb0-203">Откроется окно браузера.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-203">The browser window will be displayed.</span></span>

<span data-ttu-id="bcfb0-204">Теперь можно легко проверить веб-приложения локально с помощью SSL.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-204">You can now easily test your Web application locally using SSL.</span></span>

<a id="OAuthWebForms"></a>
## <a name="add-an-oauth-20-provider"></a><span data-ttu-id="bcfb0-205">Добавьте поставщик OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="bcfb0-205">Add an OAuth 2.0 Provider</span></span>

<span data-ttu-id="bcfb0-206">Веб-форм ASP.NET предоставляет улучшенные параметры для проверки подлинности и членства.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-206">ASP.NET Web Forms provides enhanced options for membership and authentication.</span></span> <span data-ttu-id="bcfb0-207">Эти улучшения включают OAuth.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-207">These enhancements include OAuth.</span></span> <span data-ttu-id="bcfb0-208">OAuth это открытый протокол, позволяющий авторизации для безопасности в простой и стандартный метод из Интернета, мобильных и настольных приложений.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-208">OAuth is an open protocol that allows secure authorization in a simple and standard method from web, mobile, and desktop applications.</span></span> <span data-ttu-id="bcfb0-209">Шаблон веб-форм ASP.NET использует OAuth для предоставления Facebook, Twitter, Google и корпорации Майкрософт, как поставщики проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-209">The ASP.NET Web Forms template uses OAuth to expose Facebook, Twitter, Google and Microsoft as authentication providers.</span></span> <span data-ttu-id="bcfb0-210">Несмотря на то, что в этом учебнике используется только Google как поставщик проверки подлинности, можно легко изменить код, чтобы использовать любого поставщика.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-210">Although this tutorial uses only Google as the authentication provider, you can easily modify the code to use any of the providers.</span></span> <span data-ttu-id="bcfb0-211">Шаги по реализации другие поставщики очень похожи на шаги, которые можно найти в этом учебнике.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-211">The steps to implement other providers are very similar to the steps you will see in this tutorial.</span></span>

<span data-ttu-id="bcfb0-212">Кроме проверки подлинности учебник также использовать роли для реализации авторизации.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-212">In addition to authentication, the tutorial will also use roles to implement authorization.</span></span> <span data-ttu-id="bcfb0-213">Только пользователи, добавьте к `canEdit` роли, смогут выполнять изменение данных (Создание, изменение или удаление контактов).</span><span class="sxs-lookup"><span data-stu-id="bcfb0-213">Only those users you add to the `canEdit` role will be able to change data (create, edit, or delete contacts).</span></span>

> [!NOTE] 
> 
> <span data-ttu-id="bcfb0-214">Приложений Windows Live могут принимать только динамическую URL-адрес для работающего веб-сайта, поэтому нельзя использовать URL-адрес локального веб-сайта для тестирования имен входа.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-214">Windows Live applications only accept a live URL for a working website, so you cannot use a local website URL for testing logins.</span></span>


<span data-ttu-id="bcfb0-215">Следующие шаги позволит вам добавить поставщик проверки подлинности Google.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-215">The following steps will allow you to add a Google authentication provider.</span></span>

1. <span data-ttu-id="bcfb0-216">Откройте *приложения\_Start\Startup.Auth.cs* файла.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-216">Open the *App\_Start\Startup.Auth.cs* file.</span></span>
2. <span data-ttu-id="bcfb0-217">Удалите символы комментария из `app.UseGoogleAuthentication()` выполняет, чтобы метод представлен как следующие:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-217">Remove the comment characters from the `app.UseGoogleAuthentication()` method so that the method appears as follows:</span></span> 

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample5.cs)]
3. <span data-ttu-id="bcfb0-218">Перейдите к [Google Developers Console](https://console.developers.google.com/).</span><span class="sxs-lookup"><span data-stu-id="bcfb0-218">Navigate to the [Google Developers Console](https://console.developers.google.com/).</span></span> <span data-ttu-id="bcfb0-219">Также необходимо будет выполнить вход с учетной записью электронной почты разработчика Google (gmail.com).</span><span class="sxs-lookup"><span data-stu-id="bcfb0-219">You will also need to sign-in with your Google developer email account (gmail.com).</span></span> <span data-ttu-id="bcfb0-220">Если у вас учетной записи Google, выберите **создать учетную запись** ссылку.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-220">If you do not have a Google account, select the **Create an account** link.</span></span>   
   <span data-ttu-id="bcfb0-221">Далее вы увидите **Google Developers Console**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-221">Next, you'll see the **Google Developers Console**.</span></span>   
    <span data-ttu-id="bcfb0-222">![Google Developers Console](checkout-and-payment-with-paypal/_static/image8.png)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-222">![Google Developers Console](checkout-and-payment-with-paypal/_static/image8.png)</span></span>
4. <span data-ttu-id="bcfb0-223">Нажмите кнопку **Создание проекта** и введите имя проекта и ID (можно использовать значения по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="bcfb0-223">Click the **Create Project** button and enter a project name and ID (you can use the default values).</span></span> <span data-ttu-id="bcfb0-224">Нажмите кнопку **флажок соглашение** и **создать** кнопки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-224">Then, click the **agreement checkbox** and the **Create** button.</span></span>  

    ![Google - новый проект](checkout-and-payment-with-paypal/_static/image9.png)

   <span data-ttu-id="bcfb0-226">Через несколько секунд будет создан новый проект, и ваш браузер будет отображаться новая страница проектов.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-226">In a few seconds the new project will be created and your browser will display the new projects page.</span></span>
5. <span data-ttu-id="bcfb0-227">На левой вкладке нажмите кнопку **API-интерфейсы &amp; auth**, а затем нажмите кнопку **учетные данные**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-227">In the left tab, click **APIs &amp; auth**, and then click **Credentials**.</span></span>
6. <span data-ttu-id="bcfb0-228">Нажмите кнопку **создать новый идентификатор клиента** под **OAuth**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-228">Click the **Create New Client ID** under **OAuth**.</span></span>   
   <span data-ttu-id="bcfb0-229">**Создать идентификатор клиента** откроется диалоговое окно.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-229">The **Create Client ID** dialog will be displayed.</span></span>   
    <span data-ttu-id="bcfb0-230">![Google - создать идентификатор клиента](checkout-and-payment-with-paypal/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-230">![Google - Create Client ID](checkout-and-payment-with-paypal/_static/image10.png)</span></span>
7. <span data-ttu-id="bcfb0-231">В **создать идентификатор клиента** диалоговое окно, оставьте значение по умолчанию **веб-приложение** для типа приложения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-231">In the **Create Client ID** dialog, keep the default **Web application** for the application type.</span></span>
8. <span data-ttu-id="bcfb0-232">Задать **Authorized JavaScript Origins** URL-адрес SSL, использованные ранее в этом учебнике (`https://localhost:44300/` Если вы создали проекты SSL).</span><span class="sxs-lookup"><span data-stu-id="bcfb0-232">Set the **Authorized JavaScript Origins** to the SSL URL you used earlier in this tutorial (`https://localhost:44300/` unless you've created other SSL projects).</span></span>   
   <span data-ttu-id="bcfb0-233">Этот URL-адрес является источником для вашего приложения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-233">This URL is the origin for your application.</span></span> <span data-ttu-id="bcfb0-234">Для этого примера будет только введите URL-адрес localhost теста.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-234">For this sample, you will only enter the localhost test URL.</span></span> <span data-ttu-id="bcfb0-235">Тем не менее можно ввести несколько URL-адресов с учетом localhost и производства.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-235">However, you can enter multiple URLs to account for localhost and production.</span></span>
9. <span data-ttu-id="bcfb0-236">Задать **авторизации URI перенаправления** следующее:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-236">Set the **Authorized Redirect URI** to the following:</span></span> 

    [!code-html[Main](checkout-and-payment-with-paypal/samples/sample6.html)]

   <span data-ttu-id="bcfb0-237">Это значение представляет собой URI, ASP.NET OAuth пользователям взаимодействовать с сервером google OAuth.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-237">This value is the URI that ASP.NET OAuth users to communicate with the google OAuth server.</span></span> <span data-ttu-id="bcfb0-238">Помните, приведенном выше URL-адрес SSL ( `https://localhost:44300/` Если вы создали проекты SSL).</span><span class="sxs-lookup"><span data-stu-id="bcfb0-238">Remember the SSL URL you used above (    `https://localhost:44300/` unless you've created other SSL projects).</span></span>
10. <span data-ttu-id="bcfb0-239">Нажмите кнопку **создать идентификатор клиента** кнопки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-239">Click the **Create Client ID** button.</span></span>
11. <span data-ttu-id="bcfb0-240">В левом меню Google Developers Console, нажмите кнопку **экран согласия** пункта меню, задайте адрес и продукта имени электронной почты.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-240">On the left menu of the Google Developers Console, click the **Consent screen** menu item, then set your email address and product name.</span></span> <span data-ttu-id="bcfb0-241">После завершения формы щелкните **Сохранить**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-241">When you have completed the form, click **Save**.</span></span>
12. <span data-ttu-id="bcfb0-242">Нажмите кнопку **API-интерфейсы** пункт меню, прокрутите вниз и нажмите кнопку **off** рядом с **API Google +**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-242">Click the **APIs** menu item, scroll down and click the **off** button next to **Google+ API**.</span></span>   
    <span data-ttu-id="bcfb0-243">Этот параметр принимает включит API Google +.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-243">Accepting this option will enable the Google+ API.</span></span>
13. <span data-ttu-id="bcfb0-244">Необходимо также обновить **Microsoft.Owin** пакет NuGet версии 3.0.0.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-244">You must also update the **Microsoft.Owin** NuGet package to version 3.0.0.</span></span>   
    <span data-ttu-id="bcfb0-245">Из **средства** последовательно выберите пункты **диспетчера пакетов NuGet** , а затем выберите **управление пакетами NuGet для решения**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-245">From the **Tools** menu, select **NuGet Package Manager** and then select **Manage NuGet Packages for Solution**.</span></span>  
    <span data-ttu-id="bcfb0-246">Из **управление пакетами NuGet** окна, найдите и обновление **Microsoft.Owin** пакет до версии 3.0.0.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-246">From the **Manage NuGet Packages** window, find and update the **Microsoft.Owin** package to version 3.0.0.</span></span>
14. <span data-ttu-id="bcfb0-247">В Visual Studio обновить `UseGoogleAuthentication` метод *Startup.Auth.cs* страницы путем копирования и вставки **идентификатор клиента** и **секрет клиента** в метод.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-247">In Visual Studio, update the `UseGoogleAuthentication` method of the *Startup.Auth.cs* page by copying and pasting the **Client ID** and **Client Secret** into the method.</span></span> <span data-ttu-id="bcfb0-248">**Идентификатор клиента** и **секрет клиента** значений, приведенных ниже примеров и не будет работать.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-248">The **Client ID** and **Client Secret** values shown below are samples and will not work.</span></span> 

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample7.cs?highlight=64-65)]
15. <span data-ttu-id="bcfb0-249">Нажмите клавишу **CTRL + F5** для построения и запуска приложения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-249">Press **CTRL+F5** to build and run the application.</span></span> <span data-ttu-id="bcfb0-250">Нажмите кнопку **входа** ссылку.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-250">Click the **Log in** link.</span></span>
16. <span data-ttu-id="bcfb0-251">В разделе **используется другой службой для входа в**, нажмите кнопку **Google**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-251">Under **Use another service to log in**, click **Google**.</span></span>  
    <span data-ttu-id="bcfb0-252">![Войти](checkout-and-payment-with-paypal/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-252">![Log in](checkout-and-payment-with-paypal/_static/image11.png)</span></span>
17. <span data-ttu-id="bcfb0-253">Если вам нужно ввести учетные данные, вы будете перенаправлены на сайт google, можно будет ввести учетные данные.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-253">If you need to enter your credentials, you will be redirected to the google site where you will enter your credentials.</span></span>  
    ![Google - входа](checkout-and-payment-with-paypal/_static/image12.png)
18. <span data-ttu-id="bcfb0-255">После ввода учетных данных, будет предложено предоставить разрешения для только что созданной веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-255">After you enter your credentials, you will be prompted to give permissions to the web application you just created.</span></span>  
    ![Учетная запись службы по умолчанию для проекта](checkout-and-payment-with-paypal/_static/image13.png)
19. <span data-ttu-id="bcfb0-257">Нажмите кнопку **принимать**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-257">Click **Accept**.</span></span> <span data-ttu-id="bcfb0-258">Вам будут перенаправляться к **зарегистрировать** страница **WingtipToys** приложения, где можно зарегистрировать учетную запись Google.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-258">You will now be redirected back to the **Register** page of the **WingtipToys** application where you can register your Google account.</span></span>  
    <span data-ttu-id="bcfb0-259">![Зарегистрировать учетную запись Google](checkout-and-payment-with-paypal/_static/image14.png)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-259">![Register with your Google Account](checkout-and-payment-with-paypal/_static/image14.png)</span></span>
20. <span data-ttu-id="bcfb0-260">Вы можете изменить имя локальной электронной почты регистрации, используемое для свою учетную запись Gmail, но обычно требуется сохранить псевдоним электронной почты по умолчанию (один используется для проверки подлинности).</span><span class="sxs-lookup"><span data-stu-id="bcfb0-260">You have the option of changing the local email registration name used for your Gmail account, but you generally want to keep the default email alias (that is, the one you used for authentication).</span></span> <span data-ttu-id="bcfb0-261">Нажмите кнопку **входа** как показано выше.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-261">Click **Log in** as shown above.</span></span>

### <a name="modifying-login-functionality"></a><span data-ttu-id="bcfb0-262">Изменение функции входа в систему</span><span class="sxs-lookup"><span data-stu-id="bcfb0-262">Modifying Login Functionality</span></span>

<span data-ttu-id="bcfb0-263">Как описано ранее в этой серии учебника большинство функций регистрации пользователя был включен в шаблоне веб-форм ASP.NET по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-263">As previously mentioned in this tutorial series, much of the user registration functionality has been included in the ASP.NET Web Forms template by default.</span></span> <span data-ttu-id="bcfb0-264">Теперь предстоит изменить значение по умолчанию *Login.aspx* и *Register.aspx* страниц для вызова `MigrateCart` метод.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-264">Now you will modify the default *Login.aspx* and *Register.aspx* pages to call the `MigrateCart` method.</span></span> <span data-ttu-id="bcfb0-265">`MigrateCart` Метод связывает вновь вошедшего в систему пользователя с анонимной корзины.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-265">The `MigrateCart` method associates a newly logged in user with an anonymous shopping cart.</span></span> <span data-ttu-id="bcfb0-266">Путем сопоставления пользователя и Корзина для покупок, будет доступно ведение покупательской корзине пользователя между посещений пример приложения Wingtip Toys.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-266">By associating the user and shopping cart, the Wingtip Toys sample application will be able to maintain the shopping cart of the user between visits.</span></span>

1. <span data-ttu-id="bcfb0-267">В **обозревателе решений**, найдите и откройте *учетной записи* папки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-267">In **Solution Explorer**, find and open the *Account* folder.</span></span>
2. <span data-ttu-id="bcfb0-268">Изменение кода страницы с именем *Login.aspx.cs* необходимо выделены желтым цветом, код, чтобы он выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-268">Modify the code-behind page named *Login.aspx.cs* to include the code highlighted in yellow, so that it appears as follows:</span></span>   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample8.cs?highlight=41-43)]
3. <span data-ttu-id="bcfb0-269">Сохранить *Login.aspx.cs* файла.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-269">Save the *Login.aspx.cs* file.</span></span>

<span data-ttu-id="bcfb0-270">Теперь можно пропустить это предупреждение, которое отсутствует определение для `MigrateCart` метод.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-270">For now, you can ignore the warning that there is no definition for the `MigrateCart` method.</span></span> <span data-ttu-id="bcfb0-271">Будет добавлен его чуть позже в этом учебнике.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-271">You will be adding it a bit later in this tutorial.</span></span>

<span data-ttu-id="bcfb0-272">*Login.aspx.cs* файл кода программной части поддерживает метод входа.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-272">The *Login.aspx.cs* code-behind file supports a LogIn method.</span></span> <span data-ttu-id="bcfb0-273">Проверив на страницу Login.aspx, вы увидите, что эта страница отображается кнопка «Вход», если щелкните триггеры `LogIn` обработчиком для кода.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-273">By inspecting the Login.aspx page, you'll see that this page includes a "Log in" button that when click triggers the `LogIn` handler on the code-behind.</span></span>

<span data-ttu-id="bcfb0-274">Когда `Login` метод *Login.aspx.cs* вызывается новый экземпляр покупательской корзине с именем `usersShoppingCart` создается.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-274">When the `Login` method on the *Login.aspx.cs* is called, a new instance of the shopping cart named `usersShoppingCart` is created.</span></span> <span data-ttu-id="bcfb0-275">Идентификатор (GUID) покупательской корзине извлекается и присвоено `cartId` переменной.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-275">The ID of the shopping cart (a GUID) is retrieved and set to the `cartId` variable.</span></span> <span data-ttu-id="bcfb0-276">Затем `MigrateCart` вызывается метод, передав оба `cartId` и имя пользователя вошедшего в систему с этим методом.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-276">Then, the `MigrateCart` method is called, passing both the `cartId` and the name of the logged-in user to this method.</span></span> <span data-ttu-id="bcfb0-277">При миграции покупательской корзины, идентификатор GUID, используемый для идентификации анонимных покупательской корзине заменяется имя пользователя.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-277">When the shopping cart is migrated, the GUID used to identify the anonymous shopping cart is replaced with the user name.</span></span>

<span data-ttu-id="bcfb0-278">В дополнение к изменению *Login.aspx.cs* файл кода для переноса в корзину для покупок, при входе пользователя, необходимо также изменить *файл кода программной части Register.aspx.cs* для переноса в корзину для покупок Когда пользователь создает новую учетную запись и выполнить вход.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-278">In addition to modifying the *Login.aspx.cs* code-behind file to migrate the shopping cart when the user logs in, you must also modify the *Register.aspx.cs code-behind file* to migrate the shopping cart when the user creates a new account and logs in.</span></span>

1. <span data-ttu-id="bcfb0-279">В *учетной записи* папку, откройте файл кода с именем *Register.aspx.cs*.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-279">In the *Account* folder, open the code-behind file named *Register.aspx.cs*.</span></span>
2. <span data-ttu-id="bcfb0-280">Измените файл кода путем включения кода желтым цветом, так, чтобы он выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-280">Modify the code-behind file by including the code in yellow, so that it appears as follows:</span></span>   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample9.cs?highlight=28-32)]
3. <span data-ttu-id="bcfb0-281">Сохранить *Register.aspx.cs* файла.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-281">Save the *Register.aspx.cs* file.</span></span> <span data-ttu-id="bcfb0-282">Опять же, пропустить это предупреждение о `MigrateCart` метод.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-282">Once again, ignore the warning about the `MigrateCart` method.</span></span>

<span data-ttu-id="bcfb0-283">Обратите внимание, что код, который использовался в `CreateUser_Click` обработчик событий очень похож на код, используемый в `LogIn` метод.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-283">Notice that the code you used in the `CreateUser_Click` event handler is very similar to the code you used in the `LogIn` method.</span></span> <span data-ttu-id="bcfb0-284">Когда пользователь регистрирует или входе на сайт, вызов `MigrateCart` метод будут внесены.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-284">When the user registers or logs in to the site, a call to the `MigrateCart` method will be made.</span></span>

## <a name="migrating-the-shopping-cart"></a><span data-ttu-id="bcfb0-285">Миграция в корзину для покупок</span><span class="sxs-lookup"><span data-stu-id="bcfb0-285">Migrating the Shopping Cart</span></span>

<span data-ttu-id="bcfb0-286">Теперь, когда процесс входа в систему "и" Регистрация обновления можно добавить код для переноса в корзину для покупок с помощью `MigrateCart` метод.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-286">Now that you have the log-in and registration process updated, you can add the code to migrate the shopping cart using the `MigrateCart` method.</span></span>

1. <span data-ttu-id="bcfb0-287">В **обозревателе решений**, найти *логику* папку *ShoppingCartActions.cs* файл класса.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-287">In **Solution Explorer**, find the *Logic* folder and open the *ShoppingCartActions.cs* class file.</span></span>
2. <span data-ttu-id="bcfb0-288">Добавьте код, выделены желтым цветом, позволяя существующий код в *ShoppingCartActions.cs* файл, чтобы код в *ShoppingCartActions.cs* файл отображается следующим образом:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-288">Add the code highlighted in yellow to the existing code in the *ShoppingCartActions.cs* file, so that the code in the *ShoppingCartActions.cs* file appears as follows:</span></span>   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample10.cs?highlight=215-224)]

<span data-ttu-id="bcfb0-289">`MigrateCart` Метод использует существующие cartId для поиска в корзину пользователя.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-289">The `MigrateCart` method uses the existing cartId to find the shopping cart of the user.</span></span> <span data-ttu-id="bcfb0-290">Затем код просматривает все корзину покупок и заменяет `CartId` свойства (как указано в `CartItem` схемы) с именем пользователя, выполнившего вход.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-290">Next, the code loops through all the shopping cart items and replaces the `CartId` property (as specified by the `CartItem` schema) with the logged-in user name.</span></span>

### <a name="updating-the-database-connection"></a><span data-ttu-id="bcfb0-291">Обновление подключения к базе данных</span><span class="sxs-lookup"><span data-stu-id="bcfb0-291">Updating the Database Connection</span></span>

<span data-ttu-id="bcfb0-292">Если вы следуете данного учебника с помощью **готовых** Wingtip Toys образец приложения, необходимо повторно создать базу данных членства по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-292">If you are following this tutorial using the **prebuilt** Wingtip Toys sample application, you must recreate the default membership database.</span></span> <span data-ttu-id="bcfb0-293">Изменив строку соединения по умолчанию, база данных членства будут создаваться при следующем запуске приложения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-293">By modifying the default connection string, the membership database will be created the next time the application runs.</span></span>

1. <span data-ttu-id="bcfb0-294">Откройте *Web.config* файл в корневой папке проекта.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-294">Open the *Web.config* file at the root of the project.</span></span>
2. <span data-ttu-id="bcfb0-295">Обновляет строку подключения по умолчанию, выглядит следующим образом.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-295">Update the default connection string so that it appears as follows:</span></span>   

    [!code-xml[Main](checkout-and-payment-with-paypal/samples/sample11.xml)]

<a id="PayPalWebForms"></a>
## <a name="integrating-paypal"></a><span data-ttu-id="bcfb0-296">Интеграция PayPal</span><span class="sxs-lookup"><span data-stu-id="bcfb0-296">Integrating PayPal</span></span>

<span data-ttu-id="bcfb0-297">PayPal — веб-платформа выставления счетов, которая принимает платежи с Интернет-магазины.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-297">PayPal is a web-based billing platform that accepts payments by online merchants.</span></span> <span data-ttu-id="bcfb0-298">Далее в этом руководстве рассматривается интегрировать функциональные возможности извлечения Express PayPal в приложении.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-298">This tutorial next explains how to integrate PayPal's Express Checkout functionality into your application.</span></span> <span data-ttu-id="bcfb0-299">Извлечение Express позволяет пользователям использовать PayPal для оплаты для элементов, которые они добавлены их в корзину.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-299">Express Checkout allows your customers to use PayPal to pay for the items they have added to their shopping cart.</span></span>

### <a name="create-paylpal-test-accounts"></a><span data-ttu-id="bcfb0-300">Создание тестовых PaylPal учетных записей</span><span class="sxs-lookup"><span data-stu-id="bcfb0-300">Create PaylPal Test Accounts</span></span>

<span data-ttu-id="bcfb0-301">Чтобы использовать PayPal, в тестовой среде, необходимо создать и проверить тестовую учетную запись разработчика.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-301">To use the PayPal testing environment, you must create and verify a developer test account.</span></span> <span data-ttu-id="bcfb0-302">Для создания покупатель тестовой учетной записи и продавца тестовую учетную запись будет использовать тестовую учетную запись разработчика.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-302">You will use the developer test account to create a buyer test account and a seller test account.</span></span> <span data-ttu-id="bcfb0-303">Тестовые учетные данные учетной записи разработчика также позволит Wingtip Toys образец приложения для доступа к тестовой среде PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-303">The developer test account credentials also will allow the Wingtip Toys sample application to access the PayPal testing environment.</span></span>

1. <span data-ttu-id="bcfb0-304">В браузере перейдите к разработчику PayPal проверка узла:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-304">In a browser, navigate to the PayPal developer testing site:</span></span>   
    [https://developer.paypal.com](https://developer.paypal.com/)
2. <span data-ttu-id="bcfb0-305">При отсутствии учетной записи разработчика PayPal, создайте новую учетную запись, щелкнув **зарегистрироваться**и после регистрации действия.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-305">If you don't have a PayPal developer account, create a new account by clicking **Sign Up**and following the sign up steps.</span></span> <span data-ttu-id="bcfb0-306">При наличии существующей учетной записи разработчика PayPal вход, щелкнув **входа в**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-306">If you have an existing PayPal developer account, sign in by clicking **Log In**.</span></span> <span data-ttu-id="bcfb0-307">Вам потребуется учетной записи разработчика PayPal тестирование Wingtip Toys образца приложения далее в этом учебнике.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-307">You will need your PayPal developer account to test the Wingtip Toys sample application later in this tutorial.</span></span>
3. <span data-ttu-id="bcfb0-308">Если вы только что зарегистрированы для учетной записи разработчика PayPal, может потребоваться проверить вашу учетную запись разработчика PayPal с PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-308">If you have just signed up for your PayPal developer account, you may need to verify your PayPal developer account with PayPal.</span></span> <span data-ttu-id="bcfb0-309">Вы можете проверить вашей учетной записи, выполните действия, которые PayPal отправить электронную почту.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-309">You can verify your account by following the steps that PayPal sent to your email account.</span></span> <span data-ttu-id="bcfb0-310">После проверки учетной записи разработчика PayPal войти обратно в PayPal developer проверки узла.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-310">Once you have verified your PayPal developer account, log back into the PayPal developer testing site.</span></span>
4. <span data-ttu-id="bcfb0-311">Вы вошли в систему на сайте разработчика PayPal, с учетной записью разработчика PayPal, что необходимо создать тестовую учетную запись PayPal покупатель при отсутствии уже после одного.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-311">After you are logged in to the PayPal developer site with your PayPal developer account you need to create a PayPal buyer test account if you don't already have one.</span></span> <span data-ttu-id="bcfb0-312">Для создания покупатель тестовую учетную запись, при щелчке узла PayPal **приложений** и нажмите кнопку **учетные записи "песочницы"**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-312">To create a buyer test account, on the PayPal site click the **Applications** tab and then click **Sandbox accounts**.</span></span>   
 <span data-ttu-id="bcfb0-313">**Тестовые учетные записи "песочницы"** показана страница.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-313">The **Sandbox test accounts** page is shown.</span></span>   

    > [!NOTE] 
    > 
    > <span data-ttu-id="bcfb0-314">Сайт разработчиков PayPal уже предоставляет коммерческий тестовую учетную запись.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-314">The PayPal Developer site already provides a merchant test account.</span></span>

    ![Извлечение и оплаты с PayPal - тестовые учетные записи "песочницы"](checkout-and-payment-with-paypal/_static/image15.png)
5. <span data-ttu-id="bcfb0-316">На странице "песочницы" учетные записи теста выберите **Создание учетной записи**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-316">On the Sandbox test accounts page, click **Create Account**.</span></span>
6. <span data-ttu-id="bcfb0-317">На **создать тестовую учетную запись** выберите покупатель тестовое сообщение электронной почты учетной записи и пароль по вашему выбору.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-317">On the **Create test account** page choose a buyer test account email and password of your choice.</span></span>   

    > [!NOTE] 
    > 
    > <span data-ttu-id="bcfb0-318">Необходимо будет покупатель адреса электронной почты и пароль для проверки примера приложения Wingtip Toys в конце этого учебника.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-318">You will need the buyer email addresses and password to test the Wingtip Toys sample application at the end of this tutorial.</span></span>

    ![Извлечение и оплаты с PayPal - тестовые учетные записи "песочницы"](checkout-and-payment-with-paypal/_static/image16.png)
7. <span data-ttu-id="bcfb0-320">Создать тестовую учетную запись покупатель, нажав кнопку **Создание учетной записи** кнопки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-320">Create the buyer test account by clicking the **Create Account** button.</span></span>  
 <span data-ttu-id="bcfb0-321">**"Песочницы" тестовые учетные записи** -страница.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-321">The **Sandbox Test accounts** page is displayed.</span></span> 

    ![Извлечение и оплаты с PayPal - PaylPal учетных записей](checkout-and-payment-with-paypal/_static/image17.png)
8. <span data-ttu-id="bcfb0-323">На **тестовые учетные записи "песочницы"** щелкните **организатора** учетную запись электронной почты.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-323">On the **Sandbox test accounts** page, click the **facilitator** email account.</span></span>  
    <span data-ttu-id="bcfb0-324">**Профиль** и **уведомления** отображаются параметры.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-324">**Profile** and **Notification** options appear.</span></span>
9. <span data-ttu-id="bcfb0-325">Выберите **профиль** параметр, а затем нажмите кнопку **учетные данные API** для просмотра API учетные данные для учетной записи коммерческий тест.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-325">Select the **Profile** option, then click **API credentials** to view your API credentials for the merchant test account.</span></span>
10. <span data-ttu-id="bcfb0-326">Копирует API ТЕСТОВ учетные данные в текстовом формате.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-326">Copy the TEST API credentials to notepad.</span></span>

<span data-ttu-id="bcfb0-327">Требуется отображаемое классический API тестирования учетные данные (имя пользователя, пароль и подпись) для выполнения вызовов API из образца приложения Wingtip Toys PayPal, в тестовой среде.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-327">You will need your displayed Classic TEST API credentials (Username, Password, and Signature) to make API calls from the Wingtip Toys sample application to the PayPal testing environment.</span></span> <span data-ttu-id="bcfb0-328">В следующем шаге вы добавите учетные данные.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-328">You will add the credentials in the next step.</span></span>

### <a name="add-paypal-class-and-api-credentials"></a><span data-ttu-id="bcfb0-329">Добавьте класс PayPal и учетные данные API</span><span class="sxs-lookup"><span data-stu-id="bcfb0-329">Add PayPal Class and API Credentials</span></span>

<span data-ttu-id="bcfb0-330">Поместите большая часть кода PayPal в один класс.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-330">You will place the majority of the PayPal code into a single class.</span></span> <span data-ttu-id="bcfb0-331">Этот класс содержит методы, используемые для взаимодействия с PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-331">This class contains the methods used to communicate with PayPal.</span></span> <span data-ttu-id="bcfb0-332">Кроме того вы добавите PayPal учетных данных к этому классу.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-332">Also, you will add your PayPal credentials to this class.</span></span>

1. <span data-ttu-id="bcfb0-333">В образце приложения Wingtip Toys в среде Visual Studio, щелкните правой кнопкой мыши **логику** папки, а затем выберите **добавить**  - &gt; **новый элемент**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-333">In the Wingtip Toys sample application within Visual Studio, right-click the **Logic** folder and then select **Add** -&gt; **New Item**.</span></span>   
   <span data-ttu-id="bcfb0-334">Откроется диалоговое окно **Добавление нового элемента**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-334">The **Add New Item** dialog box is displayed.</span></span>
2. <span data-ttu-id="bcfb0-335">В разделе **Visual C#** из **установленные** панели слева выберите **кода**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-335">Under **Visual C#** from the **Installed** pane on the left, select **Code**.</span></span>
3. <span data-ttu-id="bcfb0-336">В средней области выберите **класса**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-336">From the middle pane, select **Class**.</span></span> <span data-ttu-id="bcfb0-337">Назовите этот новый класс **PayPalFunctions.cs**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-337">Name this new class **PayPalFunctions.cs**.</span></span>
4. <span data-ttu-id="bcfb0-338">Нажмите кнопку **Добавить**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-338">Click **Add**.</span></span>  
   <span data-ttu-id="bcfb0-339">В редакторе отображается новый файл класса.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-339">The new class file is displayed in the editor.</span></span>
5. <span data-ttu-id="bcfb0-340">Замените код по умолчанию следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-340">Replace the default code with the following code:</span></span>  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample12.cs)]
6. <span data-ttu-id="bcfb0-341">Добавьте Merchant API учетные данные (имя пользователя, пароль и подписи), отображаются ранее в этом учебнике, чтобы вы могли принимать вызовы функций в среде тестирования PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-341">Add the Merchant API credentials (Username, Password, and Signature) that you displayed earlier in this tutorial so that you can make function calls to the PayPal testing environment.</span></span>  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample13.cs)]

> [!NOTE] 
> 
> <span data-ttu-id="bcfb0-342">В этом образце приложения просто добавляя учетные данные в файле C# (CS-файл).</span><span class="sxs-lookup"><span data-stu-id="bcfb0-342">In this sample application you are simply adding credentials to a C# file (.cs).</span></span> <span data-ttu-id="bcfb0-343">Тем не менее реализованного решения, следует шифровать учетные данные в файле конфигурации.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-343">However, in a implemented solution, you should consider encrypting your credentials in a configuration file.</span></span>


<span data-ttu-id="bcfb0-344">Класс NVPAPICaller содержит большую часть функций PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-344">The NVPAPICaller class contains the majority of the PayPal functionality.</span></span> <span data-ttu-id="bcfb0-345">Код в класс предоставляет методы, необходимые для проверки на покупку из среды тестирования PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-345">The code in the class provides the methods needed to make a test purchase from the PayPal testing environment.</span></span> <span data-ttu-id="bcfb0-346">Чтобы делать покупки используются следующие функции PayPal:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-346">The following three PayPal functions are used to make purchases:</span></span>

- <span data-ttu-id="bcfb0-347">`SetExpressCheckout` Функция</span><span class="sxs-lookup"><span data-stu-id="bcfb0-347">`SetExpressCheckout` function</span></span>
- <span data-ttu-id="bcfb0-348">`GetExpressCheckoutDetails` Функция</span><span class="sxs-lookup"><span data-stu-id="bcfb0-348">`GetExpressCheckoutDetails` function</span></span>
- <span data-ttu-id="bcfb0-349">`DoExpressCheckoutPayment` Функция</span><span class="sxs-lookup"><span data-stu-id="bcfb0-349">`DoExpressCheckoutPayment` function</span></span>

<span data-ttu-id="bcfb0-350">`ShortcutExpressCheckout` Метод теста и сведения о покупке собирает из корзины и вызывает `SetExpressCheckout` функция PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-350">The `ShortcutExpressCheckout` method collects the test purchase information and product details from the shopping cart and calls the `SetExpressCheckout` PayPal function.</span></span> <span data-ttu-id="bcfb0-351">`GetCheckoutDetails` Метод подтверждает сведения о покупке и вызовы `GetExpressCheckoutDetails` функция PayPal перед выполнением теста покупки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-351">The `GetCheckoutDetails` method confirms purchase details and calls the `GetExpressCheckoutDetails` PayPal function before making the test purchase.</span></span> <span data-ttu-id="bcfb0-352">`DoCheckoutPayment` Метод завершения покупки тестов из среды тестирования путем вызова `DoExpressCheckoutPayment` функция PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-352">The `DoCheckoutPayment` method completes the test purchase from the testing environment by calling the `DoExpressCheckoutPayment` PayPal function.</span></span> <span data-ttu-id="bcfb0-353">Остальная часть кода поддерживает методы PayPal и процессе, например кодирование строк, декодирования строк, обработка массивов и определение учетных данных.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-353">The remaining code supports the PayPal methods and process, such as encoding strings, decoding strings, processing arrays, and determining credentials.</span></span>

> [!NOTE] 
> 
> <span data-ttu-id="bcfb0-354">PayPal позволяет включать сведения о покупке необязательно, на основе [спецификации API в PayPal](https://cms.paypal.com/us/cgi-bin/?cmd=_render-content&amp;content_ID=developer/e_howto_api_nvp_r_SetExpressCheckout).</span><span class="sxs-lookup"><span data-stu-id="bcfb0-354">PayPal allows you to include optional purchase details based on [PayPal's API specification](https://cms.paypal.com/us/cgi-bin/?cmd=_render-content&amp;content_ID=developer/e_howto_api_nvp_r_SetExpressCheckout).</span></span> <span data-ttu-id="bcfb0-355">При расширении кода в примере приложения Wingtip Toys, может включать сведения о локализации, описаниях продукта, налогов, номер клиента службы, а также другие необязательные поля.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-355">By extending the code in the Wingtip Toys sample application, you can include localization details, product descriptions, tax, a customer service number, as well as many other optional fields.</span></span>


<span data-ttu-id="bcfb0-356">Обратите внимание, что возвращаемое значение и Отмена URL-адреса, указанные в **ShortcutExpressCheckout** в методе используется номер порта.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-356">Notice that the return and cancel URLs that are specified in the **ShortcutExpressCheckout** method use a port number.</span></span>

[!code-html[Main](checkout-and-payment-with-paypal/samples/sample14.html)]

<span data-ttu-id="bcfb0-357">При Visual Web Developer запускает веб-проекта, с помощью протокола SSL, обычно порт 44300 используется для веб-сервера.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-357">When Visual Web Developer runs a web project using SSL, commonly the port 44300 is used for the web server.</span></span> <span data-ttu-id="bcfb0-358">Как показано выше, номер порта — 44300.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-358">As shown above, the port number is 44300.</span></span> <span data-ttu-id="bcfb0-359">При запуске приложения, можно просмотреть другой номер порта.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-359">When you run the application, you could see a different port number.</span></span> <span data-ttu-id="bcfb0-360">Вашей порт номер необходимо правильно задать в коде, чтобы пользователь мог успешно запустить образец приложения Wingtip Toys в конце этого учебника.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-360">Your port number needs to be correctly set in the code so that you can successful run the Wingtip Toys sample application at the end of this tutorial.</span></span> <span data-ttu-id="bcfb0-361">В следующем разделе этого учебника показано, как получить номер порта локальный узел и обновить класс PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-361">The next section of this tutorial explains how to retrieve the local host port number and update the PayPal class.</span></span>

### <a name="update-the-localhost-port-number-in-the-paypal-class"></a><span data-ttu-id="bcfb0-362">Обновление номера порта LocalHost в классе PayPal</span><span class="sxs-lookup"><span data-stu-id="bcfb0-362">Update the LocalHost Port Number in the PayPal Class</span></span>

<span data-ttu-id="bcfb0-363">Пример приложения Wingtip Toys осуществляет закупку такой продукции, перейдите на сайте тестирования PayPal и возврат в локальном экземпляре Wingtip Toys образца приложения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-363">The Wingtip Toys sample application purchases products by navigating to the PayPal testing site and returning to your local instance of the Wingtip Toys sample application.</span></span> <span data-ttu-id="bcfb0-364">Чтобы вернуться на правильный URL-адрес PayPal, необходимо указать номер порта локально запущенных образец приложения в коде PayPal, упомянутых выше.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-364">In order to have PayPal return to the correct URL, you need to specify the port number of the locally running sample application in the PayPal code mentioned above.</span></span>

1. <span data-ttu-id="bcfb0-365">Щелкните правой кнопкой мыши имя проекта (**WingtipToys**) в **обозревателе решений** и выберите **свойства**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-365">Right-click the project name (**WingtipToys**) in **Solution Explorer** and select **Properties**.</span></span>
2. <span data-ttu-id="bcfb0-366">В левом столбце, выберите **Web** вкладки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-366">In the left column, select the **Web** tab.</span></span>
3. <span data-ttu-id="bcfb0-367">Получить номер порта от **URL-адрес проекта** поле.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-367">Retrieve the port number from the **Project Url** box.</span></span>
4. <span data-ttu-id="bcfb0-368">При необходимости обновите `returnURL` и `cancelURL` в классе PayPal (`NVPAPICaller`) в *PayPalFunctions.cs* файл, используемый номер порта веб-приложения:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-368">If needed, update the `returnURL` and `cancelURL` in the PayPal class (`NVPAPICaller`) in the *PayPalFunctions.cs* file to use the port number of your web application:</span></span>   

    [!code-html[Main](checkout-and-payment-with-paypal/samples/sample15.html?highlight=1-2)]

<span data-ttu-id="bcfb0-369">Теперь код, который вы добавили будет соответствовать ожидаемой порт для локального веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-369">Now the code that you added will match the expected port for your local Web application.</span></span> <span data-ttu-id="bcfb0-370">PayPal будет иметь возможность вернуться на правильный URL-адрес, на локальном компьютере.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-370">PayPal will be able to return to the correct URL on your local machine.</span></span>

### <a name="add-the-paypal-checkout-button"></a><span data-ttu-id="bcfb0-371">Добавьте кнопку PayPal извлечения</span><span class="sxs-lookup"><span data-stu-id="bcfb0-371">Add the PayPal Checkout Button</span></span>

<span data-ttu-id="bcfb0-372">Теперь, когда основными функциями PayPal были добавлены в пример приложения, можно начать добавлять разметку и код, необходимый для вызова этих функций.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-372">Now that the primary PayPal functions have been added to the sample application, you can begin adding the markup and code needed to call these functions.</span></span> <span data-ttu-id="bcfb0-373">Во-первых нужно добавить кнопку извлечения, пользователь увидит на странице корзину для покупок.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-373">First, you must add the checkout button that the user will see on the shopping cart page.</span></span>

1. <span data-ttu-id="bcfb0-374">Откройте *ShoppingCart.aspx* файла.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-374">Open the *ShoppingCart.aspx* file.</span></span>
2. <span data-ttu-id="bcfb0-375">Прокрутите файл вниз и найдите `<!--Checkout Placeholder -->` комментарий.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-375">Scroll to the bottom of the file and find the `<!--Checkout Placeholder -->` comment.</span></span>
3. <span data-ttu-id="bcfb0-376">Замените комментарий с `ImageButton` управления разметки заменяется следующим образом:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-376">Replace the comment with an `ImageButton` control so that the mark up is replaced as follows:</span></span>  

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample16.aspx)]
4. <span data-ttu-id="bcfb0-377">В *ShoppingCart.aspx.cs* файла после `UpdateBtn_Click` добавить обработчик событий в конце файла, `CheckOutBtn_Click` обработчик событий:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-377">In the *ShoppingCart.aspx.cs* file, after the `UpdateBtn_Click` event handler near the end of the file, add the `CheckOutBtn_Click` event handler:</span></span>  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample17.cs)]
5. <span data-ttu-id="bcfb0-378">Кроме того, в *ShoppingCart.aspx.cs* файл, добавьте ссылку на `CheckoutBtn`, после чего кнопки «изображение» указывается следующим образом:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-378">Also in the *ShoppingCart.aspx.cs* file, add a reference to the `CheckoutBtn`, so that the new image button is referenced as follows:</span></span>  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample18.cs?highlight=18)]
6. <span data-ttu-id="bcfb0-379">Сохраните изменения в оба *ShoppingCart.aspx* файла и *ShoppingCart.aspx.cs* файла.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-379">Save your changes to both the *ShoppingCart.aspx* file and the *ShoppingCart.aspx.cs* file.</span></span>
7. <span data-ttu-id="bcfb0-380">В меню выберите **отладки**-&gt;**построения WingtipToys**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-380">From the menu, select **Debug**-&gt;**Build WingtipToys**.</span></span>  
   <span data-ttu-id="bcfb0-381">Проект будет перестроен с только что добавленном **ImageButton** элемента управления.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-381">The project will be rebuilt with the newly added **ImageButton** control.</span></span>

### <a name="send-purchase-details-to-paypal"></a><span data-ttu-id="bcfb0-382">Отправить сведения о покупке PayPal</span><span class="sxs-lookup"><span data-stu-id="bcfb0-382">Send Purchase Details to PayPal</span></span>

<span data-ttu-id="bcfb0-383">Когда пользователь щелкает **извлечение** кнопку на странице корзину покупок (*ShoppingCart.aspx*), они начнут процесса покупки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-383">When the user clicks the **Checkout** button on the shopping cart page (*ShoppingCart.aspx*), they'll begin the purchase process.</span></span> <span data-ttu-id="bcfb0-384">В следующем коде вызывается первая функция PayPal, необходимые для покупки продуктов.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-384">The following code calls the first PayPal function needed to purchase products.</span></span>

1. <span data-ttu-id="bcfb0-385">Из *извлечение* папку, откройте файл кода с именем *CheckoutStart.aspx.cs*.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-385">From the *Checkout* folder, open the code-behind file named *CheckoutStart.aspx.cs*.</span></span>   
   <span data-ttu-id="bcfb0-386">Убедитесь, что в файле кода.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-386">Be sure to open the code-behind file.</span></span>
2. <span data-ttu-id="bcfb0-387">Замените существующий код следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-387">Replace the existing code with the following:</span></span>   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample19.cs)]

<span data-ttu-id="bcfb0-388">При щелчке приложения **извлечение** кнопку на странице покупательской корзины, браузер переходит к *CheckoutStart.aspx* страницы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-388">When the user of the application clicks the **Checkout** button on the shopping cart page, the browser will navigate to the *CheckoutStart.aspx* page.</span></span> <span data-ttu-id="bcfb0-389">Когда *CheckoutStart.aspx* страницы загрузок, `ShortcutExpressCheckout` вызывается метод.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-389">When the *CheckoutStart.aspx* page loads, the `ShortcutExpressCheckout` method is called.</span></span> <span data-ttu-id="bcfb0-390">На этом этапе пользователь перемещается PayPal тестирования веб-сайта.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-390">At this point, the user is transferred to the PayPal testing web site.</span></span> <span data-ttu-id="bcfb0-391">На веб-сайте PayPal пользователь вводит свои учетные данные PayPal, анализирует сведения о покупке, принимает соглашение PayPal и возвращает в пример приложения Wingtip Toys где `ShortcutExpressCheckout` метод завершения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-391">On the PayPal site, the user enters their PayPal credentials, reviews the purchase details, accepts the PayPal agreement and returns to the Wingtip Toys sample application where the `ShortcutExpressCheckout` method completes.</span></span> <span data-ttu-id="bcfb0-392">Когда `ShortcutExpressCheckout` метод завершения, он будет перенаправлять пользователя для *CheckoutReview.aspx* страницу, указанную в `ShortcutExpressCheckout` метод.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-392">When the `ShortcutExpressCheckout` method is complete, it will redirect the user to the *CheckoutReview.aspx* page specified in the `ShortcutExpressCheckout` method.</span></span> <span data-ttu-id="bcfb0-393">Это позволяет просмотреть сведения о заказе из образца приложения Wingtip Toys.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-393">This allows the user to review the order details from within the Wingtip Toys sample application.</span></span>

### <a name="review-order-details"></a><span data-ttu-id="bcfb0-394">Просмотрите сведения о заказе</span><span class="sxs-lookup"><span data-stu-id="bcfb0-394">Review Order Details</span></span>

<span data-ttu-id="bcfb0-395">После возвращения из PayPal, *CheckoutReview.aspx* страница примера приложения Wingtip Toys отображает сведения о заказе.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-395">After returning from PayPal, the *CheckoutReview.aspx* page of the Wingtip Toys sample application displays the order details.</span></span> <span data-ttu-id="bcfb0-396">Эта страница позволяет просмотреть сведения о заказе перед покупкой продуктов.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-396">This page allows the user to review the order details before purchasing the products.</span></span> <span data-ttu-id="bcfb0-397">*CheckoutReview.aspx* страницы должны создаваться следующим образом:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-397">The *CheckoutReview.aspx* page must be created as follows:</span></span>

1. <span data-ttu-id="bcfb0-398">В *извлечение* папку, откройте страницу с именем *CheckoutReview.aspx*.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-398">In the *Checkout* folder, open the page named *CheckoutReview.aspx*.</span></span>
2. <span data-ttu-id="bcfb0-399">Замените существующую разметку следующей:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-399">Replace the existing markup with the following:</span></span>   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample20.aspx)]
3. <span data-ttu-id="bcfb0-400">Откройте страницу кода с именем *CheckoutReview.aspx.cs* и замените существующий код следующим:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-400">Open the code-behind page named *CheckoutReview.aspx.cs* and replace the existing code with the following:</span></span>   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample21.cs)]

<span data-ttu-id="bcfb0-401">**DetailsView** управления используется для отображения сведений о заказе, которые были возвращены из PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-401">The **DetailsView** control is used to display the order details that have been returned from PayPal.</span></span> <span data-ttu-id="bcfb0-402">Кроме того, приведенный выше код сохраняет сведения о заказе в базе данных Wingtip Toys как `OrderDetail` объект.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-402">Also, the above code saves the order details to the Wingtip Toys database as an `OrderDetail` object.</span></span> <span data-ttu-id="bcfb0-403">Когда пользователь нажимает на **заказ полностью** кнопка, он перенаправляется на *CheckoutComplete.aspx* страницы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-403">When the user clicks on the **Complete Order** button, they are redirected to the *CheckoutComplete.aspx* page.</span></span>

> [!NOTE] 
> 
> <span data-ttu-id="bcfb0-404">**Совет**</span><span class="sxs-lookup"><span data-stu-id="bcfb0-404">**Tip**</span></span>
> 
> <span data-ttu-id="bcfb0-405">В разметке *CheckoutReview.aspx* Обратите внимание, что `<ItemStyle>` тег используется для изменения стиля элементов внутри **DetailsView** элемента управления в нижней части страницы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-405">In the markup of the *CheckoutReview.aspx* page, notice that the `<ItemStyle>` tag is used to change the style of the items within the **DetailsView** control near the bottom of the page.</span></span> <span data-ttu-id="bcfb0-406">Просмотрев страницу в **представление конструктора** (выбрав **разработки** в левом нижнем углу Visual Studio), выбрав **DetailsView** управления и выбрав  **Смарт-тег** (значок со стрелкой в верхней правой части элемента управления), вы сможете получить **задачи DetailsView**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-406">By viewing the page in **Design View** (by selecting **Design** at the lower left corner of Visual Studio), then selecting the **DetailsView** control, and selecting the **Smart Tag** (the arrow icon at the top right of the control), you will be able to see the **DetailsView Tasks**.</span></span>
> 
> ![Извлечение и оплаты с PayPal - изменить поля](checkout-and-payment-with-paypal/_static/image18.png)
> 
> <span data-ttu-id="bcfb0-408">Выбрав **изменить поля**, **поля** появится диалоговое окно.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-408">By selecting **Edit Fields**, the **Fields** dialog box will appear.</span></span> <span data-ttu-id="bcfb0-409">В этом окне можно легко управлять визуальных свойств, таких как **ItemStyle**, из **DetailsView** элемента управления.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-409">In this dialog box you can easily control the visual properties, such as **ItemStyle**, of the **DetailsView** control.</span></span>
> 
> ![Извлечение и оплаты с PayPal - поля диалогового окна](checkout-and-payment-with-paypal/_static/image19.png)


### <a name="complete-purchase"></a><span data-ttu-id="bcfb0-411">Завершить покупку</span><span class="sxs-lookup"><span data-stu-id="bcfb0-411">Complete Purchase</span></span>

<span data-ttu-id="bcfb0-412">*CheckoutComplete.aspx* страницы, совершает покупку PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-412">*CheckoutComplete.aspx* page makes the purchase from PayPal.</span></span> <span data-ttu-id="bcfb0-413">Как упоминалось выше, пользователь должен щелкнуть **заказ полностью** кнопку, прежде чем приложение будет переходить к *CheckoutComplete.aspx* страницы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-413">As mentioned above, the user must click on the **Complete Order** button before the application will navigate to the *CheckoutComplete.aspx* page.</span></span>

1. <span data-ttu-id="bcfb0-414">В *извлечение* папку, откройте страницу с именем *CheckoutComplete.aspx*.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-414">In the *Checkout* folder, open the page named *CheckoutComplete.aspx*.</span></span>
2. <span data-ttu-id="bcfb0-415">Замените существующую разметку следующей:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-415">Replace the existing markup with the following:</span></span>   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample22.aspx)]
3. <span data-ttu-id="bcfb0-416">Откройте страницу кода с именем *CheckoutComplete.aspx.cs* и замените существующий код следующим:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-416">Open the code-behind page named *CheckoutComplete.aspx.cs* and replace the existing code with the following:</span></span>   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample23.cs)]

<span data-ttu-id="bcfb0-417">Когда *CheckoutComplete.aspx* загрузки страницы `DoCheckoutPayment` вызывается метод.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-417">When the *CheckoutComplete.aspx* page is loaded, the `DoCheckoutPayment` method is called.</span></span> <span data-ttu-id="bcfb0-418">Как упоминалось ранее, `DoCheckoutPayment` метод завершения покупки из среды тестирования PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-418">As mentioned earlier, the `DoCheckoutPayment` method completes the purchase from the PayPal testing environment.</span></span> <span data-ttu-id="bcfb0-419">После завершения покупки заказа, PayPal *CheckoutComplete.aspx* страница отображает операции платежа `ID` по закупкам.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-419">Once PayPal has completed the purchase of the order, the *CheckoutComplete.aspx* page displays a payment transaction `ID` to the purchaser.</span></span>

### <a name="handle-cancel-purchase"></a><span data-ttu-id="bcfb0-420">Маркер отмены покупки</span><span class="sxs-lookup"><span data-stu-id="bcfb0-420">Handle Cancel Purchase</span></span>

<span data-ttu-id="bcfb0-421">Если пользователь решит отменить ее, они направляется *CheckoutCancel.aspx* страницы, где они будут видеть отмену их порядок.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-421">If the user decides to cancel the purchase, they will be directed to the *CheckoutCancel.aspx* page where they will see that their order has been cancelled.</span></span>

1. <span data-ttu-id="bcfb0-422">Перейти к странице с именем *CheckoutCancel.aspx* в *извлечение* папки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-422">Open the page named *CheckoutCancel.aspx* in the *Checkout* folder.</span></span>
2. <span data-ttu-id="bcfb0-423">Замените существующую разметку следующей:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-423">Replace the existing markup with the following:</span></span>   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample24.aspx)]

### <a name="handle-purchase-errors"></a><span data-ttu-id="bcfb0-424">Обработка ошибок покупки</span><span class="sxs-lookup"><span data-stu-id="bcfb0-424">Handle Purchase Errors</span></span>

<span data-ttu-id="bcfb0-425">Ошибки в процессе покупки будет обрабатываться *CheckoutError.aspx* страницы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-425">Errors during the purchase process will be handled by the *CheckoutError.aspx* page.</span></span> <span data-ttu-id="bcfb0-426">Код программной части *CheckoutStart.aspx* страницы, *CheckoutReview.aspx* страницы и *CheckoutComplete.aspx* каждой страницы перенаправляются на  *CheckoutError.aspx* страницы при возникновении ошибки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-426">The code-behind of the *CheckoutStart.aspx* page, the *CheckoutReview.aspx* page, and the *CheckoutComplete.aspx* page will each redirect to the *CheckoutError.aspx* page if an error occurs.</span></span>

1. <span data-ttu-id="bcfb0-427">Перейти к странице с именем *CheckoutError.aspx* в *извлечение* папки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-427">Open the page named *CheckoutError.aspx* in the *Checkout* folder.</span></span>
2. <span data-ttu-id="bcfb0-428">Замените существующую разметку следующей:</span><span class="sxs-lookup"><span data-stu-id="bcfb0-428">Replace the existing markup with the following:</span></span>   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample25.aspx)]

<span data-ttu-id="bcfb0-429">*CheckoutError.aspx* -страница с описанием ошибки при возникновении ошибки во время процесса извлечения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-429">The *CheckoutError.aspx* page is displayed with the error details when an error occurs during the checkout process.</span></span>

## <a name="running-the-application"></a><span data-ttu-id="bcfb0-430">Запуск приложения</span><span class="sxs-lookup"><span data-stu-id="bcfb0-430">Running the Application</span></span>

<span data-ttu-id="bcfb0-431">Запустите приложение, чтобы узнать, как для покупки продуктов.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-431">Run the application to see how to purchase products.</span></span> <span data-ttu-id="bcfb0-432">Обратите внимание, что вы будете запускать в PayPal тестовой среде.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-432">Note that you will be running in the PayPal testing environment.</span></span> <span data-ttu-id="bcfb0-433">Без фактического денег заменяется.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-433">No actual money is being exchanged.</span></span>

1. <span data-ttu-id="bcfb0-434">Убедитесь, что все файлы сохраняются в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-434">Make sure all your files are saved in Visual Studio.</span></span>
2. <span data-ttu-id="bcfb0-435">Откройте веб-браузер и перейдите к [ https://developer.paypal.com ](https://developer.paypal.com/).</span><span class="sxs-lookup"><span data-stu-id="bcfb0-435">Open a Web browser and navigate to [https://developer.paypal.com](https://developer.paypal.com/).</span></span>
3. <span data-ttu-id="bcfb0-436">Выполните вход с учетной записью разработчика PayPal, созданный ранее в этом учебнике.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-436">Login with your PayPal developer account that you created earlier in this tutorial.</span></span>  
   <span data-ttu-id="bcfb0-437">Для "песочницы" в PayPal разработчика, необходимо входить в систему во [ https://developer.paypal.com ](https://developer.paypal.com/) для тестирования express извлечения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-437">For PayPal's developer sandbox, you need to be logged in at [https://developer.paypal.com](https://developer.paypal.com/) to test express checkout.</span></span> <span data-ttu-id="bcfb0-438">Это относится только к "песочнице" PayPal тестирование, а не в реальной среде PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-438">This only applies to PayPal's sandbox testing, not to PayPal's live environment.</span></span>
4. <span data-ttu-id="bcfb0-439">В Visual Studio нажмите клавишу **F5** для запуска образца приложения Wingtip Toys.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-439">In Visual Studio, press **F5** to run the Wingtip Toys sample application.</span></span>  
   <span data-ttu-id="bcfb0-440">После перестроения базы данных, обозреватель и Показать *Default.aspx* страницы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-440">After the database rebuilds, the browser will open and show the *Default.aspx* page.</span></span>
5. <span data-ttu-id="bcfb0-441">Добавление трех различных продуктов в корзину покупок, при выборе категории продукта, например «Автомобили» и выбрав **добавить в тележку для закупок** рядом с каждого продукта.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-441">Add three different products to the shopping cart by selecting the product category, such as "Cars" and then clicking **Add to Cart** next to each product.</span></span>  
   <span data-ttu-id="bcfb0-442">Список покупок отобразит продукта, которые вы выбрали.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-442">The shopping cart will display the product you have selected.</span></span>
6. <span data-ttu-id="bcfb0-443">Нажмите кнопку **PayPal** кнопку для извлечения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-443">Click the **PayPal** button to checkout.</span></span> 

    ![Извлечение и оплаты с PayPal - корзину](checkout-and-payment-with-paypal/_static/image20.png)

   <span data-ttu-id="bcfb0-445">Извлечение требуют наличия учетной записи пользователя для образца приложения Wingtip Toys.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-445">Checking out will require that you have a user account for the Wingtip Toys sample application.</span></span>
7. <span data-ttu-id="bcfb0-446">Нажмите кнопку **Google** ссылки в правой части страницы, чтобы войти с использованием существующей учетной записи электронной почты gmail.com.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-446">Click the **Google** link on the right of the page to log in with an existing gmail.com email account.</span></span>  
   <span data-ttu-id="bcfb0-447">Если у вас учетной записи gmail.com, можно создать одну для тестирования на [www.gmail.com](https://www.gmail.com/). Также можно использовать стандартную учетную запись локального, нажав кнопку «Регистрация».</span><span class="sxs-lookup"><span data-stu-id="bcfb0-447">If you do not have a gmail.com account, you can create one for testing purposes at [www.gmail.com](https://www.gmail.com/). You can also use a standard local account by clicking "Register".</span></span> 

    ![Извлечение и оплаты с PayPal - вход](checkout-and-payment-with-paypal/_static/image21.png)
8. <span data-ttu-id="bcfb0-449">Войдите, используя учетную запись gmail и пароль.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-449">Sign in with your gmail account and password.</span></span> 

    ![Извлечение и оплаты с PayPal - Gmail вход](checkout-and-payment-with-paypal/_static/image22.png)
9. <span data-ttu-id="bcfb0-451">Нажмите кнопку **входа** кнопку, чтобы зарегистрировать учетную запись gmail с вашим именем пользователя Wingtip Toys образца приложения.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-451">Click the **Log in** button to register your gmail account with your Wingtip Toys sample application user name.</span></span> 

    ![Извлечение и оплаты с PayPal - Регистрация учетной записи](checkout-and-payment-with-paypal/_static/image23.png)
10. <span data-ttu-id="bcfb0-453">На сайте тестирования PayPal, добавьте к **покупатель** электронной почты адрес и пароль, созданный ранее в этом учебнике, а затем нажмите кнопку **входа в** кнопки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-453">On the PayPal test site, add your **buyer** email address and password that you created earlier in this tutorial, then click the **Log In** button.</span></span> 

    ![Извлечение и оплаты с PayPal - PayPal вход](checkout-and-payment-with-paypal/_static/image24.png)
11. <span data-ttu-id="bcfb0-455">Согласиться с политикой PayPal и нажмите кнопку **принимаю и продолжить** кнопки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-455">Agree to the PayPal policy and click the **Agree and Continue** button.</span></span>  
    <span data-ttu-id="bcfb0-456">Обратите внимание, что эта страница только отображается при первом использовании этой учетной записи PayPal.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-456">Note that this page is only displayed the first time you use this PayPal account.</span></span> <span data-ttu-id="bcfb0-457">Снова Обратите внимание, что это учетная запись тестового обмен не реальными money.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-457">Again note that this is a test account, no real money is exchanged.</span></span> 

    ![Извлечение и оплаты с PayPal - PayPal политики](checkout-and-payment-with-paypal/_static/image25.png)
12. <span data-ttu-id="bcfb0-459">Просмотрите сведения о заказе на PayPal тестирования среды страница «Просмотр» и нажмите кнопку **Продолжить**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-459">Review the order information on the PayPal testing environment review page and click **Continue**.</span></span> 

    ![Извлечение и оплаты с PayPal - проверка сведений](checkout-and-payment-with-paypal/_static/image26.png)
13. <span data-ttu-id="bcfb0-461">На *CheckoutReview.aspx* проверьте сумма заказа и просмотреть адрес созданного доставки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-461">On the *CheckoutReview.aspx* page, verify the order amount and view the generated shipping address.</span></span> <span data-ttu-id="bcfb0-462">Нажмите кнопку **заказ полностью** кнопки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-462">Then, click the **Complete Order** button.</span></span> 

    ![Извлечение и оплаты с PayPal - проверки заказа](checkout-and-payment-with-paypal/_static/image27.png)
14. <span data-ttu-id="bcfb0-464">**CheckoutComplete.aspx** откроется страница с идентификатором транзакции оплаты.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-464">The **CheckoutComplete.aspx** page is displayed with a payment transaction ID.</span></span> 

    ![Извлечение и оплаты с PayPal - Извлечение завершено](checkout-and-payment-with-paypal/_static/image28.png)

<a id="ReviewDBWebForms"></a>
## <a name="reviewing-the-database"></a><span data-ttu-id="bcfb0-466">Просмотр базы данных</span><span class="sxs-lookup"><span data-stu-id="bcfb0-466">Reviewing the Database</span></span>

<span data-ttu-id="bcfb0-467">Просмотрев обновлять данные в образце базы данных приложения Wingtip Toys после запуска приложения, можно определить, что приложение успешно записаны покупки продуктов.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-467">By reviewing the updated data in the Wingtip Toys sample application database after running the application, you can see that the application successfully recorded the purchase of the products.</span></span>

<span data-ttu-id="bcfb0-468">Можно проверять данные, содержащиеся в *Wingtiptoys.mdf* файл базы данных с помощью **обозреватель баз данных** окна (**обозревателя серверов** окна в Visual Studio) так же, как ранее в этой серии учебника.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-468">You can inspect the data contained in the *Wingtiptoys.mdf* database file by using the **Database Explorer** window (**Server Explorer** window in Visual Studio) as you did earlier in this tutorial series.</span></span>

1. <span data-ttu-id="bcfb0-469">Закройте окно браузера, если он еще открыт.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-469">Close the browser window if it is still open.</span></span>
2. <span data-ttu-id="bcfb0-470">В Visual Studio, выберите **Показать все файлы** значок в верхней части **обозревателе решений** позволяет развернуть **приложения\_данные** папки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-470">In Visual Studio, select the **Show All Files** icon at the top of **Solution Explorer** to allow you to expand the **App\_Data** folder.</span></span>
3. <span data-ttu-id="bcfb0-471">Разверните **приложения\_данные** папки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-471">Expand the **App\_Data** folder.</span></span>  
 <span data-ttu-id="bcfb0-472">Необходимо выбрать **Показать все файлы** значок папки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-472">You may need to select the **Show All Files** icon for the folder.</span></span>
4. <span data-ttu-id="bcfb0-473">Щелкните правой кнопкой мыши *Wingtiptoys.mdf* файл базы данных и выберите **откройте**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-473">Right-click the *Wingtiptoys.mdf* database file and select **Open**.</span></span>  
    <span data-ttu-id="bcfb0-474">**Обозреватель серверов** отображается.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-474">**Server Explorer** is displayed.</span></span>
5. <span data-ttu-id="bcfb0-475">Разверните **таблиц** папки.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-475">Expand the **Tables** folder.</span></span>
6. <span data-ttu-id="bcfb0-476">Щелкните правой кнопкой мыши **заказов**таблицы и выберите **Показать таблицу данных**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-476">Right-click the **Orders**table and select **Show Table Data**.</span></span>  
 <span data-ttu-id="bcfb0-477">**Заказов** таблица будет отображена.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-477">The **Orders** table is displayed.</span></span>
7. <span data-ttu-id="bcfb0-478">Просмотрите **PaymentTransactionID** подтверждает успешное транзакции.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-478">Review the **PaymentTransactionID** column to confirm successful transactions.</span></span> 

    ![Извлечение и оплаты с PayPal - проверка базы данных](checkout-and-payment-with-paypal/_static/image29.png)
8. <span data-ttu-id="bcfb0-480">Закрыть **заказов** окно таблицы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-480">Close the **Orders** table window.</span></span>
9. <span data-ttu-id="bcfb0-481">В обозревателе сервера щелкните правой кнопкой мыши **OrderDetails** таблицы и выберите **Показать таблицу данных**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-481">In the Server Explorer, right-click the **OrderDetails** table and select **Show Table Data**.</span></span>
10. <span data-ttu-id="bcfb0-482">Просмотрите `OrderId` и `Username` значения в **OrderDetails** таблицы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-482">Review the `OrderId` and `Username` values in the **OrderDetails** table.</span></span> <span data-ttu-id="bcfb0-483">Обратите внимание, что эти значения соответствуют `OrderId` и `Username` значений, включенных в **заказов** таблицы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-483">Note that these values match the `OrderId` and `Username` values included in the **Orders** table.</span></span>
11. <span data-ttu-id="bcfb0-484">Закрыть **OrderDetails** окно таблицы.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-484">Close the **OrderDetails** table window.</span></span>
12. <span data-ttu-id="bcfb0-485">Щелкните правой кнопкой мыши файл базы данных Wingtip Toys (*Wingtiptoys.mdf*) и выберите **закрыть соединение**.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-485">Right-click the Wingtip Toys database file (*Wingtiptoys.mdf*) and select **Close Connection**.</span></span>
13. <span data-ttu-id="bcfb0-486">Если вы не видите **обозревателе решений** окно, нажмите кнопку **обозревателе решений** в нижней части **обозревателя серверов** окно для отображения **обозревателе решений**  еще раз.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-486">If you do not see the **Solution Explorer** window, click **Solution Explorer** at the bottom of the **Server Explorer** window to show the **Solution Explorer** again.</span></span>

## <a name="summary"></a><span data-ttu-id="bcfb0-487">Сводка</span><span class="sxs-lookup"><span data-stu-id="bcfb0-487">Summary</span></span>

<span data-ttu-id="bcfb0-488">В этом учебнике вы добавили заказа и порядок сведений схемы для отслеживания покупки продуктов.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-488">In this tutorial you added order and order detail schemas to track the purchase of products.</span></span> <span data-ttu-id="bcfb0-489">Функциональные возможности PayPal также интегрируется в пример приложения Wingtip Toys.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-489">You also integrated PayPal functionality into the Wingtip Toys sample application.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="bcfb0-490">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="bcfb0-490">Additional Resources</span></span>

<span data-ttu-id="bcfb0-491">[Общие сведения о конфигурации ASP.NET](https://msdn.microsoft.com/library/ms178683(v=vs.100).aspx)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-491">[ASP.NET Configuration Overview](https://msdn.microsoft.com/library/ms178683(v=vs.100).aspx)</span></span>  
[<span data-ttu-id="bcfb0-492">Развертывание приложения безопасного ASP.NET Web Forms членства, OAuth и базы данных SQL в службе приложений Azure</span><span class="sxs-lookup"><span data-stu-id="bcfb0-492">Deploy a Secure ASP.NET Web Forms App with Membership, OAuth, and SQL Database to Azure App Service</span></span>](https://azure.microsoft.com/documentation/articles/web-sites-dotnet-deploy-aspnet-webforms-app-membership-oauth-sql-database/)  
[<span data-ttu-id="bcfb0-493">Microsoft Azure — бесплатная пробная версия</span><span class="sxs-lookup"><span data-stu-id="bcfb0-493">Microsoft Azure - Free Trial</span></span>](https://azure.microsoft.com/pricing/free-trial/)

## <a name="disclaimer"></a><span data-ttu-id="bcfb0-494">Отказ от ответственности</span><span class="sxs-lookup"><span data-stu-id="bcfb0-494">Disclaimer</span></span>

<span data-ttu-id="bcfb0-495">Этот учебник содержит пример кода.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-495">This tutorial contains sample code.</span></span> <span data-ttu-id="bcfb0-496">Такой образец кода предоставляется «как есть» без гарантий любого рода.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-496">Such sample code is provided "as is" without warranty of any kind.</span></span> <span data-ttu-id="bcfb0-497">Соответственно Microsoft не гарантирует точность, целостность или качество в образце кода.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-497">Accordingly, Microsoft does not guarantee the accuracy, integrity, or quality of the sample code.</span></span> <span data-ttu-id="bcfb0-498">Вы соглашаетесь использовать образец кода на свой страх и риск.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-498">You agree to use the sample code at your own risk.</span></span> <span data-ttu-id="bcfb0-499">Ни при каких условиях будет корпорация Майкрософт не несут ответственности вам каким-либо образом любой пример кода, содержимое, включая, помимо прочего, любые ошибки или пропуски в любой пример кода, содержимое, любой потери или повреждения любого рода, выполненным в результате использования любой образец кода.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-499">Under no circumstances will Microsoft be liable to you in any way for any sample code, content, including but not limited to, any errors or omissions in any sample code, content, or any loss or damage of any kind incurred as a result of the use of any sample code.</span></span> <span data-ttu-id="bcfb0-500">Настоящим уведомление и настоящим обязуетесь компенсировать, сохранить и исков Microsoft по из и связанные с потерей всех, утверждений потери, травмы или повреждения любого вида числе, среди прочего, occasioned по или поступающие из материала, учет, передачи, используйте или зависит от того, включая, помимо прочего, мнения, содержащиеся в нем.</span><span class="sxs-lookup"><span data-stu-id="bcfb0-500">You are hereby notified and do hereby agree to indemnify, save and hold Microsoft harmless from and against any and all loss, claims of loss, injury or damage of any kind including, without limitation, those occasioned by or arising from material that you post, transmit, use or rely on including, but not limited to, the views expressed therein.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="bcfb0-501">[Назад](shopping-cart.md)
> [Вперед](membership-and-administration.md)</span><span class="sxs-lookup"><span data-stu-id="bcfb0-501">[Previous](shopping-cart.md)
[Next](membership-and-administration.md)</span></span>

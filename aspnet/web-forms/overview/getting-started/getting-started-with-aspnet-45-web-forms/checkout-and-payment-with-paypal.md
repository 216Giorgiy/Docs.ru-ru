---
uid: web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal
title: "Извлечение и оплаты с PayPal | Документы Microsoft"
author: Erikre
description: "Этот учебник ряд описываются основы построения приложения веб-форм ASP.NET с помощью ASP.NET 4.5 и Microsoft Visual Studio Express 2013 для мы..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 09/08/2014
ms.topic: article
ms.assetid: 664ec95e-b0c9-4f43-a39f-798d0f2a7e08
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/getting-started/getting-started-with-aspnet-45-web-forms/checkout-and-payment-with-paypal
msc.type: authoredcontent
ms.openlocfilehash: dd975850a3ed3e7b1746d5123572065675a88656
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/10/2017
---
<a name="checkout-and-payment-with-paypal"></a>Извлечение и оплаты с PayPal
====================
По [Эрик Reitan](https://github.com/Erikre)

[Загрузите образец проекта Wingtip Toys (C#)](http://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) или [загрузить электронную (PDF)](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20ASP.NET%204.5%20Web%20Forms%20and%20Visual%20Studio%202013.pdf)

> Этот учебник ряд описываются основы построения с помощью ASP.NET 4.5 и Microsoft Visual Studio Express 2013 для веб-приложения веб-форм ASP.NET. Visual Studio 2013 [проект с исходным кодом C#](https://go.microsoft.com/fwlink/?LinkID=389434&clcid=0x409) доступен по следующему этого учебника ряда.


Этот учебник описывает изменение Wingtip Toys образец приложения для включения авторизации пользователей, регистрация и платежей, с помощью PayPal. Только пользователи, выполнившие вход будет авторизации для покупки продуктов. Функциональные возможности регистрации встроенный в пользовательский шаблон проекта веб-форм ASP.NET 4.5 уже содержит большую часть необходимых. Добавляются функции извлечения Express PayPal. В этом учебнике вы используете тестировании среде, поэтому будут передаваться без фактического средств разработчика PayPal. В конце учебника будет тестирование приложения путем выбора продуктов, чтобы добавить в корзину, нажмите кнопку извлечения и передаче данных в PayPal тестирования веб-сайта. На веб-сайте тестирования PayPal будет подтвердите свои сведения доставки "и" Оплата ", а затем вернитесь в локальном пример приложения Wingtip Toys для подтверждения и завершения покупки.

Имеется несколько процессоров опытным оплаты сторонних разработчиков, специализирующихся на покупок в сети, адрес масштабируемости и безопасности. Разработчики ASP.NET следует учитывать преимущества использования решения сторонних разработчиков оплаты до реализации покупок и приобретения решения.

> [!NOTE] 
> 
> Пример приложения Wingtip Toys была разработана для показано определенные понятия ASP.NET и возможностях, доступных разработчикам веб-страниц ASP.NET. В этом образце приложения не была оптимизирована для всех возможных случаях отношении масштабируемости и безопасности.


## <a name="what-youll-learn"></a>Что вы узнаете следующее.

- Как ограничить доступ на отдельные страницы в папке.
- Инструкции по созданию известных корзины из анонимного корзины.
- Как включить SSL для проекта.
- Инструкции по добавлению поставщика OAuth в проект.
- Инструкции по использованию PayPal приобретать продукцию, с помощью среды тестирования PayPal.
- Способ отображения сведений из PayPal в **DetailsView** элемента управления.
- Как обновить базу данных приложения Wingtip Toys сведения, полученные из PayPal.

## <a name="adding-order-tracking"></a>Добавление трассировка заказа

В этом учебнике вы создадите два новых класса, чтобы отслеживать данные от порядка создания пользователя. Классы будет отслеживать данные, касающиеся сведения о доставке, всего покупки и подтверждение оплаты.

### <a name="add-the-order-and-orderdetail-model-classes"></a>Добавление заказа и классы OrderDetail модели

Ранее в данной серии учебных курсов определенные схемы для категорий продуктов, и элементы покупательской корзины, создав `Category`, `Product`, и `CartItem` классы в *моделей* папки. Теперь добавим две новые классы для определения схемы для заказа продукта и сведения о заказе.

1. В **моделей** папки, добавьте новый класс с именем *Order.cs*.   
 В редакторе отображается новый файл класса.
2. Замените код по умолчанию следующим:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample1.cs)]
3. Добавить *OrderDetail.cs* класса *моделей* папки.
4. Замените код по умолчанию следующим кодом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample2.cs)]

`Order` И `OrderDetail` классы содержат схему для определения порядка сведения, используемые для покупки и доставки.

Кроме того необходимо обновить класс контекста базы данных, управляющий классы сущностей и предоставляющий доступ к базе данных. Для этого необходимо добавить только что созданного заказа и `OrderDetail` классов для модели `ProductContext` класса.

1. В **обозревателе решений**, найдите и откройте *ProductContext.cs* файла.
2. Добавьте код, выделенный для *ProductContext.cs* файла, как показано ниже:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample3.cs?highlight=14-15)]

Как упоминалось ранее в данной серии учебных курсов, код в *ProductContext.cs* добавляет файл `System.Data.Entity` пространства имен, чтобы получить доступ к основным функциям платформы Entity Framework. Эта функция включает в себя возможность запроса, вставки, обновления и удаления данных при работе со строго типизированных объектов. Приведенный выше код в `ProductContext` класс добавляет Entity Framework доступа к недавно добавленному `Order` и `OrderDetail` классы.

## <a name="adding-checkout-access"></a>Добавление доступа извлечения

Пример приложения Wingtip Toys позволяет анонимным пользователям для просмотра и добавляют продукты в корзину для покупок. Тем не менее если анонимные пользователи покупать продукты, в котором они добавлены в корзину покупок, их необходимо войти на сайт. Вошедшим в систему, они могут обращаться к страницы с ограниченным доступом веб-приложения, которые обрабатывают извлечение и приобрести процесса. Эти страницы с ограниченным доступом, содержащиеся в *извлечение* папке приложения.

### <a name="add-a-checkout-folder-and-pages"></a>Добавление папки извлечения и страниц

Теперь вы создадите *извлечение* папки и страниц в нем, которое будут видеть клиента во время процесса извлечения. Далее в этом учебнике, потребуется обновить эти страницы.

1. Щелкните правой кнопкой мыши имя проекта (**Wingtip Toys**) в **обозревателе решений** и выберите **добавьте новую папку**. 

    ![Извлечение и оплаты с PayPal - новая папка](checkout-and-payment-with-paypal/_static/image1.png)
2. Имя новой папки *извлечения*.
3. Щелкните правой кнопкой мыши *извлечение* папки, а затем выберите **добавить**-&gt;**новый элемент**. 

    ![Извлечение и оплаты с PayPal - новый элемент](checkout-and-payment-with-paypal/_static/image2.png)
4. Откроется диалоговое окно **Добавление нового элемента**.
5. Выберите **Visual C#**  - &gt; **Web** группа шаблонов в левой части экрана. Затем в средней области выберите **веб-форма с главной страницы**и назовите его *CheckoutStart.aspx*. 

    ![Извлечение и оплаты с PayPal - новое диалоговое окно добавления элемента](checkout-and-payment-with-paypal/_static/image3.png)
6. Как и ранее, выберите *Site.Master* файл в качестве главной страницы.
7. Добавьте следующие дополнительные страницы для *извлечение* папки, используя те же шаги:   

    - CheckoutReview.aspx
    - CheckoutComplete.aspx
    - CheckoutCancel.aspx
    - CheckoutError.aspx

### <a name="add-a-webconfig-file"></a>Добавьте файл Web.config

Путем добавления нового *Web.config* файл *извлечение* папку, вы сможете для ограничения доступа ко всем страницам, содержащиеся в папке.

1. Щелкните правой кнопкой мыши *извлечение* папку и выберите **добавить**  - &gt; **новый элемент**.  
 Откроется диалоговое окно **Добавление нового элемента**.
2. Выберите **Visual C#**  - &gt; **Web** группа шаблонов в левой части экрана. Затем в средней области выберите **файл веб-конфигурации**, примите имя по умолчанию *Web.config*, а затем выберите **добавить**.
3. Замена существующего содержимого в XML *Web.config* файл со следующим:  

    [!code-xml[Main](checkout-and-payment-with-paypal/samples/sample4.xml)]
4. Сохранить *Web.config* файла.

*Web.config* файл указывает, что все неизвестные пользователи веб-приложения должен быть доступ к страницам, содержащихся в *извлечение* папки. Тем не менее, если пользователь зарегистрировал учетную запись и войти в систему, они будут известного пользователя и будет иметь доступ к страницам в *извлечение* папки.

Это важно отметить, что конфигурация ASP.NET следует иерархии, где каждый *Web.config* файл применяет параметры конфигурации в папку, в которой он находится и всех его дочерних каталогов.

<a id="SSLWebForms"></a>
## <a name="enable-ssl-for-the-project"></a>Включить SSL для проекта

 Secure Sockets Layer (SSL) — это протокол, допускают веб-серверов и веб-клиентами для более безопасного обмена данными с помощью шифрования. Если SSL не используется, данные, которыми обмениваются клиент и сервер доступен для пакетов сканирование любой пользователь, имеющий физический доступ к сети. Кроме того некоторые распространенные схемы проверки подлинности не являются безопасными через простой HTTP. В частности Обычная проверка подлинности и проверки подлинности форм отправлять незашифрованные учетные данные. Для обеспечения безопасности, эти схемы проверки подлинности, необходимо использовать SSL. 

1. В **обозревателе решений**, нажмите кнопку **WingtipToys** проекта, а затем нажмите клавишу **F4** для отображения **свойства** окна.
2. Изменение **включен протокол SSL** для `true`.
3. Копировать **URL-адрес SSL** , его можно использовать в дальнейшем.   
 URL-адрес SSL будет `https://localhost:44300/` Если вы ранее создали веб-сайтов SSL (как показано ниже).   
    ![Свойства проекта](checkout-and-payment-with-paypal/_static/image4.png)
4. В **обозревателе решений**, щелкните правой кнопкой мыши **WingtipToys** проекта и нажмите кнопку **свойства**.
5. На левой вкладке нажмите кнопку **Web**.
6. Изменение **URL-адрес проекта** использовать **URL-адрес SSL** сохраненный ранее.   
    ![Веб-свойства проекта](checkout-and-payment-with-paypal/_static/image5.png)
7. Сохраните страницу, нажав клавишу **CTRL + S**.
8. Нажмите клавишу **Ctrl + F5** для запуска приложения. Visual Studio будет отображать параметр позволяет избежать появления предупреждений SSL.
9. Нажмите кнопку **Да** доверять сертификату IIS Express SSL и продолжить работу.   
    ![Сведения о сертификате IIS Express SSL](checkout-and-payment-with-paypal/_static/image6.png)  
 Отображается предупреждение системы безопасности.
10. Нажмите кнопку **Да** установите сертификат для вашего localhost.   
    ![Предупреждение системы безопасности-диалоговое окно](checkout-and-payment-with-paypal/_static/image7.png)  
 Откроется окно браузера.

Теперь можно легко проверить веб-приложения локально с помощью SSL.

<a id="OAuthWebForms"></a>
## <a name="add-an-oauth-20-provider"></a>Добавьте поставщик OAuth 2.0

Веб-форм ASP.NET предоставляет улучшенные параметры для проверки подлинности и членства. Эти улучшения включают OAuth. OAuth это открытый протокол, позволяющий авторизации для безопасности в простой и стандартный метод из Интернета, мобильных и настольных приложений. Шаблон веб-форм ASP.NET использует OAuth для предоставления Facebook, Twitter, Google и корпорации Майкрософт, как поставщики проверки подлинности. Несмотря на то, что в этом учебнике используется только Google как поставщик проверки подлинности, можно легко изменить код, чтобы использовать любого поставщика. Шаги по реализации другие поставщики очень похожи на шаги, которые можно найти в этом учебнике.

Кроме проверки подлинности учебник также использовать роли для реализации авторизации. Только пользователи, добавьте к `canEdit` роли, смогут выполнять изменение данных (Создание, изменение или удаление контактов).

> [!NOTE] 
> 
> Приложений Windows Live могут принимать только динамическую URL-адрес для работающего веб-сайта, поэтому нельзя использовать URL-адрес локального веб-сайта для тестирования имен входа.


Следующие шаги позволит вам добавить поставщик проверки подлинности Google.

1. Откройте *приложения\_Start\Startup.Auth.cs* файла.
2. Удалите символы комментария из `app.UseGoogleAuthentication()` выполняет, чтобы метод представлен как следующие: 

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample5.cs)]
3. Перейдите к [Google Developers Console](https://console.developers.google.com/). Также необходимо будет выполнить вход с учетной записью электронной почты разработчика Google (gmail.com). Если у вас учетной записи Google, выберите **создать учетную запись** ссылку.   
 Далее вы увидите **Google Developers Console**.   
    ![Google Developers Console](checkout-and-payment-with-paypal/_static/image8.png)
4. Нажмите кнопку **Создание проекта** и введите имя проекта и ID (можно использовать значения по умолчанию). Нажмите кнопку **флажок соглашение** и **создать** кнопки.  

    ![Google - новый проект](checkout-and-payment-with-paypal/_static/image9.png)

 Через несколько секунд будет создан новый проект, и ваш браузер будет отображаться новая страница проектов.
5. На левой вкладке нажмите кнопку **API-интерфейсы &amp; auth**, а затем нажмите кнопку **учетные данные**.
6. Нажмите кнопку **создать новый идентификатор клиента** под **OAuth**.   
 **Создать идентификатор клиента** откроется диалоговое окно.   
    ![Google - создать идентификатор клиента](checkout-and-payment-with-paypal/_static/image10.png)
7. В **создать идентификатор клиента** диалоговое окно, оставьте значение по умолчанию **веб-приложение** для типа приложения.
8. Задать **Authorized JavaScript Origins** URL-адрес SSL, использованные ранее в этом учебнике (`https://localhost:44300/` Если вы создали проекты SSL).   
 Этот URL-адрес является источником для вашего приложения. Для этого примера будет только введите URL-адрес localhost теста. Тем не менее можно ввести несколько URL-адресов с учетом localhost и производства.
9. Задать **авторизации URI перенаправления** следующее: 

    [!code-html[Main](checkout-and-payment-with-paypal/samples/sample6.html)]

 Это значение представляет собой URI, ASP.NET OAuth пользователям взаимодействовать с сервером google OAuth. Помните, приведенном выше URL-адрес SSL ( `https://localhost:44300/` Если вы создали проекты SSL).
10. Нажмите кнопку **создать идентификатор клиента** кнопки.
11. В левом меню Google Developers Console, нажмите кнопку **экран согласия** пункта меню, задайте адрес и продукта имени электронной почты. После завершения формы щелкните **Сохранить**.
12. Нажмите кнопку **API-интерфейсы** пункт меню, прокрутите вниз и нажмите кнопку **off** рядом с **API Google +**.   
 Этот параметр принимает включит API Google +.
13. Необходимо также обновить **Microsoft.Owin** пакет NuGet версии 3.0.0.   
 Из **средства** последовательно выберите пункты **диспетчера пакетов NuGet** , а затем выберите **управление пакетами NuGet для решения**.  
 Из **управление пакетами NuGet** окна, найдите и обновление **Microsoft.Owin** пакет до версии 3.0.0.
14. В Visual Studio обновить `UseGoogleAuthentication` метод *Startup.Auth.cs* страницы путем копирования и вставки **идентификатор клиента** и **секрет клиента** в метод. **Идентификатор клиента** и **секрет клиента** значений, приведенных ниже примеров и не будет работать. 

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample7.cs?highlight=64-65)]
15. Нажмите клавишу **CTRL + F5** для построения и запуска приложения. Нажмите кнопку **входа** ссылку.
16. В разделе **используется другой службой для входа в**, нажмите кнопку **Google**.  
    ![Войти](checkout-and-payment-with-paypal/_static/image11.png)
17. Если вам нужно ввести учетные данные, вы будете перенаправлены на сайт google, можно будет ввести учетные данные.  
    ![Google - входа](checkout-and-payment-with-paypal/_static/image12.png)
18. После ввода учетных данных, будет предложено предоставить разрешения для только что созданной веб-приложения.  
    ![Учетная запись службы по умолчанию для проекта](checkout-and-payment-with-paypal/_static/image13.png)
19. Нажмите кнопку **принимать**. Вам будут перенаправляться к **зарегистрировать** страница **WingtipToys** приложения, где можно зарегистрировать учетную запись Google.  
    ![Зарегистрировать учетную запись Google](checkout-and-payment-with-paypal/_static/image14.png)
20. Вы можете изменить имя локальной электронной почты регистрации, используемое для свою учетную запись Gmail, но обычно требуется сохранить псевдоним электронной почты по умолчанию (один используется для проверки подлинности). Нажмите кнопку **входа** как показано выше.

### <a name="modifying-login-functionality"></a>Изменение функции входа в систему

Как описано ранее в этой серии учебника большинство функций регистрации пользователя был включен в шаблоне веб-форм ASP.NET по умолчанию. Теперь предстоит изменить значение по умолчанию *Login.aspx* и *Register.aspx* страниц для вызова `MigrateCart` метод. `MigrateCart` Метод связывает вновь вошедшего в систему пользователя с анонимной корзины. Путем сопоставления пользователя и Корзина для покупок, будет доступно ведение покупательской корзине пользователя между посещений пример приложения Wingtip Toys.

1. В **обозревателе решений**, найдите и откройте *учетной записи* папки.
2. Изменение кода страницы с именем *Login.aspx.cs* необходимо выделены желтым цветом, код, чтобы он выглядит следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample8.cs?highlight=41-43)]
3. Сохранить *Login.aspx.cs* файла.

Теперь можно пропустить это предупреждение, которое отсутствует определение для `MigrateCart` метод. Будет добавлен его чуть позже в этом учебнике.

*Login.aspx.cs* файл кода программной части поддерживает метод входа. Проверив на страницу Login.aspx, вы увидите, что эта страница отображается кнопка «Вход», если щелкните триггеры `LogIn` обработчиком для кода.

Когда `Login` метод *Login.aspx.cs* вызывается новый экземпляр покупательской корзине с именем `usersShoppingCart` создается. Идентификатор (GUID) покупательской корзине извлекается и присвоено `cartId` переменной. Затем `MigrateCart` вызывается метод, передав оба `cartId` и имя пользователя вошедшего в систему с этим методом. При миграции покупательской корзины, идентификатор GUID, используемый для идентификации анонимных покупательской корзине заменяется имя пользователя.

В дополнение к изменению *Login.aspx.cs* файл кода для переноса в корзину для покупок, при входе пользователя, необходимо также изменить *файл кода программной части Register.aspx.cs* для переноса в корзину для покупок Когда пользователь создает новую учетную запись и выполнить вход.

1. В *учетной записи* папку, откройте файл кода с именем *Register.aspx.cs*.
2. Измените файл кода путем включения кода желтым цветом, так, чтобы он выглядит следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample9.cs?highlight=28-32)]
3. Сохранить *Register.aspx.cs* файла. Опять же, пропустить это предупреждение о `MigrateCart` метод.

Обратите внимание, что код, который использовался в `CreateUser_Click` обработчик событий очень похож на код, используемый в `LogIn` метод. Когда пользователь регистрирует или входе на сайт, вызов `MigrateCart` метод будут внесены.

## <a name="migrating-the-shopping-cart"></a>Миграция в корзину для покупок

Теперь, когда процесс входа в систему "и" Регистрация обновления можно добавить код для переноса в корзину для покупок с помощью `MigrateCart` метод.

1. В **обозревателе решений**, найти *логику* папку *ShoppingCartActions.cs* файл класса.
2. Добавьте код, выделены желтым цветом, позволяя существующий код в *ShoppingCartActions.cs* файл, чтобы код в *ShoppingCartActions.cs* файл отображается следующим образом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample10.cs?highlight=215-224)]

`MigrateCart` Метод использует существующие cartId для поиска в корзину пользователя. Затем код просматривает все корзину покупок и заменяет `CartId` свойства (как указано в `CartItem` схемы) с именем пользователя, выполнившего вход.

### <a name="updating-the-database-connection"></a>Обновление подключения к базе данных

Если вы следуете данного учебника с помощью **готовых** Wingtip Toys образец приложения, необходимо повторно создать базу данных членства по умолчанию. Изменив строку соединения по умолчанию, база данных членства будут создаваться при следующем запуске приложения.

1. Откройте *Web.config* файл в корневой папке проекта.
2. Обновляет строку подключения по умолчанию, выглядит следующим образом.   

    [!code-xml[Main](checkout-and-payment-with-paypal/samples/sample11.xml)]

<a id="PayPalWebForms"></a>
## <a name="integrating-paypal"></a>Интеграция PayPal

PayPal — веб-платформа выставления счетов, которая принимает платежи с Интернет-магазины. Далее в этом руководстве рассматривается интегрировать функциональные возможности извлечения Express PayPal в приложении. Извлечение Express позволяет пользователям использовать PayPal для оплаты для элементов, которые они добавлены их в корзину.

### <a name="create-paylpal-test-accounts"></a>Создание тестовых PaylPal учетных записей

Чтобы использовать PayPal, в тестовой среде, необходимо создать и проверить тестовую учетную запись разработчика. Для создания покупатель тестовой учетной записи и продавца тестовую учетную запись будет использовать тестовую учетную запись разработчика. Тестовые учетные данные учетной записи разработчика также позволит Wingtip Toys образец приложения для доступа к тестовой среде PayPal.

1. В браузере перейдите к разработчику PayPal проверка узла:   
    [https://Developer.PayPal.com](https://developer.paypal.com/)
2. При отсутствии учетной записи разработчика PayPal, создайте новую учетную запись, щелкнув **зарегистрироваться**и после регистрации действия. При наличии существующей учетной записи разработчика PayPal вход, щелкнув **входа в**. Вам потребуется учетной записи разработчика PayPal тестирование Wingtip Toys образца приложения далее в этом учебнике.
3. Если вы только что зарегистрированы для учетной записи разработчика PayPal, может потребоваться проверить вашу учетную запись разработчика PayPal с PayPal. Вы можете проверить вашей учетной записи, выполните действия, которые PayPal отправить электронную почту. После проверки учетной записи разработчика PayPal войти обратно в PayPal developer проверки узла.
4. Вы вошли в систему на сайте разработчика PayPal, с учетной записью разработчика PayPal, что необходимо создать тестовую учетную запись PayPal покупатель при отсутствии уже после одного. Для создания покупатель тестовую учетную запись, при щелчке узла PayPal **приложений** и нажмите кнопку **учетные записи "песочницы"**.   
 **Тестовые учетные записи "песочницы"** показана страница.   

    > [!NOTE] 
    > 
    > Сайт разработчиков PayPal уже предоставляет коммерческий тестовую учетную запись.

    ![Извлечение и оплаты с PayPal - тестовые учетные записи "песочницы"](checkout-and-payment-with-paypal/_static/image15.png)
5. На странице "песочницы" учетные записи теста выберите **Создание учетной записи**.
6. На **создать тестовую учетную запись** выберите покупатель тестовое сообщение электронной почты учетной записи и пароль по вашему выбору.   

    > [!NOTE] 
    > 
    > Необходимо будет покупатель адреса электронной почты и пароль для проверки примера приложения Wingtip Toys в конце этого учебника.

    ![Извлечение и оплаты с PayPal - тестовые учетные записи "песочницы"](checkout-and-payment-with-paypal/_static/image16.png)
7. Создать тестовую учетную запись покупатель, нажав кнопку **Создание учетной записи** кнопки.  
 **"Песочницы" тестовые учетные записи** -страница. 

    ![Извлечение и оплаты с PayPal - PaylPal учетных записей](checkout-and-payment-with-paypal/_static/image17.png)
8. На **тестовые учетные записи "песочницы"** щелкните **организатора** учетную запись электронной почты.  
    **Профиль** и **уведомления** отображаются параметры.
9. Выберите **профиль** параметр, а затем нажмите кнопку **учетные данные API** для просмотра API учетные данные для учетной записи коммерческий тест.
10. Копирует API ТЕСТОВ учетные данные в текстовом формате.

Требуется отображаемое классический API тестирования учетные данные (имя пользователя, пароль и подпись) для выполнения вызовов API из образца приложения Wingtip Toys PayPal, в тестовой среде. В следующем шаге вы добавите учетные данные.

### <a name="add-paypal-class-and-api-credentials"></a>Добавьте класс PayPal и учетные данные API

Поместите большая часть кода PayPal в один класс. Этот класс содержит методы, используемые для взаимодействия с PayPal. Кроме того вы добавите PayPal учетных данных к этому классу.

1. В образце приложения Wingtip Toys в среде Visual Studio, щелкните правой кнопкой мыши **логику** папки, а затем выберите **добавить**  - &gt; **новый элемент**.   
 Откроется диалоговое окно **Добавление нового элемента**.
2. В разделе **Visual C#** из **установленные** панели слева выберите **кода**.
3. В средней области выберите **класса**. Назовите этот новый класс **PayPalFunctions.cs**.
4. Нажмите кнопку **Добавить**.  
 В редакторе отображается новый файл класса.
5. Замените код по умолчанию следующим кодом:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample12.cs)]
6. Добавьте Merchant API учетные данные (имя пользователя, пароль и подписи), отображаются ранее в этом учебнике, чтобы вы могли принимать вызовы функций в среде тестирования PayPal.  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample13.cs)]

> [!NOTE] 
> 
> В этом образце приложения просто добавляя учетные данные в файле C# (CS-файл). Тем не менее реализованного решения, следует шифровать учетные данные в файле конфигурации.


Класс NVPAPICaller содержит большую часть функций PayPal. Код в класс предоставляет методы, необходимые для проверки на покупку из среды тестирования PayPal. Чтобы делать покупки используются следующие функции PayPal:

- `SetExpressCheckout`функция
- `GetExpressCheckoutDetails`функция
- `DoExpressCheckoutPayment`функция

`ShortcutExpressCheckout` Метод теста и сведения о покупке собирает из корзины и вызывает `SetExpressCheckout` функция PayPal. `GetCheckoutDetails` Метод подтверждает сведения о покупке и вызовы `GetExpressCheckoutDetails` функция PayPal перед выполнением теста покупки. `DoCheckoutPayment` Метод завершения покупки тестов из среды тестирования путем вызова `DoExpressCheckoutPayment` функция PayPal. Остальная часть кода поддерживает методы PayPal и процессе, например кодирование строк, декодирования строк, обработка массивов и определение учетных данных.

> [!NOTE] 
> 
> PayPal позволяет включать сведения о покупке необязательно, на основе [спецификации API в PayPal](https://cms.paypal.com/us/cgi-bin/?cmd=_render-content&amp;content_ID=developer/e_howto_api_nvp_r_SetExpressCheckout). При расширении кода в примере приложения Wingtip Toys, может включать сведения о локализации, описаниях продукта, налогов, номер клиента службы, а также другие необязательные поля.


Обратите внимание, что возвращаемое значение и Отмена URL-адреса, указанные в **ShortcutExpressCheckout** в методе используется номер порта.

[!code-html[Main](checkout-and-payment-with-paypal/samples/sample14.html)]

При Visual Web Developer запускает веб-проекта, с помощью протокола SSL, обычно порт 44300 используется для веб-сервера. Как показано выше, номер порта — 44300. При запуске приложения, можно просмотреть другой номер порта. Вашей порт номер необходимо правильно задать в коде, чтобы пользователь мог успешно запустить образец приложения Wingtip Toys в конце этого учебника. В следующем разделе этого учебника показано, как получить номер порта локальный узел и обновить класс PayPal.

### <a name="update-the-localhost-port-number-in-the-paypal-class"></a>Обновление номера порта LocalHost в классе PayPal

Пример приложения Wingtip Toys осуществляет закупку такой продукции, перейдите на сайте тестирования PayPal и возврат в локальном экземпляре Wingtip Toys образца приложения. Чтобы вернуться на правильный URL-адрес PayPal, необходимо указать номер порта локально запущенных образец приложения в коде PayPal, упомянутых выше.

1. Щелкните правой кнопкой мыши имя проекта (**WingtipToys**) в **обозревателе решений** и выберите **свойства**.
2. В левом столбце, выберите **Web** вкладки.
3. Получить номер порта от **URL-адрес проекта** поле.
4. При необходимости обновите `returnURL` и `cancelURL` в классе PayPal (`NVPAPICaller`) в *PayPalFunctions.cs* файл, используемый номер порта веб-приложения:   

    [!code-html[Main](checkout-and-payment-with-paypal/samples/sample15.html?highlight=1-2)]

Теперь код, который вы добавили будет соответствовать ожидаемой порт для локального веб-приложения. PayPal будет иметь возможность вернуться на правильный URL-адрес, на локальном компьютере.

### <a name="add-the-paypal-checkout-button"></a>Добавьте кнопку PayPal извлечения

Теперь, когда основными функциями PayPal были добавлены в пример приложения, можно начать добавлять разметку и код, необходимый для вызова этих функций. Во-первых нужно добавить кнопку извлечения, пользователь увидит на странице корзину для покупок.

1. Откройте *ShoppingCart.aspx* файла.
2. Прокрутите файл вниз и найдите `<!--Checkout Placeholder -->` комментарий.
3. Замените комментарий с `ImageButton` управления разметки заменяется следующим образом:  

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample16.aspx)]
4. В *ShoppingCart.aspx.cs* файла после `UpdateBtn_Click` добавить обработчик событий в конце файла, `CheckOutBtn_Click` обработчик событий:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample17.cs)]
5. Кроме того, в *ShoppingCart.aspx.cs* файл, добавьте ссылку на `CheckoutBtn`, после чего кнопки «изображение» указывается следующим образом:  

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample18.cs?highlight=18)]
6. Сохраните изменения в оба *ShoppingCart.aspx* файла и *ShoppingCart.aspx.cs* файла.
7. В меню выберите **отладки**-&gt;**построения WingtipToys**.  
 Проект будет перестроен с только что добавленном **ImageButton** элемента управления.

### <a name="send-purchase-details-to-paypal"></a>Отправить сведения о покупке PayPal

Когда пользователь щелкает **извлечение** кнопку на странице корзину покупок (*ShoppingCart.aspx*), они начнут процесса покупки. В следующем коде вызывается первая функция PayPal, необходимые для покупки продуктов.

1. Из *извлечение* папку, откройте файл кода с именем *CheckoutStart.aspx.cs*.   
 Убедитесь, что в файле кода.
2. Замените существующий код следующим кодом:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample19.cs)]

При щелчке приложения **извлечение** кнопку на странице покупательской корзины, браузер переходит к *CheckoutStart.aspx* страницы. Когда *CheckoutStart.aspx* страницы загрузок, `ShortcutExpressCheckout` вызывается метод. На этом этапе пользователь перемещается PayPal тестирования веб-сайта. На веб-сайте PayPal пользователь вводит свои учетные данные PayPal, анализирует сведения о покупке, принимает соглашение PayPal и возвращает в пример приложения Wingtip Toys где `ShortcutExpressCheckout` метод завершения. Когда `ShortcutExpressCheckout` метод завершения, он будет перенаправлять пользователя для *CheckoutReview.aspx* страницу, указанную в `ShortcutExpressCheckout` метод. Это позволяет просмотреть сведения о заказе из образца приложения Wingtip Toys.

### <a name="review-order-details"></a>Просмотрите сведения о заказе

После возвращения из PayPal, *CheckoutReview.aspx* страница примера приложения Wingtip Toys отображает сведения о заказе. Эта страница позволяет просмотреть сведения о заказе перед покупкой продуктов. *CheckoutReview.aspx* страницы должны создаваться следующим образом:

1. В *извлечение* папку, откройте страницу с именем *CheckoutReview.aspx*.
2. Замените существующую разметку следующей:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample20.aspx)]
3. Откройте страницу кода с именем *CheckoutReview.aspx.cs* и замените существующий код следующим:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample21.cs)]

**DetailsView** управления используется для отображения сведений о заказе, которые были возвращены из PayPal. Кроме того, приведенный выше код сохраняет сведения о заказе в базе данных Wingtip Toys как `OrderDetail` объект. Когда пользователь нажимает на **заказ полностью** кнопка, он перенаправляется на *CheckoutComplete.aspx* страницы.

> [!NOTE] 
> 
> **Совет**
> 
> В разметке *CheckoutReview.aspx* Обратите внимание, что `<ItemStyle>` тег используется для изменения стиля элементов внутри **DetailsView** элемента управления в нижней части страницы. Просмотрев страницу в **представление конструктора** (выбрав **разработки** в левом нижнем углу Visual Studio), выбрав **DetailsView** управления и выбрав  **Смарт-тег** (значок со стрелкой в верхней правой части элемента управления), вы сможете получить **задачи DetailsView**.
> 
> ![Извлечение и оплаты с PayPal - изменить поля](checkout-and-payment-with-paypal/_static/image18.png)
> 
> Выбрав **изменить поля**, **поля** появится диалоговое окно. В этом окне можно легко управлять визуальных свойств, таких как **ItemStyle**, из **DetailsView** элемента управления.
> 
> ![Извлечение и оплаты с PayPal - поля диалогового окна](checkout-and-payment-with-paypal/_static/image19.png)


### <a name="complete-purchase"></a>Завершить покупку

*CheckoutComplete.aspx* страницы, совершает покупку PayPal. Как упоминалось выше, пользователь должен щелкнуть **заказ полностью** кнопку, прежде чем приложение будет переходить к *CheckoutComplete.aspx* страницы.

1. В *извлечение* папку, откройте страницу с именем *CheckoutComplete.aspx*.
2. Замените существующую разметку следующей:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample22.aspx)]
3. Откройте страницу кода с именем *CheckoutComplete.aspx.cs* и замените существующий код следующим:   

    [!code-csharp[Main](checkout-and-payment-with-paypal/samples/sample23.cs)]

Когда *CheckoutComplete.aspx* загрузки страницы `DoCheckoutPayment` вызывается метод. Как упоминалось ранее, `DoCheckoutPayment` метод завершения покупки из среды тестирования PayPal. После завершения покупки заказа, PayPal *CheckoutComplete.aspx* страница отображает операции платежа `ID` по закупкам.

### <a name="handle-cancel-purchase"></a>Маркер отмены покупки

Если пользователь решит отменить ее, они направляется *CheckoutCancel.aspx* страницы, где они будут видеть отмену их порядок.

1. Перейти к странице с именем *CheckoutCancel.aspx* в *извлечение* папки.
2. Замените существующую разметку следующей:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample24.aspx)]

### <a name="handle-purchase-errors"></a>Обработка ошибок покупки

Ошибки в процессе покупки будет обрабатываться *CheckoutError.aspx* страницы. Код программной части *CheckoutStart.aspx* страницы, *CheckoutReview.aspx* страницы и *CheckoutComplete.aspx* каждой страницы перенаправляются на  *CheckoutError.aspx* страницы при возникновении ошибки.

1. Перейти к странице с именем *CheckoutError.aspx* в *извлечение* папки.
2. Замените существующую разметку следующей:   

    [!code-aspx[Main](checkout-and-payment-with-paypal/samples/sample25.aspx)]

*CheckoutError.aspx* -страница с описанием ошибки при возникновении ошибки во время процесса извлечения.

## <a name="running-the-application"></a>Запуск приложения

Запустите приложение, чтобы узнать, как для покупки продуктов. Обратите внимание, что вы будете запускать в PayPal тестовой среде. Без фактического денег заменяется.

1. Убедитесь, что все файлы сохраняются в Visual Studio.
2. Откройте веб-браузер и перейдите к [https://developer.paypal.com](https://developer.paypal.com/).
3. Выполните вход с учетной записью разработчика PayPal, созданный ранее в этом учебнике.  
 Для "песочницы" в PayPal разработчика, необходимо входить в систему во [https://developer.paypal.com](https://developer.paypal.com/) для тестирования express извлечения. Это относится только к "песочнице" PayPal тестирование, а не в реальной среде PayPal.
4. В Visual Studio нажмите клавишу **F5** для запуска образца приложения Wingtip Toys.  
 После перестроения базы данных, обозреватель и Показать *Default.aspx* страницы.
5. Добавление трех различных продуктов в корзину покупок, при выборе категории продукта, например «Автомобили» и выбрав **добавить в тележку для закупок** рядом с каждого продукта.  
 Список покупок отобразит продукта, которые вы выбрали.
6. Нажмите кнопку **PayPal** кнопку для извлечения. 

    ![Извлечение и оплаты с PayPal - корзину](checkout-and-payment-with-paypal/_static/image20.png)

 Извлечение требуют наличия учетной записи пользователя для образца приложения Wingtip Toys.
7. Нажмите кнопку **Google** ссылки в правой части страницы, чтобы войти с использованием существующей учетной записи электронной почты gmail.com.  
 Если у вас учетной записи gmail.com, можно создать одну для тестирования на [www.gmail.com](https://www.gmail.com/). Также можно использовать стандартную учетную запись локального, нажав кнопку «Регистрация». 

    ![Извлечение и оплаты с PayPal - вход](checkout-and-payment-with-paypal/_static/image21.png)
8. Войдите, используя учетную запись gmail и пароль. 

    ![Извлечение и оплаты с PayPal - Gmail вход](checkout-and-payment-with-paypal/_static/image22.png)
9. Нажмите кнопку **входа** кнопку, чтобы зарегистрировать учетную запись gmail с вашим именем пользователя Wingtip Toys образца приложения. 

    ![Извлечение и оплаты с PayPal - Регистрация учетной записи](checkout-and-payment-with-paypal/_static/image23.png)
10. На сайте тестирования PayPal, добавьте к **покупатель** электронной почты адрес и пароль, созданный ранее в этом учебнике, а затем нажмите кнопку **входа в** кнопки. 

    ![Извлечение и оплаты с PayPal - PayPal вход](checkout-and-payment-with-paypal/_static/image24.png)
11. Согласиться с политикой PayPal и нажмите кнопку **принимаю и продолжить** кнопки.  
 Обратите внимание, что эта страница только отображается при первом использовании этой учетной записи PayPal. Снова Обратите внимание, что это учетная запись тестового обмен не реальными money. 

    ![Извлечение и оплаты с PayPal - PayPal политики](checkout-and-payment-with-paypal/_static/image25.png)
12. Просмотрите сведения о заказе на PayPal тестирования среды страница «Просмотр» и нажмите кнопку **Продолжить**. 

    ![Извлечение и оплаты с PayPal - проверка сведений](checkout-and-payment-with-paypal/_static/image26.png)
13. На *CheckoutReview.aspx* проверьте сумма заказа и просмотреть адрес созданного доставки. Нажмите кнопку **заказ полностью** кнопки. 

    ![Извлечение и оплаты с PayPal - проверки заказа](checkout-and-payment-with-paypal/_static/image27.png)
14. **CheckoutComplete.aspx** откроется страница с идентификатором транзакции оплаты. 

    ![Извлечение и оплаты с PayPal - Извлечение завершено](checkout-and-payment-with-paypal/_static/image28.png)

<a id="ReviewDBWebForms"></a>
## <a name="reviewing-the-database"></a>Просмотр базы данных

Просмотрев обновлять данные в образце базы данных приложения Wingtip Toys после запуска приложения, можно определить, что приложение успешно записаны покупки продуктов.

Можно проверять данные, содержащиеся в *Wingtiptoys.mdf* файл базы данных с помощью **обозреватель баз данных** окна (**обозревателя серверов** окна в Visual Studio) так же, как ранее в этой серии учебника.

1. Закройте окно браузера, если он еще открыт.
2. В Visual Studio, выберите **Показать все файлы** значок в верхней части **обозревателе решений** позволяет развернуть **приложения\_данные** папки.
3. Разверните **приложения\_данные** папки.  
 Необходимо выбрать **Показать все файлы** значок папки.
4. Щелкните правой кнопкой мыши *Wingtiptoys.mdf* файл базы данных и выберите **откройте**.  
    **Обозреватель серверов** отображается.
5. Разверните **таблиц** папки.
6. Щелкните правой кнопкой мыши **заказов**таблицы и выберите **Показать таблицу данных**.  
 **Заказов** таблица будет отображена.
7. Просмотрите **PaymentTransactionID** подтверждает успешное транзакции. 

    ![Извлечение и оплаты с PayPal - проверка базы данных](checkout-and-payment-with-paypal/_static/image29.png)
8. Закрыть **заказов** окно таблицы.
9. В обозревателе сервера щелкните правой кнопкой мыши **OrderDetails** таблицы и выберите **Показать таблицу данных**.
10. Просмотрите `OrderId` и `Username` значения в **OrderDetails** таблицы. Обратите внимание, что эти значения соответствуют `OrderId` и `Username` значений, включенных в **заказов** таблицы.
11. Закрыть **OrderDetails** окно таблицы.
12. Щелкните правой кнопкой мыши файл базы данных Wingtip Toys (*Wingtiptoys.mdf*) и выберите **закрыть соединение**.
13. Если вы не видите **обозревателе решений** окно, нажмите кнопку **обозревателе решений** в нижней части **обозревателя серверов** окно для отображения **обозревателе решений**  еще раз.

## <a name="summary"></a>Сводка

В этом учебнике вы добавили заказа и порядок сведений схемы для отслеживания покупки продуктов. Функциональные возможности PayPal также интегрируется в пример приложения Wingtip Toys.

## <a name="additional-resources"></a>Дополнительные ресурсы

[Общие сведения о конфигурации ASP.NET](https://msdn.microsoft.com/library/ms178683(v=vs.100).aspx)  
[Развертывание приложения безопасного ASP.NET Web Forms членства, OAuth и базы данных SQL в службе приложений Azure](https://azure.microsoft.com/documentation/articles/web-sites-dotnet-deploy-aspnet-webforms-app-membership-oauth-sql-database/)  
[Microsoft Azure — бесплатная пробная версия](https://azure.microsoft.com/pricing/free-trial/)

## <a name="disclaimer"></a>Отказ от ответственности

Этот учебник содержит пример кода. Такой образец кода предоставляется «как есть» без гарантий любого рода. Соответственно Microsoft не гарантирует точность, целостность или качество в образце кода. Вы соглашаетесь использовать образец кода на свой страх и риск. Ни при каких условиях будет корпорация Майкрософт не несут ответственности вам каким-либо образом любой пример кода, содержимое, включая, помимо прочего, любые ошибки или пропуски в любой пример кода, содержимое, любой потери или повреждения любого рода, выполненным в результате использования любой образец кода. Настоящим уведомление и настоящим обязуетесь компенсировать, сохранить и исков Microsoft по из и связанные с потерей всех, утверждений потери, травмы или повреждения любого вида числе, среди прочего, occasioned по или поступающие из материала, учет, передачи, используйте или зависит от того, включая, помимо прочего, мнения, содержащиеся в нем.

>[!div class="step-by-step"]
[Назад](shopping-cart.md)
[Вперед](membership-and-administration.md)

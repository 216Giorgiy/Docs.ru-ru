---
uid: web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/performing-batch-updates-vb
title: "Выполнение пакетных обновлений (VB) | Документы Microsoft"
author: rick-anderson
description: "Сведения о создании полностью редактируемое DataList, где все его элементы находятся в режим редактирования и значения которого можно сохранить, нажав кнопку \"Обновить все\" на..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 10/30/2006
ms.topic: article
ms.assetid: 8dac22a7-91de-4e3b-888f-a4c438b03851
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/editing-and-deleting-data-through-the-datalist/performing-batch-updates-vb
msc.type: authoredcontent
ms.openlocfilehash: df22a7c4aedb5e5fef183817e9d2b1e4c4a919ee
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2018
---
<a name="performing-batch-updates-vb"></a>Выполнение пакетных обновлений (Visual Basic)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Загрузить пример приложения](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_37_VB.exe) или [скачать PDF](performing-batch-updates-vb/_static/datatutorial37vb1.pdf)

> Сведения о создании полностью редактируемое DataList, где все его элементы находятся в режим редактирования и значения которого можно сохранить, нажмите кнопку «Обновить все» на странице.


## <a name="introduction"></a>Вступление

В [предыдущего учебника](an-overview-of-editing-and-deleting-data-in-the-datalist-vb.md) мы рассмотрели, как создать DataList уровня элемента. Таким как стандартный для редактирования GridView, каждый элемент в элемент управления DataList включены изменения кнопка, при щелчке, делают элемента для редактирования. Хотя это уровня элемента редактирования подходит для данных, который обновляется только время от времени, определенных сценариев использования нужны пользователю возможность редактировать много записей. Если пользователь должен изменить десятки записей и принудительно нажмите кнопку Изменить, вносить свои изменения и нажмите кнопку обновления для каждого из них, объем щелкнув может помешать ее производительности. В такой ситуации, лучшим вариантом является необходимость полностью редактируемое DataList, где один *все* ее элементы находятся в режиме редактирования и нажав кнопку "Обновить все" на странице можно изменить, значения которых (см. рис. 1).


[![Каждый элемент в редактируемой полностью DataList могут быть изменены](performing-batch-updates-vb/_static/image2.png)](performing-batch-updates-vb/_static/image1.png)

**Рис. 1**: каждый элемент в полностью редактируемых DataList могут быть изменены ([Просмотр полноразмерное изображение](performing-batch-updates-vb/_static/image3.png))


В этом учебнике мы рассмотрим, как предоставить пользователям для обновления сведений об адресе поставщиков с помощью полностью доступно для редактирования DataList.

## <a name="step-1-create-the-editable-user-interface-in-the-datalist-s-itemtemplate"></a>Шаг 1: Создание интерфейса пользователя для редактирования в DataList s ItemTemplate

В предыдущем учебнике, где мы создание стандартной, уровне элемента для редактирования DataList, мы использовали два шаблона:

- `ItemTemplate`содержит интерфейс пользователя только для чтения (метка веб-элементы управления для отображения каждого s имя и цену продукта).
- `EditItemTemplate`содержит пользовательский интерфейс редактирования режиме (два элемента управления TextBox Web).

Элемент управления DataList s `EditItemIndex` свойство указывает, что `DataListItem` (если таковые имеются) отображается с помощью `EditItemTemplate`. В частности `DataListItem` которого `ItemIndex` значение соответствует DataList s `EditItemIndex` свойство отображается с помощью `EditItemTemplate`. Эта модель работает также в том случае, если при создании полностью редактируемое DataList можно изменить во время, но возвращается друг от друга только один элемент.

Для полностью доступно для редактирования DataList, мы хотим *все* из `DataListItem` s для подготовки к просмотру с помощью интерфейса для редактирования. Самый простой способ выполнения этой задачи является определение интерфейса для редактирования в `ItemTemplate`. Для изменения информации об адресе поставщики, редактируемые интерфейс содержит имя поставщика как текст, а затем текстовые поля для адреса, города и страны значения.

Сначала откройте `BatchUpdate.aspx` , добавьте элемент управления DataList и задайте его `ID` свойства `Suppliers`. Смарт-теге DataList s необязательно, чтобы добавить новый элемент управления ObjectDataSource `SuppliersDataSource`.


[![Создать новый элемент управления ObjectDataSource SuppliersDataSource с именем](performing-batch-updates-vb/_static/image5.png)](performing-batch-updates-vb/_static/image4.png)

**На рисунке 2**: создать новый именованный ObjectDataSource `SuppliersDataSource` ([Просмотр полноразмерное изображение](performing-batch-updates-vb/_static/image6.png))


Настройка ObjectDataSource для извлечения данных с помощью `SuppliersBLL` класса s `GetSuppliers()` метод (см. рис. 3). Как и в предыдущем учебнике, а не обновление сведений о поставщике через элемент управления ObjectDataSource, мы будем работать непосредственно с уровня бизнес-логики. Таким образом, значение раскрывающегося списка (нет) на вкладке «обновление» (см. рис. 4).


[![Получить сведения о поставщиках, с помощью метода GetSuppliers()](performing-batch-updates-vb/_static/image8.png)](performing-batch-updates-vb/_static/image7.png)

**Рис. 3**: получить поставщик сведения с помощью `GetSuppliers()` метод ([Просмотр полноразмерное изображение](performing-batch-updates-vb/_static/image9.png))


[![Значение раскрывающегося списка (нет) на вкладке «обновление»](performing-batch-updates-vb/_static/image11.png)](performing-batch-updates-vb/_static/image10.png)

**Рис. 4**: значение раскрывающегося списка (нет) на вкладке «обновление» ([Просмотр полноразмерное изображение](performing-batch-updates-vb/_static/image12.png))


По завершении работы мастера Visual Studio автоматически создает элемент управления DataList s `ItemTemplate` для отображения каждого поля данных, возвращаемых источником данных в веб-управления Label. Нам нужно изменить этот шаблон таким образом, чтобы он предоставляет интерфейс редактирования. `ItemTemplate` Можно настроить с помощью конструктора, используя параметр редактирование шаблонов смарт-теге DataList s или напрямую с помощью декларативного синтаксиса.

Теперь пора создать интерфейс редактирования, который отображает имя s поставщика в виде текста, но включает текстовые поля для поставщика s адреса, города и страны значения. После внесения этих изменений, декларативный синтаксис s страницы должен выглядеть следующим образом:


[!code-aspx[Main](performing-batch-updates-vb/samples/sample1.aspx)]

> [!NOTE]
> Как в предыдущем учебник DataList в этом учебнике должны иметь состояния просмотра включена.


В `ItemTemplate` я m, с помощью двух новых классов CSS `SupplierPropertyLabel` и `SupplierPropertyValue`, которой были добавлены к `Styles.css` класса и использует те же параметры стиля, как `ProductPropertyLabel` и `ProductPropertyValue` классов CSS.


[!code-css[Main](performing-batch-updates-vb/samples/sample2.css)]

После внесения этих изменений, посетите эту страницу через браузер. Как показано на рисунке 5, каждый элемент DataList отображает имя поставщика в виде текста и использует текстовые поля для отображения адреса, города и страны.


[![Каждый поставщик в DataList является Editable](performing-batch-updates-vb/_static/image14.png)](performing-batch-updates-vb/_static/image13.png)

**Рис. 5**: каждый поставщик в DataList является Editable ([Просмотр полноразмерное изображение](performing-batch-updates-vb/_static/image15.png))


## <a name="step-2-adding-an-update-all-button"></a>Шаг 2: Добавление, обновление все кнопки

Хотя на рисунке 5 каждый поставщик имеет его адреса, города и страны полей, отображаемых в текстовом поле, в настоящее время недоступны кнопкой "Обновить". Вместо того, кнопка обновления каждого элемента, с полностью доступно для редактирования DataLists имеется обычно одну кнопку Обновить все страницы, при щелчке обновляет *всех* записей в DataList. В этом учебнике позволяют s добавьте две обновить все кнопки - в верхней части страницы и нижней (несмотря на то, что либо кнопку будет иметь тот же эффект).

Начните с добавления кнопки веб-элемент управления DataList и набор его `ID` свойства `UpdateAll1`. Далее добавьте второй веб-управления Button под DataList, установка его `ID` для `UpdateAll2`. Задать `Text` двух кнопок, чтобы обновить все свойства. Наконец, создавать обработчики событий для обеих кнопок `Click` события. Вместо дублирования логики обновления в каждом из обработчиков событий, позволяют s рефакторинг эту логику в третий метод `UpdateAllSupplierAddresses`, наличие просто вызов этого метода третий обработчики событий.


[!code-vb[Main](performing-batch-updates-vb/samples/sample3.vb)]

Рис. 6 показана страница после обновления все кнопки будут добавлены.


[![Были добавлены два все кнопки обновления страницы](performing-batch-updates-vb/_static/image17.png)](performing-batch-updates-vb/_static/image16.png)

**Рис. 6**: были добавлены два все кнопки обновления страницы ([Просмотр полноразмерное изображение](performing-batch-updates-vb/_static/image18.png))


## <a name="step-3-updating-all-of-the-suppliers-address-information"></a>Шаг 3: Обновление всех сведений об адресе поставщиков

На все элементы s DataList отображение интерфейс редактирования и с добавлением обновления всех кнопок все, что остается написание кода для выполнения пакетного обновления. В частности, нам нужно перебор элементов DataList s и вызовите `SuppliersBLL` класса s `UpdateSupplierAddress` метод для каждого из них.

Коллекция `DataListItem` экземпляров этого состава DataList может осуществляться через DataList s [ `Items` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.datalist.items.aspx). Со ссылкой на `DataListItem`, мы можно захватить соответствующего `SupplierID` из `DataKeys` коллекции программным образом справочник и элементов управления в Интернете текстовое поле внутри `ItemTemplate` как показано в следующем коде:


[!code-vb[Main](performing-batch-updates-vb/samples/sample4.vb)]

Когда пользователь нажимает одну из кнопок все обновления, `UpdateAllSupplierAddresses` каждая итерация метод `DataListItem` в `Suppliers` DataList и вызовы `SuppliersBLL` класса s `UpdateSupplierAddress` метод, передавая соответствующие значения. Значение не введено значение для адреса, города или страны передает `Nothing` для `UpdateSupplierAddress` (а не содержит пустую строку), что приводит к базе данных `NULL` для базового поля записей s.

> [!NOTE]
> Улучшение может потребоваться добавить состояние веб-управления Label к странице, которая содержит некоторые сообщения о подтверждении после выполнения пакетного обновления.


## <a name="updating-only-those-addresses-that-have-been-modified"></a>Обновление только адреса, которые были изменены

Алгоритм обновления пакета, используемый для этого учебника вызовов `UpdateSupplierAddress` метод *каждого* поставщика в DataList, независимо от того, менялся ли их адресную информацию. Хотя такие blind обновляет упорядочивая t обычно проблемы с производительностью, они могут привести к неиспользуемых записей, если вы повторно аудит изменений в таблице базы данных. Например, если используются триггеры для записи всех `UPDATE` s, чтобы `Suppliers` таблицы в таблицу аудита, каждый раз при нажатии кнопки Обновить все новые записи аудита будет создаваться для каждого поставщика в системе, независимо от того, является ли пользователь внесла изменения.

Классы ADO.NET DataTable и DataAdapter предназначены для поддержки пакетные обновления, сохранения результатов только измененные, удаленных и новых записей в взаимодействия с базой данных. Каждая строка в объекте DataTable имеет [ `RowState` свойство](https://msdn.microsoft.com/library/system.data.datarow.rowstate.aspx) , указывающее, был добавлен в таблицу DataTable, удалены из него, изменен, или остается без изменений строки. Когда DataTable изначально заполнен, все строки помечаются без изменений. Изменение значения всех столбцов s строк при этом строка помечается как измененный.

В `SuppliersBLL` мы обновление информации об адресе указанного поставщика s путем чтения первой записи одного поставщика в класс `SuppliersDataTable` и задайте `Address`, `City`, и `Country` значения столбцов, используя следующий код:


[!code-vb[Main](performing-batch-updates-vb/samples/sample5.vb)]

Этот код просто назначает адрес переданное, города и страны значения `SuppliersRow` в `SuppliersDataTable` независимо от того, является ли изменены значения. Это вызывает `SuppliersRow` s `RowState` свойство помечается как измененный. Если s уровня доступа к данным `Update` вызывается метод, он видит, что `SupplierRow` был изменен и поэтому отправляет `UPDATE` команды в базу данных.

Представьте себе, тем не менее, этот метод только назначить переданный адрес, city и country значения, если они отличаются от добавленный код `SuppliersRow` s существующих значений. В случае адреса, города и страны в которых совпадает с существующие данные не будут изменены и `SupplierRow` s `RowState` будет помечен как остается неизменной. Конечным результатом становится, когда DAL s `Update` вызывается метод, будет сделан звонок нет базы данных, так как `SuppliersRow` не был изменен.

Для применения этого изменения, замените операторы, которые просто назначить переданное адреса, города и страны значения с помощью следующего кода:


[!code-vb[Main](performing-batch-updates-vb/samples/sample6.vb)]

С этим добавления кода, DAL s `Update` метод отправляет `UPDATE` инструкцию в базе данных только те записи, которые были изменены, значения, связанные с адресом.

Кроме того, мы может отслеживать ли различия поля переданное адреса и данных базы данных и, если их нет, просто пропустить вызов DAL s `Update` метод. Этот подход хорошо работает, если вы повторно базу данных с помощью прямой метод, так как переданный t DB прямой метод `SuppliersRow` экземпляра которого `RowState` можно проверить, чтобы определить, требуется ли вызов базы данных.

> [!NOTE]
> Каждый раз `UpdateSupplierAddress` вызывается метод, выполняется вызов для базы данных для получения сведений об обновленной записи. Затем Если в данных имеются изменения, другой в базу данных вызов для обновления строки таблицы. Этот рабочий процесс можно оптимизировать, создав `UpdateSupplierAddress` перегрузку метода, которая принимает `EmployeesDataTable` экземпляра, содержащего *все* изменений от `BatchUpdate.aspx` страницы. Затем он сделайте одно обращение к базе данных, чтобы получить все записи из `Suppliers` таблицы. Затем может быть перечислено два результирующих наборов и могут быть обновлены только те записи, где произошли изменения.


## <a name="summary"></a>Сводка

В этом учебнике мы узнали, как создать полностью доступно для редактирования DataList, позволяя пользователю быстро изменить адресную информацию для нескольких поставщиков. Мы запустили путем определения интерфейса редактирования веб-управления TextBox для поставщика s адреса, города и страны значения в DataList s `ItemTemplate`. Далее мы добавили обновление всех кнопок выше и ниже DataList. После его изменения и одну из кнопок все обновления, щелчок пользователя `DataListItem` перечисляются s и вызов `SuppliersBLL` класса s `UpdateSupplierAddress` метода.

Программирование довольны!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи ASP/ASP.NET и основателя из [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Майкрософт с 1998 года. Скотт — независимый консультант, trainer и записи. Его последняя книга — [ *диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он может быть достигнута по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Благодарности

Этот учебник ряд прошел проверку многие полезные рецензентов. Основными редакторами этого учебника были Зак Джонс и Алексей Pespisa. Объясняются моих последующих статей для MSDN? Если Да, напишите мне по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

>[!div class="step-by-step"]
[Назад](an-overview-of-editing-and-deleting-data-in-the-datalist-vb.md)
[Вперед](handling-bll-and-dal-level-exceptions-vb.md)

---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/using-parameterized-queries-with-the-sqldatasource-vb
title: "Использование параметризованных запросов в SqlDataSource (VB) | Документы Microsoft"
author: rick-anderson
description: "В этом учебнике мы продолжить внешнего вида элемента управления SqlDataSource и узнайте, как определять параметризованные запросы. Параметры могут быть заданы оба decla..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 02/20/2007
ms.topic: article
ms.assetid: e322f34c-83b7-41ea-ab65-ab1e0bdcc609
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/using-parameterized-queries-with-the-sqldatasource-vb
msc.type: authoredcontent
ms.openlocfilehash: 1a56990c87c1faa93612dcca0732ee789078dfe2
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/10/2017
---
<a name="using-parameterized-queries-with-the-sqldatasource-vb"></a>Использование параметризованных запросов в SqlDataSource (Visual Basic)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Загрузить пример приложения](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_48_VB.exe) или [скачать PDF](using-parameterized-queries-with-the-sqldatasource-vb/_static/datatutorial48vb1.pdf)

> В этом учебнике мы продолжить внешнего вида элемента управления SqlDataSource и узнайте, как определять параметризованные запросы. Значения параметров может быть задано декларативно и программно и может быть извлечено из нескольких расположений, например строку запроса, сеанс состояния, другие элементы управления и многое другое.


## <a name="introduction"></a>Вступление

В предыдущем учебнике мы узнали, как использовать элемент управления SqlDataSource для получения данных непосредственно из базы данных. С помощью мастера настройки источника данных, можно выбрать базу данных, а затем либо: выберите столбцы, возвращаемые из таблицы или представления; Введите пользовательские инструкции SQL; или используйте хранимую процедуру. Ли выбор столбцов из таблицы или представления, или ввести собственную инструкцию SQL, s управления SqlDataSource `SelectCommand` присваивается в конечном коде SQL ad-hoc `SELECT` инструкции и является это `SELECT` инструкции, которая выполняется при SqlDataSource s `Select()` вызывается метод (программно или автоматически на основе данных веб-элемент управления).

SQL `SELECT` инструкций, используемых в предыдущей демонстрации учебника s отсутствовали `WHERE` предложения. В `SELECT` инструкции `WHERE` предложение может использоваться для ограничения возвращаемых результатов. Например чтобы отобразить имена товары стоимостью более $50,00, можно использовать следующий запрос:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample1.sql)]

Как правило, значения, используемые в `WHERE` предложение для определения внешнего источника, например значение строки запроса, переменной сеанса или данные, вводимые пользователем на странице веб-элемент управления. В идеальном случае подобные данные указаны использования *параметры*. С помощью Microsoft SQL Server, параметры задаются с помощью `@parameterName`, как в следующем примере:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample2.sql)]

SqlDataSource поддерживает параметризованные запросы, как в `SELECT` инструкций и `INSERT`, `UPDATE`, и `DELETE` инструкции. Кроме того значения параметров можно автоматически из различных источников строке запроса состояния сеанса, элементы управления на странице и т. д или можно назначать программным образом. В этом учебнике будет показано, как определить также параметризованные запросы как для указания параметра значения декларативно и программно.

> [!NOTE]
> В предыдущем учебнике мы проверили ObjectDataSource, который был наш прекрасно подходит по сначала 46 учебники с SqlDataSource отметить их основные сходства. Это сходство также расширяются до параметров. Параметры ObjectDataSource s сопоставлен входные параметры для методов в бизнес-логики. В SqlDataSource параметры определены непосредственно в SQL-запроса. Оба элемента управления у коллекций параметров для их `Select()`, `Insert()`, `Update()`, и `Delete()` методы и и может принимать следующие значения параметра, заполняется из предварительно определенных источников (значения строк запроса, переменные сеанса и т. д ) или назначать программным образом.


## <a name="creating-a-parameterized-query"></a>Создание параметризованного запроса

Мастер настройки источника данных s управления SqlDataSource предлагает три пути для определения команды необходимо выполнить, чтобы получить записи базы данных.

- Выбирая столбцы из существующей таблицы или представления,
- Введя пользовательские инструкции SQL или
- Выбрав хранимой процедуры

При получении столбцов из существующей таблицы или представления, параметры для `WHERE` должно быть указано предложение посредством добавления `WHERE` предложение диалоговое окно. Создавая пользовательские инструкции SQL, однако можно ввести параметры непосредственно в `WHERE` предложения (с помощью `@parameterName` для обозначения каждого параметра). Объект [хранимой процедуры](http://www.awprofessional.com/articles/article.asp?p=25288&amp;rl=1) состоит из одной или нескольких инструкций SQL, и эти операторы могут быть параметризованы. Параметры, используемые в инструкциях SQL, тем не менее, должен передаваться в качестве входных параметров хранимой процедуры.

Поскольку создание параметризованного запроса зависит SqlDataSource s `SelectCommand` является указанным, позволяют s взгляните все три подхода. Чтобы приступить к работе, откройте `ParameterizedQueries.aspx` страницы в `SqlDataSource` папки, перетащите элемент управления SqlDataSource из области элементов в конструктор и задайте его `ID` для `Products25BucksAndUnderDataSource`. Затем щелкните ссылку настроить источник данных смарт-теге элемента управления s. Выберите базу данных для использования (`NORTHWINDConnectionString`) и нажмите кнопку Далее.

## <a name="step-1-adding-awhereclause-when-picking-the-columns-from-a-table-or-view"></a>Шаг 1: Добавление`WHERE`предложение при получении столбцов из таблицы или представления

При выборе данных для возврата из базы данных с помощью элемента управления SqlDataSource, мастер настройки источника данных позволяет нам просто выберите столбцы, которые возвращают из существующей таблицы или представления (см. рис. 1). Это автоматически создает SQL `SELECT` инструкцию, которая отправляется в базу данных при SqlDataSource s `Select()` вызывается метод. Как это делалось в предыдущем учебнике, выберите в раскрывающемся списке таблицу Products и проверьте `ProductID`, `ProductName`, и `UnitPrice` столбцов.


[![Выберите столбцы, возвращаемые из таблицы или представления](using-parameterized-queries-with-the-sqldatasource-vb/_static/image1.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image1.png)

**Рис. 1**: выбрать столбцы для возвращаемого значения из таблицы или представления ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image2.png))


Чтобы включить `WHERE` предложения в `SELECT` инструкции, нажмите кнопку `WHERE` кнопки, которая вызывает Add `WHERE` диалогового окна "предложение" (см. рис. 2). Чтобы добавить параметр, чтобы ограничить результаты, возвращенные `SELECT` запроса, сначала выберите столбец для фильтрации данных по. Затем выберите оператор, используемый для фильтрации (=, &lt;, &lt;=, &gt;и так далее). Теперь выберите источник значения параметра s, такие как из строки запроса или состояние сеанса. После настройки параметра, нажмите кнопку Добавить, чтобы включить его в `SELECT` запроса.

В этом примере s позволяют возвращать только те результаты где `UnitPrice` значение меньше или равно $25,00. Таким образом, выбрать `UnitPrice` из раскрывающегося списка столбцов и &lt;= из списка оператора. При использовании значения параметра жестко (например, $25,00) или значение параметра не должен задаваться программным способом, выберите Нет из раскрывающегося списка источников. Затем введите значение параметра жестко в текстовом поле значение 25,00 и завершить процесс, нажмите кнопку Добавить.


[![Ограничить результаты, возвращаемые из добавить предложение диалоговое окно](using-parameterized-queries-with-the-sqldatasource-vb/_static/image2.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image3.png)

**На рисунке 2**: ограничить результаты, возвращенные из Add `WHERE` предложение диалоговое окно ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image4.png))


После добавления параметра, нажмите кнопку ОК, чтобы вернуться в мастер настройки источника данных. `SELECT` Должен включать инструкцию в нижней части мастера `WHERE` предложение with параметр с именем `@UnitPrice`:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample3.sql)]

> [!NOTE]
> Если указать несколько условий в `WHERE` предложения от добавления `WHERE` в диалоговом окне предложения мастера соединяет их с `AND` оператор. Если нужно включить `OR` в `WHERE` предложения (например, `WHERE UnitPrice <= @UnitPrice OR Discontinued = 1`) нужно построить `SELECT` инструкции через экран пользовательские инструкции SQL.


Завершить настройку SqlDataSource (нажмите кнопку Далее, после чего завершите), а затем проверьте декларативная разметка SqlDataSource s. Теперь включает разметку `<SelectParameters>` коллекцию, которая подробно рассматриваются источников для параметров в `SelectCommand`.


[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample4.aspx)]

Если SqlDataSource s `Select()` вызывается метод, `UnitPrice` применяется значение параметра (25,00) `@UnitPrice` параметр в `SelectCommand` перед его отправкой в базу данных. Конечным результатом будет только те продукты, которые меньше или равно $25,00 возвращаются из `Products` таблицы. Чтобы проверить это, добавьте на страницу GridView, привязать его к этому источнику данных и просмотрите страницу с помощью браузера. Вы должны видеть только те продукты, которые меньше или равно $25,00, как на рис. 3 подтверждает.


[![Отображаются только те продукты меньше чем или равно $25,00](using-parameterized-queries-with-the-sqldatasource-vb/_static/image3.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image5.png)

**Рис. 3**: отображаются только те продукты меньше чем или равно $25,00 ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image6.png))


## <a name="step-2-adding-parameters-to-a-custom-sql-statement"></a>Шаг 2: Добавление параметров в инструкцию SQL, пользовательские

При добавлении пользовательские инструкции SQL можно ввести `WHERE` предложение явным образом или укажите значение в ячейке фильтра построителя запросов. Чтобы продемонстрировать это, позволяют отображать только те продукты в GridView, цены меньше, чем определенное пороговое значение s. Начните с добавления текстового поля к `ParameterizedQueries.aspx` страницу, чтобы запросить у пользователя это пороговое значение. Набор TextBox s `ID` свойства `MaxPrice`. Добавьте кнопку веб-элемент управления и задайте его `Text` свойство для отображения соответствующих продуктов.

Затем перетащите на страницу элемент управления GridView, а в его смарт-теге, выберите для создания нового SqlDataSource с именем `ProductsFilteredByPriceDataSource`. С помощью мастера настройки источника данных, перейдите к указать пользовательские инструкции SQL или хранимой процедуры экрана (см. рис. 4) и введите следующий запрос:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample5.sql)]

После ввода запроса (вручную или с помощью построителя запросов), нажмите кнопку "Далее".


[![Возвращать только те продукты, меньше или равно значение параметра](using-parameterized-queries-with-the-sqldatasource-vb/_static/image4.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image7.png)

**Рис. 4**: возвращает только те продукты меньше чем или равно значению параметра ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image8.png))


Поскольку запрос включает параметры, на следующем экране мастера запрашивает источником значений параметров. Выберите элемент управления из раскрывающегося списка параметров источника и `MaxPrice` (элемент управления TextBox s `ID` значение) в раскрывающемся списке ControlID. Можно также ввести необязательное значение по умолчанию для использования в случае, когда пользователь не ввел любой текст в `MaxPrice` текстового поля. На данный момент, не вводите значение по умолчанию.


[![S MaxPrice текстовое свойство Text используется в качестве источника параметра](using-parameterized-queries-with-the-sqldatasource-vb/_static/image5.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image9.png)

**Рис. 5**: `MaxPrice` TextBox s `Text` свойство используется в качестве источника параметра ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image10.png))


Завершите работу мастера настройки источника данных, нажав кнопку Далее, а затем Готово. Декларативная разметка для GridView, текстового поля, кнопки и SqlDataSource выглядит следующим образом:


[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample6.aspx)]

Обратите внимание, что параметру в SqlDataSource s `<SelectParameters>` раздел `ControlParameter`, которая содержит дополнительные свойства, как `ControlID` и `PropertyName`. Если SqlDataSource s `Select()` вызывается метод, `ControlParameter` извлекает значение из указанного свойства элемента управления Web и присваивает его с соответствующим параметром `SelectCommand`. В этом примере `MaxPrice` s текстовое свойство используется в качестве `@MaxPrice` значение параметра.

Внимательно просмотреть эту страницу через браузер. При первом посещении страницы или всякий раз, когда `MaxPrice` текстовое поле отсутствует значение, не отображаются записей в GridView.


[![Нет записей, что отображается при MaxPrice текстовое поле пустое.](using-parameterized-queries-with-the-sqldatasource-vb/_static/image6.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image11.png)

**Рис. 6**: нет записей, отображаемых при `MaxPrice` текстовое поле пустое ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image12.png))


Продукты не отображаются, так как, по умолчанию значение параметра пустая строка преобразуется в базу данных `NULL` значение. После сравнения из `[UnitPrice] <= NULL` всегда равно false, результаты не возвращаются.

Введите значение в текстовое поле, например 5,00 и нажмите кнопку отображения соответствующих продуктов. При обратной передаче SqlDataSource информирует GridView, что один из своих источников параметр был изменен. Следовательно для GridView число повторных привязок SqlDataSource, отображая эти продукты меньше или равен 5,00 доллара.


[![Отображаются продукты меньше чем или равно 5,00](using-parameterized-queries-with-the-sqldatasource-vb/_static/image7.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image13.png)

**Рис. 7**: отображаются продукты меньше чем или равно 5,00 ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image14.png))


## <a name="initially-displaying-all-products"></a>Изначально отображение всех продуктов

Может потребоваться отобразить вместо вывода не продуктов при первой загрузке страницы, мы *все* продуктов. Один из способов перечислены все продукты, всякий раз, когда `MaxPrice` пуст будет присвоено значение по умолчанию параметр s некоторые операция слишком большое значение, например 1000000, так как оно s, маловероятно, что Northwind Traders будет постоянно иметь инвентаризации, цена которых превышает 1 000 000 долларов. Этот подход shortsighted и может не работать в других ситуациях.

В предыдущих учебниках - [декларативные параметры](../basic-reporting/declarative-parameters-vb.md) и [иерархического фильтрации с DropDownList](../masterdetail/master-detail-filtering-with-a-dropdownlist-vb.md) были встают подобную проблему. Существует наши решения можно было поместить этой логики в бизнес-логики. В частности, уровень бизнес-ЛОГИКИ проверить входящее значение и, если он был `NULL` или некоторых зарезервированных значение, вызов направлено в метод DAL, возвращаются все записи. Если входящее значение нормальное значение фильтрации, выполнен вызов метода DAL, который выполнил инструкцию SQL, который использовать параметризованную `WHERE` предложение with указанное значение.

К сожалению мы обойти архитектуры при использовании SqlDataSource. Вместо этого необходимо настроить инструкцию SQL, интеллектуально захватить все записи, если `@MaximumPrice` параметр `NULL` или какое-либо зарезервированное значение. Для этого упражнения позволяют s имеют его таким образом, если `@MaximumPrice` равен параметр `-1.0`, затем *все* записей должны быть возвращены (`-1.0` работает как зарезервированное значение, поскольку ни один продукт не может иметь отрицательное `UnitPrice`значение). Для выполнения этой задачи можно использовать следующую инструкцию SQL:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample7.sql)]

Это `WHERE` предложение возвращает *все* записи Если `@MaximumPrice` параметр равен `-1.0`. Если значение параметра не `-1.0`, только те продукты, `UnitPrice` меньше или равно `@MaximumPrice` возвращаются значения параметра. Задав значение по умолчанию `@MaximumPrice` параметр `-1.0`, при первой загрузке страницы (или каждый раз, когда `MaxPrice` пуст), `@MaximumPrice` будет иметь значение `-1.0` и отображаются все продукты.


[![Теперь всех продуктов, которые отображаются при MaxPrice TextBox пуста](using-parameterized-queries-with-the-sqldatasource-vb/_static/image8.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image15.png)

**Рис. 8**: теперь всех продуктов, которые отображаются при `MaxPrice` текстовое поле пустое ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image16.png))


Существует несколько предостережений Обратите внимание, в рамках этого подхода. Во-первых, необходимо учесть, определить тип данных параметра s его использование s в SQL-запросе. При изменении `WHERE` предложения из `@MaximumPrice = -1.0` для `@MaximumPrice = -1`, среда выполнения рассматривает параметр является значением типа integer. Если затем выполняется попытка назначить `MaxPrice` TextBox в десятичное значение (например, 5.00), возникнет ошибка, так как она не может преобразовать 5,00 целое число. Чтобы это исправить, либо убедитесь, что используемая `@MaximumPrice = -1.0` в `WHERE` предложение или лучше, установите `ControlParameter` объект s `Type` свойство в десятичное.

Во-вторых, добавив `OR @MaximumPrice = -1.0` для `WHERE` предложение, обработчик запросов не может использовать индекс `UnitPrice` (при условии, что один существует), тем самым возникающие при сканировании таблицы. При наличии достаточно большое количество записей в это может повлиять на производительность `Products` таблицы. Удачным подходом было бы переместить эту логику в хранимую процедуру где `IF` либо выполнить инструкции `SELECT` запрос из `Products` таблицы без `WHERE` предложения, если требуется возвратить все записи, или один которого `WHERE` предложение содержит только `UnitPrice` критериев, чтобы можно было использовать индекс.

## <a name="step-3-creating-and-using-parameterized-stored-procedures"></a>Шаг 3: Создание и использование параметризованные хранимые процедуры

Хранимые процедуры можно включить набор входных параметров, которые можно использовать в инструкции SQL, определенных в хранимой процедуре. При настройке SqlDataSource использовать хранимую процедуру, которая принимает входные параметры, значения этих параметров можно задать с помощью тех же методов с помощью нерегламентированных инструкций SQL.

Чтобы проиллюстрировать использование хранимых процедур в SqlDataSource, s позволяют создать новую хранимую процедуру в базе данных Northwind с именем `GetProductsByCategory`, который принимает параметр с именем `@CategoryID` и возвращает все столбцы из этих продуктов, `CategoryID` соответствует столбцу `@CategoryID`. Чтобы создать хранимую процедуру, перейдите в обозреватель сервера и детализации `NORTHWND.MDF` базы данных. (Если пункт не отображается в обозревателе сервера, открыть его, перейдя в меню «Вид» и выбрав параметр обозревателя серверов.)

Из `NORTHWND.MDF` базы данных, щелкните правой кнопкой мыши папку хранимые процедуры, нажмите кнопку Добавить новую хранимую процедуру и введите следующий синтаксис:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample8.sql)]

Щелкните Save значок (или сочетание клавиш Ctrl + S), чтобы сохранить хранимую процедуру. Хранимую процедуру можно проверить, щелкнув правой кнопкой мыши из папки «хранимые процедуры» и выбрав команду Execute. Поступит предложение для параметров хранимых процедур s (`@CategoryID`, в данном экземпляре), после которого результаты отображаются в окне вывода.


[![GetProductsByCategory хранимой процедуры, при выполнении @CategoryID 1](using-parameterized-queries-with-the-sqldatasource-vb/_static/image9.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image17.png)

**Рис. 9**: `GetProductsByCategory` хранимой процедуры, при выполнении `@CategoryID` 1 ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image18.png))


Разрешить использование этой хранимой процедуры можно вывести список продуктов в категории "Напитки" в элементе управления GridView s. Добавить новый GridView на страницу и привязать его к новой SqlDataSource с именем `BeverageProductsDataSource`. По-прежнему указать пользовательские инструкции SQL или хранимой процедуры экрана, установите переключатель в хранимой процедуре, а также выбрать `GetProductsByCategory` хранимую процедуру из раскрывающегося списка.


[![Выберите GetProductsByCategory хранимую процедуру из раскрывающегося списка](using-parameterized-queries-with-the-sqldatasource-vb/_static/image10.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image19.png)

**Рис. 10**: выберите `GetProductsByCategory` хранимую процедуру из раскрывающегося списка ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image20.png))


Поскольку хранимая процедура принимает входной параметр (`@CategoryID`), нажав кнопку Далее предлагает нам нужно указать источник для этого параметра значение s. Напитков `CategoryID` имеет значение 1, поэтому оставьте список раскрывающегося списка параметров источника по None и введите в текстовое поле DefaultValue 1.


[![Использование жестко запрограммированных значений 1 для возврата продукты в категории «Напитки»](using-parameterized-queries-with-the-sqldatasource-vb/_static/image11.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image21.png)

**Рис. 11**: использование Hard-Coded значение 1 для возврата продукты в категории «Напитки» ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image22.png))


Как показано в следующем декларативной разметкой, при использовании хранимой процедуры SqlDataSource s `SelectCommand` свойству присвоено имя хранимой процедуры и [ `SelectCommandType` свойство](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.sqldatasource.selectcommandtype.aspx) имеет значение `StoredProcedure`, означающее `SelectCommand` имя хранимой процедуры, а не специальной инструкции SQL.


[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample9.aspx)]

Проверить страницы в браузере. Отображаются только те продукты, которые принадлежат к категории напитков, несмотря на то что *все* продукта отображаются поля с момента `GetProductsByCategory` хранимая процедура возвращает все столбцы из `Products` таблицы. Нам удалось, конечно, ограничения и настройки полей в GridView, в диалоговом окне Правка столбцов GridView s.


[![Отображаются все напитков](using-parameterized-queries-with-the-sqldatasource-vb/_static/image12.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image23.png)

**Рис. 12**: отображаются все напитков ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image24.png))


## <a name="step-4-programmatically-invoking-a-sqldatasource-sselectstatement"></a>Шаг 4: Программного вызова SqlDataSource s`Select()`инструкции

Примеры мы выше в предыдущем учебнике и к этому учебнику, удалить привязку элементов управления SqlDataSource непосредственно к GridView. SqlDataSource управления s данные, тем не менее, можно программно получить доступ к и перечисления в коде. Это может быть особенно полезна при необходимость запрашивать данные для ее проверки, но пункт не требуются для его отображения. Вместо того, чтобы записать все стандартный код ADO.NET для подключения к базе данных, укажите команду и получать результаты, можно обрабатывать этот код монотонных SqlDataSource.

Для иллюстрации работы с SqlDataSource s данных программными средствами, представьте, что начальника достиг можно с помощью запроса для создания веб-страницы, отображает имя случайно выбранных категорий и его соответствующих продуктов. То есть, при посещении этой страницы, мы хотим случайным образом выбрать категорию из `Categories` таблицы, отображаемое имя категории и затем перечислены продукты, принадлежащих к этой категории.

Для выполнения этой задачи необходимо два элемента управления SqlDataSource один ситуацию случайных категорию из `Categories` таблицу, а другую для получения категории продуктов s. Мы создадим SqlDataSource, извлекающий запись случайных категории на этом этапе; Шаг 5 анализирует SqlDataSource, запрашивающего продукты категории s, Дополнительно.

Начните с добавления SqlDataSource для `ParameterizedQueries.aspx` и задайте его `ID` для `RandomCategoryDataSource`. Настройте его, чтобы он использовал следующий SQL-запрос:


[!code-sql[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample10.sql)]

`ORDER BY NEWID()`Возвращает записи, отсортированные в случайном порядке (в разделе [использование `NEWID()` случайным образом записи сортировки](http://www.sqlteam.com/item.asp?ItemID=8747)). `SELECT TOP 1`Возвращает первую запись из результирующего набора. Собрать вместе, этот запрос возвращает `CategoryID` и `CategoryName` значения столбцов из одной, случайно выбранных категорий.

Для отображения категории s `CategoryName` значения, добавить веб-управления Label на страницу, задайте его `ID` свойства `CategoryNameLabel`и очистить его `Text` свойство. Чтобы программным способом извлечения данных из элемента управления SqlDataSource, необходимо вызвать его `Select()` метод. [ `Select()` Метод](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.sqldatasource.select.aspx) ожидает один входной параметр типа [ `DataSourceSelectArguments` ](https://msdn.microsoft.com/en-us/library/system.web.ui.datasourceselectarguments.aspx), которое указывает, каким образом сообщения регистрируются данные перед возвращением. Это может включать инструкции для сортировки и фильтрации данных и используемые данные, которые веб-элементы управления для сортировки и постраничного просмотра данных из элемента управления SqlDataSource. В нашем примере, мы не хотите t необходимость данные изменяются до возврата и таким образом будет передать в `DataSourceSelectArguments.Empty` объекта.

`Select()` Метод возвращает объект, реализующий интерфейс `IEnumerable`. Точный тип, возвращаемый зависит от значения элемента управления SqlDataSource s [ `DataSourceMode` свойства](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.sqldatasource.datasourcemode.aspx). Как отмечалось в предыдущем учебнике, это свойство может быть присвоено значение `DataSet` или `DataReader`. Если значение `DataSet`, `Select()` возвращает [DataView](https://msdn.microsoft.com/en-us/library/01s96x0z.aspx) объекта; при `DataReader`, он возвращает объект, реализующий интерфейс [ `IDataReader` ](https://msdn.microsoft.com/en-us/library/system.data.idatareader.aspx). Поскольку `RandomCategoryDataSource` имеет SqlDataSource его `DataSourceMode` свойство `DataSet` (по умолчанию), мы будем работать с объектом DataView.

Следующий код иллюстрирует способ получения записей из `RandomCategoryDataSource` SqlDataSource как DataView и как выполнить чтение `CategoryName` значение столбца из первой строки DataView:


[!code-vb[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample11.vb)]

`randomCategoryView(0)`Возвращает первый `DataRowView` в DataView. `randomCategoryView(0)("CategoryName")`Возвращает значение `CategoryName` столбца в первом ряду. Обратите внимание, что DataView слабо типизированной. Для ссылки на значение определенного столбца необходимо передать имя столбца в виде строки (в данном случае «категория»). На рисунке 13 показано сообщение, отображаемое в `CategoryNameLabel` при просмотре страницы. Конечно, фактическое имя категории отображаются выбирается случайным образом по `RandomCategoryDataSource` SqlDataSource на каждом посещении страницы (включая обратные передачи).


[![S случайным образом выбраны категории, имя отображается](using-parameterized-queries-with-the-sqldatasource-vb/_static/image13.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image25.png)

**Рис. 13**: s случайным образом выбраны категории отображается имя ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image26.png))


> [!NOTE]
> Если SqlDataSource управлять s `DataSourceMode` ранее было задано свойство `DataReader`, возвращаемое значение `Select()` метод пришлось бы привести к `IDataReader`. Для чтения `CategoryName` значение столбца из первой строки, мы d использовать следующий код:


[!code-vb[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample12.vb)]

С SqlDataSource случайным образом при выборе категории, мы готов для добавления в GridView, в которой перечислены продукты категории s.

> [!NOTE]
> Вместо того чтобы использовать метки веб-элемент управления для отображения имени категории s, может добавлена FormView или DetailsView на страницу, привязав его к SqlDataSource. Однако с помощью метки, позволило нам узнаем, как программным способом вызвать SqlDataSource s `Select()` инструкции, а также работать с его результирующие данные в коде.


## <a name="step-5-assigning-parameter-values-programmatically"></a>Шаг 5: Присвоение значений параметра программным способом

Все примеры мы выше, в этом учебнике открывалось значение жестко параметра или один из одного из источников предварительно определенных параметров (значение строки запроса, веб-элемент управления на странице и т. д.). Однако параметры s управления SqlDataSource можно также задать программным способом. Чтобы завершить нашей текущей пример, мы должны SqlDataSource, который возвращает все продукты, принадлежащие к указанной категории. Будет иметь этот SqlDataSource `CategoryID` на основе параметра, значение которого требуется задать `CategoryID` значения столбца, возвращенного `RandomCategoryDataSource` SqlDataSource в `Page_Load` обработчика событий.

Начните с добавления элемента управления GridView на страницу и привязать его к новой SqlDataSource с именем `ProductsByCategoryDataSource`. Как мы делали на шаге 3, настройте SqlDataSource таким образом, чтобы он вызывает `GetProductsByCategory` хранимой процедуры. Оставьте набор параметров источника раскрывающемся списке нет, но не вводите значение по умолчанию, как это значение по умолчанию будут заданы программным путем.


[![Не указан источник параметра или значение по умолчанию](using-parameterized-queries-with-the-sqldatasource-vb/_static/image14.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image27.png)

**Рис. 14**: не указан источник параметра или значение по умолчанию ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image28.png))


После завершения работы мастера SqlDataSource полученный должна выглядеть следующим образом:


[!code-aspx[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample13.aspx)]

Чтобы назначить `DefaultValue` из `CategoryID` параметр программное `Page_Load` обработчик событий:


[!code-vb[Main](using-parameterized-queries-with-the-sqldatasource-vb/samples/sample14.vb)]

В результате этого добавления страница содержит GridView, отображаются продукты, связанные с случайным образом выбранной категории.


[![Не указан источник параметра или значение по умолчанию](using-parameterized-queries-with-the-sqldatasource-vb/_static/image15.gif)](using-parameterized-queries-with-the-sqldatasource-vb/_static/image29.png)

**Рис. 15**: не указан источник параметра или значение по умолчанию ([Просмотр полноразмерное изображение](using-parameterized-queries-with-the-sqldatasource-vb/_static/image30.png))


## <a name="summary"></a>Сводка

SqlDataSource позволяет определять параметризованные запросы со значениями параметров можно жестко, полученных из предварительно определенных параметров источников или назначать программным образом. В этом учебнике мы узнали, как создать параметризованный запрос с помощью мастера настройки источника данных для нерегламентированных запросов SQL и хранимых процедур. Также мы рассмотрели использование жестко запрограммированный параметр источников, как источник параметра веб-элемент управления и программным путем указания значения параметра.

Как и с ObjectDataSource SqlDataSource также предоставляет возможности для изменения базовых данных. В следующем уроке мы рассмотрим способы определения `INSERT`, `UPDATE`, и `DELETE` инструкции с SqlDataSource. После добавления этих инструкций, мы используем встроенной вставку, изменение и удаление средств управления GridView, DetailsView и FormView.

Программирование довольны!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи ASP/ASP.NET и основателя из [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Майкрософт с 1998 года. Скотт — независимый консультант, trainer и записи. Его последняя книга — [ *диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он может быть достигнута по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [http://ScottOnWriting.NET](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Благодарности

Этот учебник ряд прошел проверку многие полезные рецензентов. Основными редакторами этого учебника были Scott Clyde Шмидт Рэнделл и Алексей Pespisa. Объясняются моих последующих статей для MSDN? Если Да, напишите мне по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

>[!div class="step-by-step"]
[Назад](querying-data-with-the-sqldatasource-control-vb.md)
[Вперед](inserting-updating-and-deleting-data-with-the-sqldatasource-vb.md)

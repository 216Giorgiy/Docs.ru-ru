---
uid: web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-vb
title: "Файл кода, передать параметр, при добавлении новой записи (Visual Basic) | Документы Microsoft"
author: rick-anderson
description: "Этого учебника показано, как создать веб-интерфейс, который позволяет пользователю ввести текстовых данных и передача двоичных файлов. Чтобы проиллюстрировать t доступные параметры..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/27/2007
ms.topic: article
ms.assetid: 5776281d-4637-4d1e-a65b-2621d2cade44
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-vb
msc.type: authoredcontent
ms.openlocfilehash: eb462a0e8ce88037855ea12d00c1afc0419fa04e
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2018
---
<a name="including-a-file-upload-option-when-adding-a-new-record-vb"></a><span data-ttu-id="872e8-104">Включая параметр передачи файла при добавлении новой записи (Visual Basic)</span><span class="sxs-lookup"><span data-stu-id="872e8-104">Including a File Upload Option When Adding a New Record (VB)</span></span>
====================
<span data-ttu-id="872e8-105">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="872e8-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="872e8-106">[Загрузить пример приложения](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_VB.exe) или [скачать PDF](including-a-file-upload-option-when-adding-a-new-record-vb/_static/datatutorial56vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="872e8-106">[Download Sample App](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_VB.exe) or [Download PDF](including-a-file-upload-option-when-adding-a-new-record-vb/_static/datatutorial56vb1.pdf)</span></span>

> <span data-ttu-id="872e8-107">Этого учебника показано, как создать веб-интерфейс, который позволяет пользователю ввести текстовых данных и передача двоичных файлов.</span><span class="sxs-lookup"><span data-stu-id="872e8-107">This tutorial shows how to create a Web interface that allows the user to both enter text data and upload binary files.</span></span> <span data-ttu-id="872e8-108">Чтобы проиллюстрировать параметры, доступные для хранения двоичных данных, один файл будет сохранен в базе данных, то время как другой хранятся в файловой системе.</span><span class="sxs-lookup"><span data-stu-id="872e8-108">To illustrate the options available to store binary data, one file will be saved in the database while the other is stored in the file system.</span></span>


## <a name="introduction"></a><span data-ttu-id="872e8-109">Вступление</span><span class="sxs-lookup"><span data-stu-id="872e8-109">Introduction</span></span>

<span data-ttu-id="872e8-110">На предыдущих двух уроках мы изучена методы для хранения двоичных данных, связанный с моделью данных приложения s, рассмотрены способы использования элемента управления FileUpload для отправки файлов от клиента к веб-серверу и узнали, как для представления этих двоичных данных в данных W элемент управления ЭБ.</span><span class="sxs-lookup"><span data-stu-id="872e8-110">In the previous two tutorials we explored techniques for storing binary data that is associated with the application s data model, looked at how to use the FileUpload control to send files from the client to the web server, and saw how to present this binary data in a data Web control.</span></span> <span data-ttu-id="872e8-111">Мы сохранить еще поговорим о том, как связать загруженные данные с моделью данных, однако.</span><span class="sxs-lookup"><span data-stu-id="872e8-111">We ve yet to talk about how to associate uploaded data with the data model, though.</span></span>

<span data-ttu-id="872e8-112">В этом учебнике мы создадим веб-страницы, чтобы добавить новую категорию.</span><span class="sxs-lookup"><span data-stu-id="872e8-112">In this tutorial we will create a web page to add a new category.</span></span> <span data-ttu-id="872e8-113">Помимо текстовые поля s имя категории и описания Эта страница будет должны включать два элемента управления FileUpload для новой категории s картинки и один для брошюр.</span><span class="sxs-lookup"><span data-stu-id="872e8-113">In addition to TextBoxes for the category s name and description, this page will need to include two FileUpload controls one for the new category s picture and one for the brochure.</span></span> <span data-ttu-id="872e8-114">Переданные изображения сохраняются непосредственно в новой записи s `Picture` столбец, в то время как брошюр будут сохранены в `~/Brochures` папку по пути для файла, сохраненного в новой записи s `BrochurePath` столбца.</span><span class="sxs-lookup"><span data-stu-id="872e8-114">The uploaded picture will be stored directly in the new record s `Picture` column, whereas the brochure will be saved to the `~/Brochures` folder with the path to the file saved in the new record s `BrochurePath` column.</span></span>

<span data-ttu-id="872e8-115">Перед созданием этой новой веб-страницы, необходимо обновить архитектуру.</span><span class="sxs-lookup"><span data-stu-id="872e8-115">Before creating this new web page, we'll need to update the architecture.</span></span> <span data-ttu-id="872e8-116">`CategoriesTableAdapter` Основной запрос s не сможет извлечь `Picture` столбец.</span><span class="sxs-lookup"><span data-stu-id="872e8-116">The `CategoriesTableAdapter` s main query does not retrieve the `Picture` column.</span></span> <span data-ttu-id="872e8-117">Следовательно, автоматически сгенерированный `Insert` метод имеет только входные данные для `CategoryName`, `Description`, и `BrochurePath` поля.</span><span class="sxs-lookup"><span data-stu-id="872e8-117">Consequently, the auto-generated `Insert` method only has inputs for the `CategoryName`, `Description`, and `BrochurePath` fields.</span></span> <span data-ttu-id="872e8-118">Таким образом, необходимо ли создавать дополнительный метод в TableAdapter, которые запрашиваются все четыре `Categories` поля.</span><span class="sxs-lookup"><span data-stu-id="872e8-118">Therefore, we need to create an additional method in the TableAdapter that prompts for all four `Categories` fields.</span></span> <span data-ttu-id="872e8-119">`CategoriesBLL` Класса в бизнес-логики также необходимо обновить.</span><span class="sxs-lookup"><span data-stu-id="872e8-119">The `CategoriesBLL` class in the Business Logic Layer will also need to be updated.</span></span>

## <a name="step-1-adding-aninsertwithpicturemethod-to-thecategoriestableadapter"></a><span data-ttu-id="872e8-120">Шаг 1: Добавление`InsertWithPicture`метода`CategoriesTableAdapter`</span><span class="sxs-lookup"><span data-stu-id="872e8-120">Step 1: Adding an`InsertWithPicture`Method to the`CategoriesTableAdapter`</span></span>

<span data-ttu-id="872e8-121">Когда мы создали `CategoriesTableAdapter` в [Создание слой доступа к данным](../introduction/creating-a-data-access-layer-vb.md) учебника было настроено для автоматического создания `INSERT`, `UPDATE`, и `DELETE` инструкций на основе основного запроса.</span><span class="sxs-lookup"><span data-stu-id="872e8-121">When we created the `CategoriesTableAdapter` back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) tutorial, we configured it to automatically generate `INSERT`, `UPDATE`, and `DELETE` statements based on the main query.</span></span> <span data-ttu-id="872e8-122">Кроме того, мы рекомендовано использовать DB прямой подход, который создан методы адаптера таблицы `Insert`, `Update`, и `Delete`.</span><span class="sxs-lookup"><span data-stu-id="872e8-122">Moreover, we instructed the TableAdapter to employ the DB Direct approach, which created the methods `Insert`, `Update`, and `Delete`.</span></span> <span data-ttu-id="872e8-123">Эти методы выполнения автоматического `INSERT`, `UPDATE`, и `DELETE` инструкций и, следовательно, принимать входные параметры, основанные на столбцах, возвращенной основным запросом.</span><span class="sxs-lookup"><span data-stu-id="872e8-123">These methods execute the auto-generated `INSERT`, `UPDATE`, and `DELETE` statements and, consequently, accept input parameters based on the columns returned by the main query.</span></span> <span data-ttu-id="872e8-124">В [передачи файлов](uploading-files-vb.md) учебника мы дополнить `CategoriesTableAdapter` s основной запрос для использования `BrochurePath` столбца.</span><span class="sxs-lookup"><span data-stu-id="872e8-124">In the [Uploading Files](uploading-files-vb.md) tutorial we augmented the `CategoriesTableAdapter` s main query to use the `BrochurePath` column.</span></span>

<span data-ttu-id="872e8-125">Поскольку `CategoriesTableAdapter` s основной запрос не ссылается на `Picture` столбца, мы можно добавить новую запись ни обновление существующей записи со значением для `Picture` столбца.</span><span class="sxs-lookup"><span data-stu-id="872e8-125">Since the `CategoriesTableAdapter` s main query does not reference the `Picture` column, we can neither add a new record nor update an existing record with a value for the `Picture` column.</span></span> <span data-ttu-id="872e8-126">Чтобы записать эти сведения, можно либо создать новый метод в адаптере таблицы, используемый для вставки записи с двоичными данными или мы, можно настроить автоматически сформированного `INSERT` инструкции.</span><span class="sxs-lookup"><span data-stu-id="872e8-126">In order to capture this information, we can either create a new method in the TableAdapter that is used specifically to insert a record with binary data or we can customize the auto-generated `INSERT` statement.</span></span> <span data-ttu-id="872e8-127">Проблема с Настройка автоматического `INSERT` инструкция является мы риск необходимости сделанных настроек перезаписана с помощью мастера.</span><span class="sxs-lookup"><span data-stu-id="872e8-127">The problem with customizing the auto-generated `INSERT` statement is that we risk having our customizations overwritten by the wizard.</span></span> <span data-ttu-id="872e8-128">Например, предположим, что мы настроена `INSERT` инструкцию, чтобы включить использование `Picture` столбца.</span><span class="sxs-lookup"><span data-stu-id="872e8-128">For example, imagine that we customized the `INSERT` statement to include use of the `Picture` column.</span></span> <span data-ttu-id="872e8-129">Это обновит TableAdapter s `Insert` метод, чтобы включить дополнительный входной параметр для категории s рисунок s двоичные данные.</span><span class="sxs-lookup"><span data-stu-id="872e8-129">This would update the TableAdapter s `Insert` method to include an additional input parameter for the category s picture s binary data.</span></span> <span data-ttu-id="872e8-130">Затем удалось создать метод в уровня бизнес-логики, чтобы с его помощью DAL и вызывать этот метод уровень бизнес-ЛОГИКИ через уровень представления, и все будет работать прекрасно.</span><span class="sxs-lookup"><span data-stu-id="872e8-130">We could then create a method in the Business Logic Layer to use this DAL method and invoke this BLL method through the Presentation Layer, and everything would work wonderfully.</span></span> <span data-ttu-id="872e8-131">То есть до следующего настроена через мастер настройки адаптера таблицы TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="872e8-131">That is, until the next time we configured the TableAdapter through the TableAdapter Configuration wizard.</span></span> <span data-ttu-id="872e8-132">Как только работа мастера завершена, сделанных настроек для `INSERT` инструкции будут перезаписаны, `Insert` метод будет возвращаться в его старая форма и наш код больше не будет компилироваться!</span><span class="sxs-lookup"><span data-stu-id="872e8-132">As soon as the wizard completed, our customizations to the `INSERT` statement would be overwritten, the `Insert` method would revert to its old form, and our code would no longer compile!</span></span>

> [!NOTE]
> <span data-ttu-id="872e8-133">Недовольство этот вопрос не-при использовании хранимых процедур вместо нерегламентированных инструкций SQL.</span><span class="sxs-lookup"><span data-stu-id="872e8-133">This annoyance is a non-issue when using stored procedures instead of ad-hoc SQL statements.</span></span> <span data-ttu-id="872e8-134">Будущие учебника будет изучено использование хранимых процедур вместо нерегламентированных инструкций SQL на уровне доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="872e8-134">A future tutorial will explore using stored procedures in lieu of ad-hoc SQL statements in the Data Access Layer.</span></span>


<span data-ttu-id="872e8-135">Чтобы избежать этой возможности головную боль, чем Настройка инструкций SQL автоматически созданный позволяют s вместо этого создайте новый метод для адаптера таблицы.</span><span class="sxs-lookup"><span data-stu-id="872e8-135">To avoid this potential headache, rather than customizing the auto-generated SQL statements let s instead create a new method for the TableAdapter.</span></span> <span data-ttu-id="872e8-136">Этот метод с именем `InsertWithPicture`, будет принимать значения для `CategoryName`, `Description`, `BrochurePath`, и `Picture` столбцы и выполнения `INSERT` инструкцию, которая хранит все четыре значения в новой записи.</span><span class="sxs-lookup"><span data-stu-id="872e8-136">This method, named `InsertWithPicture`, will accept values for the `CategoryName`, `Description`, `BrochurePath`, and `Picture` columns and execute an `INSERT` statement that stores all four values in a new record.</span></span>

<span data-ttu-id="872e8-137">Откройте типизированного набора данных и в режиме конструктора щелкните правой кнопкой мыши `CategoriesTableAdapter` заголовок s и в контекстном меню выберите команду Добавить запрос.</span><span class="sxs-lookup"><span data-stu-id="872e8-137">Open the Typed DataSet and, from the Designer, right-click on the `CategoriesTableAdapter` s header and choose Add Query from the context menu.</span></span> <span data-ttu-id="872e8-138">Запустится мастер настройки запроса адаптера таблицы, которая начинается с вопроса, как запроса адаптера таблицы следует обращаться к базе данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-138">This launches the TableAdapter Query Configuration Wizard, which begins by asking us how the TableAdapter query should access the database.</span></span> <span data-ttu-id="872e8-139">Выберите использовать инструкции SQL и нажмите кнопку Далее.</span><span class="sxs-lookup"><span data-stu-id="872e8-139">Choose Use SQL statements and click Next.</span></span> <span data-ttu-id="872e8-140">Следующий шаг предлагаемые для типа запроса.</span><span class="sxs-lookup"><span data-stu-id="872e8-140">The next step prompts for the type of query to be generated.</span></span> <span data-ttu-id="872e8-141">Поскольку мы повторно создать запрос, чтобы добавить новую запись для `Categories` таблицы, выберите INSERT и нажмите кнопку Далее.</span><span class="sxs-lookup"><span data-stu-id="872e8-141">Since we re creating a query to add a new record to the `Categories` table, choose INSERT and click Next.</span></span>


<span data-ttu-id="872e8-142">[![Выберите параметр вставки](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="872e8-142">[![Select the INSERT Option](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image1.png)</span></span>

<span data-ttu-id="872e8-143">**Рис. 1**: выберите параметр вставки ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="872e8-143">**Figure 1**: Select the INSERT Option ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.png))</span></span>


<span data-ttu-id="872e8-144">Теперь нам нужно указать `INSERT` инструкции SQL.</span><span class="sxs-lookup"><span data-stu-id="872e8-144">We now need to specify the `INSERT` SQL statement.</span></span> <span data-ttu-id="872e8-145">Мастер установки автоматически предлагает `INSERT` инструкции, соответствующий s основного запроса адаптера таблицы.</span><span class="sxs-lookup"><span data-stu-id="872e8-145">The wizard automatically suggests an `INSERT` statement corresponding to the TableAdapter s main query.</span></span> <span data-ttu-id="872e8-146">В этом случае он s `INSERT` инструкции, которая вставляет `CategoryName`, `Description`, и `BrochurePath` значения.</span><span class="sxs-lookup"><span data-stu-id="872e8-146">In this case, it s an `INSERT` statement that inserts the `CategoryName`, `Description`, and `BrochurePath` values.</span></span> <span data-ttu-id="872e8-147">Инструкция UPDATE, чтобы `Picture` включен столбец вместе с `@Picture` параметр следующим образом:</span><span class="sxs-lookup"><span data-stu-id="872e8-147">Update the statement so that the `Picture` column is included along with a `@Picture` parameter, like so:</span></span>


[!code-sql[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample1.sql)]

<span data-ttu-id="872e8-148">На последнем экране мастера появляется запрос на имя нового метода адаптера таблицы.</span><span class="sxs-lookup"><span data-stu-id="872e8-148">The final screen of the wizard asks us to name the new TableAdapter method.</span></span> <span data-ttu-id="872e8-149">Введите `InsertWithPicture` и нажмите кнопку Готово.</span><span class="sxs-lookup"><span data-stu-id="872e8-149">Enter `InsertWithPicture` and click Finish.</span></span>


<span data-ttu-id="872e8-150">[![Имя нового InsertWithPicture метод адаптера таблицы](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="872e8-150">[![Name the New TableAdapter Method InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.png)</span></span>

<span data-ttu-id="872e8-151">**На рисунке 2**: имя нового метода адаптера таблицы `InsertWithPicture` ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="872e8-151">**Figure 2**: Name the New TableAdapter Method `InsertWithPicture` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.png))</span></span>


## <a name="step-2-updating-the-business-logic-layer"></a><span data-ttu-id="872e8-152">Шаг 2: Обновление уровня бизнес-логики</span><span class="sxs-lookup"><span data-stu-id="872e8-152">Step 2: Updating the Business Logic Layer</span></span>

<span data-ttu-id="872e8-153">Так как уровень представления только должны взаимодействовать с бизнес-логики, а не на обход его, чтобы перейти непосредственно на уровне доступа к данным, необходимо создать метод уровень бизнес-ЛОГИКИ, который вызывает метод DAL, мы только что создали (`InsertWithPicture`).</span><span class="sxs-lookup"><span data-stu-id="872e8-153">Since the Presentation Layer should only interface with the Business Logic Layer rather than bypassing it to go directly to the Data Access Layer, we need to create a BLL method that invokes the DAL method we just created (`InsertWithPicture`).</span></span> <span data-ttu-id="872e8-154">В этом учебнике, создайте метод в `CategoriesBLL` класс с именем `InsertWithPicture` , принимающий в качестве входных данных трех `String` s и `Byte` массива.</span><span class="sxs-lookup"><span data-stu-id="872e8-154">For this tutorial, create a method in the `CategoriesBLL` class named `InsertWithPicture` that accepts as input three `String` s and a `Byte` array.</span></span> <span data-ttu-id="872e8-155">`String` Входные параметры являются категории s имя, описание и путь к файлу брошюр, пока `Byte` массив — для двоичного содержимого рисунка категории s.</span><span class="sxs-lookup"><span data-stu-id="872e8-155">The `String` input parameters are for the category s name, description, and brochure file path, while the `Byte` array is for the binary contents of the category s picture.</span></span> <span data-ttu-id="872e8-156">Как показывает следующий код, этот метод МЕТОДА вызывает соответствующий метод DAL:</span><span class="sxs-lookup"><span data-stu-id="872e8-156">As the following code shows, this BLL method invokes the corresponding DAL method:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample2.vb)]

> [!NOTE]
> <span data-ttu-id="872e8-157">Убедитесь, что вы сохранили типизированного набора данных перед добавлением `InsertWithPicture` метода для МЕТОДА.</span><span class="sxs-lookup"><span data-stu-id="872e8-157">Make sure that you have saved the Typed DataSet before adding the `InsertWithPicture` method to the BLL.</span></span> <span data-ttu-id="872e8-158">Поскольку `CategoriesTableAdapter` код класса создается автоматически в зависимости от типизированного набора данных, если Дон t сначала сохранить изменения в типизированный набор данных `Adapter` свойство выиграл t знать о `InsertWithPicture` метод.</span><span class="sxs-lookup"><span data-stu-id="872e8-158">Since the `CategoriesTableAdapter` class code is auto-generated based on the Typed DataSet, if you don t first save your changes to the Typed DataSet the `Adapter` property won t know about the `InsertWithPicture` method.</span></span>


## <a name="step-3-listing-the-existing-categories-and-their-binary-data"></a><span data-ttu-id="872e8-159">Шаг 3: Создание списков, существующие категории и их двоичные данные</span><span class="sxs-lookup"><span data-stu-id="872e8-159">Step 3: Listing the Existing Categories and their Binary Data</span></span>

<span data-ttu-id="872e8-160">В этом учебнике мы создадим страницы, который позволяет конечным пользователям добавить новую категорию в систему, предоставляя рисунок и брошюр для новой категории.</span><span class="sxs-lookup"><span data-stu-id="872e8-160">In this tutorial we will create a page that allows an end user to add a new category to the system, providing a picture and brochure for the new category.</span></span> <span data-ttu-id="872e8-161">В [предыдущего учебника](displaying-binary-data-in-the-data-web-controls-vb.md) мы использовали GridView с TemplateField и ImageField для отображения каждого имени категории s, описание, изображение и ссылка для загрузки его брошюр.</span><span class="sxs-lookup"><span data-stu-id="872e8-161">In the [preceding tutorial](displaying-binary-data-in-the-data-web-controls-vb.md) we used a GridView with a TemplateField and ImageField to display each category s name, description, picture, and a link to download its brochure.</span></span> <span data-ttu-id="872e8-162">Разрешить s реплицировать эти функциональные возможности в этом учебнике создается страница, которая позволяет для новых создаваемых и перечисляет все существующие категории.</span><span class="sxs-lookup"><span data-stu-id="872e8-162">Let s replicate that functionality for this tutorial, creating a page that both lists all existing categories and allows for new ones to be created.</span></span>

<span data-ttu-id="872e8-163">Сначала откройте `DisplayOrDownload.aspx` страницу `BinaryData` папки.</span><span class="sxs-lookup"><span data-stu-id="872e8-163">Start by opening the `DisplayOrDownload.aspx` page from the `BinaryData` folder.</span></span> <span data-ttu-id="872e8-164">Перейдите в представление источника и скопируйте GridView и ObjectDataSource s декларативного синтаксиса, вставив его в `<asp:Content>` элемент в `UploadInDetailsView.aspx`.</span><span class="sxs-lookup"><span data-stu-id="872e8-164">Go to the Source view and copy the GridView and ObjectDataSource s declarative syntax, pasting it within the `<asp:Content>` element in `UploadInDetailsView.aspx`.</span></span> <span data-ttu-id="872e8-165">Кроме того, не забывайте следует заменять `GenerateBrochureLink` метод из класса кода программной части `DisplayOrDownload.aspx` для `UploadInDetailsView.aspx`.</span><span class="sxs-lookup"><span data-stu-id="872e8-165">Also, don t forget to copy over the `GenerateBrochureLink` method from the code-behind class of `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx`.</span></span>


<span data-ttu-id="872e8-166">[![Скопируйте и вставьте декларативный синтаксис из DisplayOrDownload.aspx UploadInDetailsView.aspx](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="872e8-166">[![Copy and Paste the Declarative Syntax from DisplayOrDownload.aspx to UploadInDetailsView.aspx](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.png)</span></span>

<span data-ttu-id="872e8-167">**Рис. 3**: копирование и вставка декларативный синтаксис из `DisplayOrDownload.aspx` для `UploadInDetailsView.aspx` ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="872e8-167">**Figure 3**: Copy and Paste the Declarative Syntax from `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.png))</span></span>


<span data-ttu-id="872e8-168">После копирования декларативный синтаксис и `GenerateBrochureLink` метод через `UploadInDetailsView.aspx` просмотреть страницу через браузер, чтобы убедиться, что все, что была скопирована по правильно.</span><span class="sxs-lookup"><span data-stu-id="872e8-168">After copying the declarative syntax and `GenerateBrochureLink` method over to the `UploadInDetailsView.aspx` page, view the page through a browser to ensure that everything was copied over correctly.</span></span> <span data-ttu-id="872e8-169">Вы увидите GridView со списком восьми категорий, ссылка на загрузку брошюр и рисунка категории s.</span><span class="sxs-lookup"><span data-stu-id="872e8-169">You should see a GridView listing the eight categories that includes a link to download the brochure as well as the category s picture.</span></span>


<span data-ttu-id="872e8-170">[![Теперь вы увидите каждой категории вместе с его двоичных данных](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="872e8-170">[![You Should Now See Each Category Along with Its Binary Data](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.png)</span></span>

<span data-ttu-id="872e8-171">**Рис. 4**: вы должны теперь см. каждый категории вместе с двоичными данными, его ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="872e8-171">**Figure 4**: You Should Now See Each Category Along with Its Binary Data ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.png))</span></span>


## <a name="step-4-configuring-thecategoriesdatasourceto-support-inserting"></a><span data-ttu-id="872e8-172">Шаг 4: Настройка`CategoriesDataSource`поддержку вставки</span><span class="sxs-lookup"><span data-stu-id="872e8-172">Step 4: Configuring the`CategoriesDataSource`to Support Inserting</span></span>

<span data-ttu-id="872e8-173">`CategoriesDataSource` Используемые ObjectDataSource `Categories` GridView в настоящее время не предоставляет возможность вставки данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-173">The `CategoriesDataSource` ObjectDataSource used by the `Categories` GridView currently does not provide the ability to insert data.</span></span> <span data-ttu-id="872e8-174">Чтобы поддерживает вставку через этот элемент управления источником данных, необходимо сопоставить его `Insert` метода на метод в объекте базовой `CategoriesBLL`.</span><span class="sxs-lookup"><span data-stu-id="872e8-174">In order to support inserting through this data source control, we need to map its `Insert` method to a method in its underlying object, `CategoriesBLL`.</span></span> <span data-ttu-id="872e8-175">В частности, мы хотим сопоставить его с `CategoriesBLL` мы добавили обратно в шаге 2, метод `InsertWithPicture`.</span><span class="sxs-lookup"><span data-stu-id="872e8-175">In particular, we want to map it to the `CategoriesBLL` method we added back in Step 2, `InsertWithPicture`.</span></span>

<span data-ttu-id="872e8-176">Запустить, щелкнув ссылку в смарт-теге s ObjectDataSource настройки источника данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-176">Start by clicking the Configure Data Source link from the ObjectDataSource s smart tag.</span></span> <span data-ttu-id="872e8-177">Первый экран отображается источник данных настроен для работы с, объект `CategoriesBLL`.</span><span class="sxs-lookup"><span data-stu-id="872e8-177">The first screen shows the object the data source is configured to work with, `CategoriesBLL`.</span></span> <span data-ttu-id="872e8-178">Оставьте этот параметр соответствует-— и нажмите кнопку Далее, чтобы перейти на экран задайте методы данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-178">Leave this setting as-is and click Next to advance to the Define Data Methods screen.</span></span> <span data-ttu-id="872e8-179">Перемещение вкладки «Вставка» и выбрать `InsertWithPicture` метода из раскрывающегося списка.</span><span class="sxs-lookup"><span data-stu-id="872e8-179">Move to the INSERT tab and pick the `InsertWithPicture` method from the drop-down list.</span></span> <span data-ttu-id="872e8-180">Нажмите кнопку Готово, чтобы завершить работу мастера.</span><span class="sxs-lookup"><span data-stu-id="872e8-180">Click Finish to complete the wizard.</span></span>


<span data-ttu-id="872e8-181">[![Настройка ObjectDataSource можно использовать метод InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="872e8-181">[![Configure the ObjectDataSource to use the InsertWithPicture Method](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.png)</span></span>

<span data-ttu-id="872e8-182">**Рис. 5**: Настройка ObjectDataSource для использования `InsertWithPicture` метод ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="872e8-182">**Figure 5**: Configure the ObjectDataSource to use the `InsertWithPicture` Method ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.png))</span></span>


> [!NOTE]
> <span data-ttu-id="872e8-183">После завершения работы мастера, Visual Studio может потребоваться, если вы хотите обновить поля и ключи, что приведет к повторному созданию данных Web управляет поля.</span><span class="sxs-lookup"><span data-stu-id="872e8-183">Upon completing the wizard, Visual Studio may ask if you want to Refresh Fields and Keys, which will regenerate the data Web controls fields.</span></span> <span data-ttu-id="872e8-184">Выберите Нет, поскольку Выбор Да перезапишет все настройки полей, возможно, были внесены.</span><span class="sxs-lookup"><span data-stu-id="872e8-184">Choose No, because choosing Yes will overwrite any field customizations you may have made.</span></span>


<span data-ttu-id="872e8-185">По завершении работы мастера ObjectDataSource теперь включают значение для его `InsertMethod` свойства в том числе в `InsertParameters` для столбцов четыре категории, как следующие декларативная разметка показано:</span><span class="sxs-lookup"><span data-stu-id="872e8-185">After completing the wizard, the ObjectDataSource will now include a value for its `InsertMethod` property as well as `InsertParameters` for the four category columns, as the following declarative markup illustrates:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample3.aspx)]

## <a name="step-5-creating-the-inserting-interface"></a><span data-ttu-id="872e8-186">Шаг 5: Создание интерфейса вставки</span><span class="sxs-lookup"><span data-stu-id="872e8-186">Step 5: Creating the Inserting Interface</span></span>

<span data-ttu-id="872e8-187">Впервые охваченных [Обзор Вставка, обновление и удаление данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md), управления DetailsView предоставляет встроенные вставку интерфейс, который можно использовать при работе с элемент управления источником данных, который поддерживает вставку.</span><span class="sxs-lookup"><span data-stu-id="872e8-187">As first covered in the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md), the DetailsView control provides a built-in inserting interface that can be utilized when working with a data source control that supports inserting.</span></span> <span data-ttu-id="872e8-188">Разрешить добавление элемента управления DetailsView на данную страницу над элементом управления GridView, отображающего окончательно свой интерфейс для вставки, позволяя пользователю быстро добавить новую категорию s.</span><span class="sxs-lookup"><span data-stu-id="872e8-188">Let s add a DetailsView control to this page above the GridView that will permanently render its inserting interface, allowing a user to quickly add a new category.</span></span> <span data-ttu-id="872e8-189">После добавления новой категории в DetailsView, GridView под ним будет автоматически обновится и новой категории.</span><span class="sxs-lookup"><span data-stu-id="872e8-189">Upon adding a new category in the DetailsView, the GridView beneath it will automatically refresh and display the new category.</span></span>

<span data-ttu-id="872e8-190">Пуск, перетащив DetailsView из области элементов в конструктор выше GridView, установка его `ID` свойства `NewCategory` и очищая `Height` и `Width` значения свойств.</span><span class="sxs-lookup"><span data-stu-id="872e8-190">Start by dragging a DetailsView from the Toolbox onto the Designer above the GridView, setting its `ID` property to `NewCategory` and clearing out the `Height` and `Width` property values.</span></span> <span data-ttu-id="872e8-191">Смарт-теге s DetailsView, привяжите его к существующему `CategoriesDataSource` и затем установите флажок Разрешить вставку.</span><span class="sxs-lookup"><span data-stu-id="872e8-191">From the DetailsView s smart tag, bind it to the existing `CategoriesDataSource` and then check the Enable Inserting checkbox.</span></span>


<span data-ttu-id="872e8-192">[![Привязка DetailsView CategoriesDataSource и включить вставку](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="872e8-192">[![Bind the DetailsView to the CategoriesDataSource and Enable Inserting](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.png)</span></span>

<span data-ttu-id="872e8-193">**Рис. 6**: привязка DetailsView для `CategoriesDataSource` и разрешить вставку ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="872e8-193">**Figure 6**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image12.png))</span></span>


<span data-ttu-id="872e8-194">Преобразовываемое DetailsView в свой интерфейс для вставки без возможности восстановления, задать его `DefaultMode` свойства `Insert`.</span><span class="sxs-lookup"><span data-stu-id="872e8-194">To permanently render the DetailsView in its inserting interface, set its `DefaultMode` property to `Insert`.</span></span>

<span data-ttu-id="872e8-195">Обратите внимание, что DetailsView пять стояли `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, и `BrochurePath` хотя `CategoryID` BoundField не отображается в интерфейсе вставки, так как его `InsertVisible` свойство имеет значение `False`.</span><span class="sxs-lookup"><span data-stu-id="872e8-195">Note that the DetailsView has five BoundFields `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, and `BrochurePath` although the `CategoryID` BoundField is not rendered in the inserting interface because its `InsertVisible` property is set to `False`.</span></span> <span data-ttu-id="872e8-196">Эти стояли существует, поскольку они являются столбцы, возвращенные `GetCategories()` метод, который является ObjectDataSource вызывает для извлечения данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-196">These BoundFields exists because they are the columns returned by the `GetCategories()` method, which is what the ObjectDataSource invokes to retrieve its data.</span></span> <span data-ttu-id="872e8-197">Для вставки, тем не менее, мы не хотите t требуется позволяет пользователю задать значение для `NumberOfProducts`.</span><span class="sxs-lookup"><span data-stu-id="872e8-197">For inserting, however, we don t want to let the user specify a value for `NumberOfProducts`.</span></span> <span data-ttu-id="872e8-198">Кроме того необходимо разрешить им отправить изображение для новой категории, а также отправить PDF-ФАЙЛ для брошюр.</span><span class="sxs-lookup"><span data-stu-id="872e8-198">Moreover, we need to allow them to upload a picture for the new category as well as upload a PDF for the brochure.</span></span>

<span data-ttu-id="872e8-199">Удалить `NumberOfProducts` BoundField из полностью DetailsView и обновите `HeaderText` свойства `CategoryName` и `BrochurePath` стояли к категории и брошюр, соответственно.</span><span class="sxs-lookup"><span data-stu-id="872e8-199">Remove the `NumberOfProducts` BoundField from the DetailsView altogether and then update the `HeaderText` properties of the `CategoryName` and `BrochurePath` BoundFields to Category and Brochure, respectively.</span></span> <span data-ttu-id="872e8-200">Затем преобразуйте `BrochurePath` BoundField в TemplateField и добавить новый TemplateField для изображения, предоставляя этот новый TemplateField `HeaderText` значение изображения.</span><span class="sxs-lookup"><span data-stu-id="872e8-200">Next, convert the `BrochurePath` BoundField into a TemplateField and add a new TemplateField for the picture, giving this new TemplateField a `HeaderText` value of Picture.</span></span> <span data-ttu-id="872e8-201">Переместить `Picture` TemplateField, чтобы оно было между `BrochurePath` TemplateField и CommandField.</span><span class="sxs-lookup"><span data-stu-id="872e8-201">Move the `Picture` TemplateField so that it is between the `BrochurePath` TemplateField and CommandField.</span></span>


![Привязка DetailsView CategoriesDataSource и включить вставку](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image7.gif)

<span data-ttu-id="872e8-203">**Рис. 7**: привязка DetailsView для `CategoriesDataSource` и включить вставку</span><span class="sxs-lookup"><span data-stu-id="872e8-203">**Figure 7**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting</span></span>


<span data-ttu-id="872e8-204">Если был преобразован `BrochurePath` включает TemplateField BoundField в TemplateField через диалоговое окно Изменить поля `ItemTemplate`, `EditItemTemplate`, и `InsertItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="872e8-204">If you converted the `BrochurePath` BoundField into a TemplateField through the Edit Fields dialog box, the TemplateField includes an `ItemTemplate`, `EditItemTemplate`, and `InsertItemTemplate`.</span></span> <span data-ttu-id="872e8-205">Только `InsertItemTemplate` — необходимые, тем не менее, поэтому вы можете удалить другие шаблоны.</span><span class="sxs-lookup"><span data-stu-id="872e8-205">Only the `InsertItemTemplate` is needed, however, so feel free to remove the other two templates.</span></span> <span data-ttu-id="872e8-206">На этом этапе декларативный синтаксис s DetailsView должен выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="872e8-206">At this point your DetailsView s declarative syntax should look like the following:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample4.aspx)]

## <a name="adding-fileupload-controls-for-the-brochure-and-picture-fields"></a><span data-ttu-id="872e8-207">Добавление элементов управления FileUpload рисунок полей и брошюр</span><span class="sxs-lookup"><span data-stu-id="872e8-207">Adding FileUpload Controls for the Brochure and Picture Fields</span></span>

<span data-ttu-id="872e8-208">В настоящее время `BrochurePath` TemplateField s `InsertItemTemplate` содержит текстовое поле, пока `Picture` TemplateField не содержит какие-либо шаблоны.</span><span class="sxs-lookup"><span data-stu-id="872e8-208">Presently, the `BrochurePath` TemplateField s `InsertItemTemplate` contains a TextBox, while the `Picture` TemplateField does not contain any templates.</span></span> <span data-ttu-id="872e8-209">Необходимо обновить эти два s TemplateField `InsertItemTemplate` для использования элементов управления FileUpload.</span><span class="sxs-lookup"><span data-stu-id="872e8-209">We need to update these two TemplateField s `InsertItemTemplate` s to use FileUpload controls.</span></span>

<span data-ttu-id="872e8-210">В смарт-теге s DetailsView, выберите параметр редактирование шаблонов, а затем выберите `BrochurePath` TemplateField s `InsertItemTemplate` из раскрывающегося списка.</span><span class="sxs-lookup"><span data-stu-id="872e8-210">From the DetailsView s smart tag, choose the Edit Templates option and then select the `BrochurePath` TemplateField s `InsertItemTemplate` from the drop-down list.</span></span> <span data-ttu-id="872e8-211">Удалите текстовое поле и перетащите элемент управления FileUpload из области элементов в шаблон.</span><span class="sxs-lookup"><span data-stu-id="872e8-211">Remove the TextBox and then drag a FileUpload control from the Toolbox into the template.</span></span> <span data-ttu-id="872e8-212">Настройка управления FileUpload s `ID` для `BrochureUpload`.</span><span class="sxs-lookup"><span data-stu-id="872e8-212">Set the FileUpload control s `ID` to `BrochureUpload`.</span></span> <span data-ttu-id="872e8-213">Аналогичным образом добавить элемент управления FileUpload `Picture` TemplateField s `InsertItemTemplate`.</span><span class="sxs-lookup"><span data-stu-id="872e8-213">Similarly, add a FileUpload control to the `Picture` TemplateField s `InsertItemTemplate`.</span></span> <span data-ttu-id="872e8-214">Установить этот элемент управления FileUpload s `ID` для `PictureUpload`.</span><span class="sxs-lookup"><span data-stu-id="872e8-214">Set this FileUpload control s `ID` to `PictureUpload`.</span></span>


<span data-ttu-id="872e8-215">[![Добавление элемента управления FileUpload InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="872e8-215">[![Add a FileUpload Control to the InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image13.png)</span></span>

<span data-ttu-id="872e8-216">**Рис. 8**: добавить элемент управления FileUpload `InsertItemTemplate` ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="872e8-216">**Figure 8**: Add a FileUpload Control to the `InsertItemTemplate` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image14.png))</span></span>


<span data-ttu-id="872e8-217">После внесения этих изменений, будет две TemplateField s декларативный синтаксис:</span><span class="sxs-lookup"><span data-stu-id="872e8-217">After making these additions, the two TemplateField s declarative syntax will be:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample5.aspx)]

<span data-ttu-id="872e8-218">Пользователь добавляет новую категорию, мы хотим обеспечить брошюр и рисунка типа правильный файл.</span><span class="sxs-lookup"><span data-stu-id="872e8-218">When a user adds a new category, we want to ensure that the brochure and picture are of the correct file type.</span></span> <span data-ttu-id="872e8-219">Чтобы брошюр пользователь должен предоставить PDF-файла.</span><span class="sxs-lookup"><span data-stu-id="872e8-219">For the brochure, the user must supply a PDF.</span></span> <span data-ttu-id="872e8-220">Для изображения, нам необходимо пользователю загружать файл изображения, но мы позволяют выполнять *любой* образа файла или только файлы изображений определенного типа, такие как изображений GIF или JPGs?</span><span class="sxs-lookup"><span data-stu-id="872e8-220">For the picture, we need the user to upload an image file, but do we allow *any* image file or only image files of a particular type, such as GIFs or JPGs?</span></span> <span data-ttu-id="872e8-221">Чтобы разрешить для различных типов файлов, d необходимо расширить `Categories` схемы, включающие столбец, который записывает тип файлов, чтобы этот тип может быть отправлен клиенту через `Response.ContentType` в `DisplayCategoryPicture.aspx`.</span><span class="sxs-lookup"><span data-stu-id="872e8-221">In order to allow for different file types, we d need to extend the `Categories` schema to include a column that captures the file type so that this type can be sent to the client through `Response.ContentType` in `DisplayCategoryPicture.aspx`.</span></span> <span data-ttu-id="872e8-222">Поскольку мы не хотите t имеют такой столбец, было бы разумным шагом будет ограничен только указание типа файла определенного образа.</span><span class="sxs-lookup"><span data-stu-id="872e8-222">Since we don t have such a column, it would be prudent to restrict users to only providing a specific image file type.</span></span> <span data-ttu-id="872e8-223">`Categories` Изображения в существующей таблице s точечных рисунков, а JPGs — формате файла больше подходит для изображений, обслуживаемых через Интернет.</span><span class="sxs-lookup"><span data-stu-id="872e8-223">The `Categories` table s existing images are bitmaps, but JPGs are a more appropriate file format for images served over the web.</span></span>

<span data-ttu-id="872e8-224">Если пользователь загружает неправильный тип, необходимо отменить вставку и отображать сообщение с описанием проблемы.</span><span class="sxs-lookup"><span data-stu-id="872e8-224">If a user uploads an incorrect file type, we need to cancel the insert and display a message indicating the problem.</span></span> <span data-ttu-id="872e8-225">Добавьте веб-управления Label под DetailsView.</span><span class="sxs-lookup"><span data-stu-id="872e8-225">Add a Label Web control beneath the DetailsView.</span></span> <span data-ttu-id="872e8-226">Задайте его `ID` свойства `UploadWarning`снимите out его `Text` , установите `CssClass` свойства на "Предупреждение" и `Visible` и `EnableViewState` свойства `False`.</span><span class="sxs-lookup"><span data-stu-id="872e8-226">Set its `ID` property to `UploadWarning`, clear out its `Text` property, set the `CssClass` property to Warning, and the `Visible` and `EnableViewState` properties to `False`.</span></span> <span data-ttu-id="872e8-227">`Warning` Определяется класс CSS в `Styles.css` и отображает текст в большой, красный, выделены курсивом, полужирный шрифт.</span><span class="sxs-lookup"><span data-stu-id="872e8-227">The `Warning` CSS class is defined in `Styles.css` and renders the text in a large, red, italicized, bold font.</span></span>

> [!NOTE]
> <span data-ttu-id="872e8-228">В идеальном случае `CategoryName` и `Description` стояли будет преобразована в TemplateFields и их вставка интерфейсы, настроенные.</span><span class="sxs-lookup"><span data-stu-id="872e8-228">Ideally, the `CategoryName` and `Description` BoundFields would be converted to TemplateFields and their inserting interfaces customized.</span></span> <span data-ttu-id="872e8-229">`Description` Вставка интерфейса, например, будет скорее всего будет лучше подходят через многострочного текстового поля.</span><span class="sxs-lookup"><span data-stu-id="872e8-229">The `Description` inserting interface, for example, would likely be better suited through a multi-line textbox.</span></span> <span data-ttu-id="872e8-230">И, поскольку `CategoryName` столбец не принимает `NULL` значения, RequiredFieldValidator должны быть добавлены, чтобы пользователь предоставляет значение для нового имени категории s.</span><span class="sxs-lookup"><span data-stu-id="872e8-230">And since the `CategoryName` column does not accept `NULL` values, a RequiredFieldValidator should be added to ensure the user provides a value for the new category s name.</span></span> <span data-ttu-id="872e8-231">Эти действия остаются в качестве упражнения для средства чтения.</span><span class="sxs-lookup"><span data-stu-id="872e8-231">These steps are left as an exercise to the reader.</span></span> <span data-ttu-id="872e8-232">Обращаться к [Настройка интерфейса изменения данных](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md) подробное рассмотрение дополнения интерфейсы модификации данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-232">Refer back to [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-vb.md) for an in-depth look at augmenting the data modification interfaces.</span></span>


## <a name="step-6-saving-the-uploaded-brochure-to-the-web-server-s-file-system"></a><span data-ttu-id="872e8-233">Шаг 6: Сохранение переданные брошюр файловую систему Web Server s</span><span class="sxs-lookup"><span data-stu-id="872e8-233">Step 6: Saving the Uploaded Brochure to the Web Server s File System</span></span>

<span data-ttu-id="872e8-234">Когда пользователь вводит значения для новой категории и нажимает кнопку "Добавить", обратная передача и вставку рабочего процесса развертывания.</span><span class="sxs-lookup"><span data-stu-id="872e8-234">When the user enters the values for a new category and clicks the Insert button, a postback occurs and the inserting workflow unfolds.</span></span> <span data-ttu-id="872e8-235">Во-первых, DetailsView s [ `ItemInserting` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx) активируется.</span><span class="sxs-lookup"><span data-stu-id="872e8-235">First, the DetailsView s [`ItemInserting` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx) fires.</span></span> <span data-ttu-id="872e8-236">Далее, ObjectDataSource s `Insert()` вызывается метод, что приводит к новой записи, добавляемые `Categories` таблицы.</span><span class="sxs-lookup"><span data-stu-id="872e8-236">Next, the ObjectDataSource s `Insert()` method is invoked, which results in a new record being added to the `Categories` table.</span></span> <span data-ttu-id="872e8-237">После этого DetailsView s [ `ItemInserted` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx) активируется.</span><span class="sxs-lookup"><span data-stu-id="872e8-237">After that, the DetailsView s [`ItemInserted` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx) fires.</span></span>

<span data-ttu-id="872e8-238">Прежде чем ObjectDataSource s `Insert()` вызывается метод, необходимо сначала убедитесь, что соответствующий файл типы были отправлены пользователем и сохраните брошюр PDF в web server s файловую систему.</span><span class="sxs-lookup"><span data-stu-id="872e8-238">Before the ObjectDataSource s `Insert()` method is invoked, we must first ensure that the appropriate file types were uploaded by the user and then save the brochure PDF to the web server s file system.</span></span> <span data-ttu-id="872e8-239">Создайте обработчик событий для DetailsView s `ItemInserting` событий и добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="872e8-239">Create an event handler for the DetailsView s `ItemInserting` event and add the following code:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample6.vb)]

<span data-ttu-id="872e8-240">Запускает обработчик событий с помощью ссылки на `BrochureUpload` FileUpload управления на основе шаблонов s DetailsView.</span><span class="sxs-lookup"><span data-stu-id="872e8-240">The event handler starts by referencing the `BrochureUpload` FileUpload control from the DetailsView s templates.</span></span> <span data-ttu-id="872e8-241">Затем если передал брошюр проверяется расширения s отправленного файла.</span><span class="sxs-lookup"><span data-stu-id="872e8-241">Then, if a brochure has been uploaded, the uploaded file s extension is examined.</span></span> <span data-ttu-id="872e8-242">Если расширение не является. PDF, затем предупреждение отображается, операция вставки отменяется и окончания выполнения обработчика событий.</span><span class="sxs-lookup"><span data-stu-id="872e8-242">If the extension is not .PDF, then a warning is displayed, the insert is cancelled, and the execution of the event handler ends.</span></span>

> [!NOTE]
> <span data-ttu-id="872e8-243">Полагаться на расширение s отправленный файл не надежный способ обеспечения загруженный файл PDF-документ.</span><span class="sxs-lookup"><span data-stu-id="872e8-243">Relying on the uploaded file s extension is not a sure-fire technique for ensuring that the uploaded file is a PDF document.</span></span> <span data-ttu-id="872e8-244">На компьютере может быть допустимым PDF-документ с расширением `.Brochure`, или может выполнено без PDF-документ и предоставить ему `.pdf` расширения.</span><span class="sxs-lookup"><span data-stu-id="872e8-244">The user could have a valid PDF document with the extension `.Brochure`, or could have taken a non-PDF document and given it a `.pdf` extension.</span></span> <span data-ttu-id="872e8-245">Двоичное содержимое файла s потребуется программным образом проверить, чтобы более окончательно определить тип файла.</span><span class="sxs-lookup"><span data-stu-id="872e8-245">The file s binary content would need to be programmatically examined in order to more conclusively verify the file type.</span></span> <span data-ttu-id="872e8-246">Такие тщательного подхода, часто являются избыточным; Проверка расширения достаточно для большинства сценариев.</span><span class="sxs-lookup"><span data-stu-id="872e8-246">Such thorough approaches, though, are often overkill; checking the extension is sufficient for most scenarios.</span></span>


<span data-ttu-id="872e8-247">Как было сказано в [передачи файлов](uploading-files-vb.md) учебника, необходимо соблюдать осторожность при сохранении файлов в файловой системе, этой отправки одного пользователя s не перезаписывает другой s.</span><span class="sxs-lookup"><span data-stu-id="872e8-247">As discussed in the [Uploading Files](uploading-files-vb.md) tutorial, care must be taken when saving files to the file system so that one user s upload does not overwrite another s.</span></span> <span data-ttu-id="872e8-248">В этом учебнике мы будет пытаться использовать то же имя отправленного файла.</span><span class="sxs-lookup"><span data-stu-id="872e8-248">For this tutorial we will attempt to use the same name as the uploaded file.</span></span> <span data-ttu-id="872e8-249">Если уже существует файл в `~/Brochures` каталога с этой же именем, однако мы будем добавляется число в конце пока не будет найдено уникальное имя.</span><span class="sxs-lookup"><span data-stu-id="872e8-249">If there already exists a file in the `~/Brochures` directory with that same file name, however, we'll append a number at the end until a unique name is found.</span></span> <span data-ttu-id="872e8-250">Например, если пользователь отправляет брошюр файл с именем `Meats.pdf`, но уже существует файл с именем `Meats.pdf` в `~/Brochures` папки, мы изменим имя сохраненного файла `Meats-1.pdf`.</span><span class="sxs-lookup"><span data-stu-id="872e8-250">For example, if the user uploads a brochure file named `Meats.pdf`, but there is already a file named `Meats.pdf` in the `~/Brochures` folder, we'll change the saved file name to `Meats-1.pdf`.</span></span> <span data-ttu-id="872e8-251">Если, существует, мы попытаемся `Meats-2.pdf`, и т. д., пока не будет найдено уникальное имя файла.</span><span class="sxs-lookup"><span data-stu-id="872e8-251">If that exists, we'll try `Meats-2.pdf`, and so on, until a unique file name is found.</span></span>

<span data-ttu-id="872e8-252">В следующем коде используется [ `File.Exists(path)` метод](https://msdn.microsoft.com/library/system.io.file.exists.aspx) для определения того, существует ли файл с указанным именем файла.</span><span class="sxs-lookup"><span data-stu-id="872e8-252">The following code uses the [`File.Exists(path)` method](https://msdn.microsoft.com/library/system.io.file.exists.aspx) to determine if a file already exists with the specified file name.</span></span> <span data-ttu-id="872e8-253">В этом случае он продолжает повторите новые имена файлов для брошюр, пока не будет обнаружен конфликт.</span><span class="sxs-lookup"><span data-stu-id="872e8-253">If so, it continues to try new file names for the brochure until no conflict is found.</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample7.vb)]

<span data-ttu-id="872e8-254">После обнаружения допустимое имя файла, файл необходимо сохранить в файловой системе и ObjectDataSource s `brochurePath``InsertParameter` значения должен быть обновлен, чтобы это имя файла записывается в базу данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-254">Once a valid file name has been found, the file needs to be saved to the file system and the ObjectDataSource s `brochurePath``InsertParameter` value needs to be updated so that this file name is written to the database.</span></span> <span data-ttu-id="872e8-255">Как мы видели в *передачи файлов* учебника, можно сохранить файл с помощью элемента управления FileUpload s `SaveAs(path)` метод.</span><span class="sxs-lookup"><span data-stu-id="872e8-255">As we saw back in the *Uploading Files* tutorial, the file can be saved using the FileUpload control s `SaveAs(path)` method.</span></span> <span data-ttu-id="872e8-256">Чтобы обновить ObjectDataSource s `brochurePath` параметра, используйте `e.Values` коллекции.</span><span class="sxs-lookup"><span data-stu-id="872e8-256">To update the ObjectDataSource s `brochurePath` parameter, use the `e.Values` collection.</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample8.vb)]

## <a name="step-7-saving-the-uploaded-picture-to-the-database"></a><span data-ttu-id="872e8-257">Шаг 7: Сохранение переданные изображения в базе данных</span><span class="sxs-lookup"><span data-stu-id="872e8-257">Step 7: Saving the Uploaded Picture to the Database</span></span>

<span data-ttu-id="872e8-258">Для сохранения загруженного изображения в новом `Categories` записи, нам нужно назначить передаваемого содержимого двоичного ObjectDataSource s `picture` параметр в DetailsView s `ItemInserting` событий.</span><span class="sxs-lookup"><span data-stu-id="872e8-258">To store the uploaded picture in the new `Categories` record, we need to assign the uploaded binary content to the ObjectDataSource s `picture` parameter in the DetailsView s `ItemInserting` event.</span></span> <span data-ttu-id="872e8-259">Перед внесением этого назначения, тем не менее, необходимо сначала убедитесь, что переданный изображен JPG и не некоторый другой тип изображения.</span><span class="sxs-lookup"><span data-stu-id="872e8-259">Before we make this assignment, however, we need to first make sure that the uploaded picture is a JPG and not some other image type.</span></span> <span data-ttu-id="872e8-260">Как показано в шаге 6 позволяют использовать расширение файла s отправленного изображения, чтобы выяснить его тип s.</span><span class="sxs-lookup"><span data-stu-id="872e8-260">As in Step 6, let s use the uploaded picture s file extension to ascertain its type.</span></span>

<span data-ttu-id="872e8-261">Хотя `Categories` таблица позволяет `NULL` значения `Picture` изображение имеет столбец, в данный момент все категории.</span><span class="sxs-lookup"><span data-stu-id="872e8-261">While the `Categories` table allows `NULL` values for the `Picture` column, all categories currently have a picture.</span></span> <span data-ttu-id="872e8-262">Разрешить s предложить пользователю вводить рисунок, при добавлении новой категории через эту страницу.</span><span class="sxs-lookup"><span data-stu-id="872e8-262">Let s force the user to provide a picture when adding a new category through this page.</span></span> <span data-ttu-id="872e8-263">Следующий код проверяет, рисунок отправлен и что он имеет соответствующее расширение.</span><span class="sxs-lookup"><span data-stu-id="872e8-263">The following code checks to ensure that a picture has been uploaded and that it has an appropriate extension.</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample9.vb)]

<span data-ttu-id="872e8-264">Этот код следует разместить *перед* кода из шага 6, чтобы в случае проблемы с передачей рисунок обработчик событий будет завершена перед брошюр файл сохраняется в файловой системе.</span><span class="sxs-lookup"><span data-stu-id="872e8-264">This code should be placed *before* the code from Step 6 so that if there is a problem with the picture upload, the event handler will terminate before the brochure file is saved to the file system.</span></span>

<span data-ttu-id="872e8-265">Предположим, что соответствующий файл был загружен, назначьте передаваемого содержимого двоичного s значение параметра рисунок с следующую строку кода:</span><span class="sxs-lookup"><span data-stu-id="872e8-265">Assuming that an appropriate file has been uploaded, assign the uploaded binary content to the picture parameter s value with the following line of code:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample10.vb)]

## <a name="the-completeiteminsertingevent-handler"></a><span data-ttu-id="872e8-266">Полный`ItemInserting`обработчика событий</span><span class="sxs-lookup"><span data-stu-id="872e8-266">The Complete`ItemInserting`Event Handler</span></span>

<span data-ttu-id="872e8-267">Для полноты информации, вот `ItemInserting` обработчик событий в полном объеме:</span><span class="sxs-lookup"><span data-stu-id="872e8-267">For completeness, here is the `ItemInserting` event handler in its entirety:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample11.vb)]

## <a name="step-8-fixing-thedisplaycategorypictureaspxpage"></a><span data-ttu-id="872e8-268">Шаг 8: Исправления`DisplayCategoryPicture.aspx`страницы</span><span class="sxs-lookup"><span data-stu-id="872e8-268">Step 8: Fixing the`DisplayCategoryPicture.aspx`Page</span></span>

<span data-ttu-id="872e8-269">Let s занять некоторое время для тестирования интерфейса вставки и `ItemInserting` обработчик событий, который был создан в последних шагах.</span><span class="sxs-lookup"><span data-stu-id="872e8-269">Let s take a moment to test out the inserting interface and `ItemInserting` event handler that was created over the last few steps.</span></span> <span data-ttu-id="872e8-270">Посетите `UploadInDetailsView.aspx` постраничного просмотра обозревателя и попытаться добавить категорию, но не указывается рисунок, или указать рисунок не JPG или брошюр не PDF.</span><span class="sxs-lookup"><span data-stu-id="872e8-270">Visit the `UploadInDetailsView.aspx` page through a browser and attempt to add a category, but omit the picture, or specify a non-JPG picture or a non-PDF brochure.</span></span> <span data-ttu-id="872e8-271">В каждом из этих случаев отображается сообщение об ошибке и вставки рабочего процесса отменено.</span><span class="sxs-lookup"><span data-stu-id="872e8-271">In any of these cases, an error message will be displayed and the insert workflow cancelled.</span></span>


<span data-ttu-id="872e8-272">[![Предупреждение будет отображаться, если передается недопустимый тип файла](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="872e8-272">[![A Warning Message is Displayed If an Invalid File Type is Uploaded](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image15.png)</span></span>

<span data-ttu-id="872e8-273">**Рис. 9**: предупреждение будет отображаться, если передается недопустимый тип файла ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="872e8-273">**Figure 9**: A Warning Message is Displayed If an Invalid File Type is Uploaded ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image16.png))</span></span>


<span data-ttu-id="872e8-274">После проверки страницы требуется рисунок для отправки и реализованных t принимать файлы не PDF или не JPG, добавить новую категорию с недопустимым изображением JPG, если оставить поле брошюр пустым.</span><span class="sxs-lookup"><span data-stu-id="872e8-274">Once you have verified that the page requires a picture to be uploaded and won t accept non-PDF or non-JPG files, add a new category with a valid JPG picture, leaving the Brochure field empty.</span></span> <span data-ttu-id="872e8-275">После нажатия кнопки "Добавить", будет обратной передачи страницы и новые записи будут добавлены `Categories` таблицу с двоичное содержимое отправленного изображения s хранятся непосредственно в базе данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-275">After clicking the Insert button, the page will postback and a new record will be added to the `Categories` table with the uploaded image s binary contents stored directly in the database.</span></span> <span data-ttu-id="872e8-276">GridView обновляется и показана строка для вновь добавленного категории, но, как показано на рис. 10, новый рисунок s категории, отображается неправильно.</span><span class="sxs-lookup"><span data-stu-id="872e8-276">The GridView is updated and shows a row for the newly added category, but, as Figure 10 shows, the new category s picture is not rendered correctly.</span></span>


<span data-ttu-id="872e8-277">[![Новая категория s изображение не отображается.](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="872e8-277">[![The New Category s Picture is not Displayed](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image17.png)</span></span>

<span data-ttu-id="872e8-278">**Рис. 10**: s новой категории не изображения ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="872e8-278">**Figure 10**: The New Category s Picture is not Displayed ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image18.png))</span></span>


<span data-ttu-id="872e8-279">Новое изображение не отображается, так как `DisplayCategoryPicture.aspx` страницу, которая возвращает рисунок указанной категории s настроена для обработки точечных рисунков, который содержит заголовка OLE.</span><span class="sxs-lookup"><span data-stu-id="872e8-279">The reason the new picture is not displayed is because the `DisplayCategoryPicture.aspx` page that returns a specified category s picture is configured to process bitmaps that have an OLE header.</span></span> <span data-ttu-id="872e8-280">Этот заголовок 78 байтов исключается из `Picture` столбец s двоичное содержимое перед их отправкой обратно клиенту.</span><span class="sxs-lookup"><span data-stu-id="872e8-280">This 78 byte header is stripped from the `Picture` column s binary contents before they are sent back to the client.</span></span> <span data-ttu-id="872e8-281">Но JPG-файл, только что загруженном для новой категории не содержат этот заголовок OLE; Таким образом допустимый, необходимые байт удаляются из двоичных данных изображения s.</span><span class="sxs-lookup"><span data-stu-id="872e8-281">But the JPG file we just uploaded for the new category does not have this OLE header; therefore, valid, necessary bytes are being removed from the image s binary data.</span></span>

<span data-ttu-id="872e8-282">Поскольку теперь существует как растровые изображения с заголовками OLE и JPGs в `Categories` таблицы, необходимо обновить `DisplayCategoryPicture.aspx` , чтобы он не чередует для исходного восьми категорий заголовка OLE и пропускает этот чередует новые записи из категории.</span><span class="sxs-lookup"><span data-stu-id="872e8-282">Since there are now both bitmaps with OLE headers and JPGs in the `Categories` table, we need to update `DisplayCategoryPicture.aspx` so that it does the OLE header stripping for the original eight categories and bypasses this stripping for the newer category records.</span></span> <span data-ttu-id="872e8-283">В нашем следующем уроке мы изучим, как обновить существующий образ записи s, и мы обновим все старые категории изображения, чтобы они были JPGs.</span><span class="sxs-lookup"><span data-stu-id="872e8-283">In our next tutorial we'll examine how to update an existing record s image, and we'll update all of the old category pictures so that they are JPGs.</span></span> <span data-ttu-id="872e8-284">На данном этапе, используйте следующий код в `DisplayCategoryPicture.aspx` для удаления только заголовки OLE исходного восьми категорий:</span><span class="sxs-lookup"><span data-stu-id="872e8-284">For now, though, use the following code in `DisplayCategoryPicture.aspx` to strip the OLE headers only for those original eight categories:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample12.vb)]

<span data-ttu-id="872e8-285">Благодаря этому изменению JPG изображения теперь отображаются правильно в GridView.</span><span class="sxs-lookup"><span data-stu-id="872e8-285">With this change, the JPG image is now rendered correctly in the GridView.</span></span>


<span data-ttu-id="872e8-286">[![JPG для новых категорий являются правильно к просмотру](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="872e8-286">[![The JPG Images for New Categories are Correctly Rendered](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image19.png)</span></span>

<span data-ttu-id="872e8-287">**Рис. 11**: изображений JPG для новых категорий являются правильно к просмотру ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="872e8-287">**Figure 11**: The JPG Images for New Categories are Correctly Rendered ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-vb/_static/image20.png))</span></span>


## <a name="step-9-deleting-the-brochure-in-the-face-of-an-exception"></a><span data-ttu-id="872e8-288">Шаг 9: Удаление брошюр при возникновении исключения</span><span class="sxs-lookup"><span data-stu-id="872e8-288">Step 9: Deleting the Brochure in the Face of an Exception</span></span>

<span data-ttu-id="872e8-289">Одна из проблем для хранения двоичных данных в файловой системе web server s является появляется запрос на отключение от модели данных и двоичные данные.</span><span class="sxs-lookup"><span data-stu-id="872e8-289">One of the challenges of storing binary data on the web server s file system is that it introduces a disconnect between the data model and its binary data.</span></span> <span data-ttu-id="872e8-290">Таким образом при удалении записи соответствующих двоичных данных в файловой системе, необходимо также удалить.</span><span class="sxs-lookup"><span data-stu-id="872e8-290">Therefore, whenever a record is deleted, the corresponding binary data on the file system must also be removed.</span></span> <span data-ttu-id="872e8-291">При вставке, а также могут поступить в игру.</span><span class="sxs-lookup"><span data-stu-id="872e8-291">This can come into play when inserting, as well.</span></span> <span data-ttu-id="872e8-292">Рассмотрим следующий сценарий: пользователь добавляет новую категорию, указав допустимое изображение и брошюр.</span><span class="sxs-lookup"><span data-stu-id="872e8-292">Consider the following scenario: a user adds a new category, specifying a valid picture and brochure.</span></span> <span data-ttu-id="872e8-293">Нажмите кнопку "Добавить" обратная передача и DetailsView s `ItemInserting` вызывается событие, сохранение брошюр в файловой системе сервера s web.</span><span class="sxs-lookup"><span data-stu-id="872e8-293">Upon clicking the Insert button, a postback occurs and the DetailsView s `ItemInserting` event fires, saving the brochure to the web server s file system.</span></span> <span data-ttu-id="872e8-294">Далее, ObjectDataSource s `Insert()` вызывается метод, который вызывает `CategoriesBLL` класса s `InsertWithPicture` метод, который вызывает `CategoriesTableAdapter` s `InsertWithPicture` метод.</span><span class="sxs-lookup"><span data-stu-id="872e8-294">Next, the ObjectDataSource s `Insert()` method is invoked, which calls the `CategoriesBLL` class s `InsertWithPicture` method, which calls the `CategoriesTableAdapter` s `InsertWithPicture` method.</span></span>

<span data-ttu-id="872e8-295">Теперь, что произойдет, если база данных находится в автономном режиме или если имеется ошибка в `INSERT` инструкции SQL?</span><span class="sxs-lookup"><span data-stu-id="872e8-295">Now, what happens if the database is offline, or if there is an error in the `INSERT` SQL statement?</span></span> <span data-ttu-id="872e8-296">Четко операция вставки завершится ошибкой, поэтому нет новой категории строки будут добавляться в базу данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-296">Clearly the INSERT will fail, so no new category row will be added to the database.</span></span> <span data-ttu-id="872e8-297">Но мы по-прежнему брошюр загруженный файл, расположенный в файловой системе web server s!</span><span class="sxs-lookup"><span data-stu-id="872e8-297">But we still have the uploaded brochure file sitting on the web server s file system!</span></span> <span data-ttu-id="872e8-298">Этот файл должен удаляться при возникновении исключения во время вставки рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="872e8-298">This file needs to be deleted in the face of an exception during the inserting workflow.</span></span>

<span data-ttu-id="872e8-299">Как было описано ранее в [обработки уровень бизнес-ЛОГИКИ и исключения уровня DAL на странице ASP.NET](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md) учебник, когда порождено исключение в глубине архитектуры, его полученной через различные уровни.</span><span class="sxs-lookup"><span data-stu-id="872e8-299">As discussed previously in the [Handling BLL- and DAL-Level Exceptions in an ASP.NET Page](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-vb.md) tutorial, when an exception is thrown from within the depths of the architecture it is bubbled up through the various layers.</span></span> <span data-ttu-id="872e8-300">На уровне представления, можно определить Если возникло исключение из DetailsView s `ItemInserted` событий.</span><span class="sxs-lookup"><span data-stu-id="872e8-300">At the Presentation Layer, we can determine if an exception has occurred from the DetailsView s `ItemInserted` event.</span></span> <span data-ttu-id="872e8-301">Этот обработчик событий также предоставляет значения ObjectDataSource s `InsertParameters`.</span><span class="sxs-lookup"><span data-stu-id="872e8-301">This event handler also provides the values of the ObjectDataSource s `InsertParameters`.</span></span> <span data-ttu-id="872e8-302">Таким образом, можно создать обработчик событий для `ItemInserted` событие, которое проверяет, если возникло исключение и если да, удаляет файл, указанный параметром ObjectDataSource s `brochurePath` параметр:</span><span class="sxs-lookup"><span data-stu-id="872e8-302">Therefore, we can create an event handler for the `ItemInserted` event that checks if there was an exception and, if so, deletes the file specified by the ObjectDataSource s `brochurePath` parameter:</span></span>


[!code-vb[Main](including-a-file-upload-option-when-adding-a-new-record-vb/samples/sample13.vb)]

## <a name="summary"></a><span data-ttu-id="872e8-303">Сводка</span><span class="sxs-lookup"><span data-stu-id="872e8-303">Summary</span></span>

<span data-ttu-id="872e8-304">Существует ряд действий, которые должны быть выполнены для предоставления веб-интерфейса для добавления записи, которые содержат двоичные данные.</span><span class="sxs-lookup"><span data-stu-id="872e8-304">There are a number of steps that must be performed in order to provide a web-based interface for adding records that include binary data.</span></span> <span data-ttu-id="872e8-305">Если двоичные данные хранятся непосредственно в базу данных, скорее всего, вам потребуется обновить архитектуру, добавления определенных методов для обработки случая вставки двоичных данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-305">If the binary data is being stored directly into the database, chances are you'll need to update the architecture, adding specific methods to handle the case where binary data is being inserted.</span></span> <span data-ttu-id="872e8-306">После обновления архитектуру, следующим шагом является создание вставку интерфейс, который может выполняться с помощью DetailsView, настроенного для включения элемента управления FileUpload для каждого поля двоичных данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-306">Once the architecture has been updated, the next step is creating the inserting interface, which can be accomplished using a DetailsView that has been customized to include a FileUpload control for each binary data field.</span></span> <span data-ttu-id="872e8-307">Затем загруженные данные можно сохранить в файловой системе сервера s web или назначено для параметра источника данных в DetailsView s `ItemInserting` обработчика событий.</span><span class="sxs-lookup"><span data-stu-id="872e8-307">The uploaded data can then be saved to the web server s file system or assigned to a data source parameter in the DetailsView s `ItemInserting` event handler.</span></span>

<span data-ttu-id="872e8-308">Сохранение двоичных данных в файловой системе требует более тщательного планирования, чем сохранение данных непосредственно в базу данных.</span><span class="sxs-lookup"><span data-stu-id="872e8-308">Saving binary data to the file system requires more planning than saving data directly into the database.</span></span> <span data-ttu-id="872e8-309">Необходимо выбрать схему именования во избежание одной отправки пользователем s, перезапись другой s.</span><span class="sxs-lookup"><span data-stu-id="872e8-309">A naming scheme must be chosen in order to avoid one user s upload overwriting another s.</span></span> <span data-ttu-id="872e8-310">Кроме того чтобы удалить загруженный файл, если вставка базы данных завершается ошибкой необходимо выполнить дополнительные действия.</span><span class="sxs-lookup"><span data-stu-id="872e8-310">Also, extra steps must be taken to delete the uploaded file if the database insert fails.</span></span>

<span data-ttu-id="872e8-311">Мы публикуем возможность добавить новые категории в системе с брошюр и показатели, но мы хранять еще необходимо обратить внимание на способ обновить существующие категории s двоичных данных или правильно удалить двоичные данные для удаленных категории.</span><span class="sxs-lookup"><span data-stu-id="872e8-311">We now have the ability to add new categories to the system with a brochure and picture, but we ve yet to look at how to update an existing category s binary data or how to correctly remove the binary data for a deleted category.</span></span> <span data-ttu-id="872e8-312">В следующем уроке мы изучим этих двух разделов.</span><span class="sxs-lookup"><span data-stu-id="872e8-312">We'll explore these two topics in the next tutorial.</span></span>

<span data-ttu-id="872e8-313">Программирование довольны!</span><span class="sxs-lookup"><span data-stu-id="872e8-313">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="872e8-314">Об авторе</span><span class="sxs-lookup"><span data-stu-id="872e8-314">About the Author</span></span>

<span data-ttu-id="872e8-315">[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи ASP/ASP.NET и основателя из [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Майкрософт с 1998 года.</span><span class="sxs-lookup"><span data-stu-id="872e8-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="872e8-316">Скотт — независимый консультант, trainer и записи.</span><span class="sxs-lookup"><span data-stu-id="872e8-316">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="872e8-317">Его последняя книга — [ *диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="872e8-317">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="872e8-318">Он может быть достигнута по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="872e8-318">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="872e8-319">Благодарности</span><span class="sxs-lookup"><span data-stu-id="872e8-319">Special Thanks To</span></span>

<span data-ttu-id="872e8-320">Этот учебник ряд прошел проверку многие полезные рецензентов.</span><span class="sxs-lookup"><span data-stu-id="872e8-320">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="872e8-321">Основными редакторами этого учебника были Dave Gardner Мерфи Тереза д и Екатерина Leigh.</span><span class="sxs-lookup"><span data-stu-id="872e8-321">Lead reviewers for this tutorial were Dave Gardner, Teresa Murphy, and Bernadette Leigh.</span></span> <span data-ttu-id="872e8-322">Объясняются моих последующих статей для MSDN?</span><span class="sxs-lookup"><span data-stu-id="872e8-322">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="872e8-323">Если Да, напишите мне по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="872e8-323">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="872e8-324">[Назад](displaying-binary-data-in-the-data-web-controls-vb.md)
[Вперед](updating-and-deleting-existing-binary-data-vb.md)</span><span class="sxs-lookup"><span data-stu-id="872e8-324">[Previous](displaying-binary-data-in-the-data-web-controls-vb.md)
[Next](updating-and-deleting-existing-binary-data-vb.md)</span></span>

---
uid: web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-cs
title: Файл кода, передать параметр, при добавлении новой записи (C#) | Документы Microsoft
author: rick-anderson
description: Этого учебника показано, как создать веб-интерфейс, который позволяет пользователю ввести текстовых данных и передача двоичных файлов. Чтобы проиллюстрировать t доступные параметры...
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/27/2007
ms.topic: article
ms.assetid: 362ade25-3965-4fb2-88d2-835c4786244f
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-cs
msc.type: authoredcontent
ms.openlocfilehash: ab63f9b0c536be81fdaa894985bae6a6b9346fa5
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
<a name="including-a-file-upload-option-when-adding-a-new-record-c"></a>Включая параметр передачи файла при добавлении новой записи (C#)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Загрузить пример приложения](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_CS.exe) или [скачать PDF](including-a-file-upload-option-when-adding-a-new-record-cs/_static/datatutorial56cs1.pdf)

> Этого учебника показано, как создать веб-интерфейс, который позволяет пользователю ввести текстовых данных и передача двоичных файлов. Чтобы проиллюстрировать параметры, доступные для хранения двоичных данных, один файл будет сохранен в базе данных, то время как другой хранятся в файловой системе.


## <a name="introduction"></a>Вступление

На предыдущих двух уроках мы изучена методы для хранения двоичных данных, связанный с моделью данных приложения s, рассмотрены способы использования элемента управления FileUpload для отправки файлов от клиента к веб-серверу и узнали, как для представления этих двоичных данных в данных W элемент управления ЭБ. Мы сохранить еще поговорим о том, как связать загруженные данные с моделью данных, однако.

В этом учебнике мы создадим веб-страницы, чтобы добавить новую категорию. Помимо текстовые поля s имя категории и описания Эта страница будет должны включать два элемента управления FileUpload для новой категории s картинки и один для брошюр. Переданные изображения сохраняются непосредственно в новой записи s `Picture` столбец, в то время как брошюр будут сохранены в `~/Brochures` папку по пути для файла, сохраненного в новой записи s `BrochurePath` столбца.

Перед созданием этой новой веб-страницы, необходимо обновить архитектуру. `CategoriesTableAdapter` Основной запрос s не сможет извлечь `Picture` столбец. Следовательно, автоматически сгенерированный `Insert` метод имеет только входные данные для `CategoryName`, `Description`, и `BrochurePath` поля. Таким образом, необходимо ли создавать дополнительный метод в TableAdapter, которые запрашиваются все четыре `Categories` поля. `CategoriesBLL` Класса в бизнес-логики также необходимо обновить.

## <a name="step-1-adding-aninsertwithpicturemethod-to-thecategoriestableadapter"></a>Шаг 1: Добавление`InsertWithPicture`метода`CategoriesTableAdapter`

Когда мы создали `CategoriesTableAdapter` в [Создание слой доступа к данным](../introduction/creating-a-data-access-layer-cs.md) учебника было настроено для автоматического создания `INSERT`, `UPDATE`, и `DELETE` инструкций на основе основного запроса. Кроме того, мы рекомендовано использовать DB прямой подход, который создан методы адаптера таблицы `Insert`, `Update`, и `Delete`. Эти методы выполнения автоматического `INSERT`, `UPDATE`, и `DELETE` инструкций и, следовательно, принимать входные параметры, основанные на столбцах, возвращенной основным запросом. В [передачи файлов](uploading-files-cs.md) учебника мы дополнить `CategoriesTableAdapter` s основной запрос для использования `BrochurePath` столбца.

Поскольку `CategoriesTableAdapter` s основной запрос не ссылается на `Picture` столбца, мы можно добавить новую запись ни обновление существующей записи со значением для `Picture` столбца. Чтобы записать эти сведения, можно либо создать новый метод в адаптере таблицы, используемый для вставки записи с двоичными данными или мы, можно настроить автоматически сформированного `INSERT` инструкции. Проблема с Настройка автоматического `INSERT` инструкция является мы риск необходимости сделанных настроек перезаписана с помощью мастера. Например, предположим, что мы настроена `INSERT` инструкцию, чтобы включить использование `Picture` столбца. Это обновит TableAdapter s `Insert` метод, чтобы включить дополнительный входной параметр для категории s рисунок s двоичные данные. Затем удалось создать метод в уровня бизнес-логики, чтобы с его помощью DAL и вызывать этот метод уровень бизнес-ЛОГИКИ через уровень представления, и все будет работать прекрасно. То есть до следующего настроена через мастер настройки адаптера таблицы TableAdapter. Как только работа мастера завершена, сделанных настроек для `INSERT` инструкции будут перезаписаны, `Insert` метод будет возвращаться в его старая форма и наш код больше не будет компилироваться!

> [!NOTE]
> Недовольство этот вопрос не-при использовании хранимых процедур вместо нерегламентированных инструкций SQL. Будущие учебника будет изучено использование хранимых процедур вместо нерегламентированных инструкций SQL на уровне доступа к данным.


Чтобы избежать этой возможности головную боль, чем Настройка инструкций SQL автоматически созданный позволяют s вместо этого создайте новый метод для адаптера таблицы. Этот метод с именем `InsertWithPicture`, будет принимать значения для `CategoryName`, `Description`, `BrochurePath`, и `Picture` столбцы и выполнения `INSERT` инструкцию, которая хранит все четыре значения в новой записи.

Откройте типизированного набора данных и в режиме конструктора щелкните правой кнопкой мыши `CategoriesTableAdapter` заголовок s и в контекстном меню выберите команду Добавить запрос. Запустится мастер настройки запроса адаптера таблицы, которая начинается с вопроса, как запроса адаптера таблицы следует обращаться к базе данных. Выберите использовать инструкции SQL и нажмите кнопку Далее. Следующий шаг предлагаемые для типа запроса. Поскольку мы повторно создать запрос, чтобы добавить новую запись для `Categories` таблицы, выберите INSERT и нажмите кнопку Далее.


[![Выберите параметр вставки](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.png)

**Рис. 1**: выберите параметр вставки ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.png))


Теперь нам нужно указать `INSERT` инструкции SQL. Мастер установки автоматически предлагает `INSERT` инструкции, соответствующий s основного запроса адаптера таблицы. В этом случае он s `INSERT` инструкции, которая вставляет `CategoryName`, `Description`, и `BrochurePath` значения. Инструкция UPDATE, чтобы `Picture` включен столбец вместе с `@Picture` параметр следующим образом:


[!code-sql[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample1.sql)]

На последнем экране мастера появляется запрос на имя нового метода адаптера таблицы. Введите `InsertWithPicture` и нажмите кнопку Готово.


[![Имя нового InsertWithPicture метод адаптера таблицы](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.png)

**На рисунке 2**: имя нового метода адаптера таблицы `InsertWithPicture` ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.png))


## <a name="step-2-updating-the-business-logic-layer"></a>Шаг 2: Обновление уровня бизнес-логики

Так как уровень представления только должны взаимодействовать с бизнес-логики, а не на обход его, чтобы перейти непосредственно на уровне доступа к данным, необходимо создать метод уровень бизнес-ЛОГИКИ, который вызывает метод DAL, мы только что создали (`InsertWithPicture`). В этом учебнике, создайте метод в `CategoriesBLL` класс с именем `InsertWithPicture` , принимающий в качестве входных данных трех `string` s и `byte` массива. `string` Входные параметры являются категории s имя, описание и путь к файлу брошюр, пока `byte` массив — для двоичного содержимого рисунка категории s. Как показывает следующий код, этот метод МЕТОДА вызывает соответствующий метод DAL:


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample2.cs)]

> [!NOTE]
> Убедитесь, что вы сохранили типизированного набора данных перед добавлением `InsertWithPicture` метода для МЕТОДА. Поскольку `CategoriesTableAdapter` код класса создается автоматически в зависимости от типизированного набора данных, если Дон t сначала сохранить изменения в типизированный набор данных `Adapter` свойство выиграл t знать о `InsertWithPicture` метод.


## <a name="step-3-listing-the-existing-categories-and-their-binary-data"></a>Шаг 3: Создание списков, существующие категории и их двоичные данные

В этом учебнике мы создадим страницы, который позволяет конечным пользователям добавить новую категорию в систему, предоставляя рисунок и брошюр для новой категории. В [предыдущего учебника](displaying-binary-data-in-the-data-web-controls-cs.md) мы использовали GridView с TemplateField и ImageField для отображения каждого имени категории s, описание, изображение и ссылка для загрузки его брошюр. Разрешить s реплицировать эти функциональные возможности в этом учебнике создается страница, которая позволяет для новых создаваемых и перечисляет все существующие категории.

Сначала откройте `DisplayOrDownload.aspx` страницу `BinaryData` папки. Перейдите в представление источника и скопируйте GridView и ObjectDataSource s декларативного синтаксиса, вставив его в `<asp:Content>` элемент в `UploadInDetailsView.aspx`. Кроме того, не забывайте следует заменять `GenerateBrochureLink` метод из класса кода программной части `DisplayOrDownload.aspx` для `UploadInDetailsView.aspx`.


[![Скопируйте и вставьте декларативный синтаксис из DisplayOrDownload.aspx UploadInDetailsView.aspx](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.png)

**Рис. 3**: копирование и вставка декларативный синтаксис из `DisplayOrDownload.aspx` для `UploadInDetailsView.aspx` ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.png))


После копирования декларативный синтаксис и `GenerateBrochureLink` метод через `UploadInDetailsView.aspx` просмотреть страницу через браузер, чтобы убедиться, что все, что была скопирована по правильно. Вы увидите GridView со списком восьми категорий, ссылка на загрузку брошюр и рисунка категории s.


[![Теперь вы увидите каждой категории вместе с его двоичных данных](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.png)

**Рис. 4**: вы должны теперь см. каждый категории вместе с двоичными данными, его ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.png))


## <a name="step-4-configuring-thecategoriesdatasourceto-support-inserting"></a>Шаг 4: Настройка`CategoriesDataSource`поддержку вставки

`CategoriesDataSource` Используемые ObjectDataSource `Categories` GridView в настоящее время не предоставляет возможность вставки данных. Чтобы поддерживает вставку через этот элемент управления источником данных, необходимо сопоставить его `Insert` метода на метод в объекте базовой `CategoriesBLL`. В частности, мы хотим сопоставить его с `CategoriesBLL` мы добавили обратно в шаге 2, метод `InsertWithPicture`.

Запустить, щелкнув ссылку в смарт-теге s ObjectDataSource настройки источника данных. Первый экран отображается источник данных настроен для работы с, объект `CategoriesBLL`. Оставьте этот параметр соответствует-— и нажмите кнопку Далее, чтобы перейти на экран задайте методы данных. Перемещение вкладки «Вставка» и выбрать `InsertWithPicture` метода из раскрывающегося списка. Нажмите кнопку Готово, чтобы завершить работу мастера.


[![Настройка ObjectDataSource можно использовать метод InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.png)

**Рис. 5**: Настройка ObjectDataSource для использования `InsertWithPicture` метод ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.png))


> [!NOTE]
> После завершения работы мастера, Visual Studio может потребоваться, если вы хотите обновить поля и ключи, что приведет к повторному созданию данных Web управляет поля. Выберите Нет, поскольку Выбор Да перезапишет все настройки полей, возможно, были внесены.


По завершении работы мастера ObjectDataSource теперь включают значение для его `InsertMethod` свойства в том числе в `InsertParameters` для столбцов четыре категории, как следующие декларативная разметка показано:


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample3.aspx)]

## <a name="step-5-creating-the-inserting-interface"></a>Шаг 5: Создание интерфейса вставки

Впервые охваченных [Обзор Вставка, обновление и удаление данных](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md), управления DetailsView предоставляет встроенные вставку интерфейс, который можно использовать при работе с элемент управления источником данных, который поддерживает вставку. Разрешить добавление элемента управления DetailsView на данную страницу над элементом управления GridView, отображающего окончательно свой интерфейс для вставки, позволяя пользователю быстро добавить новую категорию s. После добавления новой категории в DetailsView, GridView под ним будет автоматически обновится и новой категории.

Пуск, перетащив DetailsView из области элементов в конструктор выше GridView, установка его `ID` свойства `NewCategory` и очищая `Height` и `Width` значения свойств. Смарт-теге s DetailsView, привяжите его к существующему `CategoriesDataSource` и затем установите флажок Разрешить вставку.


[![Привязка DetailsView CategoriesDataSource и включить вставку](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.png)

**Рис. 6**: привязка DetailsView для `CategoriesDataSource` и разрешить вставку ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image12.png))


Преобразовываемое DetailsView в свой интерфейс для вставки без возможности восстановления, задать его `DefaultMode` свойства `Insert`.

Обратите внимание, что DetailsView пять стояли `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, и `BrochurePath` хотя `CategoryID` BoundField не отображается в интерфейсе вставки, так как его `InsertVisible` свойство имеет значение `false`. Эти стояли существует, поскольку они являются столбцы, возвращенные `GetCategories()` метод, который является ObjectDataSource вызывает для извлечения данных. Для вставки, тем не менее, мы не хотите t требуется позволяет пользователю задать значение для `NumberOfProducts`. Кроме того необходимо разрешить им отправить изображение для новой категории, а также отправить PDF-ФАЙЛ для брошюр.

Удалить `NumberOfProducts` BoundField из полностью DetailsView и обновите `HeaderText` свойства `CategoryName` и `BrochurePath` стояли к категории и брошюр, соответственно. Затем преобразуйте `BrochurePath` BoundField в TemplateField и добавить новый TemplateField для изображения, предоставляя этот новый TemplateField `HeaderText` значение изображения. Переместить `Picture` TemplateField, чтобы оно было между `BrochurePath` TemplateField и CommandField.


![Привязка DetailsView CategoriesDataSource и включить вставку](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.gif)

**Рис. 7**: привязка DetailsView для `CategoriesDataSource` и включить вставку


Если был преобразован `BrochurePath` включает TemplateField BoundField в TemplateField через диалоговое окно Изменить поля `ItemTemplate`, `EditItemTemplate`, и `InsertItemTemplate`. Только `InsertItemTemplate` — необходимые, тем не менее, поэтому вы можете удалить другие шаблоны. На этом этапе декларативный синтаксис s DetailsView должен выглядеть следующим образом:


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample4.aspx)]

## <a name="adding-fileupload-controls-for-the-brochure-and-picture-fields"></a>Добавление элементов управления FileUpload рисунок полей и брошюр

В настоящее время `BrochurePath` TemplateField s `InsertItemTemplate` содержит текстовое поле, пока `Picture` TemplateField не содержит какие-либо шаблоны. Необходимо обновить эти два s TemplateField `InsertItemTemplate` для использования элементов управления FileUpload.

В смарт-теге s DetailsView, выберите параметр редактирование шаблонов, а затем выберите `BrochurePath` TemplateField s `InsertItemTemplate` из раскрывающегося списка. Удалите текстовое поле и перетащите элемент управления FileUpload из области элементов в шаблон. Настройка управления FileUpload s `ID` для `BrochureUpload`. Аналогичным образом добавить элемент управления FileUpload `Picture` TemplateField s `InsertItemTemplate`. Установить этот элемент управления FileUpload s `ID` для `PictureUpload`.


[![Добавление элемента управления FileUpload InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image13.png)

**Рис. 8**: добавить элемент управления FileUpload `InsertItemTemplate` ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image14.png))


После внесения этих изменений, будет две TemplateField s декларативный синтаксис:


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample5.aspx)]

Пользователь добавляет новую категорию, мы хотим обеспечить брошюр и рисунка типа правильный файл. Чтобы брошюр пользователь должен предоставить PDF-файла. Для изображения, нам необходимо пользователю загружать файл изображения, но мы позволяют выполнять *любой* образа файла или только файлы изображений определенного типа, такие как изображений GIF или JPGs? Чтобы разрешить для различных типов файлов, d необходимо расширить `Categories` схемы, включающие столбец, который записывает тип файлов, чтобы этот тип может быть отправлен клиенту через `Response.ContentType` в `DisplayCategoryPicture.aspx`. Поскольку мы не хотите t имеют такой столбец, было бы разумным шагом будет ограничен только указание типа файла определенного образа. `Categories` Изображения в существующей таблице s точечных рисунков, а JPGs — формате файла больше подходит для изображений, обслуживаемых через Интернет.

Если пользователь загружает неправильный тип, необходимо отменить вставку и отображать сообщение с описанием проблемы. Добавьте веб-управления Label под DetailsView. Задайте его `ID` свойства `UploadWarning`снимите out его `Text` , установите `CssClass` свойства на "Предупреждение" и `Visible` и `EnableViewState` свойства `false`. `Warning` Определяется класс CSS в `Styles.css` и отображает текст в большой, красный, выделены курсивом, полужирный шрифт.

> [!NOTE]
> В идеальном случае `CategoryName` и `Description` стояли будет преобразована в TemplateFields и их вставка интерфейсы, настроенные. `Description` Вставка интерфейса, например, будет скорее всего будет лучше подходят через многострочного текстового поля. И, поскольку `CategoryName` столбец не принимает `NULL` значения, RequiredFieldValidator должны быть добавлены, чтобы пользователь предоставляет значение для нового имени категории s. Эти действия остаются в качестве упражнения для средства чтения. Обращаться к [Настройка интерфейса изменения данных](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) подробное рассмотрение дополнения интерфейсы модификации данных.


## <a name="step-6-saving-the-uploaded-brochure-to-the-web-server-s-file-system"></a>Шаг 6: Сохранение переданные брошюр файловую систему Web Server s

Когда пользователь вводит значения для новой категории и нажимает кнопку "Добавить", обратная передача и вставку рабочего процесса развертывания. Во-первых, DetailsView s [ `ItemInserting` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx) активируется. Далее, ObjectDataSource s `Insert()` вызывается метод, что приводит к новой записи, добавляемые `Categories` таблицы. После этого DetailsView s [ `ItemInserted` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx) активируется.

Прежде чем ObjectDataSource s `Insert()` вызывается метод, необходимо сначала убедитесь, что соответствующий файл типы были отправлены пользователем и сохраните брошюр PDF в web server s файловую систему. Создайте обработчик событий для DetailsView s `ItemInserting` событий и добавьте следующий код:


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample6.cs)]

Запускает обработчик событий с помощью ссылки на `BrochureUpload` FileUpload управления на основе шаблонов s DetailsView. Затем если передал брошюр проверяется расширения s отправленного файла. Если расширение не является. PDF, затем предупреждение отображается, операция вставки отменяется и окончания выполнения обработчика событий.

> [!NOTE]
> Полагаться на расширение s отправленный файл не надежный способ обеспечения загруженный файл PDF-документ. На компьютере может быть допустимым PDF-документ с расширением `.Brochure`, или может выполнено без PDF-документ и предоставить ему `.pdf` расширения. Двоичное содержимое файла s потребуется программным образом проверить, чтобы более окончательно определить тип файла. Такие тщательного подхода, часто являются избыточным; Проверка расширения достаточно для большинства сценариев.


Как было сказано в [передачи файлов](uploading-files-cs.md) учебника, необходимо соблюдать осторожность при сохранении файлов в файловой системе, этой отправки одного пользователя s не перезаписывает другой s. В этом учебнике мы будет пытаться использовать то же имя отправленного файла. Если уже существует файл в `~/Brochures` каталога с этой же именем, однако мы будем добавляется число в конце пока не будет найдено уникальное имя. Например, если пользователь отправляет брошюр файл с именем `Meats.pdf`, но уже существует файл с именем `Meats.pdf` в `~/Brochures` папки, мы изменим имя сохраненного файла `Meats-1.pdf`. Если, существует, мы попытаемся `Meats-2.pdf`, и т. д., пока не будет найдено уникальное имя файла.

В следующем коде используется [ `File.Exists(path)` метод](https://msdn.microsoft.com/library/system.io.file.exists.aspx) для определения того, существует ли файл с указанным именем файла. В этом случае он продолжает повторите новые имена файлов для брошюр, пока не будет обнаружен конфликт.


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample7.cs)]

После обнаружения допустимое имя файла, файл необходимо сохранить в файловой системе и ObjectDataSource s `brochurePath``InsertParameter` значения должен быть обновлен, чтобы это имя файла записывается в базу данных. Как мы видели в *передачи файлов* учебника, можно сохранить файл с помощью элемента управления FileUpload s `SaveAs(path)` метод. Чтобы обновить ObjectDataSource s `brochurePath` параметра, используйте `e.Values` коллекции.


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample8.cs)]

## <a name="step-7-saving-the-uploaded-picture-to-the-database"></a>Шаг 7: Сохранение переданные изображения в базе данных

Для сохранения загруженного изображения в новом `Categories` записи, нам нужно назначить передаваемого содержимого двоичного ObjectDataSource s `picture` параметр в DetailsView s `ItemInserting` событий. Перед внесением этого назначения, тем не менее, необходимо сначала убедитесь, что переданный изображен JPG и не некоторый другой тип изображения. Как показано в шаге 6 позволяют использовать расширение файла s отправленного изображения, чтобы выяснить его тип s.

Хотя `Categories` таблица позволяет `NULL` значения `Picture` изображение имеет столбец, в данный момент все категории. Разрешить s предложить пользователю вводить рисунок, при добавлении новой категории через эту страницу. Следующий код проверяет, рисунок отправлен и что он имеет соответствующее расширение.


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample9.cs)]

Этот код следует разместить *перед* кода из шага 6, чтобы в случае проблемы с передачей рисунок обработчик событий будет завершена перед брошюр файл сохраняется в файловой системе.

Предположим, что соответствующий файл был загружен, назначьте передаваемого содержимого двоичного s значение параметра рисунок с следующую строку кода:


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample10.cs)]

## <a name="the-completeiteminsertingevent-handler"></a>Полный`ItemInserting`обработчика событий

Для полноты информации, вот `ItemInserting` обработчик событий в полном объеме:


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample11.cs)]

## <a name="step-8-fixing-thedisplaycategorypictureaspxpage"></a>Шаг 8: Исправления`DisplayCategoryPicture.aspx`страницы

Let s занять некоторое время для тестирования интерфейса вставки и `ItemInserting` обработчик событий, который был создан в последних шагах. Посетите `UploadInDetailsView.aspx` постраничного просмотра обозревателя и попытаться добавить категорию, но не указывается рисунок, или указать рисунок не JPG или брошюр не PDF. В каждом из этих случаев отображается сообщение об ошибке и вставки рабочего процесса отменено.


[![Предупреждение будет отображаться, если передается недопустимый тип файла](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image15.png)

**Рис. 9**: предупреждение будет отображаться, если передается недопустимый тип файла ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image16.png))


После проверки страницы требуется рисунок для отправки и реализованных t принимать файлы не PDF или не JPG, добавить новую категорию с недопустимым изображением JPG, если оставить поле брошюр пустым. После нажатия кнопки "Добавить", будет обратной передачи страницы и новые записи будут добавлены `Categories` таблицу с двоичное содержимое отправленного изображения s хранятся непосредственно в базе данных. GridView обновляется и показана строка для вновь добавленного категории, но, как показано на рис. 10, новый рисунок s категории, отображается неправильно.


[![Новая категория s изображение не отображается.](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image17.png)

**Рис. 10**: s новой категории не изображения ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image18.png))


Новое изображение не отображается, так как `DisplayCategoryPicture.aspx` страницу, которая возвращает рисунок указанной категории s настроена для обработки точечных рисунков, который содержит заголовка OLE. Этот заголовок 78 байтов исключается из `Picture` столбец s двоичное содержимое перед их отправкой обратно клиенту. Но JPG-файл, только что загруженном для новой категории не содержат этот заголовок OLE; Таким образом допустимый, необходимые байт удаляются из двоичных данных изображения s.

Поскольку теперь существует как растровые изображения с заголовками OLE и JPGs в `Categories` таблицы, необходимо обновить `DisplayCategoryPicture.aspx` , чтобы он не чередует для исходного восьми категорий заголовка OLE и пропускает этот чередует новые записи из категории. В нашем следующем уроке мы изучим, как обновить существующий образ записи s, и мы обновим все старые категории изображения, чтобы они были JPGs. На данном этапе, используйте следующий код в `DisplayCategoryPicture.aspx` для удаления только заголовки OLE исходного восьми категорий:


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample12.cs)]

Благодаря этому изменению JPG изображения теперь отображаются правильно в GridView.


[![JPG для новых категорий являются правильно к просмотру](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image19.png)

**Рис. 11**: изображений JPG для новых категорий являются правильно к просмотру ([Просмотр полноразмерное изображение](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image20.png))


## <a name="step-9-deleting-the-brochure-in-the-face-of-an-exception"></a>Шаг 9: Удаление брошюр при возникновении исключения

Одна из проблем для хранения двоичных данных в файловой системе web server s является появляется запрос на отключение от модели данных и двоичные данные. Таким образом при удалении записи соответствующих двоичных данных в файловой системе, необходимо также удалить. При вставке, а также могут поступить в игру. Рассмотрим следующий сценарий: пользователь добавляет новую категорию, указав допустимое изображение и брошюр. Нажмите кнопку "Добавить" обратная передача и DetailsView s `ItemInserting` вызывается событие, сохранение брошюр в файловой системе сервера s web. Далее, ObjectDataSource s `Insert()` вызывается метод, который вызывает `CategoriesBLL` класса s `InsertWithPicture` метод, который вызывает `CategoriesTableAdapter` s `InsertWithPicture` метод.

Теперь, что произойдет, если база данных находится в автономном режиме или если имеется ошибка в `INSERT` инструкции SQL? Четко операция вставки завершится ошибкой, поэтому нет новой категории строки будут добавляться в базу данных. Но мы по-прежнему брошюр загруженный файл, расположенный в файловой системе web server s! Этот файл должен удаляться при возникновении исключения во время вставки рабочего процесса.

Как было описано ранее в [обработки уровень бизнес-ЛОГИКИ и исключения уровня DAL на странице ASP.NET](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) учебник, когда порождено исключение в глубине архитектуры, его полученной через различные уровни. На уровне представления, можно определить Если возникло исключение из DetailsView s `ItemInserted` событий. Этот обработчик событий также предоставляет значения ObjectDataSource s `InsertParameters`. Таким образом, можно создать обработчик событий для `ItemInserted` событие, которое проверяет, если возникло исключение и если да, удаляет файл, указанный параметром ObjectDataSource s `brochurePath` параметр:


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample13.cs)]

## <a name="summary"></a>Сводка

Существует ряд действий, которые должны быть выполнены для предоставления веб-интерфейса для добавления записи, которые содержат двоичные данные. Если двоичные данные хранятся непосредственно в базу данных, скорее всего, вам потребуется обновить архитектуру, добавления определенных методов для обработки случая вставки двоичных данных. После обновления архитектуру, следующим шагом является создание вставку интерфейс, который может выполняться с помощью DetailsView, настроенного для включения элемента управления FileUpload для каждого поля двоичных данных. Затем загруженные данные можно сохранить в файловой системе сервера s web или назначено для параметра источника данных в DetailsView s `ItemInserting` обработчика событий.

Сохранение двоичных данных в файловой системе требует более тщательного планирования, чем сохранение данных непосредственно в базу данных. Необходимо выбрать схему именования во избежание одной отправки пользователем s, перезапись другой s. Кроме того чтобы удалить загруженный файл, если вставка базы данных завершается ошибкой необходимо выполнить дополнительные действия.

Мы публикуем возможность добавить новые категории в системе с брошюр и показатели, но мы хранять еще необходимо обратить внимание на способ обновить существующие категории s двоичных данных или правильно удалить двоичные данные для удаленных категории. В следующем уроке мы изучим этих двух разделов.

Программирование довольны!

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи ASP/ASP.NET и основателя из [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Майкрософт с 1998 года. Скотт — независимый консультант, trainer и записи. Его последняя книга — [ *диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он может быть достигнута по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Благодарности

Этот учебник ряд прошел проверку многие полезные рецензентов. Основными редакторами этого учебника были Dave Gardner Мерфи Тереза д и Екатерина Leigh. Объясняются моих последующих статей для MSDN? Если Да, напишите мне по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](displaying-binary-data-in-the-data-web-controls-cs.md)
> [Вперед](updating-and-deleting-existing-binary-data-cs.md)

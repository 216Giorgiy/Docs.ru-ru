---
uid: web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-vb
title: "С помощью кэш-зависимости SQL (Visual Basic) | Документы Microsoft"
author: rick-anderson
description: "Простейшая стратегия кэширования является предоставление кэшированные данные по истечении указанного периода времени. Однако этот простой подход означает, что maintai кэшированных данных..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 05/30/2007
ms.topic: article
ms.assetid: bd347d93-4251-4532-801c-a36f2dfa7f96
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-vb
msc.type: authoredcontent
ms.openlocfilehash: af302d67b009fc25e38fb33a5e2a623f7200bcd5
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2018
---
<a name="using-sql-cache-dependencies-vb"></a><span data-ttu-id="d7b7c-104">С помощью кэш-зависимости SQL (Visual Basic)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-104">Using SQL Cache Dependencies (VB)</span></span>
====================
<span data-ttu-id="d7b7c-105">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="d7b7c-106">[Загрузить код](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_VB.zip) или [скачать PDF](using-sql-cache-dependencies-vb/_static/datatutorial61vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_VB.zip) or [Download PDF](using-sql-cache-dependencies-vb/_static/datatutorial61vb1.pdf)</span></span>

> <span data-ttu-id="d7b7c-107">Простейшая стратегия кэширования является предоставление кэшированные данные по истечении указанного периода времени.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-107">The simplest caching strategy is to allow cached data to expire after a specified period of time.</span></span> <span data-ttu-id="d7b7c-108">Однако этот простой подход означает, что кэшированных данных поддерживается не связан с его базового источника данных, в результате устаревшие данные, который проводится слишком длинное или текущих данных, истек срок действия слишком рано.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-108">But this simple approach means that the cached data maintains no association with its underlying data source, resulting in stale data that is held too long or current data that is expired too soon.</span></span> <span data-ttu-id="d7b7c-109">Лучшим подходом является использование класса SqlCacheDependency, чтобы данные остаются кэшированных, пока его базовых данных был изменен в базе данных SQL.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-109">A better approach is to use the SqlCacheDependency class so that data remains cached until its underlying data has been modified in the SQL database.</span></span> <span data-ttu-id="d7b7c-110">Этот учебник показывает, каким образом.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-110">This tutorial shows you how.</span></span>


## <a name="introduction"></a><span data-ttu-id="d7b7c-111">Вступление</span><span class="sxs-lookup"><span data-stu-id="d7b7c-111">Introduction</span></span>

<span data-ttu-id="d7b7c-112">Методы кэширования проверяются в [кэширование данных с помощью ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) и [кэширование данных в архитектуре](caching-data-in-the-architecture-vb.md) учебники позволяет исключить данные из кэша после указанного времени истечения срока действия период времени.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-112">The caching techniques examined in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) and [Caching Data in the Architecture](caching-data-in-the-architecture-vb.md) tutorials used a time-based expiry to evict the data from the cache after a specified period.</span></span> <span data-ttu-id="d7b7c-113">Этот подход является самым простым способом сбалансировать выигрыш в производительности кэширования с устареванием данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-113">This approach is the simplest way to balance the performance gains of caching against data staleness.</span></span> <span data-ttu-id="d7b7c-114">Выбрав срока истечения времени *x* секунд, разработчик concedes пользоваться преимуществами производительности кэширования для *x* секунд, но можно задержать просто что свои данные никогда не будет устаревших дольше, чем более из *x* секунд.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-114">By selecting a time expiry of *x* seconds, a page developer concedes to enjoy the performance benefits of caching for only *x* seconds, but can rest easy that her data will never be stale longer than a maximum of *x* seconds.</span></span> <span data-ttu-id="d7b7c-115">Конечно, для статических данных *x* может распространяться на время существования веб-приложения, как было анализировать [кэширование данных при запуске приложения](caching-data-at-application-startup-vb.md) учебника.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-115">Of course, for static data, *x* can be extended to the lifetime of the web application, as was examined in the [Caching Data at Application Startup](caching-data-at-application-startup-vb.md) tutorial.</span></span>

<span data-ttu-id="d7b7c-116">При кэшировании данных базы данных, на основе времени окончания срока действия выбран часто для удобства его использования, но часто — это решение для недостаточно.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-116">When caching database data, a time-based expiry is often chosen for its ease of use but is frequently an inadequate solution.</span></span> <span data-ttu-id="d7b7c-117">В идеальном случае базы данных будет остаются в кэше до базовых данных был изменен в базе данных. только после этого будет вытеснение кэша.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-117">Ideally, the database data would remain cached until the underlying data has been modified in the database; only then would the cache be evicted.</span></span> <span data-ttu-id="d7b7c-118">Такой подход обеспечивает максимальную производительность преимущества кэширования и сводит к минимуму время устаревшие данные.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-118">This approach maximizes the performance benefits of caching and minimizes the duration of stale data.</span></span> <span data-ttu-id="d7b7c-119">Однако чтобы существует эти преимущества предоставляются необходимо некоторые системы в месте, которое знает, когда основной базы данных был изменен и исключает — соответствующие элементы из кэша.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-119">However, in order to enjoy these benefits there must be some system in place that knows when the underlying database data has been modified and evicts the corresponding items from the cache.</span></span> <span data-ttu-id="d7b7c-120">До ASP.NET 2.0 разработчики страниц были отвечать за реализацию этой системе.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-120">Prior to ASP.NET 2.0, page developers were responsible for implementing this system.</span></span>

<span data-ttu-id="d7b7c-121">ASP.NET 2.0 предоставляет [ `SqlCacheDependency` класса](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx) и необходимую инфраструктуру, чтобы определить, когда произошло изменение в базе данных, чтобы соответствующие элементы в кэше может быть исключен.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-121">ASP.NET 2.0 provides a [`SqlCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx) and the necessary infrastructure to determine when a change has occurred in the database so that the corresponding cached items can be evicted.</span></span> <span data-ttu-id="d7b7c-122">Существует два способа определить, когда базовые данные изменились: уведомления и опроса.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-122">There are two techniques for determining when the underlying data has changed: notification and polling.</span></span> <span data-ttu-id="d7b7c-123">После рассмотрения различий между уведомлением и опроса, мы создадим инфраструктуру необходимые для поддержки опроса и исследуйте способы использования `SqlCacheDependency` класса в декларативном и программно сценариев.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-123">After discussing the differences between notification and polling, we'll create the infrastructure necessary to support polling and then explore how to use the `SqlCacheDependency` class in declarative and programmatically scenarios.</span></span>

## <a name="understanding-notification-and-polling"></a><span data-ttu-id="d7b7c-124">Основные сведения о уведомления и опроса</span><span class="sxs-lookup"><span data-stu-id="d7b7c-124">Understanding Notification and Polling</span></span>

<span data-ttu-id="d7b7c-125">Существует два метода, которые могут использоваться для определения, когда был изменен в базе данных: уведомления и опроса.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-125">There are two techniques that can be used to determine when the data in a database has been modified: notification and polling.</span></span> <span data-ttu-id="d7b7c-126">Уведомления базы данных автоматически оповещает среды выполнения ASP.NET, когда результаты определенного запроса были изменены с момента последнего выполнения запроса, после чего вытесняются кэшированные элементы, связанные с запросом.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-126">With notification, the database automatically alerts the ASP.NET runtime when the results of a particular query have been changed since the query was last executed, at which point the cached items associated with the query are evicted.</span></span> <span data-ttu-id="d7b7c-127">С использованием опроса, сервер базы данных сохраняет сведения о конкретной таблицы при последней были обновлены.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-127">With polling, the database server maintains information about when particular tables have last been updated.</span></span> <span data-ttu-id="d7b7c-128">Среда выполнения ASP.NET периодически опрашивает базу данных для проверки таблицы, которые были изменены с момента их поступления в кэш.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-128">The ASP.NET runtime periodically polls the database to check what tables have changed since they were entered into the cache.</span></span> <span data-ttu-id="d7b7c-129">Эти таблицы был изменен, данные которого имеют их кэша связанных элементов, удаленных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-129">Those tables whose data has been modified have their associated cache items evicted.</span></span>

<span data-ttu-id="d7b7c-130">Параметр уведомлений требуется настройка, меньше, чем опроса и более детализированные, так как он отслеживает изменения на уровне запроса, а не на уровне таблицы.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-130">The notification option requires less setup than polling and is more granular since it tracks changes at the query level rather than at the table level.</span></span> <span data-ttu-id="d7b7c-131">К сожалению уведомления доступны только в полных выпусках Microsoft SQL Server 2005 (т. е. выпусков).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-131">Unfortunately, notifications are only available in the full editions of Microsoft SQL Server 2005 (i.e., the non-Express editions).</span></span> <span data-ttu-id="d7b7c-132">Однако параметр опроса можно использовать для всех версий Microsoft SQL Server 7.0 до 2005.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-132">However, the polling option can be used for all versions of Microsoft SQL Server from 7.0 to 2005.</span></span> <span data-ttu-id="d7b7c-133">Поскольку в этих учебниках используется экспресс-выпуска SQL Server 2005, мы основное внимание уделяется настройке и использовании параметр опроса.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-133">Since these tutorials use the Express edition of SQL Server 2005, we will focus on setting up and using the polling option.</span></span> <span data-ttu-id="d7b7c-134">В конце этого учебника дополнительные ресурсы по возможности уведомления SQL Server 2005 s см. в разделе дальнейшей чтения.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-134">Consult the Further Reading section at the end of this tutorial for further resources on SQL Server 2005 s notification capabilities.</span></span>

<span data-ttu-id="d7b7c-135">С использованием опроса, необходимо настроить базу данных для включения таблицы с именем `AspNet_SqlCacheTablesForChangeNotification` с тремя столбцами: `tableName`, `notificationCreated`, и `changeId`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-135">With polling, the database must be configured to include a table named `AspNet_SqlCacheTablesForChangeNotification` that has three columns - `tableName`, `notificationCreated`, and `changeId`.</span></span> <span data-ttu-id="d7b7c-136">Эта таблица содержит по одной строке для каждой таблицы, содержащий данные, которые могут понадобиться для использования в зависимости кэша SQL в веб-приложения.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-136">This table contains a row for each table that has data that might need to be used in a SQL cache dependency in the web application.</span></span> <span data-ttu-id="d7b7c-137">`tableName` Указывает имя таблицы во время `notificationCreated` указывает дату и время добавления строки в таблицу.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-137">The `tableName` column specifies the name of the table while `notificationCreated` indicates the date and time the row was added to the table.</span></span> <span data-ttu-id="d7b7c-138">`changeId` Столбец имеет тип `int` и начальное значение 0.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-138">The `changeId` column is of type `int` and has an initial value of 0.</span></span> <span data-ttu-id="d7b7c-139">Его значение увеличивается каждый после внесения изменений в таблицу.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-139">Its value is incremented with each modification to the table.</span></span>

<span data-ttu-id="d7b7c-140">В дополнение к `AspNet_SqlCacheTablesForChangeNotification` таблицы, базы данных также должен включать триггеры для каждой из таблиц, которые могут присутствовать в зависимости кэша SQL.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-140">In addition to the `AspNet_SqlCacheTablesForChangeNotification` table, the database also needs to include triggers on each of the tables that may appear in a SQL cache dependency.</span></span> <span data-ttu-id="d7b7c-141">Эти триггеры выполняются при вставке, обновлении или удалить строки и увеличить таблицу s `changeId` значение в `AspNet_SqlCacheTablesForChangeNotification`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-141">These triggers are executed whenever a row is inserted, updated, or deleted and increment the table s `changeId` value in `AspNet_SqlCacheTablesForChangeNotification`.</span></span>

<span data-ttu-id="d7b7c-142">Среда выполнения ASP.NET отслеживает текущий `changeId` для таблицы при кэшировании данных с помощью `SqlCacheDependency` объекта.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-142">The ASP.NET runtime tracks the current `changeId` for a table when caching data using a `SqlCacheDependency` object.</span></span> <span data-ttu-id="d7b7c-143">Периодически проверять базу данных, а также `SqlCacheDependency` объектов которого `changeId` отличается от значения в базе данных извлекаются с разными значениями `changeId` значение указывает, что произошло изменение в таблицу с момента кэширования данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-143">The database is periodically checked and any `SqlCacheDependency` objects whose `changeId` differs from the value in the database are evicted since a differing `changeId` value indicates that there has been a change to the table since the data was cached.</span></span>

## <a name="step-1-exploring-theaspnetregsqlexecommand-line-program"></a><span data-ttu-id="d7b7c-144">Шаг 1: Изучение`aspnet_regsql.exe`программы командной строки</span><span class="sxs-lookup"><span data-stu-id="d7b7c-144">Step 1: Exploring the`aspnet_regsql.exe`Command Line Program</span></span>

<span data-ttu-id="d7b7c-145">Подход с использованием опроса базы данных должны быть программу установки, чтобы содержать инфраструктуры, описанные выше: предопределенной таблице (`AspNet_SqlCacheTablesForChangeNotification`), небольшое число хранимых процедур и триггеров в каждой из таблиц, которые могут использоваться в зависимости кэша SQL в Интернете приложение.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-145">With the polling approach the database must be setup to contain the infrastructure described above: a predefined table (`AspNet_SqlCacheTablesForChangeNotification`), a handful of stored procedures, and triggers on each of the tables that may be used in SQL cache dependencies in the web application.</span></span> <span data-ttu-id="d7b7c-146">Эти таблицы, хранимые процедуры и триггеры могут создаваться по программе командной строки `aspnet_regsql.exe`, которая находится в `$WINDOWS$\Microsoft.NET\Framework\version` папки.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-146">These tables, stored procedures, and triggers can be created through the command line program `aspnet_regsql.exe`, which is found in the `$WINDOWS$\Microsoft.NET\Framework\version` folder.</span></span> <span data-ttu-id="d7b7c-147">Для создания `AspNet_SqlCacheTablesForChangeNotification` таблицы и связанных хранимых процедур, запустите из командной строки следующую программу:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-147">To create the `AspNet_SqlCacheTablesForChangeNotification` table and associated stored procedures, run the following from the command line:</span></span>


[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample1.cmd)]

> [!NOTE]
> <span data-ttu-id="d7b7c-148">Для выполнения этих команд login указанной базы данных должны находиться в [ `db_securityadmin` ](https://msdn.microsoft.com/library/ms188685.aspx) и [ `db_ddladmin` ](https://msdn.microsoft.com/library/ms190667.aspx) ролей.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-148">To execute these commands the specified database login must be in the [`db_securityadmin`](https://msdn.microsoft.com/library/ms188685.aspx) and [`db_ddladmin`](https://msdn.microsoft.com/library/ms190667.aspx) roles.</span></span> <span data-ttu-id="d7b7c-149">Для проверки T-SQL, отправляемые в базу данных по `aspnet_regsql.exe` командной строки программы, ознакомьтесь с [записи блога](http://scottonwriting.net/sowblog/posts/10709.aspx).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-149">To examine the T-SQL sent to the database by the `aspnet_regsql.exe` command line program, refer to [this blog entry](http://scottonwriting.net/sowblog/posts/10709.aspx).</span></span>


<span data-ttu-id="d7b7c-150">Например, чтобы добавить инфраструктуру для опроса базы данных Microsoft SQL Server с именем `pubs` на сервере базы данных с именем `ScottsServer` с использованием проверки подлинности Windows, перейдите в соответствующий каталог и, в командной строке введите следующую команду:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-150">For example, to add the infrastructure for polling to a Microsoft SQL Server database named `pubs` on a database server named `ScottsServer` using Windows Authentication, navigate to the appropriate directory and, from the command line, enter:</span></span>


[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample2.cmd)]

<span data-ttu-id="d7b7c-151">После добавления инфраструктуры уровня базы данных, необходимо добавить триггеры для таблиц, которые будут использоваться в зависимости кэша SQL.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-151">After the database-level infrastructure has been added, we need to add the triggers to those tables that will be used in SQL cache dependencies.</span></span> <span data-ttu-id="d7b7c-152">Используйте `aspnet_regsql.exe` командной строки программы снова, но указано имя таблицы с помощью `-t` переключения и вместо `-ed` переключения используйте `-et`, следующим образом:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-152">Use the `aspnet_regsql.exe` command line program again, but specify the table name using the `-t` switch and instead of using the `-ed` switch use `-et`, like so:</span></span>


[!code-html[Main](using-sql-cache-dependencies-vb/samples/sample3.html)]

<span data-ttu-id="d7b7c-153">Чтобы добавить триггеры в `authors` и `titles` таблицы на `pubs` базы данных на `ScottsServer`, используйте:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-153">To add the triggers to the `authors` and `titles` tables on the `pubs` database on `ScottsServer`, use:</span></span>


[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample4.cmd)]

<span data-ttu-id="d7b7c-154">В этом учебнике добавить триггеры в `Products`, `Categories`, и `Suppliers` таблицы.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-154">For this tutorial add the triggers to the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="d7b7c-155">Мы рассмотрим синтаксис командной строки, определенный на шаге 3.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-155">We'll look at the particular command line syntax in Step 3.</span></span>

## <a name="step-2-referencing-a-microsoft-sql-server-2005-express-edition-database-inappdata"></a><span data-ttu-id="d7b7c-156">Шаг 2: Создание ссылок на базе Microsoft SQL Server 2005, экспресс-выпуск в`App_Data`</span><span class="sxs-lookup"><span data-stu-id="d7b7c-156">Step 2: Referencing a Microsoft SQL Server 2005 Express Edition Database in`App_Data`</span></span>

<span data-ttu-id="d7b7c-157">`aspnet_regsql.exe` Программа командной строки необходимо указать имя сервера и базы данных для добавления необходимых опроса инфраструктуры.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-157">The `aspnet_regsql.exe` command line program requires the database and server name in order to add the necessary polling infrastructure.</span></span> <span data-ttu-id="d7b7c-158">Однако имя сервера и базы данных для базы данных Microsoft SQL Server 2005 Express, который находится в `App_Data` папку?</span><span class="sxs-lookup"><span data-stu-id="d7b7c-158">But what is the database and server name for a Microsoft SQL Server 2005 Express database that resides in the `App_Data` folder?</span></span> <span data-ttu-id="d7b7c-159">Вместо того, чтобы обнаружить, что имена сервера и базы данных представляют собой ли хранить обнаружил, что простой подход для присоединения базы данных, чтобы `localhost\SQLExpress` базы данных экземпляра и переименовать данных с помощью [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-159">Rather than having to discover what the database and server names are, I ve found that the simplest approach is to attach the database to the `localhost\SQLExpress` database instance and rename the data using [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx).</span></span> <span data-ttu-id="d7b7c-160">Если один из полных версий SQL Server 2005, установлены на компьютере, затем скорее всего уже установлены на компьютере SQL Server Management Studio.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-160">If you have one of the full versions of SQL Server 2005 installed on your machine, then you likely already have SQL Server Management Studio installed on your computer.</span></span> <span data-ttu-id="d7b7c-161">Если экспресс-выпуск, можно загрузить бесплатную [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-161">If you only have the Express edition, you can download the free [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span></span>

<span data-ttu-id="d7b7c-162">Сначала необходимо закрыть Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-162">Start by closing Visual Studio.</span></span> <span data-ttu-id="d7b7c-163">Затем откройте SQL Server Management Studio и выберите для подключения к `localhost\SQLExpress` серверу с помощью проверки подлинности Windows.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-163">Next, open SQL Server Management Studio and choose to connect to the `localhost\SQLExpress` server using Windows Authentication.</span></span>


![Присоединение к localhost\SQLExpress сервера](using-sql-cache-dependencies-vb/_static/image1.gif)

<span data-ttu-id="d7b7c-165">**Рис. 1**: присоединение к `localhost\SQLExpress` сервера</span><span class="sxs-lookup"><span data-stu-id="d7b7c-165">**Figure 1**: Attach to the `localhost\SQLExpress` Server</span></span>


<span data-ttu-id="d7b7c-166">После подключения к серверу Management Studio Показать сервера и имеют вложенные папки для базы данных, безопасности и т. д.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-166">After connecting to the server, Management Studio will show the server and have subfolders for the databases, security, and so forth.</span></span> <span data-ttu-id="d7b7c-167">Щелкните правой кнопкой мыши папку базы данных и выберите параметр присоединения.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-167">Right-click on the Databases folder and choose the Attach option.</span></span> <span data-ttu-id="d7b7c-168">Откроется диалоговое окно Присоединение баз данных (см. рис. 2).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-168">This will bring up the Attach Databases dialog box (see Figure 2).</span></span> <span data-ttu-id="d7b7c-169">Нажмите кнопку "Добавить" и выберите `NORTHWND.MDF` папки базы данных в вашей s приложения web `App_Data` папки.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-169">Click the Add button and select the `NORTHWND.MDF` database folder in your web application s `App_Data` folder.</span></span>


<span data-ttu-id="d7b7c-170">[![Присоедините NORTHWND. MDF базы данных из папки App_Data](using-sql-cache-dependencies-vb/_static/image2.gif)](using-sql-cache-dependencies-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-170">[![Attach the NORTHWND.MDF Database from the App_Data Folder](using-sql-cache-dependencies-vb/_static/image2.gif)](using-sql-cache-dependencies-vb/_static/image1.png)</span></span>

<span data-ttu-id="d7b7c-171">**На рисунке 2**: присоединение `NORTHWND.MDF` из базы данных `App_Data` папку ([Просмотр полноразмерное изображение](using-sql-cache-dependencies-vb/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="d7b7c-171">**Figure 2**: Attach the `NORTHWND.MDF` Database from the `App_Data` Folder ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image2.png))</span></span>


<span data-ttu-id="d7b7c-172">Базы данных добавляются в папку базы данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-172">This will add the database to the Databases folder.</span></span> <span data-ttu-id="d7b7c-173">Имя базы данных может быть полный путь к файлу базы данных или полный путь с префиксом [GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-173">The database name might be the full path to the database file or the full path prepended with a [GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier).</span></span> <span data-ttu-id="d7b7c-174">Чтобы избежать необходимости введите в это имя базы данных длительное время при использовании aspnet\_regsql.exe и средства командной строки, переименовать, присоединить базу данных с именем более понятную, просто щелкнув базы данных, выбрав переименование.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-174">To avoid having to type in this lengthy database name when using the aspnet\_regsql.exe command line tool, rename the database to a more human-friendly name by right-clicking on database just attached and choosing Rename.</span></span> <span data-ttu-id="d7b7c-175">Я хранить Моя база данных переименована в DataTutorials.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-175">I ve renamed my database to DataTutorials .</span></span>


![Присвойте имя более понятную присоединенная база данных](using-sql-cache-dependencies-vb/_static/image3.gif)

<span data-ttu-id="d7b7c-177">**Рис. 3**: переименуйте более понятную имя присоединяемой базы данных</span><span class="sxs-lookup"><span data-stu-id="d7b7c-177">**Figure 3**: Rename the Attached Database to a More Human-Friendly Name</span></span>


## <a name="step-3-adding-the-polling-infrastructure-to-the-northwind-database"></a><span data-ttu-id="d7b7c-178">Шаг 3: Добавление инфраструктуры опроса базы данных Northwind</span><span class="sxs-lookup"><span data-stu-id="d7b7c-178">Step 3: Adding the Polling Infrastructure to the Northwind Database</span></span>

<span data-ttu-id="d7b7c-179">Теперь, когда мы привязали `NORTHWND.MDF` из базы данных `App_Data` папки, мы готов для добавления в инфраструктуре опроса.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-179">Now that we have attached the `NORTHWND.MDF` database from the `App_Data` folder, we re ready to add the polling infrastructure.</span></span> <span data-ttu-id="d7b7c-180">Предположим, что можно сохранить базу данных переименован в DataTutorials, выполните следующие четыре команды:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-180">Assuming that you ve renamed the database to DataTutorials, run the following four commands:</span></span>


[!code-console[Main](using-sql-cache-dependencies-vb/samples/sample5.cmd)]

<span data-ttu-id="d7b7c-181">После выполнения этих четырех команд, правой кнопкой мыши имя базы данных в среде Management Studio и перейдите в меню задач выберите отсоединения.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-181">After running these four commands, right-click on the database name in Management Studio, go to the Tasks submenu, and choose Detach.</span></span> <span data-ttu-id="d7b7c-182">Затем закройте среду Management Studio и снова откройте Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-182">Then close Management Studio and reopen Visual Studio.</span></span>

<span data-ttu-id="d7b7c-183">После снова открыть Visual Studio, можно перейти к базе данных с помощью обозревателя серверов.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-183">Once Visual Studio has reopened, drill into the database through the Server Explorer.</span></span> <span data-ttu-id="d7b7c-184">Обратите внимание, новая таблица (`AspNet_SqlCacheTablesForChangeNotification`), новые хранимые процедуры и триггеры на `Products`, `Categories`, и `Suppliers` таблицы.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-184">Note the new table (`AspNet_SqlCacheTablesForChangeNotification`), the new stored procedures, and the triggers on the `Products`, `Categories`, and `Suppliers` tables.</span></span>


![База данных теперь включает инфраструктуру необходимости опроса](using-sql-cache-dependencies-vb/_static/image4.gif)

<span data-ttu-id="d7b7c-186">**Рис. 4**: база данных теперь включает инфраструктуру необходимости опроса</span><span class="sxs-lookup"><span data-stu-id="d7b7c-186">**Figure 4**: The Database Now Includes the Necessary Polling Infrastructure</span></span>


## <a name="step-4-configuring-the-polling-service"></a><span data-ttu-id="d7b7c-187">Шаг 4: Настройка службы опроса</span><span class="sxs-lookup"><span data-stu-id="d7b7c-187">Step 4: Configuring the Polling Service</span></span>

<span data-ttu-id="d7b7c-188">После создания необходимых таблиц, триггеров и хранимых процедур в базе данных, последний шаг — Настройка опроса службы, которое выполняется с помощью `Web.config` путем указания базы данных для использования и частоты опроса в миллисекундах.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-188">After creating the needed tables, triggers, and stored procedures in the database, the final step is to configure the polling service, which is done through `Web.config` by specifying the databases to use and the polling frequency in milliseconds.</span></span> <span data-ttu-id="d7b7c-189">Приведенная ниже разметка опрашивает базу данных "Борей" каждую секунду.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-189">The following markup polls the Northwind database once every second.</span></span>


[!code-xml[Main](using-sql-cache-dependencies-vb/samples/sample6.xml)]

<span data-ttu-id="d7b7c-190">`name` Значение в `<add>` (NorthwindDB) элемент связывает понятное имя с определенной базы данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-190">The `name` value in the `<add>` element ( NorthwindDB ) associates a human-readable name with a particular database.</span></span> <span data-ttu-id="d7b7c-191">При работе с зависимости кэша SQL, нам нужно будет ссылаться на имя базы данных, определенные здесь, а также в таблице на основе кэшированных данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-191">When working with SQL cache dependencies, we'll need to refer to the database name defined here as well as the table that the cached data is based on.</span></span> <span data-ttu-id="d7b7c-192">Мы рассмотрим способы использования `SqlCacheDependency` класса для программной связи зависимости кэша SQL с кэшированных данных в шаге 6.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-192">We'll see how to use the `SqlCacheDependency` class to programmatically associate SQL cache dependencies with cached data in Step 6.</span></span>

<span data-ttu-id="d7b7c-193">После установления зависимости кэша SQL опроса компьютер подключается к базам данных, определенных в `<databases>` элементы каждого `pollTime` миллисекунд и выполнения `AspNet_SqlCachePollingStoredProcedure` хранимой процедуры.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-193">Once a SQL cache dependency has been established, the polling system will connect to the databases defined in the `<databases>` elements every `pollTime` milliseconds and execute the `AspNet_SqlCachePollingStoredProcedure` stored procedure.</span></span> <span data-ttu-id="d7b7c-194">Эта хранимая процедура - которой был добавлен обратно в шаге 3 с помощью `aspnet_regsql.exe` Командная строка - возвращает `tableName` и `changeId` значения для каждой записи в `AspNet_SqlCacheTablesForChangeNotification`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-194">This stored procedure - which was added back in Step 3 using the `aspnet_regsql.exe` command line tool - returns the `tableName` and `changeId` values for each record in `AspNet_SqlCacheTablesForChangeNotification`.</span></span> <span data-ttu-id="d7b7c-195">Устаревший кэш-зависимости SQL вытесняются из кэша.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-195">Outdated SQL cache dependencies are evicted from the cache.</span></span>

<span data-ttu-id="d7b7c-196">`pollTime` Параметр представляет компромисс между производительностью и устареванием данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-196">The `pollTime` setting introduces a tradeoff between performance and data staleness.</span></span> <span data-ttu-id="d7b7c-197">Небольшое `pollTime` значение увеличивает количество запросов к базе данных, но более быстро вытесняет устаревшие данные из кэша.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-197">A small `pollTime` value increases the number of requests to the database, but more quickly evicts stale data from the cache.</span></span> <span data-ttu-id="d7b7c-198">Чтобы увеличить размер `pollTime` значение уменьшает количество запросов к базе данных, но увеличивает задержку между при изменении данных серверной части, и когда извлекаются связанные элементы.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-198">A larger `pollTime` value reduces the number of database requests, but increases the delay between when the backend data changes and when the related cache items are evicted.</span></span> <span data-ttu-id="d7b7c-199">К счастью запрос базы данных выполняется простая хранимая процедура возврат только несколько строк из таблицы упрощенный s.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-199">Fortunately, the database request is executing a simple stored procedure that s returning just a few rows from a simple, lightweight table.</span></span> <span data-ttu-id="d7b7c-200">Но поэкспериментировать с различными `pollTime` значения, чтобы найти идеальный баланс между базы данных устаревание доступа и данные для приложения.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-200">But do experiment with different `pollTime` values to find an ideal balance between database access and data staleness for your application.</span></span> <span data-ttu-id="d7b7c-201">Наименьшего `pollTime` допустимое значение равно 500.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-201">The smallest `pollTime` value allowed is 500.</span></span>

> [!NOTE]
> <span data-ttu-id="d7b7c-202">Приведенный выше пример предоставляет одну `pollTime` значение в `<sqlCacheDependency>` элемент, но при необходимости можно указать `pollTime` значение в `<add>` элемент.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-202">The above example provides a single `pollTime` value in the `<sqlCacheDependency>` element, but you can optionally specify the `pollTime` value in the `<add>` element.</span></span> <span data-ttu-id="d7b7c-203">Это полезно в том случае, если указано несколько баз данных и настроить частоту опроса на базу данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-203">This is useful if you have multiple databases specified and want to customize the polling frequency per database.</span></span>


## <a name="step-5-declaratively-working-with-sql-cache-dependencies"></a><span data-ttu-id="d7b7c-204">Шаг 5: Работа декларативно с зависимости кэша SQL</span><span class="sxs-lookup"><span data-stu-id="d7b7c-204">Step 5: Declaratively Working with SQL Cache Dependencies</span></span>

<span data-ttu-id="d7b7c-205">В шаги с 1 по 4 мы рассматривали настройке инфраструктуры необходимые базы данных и настроить систему опроса.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-205">In Steps 1 through 4 we looked at how to setup the necessary database infrastructure and configure the polling system.</span></span> <span data-ttu-id="d7b7c-206">С этой инфраструктуры мы теперь можно добавить элементы в кэше данных связанные зависимости кэша SQL, либо программные или декларативные методами.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-206">With this infrastructure in place, we can now add items to the data cache with an associated SQL cache dependency using either programmatic or declarative techniques.</span></span> <span data-ttu-id="d7b7c-207">На этом шаге мы изучим, как декларативно работать с зависимости кэша SQL.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-207">In this step we'll examine how to declaratively work with SQL cache dependencies.</span></span> <span data-ttu-id="d7b7c-208">На шаге 6 мы рассмотрим программный подход.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-208">In Step 6 we'll look at the programmatic approach.</span></span>

<span data-ttu-id="d7b7c-209">[Кэширование данных с помощью ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) декларативных возможностей кэширования ObjectDataSource изучена учебника.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-209">The [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) tutorial explored the declarative caching capabilities of the ObjectDataSource.</span></span> <span data-ttu-id="d7b7c-210">Просто задав `EnableCaching` свойства `True` и `CacheDuration` некоторые интервала времени для свойства, элемент управления ObjectDataSource автоматически будет кэшировать данные, возвращенные из базового объекта в течение указанного интервала.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-210">By simply setting the `EnableCaching` property to `True` and the `CacheDuration` property to some time interval, the ObjectDataSource will automatically cache the data returned from its underlying object for the specified interval.</span></span> <span data-ttu-id="d7b7c-211">Элемент управления ObjectDataSource можно также использовать одну или несколько зависимостей кэша SQL.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-211">The ObjectDataSource can also use one or more SQL cache dependencies.</span></span>

<span data-ttu-id="d7b7c-212">Чтобы продемонстрировать декларативно с помощью зависимости кэша SQL, откройте `SqlCacheDependencies.aspx` страницы в `Caching` папки и перетащите элемент управления GridView с панели элементов в конструктор.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-212">To demonstrate using SQL cache dependencies declaratively, open the `SqlCacheDependencies.aspx` page in the `Caching` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="d7b7c-213">Набор GridView s `ID` для `ProductsDeclarative` и в его смарт-тег, выберите, чтобы привязать его к новой ObjectDataSource с именем `ProductsDataSourceDeclarative`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-213">Set the GridView s `ID` to `ProductsDeclarative` and, from its smart tag, choose to bind it to a new ObjectDataSource named `ProductsDataSourceDeclarative`.</span></span>


<span data-ttu-id="d7b7c-214">[![Создать новый элемент управления ObjectDataSource ProductsDataSourceDeclarative с именем](using-sql-cache-dependencies-vb/_static/image5.gif)](using-sql-cache-dependencies-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-214">[![Create a New ObjectDataSource Named ProductsDataSourceDeclarative](using-sql-cache-dependencies-vb/_static/image5.gif)](using-sql-cache-dependencies-vb/_static/image3.png)</span></span>

<span data-ttu-id="d7b7c-215">**Рис. 5**: создать новый именованный ObjectDataSource `ProductsDataSourceDeclarative` ([Просмотр полноразмерное изображение](using-sql-cache-dependencies-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="d7b7c-215">**Figure 5**: Create a New ObjectDataSource Named `ProductsDataSourceDeclarative` ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image4.png))</span></span>


<span data-ttu-id="d7b7c-216">Настройка ObjectDataSource для использования `ProductsBLL` класс и установить на вкладке ВЫБЕРИТЕ в раскрывающемся списке `GetProducts()`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-216">Configure the ObjectDataSource to use the `ProductsBLL` class and set the drop-down list in the SELECT tab to `GetProducts()`.</span></span> <span data-ttu-id="d7b7c-217">На вкладке «обновление» выберите `UpdateProduct` перегрузка с три входных параметра - `productName`, `unitPrice`, и `productID`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-217">In the UPDATE tab, choose the `UpdateProduct` overload with three input parameters - `productName`, `unitPrice`, and `productID`.</span></span> <span data-ttu-id="d7b7c-218">Задайте раскрывающиеся списки (нет) на вкладках INSERT и DELETE.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-218">Set the drop-down lists to (None) in the INSERT and DELETE tabs.</span></span>


<span data-ttu-id="d7b7c-219">[![Используйте перегрузку UpdateProduct с тремя входными параметрами.](using-sql-cache-dependencies-vb/_static/image6.gif)](using-sql-cache-dependencies-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-219">[![Use the UpdateProduct Overload with Three Input Parameters](using-sql-cache-dependencies-vb/_static/image6.gif)](using-sql-cache-dependencies-vb/_static/image5.png)</span></span>

<span data-ttu-id="d7b7c-220">**Рис. 6**: используйте перегрузки UpdateProduct с тремя параметрами ввода ([Просмотр полноразмерное изображение](using-sql-cache-dependencies-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="d7b7c-220">**Figure 6**: Use the UpdateProduct Overload with Three Input Parameters ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image6.png))</span></span>


<span data-ttu-id="d7b7c-221">[![Выберите в списке раскрывающегося списка (нет) для вставки и удаления вкладок](using-sql-cache-dependencies-vb/_static/image7.gif)](using-sql-cache-dependencies-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-221">[![Set the Drop-Down List to (None) for the INSERT and DELETE Tabs](using-sql-cache-dependencies-vb/_static/image7.gif)](using-sql-cache-dependencies-vb/_static/image7.png)</span></span>

<span data-ttu-id="d7b7c-222">**Рис. 7**: значение раскрывающегося списка (нет) для вставки и удаления вкладок ([Просмотр полноразмерное изображение](using-sql-cache-dependencies-vb/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="d7b7c-222">**Figure 7**: Set the Drop-Down List to (None) for the INSERT and DELETE Tabs ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image8.png))</span></span>


<span data-ttu-id="d7b7c-223">После завершения работы мастера настройки источника данных Visual Studio создаст стояли и CheckBoxFields в GridView для каждого поля данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-223">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="d7b7c-224">Удаление всех полей, но `ProductName`, `CategoryName`, и `UnitPrice`и отформатировать эти поля, по своему усмотрению.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-224">Remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="d7b7c-225">В смарт-теге s GridView установите флажки включить разбиение на страницы, включить сортировку и разрешить изменение.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-225">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="d7b7c-226">Visual Studio установит ObjectDataSource s `OldValuesParameterFormatString` свойства `original_{0}`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-226">Visual Studio will set the ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="d7b7c-227">Чтобы для правильной работы средства редактирования s GridView, удалите это свойство полностью декларативного синтаксиса или верните значение по умолчанию `{0}`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-227">In order for the GridView s edit feature to work properly, either remove this property entirely from the declarative syntax or set it back to its default value, `{0}`.</span></span>

<span data-ttu-id="d7b7c-228">Наконец, добавьте веб-управления Label выше GridView и задайте его `ID` свойства `ODSEvents` и его `EnableViewState` свойства `False`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-228">Finally, add a Label Web control above the GridView and set its `ID` property to `ODSEvents` and its `EnableViewState` property to `False`.</span></span> <span data-ttu-id="d7b7c-229">После внесения этих изменений, на странице s должна выглядеть следующим образом.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-229">After making these changes, your page s declarative markup should look similar to the following.</span></span> <span data-ttu-id="d7b7c-230">Обратите внимание что хранить внесли настройки внешнего вида к GridView поля, которые не нужны для демонстрации возможностей зависимость кэша SQL.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-230">Note that I ve made a number of aesthetic customizations to the GridView fields that are not necessary to demonstrate the SQL cache dependency functionality.</span></span>


[!code-aspx[Main](using-sql-cache-dependencies-vb/samples/sample7.aspx)]

<span data-ttu-id="d7b7c-231">Создайте обработчик событий для ObjectDataSource s `Selecting` событий в его и добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-231">Next, create an event handler for the ObjectDataSource s `Selecting` event and in it add the following code:</span></span>


[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample8.vb)]

<span data-ttu-id="d7b7c-232">Помните, что ObjectDataSource s `Selecting` событие запускается только в том случае, при получении данных из базового объекта.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-232">Recall that the ObjectDataSource s `Selecting` event fires only when retrieving data from its underlying object.</span></span> <span data-ttu-id="d7b7c-233">Если элемент управления ObjectDataSource обращается к данным из собственный кэш, это событие не вызывается.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-233">If the ObjectDataSource accesses the data from its own cache, this event is not fired.</span></span>

<span data-ttu-id="d7b7c-234">Теперь посетите эту страницу через браузер.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-234">Now, visit this page through a browser.</span></span> <span data-ttu-id="d7b7c-235">Поскольку мы хранять еще для реализации, кэширование, каждый раз, страницы, сортировку или отредактировать сетку страницы отображать текст, события Selecting запускается, как показано на рис. 8.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-235">Since we ve yet to implement any caching, each time you page, sort, or edit the grid the page should display the text, �Selecting event fired, as Figure 8 shows.</span></span>


<span data-ttu-id="d7b7c-236">[![S ObjectDataSource события Selecting срабатывает каждый выгружаемого GridView, редактировать, время или Sorted](using-sql-cache-dependencies-vb/_static/image8.gif)](using-sql-cache-dependencies-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-236">[![The ObjectDataSource s Selecting Event Fires Each Time the GridView is Paged, Edited, or Sorted](using-sql-cache-dependencies-vb/_static/image8.gif)](using-sql-cache-dependencies-vb/_static/image9.png)</span></span>

<span data-ttu-id="d7b7c-237">**Рис. 8**: s ObjectDataSource `Selecting` событие активируется каждый времени выгружаемого GridView, редактирования или Sorted ([Просмотр полноразмерное изображение](using-sql-cache-dependencies-vb/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="d7b7c-237">**Figure 8**: The ObjectDataSource s `Selecting` Event Fires Each Time the GridView is Paged, Edited, or Sorted ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image10.png))</span></span>


<span data-ttu-id="d7b7c-238">Как мы видели в [кэширование данных с помощью ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) учебник, установка `EnableCaching` свойства `True` вызывает ObjectDataSource для кэширования данных в течение заданного по его `CacheDuration` свойство.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-238">As we saw in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-vb.md) tutorial, setting the `EnableCaching` property to `True` causes the ObjectDataSource to cache its data for the duration specified by its `CacheDuration` property.</span></span> <span data-ttu-id="d7b7c-239">ObjectDataSource также имеет [ `SqlCacheDependency` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx), который добавляет одну или несколько зависимостей кэша SQL к кэшированным данным, используя шаблон:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-239">The ObjectDataSource also has a [`SqlCacheDependency` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx), which adds one or more SQL cache dependencies to the cached data using the pattern:</span></span>


[!code-css[Main](using-sql-cache-dependencies-vb/samples/sample9.css)]

<span data-ttu-id="d7b7c-240">Где *databaseName* — имя базы данных, как указано в `name` атрибут `<add>` элемент в `Web.config`, и *tableName* имя таблицы базы данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-240">Where *databaseName* is the name of the database as specified in the `name` attribute of the `<add>` element in `Web.config`, and *tableName* is the name of the database table.</span></span> <span data-ttu-id="d7b7c-241">Например, для создания ObjectDataSource, который кэширует данные в течение неограниченного времени на основе зависимость кэша SQL для Northwind s `Products` таблица, набор ObjectDataSource s `EnableCaching` свойства `True` и его `SqlCacheDependency` свойства NorthwindDB:Products.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-241">For example, to create an ObjectDataSource that caches data indefinitely based on a SQL cache dependency against the Northwind s `Products` table, set the ObjectDataSource s `EnableCaching` property to `True` and its `SqlCacheDependency` property to NorthwindDB:Products .</span></span>

> [!NOTE]
> <span data-ttu-id="d7b7c-242">Можно использовать зависимость кэша SQL *и* на основе времени окончания срока действия, задав `EnableCaching` для `True`, `CacheDuration` для интервала времени и `SqlCacheDependency` на имена базы данных и таблицы.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-242">You can use a SQL cache dependency *and* a time-based expiry by setting `EnableCaching` to `True`, `CacheDuration` to the time interval, and `SqlCacheDependency` to the database and table name(s).</span></span> <span data-ttu-id="d7b7c-243">ObjectDataSource исключим его данные при достижении на основе времени окончания срока действия или опроса система сообщает, что основной базы данных изменилось, какое событие произойдет раньше.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-243">The ObjectDataSource will evict its data when the time-based expiry is reached or when the polling system notes that the underlying database data has changed, whichever happens first.</span></span>


<span data-ttu-id="d7b7c-244">GridView с `SqlCacheDependencies.aspx` отображает данные из двух таблиц - `Products` и `Categories` (продукта s `CategoryName` поля извлекается из `JOIN` на `Categories`).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-244">The GridView in `SqlCacheDependencies.aspx` displays data from two tables - `Products` and `Categories` (the product s `CategoryName` field is retrieved via a `JOIN` on `Categories`).</span></span> <span data-ttu-id="d7b7c-245">Таким образом, необходимо указать две зависимости кэша SQL: NorthwindDB:Products; NorthwindDB:Categories.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-245">Therefore, we want to specify two SQL cache dependencies: NorthwindDB:Products;NorthwindDB:Categories .</span></span>


<span data-ttu-id="d7b7c-246">[![Настройка ObjectDataSource для поддержки кэширования с помощью зависимости кэша SQL на продукты и категории](using-sql-cache-dependencies-vb/_static/image9.gif)](using-sql-cache-dependencies-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-246">[![Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on Products and Categories](using-sql-cache-dependencies-vb/_static/image9.gif)](using-sql-cache-dependencies-vb/_static/image11.png)</span></span>

<span data-ttu-id="d7b7c-247">**Рис. 9**: Настройка ObjectDataSource для поддержки кэширования с помощью кэш-зависимости SQL на `Products` и `Categories` ([Просмотр полноразмерное изображение](using-sql-cache-dependencies-vb/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="d7b7c-247">**Figure 9**: Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on `Products` and `Categories` ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image12.png))</span></span>


<span data-ttu-id="d7b7c-248">После настройки ObjectDataSource для поддержки кэширования, обращаются к странице через браузер.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-248">After configuring the ObjectDataSource to support caching, revisit the page through a browser.</span></span> <span data-ttu-id="d7b7c-249">Опять же возникает событие выделение текста появится при первом посещении страницы, но должна исчезнуть при разбиение по страницам, сортировки или кнопки редактирования или "Отмена".</span><span class="sxs-lookup"><span data-stu-id="d7b7c-249">Again, the text �Selecting event fired should appear on the first page visit, but should go away when paging, sorting, or clicking the Edit or Cancel buttons.</span></span> <span data-ttu-id="d7b7c-250">Это, поскольку после загрузки данных в кэш s ObjectDataSource остается там до `Products` или `Categories` таблицы изменять или обновлять данные с помощью GridView.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-250">This is because after the data is loaded into the ObjectDataSource s cache, it remains there until the `Products` or `Categories` tables are modified or the data is updated through the GridView.</span></span>

<span data-ttu-id="d7b7c-251">AFTER, срабатывающим разбиения по страницам сетки и отметить отсутствие события Selecting текст, откройте новое окно браузера и перейдите в учебнике основы редактирования, вставки и удаления раздела (`~/EditInsertDelete/Basics.aspx`).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-251">After paging through the grid and noting the lack of the �Selecting event fired text, open a new browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="d7b7c-252">Обновите имя или цену продукта.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-252">Update the name or price of a product.</span></span> <span data-ttu-id="d7b7c-253">Затем из первого окно браузера, просмотра на другую страницу данных, сортировки сетки или нажмите кнопку Правка строк.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-253">Then, from to the first browser window, view a different page of data, sort the grid, or click a row s Edit button.</span></span> <span data-ttu-id="d7b7c-254">Это время события Selecting создается, следует вновь как основной базы данных, данные были изменены (см. рис. 10).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-254">This time, the �Selecting event fired should reappear, as the underlying database data has been modified (see Figure 10).</span></span> <span data-ttu-id="d7b7c-255">Если текст не отображается, подождите немного и повторите попытку.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-255">If the text does not appear, wait a few moments and try again.</span></span> <span data-ttu-id="d7b7c-256">Помните, что опроса службы проверяет наличие изменений в `Products` таблицы каждый `pollTime` миллисекунд, так что задержка между при обновлении базовых данных и если вытеснение кэшированных данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-256">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>


<span data-ttu-id="d7b7c-257">[![Изменение таблицы Products исключает кэшированные данные](using-sql-cache-dependencies-vb/_static/image10.gif)](using-sql-cache-dependencies-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-257">[![Modifying the Products Table Evicts the Cached Product Data](using-sql-cache-dependencies-vb/_static/image10.gif)](using-sql-cache-dependencies-vb/_static/image13.png)</span></span>

<span data-ttu-id="d7b7c-258">**Рис. 10**: изменение таблицы Products исключает кэшированных данных продукта ([Просмотр полноразмерное изображение](using-sql-cache-dependencies-vb/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="d7b7c-258">**Figure 10**: Modifying the Products Table Evicts the Cached Product Data ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image14.png))</span></span>


## <a name="step-6-programmatically-working-with-thesqlcachedependencyclass"></a><span data-ttu-id="d7b7c-259">Шаг 6: Программными средствами работы с`SqlCacheDependency`класса</span><span class="sxs-lookup"><span data-stu-id="d7b7c-259">Step 6: Programmatically Working with the`SqlCacheDependency`Class</span></span>

<span data-ttu-id="d7b7c-260">[Кэширование данных в архитектуре](caching-data-in-the-architecture-vb.md) учебника рассказывали преимуществ использования архитектуры, в отличие от тесной взаимозависимости между обработчиком кэширование с ObjectDataSource отдельном слое кэширования.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-260">The [Caching Data in the Architecture](caching-data-in-the-architecture-vb.md) tutorial looked at the benefits of using a separate Caching Layer in the architecture as opposed to tightly coupling the caching with the ObjectDataSource.</span></span> <span data-ttu-id="d7b7c-261">В этом учебнике мы создали `ProductsCL` для демонстрации программными средствами работы с кэшем данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-261">In that tutorial we created a `ProductsCL` class to demonstrate programmatically working with the data cache.</span></span> <span data-ttu-id="d7b7c-262">Чтобы использовать зависимости кэша SQL в слое кэширование, `SqlCacheDependency` класса.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-262">To utilize SQL cache dependencies in the Caching Layer, use the `SqlCacheDependency` class.</span></span>

<span data-ttu-id="d7b7c-263">В системе опроса `SqlCacheDependency` объект должен быть связан с парой определенной базы данных и таблицы.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-263">With the polling system, a `SqlCacheDependency` object must be associated with a particular database and table pair.</span></span> <span data-ttu-id="d7b7c-264">Например, следующий код создает `SqlCacheDependency` объекта, основанного на базе данных Northwind s `Products` таблицы:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-264">The following code, for example, creates a `SqlCacheDependency` object based on the Northwind database s `Products` table:</span></span>


[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample10.vb)]

<span data-ttu-id="d7b7c-265">Два входных параметров для `SqlCacheDependency` конструктор s являются именами базы данных и таблицы, соответственно.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-265">The two input parameters to the `SqlCacheDependency` s constructor are the database and table names, respectively.</span></span> <span data-ttu-id="d7b7c-266">Как и с ObjectDataSource s `SqlCacheDependency` свойство, используется имя базы данных является таким же, как указано в значении `name` атрибут `<add>` элемент в `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-266">Like with the ObjectDataSource s `SqlCacheDependency` property, the database name used is the same as the value specified in the `name` attribute of the `<add>` element in `Web.config`.</span></span> <span data-ttu-id="d7b7c-267">Имя таблицы — это реальное имя таблицы базы данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-267">The table name is the actual name of the database table.</span></span>

<span data-ttu-id="d7b7c-268">Чтобы связать `SqlCacheDependency` с элемента, добавленных в кэш данных, используйте один из `Insert` перегрузки метода, которые принимает зависимость.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-268">To associate a `SqlCacheDependency` with an item added to the data cache, use one of the `Insert` method overloads that accepts a dependency.</span></span> <span data-ttu-id="d7b7c-269">Следующий код добавляет *значение* для кэширования данных неопределенное время, но связывает его с `SqlCacheDependency` на `Products` таблицы.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-269">The following code adds *value* to the data cache for an indefinite duration, but associates it with a `SqlCacheDependency` on the `Products` table.</span></span> <span data-ttu-id="d7b7c-270">Иными словами *значение* будет оставаться в кэше, пока он удаляется из-за нехватки памяти или из-за опроса система обнаружила, `Products` таблица была изменена, так как он был кэширован.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-270">In short, *value* will remain in the cache until it is evicted due to memory constraints or because the polling system has detected that the `Products` table has changed since it was cached.</span></span>


[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample11.vb)]

<span data-ttu-id="d7b7c-271">Кэширование слоя s `ProductsCL` класс в настоящее время кэширует данные из `Products` таблицу на основе времени окончания срока действия 60 секунд.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-271">The Caching Layer s `ProductsCL` class currently caches data from the `Products` table using a time-based expiry of 60 seconds.</span></span> <span data-ttu-id="d7b7c-272">Разрешить обновление этого класса, чтобы он использовал зависимости кэша SQL s.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-272">Let s update this class so that it uses SQL cache dependencies instead.</span></span> <span data-ttu-id="d7b7c-273">`ProductsCL` Класса s `AddCacheItem` метод, который отвечает за добавление данных в кэш, в настоящее время содержит следующий код:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-273">The `ProductsCL` class s `AddCacheItem` method, which is responsible for adding the data to the cache, currently contains the following code:</span></span>


[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample12.vb)]

<span data-ttu-id="d7b7c-274">Обновление кода, используемого `SqlCacheDependency` объекта вместо `MasterCacheKeyArray` зависимости кэша:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-274">Update this code to use a `SqlCacheDependency` object instead of the `MasterCacheKeyArray` cache dependency:</span></span>


[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample13.vb)]

<span data-ttu-id="d7b7c-275">Протестировать эти функции, добавьте элемент управления GridView на страницу под существующий `ProductsDeclarative` GridView.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-275">To test this functionality, add a GridView to the page beneath the existing `ProductsDeclarative` GridView.</span></span> <span data-ttu-id="d7b7c-276">Задайте этот новый s GridView `ID` для `ProductsProgrammatic` и через его смарт-тег, привязать его к новой ObjectDataSource с именем `ProductsDataSourceProgrammatic`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-276">Set this new GridView s `ID` to `ProductsProgrammatic` and, through its smart tag, bind it to a new ObjectDataSource named `ProductsDataSourceProgrammatic`.</span></span> <span data-ttu-id="d7b7c-277">Настройка ObjectDataSource для использования `ProductsCL` класса, задание раскрывающихся списков в инструкции SELECT и UPDATE вкладок, чтобы `GetProducts` и `UpdateProduct`соответственно.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-277">Configure the ObjectDataSource to use the `ProductsCL` class, setting the drop-down lists in the SELECT and UPDATE tabs to `GetProducts` and `UpdateProduct`, respectively.</span></span>


<span data-ttu-id="d7b7c-278">[![Настройка ObjectDataSource с помощью класса ProductsCL](using-sql-cache-dependencies-vb/_static/image11.gif)](using-sql-cache-dependencies-vb/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-278">[![Configure the ObjectDataSource to Use the ProductsCL Class](using-sql-cache-dependencies-vb/_static/image11.gif)](using-sql-cache-dependencies-vb/_static/image15.png)</span></span>

<span data-ttu-id="d7b7c-279">**Рис. 11**: Настройка ObjectDataSource для использования `ProductsCL` класса ([Просмотр полноразмерное изображение](using-sql-cache-dependencies-vb/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="d7b7c-279">**Figure 11**: Configure the ObjectDataSource to Use the `ProductsCL` Class ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image16.png))</span></span>


<span data-ttu-id="d7b7c-280">[![Выберите метод GetProducts из раскрывающегося списка ВЫБЕРИТЕ вкладку s](using-sql-cache-dependencies-vb/_static/image12.gif)](using-sql-cache-dependencies-vb/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-280">[![Select the GetProducts Method from the SELECT Tab s Drop-Down List](using-sql-cache-dependencies-vb/_static/image12.gif)](using-sql-cache-dependencies-vb/_static/image17.png)</span></span>

<span data-ttu-id="d7b7c-281">**Рис. 12**: выберите `GetProducts` метод из раскрывающегося списка ВЫБЕРИТЕ вкладку s ([Просмотр полноразмерное изображение](using-sql-cache-dependencies-vb/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="d7b7c-281">**Figure 12**: Select the `GetProducts` Method from the SELECT Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image18.png))</span></span>


<span data-ttu-id="d7b7c-282">[![Выберите метод UpdateProduct из обновления вкладку s раскрывающегося списка](using-sql-cache-dependencies-vb/_static/image13.gif)](using-sql-cache-dependencies-vb/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-282">[![Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List](using-sql-cache-dependencies-vb/_static/image13.gif)](using-sql-cache-dependencies-vb/_static/image19.png)</span></span>

<span data-ttu-id="d7b7c-283">**Рис. 13**: выберите метод UpdateProduct из раскрывающегося списка вкладку обновление s ([Просмотр полноразмерное изображение](using-sql-cache-dependencies-vb/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="d7b7c-283">**Figure 13**: Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-vb/_static/image20.png))</span></span>


<span data-ttu-id="d7b7c-284">После завершения работы мастера настройки источника данных Visual Studio создаст стояли и CheckBoxFields в GridView для каждого поля данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-284">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="d7b7c-285">Как и первый GridView, добавляемые на эту страницу, удалите все поля, но `ProductName`, `CategoryName`, и `UnitPrice`и отформатировать эти поля, по своему усмотрению.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-285">Like with the first GridView added to this page, remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="d7b7c-286">В смарт-теге s GridView установите флажки включить разбиение на страницы, включить сортировку и разрешить изменение.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-286">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="d7b7c-287">Как и в `ProductsDataSourceDeclarative` ObjectDataSource, Visual Studio установит `ProductsDataSourceProgrammatic` ObjectDataSource s `OldValuesParameterFormatString` свойства `original_{0}`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-287">As with the `ProductsDataSourceDeclarative` ObjectDataSource, Visual Studio will set the `ProductsDataSourceProgrammatic` ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="d7b7c-288">В порядке, для правильной работы, установите это свойство компонента GridView s изменения обратно в `{0}` (или полностью удалить назначение свойства из декларативного синтаксиса).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-288">In order for the GridView s edit feature to work properly, set this property back to `{0}` (or remove the property assignment from the declarative syntax altogether).</span></span>

<span data-ttu-id="d7b7c-289">После выполнения этих задач, полученный GridView и ObjectDataSource декларативная разметка должна выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-289">After completing these tasks, the resulting GridView and ObjectDataSource declarative markup should look like the following:</span></span>


[!code-aspx[Main](using-sql-cache-dependencies-vb/samples/sample14.aspx)]

<span data-ttu-id="d7b7c-290">Для проверки SQL зависимости в кэше в слое кэширования установите точку останова в `ProductCL` класса s `AddCacheItem` метода и затем запустить отладку.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-290">To test the SQL cache dependency in the Caching Layer set a breakpoint in the `ProductCL` class s `AddCacheItem` method and then start debugging.</span></span> <span data-ttu-id="d7b7c-291">При первом посещении `SqlCacheDependencies.aspx`, точка останова должна быть достигнута как запрошен в первый раз и помещенных в кэш данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-291">When you first visit `SqlCacheDependencies.aspx`, the breakpoint should be hit as the data is requested for the first time and placed into the cache.</span></span> <span data-ttu-id="d7b7c-292">После этого перехода на другую страницу в GridView или один из столбцов сортировки.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-292">Next, move to another page in the GridView or sort one of the columns.</span></span> <span data-ttu-id="d7b7c-293">В результате GridView для повторного запроса данных, но данные должны находиться в кэше с момента `Products` таблицы базы данных не была изменена.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-293">This causes the GridView to requery its data, but the data should be found in the cache since the `Products` database table has not been modified.</span></span> <span data-ttu-id="d7b7c-294">Если данные повторно не найден в кэше, убедитесь, что имеется достаточно памяти на компьютере и повторите попытку.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-294">If the data is repeatedly not found in the cache, make sure there is sufficient memory available on your computer and try again.</span></span>

<span data-ttu-id="d7b7c-295">После разбиение по страницам нескольких страниц GridView, откройте второе окно браузера и перейдите в учебнике основы редактирования, вставки и удаления раздела (`~/EditInsertDelete/Basics.aspx`).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-295">After paging through a few pages of the GridView, open a second browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="d7b7c-296">Обновление записи из таблицы Products и просмотрите новую страницу из первого окна браузера или щелкните один из заголовков сортировки.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-296">Update a record from the Products table and then, from the first browser window, view a new page or click on one of the sorting headers.</span></span>

<span data-ttu-id="d7b7c-297">В этом случае вы увидите одно из следующих действий: либо будут иметь точки останова, указывающее, что кэшированные данные был исключен из-за изменения в базе данных. или не быть останова, это значит, что `SqlCacheDependencies.aspx` отображается устаревшие данные.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-297">In this scenario you will see one of two things: either the breakpoint will be hit, indicating that the cached data was evicted due to the change in the database; or, the breakpoint will not be hit, meaning that `SqlCacheDependencies.aspx` is now showing stale data.</span></span> <span data-ttu-id="d7b7c-298">Если не будет достигнута точка останова, вполне вероятно, так как служба опроса не еще сработал с момента изменения данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-298">If the breakpoint is not hit, it is likely because the polling service has not yet fired since the data was changed.</span></span> <span data-ttu-id="d7b7c-299">Помните, что опроса службы проверяет наличие изменений в `Products` таблицы каждый `pollTime` миллисекунд, так что задержка между при обновлении базовых данных и если вытеснение кэшированных данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-299">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>

> [!NOTE]
> <span data-ttu-id="d7b7c-300">Эта задержка чаще всего для отображения при изменении одного из продуктов через GridView в `SqlCacheDependencies.aspx`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-300">This delay is more likely to appear when editing one of the products through the GridView in `SqlCacheDependencies.aspx`.</span></span> <span data-ttu-id="d7b7c-301">В [кэширование данных в архитектуре](caching-data-in-the-architecture-vb.md) учебника мы добавили `MasterCacheKeyArray` зависимости, чтобы убедиться, что данные редактируемого через кэша `ProductsCL` класса s `UpdateProduct` метод был исключен из кэша.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-301">In the [Caching Data in the Architecture](caching-data-in-the-architecture-vb.md) tutorial we added the `MasterCacheKeyArray` cache dependency to ensure that the data being edited through the `ProductsCL` class s `UpdateProduct` method was evicted from the cache.</span></span> <span data-ttu-id="d7b7c-302">Тем не менее, мы заменили зависимости в кэше, при изменении `AddCacheItem` метод ранее на этом шаге и, следовательно, `ProductsCL` класса будут отображать кэшированные данные, пока система опроса сообщает изменение `Products` таблицы.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-302">However, we replaced this cache dependency when modifying the `AddCacheItem` method earlier in this step and therefore the `ProductsCL` class will continue to show the cached data until the polling system notes the change to the `Products` table.</span></span> <span data-ttu-id="d7b7c-303">Мы рассмотрим способы повторное добавление `MasterCacheKeyArray` кэшировать зависимостей в шаге 7.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-303">We'll see how to reintroduce the `MasterCacheKeyArray` cache dependency in Step 7.</span></span>


## <a name="step-7-associating-multiple-dependencies-with-a-cached-item"></a><span data-ttu-id="d7b7c-304">Шаг 7: Связывание несколько зависимостей с кэшированного элемента</span><span class="sxs-lookup"><span data-stu-id="d7b7c-304">Step 7: Associating Multiple Dependencies with a Cached Item</span></span>

<span data-ttu-id="d7b7c-305">Помните, что `MasterCacheKeyArray` зависимости в кэше используется, чтобы убедиться, что *все* продуктах данных извлекается из кэша, когда обновляется связанный внутри его ни от одного объекта.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-305">Recall that the `MasterCacheKeyArray` cache dependency is used to ensure that *all* product-related data is evicted from the cache when any single item associated within it is updated.</span></span> <span data-ttu-id="d7b7c-306">Например `GetProductsByCategoryID(categoryID)` кэши метод `ProductsDataTables` экземпляров для каждого уникальный *categoryID* значение.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-306">For example, the `GetProductsByCategoryID(categoryID)` method caches `ProductsDataTables` instances for each unique *categoryID* value.</span></span> <span data-ttu-id="d7b7c-307">Если вытеснение одного из этих объектов `MasterCacheKeyArray` зависимости в кэше гарантирует, что другие также удаляются.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-307">If one of these objects is evicted, the `MasterCacheKeyArray` cache dependency ensures that the others are also removed.</span></span> <span data-ttu-id="d7b7c-308">Без этой зависимости кэша при изменении кэшированных данных существует возможность, других продукта кэшированные данные могут быть устаревшими.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-308">Without this cache dependency, when the cached data is modified the possibility exists that other cached product data may be out of date.</span></span> <span data-ttu-id="d7b7c-309">Следовательно, он s, важно, что мы поддерживать `MasterCacheKeyArray` зависимости кэша при использовании зависимости кэша SQL.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-309">Consequently, it s important that we maintain the `MasterCacheKeyArray` cache dependency when using SQL cache dependencies.</span></span> <span data-ttu-id="d7b7c-310">Тем не менее, данные кэша s `Insert` метод допускает только одну зависимость объекта.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-310">However, the data cache s `Insert` method only allows for a single dependency object.</span></span>

<span data-ttu-id="d7b7c-311">Кроме того при работе с зависимости кэша SQL мы может понадобиться связать нескольких таблиц баз данных в качестве зависимостей.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-311">Furthermore, when working with SQL cache dependencies we may need to associate multiple database tables as dependencies.</span></span> <span data-ttu-id="d7b7c-312">Например `ProductsDataTable` кэшированных в `ProductsCL` класс содержит категорию и поставщика имена для каждого продукта, но `AddCacheItem` метод использует только зависимости на `Products`.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-312">For example, the `ProductsDataTable` cached in the `ProductsCL` class contains the category and supplier names for each product, but the `AddCacheItem` method only uses a dependency on `Products`.</span></span> <span data-ttu-id="d7b7c-313">В этом случае если пользователь обновляет имя категории или поставщика, кэшированные данные будут остаются в кэше и имеет более старую версию.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-313">In this situation, if the user updates the name of a category or supplier, the cached product data will remain in the cache and be out of date.</span></span> <span data-ttu-id="d7b7c-314">Таким образом, мы хотим сделать зависимым от данных кэшированные продукта не только `Products` таблицы, но на `Categories` и `Suppliers` таблицы.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-314">Therefore, we want to make the cached product data dependent on not only the `Products` table, but on the `Categories` and `Suppliers` tables as well.</span></span>

<span data-ttu-id="d7b7c-315">[ `AggregateCacheDependency` Класс](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx) предоставляет средства для связывания несколько зависимостей с элементом кэша.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-315">The [`AggregateCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx) provides a means for associating multiple dependencies with a cache item.</span></span> <span data-ttu-id="d7b7c-316">Начните с создания `AggregateCacheDependency` экземпляра.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-316">Start by creating an `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="d7b7c-317">Добавьте набор зависимостей с помощью `AggregateCacheDependency` s `Add` метод.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-317">Next, add the set of dependencies using the `AggregateCacheDependency` s `Add` method.</span></span> <span data-ttu-id="d7b7c-318">При вставке элемента в кэше данных соответственно, передайте `AggregateCacheDependency` экземпляра.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-318">When inserting the item into the data cache thereafter, pass in the `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="d7b7c-319">Когда *любой* из `AggregateCacheDependency` изменить экземпляр s зависимости, удаления кэшированного элемента.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-319">When *any* of the `AggregateCacheDependency` instance s dependencies change, the cached item will be evicted.</span></span>

<span data-ttu-id="d7b7c-320">Ниже показан обновленный код для `ProductsCL` класса s `AddCacheItem` метод.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-320">The following shows the updated code for the `ProductsCL` class s `AddCacheItem` method.</span></span> <span data-ttu-id="d7b7c-321">Этот метод создает `MasterCacheKeyArray` кэшировать зависимостей вместе с `SqlCacheDependency` объектов для `Products`, `Categories`, и `Suppliers` таблицы.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-321">The method creates the `MasterCacheKeyArray` cache dependency along with `SqlCacheDependency` objects for the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="d7b7c-322">Они были объединены в одну `AggregateCacheDependency` объект с именем `aggregateDependencies`, который затем передается в `Insert` метод.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-322">These are all combined into one `AggregateCacheDependency` object named `aggregateDependencies`, which is then passed into the `Insert` method.</span></span>


[!code-vb[Main](using-sql-cache-dependencies-vb/samples/sample15.vb)]

<span data-ttu-id="d7b7c-323">Проверьте новый код out. Он изменится `Products`, `Categories`, или `Suppliers` таблиц привести к вытеснению кэшированных данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-323">Test this new code out. Now changes to the `Products`, `Categories`, or `Suppliers` tables cause the cached data to be evicted.</span></span> <span data-ttu-id="d7b7c-324">Кроме того `ProductsCL` класса s `UpdateProduct` метод, который вызывается при изменении продукта через GridView, исключает `MasterCacheKeyArray` зависимости, что приведет к тому кэшированные кэша `ProductsDataTable` вытеснения и данные, извлекаемые повторно при следующем запрос.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-324">Moreover, the `ProductsCL` class s `UpdateProduct` method, which is called when editing a product through the GridView, evicts the `MasterCacheKeyArray` cache dependency, which causes the cached `ProductsDataTable` to be evicted and the data to be re-retrieved on the next request.</span></span>

> [!NOTE]
> <span data-ttu-id="d7b7c-325">Кэш-зависимости SQL также может использоваться с [кэширование вывода](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-325">SQL cache dependencies can also be used with [output caching](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx).</span></span> <span data-ttu-id="d7b7c-326">Демонстрацию этой функции см. в разделе: [с помощью кэширования выходных данных ASP.NET с помощью SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-326">For a demonstration of this functionality, see: [Using ASP.NET Output Caching with SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx).</span></span>


## <a name="summary"></a><span data-ttu-id="d7b7c-327">Сводка</span><span class="sxs-lookup"><span data-stu-id="d7b7c-327">Summary</span></span>

<span data-ttu-id="d7b7c-328">При кэшировании данных базы данных, данные в идеале будет оставаться в кэше до его изменения в базе данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-328">When caching database data, the data will ideally remain in the cache until it is modified in the database.</span></span> <span data-ttu-id="d7b7c-329">В ASP.NET 2.0 можно создать и использовать в сценариях декларативные и программные зависимости кэша SQL.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-329">With ASP.NET 2.0, SQL cache dependencies can be created and used in both declarative and programmatic scenarios.</span></span> <span data-ttu-id="d7b7c-330">Одна из сложностей при таком подходе возможности обнаружения при изменении данных.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-330">One of the challenges with this approach is in discovering when the data has been modified.</span></span> <span data-ttu-id="d7b7c-331">Полные версии Microsoft SQL Server 2005 предоставляют возможности уведомления, которые можно предупредить приложения при изменении результатов запроса.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-331">The full versions of Microsoft SQL Server 2005 provide notification capabilities that can alert an application when a query result has changed.</span></span> <span data-ttu-id="d7b7c-332">Express Edition SQL Server 2005 и более ранних версий SQL Server необходимо использовать систему опроса.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-332">For the Express Edition of SQL Server 2005 and older versions of SQL Server, a polling system must be used instead.</span></span> <span data-ttu-id="d7b7c-333">К счастью настройке инфраструктуры необходимости опроса выполняется очень просто.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-333">Fortunately, setting up the necessary polling infrastructure is fairly straightforward.</span></span>

<span data-ttu-id="d7b7c-334">Программирование довольны!</span><span class="sxs-lookup"><span data-stu-id="d7b7c-334">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="d7b7c-335">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="d7b7c-335">Further Reading</span></span>

<span data-ttu-id="d7b7c-336">Дополнительные сведения по темам, рассматриваемые в этом учебнике см. в следующих ресурсах:</span><span class="sxs-lookup"><span data-stu-id="d7b7c-336">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="d7b7c-337">Использование уведомлений о запросах в Microsoft SQL Server 2005</span><span class="sxs-lookup"><span data-stu-id="d7b7c-337">Using Query Notifications in Microsoft SQL Server 2005</span></span>](https://msdn.microsoft.com/library/ms175110.aspx)
- [<span data-ttu-id="d7b7c-338">Создание уведомления о запросе</span><span class="sxs-lookup"><span data-stu-id="d7b7c-338">Creating a Query Notification</span></span>](https://msdn.microsoft.com/library/ms188669.aspx)
- <span data-ttu-id="d7b7c-339">[Кэширование в ASP.NET с `SqlCacheDependency` класса](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-339">[Caching in ASP.NET with the `SqlCacheDependency` Class](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span></span>
- <span data-ttu-id="d7b7c-340">[Средство регистрации ASP.NET SQL Server (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-340">[ASP.NET SQL Server Registration Tool (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span></span>
- [<span data-ttu-id="d7b7c-341">Общие сведения о`SqlCacheDependency`</span><span class="sxs-lookup"><span data-stu-id="d7b7c-341">Overview of `SqlCacheDependency`</span></span>](http://www.aspnetresources.com/blog/sql_cache_depedency_overview.aspx)

## <a name="about-the-author"></a><span data-ttu-id="d7b7c-342">Об авторе</span><span class="sxs-lookup"><span data-stu-id="d7b7c-342">About the Author</span></span>

<span data-ttu-id="d7b7c-343">[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи ASP/ASP.NET и основателя из [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Майкрософт с 1998 года.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-343">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="d7b7c-344">Скотт — независимый консультант, trainer и записи.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-344">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="d7b7c-345">Его последняя книга — [ *диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-345">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="d7b7c-346">Он может быть достигнута по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="d7b7c-346">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="d7b7c-347">Благодарности</span><span class="sxs-lookup"><span data-stu-id="d7b7c-347">Special Thanks To</span></span>

<span data-ttu-id="d7b7c-348">Этот учебник ряд прошел проверку многие полезные рецензентов.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-348">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="d7b7c-349">Основными редакторами этого учебника были Marko Rangel Тереза д Мерфи и – Хилтон Гизнау.</span><span class="sxs-lookup"><span data-stu-id="d7b7c-349">Lead reviewers for this tutorial were Marko Rangel, Teresa Murphy, and Hilton Giesenow.</span></span> <span data-ttu-id="d7b7c-350">Объясняются моих последующих статей для MSDN?</span><span class="sxs-lookup"><span data-stu-id="d7b7c-350">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="d7b7c-351">Если Да, напишите мне по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="d7b7c-351">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

>[!div class="step-by-step"]
[<span data-ttu-id="d7b7c-352">Назад</span><span class="sxs-lookup"><span data-stu-id="d7b7c-352">Previous</span></span>](caching-data-at-application-startup-vb.md)

---
uid: web-forms/overview/advanced/aspnet-web-forms-connection-resiliency-and-command-interception
title: Устойчивость подключений ASP.NET Web Forms и команда перехвата | Документы Microsoft
author: Erikre
description: Этот учебник описывает изменение образец приложения для поддержки устойчивость подключения и команды перехвата.
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/31/2014
ms.topic: article
ms.assetid: 6d497001-fa80-4765-b4cc-181fe90b894e
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/advanced/aspnet-web-forms-connection-resiliency-and-command-interception
msc.type: authoredcontent
ms.openlocfilehash: d5c4e46209e1b21a303fdf1fb16c6c868b3ca923
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
<a name="aspnet-web-forms-connection-resiliency-and-command-interception"></a>Устойчивость подключений ASP.NET Web Forms и перехвата команды
====================
по [Эрик Reitan](https://github.com/Erikre)

В этом учебнике предстоит изменить пример приложения Wingtip Toys поддерживает устойчивость подключений и перехвата команды. Включение устойчивость подключений, пример приложения Wingtip Toys автоматически повторит попытку вызовов данных возникновения временных ошибок, типичные для облачной среды. Кроме того, путем реализации команды перехвата, пример приложения Wingtip Toys будет перехватывать все SQL-запросы, отправляемые в базу данных для входа или их изменения.

> [!NOTE] 
> 
> Этот учебник веб-форм был основан на следующем учебнике MVC Tom Dykstra:  
> [Устойчивость подключения и команды перехвата с платформой Entity Framework в приложении ASP.NET MVC](../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application.md)


## <a name="what-youll-learn"></a>Что вы узнаете следующее.

- Как обеспечить устойчивость подключения.
- Как реализовать команду перехвата.

## <a name="prerequisites"></a>Предварительные требования

Прежде чем начать, убедитесь, что имеется следующее программное обеспечение на компьютере:

- [Microsoft Visual Studio 2013](https://www.microsoft.com/visualstudio/11/downloads#vs) или [Microsoft Visual Studio Express 2013 для Web](https://www.microsoft.com/visualstudio/11/downloads#express-web). Платформа .NET Framework устанавливается автоматически.
- Wingtip Toys образец проекта, так что можно реализовать функции, упомянутые в этом учебнике в рамках проекта Wingtip Toys. Следующая ссылка предоставляет сведения о загрузке:

    - [Приступая к работе с ASP.NET 4.5.1 веб-формы - Wingtip Toys](https://go.microsoft.com/fwlink/?LinkID=389434&amp;clcid=0x409) (C#)
- До завершения этого учебника рекомендуется ознакомиться связанных рядов учебника, [Приступая к работе с веб-форм ASP.NET 4.5 и Visual Studio 2013](../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md). Серии учебника помогут ознакомиться с **WingtipToys** проекта и кода.

## <a name="connection-resiliency"></a>Устойчивость подключений

При выборе развертывания приложения в Windows Azure, попробуйте выполняет развертывание базы данных для **Windows** **базы данных SQL Azure**, облачная служба баз данных. При подключении базы данных в облачную службу, чем при веб-сервер и сервер базы данных непосредственно соединены вместе в одном центре обработки данных, временных ошибок соединения обычно более часто. Даже если облако веб-сервера и облачная служба баз данных размещаются в одном центре обработки данных, существуют дополнительные сетевые подключения между ними, которые могут иметь проблемы, такие как подсистемы балансировки нагрузки.

Также облачной службы обычно совместно используется другими пользователями, что означает, что отклик может повлиять на их. И доступ к базе данных может контролироваться регулирования. Регулирование означает службу базы данных создает исключения, при попытке получить доступ к чаще, чем разрешено в вашей *соглашение об уровне обслуживания* (SLA).

Многие или большинства проблем подключения, возникающие при обращении к облачной службе являются временными, то есть они самоустраниться за короткий период времени. Поэтому при попытке выполнения операции базы данных получить тип ошибки, которая обычно временных, удалось повторите попытку после короткое время ожидания и операция может оказаться успешной. Можно обеспечить гораздо более широкие для пользователей, если обработки временных ошибок автоматически повторите попытку позднее, обеспечение невидимости большинство из них для клиента. Функция устойчивости подключений в Entity Framework 6 автоматизирует процесс повторного аварийное завершение SQL-запросов.

Функция устойчивости подключений должны быть настроены для конкретной базы данных службы соответствующим образом.

1. Он должен знать, какие исключения могут быть временной. Необходимо повторить ошибки, вызванные временная потеря сетевого подключения, не ошибки, вызванные ошибками программы, например.
2. Она должна ожидать соответствующий период времени между повторными попытками сбоя операции. Можно отложить больше между повторными попытками для пакетной обработки чем для документации веб-страницы, где пользователь ожидает ответа.
3. Он должен повторить попытку на достаточное количество раз, прежде чем прекратить попытки. Может потребоваться повторить несколько раз во время пакетной обработки, как в интерактивном приложении.

Можно настроить эти параметры вручную для среды базы данных поддерживается поставщиком Entity Framework.

Необходимо выполнить, чтобы включить устойчивость подключений достаточно создать класс, производный от сборки `DbConfiguration` и в этом классе укажите стратегия выполнения базы данных SQL, который в Entity Framework является другой терм для политики повтора.

### <a name="implementing-connection-resiliency"></a>Реализация устойчивость подключений

1. Загрузите и откройте [WingtipToys](https://go.microsoft.com/fwlink/?LinkID=389434&amp;clcid=0x409) образец приложения Web Forms в Visual Studio.
2. В *логику* папки **WingtipToys** приложения, добавьте файл класса с именем *WingtipToysConfiguration.cs*.
3. Замените существующий код следующим кодом:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample1.cs)]

Entity Framework автоматически выполняет код в класс, производный от `DbConfiguration`. Можно использовать `DbConfiguration` классе для выполнения задач настройки в коде, в противном случае это делается в *Web.config* файла. Дополнительные сведения см. в разделе [EntityFramework конфигурации на основе кода](https://msdn.microsoft.com/data/jj680699).

1. В *логику* откройте *AddProducts.cs* файла.
2. Добавить `using` инструкции для `System.Data.Entity.Infrastructure` , выделенный желтым цветом:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample2.cs?highlight=6)]
3. Добавить `catch` заблокировать к `AddProduct` метод, чтобы `RetryLimitExceededException` регистрируется как выделенный в желтый цвет:   

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample3.cs?highlight=14-15,17-22)]

Добавив `RetryLimitExceededException` исключения, можно предоставить лучше ведения журнала или отображать сообщение об ошибке для пользователя, где они могут решить повторите процесс. Перехват `RetryLimitExceededException` исключения, единственные ошибки, скорее всего, будут временными будет уже были испытаны и не удалось выполнить несколько раз. Фактический возвращенное исключение будет вставлено в `RetryLimitExceededException` исключение. Кроме того можно добавить общий блок catch. Дополнительные сведения о `RetryLimitExceededException` исключения, в разделе [устойчивость подключений Entity Framework и логика повторных попыток](https://msdn.microsoft.com/data/dn456835).

## <a name="command-interception"></a>Команда перехвата

Теперь, когда вы включили политику повтора, как вы тестируете для проверки, что он работает как ожидалось? Это не так просто принудительно временная ошибка происходит, особенно когда у вас локально, и он будет особенно трудно интегрировать фактические временные ошибки в автоматических модульных тестов. Чтобы протестировать функция устойчивости подключений, вам необходим способ перехватывать запросы, которые отправляет Entity Framework для SQL Server и замените тип исключения, который обычно временных ответа SQL Server.

Перехват запросов также можно использовать для реализации рекомендации для облачных приложений: задержки и успешность всех вызывает внешнее журнала служб, например службы баз данных.

В этом разделе учебника будет использоваться Entity Framework [ *возможность перехвата* ](https://msdn.microsoft.com/data/dn469464) для ведения журнала и моделирование временных ошибок.

### <a name="create-a-logging-interface-and-class"></a>Создание класса и интерфейса записи журнала

Для ведения журнала рекомендуется сделать это с помощью [ `interface` ](https://msdn.microsoft.com/library/ms173156.aspx) вместо жестко запрограммированного вызовы `System.Diagnostics.Trace` или класс ведения журнала. Облегчает изменить позже на механизме регистрации в журнале, в дальнейшем для этого. Поэтому в этом разделе мы создадим интерфейс ведения журнала и класса для его реализации.

На основании описанной выше процедуры, загрузки и открыть **WingtipToys** образец приложения в Visual Studio.

1. Создание папки в **WingtipToys** проект и назовите его *ведение журнала*.
2. В *входа* папки, создайте файл класса с именем *ILogger.cs* и замените код по умолчанию следующим кодом:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample4.cs)]

   Этот интерфейс предоставляет три уровня трассировки, чтобы указать относительную важность журналы и разработанное для предоставления сведений о задержке для вызовов внешней службы, такие как запросы к базе данных. Методы ведения журнала имеют перегрузки, которые позволяют передавать исключение. Это, чтобы сведения об исключении, включая стека трассировки и внутренние исключения надежно регистрируется с помощью класса, который реализует интерфейс, не полагаясь на который выполняется при каждом вызове метода ведения журнала в приложении.  
  
   `TraceApi` Методы можно использовать для отслеживания задержки каждого вызова внешней службы, такие как базы данных SQL.
3. В *входа* папки, создайте файл класса с именем *Logger.cs* и замените код по умолчанию следующим кодом:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample5.cs)]

Реализация использует `System.Diagnostics` для выполнения трассировки. Это встроенная функция .NET, что упрощает создание и использование сведений трассировки. Существует много &quot;прослушиватели&quot; можно использовать с `System.Diagnostics` трассировки для записи файлы, например, журналы или записывать их в хранилище больших двоичных объектов в Windows Azure. Некоторые параметры и ссылки на другие ресурсы для получения дополнительной информации см. в [Устранение неполадок Windows Azure веб-сайтов в Visual Studio](https://docs.microsoft.com/azure/app-service-web/web-sites-dotnet-troubleshoot-visual-studio). В этом учебнике будет просто просмотреть журналы в Visual Studio **вывода** окна.

В реальном приложении может потребоваться рассмотреть возможность использования платформы трассировки не `System.Diagnostics`и `ILogger` интерфейс позволяет относительно просто перейдите к механизм различных трассировки, если вы решите сделать это.

### <a name="create-interceptor-classes"></a>Создайте классы перехватчик

Затем вы создадите классы, которые платформа Entity Framework будет вызывать каждый раз, он будет отправлять запрос в базу данных, один для имитации временных ошибок и один для ведения журнала выполнения. Эти классы перехватчик должен быть производным от `DbCommandInterceptor` класса. В них написать переопределения методов, которые будут автоматически вызывается, когда запрос будет выполняться. В этих методах проверки или запрос, который отправляется в базу данных журнала, и можно изменить запрос перед отправкой в базу данных или возвращать результат в Entity Framework самостоятельно без даже передача запроса к базе данных.

1. Чтобы создать класс перехватчик, которая будет записывать каждый запрос SQL перед их отправкой в базу данных, создайте файл класса с именем *InterceptorLogging.cs* в *логику* папки и заменить значение по умолчанию код с Следующий код:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample6.cs)]

   Для успешных запросов или команд этот код записывает журнал сведений с сведения о задержке. Для исключения он создает журнал ошибок.
2. Для создания перехватчик класса, который создаст пустой временных ошибок при вводе &quot;Throw&quot; в **имя** текстового поля на странице с именем *AdminPage.aspx*, создайте класс файл с именем *InterceptorTransientErrors.cs* в *логику* папки, а также заменить значение по умолчанию код следующим кодом:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample7.cs)]

    Этот код только переопределения `ReaderExecuting` метод, который вызывается для запросов, которые могут возвращать несколько строк данных. Если вы хотите проверить устойчивость подключений для других типов запросов, можно также переопределить `NonQueryExecuting` и `ScalarExecuting` методов, качестве перехватчик ведения журнала не.  
  
   Позже, войдите в систему как «Администратор» и выберите **администратора** ссылку на верхней панели навигации. Затем на *AdminPage.aspx* страницы, добавите продукт с именем &quot;Throw&quot;. Код создает исключение пустой базы данных SQL для номер ошибки 20, типа, известного как обычно временной. Другие коды ошибок, в настоящее время распознается в качестве временного являются 64, 233, 10053, 10054, 10060, 10928, 10929, 40197, 40501 и 40613, но они могут быть изменены в новые версии базы данных SQL. Продукт будет переименован в «TransientErrorExample», вы можете использовать в коде *InterceptorTransientErrors.cs* файла.  
  
   Код возвращает исключение в Entity Framework, вместо выполнения запроса и полученные результаты назад. Временное исключение возвращается *четыре* раз, после чего код принимает обычные процедуры передачи запроса к базе данных.

    Так как все, что зарегистрирован, можно будет видеть, что Entity Framework пытается выполнить запрос предшествовало в четыре раза, и единственное различие в приложении заключается в том, что занимает больше времени для визуализации страницы с результатами запроса.  
  
   Сколько раз повторит попытку Entity Framework является настраиваемым; код определяет четыре раза, так как это значение по умолчанию для политики выполнения базы данных SQL. Если изменить политику выполнения, было также изменение здесь код, который указывает, сколько раз создаются временные ошибки. Можно также изменить код для создания исключения, чтобы Entity Framework вызовет `RetryLimitExceededException` исключение.
3. В *Global.asax*, добавьте следующие операторы using:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample8.cs)]
4. Затем добавьте выделенные строки к `Application_Start` метод:  

    [!code-csharp[Main](aspnet-web-forms-connection-resiliency-and-command-interception/samples/sample9.cs?highlight=17-20)]

Следующие строки кода находятся в каком случае перехватчик кода для запуска при Entity Framework отправляет запросы к базе данных. Обратите внимание, что поскольку вы создали перехватчик отдельные классы для имитации временной ошибки и ведения журнала, вы можете независимо включить или отключить их.   
  
 Можно добавить с помощью перехватчики `DbInterception.Add` метод в любом месте в коде; он не должен быть в `Application_Start` метод. Другой вариант, если не добавить перехватчики в `Application_Start` метод, можно обновить или добавить класс с именем *WingtipToysConfiguration.cs* и поместите этот код в конце конструктора `WingtipToysbConfiguration` класса.

Везде, где поместите этот код следует избегать использования для выполнения `DbInterception.Add` для того же перехватчик более чем один раз, или получите дополнительные перехватчик экземпляров. Например если дважды добавить перехватчик ведения журнала, вы увидите два журнала для каждого запроса SQL.

Перехватчики выполняются в порядке регистрации (порядок, в котором `DbInterception.Add` метод вызывается). Порядок может играть важную роль в зависимости от выполняемых задач в перехватчик. Например, перехватчик может изменить команду SQL, получаемый в `CommandText` свойство. Если это приводит к изменению команду SQL, далее перехватчик получит измененные команды SQL, а не исходной команды SQL.

В результате которого позволяет вызвать временные ошибки, указав другое значение в пользовательском Интерфейсе написал код имитации временной ошибки. Кроме того можно написать код перехватчик всегда создать последовательность временных исключений без проверки значение конкретного параметра. Затем можно добавить перехватчик только в том случае, если вы хотите создавать временные ошибки. Если это сделать, тем не менее, не добавляйте перехватчик до после завершения инициализации базы данных. Другими словами выполните операцию по крайней мере одна база данных, например запрос на одном из наборов сущностей, перед началом создания временных ошибок. Платформа Entity Framework выполняет несколько запросов во время инициализации базы данных, и они не выполняются в транзакции, в случае ошибки во время инициализации может возникнуть контекста в несогласованном состоянии.

## <a name="test-logging-and-connection-resiliency"></a>Ведение журнала и подключение устойчивости теста

1. В Visual Studio нажмите клавишу **F5** для запуска приложения в режиме отладки, а затем войдите в систему как «Admin», с помощью «word Pa$ $» в качестве пароля.
2. Выберите **администратора** из панели инструментов в верхней части.
3. Введите новый продукт с именем «Throw» с подходящими описание, цену и изображения.
4. Нажмите клавишу **добавить продукт** кнопки.  
   Вы заметите, что браузер видимому зависания несколько секунд, пока Entity Framework повторением запроса несколько раз. Первый Повтор происходит очень быстро, а затем увеличивает время ожидания перед каждой следующей попытки. Процесс больше ожидания перед каждой попыткой повтора называется *экспоненциально растущим* .
5. Подождите, пока она больше не atttempting для загрузки.
6. Остановите проект, а затем просмотрите Visual Studio **вывода** окна, чтобы отобразить выходные данные трассировки. Можно найти **вывода** , выбрав **отладки**  - &gt; **Windows**  - &gt;  **Выходные данные**. Может потребоваться прокрутить за несколько журналов, написанное на средства ведения журнала.  
  
   Обратите внимание, что отображаются фактические SQL-запросы, отправляемые в базу данных. Вы увидите некоторые начальных запросов и команд, как это делает Entity Framework, чтобы приступить к работе, проверка таблицы журнала версии и миграции базы данных.   
    ![Окно выходных данных](aspnet-web-forms-connection-resiliency-and-command-interception/_static/image1.png)   
   Обратите внимание, невозможно повторить этот тест, если не остановить приложение и перезапустите его. Если вы хотите иметь возможность проверить устойчивость подключений, несколько раз в рамках одного запуска приложения, можно написать код, чтобы сбросить счетчик ошибок в `InterceptorTransientErrors` .
7. Чтобы увидеть разницу стратегия выполнения (политику повторов) преобразует, комментарий `SetExecutionStrategy` строку в *WingtipToysConfiguration.cs* файла в *логику* папки, запустите **администратора**  страницу в режиме отладки, а затем добавьте продукт с именем &quot;Throw&quot; еще раз.  
  
   Это время отладчик останавливается на первой порожденное исключение немедленно при попытке выполнения запроса в первый раз.  
    ![Отладка — Просмотр сведений](aspnet-web-forms-connection-resiliency-and-command-interception/_static/image2.png)
8. Раскомментируйте `SetExecutionStrategy` строку в *WingtipToysConfiguration.cs* файла.

## <a name="summary"></a>Сводка

В этом учебнике вы знаете, как изменить пример приложения веб-форм для поддержки устойчивость подключения и команды перехвата.

## <a name="next-steps"></a>Следующие шаги

После просмотра устойчивость подключений и перехвата команды в веб-форм ASP.NET, ознакомьтесь с разделом, веб-форм ASP.NET [асинхронных методов в ASP.NET 4.5](../performance-and-caching/using-asynchronous-methods-in-aspnet-45.md). Разделе описываются основы построения асинхронного приложения веб-форм ASP.NET с помощью Visual Studio.

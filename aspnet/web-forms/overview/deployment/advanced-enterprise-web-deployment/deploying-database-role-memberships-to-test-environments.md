---
uid: web-forms/overview/deployment/advanced-enterprise-web-deployment/deploying-database-role-memberships-to-test-environments
title: "Развертывание членства в роли базы данных в средах тестирования | Документы Microsoft"
author: jrjlee
description: "В этом разделе описывается добавление учетных записей пользователей к ролям базы данных как часть развертывания решения в тестовой среде. При развертывании в решение, содержащее..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 05/04/2012
ms.topic: article
ms.assetid: 9b2af539-7ad9-47aa-b66e-873bd9906e79
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/deployment/advanced-enterprise-web-deployment/deploying-database-role-memberships-to-test-environments
msc.type: authoredcontent
ms.openlocfilehash: 226c28622f76e866fba1fc33cf9b9b7a01e5295b
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2018
---
<a name="deploying-database-role-memberships-to-test-environments"></a>Развертывание членства в роли базы данных в тестовой среде
====================
по [Джейсон Lee](https://github.com/jrjlee)

[Скачать PDF](https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/63/56/8130.DeployingWebAppsInEnterpriseScenarios.pdf)

> В этом разделе описывается добавление учетных записей пользователей к ролям базы данных как часть развертывания решения в тестовой среде.
> 
> Если вы развертываете решение, содержащее проект базы данных для промежуточной или рабочей среде, обычно не следует разработчикам автоматизировать добавление учетных записей пользователей в роли базы данных. В большинстве случаев разработчик не будет знать, какие учетные записи пользователей должны быть добавлены к роли базы данных, и эти требования могут быть изменены в любое время. Тем не менее при развертывании решение, содержащее проект базы данных в среде разработки или тестовой среде, ситуация отличается обычно вместо:
> 
> - Разработчик обычно выполняет повторное развертывание решения на регулярной основе, часто несколько раз в день.
> - Обычно база данных повторно создается на каждое развертывание, это означает, что пользователи базы данных должно быть создано и добавить в роли после каждого развертывания.
> - Обычно разработчик имеет полный контроль над целевой среды разработки или тестирования.
> 
> В этом сценарии часто бывает полезным для автоматического создания базы данных пользователей и назначить членство в ролях базы данных как часть процесса развертывания.
> 
> Ключевым фактором является то, что эта операция должна быть условного в зависимости от целевой среды. Если вы развертываете тестовой или рабочей среде, вы хотите пропустить операцию. Если вы развертываете разработчика или тестовой среды, вы хотите развернуть членство в ролях без дальнейшего вмешательства. В этом разделе описывается один из подходов, которыми можно использовать для решения этой проблемы.


Этот раздел входит в состав серию учебников, исходя из требования к развертыванию enterprise вымышленная компания Fabrikam, Inc. Этот учебник ряд использует образец решения & #x 2014; [решения диспетчера контактов](../web-deployment-in-the-enterprise/the-contact-manager-solution.md)& #x 2014; для представления веб-приложения с реалистичных уровень сложности, включая приложения ASP.NET MVC 3, Windows Службы Communication Foundation (WCF) и проект базы данных.

Метод развертывания, в основе этих учебников основан на разбиение проекта файл подход, описанный в [основные сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md), в которой процесс построения управляется двух проектов файлы & #x 2014; один с построение инструкции, которые применяются для каждой целевой среде и, содержащий параметры построения и развертывания конкретной среды. Во время построения файла проекта среды объединяется в файл проекта зависит от среды, образуют полный набор инструкций построения.

## <a name="task-overview"></a>Общие сведения о задаче

В этом разделе предполагается, что:

- Используйте разбиение подход файл проекта для развертывания решения, описанные в [основные сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md).
- Вызовите VSDBCMD из файла проекта для развертывания проекта базы данных, как описано в [основные сведения о процессе построения](../web-deployment-in-the-enterprise/understanding-the-build-process.md).

Чтобы создать пользователей базы данных и назначить членство в ролях, при развертывании проекта базы данных в тестовой среде, необходимо:

- Создайте сценарий Transact языка структурированных запросов (Transact-SQL), который делает базы данных, необходимые изменения.
- Создайте целевой объект Microsoft Build Engine (MSBuild), который использует программы sqlcmd.exe, чтобы запустить сценарий SQL.
- Настройка файлов проекта для вызова целевой, при развертывании решения в тестовой среде.

В этом разделе будет показано, как для выполнения каждой из этих процедур.

## <a name="scripting-the-database-role-memberships"></a>Сценарии членства в роли базы данных

Можно создать скрипт Transact-SQL в большом объеме различными способами и выберите в любом месте. Проще всего создать скрипт в решении Visual Studio 2010.

**Чтобы создать сценарий SQL**

1. В **обозревателе решений** окна, разверните узел проекта базы данных.
2. Щелкните правой кнопкой мыши **сценариев** папку, выберите пункт **добавить**, а затем нажмите кнопку **новую папку**.
3. Тип **тест** как имя папки и нажмите клавишу ВВОД.
4. Щелкните правой кнопкой мыши **тест** папку, выберите пункт **добавить**и нажмите кнопку **сценарий**.
5. В **Добавление нового элемента** диалогового окна Предоставьте сценарий понятное имя (например, **AddRoleMemberships.sql**) и нажмите кнопку **добавить**.

    ![](deploying-database-role-memberships-to-test-environments/_static/image1.png)
6. В *AddRoleMemberships.sql* файл, добавьте инструкции Transact-SQL:

    1. Создание пользователя базы данных для имени входа SQL Server, который получит доступ к базе данных.
    2. Добавление пользователя базы данных ни одной базы данных, необходимых роли.
7. Файл должен выглядеть примерно следующим образом:

    [!code-sql[Main](deploying-database-role-memberships-to-test-environments/samples/sample1.sql)]
8. Сохраните файл.

## <a name="executing-the-script-on-the-target-database"></a>Выполнение скрипта в целевой базе данных

В идеальном случае будет запускать любые необходимые сценарии Transact-SQL в скрипте после развертывания при развертывании проекта базы данных. Однако после развертывания сценарии не позволяют выполнить логику условно на основе конфигурации решения или свойства построения. Можно запустить скрипты SQL непосредственно из файла проекта MSBuild, создав **целевой** элемент, который выполняет команду sqlcmd.exe. Эта команда используется для запуска скрипта в целевой базе данных:


[!code-console[Main](deploying-database-role-memberships-to-test-environments/samples/sample2.cmd)]


> [!NOTE]
> Дополнительные сведения о параметрах командной строки sqlcmd см. в разделе [программы sqlcmd](https://msdn.microsoft.com/library/ms162773.aspx).


Прежде чем внедрять этой команды в целевой объект MSBuild, следует принять во внимание при каких условиях требуется для выполнения сценария:

- Целевой базы данных должен существовать, прежде чем изменить его членство в ролях. Таким образом, необходимо запустить этот сценарий *после* развертывания базы данных.
- Необходимо включить условие, чтобы скрипт выполняется только для тестовых сред.
- Если вы используете развертывания «что, если» & #x 2014; другими словами, если создание скриптов развертывания, но фактически не запущен их & #x 2014; не следует работать скрипт SQL.

Если вы используете разбиение проекта файл подход, описанный в [основные сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md), как показано образец решения диспетчера контактов, можно разделить инструкции построения для сценария SQL следующим образом:

- Требуемые свойства, зависящие от среды, вместе с свойство, которое определяет, следует ли развертывать разрешения, должен использоваться в файле проекта, относящихся к среде (например, *Env Dev.proj*).
- Целевой объект MSBuild, вместе со всех свойств, которые не изменится между средами назначения должны перейти в файле универсального проекта (например, *Publish.proj*).

В файле проекта для конкретной среды необходимо определить имя сервера базы данных, имя целевой базы данных и логическое свойство, которое дает пользователю возможность указать, следует ли развертывать членство в ролях.


[!code-xml[Main](deploying-database-role-memberships-to-test-environments/samples/sample3.xml)]


В файле универсального проекта необходимо указать расположение исполняемом файле sqlcmd и расположение сценария SQL, который требуется запустить. Эти свойства будет оставаться неизменным независимо от целевой среды. Необходимо также создать целевой объект MSBuild для выполнения команды sqlcmd.


[!code-xml[Main](deploying-database-role-memberships-to-test-environments/samples/sample4.xml)]


Обратите внимание, добавьте расположение исполняемом файле sqlcmd, как статическое свойство, как это может быть полезно для других целевых объектов. Напротив он определяет расположение сценария SQL и синтаксис команды sqlcmd как динамические свойства в целевом объекте, как они не должны перед выполнением целевой объект. В этом случае **DeployTestDBPermissions** целевой будет выполняться только при соблюдении следующих условий:

- **DeployTestDBRoleMemberships** свойству **true**.
- Пользователь не указал **WhatIf = true** флаг.

Наконец не забудьте целевой объект вызова. В *Publish.proj* файла, это можно сделать, добавив целевой список зависимостей для значения по умолчанию **FullPublish** цели. Необходимо убедиться, что **DeployTestDBPermissions** целевой объект не выполняется до **PublishDbPackages** целевой объект был выполнен.


[!code-xml[Main](deploying-database-role-memberships-to-test-environments/samples/sample5.xml)]


## <a name="conclusion"></a>Заключение

В этом разделе описывается один способ, в котором можно добавить пользователей базы данных и ролей как действие после развертывания при развертывании проекта базы данных. Это обычно бывает удобным, когда регулярно повторно создать базу данных в тестовой среде, но его следует избегать обычно при развертывании баз данных в промежуточной или производственной среды. Таким образом вам следует использовать необходимые условную логику, чтобы пользователи базы данных и членства в роли создаются только при необходимости делать это.

## <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения об использовании VSDBCMD для развертывания проектов базы данных см. в разделе [развертывание проектов базы данных](../web-deployment-in-the-enterprise/deploying-database-projects.md). Рекомендации по настройке развертывания базы данных для различных целевых средах см. в разделе [Настройка развертывания базы данных для нескольких сред](customizing-database-deployments-for-multiple-environments.md). Дополнительные сведения об использовании пользовательские файлы проекта MSBuild для управления процессом развертывания см. в разделе [основные сведения о файле проекта](../web-deployment-in-the-enterprise/understanding-the-project-file.md) и [основные сведения о процессе построения](../web-deployment-in-the-enterprise/understanding-the-build-process.md). Дополнительные сведения о параметрах командной строки sqlcmd см. в разделе [программы sqlcmd](https://msdn.microsoft.com/library/ms162773.aspx).

>[!div class="step-by-step"]
[Назад](customizing-database-deployments-for-multiple-environments.md)
[Вперед](deploying-membership-databases-to-enterprise-environments.md)

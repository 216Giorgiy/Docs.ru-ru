---
uid: web-forms/overview/older-versions-security/introduction/forms-authentication-configuration-and-advanced-topics-cs
title: Настройки проверки подлинности и дополнительные разделы (C#) | Документы Microsoft
author: rick-anderson
description: В этом учебнике мы Изучите различные параметры проверки подлинности форм и узнать, как их изменяют через элемент формы. Это будет основан подробные...
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/14/2008
ms.topic: article
ms.assetid: b9c29865-a34e-48bb-92c0-c443a72cb860
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-security/introduction/forms-authentication-configuration-and-advanced-topics-cs
msc.type: authoredcontent
ms.openlocfilehash: 58d87bd6211ae1b1eea227d34c001239efcf5f1d
ms.sourcegitcommit: 356c8d394aaf384c834e9c90cabab43bfe36e063
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/26/2018
ms.locfileid: "36961403"
---
<a name="forms-authentication-configuration-and-advanced-topics-c"></a>Настройка проверки подлинности форм и дополнительные разделы (C#)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Загрузить код](http://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/ASPNET_Security_Tutorial_03_CS.zip) или [скачать PDF](http://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/aspnet_tutorial03_AuthAdvanced_cs.pdf)

> В этом учебнике мы Изучите различные параметры проверки подлинности форм и узнать, как их изменяют через элемент формы. Это будет основан подробное описание настройки страницы входа при помощи пользовательский URL-адрес (например, SignIn.aspx вместо Login.aspx) и билеты форм без поддержки файлов cookie проверки подлинности значение времени ожидания билета проверки подлинности форм.


## <a name="introduction"></a>Вступление

В [с предыдущим учебником](an-overview-of-forms-authentication-cs.md) мы рассмотрели действия, необходимые для реализации проверки подлинности форм в приложении ASP.NET, смогут указать параметры конфигурации в файле Web.config для создания различных входа страницы для отображения содержимое для пользователей, прошедших проверку подлинности и анонимный. Помните, что настраивался веб-сайт на использование проверки подлинности форм, задав атрибут режима &lt;проверки подлинности&gt; элемент формы. &lt;Проверки подлинности&gt; элемента может включать &lt;forms&gt; дочерний элемент, через который может быть указан набор параметров проверки подлинности форм.

В этом учебнике мы Изучите различные параметры проверки подлинности форм и узнать, как изменить их с помощью &lt;forms&gt; элемента. Это будет основан подробное описание настройки страницы входа при помощи пользовательский URL-адрес (например, SignIn.aspx вместо Login.aspx) и билеты форм без поддержки файлов cookie проверки подлинности значение времени ожидания билета проверки подлинности форм. Мы также подробнее изучить состава билета проверки подлинности форм и меры предосторожности, чтобы обеспечить безопасность из проверки и незаконное изменение данных билета как ASP.NET см. Наконец мы рассмотрим способы хранения данных дополнительных пользователей в билета проверки подлинности форм и смоделировать эти данные через пользовательского объекта-участника.

## <a name="step-1-examining-the-ltformsgt-configuration-settings"></a>Шаг 1: Проверка &lt;forms&gt; параметры конфигурации

Система проверки подлинности форм в ASP.NET обеспечивает множество параметров конфигурации, которые можно настраивать для отдельных приложений по. Сюда входят параметры, такие как: время существования форм проверки подлинности билета; какие виды защита применяется к билета; в разделе какие условия без поддержки файлов cookie проверки подлинности используются билеты; путь к странице входа; и другие сведения. Чтобы изменить значения по умолчанию, добавьте [ &lt;forms&gt; элемент](https://msdn.microsoft.com/library/1d3t3c61.aspx) как дочерний [ &lt;проверки подлинности&gt; элемент](https://msdn.microsoft.com/library/532aee0e.aspx), указав эти свойства значения, которые необходимо настроить как атрибуты XML следующим образом:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample1.xml)]

В таблице 1 перечислены свойства, которые можно настроить с помощью &lt;forms&gt; элемента. Поскольку XML-файла Web.config, имена атрибутов в левом столбце учитывается регистр.


| <strong>Attribute (XElement Dynamic Property)</strong> (Attribute (динамическое свойство XElement)) |                                                                                                                                                                                                                                     <strong>Описание</strong>                                                                                                                                                                                                                                      |
|----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|         без поддержки файлов cookie         |                                                                                                                Этот атрибут указывает, при каких условиях билет проверки подлинности хранится в файле cookie, и они внедрены в URL-адрес. Допустимые значения: UseCookies; UseUri; Автоматическое определение параметров; и UseDeviceProfile (по умолчанию). Шаг 2 проверяет этот параметр более подробно.                                                                                                                |
|         defaultUrl         |                                                                                                                                                         Указывает URL-адрес, который пользователи будут перенаправлены после входа в систему со страницы входа, если нет RedirectUrl значения, указанного в строке запроса. Значение по умолчанию — default.aspx.                                                                                                                                                         |
|           домен           | При использовании билетов проверки подлинности на основе файлов cookie, этот параметр указывает значение домена файла cookie. Значение по умолчанию — пустая строка, которая заставляет браузер использовать домен, из которого он был выдан (например, www.yourdomain.com). В этом случае файл cookie будет <strong>не</strong> отправляться, когда создание запросов для дочерних доменов, например admin.yourdomain.com. Если вы хотите куки-файл должен быть передан на все дочерние домены, необходимо настроить атрибут домена, указав для нее значение yourdomain.com. |
|  enableCrossAppRedirects   |                                                                                                                                                                   Логическое значение, указывающее, сохраненных прошедших проверку подлинности пользователей при перенаправлении на URL-адреса в других веб-приложений на том же сервере. Значение по умолчанию – false.                                                                                                                                                                   |
|          loginUrl          |                                                                                                                                                                                                                      URL-адрес страницы входа. Значение по умолчанию — login.aspx.                                                                                                                                                                                                                      |
|            имя            |                                                                                                                                                                                                   При использовании проверки подлинности на основе файлов cookie билеты, имя файла cookie. Значение по умолчанию —. ASPXAUTH.                                                                                                                                                                                                   |
|            путем            |                                                                             При использовании билетов проверки подлинности на основе файлов cookie, этот параметр указывает атрибут пути файла cookie. Атрибут пути позволяет разработчику ограничить область куки-файла в определенном каталоге иерархию. Значение по умолчанию — /, информирующий браузер для отправки файла cookie билет проверки подлинности на любой запрос, выполненных в домене.                                                                              |
|         защита         |                                                                                                                                            Указывает, какие методы используются для защиты билета проверки подлинности форм. Допустимые значения: все (по умолчанию); Шифрование; None; и их проверку. Эти параметры подробно описываются в шаге 3.                                                                                                                                            |
|         requireSSL         |                                                                                                                                                                                Логическое значение, указывающее, требуется ли SSL-соединение для передачи файла cookie проверки подлинности. Значением по умолчанию является false.                                                                                                                                                                                |
|     slidingExpiration      |                                                                                                 Логическое значение, указывающее ли время ожидания файла cookie проверки подлинности сбрасывается каждый раз пользователь посещает сайт во время одного сеанса. Значение по умолчанию — true. Политика времени ожидания билета проверки подлинности рассматривается более подробно в задание раздела значение времени ожидания билета.                                                                                                 |
|          timeout           |                                                                                                                               Время в минутах, после которого истекает срок действия файла cookie билет проверки подлинности. Значение по умолчанию — 30. Политика времени ожидания билета проверки подлинности рассматривается более подробно в задание раздела значение времени ожидания билета.                                                                                                                               |

**Таблица 1**: Сводка &lt;forms&gt; атрибутов элемента

В ASP.NET 2.0 и выше, значение по умолчанию значения для проверки подлинности форм жестко запрограммированы в классе FormsAuthenticationConfiguration в .NET Framework. Все изменения должны применяться для отдельных приложений, в файле Web.config. Это отличается от ASP.NET 1.x, где значения по умолчанию для проверки подлинности форм были сохранены в файле machine.config (и таким образом могут быть изменены через редактирования machine.config). Время на темы ASP.NET 1.x, что стоит упомянуть что ряд параметров системы проверки подлинности форм имеют разные значения по умолчанию в ASP.NET 2.0 и дальше, чем в ASP.NET 1.x. При переносе приложения в среде ASP.NET 1.x важно учитывать эти различия. Обратитесь к [ &lt;forms&gt; технической документации элемент](https://msdn.microsoft.com/library/1d3t3c61.aspx) список различий.

> [!NOTE]
> Несколько параметров проверки подлинности форм, такие как время ожидания, домена и пути, укажите сведения для результирующего файла cookie билет проверки подлинности форм. Дополнительные сведения о файлы cookie, как они работают и их различные свойства чтения [этого учебника файлы cookie](http://www.quirksmode.org/js/cookies.html).


### <a name="specifying-the-tickets-timeout-value"></a>Указав значение времени ожидания билета

Билет проверки подлинности форм является маркер, который представляет собой удостоверение. С билетов проверки подлинности на основе файлов cookie этот токен сохраняется в форме куки-файла и отправляются на веб-сервер при каждом запросе. Владения маркером, по сути, объявляет, я *username*, я уже выполнен вход и используется, поэтому можно запомнить удостоверение пользователя между посещений страницы.

Билет проверки подлинности форм не только включает удостоверение пользователя, но также содержит сведения для обеспечения целостности и безопасности маркера. В конце концов мы не хотим сделать злоумышленнику иметь возможность создать нелицензионным маркер или изменить каким-либо образом underhanded приемлемы маркер.

Один бит, такой информации, содержащейся в билете равен *срока действия*, который является дата и время билета больше не действительна. Каждый раз, FormsAuthenticationModule проверяет билет проверки подлинности гарантирует, что срок действия билета еще не прошел. Если Да, он не учитывает билета и определяет пользователя как анонимный. Такая мера защиты помогает защититься от атак с повторением. Без срока действия, если злоумышленник может получить свой опыт по билет проверки подлинности пользователя — возможно, физический доступ к компьютеру и болея через свои файлы cookie - они могут отправить запрос на сервер с Этот билет проверки подлинности украденного и Получите запись. Хотя срок действия не предотвращает этот сценарий, ограничивает окна во время которых может быть успешным, такой атаки.

> [!NOTE]
> Шаг 3 сведения о дополнительных технологий, используемых системой проверки подлинности форм для защиты билет проверки подлинности.


При создании билета проверки подлинности, системой проверки подлинности форм определяет его срока действия, по журналу задание времени ожидания. Как указано в таблице 1, время ожидания, установка значений по умолчанию 30 минут, это означает, что при создании билета проверки подлинности форм его срока действия имеет значение даты и времени в будущем 30 минут.

Срок действия определяет абсолютное время в будущем когда истекает срок действия билета проверки подлинности форм. Однако обычно необходимо реализовать скользящего срока действия, который сбрасывается каждый раз при последующих посещениях пользователем сайт разработчиков. Это поведение определяется параметрами slidingExpiration. Если задано значение true (по умолчанию), каждый раз FormsAuthenticationModule проверяет подлинность пользователя, он обновляет срока действия билета. Если значение равно false, срок действия не обновляется при каждом запросе, тем самым вызывая ровно столько времени ожидания минут после того билет был при первом срок действия билета создана.

> [!NOTE]
> Срок действия, хранятся в билет проверки подлинности является абсолютное значение даты и времени, например 2 августа 2008 11:34 по. Кроме того Дата и время относятся к веб-сервере местное время. Это может иметь некоторые интересные побочные эффекты вокруг летнее время (DST), при часами в Соединенных Штатах сдвигаются вперед один час (предполагается, что веб-сервер размещается в регионе, где наблюдается летнее время). Например, рассмотрим ситуацию для веб-узла ASP.NET и срока действия 30 минут времени начала летнего времени, близкий (то есть в 2:00). Представьте, что посетитель входит сайт 11 марта 2008 г. в 13:55:00. Это вызовет билета проверки подлинности форм, истечения срока действия в 11 марта 2008 г. в 02:25:00 (в дальнейшем 30 минут). Однако после 2:00 AM, выпустите, часы перейдет к 3:00 AM из-за летнего времени. При загрузке новой страницы шесть минут после входа в систему (в 03:01:00), FormsAuthenticationModule сообщает билета истек и перенаправляет пользователя на страницу входа. Более подробное описание для этого и других oddities времени ожидания билета проверки подлинности, а также способы решения проблем, получают копию Стефан Шакоу *Professional ASP.NET 2.0 безопасности, членства и управления ролями* (ISBN: 978-0-7645-9698-8).


Рис. 1 показан рабочий процесс, когда slidingExpiration имеет значение false и время ожидания равно 30. Содержит дату истечения срока действия билета проверки подлинности, созданный при входе в систему, и это значение не обновляется при последующих запросах. Если FormsAuthenticationModule обнаруживает, что срок действия билета истек, он отвергает его и рассматривает как анонимный запрос.


[![Графическое представление slidingExpiration срока действия при билета проверки подлинности форм имеет значение false](forms-authentication-configuration-and-advanced-topics-cs/_static/image2.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image1.png)

**На рисунке 01**: графическое представление slidingExpiration срока действия при билета проверки подлинности форм имеет значение false ([Просмотр полноразмерное изображение](forms-authentication-configuration-and-advanced-topics-cs/_static/image3.png))


На рисунке 2 показан рабочий процесс, если slidingExpiration имеет значение true, а также время ожидания равно 30. При получении запроса с проверкой подлинности (с помощью билета не истек срок действия) его срока действия обновляется время ожидания в минутах в будущем.


[![Графическое представление билета проверки подлинности форм при slidingExpiration имеет значение true](forms-authentication-configuration-and-advanced-topics-cs/_static/image5.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image4.png)

**На рисунке 02**: графическое представление билета проверки подлинности форм при slidingExpiration имеет значение true ([Просмотр полноразмерное изображение](forms-authentication-configuration-and-advanced-topics-cs/_static/image6.png))


При использовании билетов проверки подлинности на основе файлов cookie (по умолчанию), данного обсуждения становится немного более сложными, поскольку файлы cookie также может иметь свои собственные кэше указано. Файл cookie истечения срока действия (или его отсутствие) указывает, что браузер при следует удалить куки-файл. Если куки-файл не имеет срока действия, он будет уничтожен, когда браузер завершает работу. При наличии срока действия куки-файл хранится на компьютере пользователя до даты и времени, указанного в срок действия истек. При удалении файла cookie в браузере нельзя отправить на веб-сервер. Таким образом удаление файла Cookie является аналогом вход из узла пользователя.

> [!NOTE]
> Конечно пользователь может заранее удалить все файлы cookie, хранящиеся на компьютере. В Internet Explorer 7 следует перейти к Сервис, параметры и нажмите кнопку "Удалить" в разделе средство просмотра журнала. После этого нажмите кнопку Удалить файлы cookie.


Система проверки подлинности форм создает на основе сеансов или на основе срока действия файлов cookie в зависимости от значения, передаваемые в *persistCookie* параметра. Напомним, что класс FormsAuthentication GetAuthCookie, SetAuthCookie и RedirectFromLoginPage методы принимают в два входных параметра: *username* и *persistCookie*. Страницы входа, созданной в предыдущем учебнике включены флажок Запомнить меня, которые, по определению того, был ли создан постоянный файл cookie. Сохраняемые файлы cookie на основе срока действия; не сохраняемые файлы cookie на основе сеансов.

Время ожидания и slidingExpiration понятия уже же применяются для обоих файлов cookie на основе сеансов и истечения срока действия. Только один дополнительный различий в выполнения: при использовании файлов cookie на основе срока действия slidingTimeout задано значение true, срока действия файла cookie обновляется только при более половины указанного времени прошло.

Давайте обновить политики времени ожидания билета проверки подлинности наш веб-сайт, который билетов тайм-аут после одного часа (60 минут) с помощью скользящего срока действия. Для этого, обновление файла Web.config, добавление &lt;forms&gt; элемент &lt;проверки подлинности&gt; элемент следующей разметкой:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample2.xml)]

### <a name="using-an-login-page-url-other-than-loginaspx"></a>С помощью URL-адрес страницы входа Кроме Login.aspx

Поскольку FormsAuthenticationModule будет автоматически перенаправлен на страницу входа неавторизованные пользователи, его необходимо знать URL-адрес страницы входа. Этот URL-адрес указан в атрибуте loginUrl &lt;forms&gt; элемента и значения по умолчанию на страницу login.aspx. При переносе на существующем веб-сайте уже имеется страница входа в систему с другой URL-адрес, задача, которая уже с закладками и индексирование поисковыми. Вместо того чтобы Переименование существующих страница входа на страницу login.aspx и критические ссылки и закладки пользователей, вместо этого можно изменить атрибут loginUrl, чтобы он указывал на страницу входа.

Например, если страница входа называется SignIn.aspx и находится в каталоге пользователей, может указывать параметр конфигурации loginUrl ~/Users/SignIn.aspx следующим образом:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample3.xml)]

Поскольку наш текущее приложение уже имеет страницу входа с именем Login.aspx, нет необходимости для указания настраиваемое значение в &lt;forms&gt; элемента.

## <a name="step-2-using-cookieless-forms-authentication-tickets"></a>Шаг 2: С помощью форм без поддержки файлов cookie билетов проверки подлинности

По умолчанию системой проверки подлинности форм определяет, следует ли сохранить ее билетов проверки подлинности в коллекцию файлов cookie или внедрять их в URL-АДРЕСЕ, в зависимости от агента пользователя на узле. Все основные обозреватели настольных компьютеров, например Internet Explorer, Firefox, Opera и Safari, поддержка файлов cookie, но это не все мобильные устройства.

Куки-файл политики, используемые системой проверки подлинности форм зависит от без поддержки файлов cookie в &lt;forms&gt; элемент, который можно задать один из четырех значений:

- UseCookies - указывает, что всегда будет использоваться билетов проверки подлинности на основе файлов cookie.
- UseUri - указывает, что билетов проверки подлинности на основе файлов cookie не будут использоваться.
- Автообнаружение — Если профиль устройства поддерживает файлы cookie, билетов проверки подлинности на основе файлов cookie не используются; Если профиль устройства поддерживает файлы cookie, механизм тестирования используется для включения файлов cookie.
- UseDeviceProfile - по умолчанию. использует билетов проверки подлинности на основе файлов cookie только в том случае, если профиль устройства поддерживает файлы cookie. Используется механизм поиска сборок.

Автоматическое обнаружение и UseDeviceProfile параметры полагаться на *профиль устройства* в Проверка необходимости использования проверки подлинности на основе файлов cookie или без использования билетов. ASP.NET поддерживает базу данных из различных устройств и их возможности, например, поддерживают ли они файлов cookie, какие версии поддерживают JavaScript и т. д. Каждый раз, устройство запрашивает веб-страницы на веб-сервере, он отправляет вдоль *агент пользователя* заголовка HTTP, который определяет тип устройства. ASP.NET автоматически сопоставляет строки указанного агента пользователя с соответствующей профиля, заданного в своей базе данных.

> [!NOTE]
> Эта база данных возможностей устройства хранится в XML-файлов число, которое соответствует [файла описания браузера схемы](https://msdn.microsoft.com/library/ms228122.aspx). Файлы профиля устройства по умолчанию расположены в папке % WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG\Browsers. Можно также добавить пользовательские файлы приложения в приложение\_папку браузеров. Дополнительные сведения см. в разделе [How To: определение типов браузеров, поддерживаемых веб-страницах ASP.NET](https://msdn.microsoft.com/library/3yekbd5b.aspx).


Поскольку значение по умолчанию — UseDeviceProfile, билетов форм без поддержки файлов cookie проверки подлинности будет использоваться при посещении сайта со стороны устройства, профиль сообщает, что он не поддерживает файлы cookie.

### <a name="encoding-the-authentication-ticket-in-the-url"></a>Кодирование билет проверки подлинности в URL-адрес

Файлы cookie — это естественное средний для во все запросы для определенного веб-сайта, поэтому параметров проверки подлинности форм по умолчанию используют файлы cookie, если их поддерживает просмотр устройств, включая сведения из браузера. Если файлы cookie не поддерживается, необходимо использовать альтернативный способ передачи билета проверки подлинности от клиента к серверу. Распространенный обходной путь, используемый в средах без поддержки файлов cookie используется для преобразования данных куки-файл в URL-АДРЕСЕ.

Чтобы увидеть, как такие сведения, может быть внедрен в URL-адрес рекомендуется для принудительного использования билетов без поддержки файлов cookie проверки подлинности. Это можно сделать, задав для параметра конфигурации без поддержки файлов cookie UseUri:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample4.xml)]

После внесения этого изменения на узле с помощью браузера. При посещении как анонимный пользователь, URL-адреса, будет выглядеть точно, как раньше. Например при посещении страницы Default.aspx моего браузера адресной строке отображается следующий URL-адрес:

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/default.aspx`

Однако после входа в систему билета проверки подлинности форм внедряется в URL-адрес. Например после посещения страницы входа и входа в систему качестве Sam, возврата на страницу Default.aspx, но на этот раз будет URL-адрес:

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/(F(jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv-rfezq0gKadKX0YPZCkA2))/default.aspx`

В URL-адрес внедренными билета проверки подлинности форм. Строка (F (jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv rfezq0gKadKX0YPZCkA2) представляет данные билета проверки подлинности шестнадцатеричной кодировке, и те же данные, которые обычно хранится в файле cookie.

В порядке для билетов без поддержки файлов cookie проверки подлинности для работы системы необходимо закодировать все URL-адреса на странице для включения данные билета проверки подлинности, в противном случае билет проверки подлинности будут потеряны, если пользователь щелкает ссылку. К счастью эта логика внедрение выполняется автоматически. Для демонстрации этой функциональности, откройте страницу Default.aspx и добавьте элемент управления гиперссылки, установите значение его свойства Text и NavigateUrl проверить ссылку и SomePage.aspx, соответственно. Не важно, что нет страницы в проект с именем SomePage.aspx.

Сохранить изменения в файл Default.aspx и посетите через браузер. Войдите на сайт, чтобы билета проверки подлинности форм внедрен в URL-адрес. Далее Default.aspx, выберите ссылку, проверить ссылку. Что произошло? Если страницы, с именем SomePage.aspx, не существует, затем произошла ошибка 404, но это не важно здесь. Вместо этого определите, в адресной строке браузера. Обратите внимание, что он включает билета проверки подлинности форм в URL-адрес!

`http://localhost:2448/ASPNET\_Security\_Tutorial\_03\_CS/(F(jaIOIDTJxIr12xYS-VVgkqKCVAuIoW30Bu0diWi6flQC-FyMaLXJfow\_Vd9GZkB2Cv-rfezq0gKadKX0YPZCkA2))/SomePage.aspx`

SomePage.aspx URL-адрес в ссылке автоматически преобразован в URL-адрес, который включен билет проверки подлинности — не пришлось писать единой строки кода! Билет проверки подлинности форм автоматически внедряются в URL-адрес для гиперссылки, не ставьте `http://` или `/`. Не важно, если ссылка на отображается в вызов Response.Redirect, элемент управления гиперссылки или элемент привязки HTML (т. е. `<a href="...">...</a>`). До тех пор, пока не URL-адреса, примерно `http://www.someserver.com/SomePage.aspx` или `/SomePage.aspx`, нам будет внедрен билета проверки подлинности форм.

> [!NOTE]
> Те же политики времени ожидания как билетов проверки подлинности на основе файлов cookie придерживаться билетов проверки подлинности форм без поддержки файлов cookie. Однако без поддержки файлов cookie проверки подлинности билеты подверженных атак, так как билет проверки подлинности встроена непосредственно в URL-адрес. Предположим, пользователь посетит веб-сайт, входит в систему и затем вставляет URL-адрес в сообщение электронной почты коллеге. Если коллеги щелкает эту ссылку, до достижения срок действия, они будут войти как пользователь, отправивший сообщение электронной почты!


## <a name="step-3-securing-the-authentication-ticket"></a>Шаг 3: Защита билет проверки подлинности

Билет проверки подлинности форм, передаваемых по сети либо в файле cookie или внедренные непосредственно в URL-адрес. В дополнение к данными удостоверения билет проверки подлинности можно также включить пользовательские данные (как видно на шаге 4). Следовательно, очень важно, шифрование данных, билета от любопытных глаз и (даже более важно) системой проверки подлинности форм может гарантировать, что запрос не был изменен.

Для обеспечения конфиденциальности данных билетов системой проверки подлинности форм можно зашифровать данные билета. Не удалось зашифровать данные билета отправляет потенциально конфиденциальная информация по сети в виде обычного текста.

Чтобы гарантировать билет подлинности, необходимо системой проверки подлинности форм *проверки* билета. Проверка — это процесс обеспечения определенную часть данных не была изменена что выполняются с помощью  *[код проверки подлинности (MAC) сообщения](http://en.wikipedia.org/wiki/Message_authentication_code)*. По сути MAC-адрес является небольшая часть сведения, которые определяют данные, необходимые для проверки (в данном случае билета). При изменении данных, представленных MAC затем MAC-адрес и данные не будут соответствовать. Кроме того трудно требовательных злоумышленнику изменить данные и создать свой собственный MAC в соответствии с измененными данными.

При создании (или изменение) билет системой проверки подлинности форм MAC создает и привязывает его к данные билета. По прибытии последующий запрос системой проверки подлинности форм сравнивает данные MAC и билетов для проверки подлинности данные билета. Этот рабочий процесс показан на рис графически.


[![Билет подлинности обеспечивается через MAC](forms-authentication-configuration-and-advanced-topics-cs/_static/image8.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image7.png)

**На рисунке 03**: билет подлинности обеспечивается через MAC ([Просмотр полноразмерное изображение](forms-authentication-configuration-and-advanced-topics-cs/_static/image9.png))


Какие меры безопасности применяются к билет проверки подлинности зависит от настройки защиты в &lt;forms&gt; элемента. Параметр защиты может быть назначен один из следующих трех значений:

- ALL --ticket зашифрован и цифровую подпись (по умолчанию).
- Шифрование — шифрование только применяется - MAC не создается.
- None — билет не шифруются и не цифровой подписью.
- Проверка - MAC создается, но билет данные отправляются по сети в виде обычного текста.

Корпорация Майкрософт настоятельно рекомендует с использованием всех параметров.

### <a name="setting-the-validation-and-decryption-keys"></a>Настройка проверки и расшифровки ключей

Шифрование и хеширование алгоритмы, используемые системой проверки подлинности форм для шифрования и проверки билет проверки подлинности можно настроить через [ &lt;machineKey&gt; элемент](https://msdn.microsoft.com/library/w8h3skw9.aspx) в файле Web.config. В таблице 2 показано &lt;machineKey&gt; атрибутов элемента и их возможные значения.

| **Attribute (XElement Dynamic Property)** (Attribute (динамическое свойство XElement)) | **Описание** |
| --- | --- |
| расшифровка | Указывает алгоритм, используемый для шифрования. Этот атрибут может принимать одно из следующих четырех значений: - авто - по умолчанию; определяет алгоритм, в зависимости от длины decryptionKey атрибута. -Использует AES - [Advanced Encryption Standard (AES)](http://en.wikipedia.org/wiki/Advanced_Encryption_Standard) алгоритма. -Использует DES - [Data Encryption Standard (DES)](http://en.wikipedia.org/wiki/Data_Encryption_Standard) этот алгоритм считается требовательных слабое и не должны использоваться. Использует - 3DES - [Triple DES](http://en.wikipedia.org/wiki/Triple_DES) алгоритм, который работает путем применения алгоритма DES три раза. |
| decryptionKey | Секретный ключ, используемый алгоритм шифрования. Это значение должны быть шестнадцатеричной строки, соответствующей длины (на основе значения в расшифровки), автоматически заполнять или либо значение с, IsolateApps. Добавление IsolateApps предписывает ASP.NET использовать уникальное значение для каждого приложения. Значение по умолчанию — AutoGenerate, IsolateApps. |
| проверка | Указывает алгоритм, используемый для проверки. Этот атрибут может принимать одно из следующих четырех значений: - AES - алгоритм Advanced Encryption Standard (AES). -Использует MD5 - [Message-Digest 5 (MD5)](http://en.wikipedia.org/wiki/MD5) алгоритма. -Использует SHA1 - [SHA1](http://en.wikipedia.org/wiki/Sha1) алгоритм (по умолчанию). -3DES - используется алгоритм Triple DES. |
| validationKey | Секретный ключ, используемые алгоритмом для проверки. Это значение должны быть шестнадцатеричной строки, соответствующей длины (на основе значения в проверки), автоматически заполнять или либо значение с, IsolateApps. Добавление IsolateApps предписывает ASP.NET использовать уникальное значение для каждого приложения. Значение по умолчанию — AutoGenerate, IsolateApps. |

**В таблице 2**: &lt;machineKey&gt; атрибуты элемента

Подробное описание этих параметров шифрования и проверки, а также преимущества и недостатки различных алгоритмов, выходит за рамки данного руководства. Для подробные рассмотрим эти проблемы, включая рекомендации по какие алгоритмы шифрования и проверки, чтобы использовать, какие длины ключей для использования и как оптимальным способом создания этих ключей для см *Professional ASP.NET 2.0 безопасности, членство и роли управления* .

По умолчанию ключи, используемые для шифрования и проверки подлинности создаются автоматически для каждого приложения, и эти ключи хранятся в локальной системы безопасности (LSA). Иными словами параметры по умолчанию гарантирует уникальных ключей в веб-сервер, веб-сервер и приложения по приложениям. Следовательно это поведение по умолчанию не будет работать в двух следующих случаях:

- **Веб-ферм** — в [веб-фермы](http://en.wikipedia.org/wiki/Web_farm) сценарии одного веб-приложения, размещенного на нескольких веб-серверов в целях обеспечения избыточности и масштабируемости. Каждый входящий запрос отправляется на сервер в ферме, это означает, что в течение времени существования пользовательского сеанса, разных серверах может использоваться для обработки его различных запросов. Следовательно каждый сервер должен использовать те же ключи шифрования и проверки, для создания билета проверки подлинности форм, зашифрованные и проверенные на одном сервере можно расшифровать и проверить на другом сервере в ферме.
- **CROSS общий доступ к приложениям билет** -одного веб-сервера может размещать несколько приложений ASP.NET. Если вам требуется для таких приложений для совместного использования одной формы билет проверки подлинности, крайне важно, что совпадающие свои ключи шифрования и проверки.

При работе на веб-ферме задания или совместного использования билетов проверки подлинности приложениями на том же сервере, необходимо настроить &lt;machineKey&gt; элемент в уязвимых приложений, чтобы их decryptionKey и Сопоставьте validationKey значения.

Хотя ни одно из указанных выше сценариев применяется для нашего примера приложения, мы по-прежнему можно задать значения validationKey и decryptionKey явные и определить алгоритмов для использования. Добавить &lt;machineKey&gt; параметр в файл Web.config:

[!code-xml[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample5.xml)]

Для получения дополнительной информации посетите [How To: Настройка MachineKey в ASP.NET 2.0](https://msdn.microsoft.com/library/ms998288.aspx).

> [!NOTE]
> Значения decryptionKey и validationKey были взяты из [Стив Gibson](http://www.grc.com/stevegibson.htm) [точной пароли веб-странице](https://www.grc.com/passwords.htm), служащего для создания 64 случайные шестнадцатеричные символы при всех. Чтобы уменьшить вероятность того, что эти ключи, делая их передачу в приложении, рекомендуется заменить выше ключи случайным из них на странице точной пароли.


## <a name="step-4-storing-additional-user-data-in-the-ticket"></a>Шаг 4: Хранение дополнительных пользовательских данных в билете

Многие веб-приложения отображения сведений об или базовые отображения страницы для текущего пользователя. Например веб-страницы могут отображаться имя пользователя и дату, которую она последнего входа в систему в верхней части каждой страницы. Билета проверки подлинности форм хранит имя текущего вошедшего в систему пользователя, но при необходимости другие сведения страницы необходимо перейти на хранилище пользователя - как правило, база данных - для поиска информации, не хранятся в билет проверки подлинности.

С помощью небольшого фрагмента кода дополнительные пользовательские сведения могут храниться в билета проверки подлинности форм. Такие данные могут быть выражены через [класс FormsAuthenticationTicket](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.aspx) [UserData свойство](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.userdata.aspx). Это подходит для хранения небольшие объемы информации о пользователе, достаточно часто. Значение, указанное в UserData свойство входит в состав файла Cookie билет проверки подлинности и, подобно поля билет, шифруется и проверки на основе системой проверки подлинности форм конфигурации. По умолчанию UserData является пустой строкой.

Чтобы сохранить данные пользователя в билет проверки подлинности, необходимо написать большой объем кода на странице входа, которое извлекает сведения о пользователе и сохраняет его в билете. Поскольку UserData свойства строкового типа, данные, хранящиеся в нем должны быть правильно сериализованы как строка. Например предположим, что наши хранилища пользователя включаются Дата рождения каждого пользователя и имя работодателя, а, чтобы хранить значения этих двух свойств в билет проверки подлинности. Нам удалось сериализовать эти значения в строку, объединяя пользователя Дата рождения строки с символ вертикальной черты (|), за которым следует имя работодателя. Для пользователя, рождения на 15 августа 1974, который будет работать для Northwind Traders, мы бы присвоить UserData свойство строки: 1974-08-15 | Northwind Traders.

Каждый раз, когда необходимо получить доступ к данным в билете мы можно сделать, перехватывая FormsAuthenticationTicket текущего запроса и десериализации свойство UserData. В случае дата рождения и работодателя пример имени мы бы разбиения строки UserData на двух подстрок в зависимости от разделителя (|).


[![Дополнительные сведения о пользователе, которые могут храниться в билет проверки подлинности](forms-authentication-configuration-and-advanced-topics-cs/_static/image11.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image10.png)

**На рисунке 04**: Дополнительные пользователя сведения могут храниться в билет проверки подлинности ([Просмотр полноразмерное изображение](forms-authentication-configuration-and-advanced-topics-cs/_static/image12.png))


### <a name="writing-information-to-userdata"></a>Запись данных UserData

К сожалению Добавление сведений о пользователе для билета проверки подлинности форм не так просто, как можно предположить, что. Свойство UserData FormsAuthenticationTicket класса доступен только для чтения и можно указать только с помощью конструктора класса FormsAuthenticationTicket. При указании свойства UserData в конструкторе, необходимо также предоставить билет и другие значения: имя пользователя, Дата выпуска, истечение срока действия и т. д. Создавая страницу входа в предыдущем учебнике, это все обработано нам FormsAuthentication классом. При добавлении UserData FormsAuthenticationTicket, необходимо написать код, чтобы реплицировать большинству функций, уже обеспечиваемые FormsAuthentication класса.

Давайте рассмотрим необходимый код для работы с UserData, обновив страницу Login.aspx для записи дополнительных сведений о пользователе для билета проверки подлинности. Представьте, что наши хранилища пользователя содержит сведения о компании, для работы пользователя и их название и что мы хотим эти сведения записываются в билет проверки подлинности. Обновление на страницу Login.aspx LoginButton обработчик щелчков, чтобы код выглядел следующим образом:

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample6.cs)]

Давайте пошагово этот код по одной строке за раз. Этот метод начинает путем определения четыре строки массива: пользователей, пароли, companyName и titleAtCompany. Эти массивы хранения имен пользователей, паролей, названия компаний и заголовки для учетных записей пользователей в системе, для которых имеются три: Скотт Цзисунь и Sam. В реальном приложении эти значения будут запрашиваться из хранилища пользователя, не жестко запрограммированы в исходный код страницы.

В предыдущем учебнике если предоставленные учетные данные были допустимыми мы просто вызвать FormsAuthentication.RedirectFromLoginPage (UserName.Text, RememberMe.Checked), выполнить следующие действия:

1. Создать билет проверки подлинности форм
2. Записано билет соответствующее хранилище. Коллекция файлов cookie в браузере используется для билетов проверки подлинности на основе файлов cookie; для билетов без поддержки файлов cookie проверки подлинности билета данных сериализуется в URL-адрес
3. Перенаправляет пользователя на страницу соответствующие

В приведенном выше коде реплицируются следующие действия. Во-первых строку, с которой в конечном итоге он будет храниться в свойстве UserData образуется путем объединения название компании и title, разделяющий два значения с вертикальной черты (|).

Строка, userDataString = строка. Concat (companyName [i] «|», titleAtCompany[i]);

Затем FormsAuthentication.GetAuthCookie, вызывается метод, который создает билет проверки подлинности, шифрует и проверяет его в соответствии с параметрами конфигурации и помещает его в объект HttpCookie.

HttpCookie authCookie = FormsAuthentication.GetAuthCookie (UserName.Text, RememberMe.Checked);

Для работы с FormAuthenticationTicket, внедренных в файл cookie, нам потребуется вызвать класс FormAuthentication [расшифровать метод](https://msdn.microsoft.com/library/system.web.security.formsauthentication.decrypt.aspx), передавая значение файла cookie.

Билет FormsAuthenticationTicket = FormsAuthentication.Decrypt(authCookie.Value);

Затем создайте *новый* FormsAuthenticationTicket экземпляра на основе существующих FormsAuthenticationTicket значений. Однако этот новый билет включает сведения о пользователе (userDataString).

FormsAuthenticationTicket newTicket = новый FormsAuthenticationTicket (билет. Версия билета. Имя билета. IssueDate, билета. Срок действия билета. IsPersistent, userDataString);

Мы затем шифрования (и проверки) новый экземпляр FormsAuthenticationTicket путем вызова [методу шифрования](https://msdn.microsoft.com/library/system.web.security.formsauthentication.encrypt.aspx)и вернуть эти данные, зашифрованные (и проверенные) в authCookie.

authCookie.Value = FormsAuthentication.Encrypt(newTicket);

Наконец authCookie добавляется в коллекцию Response.Cookies и метод GetRedirectUrl вызывается для определения соответствующих страницы для отправки пользователю.

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample7.cs)]

Весь этот код требуется, поскольку UserData свойство доступно только для чтения и FormsAuthentication класс предоставляет методы для задания сведений UserData в его GetAuthCookie, SetAuthCookie или RedirectFromLoginPage методы.

> [!NOTE]
> Код, который мы только что рассмотрели хранит сведения о пользователе в билет проверки подлинности на основе файлов cookie. Классы, ответственный за сериализацию билета проверки подлинности форм для URL-адреса являются внутренними для .NET Framework. Короче говоря, нельзя хранить данные пользователя в билет проверки подлинности форм без поддержки файлов cookie.


### <a name="accessing-the-userdata-information"></a>Доступ к сведениям UserData

На этом этапе название организации и название каждого пользователя хранится в свойство UserData билета проверки подлинности форм при входе. Эта информация может осуществляться из билета проверки подлинности на любой странице без необходимости передачи в хранилище пользователя. Чтобы продемонстрировать, как эти сведения можно получить из свойства UserData, давайте обновить Default.aspx, чтобы его приветственное сообщение включает в себя не только имя пользователя, но также компании, в которой они работают и названий.

В настоящее время Default.aspx содержит AuthenticatedMessagePanel панели с элементом управления Label с именем WelcomeBackMessage. Эта панель отображается только пользователям, прошедшим проверку. Обновление кода в странице Default.aspx в\_загрузки обработчика событий таким образом, чтобы он выглядел следующим образом:

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample8.cs)]

Если Request.IsAuthenticated имеет значение true, то свойство Text WelcomeBackMessage изначально устанавливается в Добро пожаловать *username*. Затем, чтобы может получить доступ к базовой FormsAuthenticationTicket свойство User.Identity приведен объект FormsIdentity. После получения FormsAuthenticationTicket мы десериализовать свойство UserData в название компании и заголовок. Это достигается путем разбиения строки на вертикальной черты. Название компании и заголовок затем отображаются в метке WelcomeBackMessage.

Рис. 5 показан экрана это в действии. Войдите в систему как Скотт отображает приветственное сообщение назад, включающий Скотта компании и заголовок.


[![В настоящее время пользователю, выполнившему вход в компании и заголовок отображаются](forms-authentication-configuration-and-advanced-topics-cs/_static/image14.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image13.png)

**На рисунке 05**: компании в настоящее время входа в систему пользователя и название отображаются ([Просмотр полноразмерное изображение](forms-authentication-configuration-and-advanced-topics-cs/_static/image15.png))


> [!NOTE]
> Билет проверки подлинности UserData служит в качестве кэша для хранилища пользователя. Подобно любому кэшу он должен быть обновлен при изменении базовых данных. Например при наличии веб-страницы, из которого пользователи могут обновлять свой профиль кэширование UserData свойства поля должны обновляться для отражения изменений, внесенных пользователем.


## <a name="step-5-using-a-custom-principal"></a>Шаг 5: С помощью пользовательского участника

Для каждого входящего запроса FormsAuthenticationModule пытается проверить подлинность пользователя. При наличии билет проверки подлинности, не истек срок действия объекта GenericPrincipal FormsAuthenticationModule назначает свойство HttpContext.User. Этот объект GenericPrincipal имеет идентификатор типа FormsIdentity, который включает ссылку на билета проверки подлинности форм. Класс GenericPrincipal содержит исходного состояния системы минимальным функциональных возможностей с помощью класса, реализующего интерфейс IPrincipal - содержит только свойство Identity и метод IsInRole.

Объект-участник имеет две функции: чтобы указать, какие роли, которым принадлежит пользователь и предоставляют сведения об удостоверении. Это обеспечивается за счет интерфейса IPrincipal IsInRole (*roleName*) метод и свойства Identity, соответственно. Класс GenericPrincipal позволяет массив строк имен ролей, указанного с помощью его конструктора; его IsInRole (*roleName*) метод просто проверяет, если переданный в *roleName* присутствует в массиве строк. Когда FormsAuthenticationModule создает GenericPrincipal, передается в пустой массив строк GenericPrincipal конструктор. Следовательно любой вызов IsInRole всегда будет возвращать значение false.

Класс GenericPrincipal подходит для большинства сценариев проверки подлинности на основе форм, где не используются роли. Для тех случаев, когда недостаточно обработку роли по умолчанию или при необходимости свяжите с пользователем, пользовательского объекта IIdentity создания пользовательского объекта IPrincipal во время процесса проверки подлинности и присвоить его свойству HttpContext.User.

> [!NOTE]
> Как мы увидим в будущих учебниках, когда ASP. Включить ролей в .NET framework создается объект пользовательского основного типа [RolePrincipal создан](https://msdn.microsoft.com/library/system.web.security.roleprincipal.aspx) и перезаписывает объекта GenericPrincipal создан проверки подлинности форм. Это делается, чтобы настроить метод IsInRole основного сервера для взаимодействия с API платформы ролей.


Поскольку мы имеют не заботиться сами с ролями еще, единственная причина того, мы бы для создания собственного участника безопасности на этом juncture будет связать пользовательский IIdentity объект участнику. На шаге 4 мы рассмотрели хранения дополнительных сведений о пользователях в свойстве UserData билет проверки подлинности, в частности, название компании пользователя и названий. Однако только UserData сведения доступны через билет проверки подлинности и затем только в качестве сериализованной строки, это означает, что каждый раз, когда мы хотим просмотреть эти сведения, хранящиеся в билете нам нужно интерпретировать свойство UserData.

Мы можем улучшить процесс разработки путем создания класса, реализующего интерфейс IIdentity, которые включают свойства CompanyName и заголовок. Таким образом, разработчик можно получить доступ к текущему пользователю название компании и заголовок напрямую с помощью свойства CompanyName и Title, без необходимости о том, как интерпретировать свойство UserData.

### <a name="creating-the-custom-identity-and-principal-classes"></a>Создание пользовательских удостоверений и классы участников

В этом учебнике, давайте создадим пользовательские объекты principal и identity в приложении\_папки с кодом. Начните с добавления приложений\_папки в проект кода — щелкните правой кнопкой мыши имя проекта в обозревателе решений, выберите параметр Добавить папку ASP.NET и выберите приложение\_кода. Приложение\_папки с кодом является особой папке ASP.NET, который содержит класс файлы для веб-сайта.

> [!NOTE]
> Приложение\_папку кода следует использовать только при управлении проектами с помощью модели проекта веб-сайта. Если вы используете [модель проекта веб-приложения](https://msdn.microsoft.com/asp.net/Aa336618.aspx), создание стандартной папки, и добавить классы. Например можно добавить новую папку с именем классы и существует поместить код.


Добавьте два новых файла класса приложения\_папки с кодом, один именованный CustomIdentity.cs и один с именем CustomPrincipal.cs.


[![Добавление в проект классы CustomPrincipal и CustomIdentity](forms-authentication-configuration-and-advanced-topics-cs/_static/image17.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image16.png)

**На рисунке 06**: добавьте в проект классы CustomPrincipal и CustomIdentity ([Просмотр полноразмерное изображение](forms-authentication-configuration-and-advanced-topics-cs/_static/image18.png))


Класс CustomIdentity отвечает за реализацию интерфейс IIdentity, который определяет AuthenticationType, свойство IsAuthenticated и имя свойства. Помимо этих обязательных свойств нас интересуют предоставления базовых билета проверки подлинности форм а также свойства для заголовка и название компании пользователя. Введите следующий код в класс CustomIdentity.

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample9.cs)]

Обратите внимание, что класс включает переменную-член FormsAuthenticationTicket (\_билета) и что этот билет сведения должны предоставляться через конструктор. Этот билет данные используются в возвращение имени удостоверения; его свойство UserData анализируется для возврата значений для свойства CompanyName и заголовок.

Создайте класс CustomPrincipal. Поскольку мы не интересуются ролей на этом juncture, CustomPrincipal в конструктор класса принимает только объект CustomIdentity; его метод IsInRole всегда возвращает значение false.

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample10.cs)]

### <a name="assigning-a-customprincipal-object-to-the-incoming-requests-security-context"></a>Назначение объекта CustomPrincipal контекст безопасности входящего запроса

Теперь у нас есть классом, который расширяет определение IIdentity по умолчанию, чтобы включить свойства CompanyName и Title, а также пользовательские основной класс, который использует пользовательское удостоверение. Мы готовы к действию в конвейере ASP.NET и назначьте нашей пользовательского объекта-участника контекст безопасности входящего запроса.

Конвейер ASP.NET принимает входящий запрос и обрабатывает его через ряд действий. На каждом шаге возникает определенного события, дает разработчикам коснитесь в конвейере ASP.NET и измените запрос на определенных этапах жизненного цикла. FormsAuthenticationModule, например, ожидает ASP.NET для вызова [AuthenticateRequest событие](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), после чего он оценивает входящего запроса, для нее билет проверки подлинности. При обнаружении билет проверки подлинности объекта GenericPrincipal создается и назначается свойству HttpContext.User.

После события AuthenticateRequest конвейера ASP.NET вызывает [PostAuthenticateRequest событий](https://msdn.microsoft.com/library/system.web.httpapplication.postauthenticaterequest.aspx), который является, где можно заменить GenericPrincipal объект, созданный с помощью экземпляра FormsAuthenticationModule нашей Объект CustomPrincipal. Рис. 7 показана этот рабочий процесс.


[![GenericPrincipal заменяется CustomPrincipal в событии PostAuthenticationRequest](forms-authentication-configuration-and-advanced-topics-cs/_static/image20.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image19.png)

**На рисунке 07**: GenericPrincipal заменяется CustomPrincipal в событии PostAuthenticationRequest ([Просмотр полноразмерное изображение](forms-authentication-configuration-and-advanced-topics-cs/_static/image21.png))


Чтобы выполнить код в ответ на событие конвейера ASP.NET, мы можно создать соответствующий обработчик событий в файле Global.asax или создать собственный HTTP-модуля. В этом учебнике давайте создадим обработчик событий в файле Global.asax. Начните с добавления Global.asax для веб-сайта. Щелкните правой кнопкой мыши имя проекта в обозревателе решений и добавьте элемент типа с именем Global.asax глобальный класс приложения.


[![Добавьте файл Global.asax для веб-сайта](forms-authentication-configuration-and-advanced-topics-cs/_static/image23.png)](forms-authentication-configuration-and-advanced-topics-cs/_static/image22.png)

**На рисунке 08**: добавить файл Global.asax для веб-сайта ([Просмотр полноразмерное изображение](forms-authentication-configuration-and-advanced-topics-cs/_static/image24.png))


Шаблон по умолчанию Global.asax содержит обработчики событий для события конвейера ASP.NET, включая начала, окончания и [событие ошибки](https://msdn.microsoft.com/library/system.web.httpapplication.error.aspx), среди прочего. Вы можете удалить эти обработчики событий, как мы не нужны для этого приложения. Событие, которое мы будем рады получить — PostAuthenticateRequest. Добавьте в файл Global.asax, его разметка выглядит следующим образом:

[!code-aspx[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample11.aspx)]

Приложение\_метод OnPostAuthenticateRequest выполняется каждый раз, среда выполнения ASP.NET вызывает событие PostAuthenticateRequest, которое происходит один раз для каждого входящего запроса страницы. Обработчик события начинается с проверки, если пользователь прошел проверку подлинности и была выполнена проверка подлинности посредством проверки подлинности форм. В этом случае новый объект CustomIdentity создается и передается текущий запрос билета проверки подлинности в своем конструкторе. После этого объект CustomPrincipal создается и передается только что созданный объект CustomIdentity в своем конструкторе. Наконец на вновь созданный объект CustomPrincipal назначается контекст безопасности текущего запроса.

Обратите внимание, что последний шаг — связывание объекте CustomPrincipal с контекстом безопасности запроса - назначает участника два свойства: HttpContext.User и Thread.CurrentPrincipal. Эти два назначения необходимы из-за способа обработки контексты безопасности в ASP.NET. Платформа .NET Framework связывает контекста безопасности с каждого выполняемого потока; Эта информация доступна в виде объекта IPrincipal через [объекта потока](https://msdn.microsoft.com/library/system.threading.thread.aspx) [CurrentPrincipal свойство](https://msdn.microsoft.com/library/system.threading.thread.currentcontext.aspx). Что такое путать, имеет ASP.NET свои собственные сведения о контексте безопасности (HttpContext.User).

В некоторых сценариях проверяется свойство Thread.CurrentPrincipal при определении контекст безопасности; в других случаях используется HttpContext.User. Например, существуют средства безопасности в .NET, которые позволяют разработчикам декларативно указать, какие пользователи или роли можно создать экземпляр класса или вызова методов, определенных (см. [добавления правила авторизации для бизнеса и данных с помощью слоев PrincipalPermissionAttributes](https://weblogs.asp.net/scottgu/archive/2006/10/04/Tip_2F00_Trick_3A00_-Adding-Authorization-Rules-to-Business-and-Data-Layers-using-PrincipalPermissionAttributes.aspx)). В системе эти методы декларативные определения контекста безопасности через свойство Thread.CurrentPrincipal.

В других случаях используется свойство HttpContext.User. Например в предыдущем учебнике мы использовали это свойство для отображения текущего вошедшего в систему пользователя. Очевидно затем, крайне важно, сведения о контексте безопасности в свойствах Thread.CurrentPrincipal и HttpContext.User совпадает.

Среда выполнения ASP.NET автоматически синхронизирует эти значения свойств для нас. Тем не менее, процесс синхронизации возникает после события AuthenticateRequest, но *перед* PostAuthenticateRequest событий. Следовательно при добавлении пользовательского участника в событии PostAuthenticateRequest нам нужно убедиться, чтобы вручную назначить Thread.CurrentPrincipal иначе Thread.CurrentPrincipal и HttpContext.User будут синхронизированы. В разделе [Context.User vs. Thread.CurrentPrincipal](http://leastprivilege.com/2005/11/23/context-user-vs-thread-currentprincipal/) для более подробные сведения об этой проблеме.

### <a name="accessing-the-companyname-and-title-properties"></a>Доступ к CompanyName и свойства заголовка

Каждый раз, когда поступает запрос и передается в обработчик ASP.NET, приложение\_будет срабатывать OnPostAuthenticateRequest обработчика событий в файле Global.asax. Если запрос успешно проверена, FormsAuthenticationModule, обработчик событий будет создать объект CustomPrincipal с объект CustomIdentity, основанный на билета проверки подлинности форм. С этой логики в месте доступ к сведениям о название организации и название текущего вошедшего в систему пользователя очень просто.

Вернуться на страницу\_обработчик события загрузки на странице Default.aspx, где на шаге 4 мы написали код для получения билета проверки подлинности форм и анализа UserData свойства для отображения заголовка и название компании пользователя. С объектами CustomPrincipal и CustomIdentity теперь используется нет необходимости выполнить синтаксический анализ значения из свойства UserData билета. Вместо этого просто получить ссылку на объект CustomIdentity и его свойства CompanyName и заголовка:

[!code-csharp[Main](forms-authentication-configuration-and-advanced-topics-cs/samples/sample12.cs)]

## <a name="summary"></a>Сводка

В этом учебнике мы рассмотрели, как настроить параметры системы проверки подлинности форм через Web.config. Мы рассмотрели обработку истечения срока действия билета проверки подлинности и использовании шифрование и проверка меры безопасности для защиты от проверки и изменения билета. Наконец мы рассмотрели использование свойства UserData билет проверки подлинности для хранения дополнительных сведений о пользователях в билете сам и как использовать пользовательские объекты principal и identity предоставлять эту информацию в виде более понятная.

Этот учебник завершает изучение проверки подлинности форм в ASP.NET. Следующее руководство начинается нашей путешествие framework членства.

Программирование довольны!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, рассматриваемые в этом учебнике см. в следующих ресурсах:

- [Разбор форм проверки подлинности](http://aspnet.4guysfromrolla.com/articles/072005-1.aspx)
- [Объяснение: Проверка подлинности форм в ASP.NET 2.0](https://msdn.microsoft.com/library/aa480476.aspx)
- [Практическое руководство: Защита проверки подлинности форм в ASP.NET 2.0](https://msdn.microsoft.com/library/ms998310.aspx)
- [Профессиональные ASP.NET 2.0 безопасности, членства и управления ролями](http://www.wrox.com/WileyCDA/WroxTitle/productCd-0764596985.html) (ISBN: 978-0-7645-9698-8)
- [Защита элементов управления входа](https://msdn.microsoft.com/library/ms178346.aspx)
- [&lt;Проверки подлинности&gt; элемент](https://msdn.microsoft.com/library/532aee0e.aspx)
- [&lt;Forms&gt; элемент для &lt;проверки подлинности&gt;](https://msdn.microsoft.com/library/1d3t3c61.aspx)
- [&lt;MachineKey&gt; элемент](https://msdn.microsoft.com/library/w8h3skw9.aspx)
- [Основные сведения о билета проверки подлинности форм и файлы Cookie](https://support.microsoft.com/kb/910443)

### <a name="video-training-on-topics-contained-in-this-tutorial"></a>Видео на разделы, содержащиеся в этом учебнике

- [Как изменить свойства проверки подлинности форм](../../../videos/authentication/how-to-change-the-forms-authentication-properties.md)
- [Способ установки и использования файла Cookie проверки подлинности в приложении ASP.NET](../../../videos/authentication/how-to-setup-and-use-cookie-less-authentication-in-an-aspnet-application.md)
- [Перемещение входа с проверкой подлинности на основе форм в ASP](../../../videos/authentication/asp-forms-login-relocation.md)
- [Конфигурация пользовательского ключа для входа](../../../videos/authentication/forms-login-custom-key-configuration.md)
- [Добавление пользовательских данных в метод проверки подлинности](../../../videos/authentication/add-custom-data-to-the-authentication-method.md)
- [Использование пользовательских объектов Principal](../../../videos/authentication/use-custom-principal-objects.md)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких ASP/ASP.NET и основатель 4GuysFromRolla.com, работает с веб-технологиями Майкрософт с 1998 года. Скотт — независимый консультант, trainer и записи. Его последняя книга —  *[диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скотт может быть достигнута по [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по [ http://ScottOnWriting.NET ](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Благодарности

Этот учебник ряд прошел проверку многие полезные рецензентов. Основной рецензент этого учебника было Alicja Maziarz. Объясняются моих последующих статей для MSDN? Если Да, напишите мне по [ mitchell@4GuysFromRolla.com ](mailto:mitchell@4guysfromrolla.com).

> [!div class="step-by-step"]
> [Назад](an-overview-of-forms-authentication-cs.md)
> [Вперед](security-basics-and-asp-net-support-vb.md)

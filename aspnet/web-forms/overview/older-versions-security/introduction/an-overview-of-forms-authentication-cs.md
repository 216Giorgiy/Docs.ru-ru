---
uid: web-forms/overview/older-versions-security/introduction/an-overview-of-forms-authentication-cs
title: Обзор проверки подлинности форм (C#) | Документы Microsoft
author: rick-anderson
description: Создание настраиваемых маршрутов
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/14/2008
ms.topic: article
ms.assetid: de2d65b9-aadc-42ba-abe1-4e87e66521a0
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-security/introduction/an-overview-of-forms-authentication-cs
msc.type: authoredcontent
ms.openlocfilehash: 1f64384d403f3cf81ffa3327a81b635bc71e2b44
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
---
<a name="an-overview-of-forms-authentication-c"></a>Обзор проверки подлинности форм (C#)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Загрузить код](http://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/ASPNET_Security_Tutorial_02_CS.zip) или [скачать PDF](http://download.microsoft.com/download/2/F/7/2F705A34-F9DE-4112-BBDE-60098089645E/aspnet_tutorial02_FormsAuth_cs.pdf)

> В этом учебнике будет преобразован из простое описание реализации; в частности мы рассмотрим реализации проверки подлинности форм. Веб-приложение, мы начнем, создав в этом учебнике будет продолжать построено в последующих учебники по мере продвижения из простых форм проверки подлинности для членства и ролей.
> 
> См. Дополнительные сведения в этом видео по этой теме: [использование проверки подлинности форм в ASP.NET основные](# "using-basic-forms-authentication-in-aspnet").


## <a name="introduction"></a>Вступление

В [предыдущего учебника](security-basics-and-asp-net-support-cs.md) мы рассмотрели различные проверки подлинности, авторизации и пользователя учетной записи параметры, предоставляемые ASP.NET. В этом учебнике будет преобразован из простое описание реализации; в частности мы рассмотрим реализации проверки подлинности форм. Веб-приложение, мы начнем, создав в этом учебнике будет продолжать построено в последующих учебники по мере продвижения из простых форм проверки подлинности для членства и ролей.

Этот учебник начинается с глубокое изучение рабочего процесса проверки подлинности форм, статьи, которые мы рассмотрели при предыдущем учебнике. После этого мы создадим веб-сайта ASP.NET через для демонстрации концепции проверки подлинности форм. Далее мы настроить сайт для использования проверки подлинности форм, создания простой страницы входа и определение в коде, является ли проверка подлинности пользователя, и в этом случае имя пользователя, они вошли в систему.

Основные сведения о форм, рабочего процесса проверки подлинности в веб-приложения и создание страницы входа и выхода из нее будут все важные шаги в построении приложения ASP.NET, который поддерживает учетные записи пользователей и проверяет подлинность пользователей с помощью веб-страницы. Из-за этого — и так как эти учебники последовательно друг от друга - я рекомендую для работы этого учебника в полном объеме, прежде чем перейти к следующим даже если вы уже имели возможности настройки проверки подлинности форм в последние проекты.

## <a name="understanding-the-forms-authentication-workflow"></a>Основные сведения о рабочем процессе проверки подлинности форм

Когда среда выполнения ASP.NET обрабатывает запрос для ресурса ASP.NET, например страницы ASP.NET или веб-службы ASP.NET, запрос Возводит число событий во время его жизненного цикла. Существуют события, возникающие в конце очень начальная и самого запроса, те, возникает, когда запрос прошел проверку подлинности и авторизацию, событие, вызываемое в случае необработанных исключений и т. д. Чтобы просмотреть полный список событий, обратитесь к [событий HttpApplication объекта](https://msdn.microsoft.com/library/system.web.httpapplication_events.aspx).

*Модули HTTP* — управляемые классы, в которых код выполняется в ответ на определенное событие в жизненном цикле запроса. ASP.NET поставляется с ряд модулей HTTP, выполнять основные задачи в фоновом. Ниже приведены два встроенных модулей HTTP, которые особенно важны для нашего обсуждения.

- **[`FormsAuthenticationModule`](https://msdn.microsoft.com/library/system.web.security.formsauthenticationmodule.aspx)** — проверяет подлинность пользователя, проверяя билета проверки подлинности форм, который обычно входит в коллекцию файлов cookie. Если присутствует не билета проверки подлинности форм, пользователь является анонимным.
- **[`UrlAuthorizationModule`](https://msdn.microsoft.com/library/system.web.security.urlauthorizationmodule.aspx)** — Определяет, разрешено ли текущий пользователь доступ к запрошенному URL-АДРЕСУ. Этот модуль определяет центр сертификации по журналу правил авторизации, указанные в файлах конфигурации приложения. ASP.NET также включает [ `FileAuthorizationModule` ](https://msdn.microsoft.com/library/system.web.security.fileauthorizationmodule.aspx) , определяющая центр по журналу запрошенного файлы списки управления доступом.

`FormsAuthenticationModule` Пытается проверить подлинность пользователя до `UrlAuthorizationModule` (и `FileAuthorizationModule`) выполнения. Если пользователя, выполняющего запрос не авторизован для доступа к запрошенному ресурсу, модуль проверки завершается запрос и возвращает [HTTP 401 несанкционированный](http://www.checkupdown.com/status/E401.html) состояния. В сценарии проверки подлинности Windows состояние HTTP 401 возвращается в браузере. Этот код состояния заставляет браузер приглашение ввести свои учетные данные с помощью модального диалогового окна. С помощью форм, однако HTTP 401 несанкционированный никогда не отправляется в браузер, так как FormsAuthenticationModule обнаруживает это состояние и обновляет его и перенаправляет пользователя на страницу входа, а не (через [HTTP 302 перенаправления](http://www.checkupdown.com/status/E302.html) состояние).

Для определения, если учетные данные пользователя являются допустимыми, и если да, для создания билета проверки подлинности форм и перенаправит пользователя назад на страницу они предпринималась попытка посетите — ответственность на страницу входа. Билет проверки подлинности включена в последующие запросы к страницам на веб-сайт, который `FormsAuthenticationModule` используется для идентификации пользователя.


![Рабочий процесс проверки подлинности форм](an-overview-of-forms-authentication-cs/_static/image1.png)

**Рис. 1**: рабочий процесс проверки подлинности форм


### <a name="remembering-the-authentication-ticket-across-page-visits"></a>Запоминание билет проверки подлинности через посещений страницы

После входа в систему билета проверки подлинности форм должны отправляться обратно в веб-сервера для каждого запроса, чтобы пользователь останется вошедший в систему, при просмотре сайта. Обычно это выполняется путем размещения билет проверки подлинности в коллекцию файлов cookie. [Файлы cookie](http://en.wikipedia.org/wiki/HTTP_cookie) маленькие текстовые файлы, которые находятся на компьютере пользователя и передаются в заголовках HTTP для каждого запроса на веб-сайт, который создал файл cookie. Таким образом после создания билета проверки подлинности форм и хранятся в файлах cookie в браузере, каждого последующих посещения этого узла отправляет билет проверки подлинности вместе с запросом, тем самым идентификатором пользователя.

Одним из аспектов файлов cookie является срока, Дата и время, по которому браузер отменяет куки-файл. После истечения срока действия файла cookie проверки подлинности форм, пользователь может больше не проверку подлинности и поэтому становятся анонимный. Когда пользователь посещает из открытых терминала, скорее всего, они хотят их билет проверки подлинности для срока действия при закрытии обозревателя. При посещении из дома, однако этот же пользователь может потребоваться билет проверки подлинности для сохраненных между перезагрузками браузера, чтобы они не имеют повторно войти в каждый раз при посещении сайта. Это решение обычно принимается пользователем в форме «Запомнить мои данные» флажок на странице входа. На шаге 3 будут рассмотрены способы реализации флажок «Запомнить мои данные» на странице входа. В руководстве ниже адреса параметры времени ожидания билета проверки подлинности, подробно.

> [!NOTE]
> Это возможно, агент пользователя, используемой для входа веб-сайта могут не поддерживать файлы cookie. В этом случае ASP.NET можно использовать билетов проверки подлинности форм без поддержки файлов cookie. В этом режиме билет проверки подлинности кодируется в URL-адрес. Мы рассмотрим использование билетов без поддержки файлов cookie проверки подлинности и как они создаются и управляются в следующем уроке.


### <a name="the-scope-of-forms-authentication"></a>Область проверки подлинности форм

`FormsAuthenticationModule` — Управляемый код, который является частью среды выполнения ASP.NET. До версии 7 корпорации Майкрософт [Internet Information Services (IIS)](https://www.iis.net/) веб-сервере произошла distinct барьер между HTTP-конвейера служб IIS и среды выполнения ASP.NET конвейера. Иными словами, в IIS 6 и более ранних версиях `FormsAuthenticationModule` выполняется только в случае, когда запрос делегируется среды выполнения ASP.NET из IIS. По умолчанию службы IIS обрабатывает статического содержимого, сам — как страницы HTML и CSS и файлы изображений — и только передает запросы для среды выполнения ASP.NET при запросе страницы с расширением .aspx, .asmx и .ashx.

IIS 7, однако позволяет для интеграции служб IIS и ASP.NET конвейеров. Некоторые параметры конфигурации можно настроить службы IIS 7 для вызова FormsAuthenticationModule для *все* запросов. Кроме того в службах IIS 7 можно определить правила авторизации URL-адрес для файлов любого типа. Дополнительные сведения см. в разделе [изменений между IIS6 и безопасность IIS7](https://www.iis.net/learn/get-started/whats-new-in-iis-7/changes-in-security-between-iis-60-and-iis-7-and-above), [ваш веб-платформы безопасности](https://www.iis.net/learn/get-started/whats-new-in-iis-7/iis7-and-above-security-improvements), и [авторизации URL-адресов для IIS7 основные сведения о](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/URL-Authorization/Understanding-IIS7-URL-Authorization).

Короче говоря, в версиях, предшествующих IIS 7, можно использовать только проверку подлинности форм для защиты ресурсов, которые обрабатываются средой выполнения ASP.NET. Аналогичным образом правила авторизации URL-адреса применяются только к ресурсам, которые обрабатываются средой выполнения ASP.NET. Но в службах IIS 7 можно интегрировать FormsAuthenticationModule и UrlAuthorizationModule в конвейер HTTP служб IIS, тем самым расширяя этих функциональных возможностей для всех запросов.

## <a name="step-1-creating-an-aspnet-website-for-this-tutorial-series"></a>Шаг 1: Создание веб-сайта ASP.NET для этого учебника ряда

Для достижения наиболее широкой аудитории, веб-узла ASP.NET, мы будем строить во всей этой серии будет создан с корпорации Майкрософт бесплатную версию Visual Studio 2008 [Visual Web Developer 2008](https://www.microsoft.com/express/vwd/). Мы будем реализовывать `SqlMembershipProvider` хранилища пользователя в [Microsoft SQL Server 2005 Express Edition](https://msdn.microsoft.com/sql/Aa336346.aspx) базы данных. При использовании Visual Studio 2005 или другого выпуска Visual Studio 2008 или SQL Server, не беспокойтесь — действия будут практически одинаковых и любой нетривиальный различия будет необходимо обратить внимание.

> [!NOTE]
> Демонстрация веб-приложения, используемые в каждом учебнике доступен для загрузки. Это загружаемый приложение создано с помощью Visual Web Developer 2008, предназначенных для .NET Framework версии 3.5. Поскольку приложение предназначено для .NET 3.5, его файл Web.config содержит элементы конфигурации дополнительные, зависящие от 3.5. Короче говоря, если у вас еще установка .NET 3.5 на компьютере, затем загружаемая веб-приложение не будет работать без удаления разметку 3.5 из файла Web.config.


Прежде чем мы можно настроить проверку подлинности форм, необходимо сначала на веб-сайте ASP.NET. Начните с создания нового файла на основе системы веб-узла ASP.NET. Для этого запустите Visual Web Developer и перейдите в меню «файл» и выберите новый веб-сайт, отображает диалоговое окно нового веб-сайта. Выберите шаблон веб-сайт ASP.NET, указывает расположение раскрывающегося списка в файловой системе, выберите папку для размещения веб-сайта и выбранный язык C#. Это создаст новый веб-сайт со страницей Default.aspx ASP.NET, приложение\_папки данных и файл Web.config.

> [!NOTE]
> Visual Studio поддерживает два режима управления проектом: проекты веб-сайтов и проектов веб-приложений. Проектов веб-сайтов отсутствует в файле проекта, тогда как проекты веб-приложений имитировать архитектуру проекта в Visual Studio .NET 2002/2003 — они включают файл проекта и компиляции исходного кода проекта в единую сборку, которая размещается в папке/Bin. Проекты Visual Studio 2005 изначально только поддерживаемые веб-сайта, несмотря на то, что модель проекта веб-приложения был снова с пакетом обновления 1; Visual Studio 2008 предлагает обе модели проекта. Visual Web Developer 2005 и 2008 выпусков, однако поддерживают только проекты веб-сайтов. Будет использоваться в модели проекта веб-сайта. Если вы используете отличных от Express edition и хотите использовать [модель проекта веб-приложения](https://msdn.microsoft.com/library/aa730880%28vs.80%29.aspx) вместо этого вы можете сделать это, но имейте в виду, что может быть некоторые несоответствия между отображаемые на экране и действия, которые необходимо выполнить сравнение показано снимки экрана и инструкции, приведенные в этих учебниках.


[![Создать новый файл на основе системы веб-сайта](an-overview-of-forms-authentication-cs/_static/image3.png)](an-overview-of-forms-authentication-cs/_static/image2.png)

**На рисунке 2**: Создание веб-сайта New File System-Based ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image4.png))


### <a name="adding-a-master-page"></a>Добавление главной страницы

Добавьте в новой главной страницы сайта в корневую папку с именем Site.master. [Главные страницы](https://msdn.microsoft.com/library/wtxbf3hh.aspx) страницы разработчик может определить шаблон сайта, могут применяться к страницам ASP.NET. Основным преимуществом главные страницы — что общий внешний вид веб-узла можно определить в одном месте, что делает его легко обновить или изменить макет веб-узла.


[![Добавить главную страницу Site.master на веб-сайт с именем](an-overview-of-forms-authentication-cs/_static/image6.png)](an-overview-of-forms-authentication-cs/_static/image5.png)

**Рис. 3**: Добавление Site.master Master с именем страницы на веб-сайт ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image7.png))


Определите макет для сайта всех страниц на главной странице. Можно использовать представление проектирования и добавьте любые макета или веб-элементы управления, или можно вручную добавить разметку вручную в представлении источника. Я структурированный макет my главной страницы, чтобы имитировать макета, используемого в моей *[работа с данными в ASP.NET 2.0](../../data-access/index.md)* учебника ряда (см. рис. 4). На главной странице используется [каскадных таблиц стилей](http://www.w3schools.com/css/default.asp) для положения и определения в файле Style.css (включенный в этот учебник загрузки). Пока не удастся найти из приведенной ниже разметки, определенные правила CSS таким образом, что Навигация &lt;div&gt;элемента содержимого с абсолютным позиционированием, чтобы он отображается слева и имеет фиксированную ширину 200 пикселей.

[!code-aspx[Main](an-overview-of-forms-authentication-cs/samples/sample1.aspx)]

На главной странице определяются как статические, так и области, которые можно изменить с помощью страниц ASP.NET, в которых используется Главная страница. Изменяемые области обозначаются `ContentPlaceHolder` элемента управления, который можно увидеть в содержимом &lt;div&gt;. Наш Главная страница имеет один `ContentPlaceHolder` (тегу), но может быть и несколько главной страницы.

С разметки, введенного выше переключением в представление конструирования отображается макет главной страницы. Все страницы ASP.NET, использующие этот главной страницы будет иметь этот универсальный макет с возможностью указать разметку для `MainContent` области.


[![Главная страница, при просмотре в режиме конструктора](an-overview-of-forms-authentication-cs/_static/image9.png)](an-overview-of-forms-authentication-cs/_static/image8.png)

**Рис. 4**: главной страницы, при просмотре через конструктор ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image10.png))


### <a name="creating-content-pages"></a>Создание страницы содержимого

На этом этапе у нас есть страница Default.aspx в сайте, но не использует главную страницу, которую мы только что создали. Хотя и существует возможность управлять декларативная разметка веб-страницы, использующие эталонную страницу, если страница не содержит данных, все еще проще просто удалить страницу, а затем добавьте его в проект, указав главную страницу для использования. Таким образом запуск, удалив файл Default.aspx из проекта.

Далее щелкните правой кнопкой мыши имя проекта в обозревателе решений и выберите команду Добавить новый веб-форму с именем Default.aspx. На этот раз, установите флажок «Выбрать главную страницу» и выберите главную страницу Site.master из списка.


[![Добавьте новую страницу Default.aspx, выбрав для выбора главной страницы](an-overview-of-forms-authentication-cs/_static/image12.png)](an-overview-of-forms-authentication-cs/_static/image11.png)

**Рис. 5**: Добавление новых Default.aspx страницы решили Выбор главной страницы ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image13.png))


![Используйте Site.master главной страницы](an-overview-of-forms-authentication-cs/_static/image14.png)

**Рис. 6**: используйте Site.master главной страницы


> [!NOTE]
> При использовании модели проекта веб-приложения в диалоговом окне Добавить новый элемент не включает флажок «Выбрать главную страницу». Вместо этого необходимо добавить элемент типа «Веб-форму содержимого». После выбора параметра «Форма веб-содержимого» и нажмите кнопку Добавить, Visual Studio отобразит же Select главного диалоговое окно показано на рис. 6.


Новая страница Default.aspx декларативная разметка включает только @Page директивы, указав путь к главному страницы для главной страницы тегу ContentPlaceHolder файлов и управления содержимым.

[!code-aspx[Main](an-overview-of-forms-authentication-cs/samples/sample2.aspx)]

Пока оставьте пустым Default.aspx. Мы будет возвращать его позже в этом учебнике для добавления содержимого.

> [!NOTE]
> Наш главной страницы содержит раздел для меню или другой интерфейс навигации. В будущем учебнике мы создадим такой интерфейс.

## <a name="step-2-enabling-forms-authentication"></a>Шаг 2: Включение проверки подлинности форм

Когда ASP.NET веб-сайт создан теперь нам является возможность проверки подлинности форм. Указанные настройки проверки подлинности приложения с помощью [ `<authentication>` элемент](https://msdn.microsoft.com/library/532aee0e.aspx) в файле Web.config. `<authentication>` Элемент содержит один атрибут с именем mode, указывающее модель проверки подлинности, используемые приложением. Этот атрибут может принимать одно из следующих четырех значений:

- **Windows** — как описано в предыдущем учебнике, когда приложение использует проверку подлинности Windows отвечает веб-сервера для проверки подлинности посетителя и обычно это осуществляется посредством Basic, Digest или встроенная проверка подлинности Windows Проверка подлинности.
- **Формы**— пользователи проходят проверку подлинности с помощью формы на веб-странице.
- **Passport**— пользователи проходят проверку подлинности с помощью Microsoft Passport Network.
- **Нет**— модель проверки подлинности не используется; всех посетителей являются анонимными.

По умолчанию приложения ASP.NET используют проверку подлинности Windows. Чтобы изменить тип проверки подлинности для форм проверки подлинности, затем, нам нужно изменить `<authentication>` атрибут mode элемента формы.

Если проект еще не содержит файл Web.config, добавьте один теперь путем щелчка правой кнопкой мыши имя проекта в обозревателе решений и добавьте новый элемент и затем добавив файл веб-конфигурации.


[![Если проект еще не содержит файл Web.config, добавьте его сейчас](an-overview-of-forms-authentication-cs/_static/image16.png)](an-overview-of-forms-authentication-cs/_static/image15.png)

**Рис. 7**: Если ваш проект Does не еще включают Web.config, добавьте его сейчас ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image17.png))


Затем возьмите `<authentication>` элемент и обновление его для использования проверки подлинности форм. После этого изменения файла Web.config должна выглядеть следующим:

[!code-xml[Main](an-overview-of-forms-authentication-cs/samples/sample3.xml)]

> [!NOTE]
> Поскольку XML-файла Web.config, важно регистр. Убедитесь, что значение атрибута mode в формы, с заглавной буквы «F». Если вы используете другой регистр символов, таких как «forms», вы получите ошибку конфигурации при посещении сайта с помощью браузера.


`<authentication>` Элемента может включать `<forms>` дочерний элемент, который содержит параметры, специфичные для проверки подлинности форм. Теперь давайте просто используйте параметры по умолчанию для проверки подлинности форм. Мы рассмотрим `<forms>` дочерний элемент более подробно в следующем уроке.

## <a name="step-3-building-the-login-page"></a>Шаг 3: Создание страницы входа

Для поддержки проверки подлинности форм наш веб-сайт должен страницу входа. Как описано в разделе «Основные сведения о форм с процессом проверки подлинности» `FormsAuthenticationModule` будет автоматически перенаправления пользователя на страницу входа при попытке получить доступ к странице, что он не разрешено просматривать. Существуют также ASP.NET веб-элементов управления, которые будет отображаться ссылка на страницу входа для анонимных пользователей. Это вызывает вопрос, «Какова URL-адрес страницы входа?»

По умолчанию системой проверки подлинности форм ожидает страницу входа могут называться Login.aspx и размещаются в корневой каталог веб-приложения. Если вы хотите использовать URL-адрес страницы другого имени входа, это можно сделать путем задания его в файле Web.config. Будет показано, как это сделать в последующих учебника.

Страница входа имеет три функциональные обязанности.

1. Предоставить интерфейс, позволяющий посетителей вводить свои учетные данные.
2. Определите, если отправленное учетные данные действительны.
3. «Вход» пользователя путем создания билета проверки подлинности форм.

### <a name="creating-the-login-pages-user-interface"></a>Создание пользовательского интерфейса для страницы входа

Давайте начнем с первой задачи. Добавить новую страницу ASP.NET в корневой каталог веб-узла с именем Login.aspx и связать его с главной страницы Site.master.


[![Добавьте новую страницу ASP.NET с именем Login.aspx](an-overview-of-forms-authentication-cs/_static/image19.png)](an-overview-of-forms-authentication-cs/_static/image18.png)

**Рис. 8**: Добавление новых ASP.NET страница с именем Login.aspx ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image20.png))


Интерфейс страницы входа обычно состоит из двух текстовых полей — один для имени пользователя, по одному для свой пароль — и кнопки для отправки формы. Веб-сайтов часто включают флажок «Запомнить мои данные», если этот флажок установлен, не будет устранена полученный билет проверки подлинности между перезагрузками браузера.

Добавьте два текстовых поля Login.aspx и установите их `ID` свойства для имени пользователя и пароля, соответственно. Также задать пароля пользователя `TextMode` свойство пароля. Добавьте элемент управления CheckBox, установка его `ID` свойства RememberMe и его `Text` свойства «Запомнить мои». После этого добавьте кнопку с именем LoginButton которого `Text` задано значение «Вход». И наконец, добавьте метки веб-элемент управления и задайте его `ID` свойства InvalidCredentialsMessage, его `Text` свойства «имя пользователя или пароль является недопустимым. Повторите попытку.», его `ForeColor` свойство на красный и его `Visible` свойству значение False.

На этом этапе экран должен выглядеть примерно на показанную на рис. 9 и на странице декларативный синтаксис должен выглядеть примерно следующее:

[!code-aspx[Main](an-overview-of-forms-authentication-cs/samples/sample4.aspx)]


[![Страница входа содержит два текстовых поля, флажок, кнопку и метку](an-overview-of-forms-authentication-cs/_static/image22.png)](an-overview-of-forms-authentication-cs/_static/image21.png)

**Рис. 9**: входа содержит два текстовые поля страницы, флажок, кнопку и метку ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image23.png))


Наконец, создайте обработчик событий для нажатия LoginButton событий. В конструкторе дважды щелкните элемент управления Button, чтобы создать этот обработчик событий.

### <a name="determining-if-the-supplied-credentials-are-valid"></a>Определение, если учетные данные допустимы

Теперь нам нужно реализовать задача 2 нажатия кнопки обработчик событий — определить, допустимы ли указанные учетные данные. Для этого необходимо поддерживать пользовательского хранилища, которая содержит все учетные данные пользователей, чтобы мы могли определить, если предоставленные учетные данные совпадают с любой известных учетных данных.

До ASP.NET 2.0 разработчики несут ответственность за реализации оба собственные хранилища пользователя и написание кода для проверки предоставленных учетных данных в хранилище. Большинство разработчиков будет реализовывать в хранилище пользователя в базе данных, создание таблицы с именем пользователей и столбцы, такие как имя пользователя, пароль, электронной почты, LastLoginDate и т. д. Эта таблица, будут иметь одну запись для каждой учетной записи пользователя. Проверка того, предоставленные учетные данные пользователя будет включать в себя запросы к базе данных для сопоставления имени пользователя и затем гарантирует, что пароль базы данных значение соответствовало введенного пароля.

В ASP.NET 2.0 разработчикам следует использовать один из поставщиков членства для управления в хранилище пользователя. В этой серии учебника будет использоваться SqlMembershipProvider, который использует базу данных SQL Server для хранилища пользователя. При использовании SqlMembershipProvider, нам нужно реализовать схему конкретной базы данных, включает таблицы, представления и хранимые процедуры, ожидаемый поставщиком. Мы рассмотрим, как для реализации этой схемы в ***создания схемы членства в SQL Server*** учебника. С поставщиком членства в месте, проверка учетных данных пользователя достаточно вызвать метод [класс членства](https://msdn.microsoft.com/library/system.web.security.membership.aspx) [ValidateUser (*username*, *пароля*) метод](https://msdn.microsoft.com/library/system.web.security.membership.validateuser.aspx), которая возвращает логическое значение, указывающее, ли допустимость *username* и *пароль* комбинации. Увидев, как мы еще не реализован SqlMembershipProvider пользовательского хранилища, в настоящее время невозможно использовать метод ValidateUser класса членства.

А не тратить время для создания собственных пользовательских пользователей базы данных таблицы (что было бы устаревшим после мы реализовали SqlMembershipProvider), давайте вместо жестко действительные учетные данные в имени входа страницы самого. В LoginButton выберите обработчик событий, добавьте следующий код:

[!code-csharp[Main](an-overview-of-forms-authentication-cs/samples/sample5.cs)]

Как видите, существует три действительные учетные записи пользователей — Скотт, Цзисунь и Сэм — и все три класса имеют один и тот же пароль («password»). Код выполняет цикл по массивы пользователей и паролей, допустимым совпадение имени пользователя и пароля. Если имя пользователя и пароль являются допустимыми, необходимо войти в систему пользователя и затем перенаправит их на соответствующую страницу. Если учетные данные являются недопустимыми, мы отображается метка InvalidCredentialsMessage.

Когда пользователь вводит правильные учетные данные, упомянутые, они перенаправляются «соответствующую страницу». Что такое соответствующая страница, однако Помните, что при посещении страницы, которые не авторизованы для просмотра FormsAuthenticationModule автоматически перенаправит их на страницу входа. При этом он включает запрошенного URL-адреса в строке запроса через параметр ReturnUrl. То есть если они были не авторизован для этого пользователь пытался посетите ProtectedPage.aspx, FormsAuthenticationModule перенаправит их на:

Login.aspx?ReturnUrl=ProtectedPage.aspx

После успешного входа в систему пользователь должен попасть на ProtectedPage.aspx. Кроме того пользователи могут посетите страницу входа в свои собственные volition. В этом случае после входа пользователя они должны отправляться страницу Default.aspx в корневую папку.

### <a name="logging-in-the-user"></a>Вход пользователя

Предположим, что предоставленные учетные данные являются допустимыми, потребуется создать билета проверки подлинности форм, тем самым вход пользователя на сайт. [Класс FormsAuthentication](https://msdn.microsoft.com/library/system.web.security.formsauthentication.aspx) в [имен System.Web.Security](https://msdn.microsoft.com/library/system.web.security.aspx) предоставляет различные методы для ведения журнала в и выходе из системы пользователей с помощью форм системой проверки подлинности. Хотя существует несколько методов в классе FormsAuthentication, которые нас интересуют на этом juncture встречаются:

- [GetAuthCookie (*username*, *persistCookie*)](https://msdn.microsoft.com/library/system.web.security.formsauthentication.getauthcookie.aspx) — создает билета проверки подлинности форм для передаваемого *username*. Затем этот метод создает и возвращает HttpCookie объекта, который хранит содержимое билет проверки подлинности. Если *persistCookie* имеет значение true, создается постоянный файл cookie.
- [SetAuthCookie (*username*, *persistCookie*)](https://msdn.microsoft.com/library/system.web.security.formsauthentication.setauthcookie.aspx) — вызывает GetAuthCookie (*username*, *persistCookie*) метод для создания файла cookie проверки подлинности форм. Затем этот метод добавляет файл cookie, возвращенные GetAuthCookie к коллекции (при условии, что используется; в противном случае время форм на основе файлов cookie проверки подлинности, этот метод вызывает внутренний класс, обрабатывает логику, без поддержки файлов cookie билета).
- [RedirectFromLoginPage (*username*, *persistCookie*)](https://msdn.microsoft.com/library/system.web.security.formsauthentication.redirectfromloginpage.aspx) — этот метод вызывает метод SetAuthCookie (*username*, *persistCookie*) и затем перенаправляет пользователя на соответствующую страницу.

GetAuthCookie удобно в тех случаях, когда требуется изменить билет проверки подлинности выписке куки-файл в коллекцию файлов cookie. SetAuthCookie полезен, если необходимо создание билета проверки подлинности форм и добавление в коллекцию файлов cookie, но не требуется перенаправлять пользователя на соответствующую страницу. Возможно требуется сохранять их на странице входа, или их отправки на альтернативный страницу.

Поскольку нам требуется вход пользователя и перенаправит их на соответствующей странице, воспользуемся RedirectFromLoginPage. Обновить LoginButton нажмите кнопку обработчика событий, заменив две строки комментарии TODO следующую строку кода:

FormsAuthentication.RedirectFromLoginPage(UserName.Text, RememberMe.Checked);

При создании билета проверки подлинности форм, мы используем свойство Text текстового поля имя пользователя для билета проверки подлинности форм *username* параметров и состояния флажка флажок RememberMe  *persistCookie* параметра.

Чтобы протестировать страницу входа, посетите его в браузере. Начните с ввода недействительные учетные данные, такие как имя пользователя «Nope» и паролем «ошибка». При нажатии кнопки входа обратная передача будет выполняться и InvalidCredentialsMessage метка будет отображена.


[![InvalidCredentialsMessage метка будет отображаться при вводе недопустимые учетные данные](an-overview-of-forms-authentication-cs/_static/image25.png)](an-overview-of-forms-authentication-cs/_static/image24.png)

**Рис. 10**: InvalidCredentialsMessage метка будет отображаться при вводе недействительные учетные данные ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image26.png))


Затем введите действительные учетные данные и нажмите кнопку входа. Этот момент обратной передачи билета проверки подлинности форм создается и вы будете автоматически перенаправлены на Default.aspx. На этом этапе необходимо войти веб-сайт, несмотря на то, что существуют не визуальные подсказки, чтобы указать, что вы выполнили вход. На шаге 4, будет показано, как программным способом определить, является ли пользователь регистрируется в или не, а также способ идентификации пользователя, посетив страницу.

Шаг 5 рассматриваются приемы для входа пользователя из веб-сайта.

### <a name="securing-the-login-page"></a>Защита страницы входа

Когда пользователь вводит свои учетные данные и отправляет форму страницы входа, учетные данные, в том числе пароль — передаются через Интернет на веб-сервер в *обычный текст*. Это означает, что любой злоумышленник, проанализировать сетевой трафик можно увидеть имя пользователя и пароль. Чтобы избежать этого, очень важно для шифрования сетевого трафика с помощью [Secure слои сокетов (SSL)](http://en.wikipedia.org/wiki/Secure_Sockets_Layer). Это позволит гарантировать шифровать учетные данные (а также всю страницу HTML-разметка) от момента, когда они покидают браузер, пока они не будут получены веб-сервером.

Если веб-сайт не содержит конфиденциальные сведения, будет достаточно для использования протокола SSL на странице входа и на других страницах где пароль пользователя в противном случае отправляются по сети в виде обычного текста. Можно не беспокоиться о защите билета проверки подлинности форм, поскольку по умолчанию, он и зашифрован и цифровую подпись (чтобы предотвратить несанкционированный доступ). В этом руководстве представлены более подробные сведения о безопасности билета проверки подлинности форм.

> [!NOTE]
> Многие финансовых и медицинские веб-узлы настроены на использование SSL на *все* страниц, доступных для прошедших проверку пользователей. При создании такого веб-сайта, можно настроить систему проверки подлинности форм, чтобы билета проверки подлинности с помощью форм передаются только через безопасное подключение. Мы рассмотрим различные параметры конфигурации для проверки подлинности форм в следующем уроке  *[настройки проверки подлинности форм и дополнительные разделы](forms-authentication-configuration-and-advanced-topics-cs.md)*.


## <a name="step-4-detecting-authenticated-visitors-and-determining-their-identity"></a>Шаг 4: Обнаружение прошедшего проверку подлинности посетителей и определение их идентификации

На этом этапе мы включения проверки подлинности форм и создать страницу входа, ограниченные механизмы, но у нас есть еще для проверки того, как мы можно определить, является ли пользователь проверку подлинности или анонимный. В некоторых сценариях мы можете отображать различные данные или сведения в зависимости от того, было ли проверку подлинности или анонимного пользователя посетив страницу. Кроме того мы часто нужно знать удостоверение пользователя, прошедшего проверку подлинности.

Давайте дополнить существующие страницу Default.aspx, чтобы демонстрируются эти методы. На странице Default.aspx добавьте два панель элемента управления, один именованный AuthenticatedMessagePanel и другой именованный AnonymousMessagePanel. Добавьте элемент управления Label, с именем WelcomeBackMessage первой панели. Второй панели добавления элемента управления HyperLink, установите его свойство Text на «Вход», а для свойства NavigateUrl в «~ / Login.aspx». На этом этапе декларативная разметка для Default.aspx должен выглядеть следующим образом:

[!code-aspx[Main](an-overview-of-forms-authentication-cs/samples/sample6.aspx)]

Как вы, вероятно, догадаться к этому моменту, смысл в том для отображения только AuthenticatedMessagePanel для прошедших проверку подлинности посетителей и просто AnonymousMessagePanel для анонимных пользователей. Для этого необходимо установить эти панели отображаемых свойств в зависимости от того, является ли пользователь вошел или не.

[Request.IsAuthenticated свойство](https://msdn.microsoft.com/library/system.web.httprequest.isauthenticated.aspx) возвращает логическое значение, указывающее, прошел ли запрос аутентификацию. Введите следующий код в страницу\_загрузить код обработчика событий:

[!code-csharp[Main](an-overview-of-forms-authentication-cs/samples/sample7.cs)]

Этот код в месте посетите Default.aspx через браузер. Предположим, что у вас еще выполнить вход, вы увидите ссылку на страницу входа (см. рис. 11). Щелкните эту ссылку и войдите на сайт. Как мы видели в шаге 3, после ввода учетных данных вы вернетесь на Default.aspx, но это время на странице отображается «Приветствия обратно!» сообщения (см. рис. 12).


![При посещении анонимно, ссылка в журнале отображается](an-overview-of-forms-authentication-cs/_static/image27.png)

**Рис. 11**: отображаются при посещении анонимно, ссылка в журнал


![Отображаются пользователи, прошедшие проверку подлинности](an-overview-of-forms-authentication-cs/_static/image28.png)

**Рис. 12**: показаны прошедшие проверку «Добро пожаловать»! Сообщение


Можно определить удостоверение пользователя, выполнившего вход через [объект HttpContext](https://msdn.microsoft.com/library/system.web.httpcontext.aspx) [свойство пользователя](https://msdn.microsoft.com/library/system.web.httpcontext.user.aspx). Объект HttpContext представляет сведения о текущем запросе и — это место для таких общих объектов ASP.NET, как ответ, запроса и сеанса, в частности. Свойства пользователя представляет контекст безопасности текущего HTTP-запроса и реализует [интерфейса IPrincipal](https://msdn.microsoft.com/library/system.security.principal.iprincipal.aspx).

Свойство пользователя задается FormsAuthenticationModule. В частности когда FormsAuthenticationModule находит билета проверки подлинности форм во входящем запросе, создает новый объект GenericPrincipal и присваивает его свойству пользователя.

Principal-объекты (например, GenericPrincipal) предоставляют сведения о удостоверение пользователя и роли, к которым они принадлежат. Интерфейс IPrincipal определяет два члена:

- [IsInRole (*roleName*)](https://msdn.microsoft.com/library/system.security.principal.iprincipal.isinrole.aspx) — метод, который возвращает логическое значение, указывающее, принадлежит ли участник к указанной роли.
- [Удостоверение](https://msdn.microsoft.com/library/system.security.principal.iprincipal.identity.aspx) — свойство, которое возвращает объект, реализующий интерфейс [интерфейс IIdentity](https://msdn.microsoft.com/library/system.security.principal.iidentity.aspx). Интерфейс IIdentity определяет три свойства: [AuthenticationType](https://msdn.microsoft.com/library/system.security.principal.iidentity.authenticationtype.aspx), [свойство IsAuthenticated](https://msdn.microsoft.com/library/system.security.principal.iidentity.isauthenticated.aspx), и [имя](https://msdn.microsoft.com/library/system.security.principal.iidentity.name.aspx).

Мы можно определить имя текущей посетителя, используя следующий код:

Строка, currentUsersName = User.Identity.Name;

Если с помощью форм проверки подлинности, [FormsIdentity объект](https://msdn.microsoft.com/library/system.web.security.formsidentity.aspx) создается для GenericPrincipal свойство Identity. Класс FormsIdentity всегда возвращает строку «Forms» для свойства AuthenticationType и true для свойства его свойство IsAuthenticated. Свойство Name возвращает имя пользователя, указанное при создании билета проверки подлинности форм. Помимо этих трех свойств FormsIdentity включает доступ к базовой билет проверки подлинности через его [билета свойство](https://msdn.microsoft.com/library/system.web.security.formsidentity.ticket.aspx). Билет свойство возвращает объект типа [FormsAuthenticationTicket](https://msdn.microsoft.com/library/system.web.security.formsauthenticationticket.aspx), который имеет свойства, как срок действия, IsPersistent, IssueDate, имя и т. д.

Важный аспект следует уяснить, вот что *username* параметр, указанный в FormsAuthentication.GetAuthCookie (*username*, *persistCookie*), FormsAuthentication.SetAuthCookie (*username*, *persistCookie*) и FormsAuthentication.RedirectFromLoginPage (*username*, *persistCookie*) методы имеет то же значение, возвращенных User.Identity.Name. Кроме того билет проверки подлинности, созданные при использовании этих методов доступен для приведения объекта FormsIdentity User.Identity и последующий доступ к свойству Ticket:

[!code-csharp[Main](an-overview-of-forms-authentication-cs/samples/sample8.cs)]

Позволяет задать персональный сообщение в файле Default.aspx. Обновление страницы\_загрузки обработчика событий таким образом, чтобы метки WelcomeBackMessage свойство Text присваивается строка «Добро пожаловать, *username*!»

WelcomeBackMessage.Text = "Welcome back, " + User.Identity.Name + "!";

Рис. 13 показано влияние этого изменения (при входе в систему как пользователь Скотт).


![Приветственное сообщение включает в себя пользователя в поле имя пользователя](an-overview-of-forms-authentication-cs/_static/image29.png)

**Рис. 13**: приветственное сообщение включает в себя пользователя в поле имя пользователя


### <a name="using-the-loginview-and-loginname-controls"></a>С помощью LoginView и элементы управления LoginName

Отображение различное содержимое для пользователей, прошедших проверку подлинности и анонимный является общим требованием; Таким образом, отображает имя пользователя, выполнившего вход. По этой причине ASP.NET включает в себя два веб-элементов управления, которые обеспечивают те же функциональные возможности, показанные на рис. 13, но без необходимости написания единой строки кода.

[Управления LoginView](https://msdn.microsoft.com/library/system.web.ui.webcontrols.loginview.aspx) является на основе шаблона веб-элемент управления, упрощающий отображают различные данные для пользователей, прошедших проверку подлинности и анонимный. LoginView включает два стандартных шаблона:

- AnonymousTemplate — разметки добавлен в этот шаблон отображается только для анонимных пользователей.
- LoggedInTemplate — разметки этот шаблон отображается только пользователям, прошедшим проверку.

Давайте добавим наш сайт главной страницы, Site.master элемента управления LoginView. Вместо добавления только элемента управления LoginView, добавим обе нового ContentPlaceHolder элемента управления и поместите в этот новый ContentPlaceHolder элемента управления LoginView. Вскоре станут очевидными обоснование для этого решения.

> [!NOTE]
> Помимо AnonymousTemplate и LoggedInTemplate элемента управления LoginView могут включать шаблоны конкретных ролей. Шаблоны конкретных ролей отображение разметки только для тех пользователей, которые принадлежат определенной роли. Возможности ролей управления LoginView изучим в будущем учебника.


Начните с добавления ContentPlaceHolder, с именем LoginContent в главной страницы в области навигации &lt;div&gt; элемента. Можно просто перетащить элемент управления ContentPlaceHolder из области элементов в представлении источника, поместив разметка прямо над «TODO: меню будет здесь...» текста.

[!code-aspx[Main](an-overview-of-forms-authentication-cs/samples/sample9.aspx)]

Добавьте элемент управления LoginView внутри LoginContent ContentPlaceHolder. Содержимое, помещаются в элементы управления главной страницы ContentPlaceHolder считаются *по умолчанию содержимое* для ContentPlaceHolder. То есть страниц ASP.NET с использованием этой главной страницы можно указать свой собственный контент для каждого ContentPlaceHolder или использовать содержимое главной страницы по умолчанию.

LoginView и другие элементы управления входа расположены в входа вкладку области элементов.


![На панели инструментов элемента управления LoginView](an-overview-of-forms-authentication-cs/_static/image30.png)

**Рис. 14**: на панели инструментов элемента управления LoginView


Добавьте два &lt;br /&gt; элементов сразу после элемента управления LoginView, но по-прежнему внутри ContentPlaceHolder. На этом этапе навигации &lt;div&gt; элемента должна выглядеть следующим образом:

[!code-aspx[Main](an-overview-of-forms-authentication-cs/samples/sample10.aspx)]

Можно определить шаблоны LoginView из конструктора или декларативная разметка. В конструкторе Visual Studio разверните LoginView смарт-тег, который содержит список настроенных шаблонов в раскрывающемся списке. Введите текст «Hello, stranger» в AnonymousTemplate; затем добавьте элемента управления HyperLink и задать его свойства Text и NavigateUrl на «Вход» и «~ / Login.aspx» соответственно.

После настройки AnonymousTemplate, переключитесь в LoggedInTemplate и ввода текста, «Добро пожаловать». Затем перетащите элемент управления LoginName из области элементов в LoggedInTemplate, поместив его сразу же после «Добро пожаловать назад,» текст. [Управления LoginName](https://msdn.microsoft.com/library/system.web.ui.webcontrols.loginname.aspx), как предполагает название, отображает имя текущего пользователя. Внутри элемента управления LoginName просто выводит свойства User.Identity.Name

После внесения этих изменений в шаблоны LoginView, разметка должна выглядеть следующим образом:

[!code-aspx[Main](an-overview-of-forms-authentication-cs/samples/sample11.aspx)]

В результате этого добавления на главную страницу Site.master каждой страницы в веб-узел будет отображаться различные сообщения в зависимости от того, является ли пользователь проверку подлинности. Рис. 15 показана страница Default.aspx при посещены пользователем Цзисунь через браузер. Сообщение «Добро пожаловать назад, Цзисунь» повторяется дважды: один раз в главной страницы переходов слева (с помощью элемента управления LoginView, мы только что добавили) и один раз в файле Default.aspx содержимого области (с помощью панели элементов управления и программная логика).


![Отображение элемента управления LoginView](an-overview-of-forms-authentication-cs/_static/image31.png)

**Рис. 15**: отображает элемент управления LoginView «Добро пожаловать, Цзисунь.»


Так как мы добавили LoginView на главную страницу, она может отображаться на каждой странице на нашем сайте. Тем не менее могут существовать веб-страниц где мы не хотим Показать это сообщение. Такой страницы является страницу входа, поскольку ссылка на страницу входа кажется не на своем месте существует. Поскольку мы разместили элемент управления LoginView в ContentPlaceHolder на главной странице, эта разметка по умолчанию можно переопределить в нашу страницу содержимого. Откройте страницу Login.aspx и перейдите в конструктор. Поскольку мы не определен явно элемент управления содержимым в Login.aspx LoginContent ContentPlaceHolder на главной странице, на страницу входа покажет разметки главной страницы по умолчанию для этого ContentPlaceHolder. Вы увидите это с помощью конструктора — LoginContent ContentPlaceHolder показана разметка по умолчанию (элемента управления LoginView).


[![Страница входа отображается по умолчанию содержимое для главной страницы LoginContent ContentPlaceHolder](an-overview-of-forms-authentication-cs/_static/image33.png)](an-overview-of-forms-authentication-cs/_static/image32.png)

**На рисунке 16**: страницы входа показывает содержимого по умолчанию для главной страницы LoginContent ContentPlaceHolder ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image34.png))


Чтобы переопределить стандартную разметку для LoginContent ContentPlaceHolder, щелкните правой кнопкой мыши в области конструктора и выберите создать настраиваемый содержимое в контекстном меню. (При использовании Visual Studio 2008 ContentPlaceHolder включает смарт-тег, при выборе обеспечивает тот же параметр.) При этом добавляется новый элемента управления содержимым в разметке страницы и тем самым позволяет определить настраиваемое содержимое для этой страницы. Невозможно добавить пользовательское сообщение, например «Выполните вход in...», но давайте просто оставьте это поле пустым.

> [!NOTE]
> В Visual Studio 2005, при создании пользовательского содержимого создается пустой содержимого элемента управления на странице ASP.NET. В Visual Studio 2008 Однако создание пользовательского содержимого копирует содержимое главной страницы по умолчанию в только что созданный элемент управления содержимым. При использовании Visual Studio 2008, после создания нового элемента управления содержимым убедитесь очистить содержимое, скопированных из главной страницы.


Рисунок 17 показана страница Login.aspx при посещении из браузера после внесения этого изменения. Обратите внимание, что не «Hello, stranger» или «Добро пожаловать, *username*» сообщение на панели навигации слева &lt;div&gt; как при посещении Default.aspx.


[![Страница входа скрывает разметки LoginContent ContentPlaceHolder по умолчанию](an-overview-of-forms-authentication-cs/_static/image36.png)](an-overview-of-forms-authentication-cs/_static/image35.png)

**Рисунок 17**: страницы входа скрывает разметки LoginContent ContentPlaceHolder по умолчанию ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image37.png))


## <a name="step-5-logging-out"></a>Шаг 5: Выход

На шаге 3 мы рассматривали создания страницы входа для входа пользователя в систему на сайте, но у нас есть еще сведения для пользователя выход. В дополнение к методам для входа пользователя в FormsAuthentication класс также предоставляет [метод SignOut](https://msdn.microsoft.com/library/system.web.security.formsauthentication.signout.aspx). Метод SignOut просто уничтожает билета проверки подлинности форм, тем самым входа пользователя за пределы сайта.

Журнал ожидания ссылка — это стандартная функция предложения, ASP.NET содержит элемент управления, специально для пользователя выход. [Управления LoginStatus](https://msdn.microsoft.com/library/system.web.ui.webcontrols.loginstatus.aspx) отображает LinkButton «Вход» или «Выход» LinkButton, в зависимости от состояния проверки подлинности пользователя. В то время как LinkButton «Выход» отображается пользователям, прошедшим проверку для анонимных пользователей отображается LinkButton «Вход». Текст для элементов управления LinkButton «Выход» и «Вход» можно настроить с помощью LoginStatus LoginText и LogoutText свойства.

Нажав кнопку «Вход» LinkButton вызывает обратную передачу, из которого выпускается перенаправление на страницу входа. Нажав кнопку «Выход» LinkButton заставляет элемент управления LoginStatus для вызова метода FormsAuthentication.SignOff и затем перенаправляет пользователя на страницу. Страница, вошедшего в систему сеанс пользователя перенаправляется зависит от свойства LogoutAction, который можно назначить одно из трех следующих значений:

- Обновление — значение по умолчанию. перенаправляет пользователя на страницу, которую они только что посещения. Если страница, которую они только что посещения анонимным пользователям не разрешено, затем FormsAuthenticationModule будет автоматически перенаправлять пользователя на страницу входа.

Может быть интересно, перешли почему здесь выполняется перенаправление. Если пользователь хочет остаются на той же странице, почему необходимость явного перенаправления? Так как при щелчке LinkButton «Выход», пользователь по-прежнему имеет билета проверки подлинности форм в свою коллекцию файлов cookie. Поэтому обратного запроса является запрос с проверкой подлинности. Элемент управления LoginStatus вызывает метод SignOut, но это происходит после FormsAuthenticationModule прошел проверку подлинности пользователя. Таким образом для явного перенаправления заставляет браузер повторного запроса страницы. К моменту браузер повторно запрашивает страницу билета проверки подлинности форм была удалена, и поэтому входящего запроса является анонимным.

- Перенаправления — пользователь перенаправляется на URL-адрес, заданный свойством LogoutPageUrl LoginStatus.
- RedirectToLoginPage — пользователь перенаправляется на страницу входа.

Давайте управления LoginStatus главной страницы и настройте его для использования перенаправления параметр для отправки пользователю страницу, которая выводит сообщение, подтверждающее, что они вышли из системы. Начните с создания страницы в корневом каталоге с именем Logout.aspx. Не забудьте связать эту страницу с главной страницы Site.master. Затем введите сообщение в разметке страницы, объясняющий пользователю, который они отключены.

Затем вернуться на главную страницу Site.master и добавьте элемент управления LoginStatus под LoginView в LoginContent ContentPlaceHolder. Задать свойства элемента управления LoginStatus LogoutAction перенаправления, а для свойства LogoutPageUrl в «~ / Logout.aspx».

[!code-aspx[Main](an-overview-of-forms-authentication-cs/samples/sample12.aspx)]

Поскольку LoginStatus выходит за пределы элемента управления LoginView, он будет отображаться для анонимных и зарегистрированных пользователей, но это нормально, так как «Вход» или «Выход» LinkButton LoginStatus будет правильно отображать. При добавлении элемента управления LoginStatus гиперссылка «Вход» AnonymousTemplate является избыточным, таким образом удалить.

На рисунке 18 показано Default.aspx при посещении Цзисунь. Обратите внимание, что в левом столбце отображается сообщение «Добро пожаловать, Цзисунь» со ссылкой на выход. Щелкнув выход LinkButton вызывает обратную передачу, Цзисунь выходит из системы и перенаправляет ее Logout.aspx. Как показано на рисунке 19, когда Цзисунь достигает Logout.aspx ей уже произведен выход и поэтому является анонимным. Следовательно, в левом столбце отображается текст «Добро пожаловать, stranger» и ссылка на страницу входа.


[![Показывает Default.aspx](an-overview-of-forms-authentication-cs/_static/image39.png)](an-overview-of-forms-authentication-cs/_static/image38.png)

**На рисунке 18**: показывает Default.aspx «Добро пожаловать, Цзисунь» вместе с LinkButton «Выход» ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image40.png))


[![Показывает Logout.aspx](an-overview-of-forms-authentication-cs/_static/image42.png)](an-overview-of-forms-authentication-cs/_static/image41.png)

**На рисунке 19**: показывает Logout.aspx «Добро пожаловать, stranger» вместе с LinkButton «Вход» ([Просмотр полноразмерное изображение](an-overview-of-forms-authentication-cs/_static/image43.png))


> [!NOTE]
> Я рекомендую настроить Logout.aspx страницу, чтобы скрыть LoginContent ContentPlaceHolder главной страницы (как это делалось для Login.aspx на шаге 4). Потому, что отображаемый элементом управления LoginStatus LinkButton «Вход» (один под «Hello, stranger») отправляет на страницу входа, передавая ReturnUrl параметра строки запроса URL-адрес текущего пользователя. Иными словами Если пользователь, выполнивший вход out щелкнет этот LoginStatus LinkButton «Вход» и затем регистрирует в, они будут перенаправляться обратно в Logout.aspx, который легко может запутать пользователя.


## <a name="summary"></a>Сводка

В этом учебнике работы с проверкой рабочего процесса проверки подлинности форм, а затем в ней реализация проверки подлинности форм в приложении ASP.NET. На платформе проверки подлинности форм FormsAuthenticationModule, есть две задачи: определение пользователям на основании их билета проверки подлинности форм и Перенаправление неавторизованных пользователей на страницу входа.

Класс FormsAuthentication .NET Framework включает методы для создания, просмотр и удаление билетов проверки подлинности форм. Свойство Request.IsAuthenticated и объект пользователя предоставлять дополнительную поддержку программный для определения, является ли запрос проходит проверку подлинности и информации об удостоверении пользователя. Также существуют элементы управления LoginView, LoginStatus и LoginName Web, которых предоставления разработчикам возможности быстрого, написания кода для выполнения многих распространенных задач, связанных с имени входа. Рассмотрим эти и другие связанные с именем входа веб-элементов управления более подробно в будущих учебниках.

Этот учебник предоставляется поверхностной обзор проверки подлинности форм. Мы не проверить различные параметры, рассмотрим как cookieless рабочих билетов проверки подлинности форм или исследовать, как ASP.NET защищает содержимое билета проверки подлинности форм. Мы рассмотрим эти разделы и см. в разделе [следующее руководство](forms-authentication-configuration-and-advanced-topics-cs.md).

Программирование довольны!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, рассматриваемые в этом учебнике см. в следующих ресурсах:

- [Изменения между безопасности служб IIS 7 и IIS 6](https://www.iis.net/articles/view.aspx/IIS7/Managing-IIS7/Configuring-Security/Changes-between-IIS6-and-IIS7-Security)
- [Элементы управления входом ASP.NET](https://msdn.microsoft.com/library/d51ttbhx.aspx)
- [Профессиональные ASP.NET 2.0 безопасности, членства и управления ролями](http://www.wrox.com/WileyCDA/WroxTitle/productCd-0764596985.html) (ISBN: 978-0-7645-9698-8)
- [`<authentication>` Элемент](https://msdn.microsoft.com/library/532aee0e.aspx)
- [`<forms>` Элемент для `<authentication>`](https://msdn.microsoft.com/library/1d3t3c61.aspx)

### <a name="video-training-on-topics-contained-in-this-tutorial"></a>Видео на разделы, содержащиеся в этом учебнике

- [Использование базовой проверки подлинности на основе форм в ASP.NET](../../../videos/authentication/using-basic-forms-authentication-in-aspnet.md)

## <a name="about-the-author"></a>Об авторе

[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи ASP/ASP.NET и основателя из [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Майкрософт с 1998 года. Скотт — независимый консультант, trainer и записи. Его последняя книга — [ *диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco). Он может быть достигнута по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).

## <a name="special-thanks-to"></a>Особая благодарность

Этот учебник ряд прошел проверку многие полезные рецензентов. Основной рецензент этого учебника было ряда прошел проверку многие полезные рецензентов этого учебника. Основными редакторами этого учебника включают Alicja Maziarz, Джон Suru и Мерфи Тереза д. Объясняются моих последующих статей для MSDN? Если Да, напишите мне по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)

> [!div class="step-by-step"]
> [Назад](security-basics-and-asp-net-support-cs.md)
> [Вперед](forms-authentication-configuration-and-advanced-topics-cs.md)

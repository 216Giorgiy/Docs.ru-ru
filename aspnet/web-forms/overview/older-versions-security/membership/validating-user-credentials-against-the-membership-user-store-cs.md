---
uid: web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-cs
title: "Проверка учетных данных пользователя в хранилище данных членства пользователя (C#) | Документы Microsoft"
author: rick-anderson
description: "В этом учебнике мы рассмотрим, как для проверки учетных данных пользователя в хранилище пользователя членства, с помощью программных средств и управления входом..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/18/2008
ms.topic: article
ms.assetid: 61aa4e08-aa81-4aeb-8ebe-19ba7a65e04c
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-security/membership/validating-user-credentials-against-the-membership-user-store-cs
msc.type: authoredcontent
ms.openlocfilehash: 8f8f4db63ba8c1f1c1df7c1c5c1f92184bf6841d
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2018
---
<a name="validating-user-credentials-against-the-membership-user-store-c"></a>Проверка учетных данных пользователя в хранилище данных членства пользователя (C#)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Загрузить код](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_06_CS.zip) или [скачать PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial06_LoggingIn_cs.pdf)

> В этом учебнике мы рассмотрим, как для проверки учетных данных пользователя в хранилище пользователя членства, с помощью программных средств и управления входом. Кроме того, мы рассмотрим способы настройки внешнего вида и поведения элемента управления имя входа.


## <a name="introduction"></a>Вступление

В <a id="Tutorial05"> </a> [предыдущего учебника](creating-user-accounts-cs.md) мы рассмотрели создание новой учетной записи пользователя в framework членства. Сначала мы рассмотрели программное создание учетных записей пользователей через `Membership` класса `CreateUser` метод и затем просмотреть с помощью элемента управления CreateUserWizard. Тем не менее на страницу входа в настоящее время проверяет указанные учетные данные по списку жестко пар имени пользователя и пароля. Нам нужно обновить логику на страницу входа, таким образом, чтобы он проверяет учетные данные к хранилищу framework членства пользователя.

Гораздо как с созданием учетных записей пользователей, учетные данные могут быть проверены программно или декларативно. API членства включает метод программным путем проверки учетных данных пользователя в хранилище пользователя. И ASP.NET поставляется с входа веб-элементе управления, который отрисовывает пользовательский интерфейс с текстовые поля для имени пользователя и пароль, а также кнопку для входа.

В этом учебнике мы рассмотрим, как для проверки учетных данных пользователя в хранилище пользователя членства, с помощью программных средств и управления входом. Кроме того, мы рассмотрим способы настройки внешнего вида и поведения элемента управления имя входа. Давайте начнем!

## <a name="step-1-validating-credentials-against-the-membership-user-store"></a>Шаг 1: Проверка учетных данных в хранилище данных членства пользователя

Для веб-сайтов, использующих проверку подлинности форм входе пользователя на веб-сайт, посетив страницу входа и ввода учетных данных. Эти учетные данные затем сравниваться хранилища пользователя. Если они являются допустимыми, пользователю предоставляется билета проверки подлинности форм, который является маркером безопасности, который указывает удостоверение и подлинность посетителя.

Для проверки пользователя к framework членства, используйте `Membership` класса [ `ValidateUser` метод](https://msdn.microsoft.com/library/system.web.security.membership.validateuser.aspx). `ValidateUser` Метод принимает два входных параметра -  *`username`*  и  *`password`*  — и возвращает логическое значение, указывающее, использовались ли учетные данные. Как и с `CreateUser` метод мы рассмотрели в предыдущем учебнике `ValidateUser` метод делегирует фактическая проверка для настроенного поставщика членства.

`SqlMembershipProvider` Проверяет указанные учетные данные, получая пароль заданного пользователя через `aspnet_Membership_GetPasswordWithFormat` хранимой процедуры. Помните, что `SqlMembershipProvider` хранит пароли пользователей, используя один из трех форматов: clear зашифрован или хэшируется. `aspnet_Membership_GetPasswordWithFormat` Хранимая процедура возвращает пароль в формате raw. Для зашифрованных или хэшированных паролей `SqlMembershipProvider` преобразует  *`password`*  значение, переданное `ValidateUser` метода, в эквивалентное ему зашифрованы или хэшируются состояние и затем сравнивает его с что возвратил База данных. Если пароль, которые хранятся в базе данных соответствует форматированные пароль, введенный пользователем, учетные данные недопустимы.

Давайте обновить нашу страницу входа в систему (~ /`Login.aspx`), чтобы он проверяет указанные учетные данные в хранилище пользователя членства framework. Мы создали эту страницу входа в <a id="Tutorial02"> </a> [ *Общие сведения для проверки подлинности форм* ](../introduction/an-overview-of-forms-authentication-cs.md) учебник, создание интерфейса с помощью двух текстовых полях имя пользователя и пароль, Запомнить меня, флажки и кнопки входа (см. рис. 1). Код проверяет введенные учетные данные с жестко список пар имя пользователя и пароль (Scott пароль, Цзисунь и пароля и Sam и пароль). В <a id="Tutorial03"> </a> [ *настройки проверки подлинности форм и дополнительные разделы* ](../introduction/forms-authentication-configuration-and-advanced-topics-cs.md) учебника мы обновили кода на страницу входа для хранения дополнительных сведений в формах билет проверки подлинности `UserData` свойство.


[![Интерфейс страницы входа включает два текстовые поля, кнопки и CheckBoxList](validating-user-credentials-against-the-membership-user-store-cs/_static/image2.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image1.png)

**Рис. 1**: страницы входа интерфейса включает два текстовые поля, CheckBoxList и кнопка ([Просмотр полноразмерное изображение](validating-user-credentials-against-the-membership-user-store-cs/_static/image3.png))


Пользовательский интерфейс страницы входа может остаться без изменений, но нужно заменить кнопки входа `Click` обработчик событий с кодом, который проверяет пользователя в хранилище пользователя членства framework. Обновите этот обработчик событий, чтобы ее код имеет следующий вид:

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample1.cs)]

Этот код является весьма простым. Мы начнем с вызова `Membership.ValidateUser` метод, передавая указанное имя пользователя и пароль. Если этот метод возвращает значение true, то пользователь входит на сайт через `FormsAuthentication` RedirectFromLoginPage метод класса. (Как уже говорилось в <a id="Tutorial2"> </a> [ *Общие сведения для проверки подлинности форм* ](../introduction/an-overview-of-forms-authentication-cs.md) учебнике `FormsAuthentication.RedirectFromLoginPage` создает билет проверки подлинности форм и затем перенаправляет пользователя соответствующая страница.) Если учетные данные являются недопустимыми, однако `InvalidCredentialsMessage` метка будет отображаться, сообщая пользователю, что их имя пользователя или пароль неправильный.

Это все, чтобы он!

Чтобы проверить правильность работы страницы входа, пытаться выполнить вход с одной из учетных записей пользователей, созданных в предыдущем учебнике. Или, если вы еще не создали учетную запись, загрузив и создать из `~/Membership/CreatingUserAccounts.aspx` страницы.

> [!NOTE]
> Когда пользователь вводит свои учетные данные и отправляет форму страницы входа, учетные данные, включая пароль, передаются через Интернет на веб-сервер в *обычный текст*. Это означает, что любой злоумышленник, проанализировать сетевой трафик можно увидеть имя пользователя и пароль. Чтобы избежать этого, очень важно для шифрования сетевого трафика с помощью [Secure слои сокетов (SSL)](http://en.wikipedia.org/wiki/Secure_Sockets_Layer). Это позволит гарантировать шифровать учетные данные (а также всю страницу HTML-разметка) от момента, когда они покидают браузер, пока они не будут получены веб-сервером.


### <a name="how-the-membership-framework-handles-invalid-login-attempts"></a>Как Framework членства обрабатывает недопустимые входов

Когда посетитель достигает страницы входа и отправляет свои учетные данные, их браузер отправляет запрос HTTP на страницу входа. Если учетные данные являются допустимыми, HTTP-ответа включает билет проверки подлинности в файле cookie. Таким образом злоумышленник, попытка взлома веб-узла может создать программу, которую досконально отправляет HTTP-запросы на страницу входа с допустимое имя пользователя и пароль предположение. Если пароль пробное значение правильным, страницы входа возвращает билет файла cookie проверки подлинности, после чего программа узнает, что он сталкивались со пару допустимое имя пользователя и пароль. Через подбора такой программы можно наткнулись пароля пользователя, особенно в том случае, если пароль является слабым.

Чтобы избежать подобных атак методом подбора, framework членства блокирует работу пользователя при наличии определенного числа попыток неудачной попытки входа в течение определенного периода времени. Точные параметры можно настраивать следующие параметры конфигурации два поставщика членства:

- `maxInvalidPasswordAttempts`-Указывает, сколько недопустимый пароль попыток разрешены для пользователя в течение периода времени, прежде чем учетная запись заблокирована. Значение по умолчанию — 5.
- `passwordAttemptWindow`-Указывает период времени в минутах, в течение которых указанное количество попыток недопустимое имя для входа приведет к учетной записи могут быть заблокированы. Значение по умолчанию — 10.

Если пользователь была заблокирована, она не может выполнить вход до снятия блокировки администратором своей учетной записи. Когда пользователь будет заблокирована, `ValidateUser` метод будет *всегда* возвращают `false`, даже если допустимые учетные данные указаны. Хотя это уменьшает вероятность того, что злоумышленник прервется на свой сайт через методы подбора, может оказаться блокировки действительный пользователь, который просто забыл свой пароль или случайно Caps Lock или является наличие поврежденных ввода день.

К сожалению нет никаких встроенных средств для разблокировки учетной записи пользователя. Чтобы разблокировать учетную запись, можно изменить базу данных непосредственно - изменять `IsLockedOut` в `aspnet_Membership` таблицу для соответствующей учетной записью пользователя — или создать веб-интерфейс, который перечисляет заблокированных учетных записей с параметрами для их разблокировки. Рассмотрим Создание интерфейсов администратора для выполнения общих пользовательских задач, связанных с учетной записью и роли в будущем учебника.

> [!NOTE]
> Один из недостатков из `ValidateUser` в противном случае, если предоставленные учетные данные являются недопустимыми, он не поддерживает все пояснение, почему это происходит. Учетные данные недопустима, так как в хранилище пользователя, не совпадающую пару имя пользователя и пароль или поскольку пользователь не был утвержден или пользователя была заблокирована. На шаге 4 вы узнаете, как отображать подробные сообщения для пользователя при неудачной попытке их имени входа.


## <a name="step-2-collecting-credentials-through-the-login-web-control"></a>Шаг 2: Сбор учетных данных через веб-элемент управления входа

[Входа веб-элемент управления](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx) Отрисовывает пользовательский интерфейс по умолчанию очень похожий на тот, который мы создали обратно в <a id="SKM5"> </a> [ *Общие сведения для проверки подлинности форм* ](../introduction/an-overview-of-forms-authentication-cs.md) учебника. С помощью управления входом избавляет от необходимости создавать интерфейс для сбора учетных данных s посетитель работу. Кроме того управления входом автоматически выполняет вход пользователя (при условии, что отправленные учетные данные действительны), тем самым сохранение нам от необходимости писать код.

Давайте обновить `Login.aspx`, заменив созданная вручную интерфейса и кода с элементом управления входа в систему. Удалите существующую разметку и код в `Login.aspx`. Можно удалить сразу или просто закомментируйте его. Закомментируйте декларативная разметка, поместите его между `<%--` и `--%>` разделители. Разделители можно ввести вручную или, как показано на рисунке 2, можно выбрать текст, комментарий и нажмите кнопку закомментировать выделенные строки значок на панели инструментов. Аналогично можно использовать закомментируйте значок выбранных строк в комментарий выделенный код в класс кода программной.


[![Закомментируйте существующую декларативная разметка и исходного кода на страницу Login.aspx](validating-user-credentials-against-the-membership-user-store-cs/_static/image5.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image4.png)

**На рисунке 2**: комментарий Out существующих декларативная разметка и исходный код в `Login.aspx` ([Просмотр полноразмерное изображение](validating-user-credentials-against-the-membership-user-store-cs/_static/image6.png))


> [!NOTE]
> Закомментировать выделенные строки значок недоступен при просмотре декларативная разметка в Visual Studio 2005. Если вы не используете Visual Studio 2008 необходимо вручную добавить `<%--` и `--%>` разделители.


Затем перетащите элемент управления Login из области элементов на страницу и установить его `ID` свойства `myLogin`. На этом этапе экран должен выглядеть примерно на рис. 3. Обратите внимание, что интерфейс управления входа по умолчанию включает элементы управления TextBox для имени пользователя и пароля, Запомнить меня в следующий раз флажок и кнопку в журнал. Существуют также `RequiredFieldValidator` элементы управления для двух текстовых полей.


[![Добавление элемента управления для входа на страницу](validating-user-credentials-against-the-membership-user-store-cs/_static/image8.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image7.png)

**Рис. 3**: Добавление элемента управления для входа на страницу ([Просмотр полноразмерное изображение](validating-user-credentials-against-the-membership-user-store-cs/_static/image9.png))


И Готово! При нажатии кнопки входа в управления входом, обратная передача будет выполняться, и управления входом вызовет `Membership.ValidateUser` метод, передавая введенное имя пользователя и пароль. Если учетные данные являются недопустимыми, элемент управления входа отображает сообщение о том, например. Если, однако учетные данные допустимы, управления Login создает билет проверки подлинности форм и перенаправляет пользователя на соответствующую страницу.

Элемент управления входа использует четыре фактора определить соответствующую страницу, чтобы перенаправить пользователя после успешного входа:

- Ли элемент управления входа находится на странице входа, в соответствии с определением `loginUrl` Настройка проверки подлинности форм; этот параметр по умолчанию —`Login.aspx`
- Наличие `ReturnUrl` параметр строки запроса
- Значение элемента управления входа [ `DestinationUrl` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.destinationpageurl.aspx)
- `defaultUrl` Значение указано в формах параметры конфигурации проверки подлинности; значение этого параметра по умолчанию —`Default.aspx`

На рисунке 4 показаны как элемент управления входа использует эти четыре параметра для прибытия на соответствующей странице решения.


[![Добавление элемента управления для входа на страницу](validating-user-credentials-against-the-membership-user-store-cs/_static/image11.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image10.png)

**Рис. 4**: Добавление элемента управления для входа на страницу ([Просмотр полноразмерное изображение](validating-user-credentials-against-the-membership-user-store-cs/_static/image12.png))


Теперь пора проверить элемента управления для входа на узле с помощью браузера, и существующего пользователя в платформе членства.

Готовый для просмотра интерфейс управления входом широкие возможности настройки. Существует ряд свойств, которые влияют на его внешний вид. Более того управления входом можно преобразовать в шаблон для точного контроля над макета элементов пользовательского интерфейса. В оставшейся части этого шага рассматривается настройка внешнего вида и макета.

### <a name="customizing-the-login-controls-appearance"></a>Настройка внешнего вида элемента управления Login

Параметры свойств по умолчанию для управления входом отрисовки пользовательского интерфейса с заголовком (вход), элементы управления текстового поля и метки для входных данных имя пользователя и пароль, Запомнить мои рядом время, флажки и кнопки входа. Внешний вид этих элементов все настраиваются с помощью управления входом множество свойств. Кроме того можно добавить дополнительных элементах пользовательского интерфейса — например, укажите ссылку на страницу, чтобы создать новую учетную запись пользователя -, задав свойство или два.

Давайте потратить некоторое gussy копирование вида нашей управления входом в систему. Поскольку `Login.aspx` страницы уже содержит текст в верхней части страницы, информирующее о имени входа, заголовок элемента управления имя входа является избыточным. Таким образом, очистить [ `TitleText` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.titletext.aspx) значение, чтобы удалить заголовок управления входом.

: Имя пользователя и пароль: метки слева от текстовые поля можно настроить с помощью [ `UserNameLabelText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.usernamelabeltext.aspx) и [ `PasswordLabelText` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordlabeltext.aspx)соответственно. Позволяет изменить имя пользователя: метка для чтения имя пользователя:. Стили метку и текстовое поле настраиваются с помощью [ `LabelStyle` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.labelstyle.aspx) и [ `TextBoxStyle` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textboxstyle.aspx)соответственно.

Запомнить меня свойства Text далее флажок времени можно задать с помощью управления входом [ `RememberMeText property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermetext.aspx), и значение по умолчанию проверки состояния можно настроить через [ `RememberMeSet property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.remembermeset.aspx) (который по умолчанию используется значение False). Продолжить и задать `RememberMeSet` значение True, чтобы Запомнить меня рядом время флажок будет установлен по умолчанию.

Элемент управления входа предоставляет два свойства для подгонки макета ее элементы управления пользовательского интерфейса. [ `TextLayout property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.textlayout.aspx) Указывает, является ли имя пользователя: и пароль: метки отображаются слева их соответствующие текстовые поля (по умолчанию), либо над ними. [ `Orientation property` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.orientation.aspx) Указывает, расположены ли входные данные пользователя и пароль по вертикали (друг с другом) или по горизонтали. Я хочу оставить эти два свойства, значения по умолчанию, но я рекомендую попробовать установить эти два свойства для их значения по умолчанию, чтобы просмотреть результирующий эффект.

> [!NOTE]
> В следующем разделе Настройка макета элемента управления имя входа, мы рассмотрим использование шаблонов для определения точного макета элементов макета элемента управления пользовательского интерфейса.


Подведение параметры свойств управления входом, задав [ `CreateUserText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createusertext.aspx) и [ `CreateUserUrl` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.createuserurl.aspx) для не зарегистрирована? Создание учетной записи! и `~/Membership/CreatingUserAccounts.aspx`соответственно. Это добавляет гиперссылки к интерфейсу управления входом, указывающий на страницу мы создали в <a id="SKM6"> </a> [предыдущего учебника](creating-user-accounts-cs.md). Элемент управления входа [ `HelpPageText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppagetext.aspx) и [ `HelpPageUrl` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.helppageurl.aspx) и [ `PasswordRecoveryText` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoverytext.aspx) и [ `PasswordRecoveryUrl` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.passwordrecoveryurl.aspx) работают таким же образом, ссылки на страницу справки и страницы восстановления пароля.

После внесения этих изменений свойств, декларативная разметка и внешний вид элемента управления входа должен выглядеть, как показано на рис. 5.


[![Значения свойств элемента управления входа определяют его внешний вид](validating-user-credentials-against-the-membership-user-store-cs/_static/image14.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image13.png)

**Рис. 5**: элемент управления входа свойства значения определяют его внешний вид ([Просмотр полноразмерное изображение](validating-user-credentials-against-the-membership-user-store-cs/_static/image15.png))


### <a name="configuring-the-login-controls-layout"></a>Настройка макета элемента управления Login

Пользовательский интерфейс входа веб-элемента управления по умолчанию размещает интерфейсе в HTML- `<table>`. Но что делать, если требуется более точный контроль выводимых данных? Допустим, требуется заменить `<table>` ряд `<div>` тегов. Или, что делать, если приложение требует дополнительные учетные данные для проверки подлинности? Многие финансовые веб-сайты для экземпляра обязать пользователей вводить не только имя пользователя и пароль, но также личный идентификационный номер (PIN) или другие идентификационные сведения. Независимо от причины, возможно, имеется возможность преобразовать в шаблон, из которого можно явным образом определить декларативная разметка интерфейса управления входом.

Необходимо выполнить два действия, чтобы обновить элемент управления входа в систему для сбора дополнительных учетных данных:

1. Обновление интерфейса управления Login для включения элементов управления Web, чтобы собирать дополнительные учетные данные.
2. Переопределение логики управления входом внутренней проверки подлинности, чтобы только проверка подлинности пользователя имя пользователя и пароль действителен ли и их дополнительные учетные данные допустимы, слишком.

Для выполнения первой задачи, необходимо преобразовать в шаблон элемента управления для входа и добавить необходимые веб-элементов управления. Как и для второй задачи управления входом логики проверки подлинности могут быть заменены Создание обработчика событий для элемента управления [ `Authenticate` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx).

Давайте обновляет управления входом, он запрашивает у пользователей ввести имя пользователя, пароль и адрес электронной почты и только проверяет подлинность пользователя, если предоставленный адрес электронной почты соответствует свой адрес электронной почты для файла. Необходимо сначала преобразовать в шаблон интерфейс управления входом. Выберите смарт-тега элемента управления имя входа, преобразовать в шаблон.


[![Преобразовать в шаблон элемента управления для входа](validating-user-credentials-against-the-membership-user-store-cs/_static/image17.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image16.png)

**Рис. 6**: преобразование в шаблон элемента управления для входа ([Просмотр полноразмерное изображение](validating-user-credentials-against-the-membership-user-store-cs/_static/image18.png))


> [!NOTE]
> Чтобы восстановить состояние элемента управления для входа свою версию предварительно template, по ссылке сброса смарт-теге элемента управления.


Преобразование элемента управления для входа в шаблон добавляет `LayoutTemplate` для декларативная разметка элемента управления с помощью HTML-элементов и определение пользовательского интерфейса в веб-элементов управления. Как показано на рис. 7, преобразование в шаблон элемента управления удаляет ряд свойств из окна свойств, таких как `TitleText`, `CreateUserUrl`, и т. д., так как эти значения игнорируются при использовании шаблона.


[![Меньше свойств, доступных при элемент управления входа преобразуется в шаблон](validating-user-credentials-against-the-membership-user-store-cs/_static/image20.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image19.png)

**Рис. 7**: меньше свойств, доступных при элемент управления входа преобразуется в шаблон ([Просмотр полноразмерное изображение](validating-user-credentials-against-the-membership-user-store-cs/_static/image21.png))


HTML-разметку в `LayoutTemplate` могут редактироваться по мере необходимости. Аналогичным образом вы можете добавить любое новое веб-элементов управления в шаблон. Тем не менее, важно управления входом в систему основные веб-элементов управления остаются в шаблон и сохранить назначенных им `ID` значения. В частности, не удалите или переименуйте `UserName` или `Password` текстовые поля, `RememberMe` флажок `LoginButton` кнопки, `FailureText` метку, или `RequiredFieldValidator` элементов управления.

Для сбора посетителей адрес электронной почты, необходимо добавить текстовое поле в шаблон. Добавьте следующую разметку декларативный между строки таблицы (`<tr>`), содержащий `Password` текстового поля и строки таблицы, содержащий Запомнить меня рядом раз флажок:

[!code-aspx[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample2.aspx)]

После добавления `Email` текстовое поле, посетите веб-сайт с помощью браузера. Как показано на рис. 8, пользовательский интерфейс входа элемента управления теперь включает третьего текстового поля.


[![Элемент управления входа теперь включает текстовое поле для адреса электронной почты пользователя](validating-user-credentials-against-the-membership-user-store-cs/_static/image23.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image22.png)

**Рис. 8**: элемент управления входа теперь включает текстовое поле для адреса электронной почты пользователя ([Просмотр полноразмерное изображение](validating-user-credentials-against-the-membership-user-store-cs/_static/image24.png))


На этом этапе управления входом по-прежнему используется `Membership.ValidateUser` метод, чтобы проверить предоставленные учетные данные. Соответственно, значение, введенное в `Email` TextBox никак не влияет на ли пользователь может войти. На шаге 3 мы рассмотрим переопределение логики проверки подлинности имени входа элемента управления, чтобы учетные данные являются только считается действительным, если имя пользователя и пароль являются допустимыми и адрес электронной почты указанного соответствует адрес электронной почты для файла.

## <a name="step-3-modifying-the-login-controls-authentication-logic"></a>Шаг 3: Изменение логики проверки подлинности управления входом

Когда посетитель предоставляет ей учетные данные и щелчков мыши, затем следует кнопку входа, обратную передачу имени входа контроль над и проходит через рабочий процесс проверки подлинности. Рабочий процесс запускается, вызывая [ `LoggingIn` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggingin.aspx). Все обработчики событий, связанных с этим событием может привести к отмене журнала в операции, установив `e.Cancel` свойства `true`.

Если журнал в операции не отменяется, рабочий процесс продвижения, вызывая [ `Authenticate` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.authenticate.aspx). Если обработчик событий для `Authenticate` события, то он отвечает за определение ли указанные учетные данные допустимы, или нет. Если нет обработчика, управления входом использует `Membership.ValidateUser` метод для определения действительности учетных данных.

Если предоставленные учетные данные допустимы, а затем создается билета проверки подлинности с помощью форм, [ `LoggedIn` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loggedin.aspx) происходит событие, и пользователь перенаправляется на соответствующую страницу. Если, однако учетные данные считаются недействительными, а затем [ `LoginError` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.loginerror.aspx) возникает и отображается сообщение, информирующее пользователя, учетные данные были заданы неверно. По умолчанию при сбое входа в систему управления просто устанавливает его `FailureText` метки свойства Text элемента управления, чтобы сообщение об ошибке (попытку входа в систему не выполнена. Повторите попытку). Тем не менее если управления входом [ `FailureAction` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failureaction.aspx) равно `RedirectToLoginPage`, затем проблем входа в систему управления `Response.Redirect` на страницу входа, добавления параметра строки запроса `loginfailure=1` (что вызывает имени входа элемент управления для отображения сообщения об ошибке).

Рис. 9 предлагает блок-схема рабочего процесса проверки подлинности.


[![Рабочий процесс управления входа проверки подлинности](validating-user-credentials-against-the-membership-user-store-cs/_static/image26.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image25.png)

**Рис. 9**: рабочий процесс управления входом в систему проверки подлинности ([Просмотр полноразмерное изображение](validating-user-credentials-against-the-membership-user-store-cs/_static/image27.png))


> [!NOTE]
> Если вас интересует, когда используется `FailureAction` `RedirectToLogin` странице параметр, рассмотрим следующий сценарий. В данный момент нашей `Site.master` Главная страница в настоящее время имеет текст, Hello, stranger отображается в левом столбце при посещении анонимных пользователей, но Предположим, мы хотим замените текст элемента управления для входа. Данный подход позволяет анонимным пользователям входить в систему с любой страницы на сайте, не требуя их посетить непосредственно на страницу входа. Тем не менее, если пользователь не удалось выполнить вход через управления входом, подготовки к просмотру в главной страницы, он может быть целесообразно перенаправит их на странице входа (`Login.aspx`), так как эта страница скорее всего, включает дополнительные инструкции, ссылки и другие Справка — например каналов для создания Новая учетная запись или извлечь утраченный пароль -, не были добавлены на главную страницу.


### <a name="creating-theauthenticateevent-handler"></a>Создание`Authenticate`обработчика событий

Чтобы подключить логику нестандартной проверки подлинности, необходимо создать обработчик событий для элемента управления входом `Authenticate` событий. Создание обработчика событий для `Authenticate` событий создаст следующие определения обработчика событий:

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample3.cs)]

Как видите, `Authenticate` обработчик событий передается объект типа [ `AuthenticateEventArgs` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.authenticateeventargs.aspx) как второй входной параметр. `AuthenticateEventArgs` Класс содержит логическое свойство с именем `Authenticated` , используемый для указания, допустимы ли указанные учетные данные. Наша задача, то необходимо писать код здесь, определяет, допустимы ли указанные учетные данные, а также задания `e.Authenticate` свойство соответствующим образом.

### <a name="determining-and-validating-the-supplied-credentials"></a>Определение и проверка предоставленных учетных данных

Используйте элемент управления Login [ `UserName` ](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.username.aspx) и [ `Password` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.password.aspx) определить учетные данные пользователя и пароль, введенный пользователем. Для определения значения, введенные в любые дополнительные веб-элементов управления (таких как `Email` TextBox, мы добавили в предыдущем шаге), использовать  *`LoginControlID`*  `.FindControl`(» *`controlID`* ») для получения программную ссылку на веб-элемент управления в шаблоне, `ID` свойства равен  *`controlID`* . Например, чтобы получить ссылку на `Email` текстовое поле, используйте следующий код:

`TextBox EmailTextBox = myLogin.FindControl("Email") as TextBox;`

Чтобы проверить учетные данные пользователя, необходимо сделать две вещи:

1. Убедитесь, что указанное имя пользователя и пароль являются допустимыми
2. Убедитесь, что введенный адрес электронной почты соответствует адрес электронной почты для пользователя при входе в файл

Для выполнения первой проверки, можно просто использовать `Membership.ValidateUser` метода, как мы видели в шаге 1. Вторая проверка необходимо определить адрес электронной почты пользователя, чтобы мы можно сравнить с адресом электронной почты, введенные в элементе управления TextBox. Чтобы получить сведения о конкретном пользователе, используйте `Membership` класса [ `GetUser` метод](https://msdn.microsoft.com/library/system.web.security.membership.getuser.aspx).

`GetUser` Метод имеет несколько перегрузок. Если используется без передачи параметров, он возвращает сведения о текущего пользователя. Чтобы получить сведения о конкретном пользователе, вызовите `GetUser` передав их имена пользователей. В любом случае `GetUser` возвращает [ `MembershipUser` объекта](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx), который имеет свойства, такие как `UserName`, `Email`, `IsApproved`, `IsOnline`, и т. д.

Следующий код реализует эти две проверки. Если оба передать, затем `e.Authenticate` равно `true`, в противном случае ему назначается `false`.

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample4.cs)]

Этот код в месте попытка войти качестве допустимого пользователя, введите правильное имя пользователя, пароль и адрес электронной почты. Попробуйте еще раз, но на этот раз намеренно используйте неправильного адреса электронной почты (см. рис. 10). Наконец попробуйте его третий раз, используя имя пользователя не существует. В первом случае пользователь должен успешно войти на сайт, но в двух последних случаях должно появиться сообщение недействительные учетные данные управления входом.


[![Не удается войти Tito при указании неправильного адреса электронной почты](validating-user-credentials-against-the-membership-user-store-cs/_static/image29.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image28.png)

**Рис. 10**: Tito нельзя журнала в при указав неправильный адрес электронной почты ([Просмотр полноразмерное изображение](validating-user-credentials-against-the-membership-user-store-cs/_static/image30.png))


> [!NOTE]
> Как описано в разделе как членство Framework обрабатывает недопустимые попыток входа на шаге 1, если `Membership.ValidateUser` вызывается метод и передать недопустимые учетные данные, он отслеживает попытки недопустимое имя для входа и блокирует работу пользователя, если они превышают определенное Пороговое значение попыток в течение указанного интервала времени. Поскольку наши вызовы логики настраиваемой проверки подлинности `ValidateUser` метод неправильный пароль для допустимое имя пользователя увеличивает счетчик попыток недопустимое имя для входа, но не этого счетчика увеличивается в случае, когда имя пользователя и пароль являются допустимыми, но Неправильный адрес электронной почты. Скорее всего, это подходит, так как это маловероятно, что злоумышленник будет знать имя пользователя и пароль, что нужно использовать подбора методы для определения адреса электронной почты пользователя.


## <a name="step-4-improving-the-login-controls-invalid-credentials-message"></a>Шаг 4: Улучшение управления входом недействительные учетные данные сообщения

Когда пользователь пытается войти в систему с неправильными учетными данными, элемент управления входа отображает сообщение о том, что попытка входа была неудачной. В частности, элемент управления отображает сообщения, заданного его [ `FailureText` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.failuretext.aspx), имеющий значение по умолчанию попытку входа не выполнена. Повторите попытку.

Помните, что существует множество причин, почему может быть недопустимые учетные данные пользователя:

- Имя пользователя не существует
- Имя пользователя существует, но пароль является недопустимым
- Имя пользователя и пароль являются допустимыми, но пользователь еще не утвержденные
- Имя пользователя и пароль являются допустимыми, но пользователь заблокирован out (скорее всего, так как оно превышает число попыток недопустимое имя для входа в течение указанного промежутка времени)

И могут быть другие причины при использовании логики настраиваемой проверки подлинности. Например кодом мы писали на шаге 3, имя пользователя и пароль может быть допустимым, но адрес электронной почты может быть неверным.

Независимо от того, почему учетные данные недействительны элемент управления входа отображает же сообщение об ошибке. Отсутствие обратной связи может запутать пользователя, чья учетная запись не была утверждена или кто была заблокирована. С небольшой работы, мы может иметь более подходящим сообщение элемента управления для входа.

Каждый раз, когда пользователь пытается войти в систему с неправильными учетными данными входа в систему управления вызывает его `LoginError` событий. Теперь создайте обработчик событий для этого события и добавьте следующий код:

[!code-csharp[Main](validating-user-credentials-against-the-membership-user-store-cs/samples/sample5.cs)]

Приведенный выше код запускается, задав управления входом `FailureText` свойства, значение по умолчанию (попытку входа в систему не выполнена. Повторите попытку). Затем он проверяет, если предоставленное имя пользователя сопоставляется с существующей учетной записи пользователя. Если таким образом, он просматривает результирующий `MembershipUser` объекта `IsLockedOut` и `IsApproved` свойства, чтобы определить, если учетная запись заблокирована или не была утверждена. В любом случае `FailureText` свойство обновляется в соответствующее значение.

Чтобы проверить код, намеренно попытайтесь войдите в систему как существующего пользователя, но использовать неправильный пароль. Выполните это пять раз подряд в течение 10 минут, а учетная запись будет заблокирована. Как показано на рис. 11, входа последующие попытки будут всегда ошибкой (даже с правильным паролем), однако теперь отображения более описательное ваша учетная запись заблокирована из-за слишком большого числа попыток недопустимое имя для входа. Обратитесь к администратору, чтобы разблокировать учетную запись сообщения.


[![Tito выполняется слишком много попыток недопустимое имя для входа и была заблокирована](validating-user-credentials-against-the-membership-user-store-cs/_static/image32.png)](validating-user-credentials-against-the-membership-user-store-cs/_static/image31.png)

**Рис. 11**: Tito выполняется слишком много недопустимый попыток входа и имеет был заблокирован ([Просмотр полноразмерное изображение](validating-user-credentials-against-the-membership-user-store-cs/_static/image33.png))


## <a name="summary"></a>Сводка

Предыдущий этого учебника нашу страницу входа проверить предоставленные учетные данные по списку жестко пар имени пользователя и пароля. В этом учебнике мы обновили страницу для проверки учетных данных для членства framework. На первом шаге мы рассмотрели использование `Membership.ValidateUser` метод программными средствами. На шаге 2 мы заменили нашей созданная вручную пользовательского интерфейса и кода с помощью управления входом.

Элемент управления входа Отрисовывает пользовательский интерфейс стандартное имя входа и автоматически проверяет учетные данные пользователя с framework членства. Кроме того в случае действительные учетные данные входа в систему управления входе пользователя посредством проверки подлинности форм. Иными словами в пользовательском интерфейсе входа полнофункциональным доступен, просто перетащив управления входом на страницы, не очень декларативная разметка или код, необходимый. Дополнительные возможности, широкие возможности настройки, позволяя нормально степень контроля над обоих готовый для просмотра пользовательского интерфейса и проверку подлинности логики управления входом.

На этом этапе посетителей на нашем сайте можно создать новую учетную запись пользователя и журнала на сайт, но у нас есть еще рассмотреть ограничения доступа к страницам, зависящих от пользователя, прошедшего проверку подлинности. В настоящее время любого пользователя, прошедшего проверку подлинности или анонимный доступ, можно просмотреть все страницы на нашем сайте. А также управление доступом на нашем сайте страницы на основе пользователя по, возможно некоторые страницы, функциональные возможности которых зависит от пользователя. Далее учебнике рассказывается, как для ограничения доступа и функциональные возможности в страницы на основе зарегистрированного в системе пользователя.

Программирование довольны!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, рассматриваемые в этом учебнике см. в следующих ресурсах:

- [Отображение сообщений с пользовательскими заблокирован и не утвержденные пользователи](http://aspnet.4guysfromrolla.com/articles/050306-1.aspx)
- [Изучение ASP.NET 2.0 членства, ролей и профиля](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [Практическое руководство: Создание имени входа страницы ASP.NET](https://msdn.microsoft.com/library/ms178331.aspx)
- [Техническая документация управления входа](https://msdn.microsoft.com/library/system.web.ui.webcontrols.login.aspx)
- [С помощью элементов управления входом](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/security/login.aspx)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких ASP/ASP.NET и основатель 4GuysFromRolla.com, работает с веб-технологиями Майкрософт с 1998 года. Скотт — независимый консультант, trainer и записи. Его последняя книга —  *[диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скотт может быть достигнута по [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по [http://ScottOnWriting.NET](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Благодарности

Этот учебник ряд прошел проверку многие полезные рецензентов. Основными редакторами этого учебника были Мерфи Тереза д и Майкл Olivero. Объясняются моих последующих статей для MSDN? Если Да, напишите мне по [ mitchell@4GuysFromRolla.com ](mailto:mitchell@4guysfromrolla.com).

>[!div class="step-by-step"]
[Назад](creating-user-accounts-cs.md)
[Вперед](user-based-authorization-cs.md)

---
uid: web-forms/overview/older-versions-security/membership/storing-additional-user-information-cs
title: Сохранение дополнительных сведений (C#) | Документы Microsoft
author: rick-anderson
description: В этом учебнике мы будет ответить на этот вопрос путем построения очень элементарного гостевая. При этом мы рассмотрим различные варианты modeli...
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/18/2008
ms.topic: article
ms.assetid: 1642132a-1ca5-4872-983f-ab59fc8865d3
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-security/membership/storing-additional-user-information-cs
msc.type: authoredcontent
ms.openlocfilehash: e484f63a82ad9ecf1f376143bdc1924e231e0801
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/10/2018
---
<a name="storing-additional-user-information-c"></a>Сохранение дополнительных сведений (C#)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Загрузить код](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_08_CS.zip) или [скачать PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial08_ExtraUserInfo_cs.pdf)

> В этом учебнике мы будет ответить на этот вопрос путем построения очень элементарного гостевая. При этом мы рассмотрим различные параметры для моделирования данных пользователя в базе данных и затем показано, как связать эти данные с учетные записи пользователей, созданные платформой членства.


## <a name="introduction"></a>Вступление

ASP. Членство в .NET framework предлагает гибкий интерфейс для управления пользователями. API членства включает методы для проверки учетных данных, получение сведений о текущего пользователя, создание новой учетной записи пользователя и удаления учетной записи пользователя, в частности. Каждая учетная запись пользователя в платформе членства содержит только свойства, необходимые для проверки учетных данных и выполнения задач, связанных с учетной записи пользователя необходимо. Это свидетельствует методы и свойства [ `MembershipUser` класса](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx), который моделирует framework членство учетной записи пользователя. Этот класс имеет свойства, такие как [ `UserName` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.username.aspx), [ `Email` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.email.aspx), и [ `IsLockedOut` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.islockedout.aspx), и методы, например [ `GetPassword` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.getpassword.aspx) и [ `UnlockUser` ](https://msdn.microsoft.com/library/system.web.security.membershipuser.unlockuser.aspx).

Очень часто нужен для хранения дополнительных сведений о пользователях не включены в framework членства. Например Интернет-магазине может потребоваться разрешить каждому пользователю сохранить ее адреса доставки и выставления счетов, сведения о платеже, параметров доставки и номер телефона. Кроме того каждый заказ в системе связан с учетной записью определенного пользователя.

`MembershipUser` Класса не включает такие свойства, как `PhoneNumber` или `DeliveryPreferences` или `PastOrders`. Так как мы отслеживать сведения о пользователе, необходимые для приложения и его интеграции с помощью платформы членства? В этом учебнике мы будет ответить на этот вопрос путем построения очень элементарного гостевая. При этом мы рассмотрим различные параметры для моделирования данных пользователя в базе данных и затем показано, как связать эти данные с учетные записи пользователей, созданные платформой членства. Давайте начнем!

## <a name="step-1-creating-the-guestbook-applications-data-model"></a>Шаг 1: Создание модели данных гостевая

Существуют различные методы, которые можно использовать для сбора сведений пользователя в базе данных и связать его с учетные записи пользователей, созданные платформой членства. Чтобы продемонстрировать эти методы, необходимо дополнить учебника веб-приложения, чтобы он получает какая-либо данные о пользователях. (В настоящее время модель данных приложения содержит только таблицы, необходимые для служб приложения `SqlMembershipProvider`.)

Давайте создадим простой гостевая, где прошедший проверку пользователь может оставить комментарий. Помимо хранения комментариях, давайте позволить пользователям для сохранения его родного города, домашней страницы и подписи. Если указано, пользователя родного города, домашней страницы и подписи, будут отображаться на каждое сообщение, он остается гостевой книге.

### <a name="adding-theguestbookcommentstable"></a>Добавление`GuestbookComments`таблицы

Чтобы записать комментариях, необходимо создать таблицу базы данных с именем `GuestbookComments` , содержит столбцы как `CommentId`, `Subject`, `Body`, и `CommentDate`. Необходимо также иметь каждой записи в `GuestbookComments` ссылки на таблицу пользователя, оставить комментарий.

Чтобы добавить эту таблицу в базе данных, перейдите в обозреватель баз данных в Visual Studio и детализировать `SecurityTutorials` базы данных. Щелкните правой кнопкой мыши папку «таблицы» и выберите команду Добавить новую таблицу. Откроется интерфейс, позволяющий определить столбцы для новой таблицы.


[![Добавить новую таблицу в базу данных SecurityTutorials](storing-additional-user-information-cs/_static/image2.png)](storing-additional-user-information-cs/_static/image1.png)

**Рис. 1**: добавить новую таблицу в `SecurityTutorials` базы данных ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image3.png))


Затем определите `GuestbookComments`его столбцы. Начните с добавления столбца с именем `CommentId` типа `uniqueidentifier`. Этот столбец будет уникальной идентификации каждого комментария в гостевой книге, поэтому запрещать `NULL` s и пометить ее как первичный ключ таблицы. Вместо того, чтобы предоставить значение для `CommentId` на каждый `INSERT`, мы может указывать, что новый `uniqueidentifier` значение должно автоматически создаваться для этого поля на `INSERT` , задав значение столбца по умолчанию `NEWID()`. После добавления этого первым полем, пометив его как первичный ключ и параметров значения по умолчанию экран должен выглядеть примерно на рисунке показано на рис. 2.


[![Добавить первичный столбец с именем CommentId](storing-additional-user-information-cs/_static/image5.png)](storing-additional-user-information-cs/_static/image4.png)

**На рисунке 2**: добавить основной столбец с именем `CommentId` ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image6.png))


Добавьте столбец с именем `Subject` типа `nvarchar(50)` и столбец с именем `Body` типа `nvarchar(MAX)`, запрет `NULL` s в обоих столбцах. После этого добавьте столбец с именем `CommentDate` типа `datetime`. Запретить `NULL` s и набор `CommentDate` значение по умолчанию столбца `getdate()`.

Осталось добавить столбец, связывающий каждый комментарий гостевую учетную запись пользователя. Один из вариантов следовало бы добавить столбец с именем `UserName` типа `nvarchar(256)`. Это приемлемо при использовании поставщика членства, отличного от `SqlMembershipProvider`. Но при использовании `SqlMembershipProvider`, как мы этого учебника ряда `UserName` столбца в `aspnet_Users` таблицы не обязательно быть уникальными. `aspnet_Users` Является первичным ключом таблицы `UserId` и имеет тип `uniqueidentifier`. Таким образом `GuestbookComments` таблица должна столбец с именем `UserId` типа `uniqueidentifier` (запрет `NULL` значения). Продолжить и добавить этот столбец.

> [!NOTE]
> Как уже говорилось в [ *создания схемы членства в SQL Server* ](creating-the-membership-schema-in-sql-server-cs.md) учебника framework членства, предназначенной для нескольких веб-приложений с разными учетными записями одного и того же хранилище пользователя. Это делается с помощью секционирования учетных записей пользователей в разных приложениях. И хотя каждое имя пользователя гарантированно будет уникальным в пределах приложения, того же имени пользователя могут быть использованы в разных приложениях с помощью того же хранилища пользователя. Имеется составной `UNIQUE` ограничение в `aspnet_Users` таблицы на `UserName` и `ApplicationId` поля, но не на только что `UserName` поля. Следовательно, возможна aspnet\_таблицы пользователи имеют два (или более) записи с тем же `UserName` значение. Нет, однако `UNIQUE` ограничения на `aspnet_Users` таблицы `UserId` поле (так как он является первичным ключом). Объект `UNIQUE` ограничение важен, поскольку без него не может установить ограничение внешнего ключа между `GuestbookComments` и `aspnet_Users` таблицы.


После добавления `UserId` столбца, сохраните таблицу, щелкнув значок сохранения на панели инструментов. Назовите новую таблицу `GuestbookComments`.

У нас есть одна проблема последней, чтобы уделить внимание с `GuestbookComments` таблицы: необходимо создать [ограничение внешнего ключа](https://msdn.microsoft.com/library/ms175464.aspx) между `GuestbookComments.UserId` столбца и `aspnet_Users.UserId` столбца. Для этого щелкните значок связи на панели инструментов для запуска диалогового окна связи по внешнему ключу. (Кроме того, можно открыть его, перейдя в меню конструктора таблиц и выборе связи.)

Нажмите кнопку «Добавить» в левом нижнем углу диалогового окна связи по внешнему ключу. Это добавит новое ограничение внешнего ключа, несмотря на то, что нам по-прежнему необходимо определить таблицы, участвующие в связи.


[![Используйте диалоговое окно связей по внешнему ключу для управления ограничения внешнего ключа таблицы](storing-additional-user-information-cs/_static/image8.png)](storing-additional-user-information-cs/_static/image7.png)

**Рис. 3**: использовать для управления ограничения внешнего ключа таблицы внешнего ключа связи диалоговом окне ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image9.png))


Затем щелкните значок многоточия в строке «Спецификации таблиц и столбцов» в правой части. Это приведет к запуску таблицы и столбцы диалоговым окном, из которого можно указать таблицы первичного ключа и столбец, а столбец внешнего ключа из `GuestbookComments` таблицы. В частности, выберите `aspnet_Users` и `UserId` как таблицы первичного ключа и столбец, и `UserId` из `GuestbookComments` таблице как столбец внешнего ключа (см. рис. 4). После определения первичного и внешнего ключа таблицы и столбцы, нажмите кнопку ОК, чтобы вернуться к диалоговому окну связи по внешнему ключу.


[![Определение внешнего ключа ограничения между aspnet_Users и GuesbookComments таблицы](storing-additional-user-information-cs/_static/image11.png)](storing-additional-user-information-cs/_static/image10.png)

**Рис. 4**: устанавливать внешнего ключа ограничения между `aspnet_Users` и `GuesbookComments` таблиц ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image12.png))


На этом этапе было установлено ограничение внешнего ключа. Наличие этого ограничения гарантирует [реляционной целостности](http://en.wikipedia.org/wiki/Referential_integrity) между двумя таблицами, гарантируя, что никогда не будет запись гостевая книга ссылается на учетную запись пользователя не существует. По умолчанию ограничение внешнего ключа запретит родительской записи должны удаляться, если существуют соответствующие дочерние записи. То есть если пользователь создает один или несколько комментариях и предпринимается попытка удаления учетной записи пользователя, удаления, если не сначала удалить его комментариях.

Ограничения внешнего ключа можно настроить автоматическое удаление связанных дочерних записей при удалении родительской записи. Другими словами мы можно настроить это ограничение внешнего ключа, чтобы гостевой книги записи пользователя автоматически удаляются при удалении своей учетной записи пользователя. Для этого разверните раздел «INSERT и UPDATE спецификация» и задайте для свойства «Удалить правило» значение Cascade.


[![Настройка ограничения внешнего ключа для каскадное удаление](storing-additional-user-information-cs/_static/image14.png)](storing-additional-user-information-cs/_static/image13.png)

**Рис. 5**: Настройка ограничение внешнего ключа для каскадное удаление ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image15.png))


Чтобы сохранить ограничение внешнего ключа, нажмите кнопку "Закрыть", чтобы выйти из связи внешних ключей. Щелкните значок сохранения на панели инструментов можно сохранить в таблице и эта связь.

### <a name="storing-the-users-home-town-homepage-and-signature"></a>Хранение домашней Город пользователя, домашней страницы и подписи

`GuestbookComments` Таблице показано, как сохранить информацию, которая использует один ко многим с учетными записями пользователей. Поскольку каждая учетная запись пользователя может иметь произвольное число связанных комментариев, эта связь моделируется путем создания таблицы для хранения комментариев со столбцом, ссылающемся каждый комментарий к конкретному пользователю. При использовании `SqlMembershipProvider`, связь будет наилучшим образом установлена путем создания столбца с именем `UserId` типа `uniqueidentifier` и ограничение внешнего ключа между этот столбец и `aspnet_Users.UserId`.

Теперь необходимо связать с каждой учетной записи пользователя для хранения пользователя родного города, домашней страницы и подпись, которая будет отображаться в его комментариях три столбца. Существуют количество способов решения этой задачи:

- <strong>Добавление новых столбцов в</strong><strong>`aspnet_Users`</strong><strong>или</strong><strong>`aspnet_Membership`</strong><strong>таблиц.</strong> Я не рекомендую этот подход, так как она изменяет схемы, используемой `SqlMembershipProvider`. Это решение может возвращаться перейдет в будущем. Например, что если будущей версии ASP.NET использует другой `SqlMembershipProvider` схемы. Корпорация Майкрософт может включать средство для переноса ASP.NET 2.0 `SqlMembershipProvider` данных в новую схему, но если вы изменили ASP.NET 2.0 `SqlMembershipProvider` схемы, такое преобразование может оказаться невозможным.

- **С помощью ASP. В .NET framework профиля, определение свойства профиля для родного города, домашней страницы и подписи.** ASP.NET включает платформу профиль, предназначенный для хранения дополнительных данных конкретного пользователя. Например framework членства профиля framework строится поверх модель поставщика. Платформа .NET Framework поставляется с `SqlProfileProvider` sthat, которая хранит данные профиля в базе данных SQL Server. На самом деле, базе данных уже есть таблица, используемая `SqlProfileProvider` (`aspnet_Profile`), как он был добавлен, когда мы добавили служб приложения обратно в <a id="_msoanchor_2"> </a> [ *создания схемы членства в SQL Сервер* ](creating-the-membership-schema-in-sql-server-cs.md) учебника.   
  Основным преимуществом framework профиль является то, что для разработчиков определить свойства профиля в `Web.config` — код не должен записываться сериализации данных профиля из базового хранилища данных. Иными словами очень удобно для определения набора свойств профиля и работа с ними в коде. Однако система профиля оставляет много требуемого, когда дело доходит до управления версиями, поэтому, если в приложении, где предполагается, что новые пользовательские свойства для добавления в более позднее время, так и существующие быть удалены или изменены, а затем framework профиль не может быть  наиболее подходящий вариант. Кроме того `SqlProfileProvider` хранит свойства профиля высокой денормализованные перебора, сделав его практически невозможным выполнять запросы непосредственно к данные профиля (например, сколько пользователей имеют домашний Город Нью-Йорк).   
  Дополнительные сведения о платформе профиля см. в разделе «Дополнительные материалы» в конце этого учебника.

- <strong>Добавьте эти три столбца в новую таблицу в базе данных и установить однозначное соответствие между этой таблицы и</strong><strong>`aspnet_Users`</strong><strong>.</strong> Такой подход немного сложнее, чем с помощью платформы профиль включает в себя, но предоставляет максимальную гибкость при как дополнительные свойства моделируются в базе данных. Этот параметр, который будет использоваться в этом учебнике используется.

Мы создадим новую таблицу с именем `UserProfiles` для сохранения родного города, домашней страницы и подписи для каждого пользователя. Щелкните правой кнопкой мыши папку «таблицы» в окне обозревателя базы данных и выберите команду Создать новую таблицу. Имя первого столбца `UserId` и установите для него `uniqueidentifier`. Запретить `NULL` значений и пометить столбец как первичный ключ. Добавьте столбцы с именами: `HomeTown` типа `nvarchar(50)`; `HomepageUrl` типа `nvarchar(100)`; а подпись типа `nvarchar(500)`. Каждый из этих трех столбцов может принимать `NULL` значение.


[![Создать таблицу UserProfiles](storing-additional-user-information-cs/_static/image17.png)](storing-additional-user-information-cs/_static/image16.png)

**Рис. 6**: создание `UserProfiles` таблицы ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image18.png))


Сохраните таблицу и назовите его `UserProfiles`. Наконец, установить ограничение внешнего ключа между `UserProfiles` таблицы `UserId` поля и `aspnet_Users.UserId` поля. Как мы сделали с ограничение внешнего ключа между `GuestbookComments` и `aspnet_Users` таблицы, иметь это ограничение каскадное удаление. С момента `UserId` в `UserProfiles` первичный ключ, это гарантирует, что будет существовать только одна запись в `UserProfiles` таблицу для каждой учетной записи пользователя. Этот тип связи называется как один к одному.

После создания модели данных, мы готовы для использования. На шагах 2 и 3 будут рассмотрены как можно просматривать и изменять их домашней сведения города, домашней страницы и подпись текущего пользователя. На шаге 4 мы создадим интерфейс для прошедших проверку пользователей отправлять новые комментарии в гостевую книгу и просматривать существующие серверы.

## <a name="step-2-displaying-the-users-home-town-homepage-and-signature"></a>Шаг 2: Отображение домашней Город пользователя, домашней страницы и подписи

Существует множество способов Разрешить текущему пользователю просмотреть и изменить его домашней сведения о городе, домашней страницы и подписи. Мы вручную создать пользовательский интерфейс с текстовым полем и элементы управления Label или мы может использовать один из данных веб-элементы управления, такие как элемент управления DetailsView. Для выполнения в базе данных `SELECT` и `UPDATE` инструкций ADO.NET можно написать код в класс кода программной нашу страницу или можно также использовать декларативный подход с SqlDataSource. В идеальном случае наше приложение будет содержать многоуровневой архитектуре мы, либо можно вызывать программно из классов страницы кода или декларативно с помощью элемента управления ObjectDataSource.

После этого учебника посвящены форм проверки подлинности, авторизации, учетные записи пользователей и роли, не будет подробное описание того, эти параметры доступа различные данные или почему многоуровневая архитектура предпочтительнее непосредственного выполнения инструкции SQL на странице ASP.NET. Я буду для ознакомления с помощью DetailsView и — быстрый и простой параметр – SqlDataSource, но концепции, описанные определенно могут быть применены альтернативные Web элементов управления и данных логики доступа. Дополнительные сведения о работе с данными в ASP.NET см. в мой *[работа с данными в ASP.NET 2.0](../../data-access/index.md)* учебные курсы.

Откройте `AdditionalUserInfo.aspx` страницы в `Membership` папки и добавление элемента управления DetailsView на страницу параметра его `ID` свойства `UserProfile` и очищая его `Width` и `Height` свойства. Разверните DetailsView смарт-тег и выберите для привязки к элементу источника данных. Это приведет к запуску мастера настройки источника данных (см. рис. 7). Первым шагом попросит указать тип источника данных. Так как мы собираемся подключитесь напрямую к `SecurityTutorials` базы данных, выберите значок базы данных, указав `ID` как `UserProfileDataSource`.


[![Добавить новый элемент управления SqlDataSource с именем UserProfileDataSource](storing-additional-user-information-cs/_static/image20.png)](storing-additional-user-information-cs/_static/image19.png)

**Рис. 7**: Добавление нового элемента управления SqlDataSource с именем `UserProfileDataSource` ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image21.png))


Следующая страница запрашивает базу данных для использования. Строка подключения в уже определены `Web.config` для `SecurityTutorials` базы данных. Это имя строки соединения — `SecurityTutorialsConnectionString` — должен находиться в раскрывающемся списке. Выберите этот параметр и нажмите кнопку Далее.


[![Выберите из раскрывающегося списка SecurityTutorialsConnectionString](storing-additional-user-information-cs/_static/image23.png)](storing-additional-user-information-cs/_static/image22.png)

**Рис. 8**: выберите `SecurityTutorialsConnectionString` из раскрывающегося списка ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image24.png))


Последующие экрана появляется запрос на указание таблицы и столбцы для запроса. Выберите `UserProfiles` таблицу из раскрывающегося списка и отметьте все столбцы.


[![Перевести обратно все столбцы из таблицы UserProfiles](storing-additional-user-information-cs/_static/image26.png)](storing-additional-user-information-cs/_static/image25.png)

**Рис. 9**: перевести обратно все столбцы из `UserProfiles` таблицы ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image27.png))


Текущий запрос возвращает рис. 9 *все* записей в `UserProfiles`, но нас интересуют только запись выполнившего вход пользователя. Чтобы добавить `WHERE` предложение, щелкните `WHERE` кнопку, чтобы открыть окно добавления `WHERE` диалогового окна "предложение" (см. рис. 10). Здесь можно выбрать столбец для фильтрации, оператор и источник параметра фильтра. Выберите `UserId` как столбец и «=», что и оператор.

К сожалению, не указан источник встроенный параметр для возврата текущего вошедшего в систему пользователя `UserId` значение. Вам потребуется получить это значение программными средствами. Таким образом значение исходного раскрывающегося списка на «Нет,» щелкните Добавить кнопку, чтобы добавить параметр и нажмите кнопку ОК.


[![Добавьте параметр фильтра для столбца UserId](storing-additional-user-information-cs/_static/image29.png)](storing-additional-user-information-cs/_static/image28.png)

**Рис. 10**: добавьте параметр фильтра на `UserId` столбца ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image30.png))


После нажатия кнопки ОК будет возвращено экран, показанный на рисунке 9. На этот раз Однако SQL-запроса в нижней части экрана должен включать `WHERE` предложения. Чтобы перейти экран «Проверка запроса», нажмите кнопку "Далее". Здесь можно выполнить запрос и просмотреть результаты. Нажмите кнопку Готово, чтобы завершить работу мастера.

После завершения работы мастера настройки источника данных, Visual Studio создает элемент управления SqlDataSource на основе параметров, указанных в мастере. Кроме того, он вручную добавляет стояли DetailsView для каждого столбца, возвращаемые SqlDataSource `SelectCommand`. Нет необходимости для отображения `UserId` поле в DetailsView, поскольку пользователь не нужно знать, это значение. Можно удалить это поле непосредственно из элемента управления DetailsView декларативная разметка или, нажав кнопку «Изменить поля» ссылка с его смарт-тег.

На этом этапе на странице должна выглядеть следующим образом:

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample1.aspx)]

Нам необходимо программно задать элемент управления SqlDataSource `UserId` параметров для текущего вошедшего пользователя `UserId` перед выбором данных. Это можно сделать путем создания обработчика событий для SqlDataSource `Selecting` существует код события и добавив следующий код:

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample2.cs)]

Приведенный выше код запускает путем получения ссылки для текущего пользователя путем вызова `Membership` класса `GetUser` метод. Возвращает `MembershipUser` объекта, в которых `ProviderUserKey` свойство содержит `UserId`. `UserId` Значение затем присваивается SqlDataSource `@UserId` параметра.

> [!NOTE]
> `Membership.GetUser()` Метод возвращает сведения о текущего пользователя. При просмотре странице анонимный пользователь вернется значение `null`. В таком случае это приведет к `NullReferenceException` на следующей строке кода при попытке чтения `ProviderUserKey` свойство. Конечно, нам не нужно беспокоиться о `Membership.GetUser()` возврат `null` значение в `AdditionalUserInfo.aspx` так, как было настроено Авторизация URL-адреса в предыдущем учебнике, чтобы только прошедшие проверку подлинности пользователи могут обращаться к ресурсам ASP.NET в этой папке. Если требуется доступ к сведениям о текущего пользователя на странице, где разрешен анонимный доступ, убедитесь в том, чтобы убедиться, что значение, отличное от`null MembershipUser` объект возвращается из `GetUser()` метод перед ссылкой его свойства.


При посещении `AdditionalUserInfo.aspx` страницы через браузер появится пустая страница, так как у нас есть еще добавить все строки для `UserProfiles` таблицы. На шаге 6 будут рассмотрены способы настройки управления CreateUserWizard для автоматического добавления новой строки к `UserProfiles` таблицы при создании новой учетной записи пользователя. Теперь Однако нам потребуется вручную создать запись в таблице.

Перейдите в обозреватель баз данных в Visual Studio и разверните папку «таблицы». Щелкните правой кнопкой мыши `aspnet_Users` таблицы и выберите «Показать таблицу данных» для просмотра записей в таблице; сделать то же самое для `UserProfiles` таблицы. Рис. 11 показана эти результаты, если мозаикой по вертикали. В базе данных нет `aspnet_Users` записи для Bruce Fred и Tito, но нет записей в `UserProfiles` таблицы.


[![Отображается содержимое aspnet_Users и UserProfiles таблицы](storing-additional-user-information-cs/_static/image32.png)](storing-additional-user-information-cs/_static/image31.png)

**Рис. 11**: содержимое `aspnet_Users` и `UserProfiles` таблиц ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image33.png))


Добавьте новую запись для `UserProfiles` таблицы, вручную введя значения для `HomeTown`, `HomepageUrl`, и `Signature` поля. Самый простой способ получить действующую `UserId` значение в новом `UserProfiles` записи заключается в выборе `UserId` из учетной записи пользователя в `aspnet_Users` таблицы, скопируйте и вставьте его в `UserId` в `UserProfiles`. Рис. 12 показан `UserProfiles` таблицы после добавления новой записи для Bruce.


[![Запись была добавлена к UserProfiles Bruce](storing-additional-user-information-cs/_static/image35.png)](storing-additional-user-information-cs/_static/image34.png)

**Рис. 12**: запись была добавлена к `UserProfiles` для Bruce ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image36.png))


Вернитесь к `AdditionalUserInfo.aspx` страницы, войти в систему качестве Bruce. Как показано на рис. 13, отображаются параметры Bruce's.


[![В настоящее время посещения пользователя — показано His настройки](storing-additional-user-information-cs/_static/image38.png)](storing-additional-user-information-cs/_static/image37.png)

**Рис. 13**: в настоящее время посещения пользователей будет показано His параметры ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image39.png))


> [!NOTE]
> Переход вперед и вручную добавить записи в `UserProfiles` таблицы для каждого пользователя членства. На шаге 6 будут рассмотрены способы настройки управления CreateUserWizard для автоматического добавления новой строки к `UserProfiles` таблицы при создании новой учетной записи пользователя.


## <a name="step-3-allowing-the-user-to-edit-his-home-town-homepage-and-signature"></a>Шаг 3: Разрешение пользователю возможность редактировать его домашней города, домашней страницы и подписи

На этом этапе текущий пользователь может просматривать их родного города, домашней страницы и параметры подписи, но они еще не могут изменять их. Давайте обновить элемент управления DetailsView можно изменять данные.

Первое, что необходимо сделать — добавить `UpdateCommand` для SqlDataSource, указав `UPDATE` оператора для выполнения и соответствующие параметры. SqlDataSource и, в окне свойств щелкните кнопку с многоточием рядом со свойством UpdateQuery, чтобы открыть диалоговое окно Редактор команд и параметров. Введите следующую `UPDATE` инструкции в текстовое поле:

[!code-sql[Main](storing-additional-user-information-cs/samples/sample3.sql)]

Затем нажмите кнопку «Обновить параметры», которая будет создан параметр в элементе управления SqlDataSource `UpdateParameters` коллекцию для каждого параметра в `UPDATE` инструкции. Оставьте источником для всех параметров набора нет и нажмите кнопку ОК, чтобы закрыть диалоговое.


[![Укажите UpdateCommand и UpdateParameters SqlDataSource](storing-additional-user-information-cs/_static/image41.png)](storing-additional-user-information-cs/_static/image40.png)

**Рис. 14**: укажите SqlDataSource `UpdateCommand` и `UpdateParameters` ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image42.png))


Из-за добавления мы внесли в элемент управления SqlDataSource DetailsView управления теперь поддерживает редактирование. DetailsView смарт-теге установите флажок «Разрешить изменение». Это добавляет CommandField в элемент управления `Fields` коллекции с его `ShowEditButton` свойством, имеющим значение True. Это делает кнопку "Изменить", если DetailsView отображается в режиме только для чтения и обновления и кнопки "Отмена", при отображении в режиме редактирования. Не требует от пользователя, нажмите кнопку Изменить, менее, мы может иметь DetailsView отрисовки в состоянии «всегда редактируемые», задав управления DetailsView [ `DefaultMode` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.defaultmode.aspx) для `Edit`.

Эти изменения элемента управления DetailsView должна выглядеть следующим образом:

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample4.aspx)]

Обратите внимание на появление CommandField и `DefaultMode` свойства.

Продолжим и проверить эту страницу через браузер. При посещении с пользователем, который имеет соответствующей записи в `UserProfiles`, параметры пользователя отображаются на интерфейс для редактирования.


[![DetailsView отображает интерфейс для редактирования](storing-additional-user-information-cs/_static/image44.png)](storing-additional-user-information-cs/_static/image43.png)

**Рис. 15**: DetailsView отображает интерфейс для редактирования ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image45.png))


Попробуйте изменять значения и нажав кнопку обновления. Он отображается, как если бы ничего не происходит. Обратная передача значения сохраняются в базе данных, но отсутствует visual обратная связь возникшей сохранения.

Чтобы исправить это, вернитесь в Visual Studio и добавить элемент управления Label выше DetailsView. Задайте его `ID` для `SettingsUpdatedMessage`, ее `Text` свойства «параметры обновления,» и его `Visible` и `EnableViewState` свойства `false`.

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample5.aspx)]

Нам нужно отобразить `SettingsUpdatedMessage` метки при каждом обновлении DetailsView. Чтобы сделать это, создайте обработчик событий для элемента DetailsView `ItemUpdated` событий и добавьте следующий код:

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample6.cs)]

Вернитесь к `AdditionalUserInfo.aspx` страницы с помощью браузера и обновлять данные. На этот раз отображается сообщение о состоянии полезными.


[![SMS-сообщений будет отображаться при обновление параметров](storing-additional-user-information-cs/_static/image47.png)](storing-additional-user-information-cs/_static/image46.png)

**На рисунке 16**: короткое сообщение отображается при обновлении параметров ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image48.png))


> [!NOTE]
> Элемент управления DetailsView Правка оставляет интерфейс много необходимое. Она использует стандартного размера текстовые поля, но поле подписи, скорее всего, должно быть многострочного текстового поля. RegularExpressionValidator следует использовать, чтобы убедиться, что URL-адрес домашней страницы, если введено, начинается с «http://» или «https://». Более того, так как элемента управления DetailsView его `DefaultMode` свойство `Edit`, кнопки «Отмена» не делает ничего. Он должен либо быть удален или, при щелчке перенаправлять пользователя на другую страницу (например, `~/Default.aspx`). Эти усовершенствования я оставьте в качестве упражнения для модуля чтения.


### <a name="adding-a-link-to-theadditionaluserinfoaspxpage-in-the-master-page"></a>Добавление ссылки на`AdditionalUserInfo.aspx`страницы на главной странице

В настоящее время веб-сайт не предоставляет все ссылки на `AdditionalUserInfo.aspx` страницы. Единственный способ получить к нему доступ требуется ввести URL-адрес страницы непосредственно в адресной строке браузера. Давайте добавим ссылку на эту страницу в `Site.master` главной страницы.

Помните, что главная страница содержит элемент управления LoginView Web в его `LoginContent` ContentPlaceHolder, отображающий различные разметки для прошедших проверку подлинности и анонимный посетителей. Обновление элемента управления LoginView `LoggedInTemplate` включить ссылку на `AdditionalUserInfo.aspx` страницы. После внесения этих изменений LoginView элемента управления должна выглядеть следующим образом:

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample7.aspx)]

Обратите внимание, добавление `lnkUpdateSettings` элемента управления HyperLink `LoggedInTemplate`. Для этой ссылки на месте прошедших проверку подлинности пользователей можно быстро перейти на страницу для просмотра и изменения их домашней города, домашней страницы и подписи.

## <a name="step-4-adding-new-guestbook-comments"></a>Шаг 4: Добавление новых комментариях

`Guestbook.aspx` Страница находится где прошедшие проверку подлинности пользователи могут просматривать гостевой книге и оставить комментарий. Давайте начнем с создания интерфейса для добавления новых комментариях.

Откройте `Guestbook.aspx` в Visual Studio и создать пользовательский интерфейс, состоящий из двух элементов управления TextBox: для нового комментария субъекта и для этого тела. Значение первого элемента управления TextBox `ID` свойства `Subject` и его `Columns` свойство 40; установите второй `ID` для `Body`, ее `TextMode` для `MultiLine`и его `Width` и `Rows` свойства «95%» и 8, соответственно. Для завершения пользовательского интерфейса, добавьте кнопку веб-элемент управления с именем `PostCommentButton` и задайте его `Text` значение «Post ваш комментарий».

Поскольку каждый комментарий гостевую требует темы и текст, добавьте RequiredFieldValidator для каждого из текстовых полей. Задать `ValidationGroup` свойства этих элементов управления для «EnterComment»; аналогичным образом, установите `PostCommentButton` элемента управления `ValidationGroup` свойства «EnterComment». Дополнительные сведения о ASP. NET проверяющие элементы управления, извлечение [проверку формы в ASP.NET](http://www.4guysfromrolla.com/webtech/090200-1.shtml), [разбор элементов управления проверки в ASP.NET 2.0](http://aspnet.4guysfromrolla.com/articles/112305-1.aspx)и [учебник элементов управления проверки сервера](http://www.w3schools.com/aspnet/aspnet_refvalidationcontrols.asp) на [W3Schools](http://www.w3schools.com/).

После создания пользовательского интерфейса на странице должна выглядеть примерно следующим образом:

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample8.aspx)]

Благодаря полный пользовательский интерфейс, теперь нам требуется вставить новую запись в `GuestbookComments` таблицу при `PostCommentButton` нажатии. Это можно сделать несколькими способами: мы можно писать код ADO.NET в кнопки `Click` обработчик событий; мы можно добавить на страницу элемент управления SqlDataSource, настроить его `InsertCommand`и вызовите его `Insert` метода из `Click` событий обработчик; или мы могли бы построения средний уровень, для вставки новых комментариях и вызова этих функций из `Click` обработчика событий. Поскольку мы рассмотрели использование SqlDataSource на шаге 3, воспользуемся кода ADO.NET здесь.

> [!NOTE]
> Классы ADO.NET, используемые для программного доступа к данным из базы данных Microsoft SQL Server находятся в `System.Data.SqlClient` пространства имен. Может потребоваться импортировать это пространство имен на странице кода класса (т. е. `using System.Data.SqlClient;`).


Создайте обработчик событий для `PostCommentButton`в `Click` событий и добавьте следующий код:

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample9.cs)]

`Click` Запускает обработчик событий, проверьте правильность данных, предоставленное пользователем. Если это не так, обработчик событий завершит работу перед вставкой записи. При условии, что предоставленных данных является допустимым, выполнившего вход пользователя `UserId` значение извлекается и хранятся в `currentUserId` локальной переменной. Это значение необходимо, поскольку мы должны предоставить `UserId` значение при вставке записи в `GuestbookComments`.

После этого строка соединения для `SecurityTutorials` базы данных извлекается из `Web.config` и `INSERT` задана инструкция SQL. Объект `SqlConnection` объект создается и открывается. Далее, `SqlCommand` объект создается и значения для параметров используются в `INSERT` назначаются запроса. `INSERT` Выполняется инструкция, и соединение закрыто. В конце обработчика событий `Subject` и `Body` текстовые поля `Text` свойства, очищаются, чтобы значения пользователя, не сохраняются между обратной передачи.

Продолжим и проверьте страницу в браузере. Так как эта страница находится в `Membership` папку он недоступен для анонимных пользователей. Таким образом необходимо будет первого входа в систему (если это еще не сделано). Введите значение в `Subject` и `Body` текстовые поля и нажмите кнопку `PostCommentButton` кнопки. Это приведет к новой записи для добавления `GuestbookComments`. При обратной передаче поле темы и текст, введенный удаляются из текстовых полей.

После нажатия кнопки `PostCommentButton` существует кнопка является не визуальную обратную связь, комментарий, добавленный в гостевую книгу. Мы по-прежнему необходимо обновить эту страницу, чтобы отобразить существующие комментариях, которые мы сделаем это в шаге 5. После добиться, просто добавить комментарий будет отображаться в списке комментариев, предоставляя достаточно визуальную обратную связь. На данном этапе подтверждения, гостевой книге комментарий был сохранен, проверив содержимое из `GuestbookComments` таблицы.

Рисунок 17 показано содержимое `GuestbookComments` таблицу были добавлены два комментарии.


[![Вы увидите в комментариях в таблице GuestbookComments](storing-additional-user-information-cs/_static/image50.png)](storing-additional-user-information-cs/_static/image49.png)

**Рисунок 17**: вы увидите комментариях в `GuestbookComments` таблицы ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image51.png))


> [!NOTE]
> Если пользователь пытается вставить гостевой книге комментарий, который содержит потенциально опасной разметки — например HTML — ASP.NET вызовет `HttpRequestValidationException`. Дополнительные сведения об этом исключении, почему оно создается, и как разрешить пользователям отправлять потенциально опасных значений обратитесь к [Технический документ проверки запроса](../../../../whitepapers/request-validation.md).


## <a name="step-5-listing-the-existing-guestbook-comments"></a>Шаг 5: Список существующих комментариях

Помимо оставить комментарии, пользователю, просматривающему `Guestbook.aspx` страница должна быть возможность просматривать существующие комментариях. Чтобы сделать это, добавьте элемент управления ListView с именем `CommentList` в нижней части страницы.

> [!NOTE]
> Элемент управления ListView впервые появился в ASP.NET версии 3.5. Она предназначена для отображения списка элементов в очень настраиваемым и гибкий макет, но по-прежнему предлагают встроенные редактирование, вставка, удаление, разбиение по страницам и сортировка функциональные возможности, такие как GridView. При использовании ASP.NET 2.0, необходимо вместо этого используйте элемент управления DataList или повторителя. Дополнительные сведения об использовании ListView см. в разделе [Скотт Гатри](https://weblogs.asp.net/scottgu/)в записи блога [управления asp: ListView](https://weblogs.asp.net/scottgu/archive/2007/08/10/the-asp-listview-control-part-1-building-a-product-listing-page-with-clean-css-ui.aspx)и моей статье [отображение данных с помощью элемента управления ListView](http://aspnet.4guysfromrolla.com/articles/122607-1.aspx).


Откройте ListView смарт-тег и привязки элемента управления источника данных из раскрывающегося списка Выбор источника данных. Как было показано в шаге 2, запустится мастер настройки источника данных. Выберите значок базы данных, имя результирующей SqlDataSource `CommentsDataSource`и нажмите кнопку ОК. Затем выберите `SecurityTutorialsConnectionString` подключения строка, из раскрывающегося списка и нажмите кнопку Далее.

На этом этапе на шаге 2 можно указать данные для запроса с комплектации `UserProfiles` таблицу из раскрывающегося списка и выберите столбцы, возвращаемые (указывают назад на рис. 9). На этот раз тем не менее, мы хотим создать инструкцию SQL, которая извлекает не только записи из `GuestbookComments`, но также составителя комментария родного города, домашней страницы, подписи и имя пользователя. Таким образом установите переключатель «Указать пользовательские инструкции SQL или хранимой процедуры» и нажмите кнопку Далее.

Откроется окно «Определение пользовательских инструкций или хранимых процедур». Нажмите кнопку построителя запросов для графического построения запроса. Построитель запросов начинает, предлагающее указать таблицы, которые нам нужно создать запрос. Выберите `GuestbookComments`, `UserProfiles`, и `aspnet_Users` таблицы и нажмите кнопку ОК. Все три таблицы добавляются в область конструктора. Так как существуют ограничения внешнего ключа между `GuestbookComments`, `UserProfiles`, и `aspnet_Users` таблицы, построитель запросов автоматически `JOIN` s эти таблицы.

Осталось укажите возвращаемые столбцы. Из `GuestbookComments` таблицы выберите `Subject`, `Body`, и `CommentDate` столбцы; возвращают `HomeTown`, `HomepageUrl`, и `Signature` столбцы из `UserProfiles` таблицы; и возвращать `UserName` из `aspnet_Users`. Кроме того, добавьте "`ORDER BY CommentDate DESC`" в конец `SELECT` запроса, чтобы последние записи, будут возвращены первыми. После выбора этих на показанную на рисунке 18 должен выглядеть интерфейс построителя запросов.


[![Constructed запрос на соединение GuestbookComments, UserProfiles и aspnet_Users таблицы](storing-additional-user-information-cs/_static/image53.png)](storing-additional-user-information-cs/_static/image52.png)

**На рисунке 18**: запрос создан `JOIN` s `GuestbookComments`, `UserProfiles`, и `aspnet_Users` таблиц ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image54.png))


Нажмите кнопку ОК, чтобы закрыть окно построителя запросов и вернуться в окно «Определение пользовательских инструкций или хранимых процедур». Нажмите кнопку Далее, чтобы перейти на экран «Проверка запроса», где можно просмотреть результаты запроса, нажав кнопку Проверить запрос. Когда вы будете готовы, нажмите кнопку "Готово", чтобы завершить работу мастера настройки источника данных ".

Когда мы выполнили мастер настройки источника данных в шаге 2, связанного элемента управления DetailsView `Fields` коллекции был обновлен для включения BoundField для каждого столбца, возвращаемое `SelectCommand`. ListView, однако остается без изменений; Мы по-прежнему необходимо определить его макет. Макет ListView могут быть созданы вручную через его декларативная разметка или через пункт «Настройка ListView» в его смарт-тег. Я обычно предпочитают определение разметку вручную, но использовать любой метод самым естественным выбором.

Остановка происходит с помощью следующих `LayoutTemplate`, `ItemTemplate`, и `ItemSeparatorTemplate` для элемента управления ListView:

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample10.aspx)]

`LayoutTemplate` Определяет разметку передаются с помощью элемента управления, а `ItemTemplate` отображает каждый элемент, возвращаемый SqlDataSource. `ItemTemplate`Его разметка помещается в `LayoutTemplate` `itemPlaceholder` элемента управления. В дополнение к `itemPlaceholder`, `LayoutTemplate` включает элемент управления DataPager, который ограничивает ListView отображается только 10 комментариях на каждой странице (по умолчанию) и отображает интерфейс разбиения по страницам.

Мои `ItemTemplate` отображает каждый комментарий гостевую субъекта в `<h4>` элемент с текстом, которые находятся ниже субъекта. Обратите внимание, что синтаксис, используемый для отображения текста принимает данные, возвращенные `Eval("Body")` инструкции привязки данных, преобразует его в строку и заменяет разрывы строк с `<br />` элемента. Такое преобразование необходимо, чтобы показать разрывы строки, введенные при отправке комментарий, так как пробелы игнорируются с HTML. Подпись пользователя отображается под текст курсивом, следуют пользователя родного города, ссылку на его домашней страницы, даты и времени, сделанные комментарий, имя пользователя для пользователя, который оставить комментарий.

Занять некоторое время для просмотра страницы через браузер. Вы увидите комментарии, добавленные в гостевую книгу на шаге 5, показанные здесь.


[![Guestbook.aspx сейчас отображается комментариях](storing-additional-user-information-cs/_static/image56.png)](storing-additional-user-information-cs/_static/image55.png)

**На рисунке 19**: `Guestbook.aspx` теперь отображает комментариях ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image57.png))


Попробуйте добавить нового комментария в гостевую книгу. После нажатия кнопки `PostCommentButton` обратной передаче страницы кнопку Добавить комментарий к базе данных, но в элементе управления ListView не обновляется для отображения нового комментария. Это можно исправить, либо:

- Обновление `PostCommentButton` кнопки `Click` обработчик событий, чтобы он вызывал управления ListView `DataBind()` метод после вставки нового комментария в базе данных, или
- Задание элемента управления ListView `EnableViewState` свойства `false`. Такой подход работает, так как отключив состояние представления элемента управления, его необходимо привязать данные каждой обратной передачи.

Учебник веб-сайт, загружаемые из этого учебника иллюстрирует обоих методов. Элемент управления ListView `EnableViewState` свойства `false` и код, необходимый для программным способом привяжите данные к ListView присутствует в `Click` обработчик событий закомментирован.

> [!NOTE]
> В настоящее время `AdditionalUserInfo.aspx` страницы позволяет пользователю просматривать и изменять их домашней настройки города, домашней страницы и подписи. Он может быть низким приоритетом обновить `AdditionalUserInfo.aspx` для отображения вошедшего в систему в комментариях пользователя. То есть, помимо изучения и изменения ее сведения, посетите пользователь `AdditionalUserInfo.aspx` страницу, чтобы увидеть, какие гостевую комментарии, она выполняется в прошлом. Я это поле оставить в качестве упражнения для интересующихся.


## <a name="step-6-customizing-the-createuserwizard-control-to-include-an-interface-for-the-home-town-homepage-and-signature"></a>Шаг 6: Настройка управления CreateUserWizard включаемых интерфейс для домашней города, домашней страницы и подписи

`SELECT` Запрос, используемый методом `Guestbook.aspx` страница использует `INNER JOIN` для объединения связанных записей среди `GuestbookComments`, `UserProfiles`, и `aspnet_Users` таблицы. Если пользователь, не имеет записи в `UserProfiles` делает гостевую комментарий комментария не будет отображаться в ListView, так как `INNER JOIN` возвращает только `GuestbookComments` записей при отсутствии совпадающих записей в `UserProfiles` и `aspnet_Users`. И как мы видели в шаге 3, если пользователь не имеет запись `UserProfiles` ей не удается просмотреть или изменить ее параметры в `AdditionalUserInfo.aspx` страницы.

Следует отметить, из-за нашей разработки решений, важно, что каждой учетной записи пользователя в систему членства имеет соответствующего записи в `UserProfiles` таблицы. Мы хотим предназначен для соответствующей записи для добавления `UserProfiles` при создании новой учетной записи пользователя членства через CreateUserWizard.

Как было сказано в [ *Создание учетных записей пользователей* ](creating-user-accounts-cs.md) учебник, после создания новой учетной записи пользователя членства управления CreateUserWizard вызывает его [ `CreatedUser` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx). Мы создайте обработчик событий для этого события, получить идентификатор пользователя для только что созданного пользователя и затем вставить запись в `UserProfiles` таблицы со значениями по умолчанию для `HomeTown`, `HomepageUrl`, и `Signature` столбцов. Более того существует возможность запрашивать у пользователя эти значения, настроив интерфейс управления CreateUserWizard, включив дополнительные текстовые поля.

Давайте сначала посмотрим, как добавить новую строку в `UserProfiles` в таблицу `CreatedUser` обработчика событий со значениями по умолчанию. Вслед за этим будет показано, как настроить пользовательский интерфейс управления CreateUserWizard включать дополнительные поля формы для сбора родного города, домашней страницы и подпись нового пользователя.

### <a name="adding-a-default-row-touserprofiles"></a>Добавление строки по умолчанию в`UserProfiles`

В [ *Создание учетных записей пользователей* ](creating-user-accounts-cs.md) учебника мы добавили в элементе управления CreateUserWizard для `CreatingUserAccounts.aspx` страницы в `Membership` папки. Для выполнения CreateUserWizard управления добавить запись `UserProfiles` таблицы при создании учетных записей пользователей, необходимо обновить функциональные возможности управления CreateUserWizard. Вместо того, чтобы эти изменения, `CreatingUserAccounts.aspx` давайте вместо этого добавьте новый элемент управления CreateUserWizard для `EnhancedCreateUserWizard.aspx` страницы и внесите изменения в этом учебнике существует.

Откройте `EnhancedCreateUserWizard.aspx` в Visual Studio и перетащите элемент управления CreateUserWizard из области элементов на страницу. Настройка управления CreateUserWizard `ID` свойства `NewUserWizard`. Как уже говорилось в <a id="_msoanchor_5"> </a> [ *Создание учетных записей пользователей* ](creating-user-accounts-cs.md) учебника CreateUserWizard по умолчанию пользовательский интерфейс предлагает посетитель всю необходимую информацию. После эти сведения были указаны, элемент управления внутри создает учетной записи пользователя в платформе членства без нам писать единой строки кода.

Элемент управления CreateUserWizard вызывает ряд событий во время его рабочего процесса. Срабатывает после посетитель предоставляет сведения о запросе и отправляет форму, изначально управления CreateUserWizard его [ `CreatingUser` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.creatinguser.aspx). Если проблема во время процесса создания [ `CreateUserError` событий](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createusererror.aspx) срабатывает; тем не менее, если пользователь успешно создан, то [ `CreatedUser` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.createduser.aspx) возникает. В <a id="_msoanchor_6"> </a> [ *Создание учетных записей пользователей* ](creating-user-accounts-cs.md) учебника мы создали обработчик событий для `CreatingUser` событий, чтобы убедиться, что указанное имя пользователя не содержал ведущими или конечные пробелы, и что имя пользователя не появился в любом месте в пароле.

Чтобы добавить строку в `UserProfiles` таблицы для только что созданного пользователя, необходимо создать обработчик событий для `CreatedUser` события. К моменту `CreatedUser` возникло событие, учетная запись пользователя уже создана в платформе членства, позволяющих извлечь значение UserId учетной записи пользователя.

Создайте обработчик событий для `NewUserWizard`в `CreatedUser` событий и добавьте следующий код:

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample11.cs)]

Начинается выше код, получив идентификатор пользователя учетной записи пользователя, только что добавлен. Это достигается с помощью `Membership.GetUser(username)` метод для возврата сведений о конкретного пользователя, а затем использовав `ProviderUserKey` свойства, чтобы получить их UserId. Имя пользователя, введенное пользователем в элементе управления CreateUserWizard доступен через его [ `UserName` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.username.aspx).

После этого строка подключения извлекается из `Web.config` и `INSERT` задана инструкция. Создаются необходимые объекты ADO.NET и выполнить команду. Код присваивает [ `DBNull` ](https://msdn.microsoft.com/library/system.dbnull.aspx) экземпляр `@HomeTown`, `@HomepageUrl`, и `@Signature` параметры, которые приводит к вставке базы данных `NULL` значения `HomeTown`, `HomepageUrl`, и `Signature` поля.

Посетите `EnhancedCreateUserWizard.aspx` через браузер и создать новую учетную запись. После этого вернитесь в Visual Studio и изучить содержимое `aspnet_Users` и `UserProfiles` таблицы (как мы делали обратно на рис. 12). Вы увидите новую учетную запись пользователя в `aspnet_Users` и соответствующим `UserProfiles` строки (с `NULL` значения для `HomeTown`, `HomepageUrl`, и `Signature`).


[![Новая учетная запись пользователя и UserProfiles записи были добавлены](storing-additional-user-information-cs/_static/image59.png)](storing-additional-user-information-cs/_static/image58.png)

**Рис. 20**: новой учетной записи пользователя и `UserProfiles` записи были добавлены ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image60.png))


После посетителя имеет предоставленный информации своей новой учетной записи и нажал кнопку «Создать пользователя», создается учетная запись пользователя, и к добавлению строки `UserProfiles` таблицы. CreateUserWizard затем отображает ее `CompleteWizardStep`, которая отображает сообщение об успешном выполнении и кнопки продолжения. Нажав кнопку «Продолжить» вызывает обратную передачу, но никакие действия не выполняются, а пользователь вошел на `EnhancedCreateUserWizard.aspx` страницы.

Можно указать URL-адрес для отправки пользователю при нажатии кнопки "Продолжить" посредством управления CreateUserWizard [ `ContinueDestinationPageUrl` свойства](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.continuedestinationpageurl.aspx). Задать `ContinueDestinationPageUrl` свойства «~ / Membership/AdditionalUserInfo.aspx». Откроется новый пользователю `AdditionalUserInfo.aspx`, где они могут просматривать и обновлять их параметры.

### <a name="customizing-the-createuserwizards-interface-to-prompt-for-the-new-users-home-town-homepage-and-signature"></a>Настройка интерфейса CreateUserWizard на запрос нового пользователя домашней города, домашней страницы и подписи

Интерфейс управления CreateUserWizard по умолчанию достаточно для сценариев создания простого учетной записи, где должны собираться только основных учетных записей пользователей как имя пользователя, пароль и электронной почты. Но что делать, если мы хотели бы предложить посетитель введите свой родного города, домашней страницы и подписи при создании учетной записи? Существует возможность настроить интерфейс управления CreateUserWizard для сбора дополнительных сведений при регистрации, и эти сведения могут использоваться в `CreatedUser` обработчик событий, чтобы вставить дополнительные записи в базе данных.

Элемент управления CreateUserWizard расширяет возможности управления мастер ASP.NET, который представляет элемент управления, позволяющий разработчику определить ряд упорядоченный `WizardSteps`. Мастер управления отрисовывает активного шага и предоставляет интерфейс навигации, который позволяет посетителя для перемещения по следующие действия. Мастер управления идеально подходит для разбиение long задачи на несколько простых шагов. Дополнительные сведения о мастере управления см. в разделе [Создание пошаговое пользовательского интерфейса с помощью элемента управления ASP.NET 2.0 мастер](http://aspnet.4guysfromrolla.com/articles/061406-1.aspx).

По умолчанию разметку элемента управления CreateUserWizard определяет два `WizardSteps`: `CreateUserWizardStep` и `CompleteWizardStep`.

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample12.aspx)]

Первый `WizardStep`, `CreateUserWizardStep`, отображает интерфейс, который запрашивает имя пользователя, пароль, электронной почты и т. д. После посетителя отправляет эту информацию и нажимает кнопку «Создать пользователя», она отображается `CompleteWizardStep`, который показывает сообщение об успешном выполнении и кнопки продолжения.

Чтобы настроить интерфейс управления CreateUserWizard, включив дополнительные поля формы, мы можем:

- <strong>Создать один или несколько новых</strong><strong>`WizardStep`</strong><strong>s, чтобы содержать дополнительные элементы интерфейса</strong>. Чтобы добавить новый `WizardStep` чтобы CreateUserWizard, нажмите кнопку «Добавить или удалить `WizardSteps`"ссылка из его смарт-тег, чтобы запустить `WizardStep` редактор коллекции. Здесь можно добавить, удалить или переупорядочить шаги в мастере. Именно этот подход, которые будут использоваться для этого учебника.

- <strong>Преобразовать</strong><strong>`CreateUserWizardStep`</strong><strong>в редактируемый</strong><strong>`WizardStep`</strong><strong>.</strong> Эта процедура заменяет `CreateUserWizardStep` на эквивалентное `WizardStep` которого разметка определяет пользовательский интерфейс, который соответствует `CreateUserWizardStep`"s. Путем преобразования `CreateUserWizardStep` в `WizardStep` можно переместить элементы управления или добавление дополнительных элементах пользовательского интерфейса на этом шаге. Чтобы преобразовать `CreateUserWizardStep` или `CompleteWizardStep` в редактируемый `WizardStep`, нажмите кнопку «Создать пользователя Настройка перешагнуть» или «Настроить полный шаг» ссылку из смарт-тега элемента управления.

- **Используйте сочетание двух вышеупомянутых параметров.**

Важно помнить, является выполнение управления CreateUserWizard его процесс создания учетной записи пользователя, при нажатии кнопки «Создать пользователя» изнутри его `CreateUserWizardStep`. Не важно, если существуют дополнительные `WizardStep` s после `CreateUserWizardStep` или нет.

При добавлении пользовательского `WizardStep` управления CreateUserWizard, чтобы собирать дополнительного ввода данных пользователем, пользовательского `WizardStep` можно разместить до или после `CreateUserWizardStep`. Если она предшествует `CreateUserWizardStep` затем дополнительного ввода данных пользователем собираются из настраиваемого `WizardStep` для `CreatedUser` обработчика событий. Тем не менее если пользовательский `WizardStep` следует после `CreateUserWizardStep` затем, когда пользовательский `WizardStep` отображается учетную запись пользователя уже создан и `CreatedUser` события.

Рисунок 21 показан рабочий процесс после добавления `WizardStep` предшествует `CreateUserWizardStep`. С момента сбора дополнительных сведений по времени `CreatedUser` вызывается событие, все что нужно сделать — обновление `CreatedUser` обработчик событий для получения входных данных и использовать их для `INSERT` значения параметров инструкции (а не `DBNull.Value`).


[![CreateUserWizard рабочего процесса, когда дополнительные WizardStep предшествует CreateUserWizardStep](storing-additional-user-information-cs/_static/image62.png)](storing-additional-user-information-cs/_static/image61.png)

**Рисунок 21**: CreateUserWizard рабочего процесса при дополнительных `WizardStep` Precedes `CreateUserWizardStep` ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image63.png))


Если пользовательский `WizardStep` помещается *после* `CreateUserWizardStep`, однако процесса создания учетной записи пользователя происходит до того, как пользователь возможность ввести свой домашний города, домашней страницы или подпись. В этом случае необходимо вставки в базу данных после создания учетной записи пользователя, как показано на рисунке 22 этих дополнительных сведений.


[![CreateUserWizard рабочего процесса, когда дополнительные WizardStep следует после CreateUserWizardStep](storing-additional-user-information-cs/_static/image65.png)](storing-additional-user-information-cs/_static/image64.png)

**На рисунке 22**: CreateUserWizard рабочего процесса при дополнительных `WizardStep` поставляется после `CreateUserWizardStep` ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image66.png))


Рабочий процесс, показанный на рисунке 22 ожидает вставки записи в `UserProfiles` таблице до, после завершения шаг 2. Если посетитель закрывает браузер после шага 1, тем не менее, будет достигнут состояния, где учетную запись пользователя была создана, но не запись была добавлена к `UserProfiles`. Одно решение — записывать с `NULL` или по умолчанию значениях, вставляемых в `UserProfiles` в `CreatedUser` обработчик событий (которая срабатывает после шага 1) и только затем это записи после завершения шаг 2. Это гарантирует, что `UserProfiles` будет добавлена запись для учетной записи пользователя, даже если пользователь закрывает регистрации процесса середине.

В этом учебнике мы создадим новый `WizardStep` , наступающее после `CreateUserWizardStep` перед вызовом `CompleteWizardStep`. Давайте первый get WizardStep в поместите и настройки, а затем мы рассмотрим код.

Смарт-тег элемента управления CreateUserWizard, выберите «Добавить или удалить `WizardStep` s», вызывает `WizardStep` диалогового окна Редактор коллекции. Добавьте новый `WizardStep`, параметр его `ID` для `UserSettings`, ее `Title` для «Your параметры» и его `StepType` для `Step`. Расположите его, чтобы он следует после `CreateUserWizardStep` («зарегистрироваться для новой учетной записи») и перед `CompleteWizardStep` («завершение»), как показано на рисунке 23.


[![Добавление элемента управления CreateUserWizard новый WizardStep](storing-additional-user-information-cs/_static/image68.png)](storing-additional-user-information-cs/_static/image67.png)

**На рисунке 23**: добавить новый `WizardStep` для управления CreateUserWizard ([Просмотр полноразмерное изображение](storing-additional-user-information-cs/_static/image69.png))


Нажмите кнопку ОК, чтобы закрыть `WizardStep` диалогового окна Редактор коллекции. Новый `WizardStep` свидетельствует управления CreateUserWizard обновленные декларативная разметка:

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample13.aspx)]

Обратите внимание, новый `<asp:WizardStep>` элемента. Нам нужно добавить пользовательский интерфейс для сбора родного города, домашней страницы и подписи здесь нового пользователя. Это содержимое можно ввести в декларативного синтаксиса или с помощью конструктора. Для использования конструктора, выберите шаг «Your параметры» из раскрывающегося списка в смарт-тег, чтобы просмотреть шаг в конструкторе.

> [!NOTE]
> При выборе действия – смарт-тег раскрывающегося списка обновляется управления CreateUserWizard [ `ActiveStepIndex` свойство](https://msdn.microsoft.com/library/system.web.ui.webcontrols.createuserwizard.activestepindex.aspx), которое указывает индекс начального шага. Таким образом, при использовании этого раскрывающегося списка для изменения на шаге «Your параметры» в конструкторе, не забудьте установить его обратно в «Вход на новой учетной записи», чтобы этот шаг показан при первом посещении пользователей `EnhancedCreateUserWizard.aspx` страницы.


Создание пользовательского интерфейса в пределах шага «Your параметры», который содержит три элемента управления TextBox с именем `HomeTown`, `HomepageUrl`, и `Signature`. После создания этот интерфейс, CreateUserWizard должна выглядеть следующим образом:

[!code-aspx[Main](storing-additional-user-information-cs/samples/sample14.aspx)]

Продолжить и посетите эту страницу через браузер, создав учетной записи пользователя, определяя родного города, домашней страницы и подписи. После завершения `CreateUserWizardStep` в структуре членства создается учетная запись пользователя и `CreatedUser` выполняется обработчик событий, которые добавляет новую строку в `UserProfiles`, но база данных `NULL` значение для `HomeTown`, `HomepageUrl`, и `Signature`. Значения, введенные для родного города, домашней страницы и подпись никогда не используются. Конечным результатом становится учетной записи пользователя с `UserProfiles` запись которого `HomeTown`, `HomepageUrl`, и `Signature` поля еще должны быть указаны.

Нам нужно выполнять код после шаг «Your параметры», который принимает домашней города, honepage и подпись значений, вводимых пользователем и обновляет соответствующий `UserProfiles` записи. Каждый раз при перемещении между шагами в мастер элементов управления, мастер [ `ActiveStepChanged` событие](https://msdn.microsoft.com/library/system.web.ui.webcontrols.wizard.activestepchanged.aspx) активируется. Можно создать обработчик событий для этого события и обновления `UserProfiles` таблицы при завершении шага «Your параметры».

Добавьте обработчик событий для CreateUserWizard `ActiveStepChanged` событий и добавьте следующий код:

[!code-csharp[Main](storing-additional-user-information-cs/samples/sample15.cs)]

Приведенный выше код начинается с определения, если мы только что достигнуто на шаге «Завершение». Так как на шаге «Завершение» возникает сразу после шага «Свои параметры», когда посетитель достигает «Выполнено» пошагово, означает, что она только что завершили шаг «Your параметры».

В этом случае необходимо программным путем ссылки на элементы управления TextBox в `UserSettings WizardStep`. Это достигается с помощью первого `FindControl` метод для программного обращения к `UserSettings WizardStep`, а затем еще раз, чтобы ссылаться текстовых полей внутри `WizardStep`. После сослались текстовых полей, все готово для выполнения `UPDATE` инструкции. `UPDATE` Инструкция имеет то же число параметров, `INSERT` инструкции в `CreatedUser` обработчика событий, но здесь мы используем домашней города, домашней страницы и подпись значения, предоставленные пользователем.

С помощью этого обработчика событий в месте, посетите `EnhancedCreateUserWizard.aspx` через браузер и создать новую учетную запись указания значений для родного города, домашней страницы и подписи. После создания новой учетной записи должны быть перенаправлены в `AdditionalUserInfo.aspx` страницы, где только что введенных домашней города, домашней страницы и подпись информация отображается.

> [!NOTE]
> Наш веб-сайт в настоящее время имеет две страницы, из которых посетитель может создать новую учетную запись: `CreatingUserAccounts.aspx` и `EnhancedCreateUserWizard.aspx`. Пункты sitemap веб-сайта и страницы входа `CreatingUserAccounts.aspx` страницы, но `CreatingUserAccounts.aspx` страницы не запрашивает пользователя его домашней города, домашней страницы и подписи данные и не создается соответствующая строка в `UserProfiles`. Поэтому обновлять `CreatingUserAccounts.aspx` страницы, чтобы он обеспечивает эту функцию или обновить страницу карты веб-узла и имя входа для ссылки на `EnhancedCreateUserWizard.aspx` вместо `CreatingUserAccounts.aspx`. Если вы выберите второй вариант, необходимо обязательно обновить `Membership` папки `Web.config` файл таким образом, чтобы разрешить анонимным пользователям доступ к `EnhancedCreateUserWizard.aspx` страницы.


## <a name="summary"></a>Сводка

В этом учебнике мы рассмотрели методы для моделирования данных, связанного с учетных записей пользователей в структуре членства. В частности мы рассматривали моделирования сущностей, которые совместно используют один ко многим учетные записи пользователей, а также данные, которые являются общими отношение. Кроме того, мы узнали, как это связаны сведения могут отображаться, вставляются и обновляются, с примерами с использованием элемента управления SqlDataSource и др с помощью кода ADO.NET.

Этот учебник завершает нашей рассмотрим учетных записей пользователей. Начиная с следующем уроке мы будет можем обратиться к роли. По следующей несколько учебников, мы рассмотрим framework ролей, показано, как создать новые роли как назначение ролей для пользователей, чтобы определить, какие роли принадлежит пользователь, а также и применять проверку подлинности на основе ролей.

Программирование довольны!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, рассматриваемые в этом учебнике см. в следующих ресурсах:

- [Просмотр и обновление данных в ASP.NET 2.0](http://aspnet.4guysfromrolla.com/articles/011106-1.aspx)
- [Элемент управления ASP.NET 2.0 мастера](https://weblogs.asp.net/scottgu/archive/2006/02/21/438732.aspx)
- [Создание пошаговые пользовательского интерфейса с помощью элемента управления ASP.NET 2.0 мастера](http://aspnet.4guysfromrolla.com/articles/061406-1.aspx)
- [Создание параметров управления пользовательский источник данных](http://aspnet.4guysfromrolla.com/articles/110106-1.aspx)
- [Настройка управления CreateUserWizard](http://aspnet.4guysfromrolla.com/articles/070506-1.aspx)
- [Примеры использования элемента управления DetailsView](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/ctrlref/data/detailsview.aspx)
- [Отображение данных с помощью элемента управления ListView](http://aspnet.4guysfromrolla.com/articles/122607-1.aspx)
- [Разбор элементов управления проверки в ASP.NET 2.0](http://aspnet.4guysfromrolla.com/articles/112305-1.aspx)
- [Изменения, вставки и удаления данных](../../data-access/editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md)
- [Проверка формы в ASP.NET](http://www.4guysfromrolla.com/webtech/090200-1.shtml)
- [Сбор сведений о регистрации пользовательского](https://weblogs.asp.net/scottgu/archive/2006/07/05/Tip_2F00_Trick_3A00_-Gathering-Custom-User-Registration-Information.aspx)
- [Профили в ASP.NET 2.0](http://www.odetocode.com/Articles/440.aspx)
- [Элемент управления asp: ListView](https://weblogs.asp.net/scottgu/archive/2007/08/10/the-asp-listview-control-part-1-building-a-product-listing-page-with-clean-css-ui.aspx)
- [Примеры использования профилей пользователя](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/profile/default.aspx)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких ASP/ASP.NET и основатель 4GuysFromRolla.com, работает с веб-технологиями Майкрософт с 1998 года. Скотт — независимый консультант, trainer и записи. Его последняя книга —  *[диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скотт может быть достигнута по [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по [ http://ScottOnWriting.NET ](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность

Этот учебник ряд прошел проверку многие полезные рецензентов. Объясняются моих последующих статей для MSDN? Если Да, напишите мне по [ mitchell@4GuysFromRolla.com ](mailto:mitchell@4GuysFromRolla.com).

> [!div class="step-by-step"]
> [Назад](user-based-authorization-cs.md)
> [Вперед](creating-the-membership-schema-in-sql-server-vb.md)

---
uid: web-forms/overview/older-versions-security/membership/creating-the-membership-schema-in-sql-server-vb
title: "Создание схемы членства в SQL Server (VB) | Документы Microsoft"
author: rick-anderson
description: "Этот учебник начинает проверять методы для добавления необходимую схему для использования SqlMembershipProvider к базе данных. После этого мы wi..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/18/2008
ms.topic: article
ms.assetid: 112a674d-716f-41a6-99b8-4074d65a54c0
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-security/membership/creating-the-membership-schema-in-sql-server-vb
msc.type: authoredcontent
ms.openlocfilehash: 181741dc7e0fb7e1073f3783d96f59ac905f5e63
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/10/2017
---
<a name="creating-the-membership-schema-in-sql-server-vb"></a>Создание схемы членства в SQL Server (Visual Basic)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Загрузить код](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/ASPNET_Security_Tutorial_04_VB.zip) или [скачать PDF](http://download.microsoft.com/download/3/f/5/3f5a8605-c526-4b34-b3fd-a34167117633/aspnet_tutorial04_MembershipSetup_vb.pdf)

> Этот учебник начинает проверять методы для добавления необходимую схему для использования SqlMembershipProvider к базе данных. После этого мы проверка ключа таблиц в схеме и обсудить их назначении и важность. Этот учебник завершает рассматриваются как определить, какой поставщик членства framework следует использовать приложения ASP.NET.


## <a name="introduction"></a>Вступление

Предыдущие два учебника проанализирована с помощью проверки подлинности форм для идентификации посетителей веб-сайта. Проверка подлинности форм упрощает для разработчиков, для входа пользователя в веб-сайт и запомнить их через посещений страницы с использованием билетов проверки подлинности. `FormsAuthentication` Класс содержит методы для создания билета и добавив его в файлы cookie посетителя. `FormsAuthenticationModule` Анализирует все входящие запросы и для них с помощью билета проверки подлинности, создает и связывает `GenericPrincipal` и `FormsIdentity` объект с текущим запросом. Проверка подлинности форм — просто в механизм предоставления билета проверки подлинности пользователь при входе в и при последующих запросах, синтаксический анализ Этот билет для установления личности пользователя. Для веб-приложения для поддержки учетных записей пользователей по-прежнему необходимо реализовать хранилище пользователя и добавить функциональные возможности для проверки учетных данных, регистрации новых пользователей, а также множество других задач пользователя учетной записи.

До ASP.NET 2.0 разработчикам приходилось обработчик для реализации все эти задачи связанные с учетной записью пользователя. К счастью команда ASP.NET распознан этот недостаток и включает платформу членства в ASP.NET 2.0. Платформа членство — это набор классов в .NET Framework, которые предоставляют программный интерфейс для выполнения основных задач, связанных с учетной записью пользователя. Эта платформа строится поверх [модель поставщика](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx), которая позволяет разработчикам подключите пользовательской реализации стандартизированный API-Интерфейс.

Как было сказано в <a id="Tutorial1"> </a> [ *основы безопасности и поддержкой ASP.NET* ](../introduction/security-basics-and-asp-net-support-vb.md) учебник, .NET Framework поставляется с двумя встроенных поставщиков членства: [ `ActiveDirectoryMembershipProvider` ](https://msdn.microsoft.com/en-us/library/system.web.security.activedirectorymembershipprovider.aspx) и [ `SqlMembershipProvider` ](https://msdn.microsoft.com/en-us/library/system.web.security.sqlmembershipprovider.aspx). Как и предполагает его имя, `SqlMembershipProvider` использует базы данных Microsoft SQL Server в качестве хранилища пользователя. Чтобы использовать этот поставщик в приложение, необходимо указать поставщику, какие базы данных для использования в качестве хранилища. Как можно себе представить, `SqlMembershipProvider` ожидает базу данных хранилища пользователя иметь определенные таблицы базы данных, представления и хранимые процедуры. Необходимо добавить этот ожидаемую схему для выбранной базы данных.

Этот учебник начинает проверять методы для добавления необходимую схему для базы данных для использования `SqlMembershipProvider`. После этого мы проверка ключа таблиц в схеме и обсудить их назначении и важность. Этот учебник завершает рассматриваются как определить, какой поставщик членства framework следует использовать приложения ASP.NET.

Давайте начнем!

## <a name="step-1-deciding-where-to-place-the-user-store"></a>Шаг 1: Выбор места для размещения хранилища пользователя

Приложения ASP.NET данные часто хранятся в нескольких таблицах в базе данных. При реализации `SqlMembershipProvider` схемы базы данных, мы необходимо решить, следует ли поместить схемы членства в той же базе данных, как данные приложения или в альтернативную базу данных.

Я рекомендую поиск схемы членства в той же базе данных, как данные приложения по следующим причинам:

- **Простота модификации** проще для понимания, обслуживание и развертывание, чем приложение, которое имеет две базы данных приложения, данные которого инкапсулируется в одной базе данных.
- **Реляционной целостности** , найдя в таблицах, связанных с членством в той же базе данных, как приложения таблицы, он является возможность установления [ограничения внешнего ключа](http://en.wikipedia.org/wiki/Foreign_key) первичных ключей в Таблиц, связанных с членством и связанные приложения таблицы.

Отделение данных хранилища и приложения пользователя в отдельной базе данных имеет смысл только при наличии нескольких приложений каждого использовать отдельные базы данных, что нужно совместно использовать общее хранилище пользователя.

### <a name="creating-a-database"></a>Создание базы данных

Приложение, которое мы строить так как второй учебника еще не обязательно базы данных. Нужно один, однако для хранилища пользователя. Позволяет создать и затем добавить к нему схему, необходимую `SqlMembershipProvider` поставщика (см. шаг 2).

> [!NOTE]
> На протяжении этого ряда учебника мы будем использовать [Microsoft SQL Server 2005 Express Edition](https://msdn.microsoft.com/en-us/sql/Aa336346.aspx) базу данных для хранения нашими таблицами приложения и `SqlMembershipProvider` схемы. Это было сделано по двум причинам: во-первых, из-за его стоимость - свободных - экспресс-выпуск является наиболее легче читаются доступную версию SQL Server 2005; Во-вторых, можно поместить баз данных SQL Server 2005 Express Edition непосредственно в веб-приложение `App_Data` папку, сделав его несложной упаковка базы данных и веб-приложения в один ZIP-файл и выполнить его повторное развертывание без какие-либо специальная настройка инструкции или параметры конфигурации. Если вы хотите использовать для выполнения этой процедуры с помощью экспресс-выпуск не - версии SQL Server, вы можете. Действия, практически не отличается. `SqlMembershipProvider` Схемы будет работать с любой версии Microsoft SQL Server 2000 и до.

В обозревателе решений щелкните правой кнопкой мыши `App_Data` папку и выберите команду Добавить новый элемент. (Если вы не видите `App_Data` в папке проекта, правой кнопкой мыши проект в обозревателе решений выберите Добавить папку ASP.NET и выберите `App_Data`.) В диалоговом окне Добавление нового элемента выберите, чтобы добавить новую базу данных SQL с именем `SecurityTutorials.mdf`. В этом учебнике мы будем добавлять `SqlMembershipProvider` схемы для этой базы данных; в последующих учебники, мы создадим дополнительных таблиц для отслеживания наших данных приложения.


[![Добавление новой базы данных SQL с именем SecurityTutorials.mdf базы данных в папку App_Data](creating-the-membership-schema-in-sql-server-vb/_static/image2.png)](creating-the-membership-schema-in-sql-server-vb/_static/image1.png)

**Рис. 1**: Добавление новой базы данных SQL с именем `SecurityTutorials.mdf` базы данных для `App_Data` папку ([Просмотр полноразмерное изображение](creating-the-membership-schema-in-sql-server-vb/_static/image3.png))


Добавление базы данных до `App_Data` папки автоматически включает его в представлении обозревателя базы данных. (В экспресс-выпуск не - версии Visual Studio, в обозревателе базы данных называется обозревателя серверов). Перейдите в обозревателе баз данных и разверните только что добавленные `SecurityTutorials` базы данных. При обозреватель баз данных нет на экране, перейдите в меню «Вид» и выбрать обозреватель баз данных или нажмите сочетание клавиш Ctrl + Alt + S. Как показано на рисунке 2, `SecurityTutorials` база данных пуста — он содержит ни одной таблицы, представлений и хранимых процедур.


[![SecurityTutorials базы данных в настоящее время пуст](creating-the-membership-schema-in-sql-server-vb/_static/image5.png)](creating-the-membership-schema-in-sql-server-vb/_static/image4.png)

**На рисунке 2**: `SecurityTutorials` базы данных в настоящее время пуст ([Просмотр полноразмерное изображение](creating-the-membership-schema-in-sql-server-vb/_static/image6.png))


## <a name="step-2-adding-thesqlmembershipproviderschema-to-the-database"></a>Шаг 2: Добавление`SqlMembershipProvider`схемы в базу данных

`SqlMembershipProvider` Требует определенный набор таблиц, представлений и хранимых процедур для установки в базу данных хранилища пользователя. Эти объекты необходимые базы данных могут быть добавлены с помощью [ `aspnet_regsql.exe` средство](https://msdn.microsoft.com/en-us/library/ms229862.aspx). Этот файл находится в `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\` папки.

> [!NOTE]
> `aspnet_regsql.exe` Средство предлагает функции командной строки и графического интерфейса пользователя. Графический интерфейс — более понятные и что будут рассмотрены в данном учебнике. Интерфейс командной строки используется при добавлении `SqlMembershipProvider` схему необходимо автоматизировать, например построения скрипты или автоматизированные сценарии тестирования.

`aspnet_regsql.exe` Средство используется для добавления или удаления *служб приложений ASP.NET* для указанной базы данных SQL Server. Службы приложения ASP.NET включают в себя схемы для `SqlMembershipProvider` и `SqlRoleProvider`, а также схем для поставщиков на основе SQL для других платформ ASP.NET 2.0. Требуется предоставить два бита данных `aspnet_regsql.exe` средство:

- Мы хотим для добавления или удаления службы приложений и
- Базу данных, из которой нужно добавить или удалить схему службы приложения

В запрос для базы данных для использования, `aspnet_regsql.exe` средство появляется запрос на указание имени сервера, база данных расположена на учетные данные безопасности для подключения к базе данных и имя базы данных. При использовании отличные от Express Edition из SQL Server, вы уже знаете эти сведения, как он содержит те же сведения, которые необходимо указать в строке соединения при работе с базой данных через веб-страницу ASP.NET. Определение имени сервера и базы данных, при использовании базы данных SQL Server 2005, экспресс-выпуск в `App_Data` , тем не менее, будет несколько сложнее.

В следующем разделе рассматриваются простой и понятный способ для указания имени сервера и базы данных для базы данных SQL Server 2005, экспресс-выпуск в `App_Data` папки. Если вы не используете SQL Server 2005 Express Edition теперь, можете пропустить Установка разделе приложения службы.

### <a name="determining-the-server-and-database-name-for-a-sql-server-2005-express-edition-database-in-theappdatafolder"></a>Определить имена сервера и базы данных для базы данных экспресс-выпуска SQL Server 2005 в`App_Data`папки

Чтобы использовать `aspnet_regsql.exe` средство, нам нужно знать имена сервера и базы данных. Имя сервера — `localhost\InstanceName`. Скорее всего, *InstanceName* — `SQLExpress`. Тем не менее при установке SQL Server 2005 Express Edition вручную (то есть, то он не был установлен автоматически при установке Visual Studio), возможно, что вы выбрали другое имя экземпляра.

Имя базы данных — чуть сложнее для определения. Базы данных в `App_Data` папки обычно имеют имя базы данных, которая включает [глобальный уникальный идентификатор](http://en.wikipedia.org/wiki/Globally_Unique_Identifier) с указанием пути к файлу базы данных. Нам нужно определить это имя базы данных, чтобы добавить схему службы приложения через `aspnet_regsql.exe`.

Чтобы выяснить имя базы данных проще всего проанализировать его с помощью SQL Server Management Studio. SQL Server Management Studio предоставляет графический интерфейс для управления базами данных SQL Server 2005, но она не поставляется с Express Edition SQL Server 2005. Хорошо то, что [можно загрузить](https://www.microsoft.com/downloads/details.aspx?FamilyId=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796&amp;displaylang=en) свободного Express Edition из SQL Server Management Studio.

> [!NOTE]
> При наличии экспресс-выпуск не - версию SQL Server 2005 установлен на рабочем столе скорее всего установить полную версию среды Management Studio. Можно использовать полную версию для определения имени базы данных, выполнив шаги, как показано ниже, для экспресс-выпуск.

Сначала необходимо закрыть Visual Studio, чтобы убедиться, что закрыты все блокировки, установленные Visual Studio в файле базы данных. Затем запустите SQL Server Management Studio и подключитесь к `localhost\InstanceName` базы данных для SQL Server 2005 Express Edition. Как отмечалось ранее, скорее всего, является имя экземпляра `SQLExpress`. Для параметра проверки подлинности выберите проверку подлинности Windows.


[![Подключитесь к экземпляру SQL Server 2005, экспресс-выпуск](creating-the-membership-schema-in-sql-server-vb/_static/image8.png)](creating-the-membership-schema-in-sql-server-vb/_static/image7.png)

**Рис. 3**: подключиться к экземпляру SQL Server 2005 Express Edition ([Просмотр полноразмерное изображение](creating-the-membership-schema-in-sql-server-vb/_static/image9.png))


После подключения к экземпляру SQL Server 2005, экспресс-выпуск среды Management Studio отображаются папки для базы данных, параметры безопасности, объекты сервера и т. д. Если развернуть вкладку базы данных вы увидите, что `SecurityTutorials.mdf` база данных находится в *не* зарегистрирован в экземпляре базы данных - нам нужно сначала присоединить базу данных.

Щелкните правой кнопкой мыши папку базы данных и выберите присоединение в контекстном меню. Откроется диалоговое окно Присоединение баз данных. Здесь, нажмите кнопку "Добавить", перейдите в `SecurityTutorials.mdf` базы данных и нажмите кнопку ОК. На рисунке 4 показаны в диалоговом окне Присоединение баз данных после `SecurityTutorials.mdf` выбрать базу данных. Рис. 5 показан в обозревателе объектов среды Management Studio после успешного присоединения базы данных.


[![Присоедините базу данных SecurityTutorials.mdf](creating-the-membership-schema-in-sql-server-vb/_static/image11.png)](creating-the-membership-schema-in-sql-server-vb/_static/image10.png)

**Рис. 4**: присоединение `SecurityTutorials.mdf` базы данных ([Просмотр полноразмерное изображение](creating-the-membership-schema-in-sql-server-vb/_static/image12.png))


[![SecurityTutorials.mdf базы данных появится в папке базы данных](creating-the-membership-schema-in-sql-server-vb/_static/image14.png)](creating-the-membership-schema-in-sql-server-vb/_static/image13.png)

**Рис. 5**: `SecurityTutorials.mdf` база данных появится в папке базы данных ([Просмотр полноразмерное изображение](creating-the-membership-schema-in-sql-server-vb/_static/image15.png))


Как показано на рисунке 5, `SecurityTutorials.mdf` базы данных имеет имя, а abstruse. Изменим легче запоминать (и проще для ввода) имя. Щелкните правой кнопкой мыши базу данных, выберите команду "Переименовать" в контекстном меню и переименуйте его `SecurityTutorialsDatabase`. Это не изменяет имя файла, только имя базы данных использует для собственной идентификации в SQL Server.


[![Переименовать базу данных для SecurityTutorialsDatabase](creating-the-membership-schema-in-sql-server-vb/_static/image17.png)](creating-the-membership-schema-in-sql-server-vb/_static/image16.png)

**Рис. 6**: переименовать базу данных для `SecurityTutorialsDatabase`([Просмотр полноразмерное изображение](creating-the-membership-schema-in-sql-server-vb/_static/image18.png))


На этом этапе мы знаем, имена сервера и базы данных для `SecurityTutorials.mdf` файла базы данных: `localhost\InstanceName` и `SecurityTutorialsDatabase`соответственно. Теперь все готово для установки служб приложений через `aspnet_regsql.exe` средства.

### <a name="installing-the-application-services"></a>Установка служб приложений

Чтобы запустить `aspnet_regsql.exe` средство, перейдите в меню «Пуск» и выберите команду выполнить. Введите `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\aspnet_regsql.exe` в текстовое поле и нажмите кнопку ОК. Кроме того, можно использовать проводник детализировать соответствующую папку и дважды щелкните `aspnet_regsql.exe` файла. Любой из этих подходов приводит к те же результаты.

Под управлением `aspnet_regsql.exe` средство без аргументов командной строки будет запущен мастер установки SQL Server ASP.NET графического интерфейса пользователя. Мастер позволяет легко добавлять и удалять службы приложения ASP.NET на указанной базе данных. Первый экран мастера, на рисунке 7 показано назначение средства.


[![Добавьте схемы членства с помощью установки мастер ASP.NET SQL Server делает](creating-the-membership-schema-in-sql-server-vb/_static/image20.png)](creating-the-membership-schema-in-sql-server-vb/_static/image19.png)

**Рис. 7**: используйте, чтобы добавить схему членства ASP.NET SQL Server программа установки мастер облегчает ([Просмотр полноразмерное изображение](creating-the-membership-schema-in-sql-server-vb/_static/image21.png))


Второй шаг мастера запрашивает ли мы хотим добавить служб приложений или удалить ее. Поскольку мы хотим добавить таблицы, представления и хранимые процедуры, необходимые для `SqlMembershipProvider`, выберите Настройка SQL Server для параметра службы приложения. Позже Если вы хотите удалить эту схему из базы данных, повторно запустите мастер, но вместо этого выбрать сведения о службах приложений удалить из существующего параметра базы данных.


[![Выберите настройки для параметра приложения служб SQL Server](creating-the-membership-schema-in-sql-server-vb/_static/image23.png)](creating-the-membership-schema-in-sql-server-vb/_static/image22.png)

**Рис. 8**: выберите Настройка SQL Server для параметра службы приложений ([Просмотр полноразмерное изображение](creating-the-membership-schema-in-sql-server-vb/_static/image24.png))


Третий шаг запрашивает сведения о базе данных: имя сервера, сведения о проверке подлинности и имя базы данных. Если действия вместе с учебником и добавили `SecurityTutorials.mdf` базы данных для `App_Data`, присоединении к `localhost\InstanceName`и переименован в `SecurityTutorialsDatabase`, затем используйте следующие значения:

- Сервер:`localhost\InstanceName`
- Аутентификация Windows
- База данных:`SecurityTutorialsDatabase`


[![Введите сведения о базе данных](creating-the-membership-schema-in-sql-server-vb/_static/image26.png)](creating-the-membership-schema-in-sql-server-vb/_static/image25.png)

**Рис. 9**: Введите сведения о базе данных ([Просмотр полноразмерное изображение](creating-the-membership-schema-in-sql-server-vb/_static/image27.png))


После ввода сведений о базе данных, нажмите кнопку "Далее". Последний шаг приведены шаги, которые будут выполнены. Для установки служб приложения и завершите работу мастера, нажмите кнопку "Далее".

> [!NOTE]
> Если вы использовали Management Studio для присоединения базы данных и переименуйте файл базы данных, нужно убедиться, что присоединение и отсоединение базы данных закройте среду Management Studio, прежде чем повторно открыть Visual Studio. Чтобы отсоединить `SecurityTutorialsDatabase` базы данных, щелкните правой кнопкой мыши имя базы данных и, в меню задач выберите отсоединения.

После завершения работы мастера вернитесь в Visual Studio и перейдите в обозревателе базы данных. Разверните папку «таблицы». Вы увидите ряд таблиц, имена которых начинаются с префикса `aspnet_`. Аналогично ряд представлений и хранимых процедур можно найти в папках, представления и хранимые процедуры. Эти объекты базы данных, составляющие схему службы приложения. Изучим объекты конкретных членства и ролей базы данных в шаге 3.


[![Широкий набор таблиц, представлений и хранимых процедур были добавлены в базу данных](creating-the-membership-schema-in-sql-server-vb/_static/image29.png)](creating-the-membership-schema-in-sql-server-vb/_static/image28.png)

**Рис. 10**: различные таблицы, представления и хранимые процедуры были добавлены в базу данных ([Просмотр полноразмерное изображение](creating-the-membership-schema-in-sql-server-vb/_static/image30.png))


> [!NOTE]
> `aspnet_regsql.exe` Графический пользовательский интерфейс средства устанавливает схему всего приложения службы. Но при выполнении `aspnet_regsql.exe` из командной строки можно указать, какие конкретного приложения служб компонентов для установки (или удаления). Таким образом, если требуется добавить только таблицы, представления и хранимых процедур, необходимых для `SqlMembershipProvider` и `SqlRoleProvider` поставщиков, запустите `aspnet_regsql.exe` из командной строки. Кроме того, вы можете вручную запустить соответствующий подмножество T-SQL создавать сценарии, используемые `aspnet_regsql.exe`. Эти сценарии расположены в `WINDIR%\Microsoft.Net\Framework\v2.0.50727\` папки с именами `InstallCommon.sql`, `InstallMembership.sql`, `InstallRoles.sql`, `InstallProfile.sql`, `InstallSqlState.sql`, и т. д.

На этом этапе мы создали объекты базы данных, необходимые для `SqlMembershipProvider`. Тем не менее, мы по-прежнему необходимо указать членства framework следует использовать `SqlMembershipProvider` (versus, скажем, `ActiveDirectoryMembershipProvider`) и что `SqlMembershipProvider` следует использовать `SecurityTutorials` базы данных. Мы рассмотрим способы указания поставщик, используемый и настройка параметров выбранного поставщика на шаге 4. Но сначала давайте более подробный обзор объектов базы данных, которые были только что создали.

## <a name="step-3-a-look-at-the-schemas-core-tables"></a>Шаг 3: Просмотрите схемы основных таблиц

При работе с платформами членства и ролей, в приложении ASP.NET, содержатся сведения о реализации поставщиком. В будущих учебниках мы будет взаимодействовать с этих платформ через .NET Framework `Membership` и `Roles` классы. При использовании этих API высокого уровня нам не нужно относятся сами низкоуровневые сведения, как выполняются запросы или были изменены какие таблицы `SqlMembershipProvider` и `SqlRoleProvider`.

Учитывая это, можно уверенно использовать платформы членства и ролей без анализировать схему базы данных, созданный на шаге 2. Тем не менее при создании таблицы для хранения данных приложения мы может потребоваться создать сущности, которые относятся к пользователям и ролям. Необходимо иметь навыки работы с `SqlMembershipProvider` и `SqlRoleProvider` схем при создании внешнего ключа ограничения между таблицами данных приложения и эти таблицы, созданный на шаге 2. Кроме того, в некоторых редких случаях может потребоваться взаимодействовать с пользователем и сохраняет роли на уровне базы данных (а не через `Membership` или `Roles` классы).

### <a name="partitioning-the-user-store-into-applications"></a>Секционирование в хранилище пользователя в приложения

Платформы членства и ролей разработаны таким образом, что единое хранилище пользователя и роли могут использоваться совместно в разных приложениях. Приложение ASP.NET, использующее платформы членства или ролей необходимо указать какой раздел приложения для использования. Иными словами несколько веб-приложений можно использовать одинаковые хранилища пользователя и роли. Рис. 11 показана хранилищ пользователя и роли, которые разделена на три приложения: HRSite, CustomerSite и SalesSite. Эти три веб-приложения каждого своих собственных уникальных пользователей и ролей, еще не все они физически хранить учетные данные учетной записи и роли в одной таблице базы данных.


[![Учетные записи пользователей, которые могут быть секционированы несколькими приложениями](creating-the-membership-schema-in-sql-server-vb/_static/image32.png)](creating-the-membership-schema-in-sql-server-vb/_static/image31.png)

**Рис. 11**: пользователь учетные записи могут быть секционированы по несколько приложений ([Просмотр полноразмерное изображение](creating-the-membership-schema-in-sql-server-vb/_static/image33.png))


`aspnet_Applications` Таблица является то, что определяет эти секции. Каждое приложение, использующее базу данных для хранения учетных записей пользователей будет представлен строки в этой таблице. `aspnet_Applications` Таблица содержит четыре столбца: `ApplicationId`, `ApplicationName`, `LoweredApplicationName`, и `Description`.`ApplicationId` относится к типу [ `uniqueidentifier` ](https://msdn.microsoft.com/en-us/library/ms187942.aspx) и является первичным ключом таблицы; `ApplicationName` предоставляет уникальное имя понятную для каждого приложения.

Другие таблицы, связанные с членство и роли обратной ссылки на `ApplicationId` в `aspnet_Applications`. Например `aspnet_Users` имеет таблицу, которая содержит запись для каждой учетной записи пользователя, `ApplicationId` поле внешнего ключа, то же относится и `aspnet_Roles` таблицы. `ApplicationId` Поля в этих таблицах указывает раздел приложения учетной записи пользователя или роль.

### <a name="storing-user-account-information"></a>Хранение учетных записей пользователей

Учетная запись пользователя, размещенное в две таблицы: `aspnet_Users` и `aspnet_Membership`. `aspnet_Users` Таблица содержит поля, которые содержат необходимые учетные данные. Существуют три наиболее важные столбцы.

- `UserId`
- `UserName`
- `ApplicationId`

`UserId`является первичным ключом (и типа `uniqueidentifier`). `UserName`относится к типу `nvarchar(256)` и наряду с паролем, составляющих учетные данные пользователя. (Пароль хранится в `aspnet_Membership` таблицы.) `ApplicationId` связывает учетной записи пользователя для конкретного приложения в `aspnet_Applications`. Нет составного [ `UNIQUE` ограничение](https://msdn.microsoft.com/en-us/library/ms191166.aspx) на `UserName` и `ApplicationId` столбцов. Это гарантирует, что определенного приложения каждое имя пользователя является уникальным, но он позволяет одним и тем же `UserName` для использования в разных приложениях.

`aspnet_Membership` Таблица содержит дополнительные сведения, такие как пароль пользователя, адрес электронной почты, последнего входа даты и времени и т. д. Имеется взаимно-однозначное соответствие между записями в `aspnet_Users` и `aspnet_Membership` таблицы. Это отношение гарантируется `UserId` в `aspnet_Membership`, который используется в качестве первичного ключа таблицы. Как `aspnet_Users` таблицы, `aspnet_Membership` включает `ApplicationId` поле, которое связывает эту информацию для определенного раздела приложений.

### <a name="securing-passwords"></a>Защита паролей

Пароль хранится в `aspnet_Membership` таблицы. `SqlMembershipProvider` Позволяет пароли должны храниться в базе данных с помощью одного из следующих трех способов:

- **Очистить** -пароль хранится в базе данных как обычный текст. Я настоятельно не рекомендуется создавать с помощью этого параметра. В случае компрометации базы данных — будь то злоумышленник, который находит черным или недовольные сотрудников, которые имеют доступ к базе данных - учетные данные каждого пользователя имеют ли переход.
- **На основании хэша** -пароли хэшируются с помощью одностороннего алгоритма хеширования и произвольно создаваемого случайного значения. Это хэшированное значение (вместе с соли) хранится в базе данных.
- **Шифрование** -зашифрованную версию пароля хранится в базе данных.

Пароль хранилища методика зависит от `SqlMembershipProvider` , заданные в `Web.config`. Мы рассмотрим Настройка `SqlMembershipProvider` параметров на шаге 4. Поведение по умолчанию не хранить хэш пароля.

Столбцы, ответственный за хранение пароля, `Password`, `PasswordFormat`, и `PasswordSalt`. `PasswordFormat`поле типа `int` , значение которого указывает метод, используемый для хранения пароля: 0 для очистки; 1 для Hashed; 2; для шифрования. `PasswordSalt`назначенный случайным строки независимо от того, пароль хранилища методика; значение `PasswordSalt` используется только при вычислении хэш пароля. Наконец `Password` столбец содержит данные фактический пароль, будь то обычный текст пароля, хэш пароля или зашифрованный пароль.

Таблица 1 демонстрирует, как эти три столбца будет выглядеть для различных методов хранения при сохранении пароля MySecret! .

| **Метод хранения&lt;\_o3a\_p /&gt;** | **Пароль&lt;\_o3a\_p /&gt;** | **PasswordFormat&lt;\_o3a\_p /&gt;** | **PasswordSalt&lt;\_o3a\_p /&gt;** |
| --- | --- | --- | --- |
| Clear | MySecret! | 0 | tTnkPlesqissc2y2SMEygA == |
| На основании хэша | 2oXm6sZHWbTHFgjgkGQsc2Ec9ZM = | 1 | wFgjUfhdUFOCKQiI61vtiQ == |
| Шифрование | 62RZgDvhxykkqsMchZ0Yly7HS6onhpaoCYaRxV8g0F4CW56OXUU3e7Inza9j9BKp | 2 | LSRzhGS, aa-oqAXGLHJNBw == |

**Таблица 1**: примеры значений для полей с паролями, при сохранении пароля MySecret!

> [!NOTE]
> Определенный шифрования и алгоритм хеширования, используемый `SqlMembershipProvider` , определяется параметрами в `<machineKey>` элемент. Мы рассмотрели данного элемента конфигурации на шаге 3 <a id="Tutorial3"> </a> [ *настройки проверки подлинности форм и дополнительные разделы* ](../introduction/forms-authentication-configuration-and-advanced-topics-vb.md) учебника.

### <a name="storing-roles-and-role-associations"></a>Сохранение ролей и роль взаимосвязи

Роли framework разработчики могут определить набор ролей и указать, какие пользователи принадлежать к роли. Эти сведения сохраняются в базе данных с помощью двух таблиц: `aspnet_Roles` и `aspnet_UsersInRoles`. Каждая запись в `aspnet_Roles` таблице представляет роль для конкретного приложения. Как `aspnet_Users` таблицы, `aspnet_Roles` таблица содержит три столбца, которые имеют отношение к нашей обсуждений:

- `RoleId`
- `RoleName`
- `ApplicationId`

`RoleId`является первичным ключом (и типа `uniqueidentifier`). `RoleName` имеет тип `nvarchar(256)`. И `ApplicationId` связывает учетной записи пользователя для конкретного приложения в `aspnet_Applications`. Нет составного `UNIQUE` ограничения на `RoleName` и `ApplicationId` столбцы, обеспечивая определенного приложения каждое имя роли уникальное.

`aspnet_UsersInRoles` Таблица служит сопоставление пользователей и ролей. Существует только два столбца - `UserId` и `RoleId` - а вместе они образуют составной первичный ключ.

## <a name="step-4-specifying-the-provider-and-customizing-its-settings"></a>Шаг 4: Указание поставщика и настройка его параметров

Все платформы, поддерживающие модель поставщика — например платформ членства и ролей - отсутствуют сведения о реализации сами и вместо этого делегировать ответственность на класс поставщика. В случае платформа членства `Membership` класс определяет API управления учетными записями пользователей, но не взаимодействует непосредственно с любого хранилища пользователя. Вместо этого `Membership` передачи методы класса запроса на настроенный поставщик - мы будем использовать `SqlMembershipProvider`. Когда мы вызвать один из методов в `Membership` класса, как платформа членства узнает, делегировать вызов `SqlMembershipProvider`?

`Membership` Класс имеет [ `Providers` свойство](https://msdn.microsoft.com/en-us/library/system.web.security.membership.providers.aspx) , содержащий ссылку на все классы зарегистрированного поставщика, доступный для использования платформой членства. Каждый зарегистрированный поставщик имеет соответствующее имя и тип. Имя предоставляет понятную возможность ссылаться определенного поставщика в `Providers` коллекции, а тип идентифицирует класс поставщика. Кроме того каждый зарегистрированный поставщик может включать параметры конфигурации. Параметры конфигурации для платформы членства — `PasswordFormat` и `requiresUniqueEmail`, многие другие. См. Полный список параметров конфигурации, используемые в таблице 2 `SqlMembershipProvider`.

`Providers` Содержимое свойства указываются с помощью параметров конфигурации веб-приложения. По умолчанию все веб-приложения имеют поставщик с именем `AspNetSqlMembershipProvider` типа `SqlMembershipProvider`. Этот поставщик членства по умолчанию регистрируется в `machine.config` (расположенный в `%WINDIR%\Microsoft.Net\Framework\v2.0.50727\CONFIG`):

[!code-xml[Main](creating-the-membership-schema-in-sql-server-vb/samples/sample1.xml)]

Как разметка выше [ `<membership>` элемент](https://msdn.microsoft.com/en-us/library/1b9hw62f.aspx) определяет параметры конфигурации для платформы членства при [ `<providers>` дочерний элемент](https://msdn.microsoft.com/en-us/library/6d4936ht.aspx) указывает зарегистрированный Поставщики. Поставщики могут быть добавлены или удалены с помощью [ `<add>` ](https://msdn.microsoft.com/en-us/library/whae3t94.aspx) или [ `<remove>` ](https://msdn.microsoft.com/en-us/library/aykw9a6d.aspx) элементов; используйте [ `<clear>` ](https://msdn.microsoft.com/en-us/library/t062y6yc.aspx) элемента для удаления всех в настоящее время зарегистрированных поставщиков. Как разметка выше `machine.config` добавляет поставщик с именем `AspNetSqlMembershipProvider` типа `SqlMembershipProvider`.

В дополнение к `name` и `type` атрибуты, `<add>` элемент содержит атрибуты, определяющие значения для различных настройку параметров. В таблице 2 содержится список имеющихся `SqlMembershipProvider`-определенные параметры конфигурации, а также описание каждого из них.

> [!NOTE]
> Любые значения по умолчанию, указанных в таблице 2 см. значения по умолчанию, определенные в `SqlMembershipProvider` класса. Обратите внимание, что не все параметры конфигурации в `AspNetSqlMembershipProvider` соответствуют значениям по умолчанию `SqlMembershipProvider` класса. Например, если не указан в поставщике членства `requiresUniqueEmail` задание значения по умолчанию true. Тем не менее `AspNetSqlMembershipProvider` переопределит это значение по умолчанию, явно указав значение `false`.

| **Установка&lt;\_o3a\_p /&gt;** | **Описание&lt;\_o3a\_p /&gt;** |
| --- | --- |
| `ApplicationName` | Напомним, что позволяет framework членства для одного пользователя хранилища, чтобы быть разделено между несколькими приложениями. Этот параметр указывает имя секции приложения, используемые поставщиком членства. Если это значение не указано явным образом, он установлен, во время выполнения, равным пути виртуального корневого каталога приложения. |
| `commandTimeout` | Указывает значение времени ожидания команды SQL (в секундах). Значение по умолчанию — 30. |
| `connectionStringName` | Имя строки подключения в `<connectionStrings>` элемента, который требуется использовать для подключения к базе данных хранилища пользователя. Это значение является обязательным. |
| `description` | Содержит описание понятную зарегистрированный поставщик. |
| `enablePasswordRetrieval` | Указывает, могут ли пользователи получить их забытый пароль. Значение по умолчанию — `false`. |
| `enablePasswordReset` | Указывает, разрешено ли пользователям сброс пароля. По умолчанию — `true`. |
| `maxInvalidPasswordAttempts` | Максимальное число попыток неудачной попытки входа, которые могут возникнуть для данного пользователя в определенное `passwordAttemptWindow` пользователь блокируется. Значение по умолчанию — 5. |
| `minRequiredNonalphanumericCharacters` | Минимальное число не буквенно-цифровые символы, которые должны находиться в пароль. Это значение должно быть в диапазоне от 0 до 128. значение по умолчанию — 1. |
| `minRequiredPasswordLength` | Минимальное количество символов, требуемых в пароле. Это значение должно быть в диапазоне от 0 до 128. значение по умолчанию — 7. |
| `name` | Имя зарегистрированного поставщика. Это значение является обязательным. |
| `passwordAttemptWindow` | Количество минут в течение которого не отслеживаются попыток входа. Если пользователь предоставляет учетные данные для входа недопустимый `maxInvalidPasswordAttempts` указано время в данном окне, они будут заблокированы. Значение по умолчанию — 10. |
| `PasswordFormat` | Формат хранения паролей: `Clear`, `Hashed`, или `Encrypted`. Значение по умолчанию — `Hashed`. |
| `passwordStrengthRegularExpression` | Если указано, это регулярное выражение используется для оценки стойкость пароля выбранного пользователя, при создании новой учетной записи или при изменении пароля. Значение по умолчанию - пустая строка. |
| `requiresQuestionAndAnswer` | Указывает, является ли пользователь должен ответить на свой вопрос безопасности при извлечении или сбросе пароля. Значение по умолчанию — `true`. |
| `requiresUniqueEmail` | Указывает, является ли все учетные записи пользователей в разделе данного приложения должен иметь уникальный почтовый адрес. Значение по умолчанию — `true`. |
| `type` | Указывает тип поставщика. Это значение является обязательным. |

**В таблице 2**: членства и `SqlMembershipProvider` параметры конфигурации

В дополнение к `AspNetSqlMembershipProvider`, другие поставщики членства могут быть зарегистрированы для отдельных приложений по путем добавления аналогичные разметку для `Web.config` файла.

> [!NOTE]
> Платформа ролей работает во многом так же, как: нет зарегистрированных роли поставщика по умолчанию в `machine.config` и зарегистрированных поставщиков можно настроить для отдельных приложений по в `Web.config`. Изучим framework ролей и его конфигурации разметки подробно в будущем учебника.

### <a name="customizing-thesqlmembershipprovidersettings"></a>Настройка`SqlMembershipProvider`параметров

Значение по умолчанию `SqlMembershipProvider` (`AspNetSqlMembershipProvider`) имеет его `connectionStringName` атрибуту присвоено значение `LocalSqlServer`. Как `AspNetSqlMembershipProvider` поставщика, имя строки подключения `LocalSqlServer` определяется в `machine.config`.

[!code-xml[Main](creating-the-membership-schema-in-sql-server-vb/samples/sample2.xml)]

Как видите, эта строка подключения определяет базу данных, расположенную в SQL 2005 Express Edition | DataDirectory|aspnetdb.mdf. Строка | DataDirectory | преобразуется во время выполнения, чтобы она указывала на `~/App_Data/` каталога, поэтому путь к базе данных | DataDirectory|aspnetdb.mdf может достигать `~/App_Data` / `aspnet.mdf`.

Если не был указан поставщик информацию о членстве в нашем приложении `Web.config` файл, приложение использует поставщик членства по умолчанию зарегистрированные `AspNetSqlMembershipProvider`. Если `~/App_Data/aspnet.mdf` базы данных не существует, среда выполнения ASP.NET будет автоматически создать его и добавить схему службы приложения. Тем не менее, мы не хотим использовать `aspnet.mdf` в базе данных; вместо этого мы хотим использовать `SecurityTutorials.mdf` базы данных, созданную на шаге 2. Это изменение можно одним из двух способов:

- **Укажите значение для ***`LocalSqlServer`*** имя строки подключения в ***`Web.config`***.** Путем перезаписи `LocalSqlServer` значение имя строки подключения в `Web.config`, можно использовать поставщика членства по умолчанию зарегистрированные (`AspNetSqlMembershipProvider`) и его правильной работы с `SecurityTutorials.mdf` базы данных. Этот подход подходит при наличии содержимого с указанными параметрами конфигурации по `AspNetSqlMembershipProvider`. Дополнительные сведения об этом приеме см. в разделе [Скотт Гатри](https://weblogs.asp.net/scottgu/)в записи блога [Настройка ASP.NET 2.0 служб приложений для использования SQL Server 2000 или SQL Server 2005](https://weblogs.asp.net/scottgu/archive/2005/08/25/423703.aspx).
- **Добавить новый зарегистрированный поставщик типа ***`SqlMembershipProvider`*** и настройте его ***`connectionStringName`*** параметр, чтобы она указывала на ***`SecurityTutorials.mdf`*** базы данных.** Этот подход полезен в сценариях, где вы хотите настроить другие свойства конфигурации, в дополнение к строке подключения базы данных. В собственных проектах я всегда использую этот подход из-за его гибкости и удобства чтения.

Перед добавлением нового зарегистрированного поставщика, который ссылается на `SecurityTutorials.mdf` базы данных, необходимо сначала добавить строковое значение соответствующее соединение в `<connectionStrings>` раздела `Web.config`. Приведенный ниже код добавляет новую строку подключения с именем `SecurityTutorialsConnectionString` , ссылается на SQL Server 2005 Express Edition `SecurityTutorials.mdf` базы данных в `App_Data` папки.

[!code-xml[Main](creating-the-membership-schema-in-sql-server-vb/samples/sample3.xml)]

> [!NOTE]
> Если используется альтернативный файл базы данных, при необходимости обновите строки подключения. Дополнительные сведения о формирование правильную строку подключения, см. [ConnectionStrings.com](http://www.connectionstrings.com/).

Добавьте следующую разметку конфигурации членства для `Web.config` файла. Эта разметка регистрирует нового поставщика с именем `SecurityTutorialsSqlMembershipProvider`.

[!code-xml[Main](creating-the-membership-schema-in-sql-server-vb/samples/sample4.xml)]

Помимо регистрации `SecurityTutorialsSqlMembershipProvider` выше разметка определяет поставщика, `SecurityTutorialsSqlMembershipProvider` как поставщик по умолчанию (через `defaultProvider` атрибута в `<membership>` элемент). Помните, что платформа членства может иметь несколько зарегистрированных поставщиков. Поскольку `AspNetSqlMembershipProvider` регистрируется как первый поставщик в `machine.config`, он служит в качестве поставщика по умолчанию, если не указывается, в противном случае.

В настоящее время наше приложение имеет два зарегистрированных поставщиков: `AspNetSqlMembershipProvider` и `SecurityTutorialsSqlMembershipProvider`. Тем не менее, перед регистрацией `SecurityTutorialsSqlMembershipProvider` поставщика нам удалось очистки всех ранее зарегистрированных поставщиков, добавив [ `<clear />` элемент](https://msdn.microsoft.com/en-us/library/t062y6yc.aspx) непосредственно перед нашей `<add>` элемента. Это будет очистить `AspNetSqlMembershipProvider` из списка зарегистрированных поставщиков, это значит, что `SecurityTutorialsSqlMembershipProvider` бы только зарегистрированного поставщика членства. Если мы использовали этот подход, то мы не нужно пометить `SecurityTutorialsSqlMembershipProvider` поставщика по умолчанию, так как было бы только зарегистрированного поставщика членства. Дополнительные сведения об использовании `<clear />`, в разделе [использование `<clear />` при добавлении поставщиков](https://weblogs.asp.net/scottgu/archive/2006/11/20/common-gotcha-don-t-forget-to-clear-when-adding-providers.aspx).

Обратите внимание, что `SecurityTutorialsSqlMembershipProvider` `connectionStringName` задание ссылки на только что добавленные `SecurityTutorialsConnectionString` имя строки подключения и что его `applicationName` параметру было присвоено значение SecurityTutorials. Кроме того `requiresUniqueEmail` параметру было присвоено `true`. Все прочие параметры конфигурации совпадают со значениями в `AspNetSqlMembershipProvider`. Вы можете сделать, любые изменения конфигурации, при необходимости. Например это сделать стойкость пароля, требуя два неалфавитных символов вместо одного или увеличив длину пароля до восьми символов, а не семь.

> [!NOTE]
> Напомним, что позволяет framework членства для одного пользователя хранилища, чтобы быть разделено между несколькими приложениями. Поставщик членства `applicationName` параметр указывает, какое приложение использует поставщик при работе с хранилищем пользователя. Очень важно, явно задать значение для `applicationName` значение параметра конфигурации, поскольку если `applicationName` не заданы явным образом, он не будет назначен путь виртуального корневого каталога веб-приложения во время выполнения. Это работает отлично, при условии, что пути виртуального корневого каталога приложения не меняется, но если перевести приложение в другой путь `applicationName` параметр слишком изменится. В этом случае поставщик членства начнет работать с разделом другого приложения, не использовалось ранее. Учетные записи пользователей, созданные до перемещения будет находиться в секцию другого приложения, и эти пользователи больше не смогут Войдите на сайт. Подробное обсуждение по данному вопросу см. в разделе [всегда задается `applicationName` свойства при настройке 2.0 членства ASP.NET и другие поставщики](https://weblogs.asp.net/scottgu/443634).

## <a name="summary"></a>Сводка

На этом этапе у нас есть базы данных с помощью служб настроенное приложение (`SecurityTutorials.mdf`) и в наших веб-приложения настроены, чтобы платформа членства использует `SecurityTutorialsSqlMembershipProvider` вновь зарегистрированного поставщика. Это зарегистрированного поставщика имеет тип `SqlMembershipProvider` и имеет его `connectionStringName` задана строка подключения (`SecurityTutorialsConnectionString`) и его `applicationName` явно не задано значение.

Теперь мы готовы к использованию framework членство из нашего приложения. В следующем уроке мы рассмотрим, как создание новых учетных записей пользователей. После того, что мы изучим, проверка подлинности пользователей, выполнения авторизации на основе пользователей и сохраняя дополнительную информацию, связанный с пользователем в базе данных.

Программирование довольны!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, рассматриваемые в этом учебнике см. в следующих ресурсах:

- [Всегда значение `applicationName` свойства при настройке 2.0 членства ASP.NET и других поставщиков](https://weblogs.asp.net/scottgu/443634)
- [Настройка ASP.NET 2.0 служб приложений для использования SQL Server 2000 или SQL Server 2005](https://weblogs.asp.net/scottgu/archive/2005/08/25/423703.aspx)
- [Загрузите SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?FamilyId=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796&amp;displaylang=en)
- [Изучение ASP.NET 2.0 s членства, ролей и профиля](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [`<add>` Элемент для поставщиков для членства](https://msdn.microsoft.com/en-us/library/whae3t94.aspx)
- [`<membership>` Элемент](https://msdn.microsoft.com/en-us/library/1b9hw62f.aspx)
- [`<providers>` Элемент для членства](https://msdn.microsoft.com/en-us/library/6d4936ht.aspx)
- [С помощью `<clear />` при добавлении поставщиков](https://weblogs.asp.net/scottgu/archive/2006/11/20/common-gotcha-don-t-forget-to-clear-when-adding-providers.aspx)
- [Непосредственная работа с`SqlMembershipProvider`](http://aspnet.4guysfromrolla.com/articles/091207-1.aspx)

### <a name="video-training-on-topics-contained-in-this-tutorial"></a>Видео на разделы, содержащиеся в этом учебнике

- [Основные сведения о членства ASP.NET](../../../videos/authentication/understanding-aspnet-memberships.md)
- [Настройка SQL для работы со схемами членства](../../../videos/authentication/configuring-sql-to-work-with-membership-schemas.md)
- [Изменение настроек членства в схеме членства по умолчанию](../../../videos/authentication/changing-membership-settings-in-the-default-membership-schema.md)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких ASP/ASP.NET и основатель 4GuysFromRolla.com, работает с веб-технологиями Майкрософт с 1998 года. Скотт — независимый консультант, trainer и записи. Его последняя книга —  *[диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скотт может быть достигнута по [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по [http://ScottOnWriting.NET](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Благодарности

Этот учебник ряд прошел проверку многие полезные рецензентов. Основной рецензент этого учебника было Alicja Maziarz. Объясняются моих последующих статей для MSDN? Если Да, напишите мне по [ mitchell@4GuysFromRolla.com ](mailto:mitchell@4GuysFromRolla.com).

>[!div class="step-by-step"]
[Назад](storing-additional-user-information-cs.md)
[Вперед](creating-user-accounts-vb.md)

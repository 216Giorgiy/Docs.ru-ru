---
uid: web-forms/overview/older-versions-security/roles/assigning-roles-to-users-vb
title: "Назначение ролей для пользователей (VB) | Документы Microsoft"
author: rick-anderson
description: "В этом учебнике мы построим двух страницах ASP.NET, облегчающие управление которыми пользователи принадлежат роли. Первая страница будет включать средства, чтобы увидеть, что..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/24/2008
ms.topic: article
ms.assetid: fd208ee9-69cc-4467-9783-b4e039bdd1d3
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-security/roles/assigning-roles-to-users-vb
msc.type: authoredcontent
ms.openlocfilehash: c790f5f9b486b6598955459827c07ec9ad33ae38
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/24/2018
---
<a name="assigning-roles-to-users-vb"></a>Назначение ролей для пользователей (Visual Basic)
====================
по [Скотт Митчелл](https://twitter.com/ScottOnWriting)

[Загрузить код](http://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/VB.10.zip) или [скачать PDF](http://download.microsoft.com/download/6/0/3/6032582f-360d-4739-b935-38721fdb86ea/aspnet_tutorial10_AssigningRoles_vb.pdf)

> В этом учебнике мы построим двух страницах ASP.NET, облегчающие управление которыми пользователи принадлежат роли. Первая страница будет содержать средства, чтобы увидеть, какие пользователи принадлежат данной роли, определенный пользователь принадлежит к роли и возможность назначить или удалить пользователя из определенной роли. На второй странице мы дополнять управления CreateUserWizard таким образом, чтобы он включал шаг указывать только что созданный пользователь принадлежит к роли. Это полезно в сценариях, где администратор может создавать новые учетные записи пользователей.


## <a name="introduction"></a>Вступление

<a id="_msoanchor_1"> </a> [С предыдущим учебником](creating-and-managing-roles-vb.md) проверить framework ролей и `SqlRoleProvider`; мы узнали, как использовать `Roles` класса для создания, извлечения и удаления ролей. Помимо создания и удаления ролей, необходимо иметь возможность назначать или удалять пользователей из роли. К сожалению ASP.NET не поставляется с любой веб-элементы управления для управления которыми пользователи принадлежат роли. Вместо этого необходимо создать собственную страниц ASP.NET для управления этих связей. Хорошо то, что добавление и удаление пользователей к ролям довольно просто. `Roles` Класс содержит ряд методов для добавления одного или нескольких пользователей в одну или несколько ролей.

В этом учебнике мы построим двух страницах ASP.NET, облегчающие управление которыми пользователи принадлежат роли. Первая страница будет содержать средства, чтобы увидеть, какие пользователи принадлежат данной роли, определенный пользователь принадлежит к роли и возможность назначить или удалить пользователя из определенной роли. На второй странице мы дополнять управления CreateUserWizard таким образом, чтобы он включал шаг указывать только что созданный пользователь принадлежит к роли. Это полезно в сценариях, где администратор может создавать новые учетные записи пользователей.

Давайте начнем!

## <a name="listing-what-users-belong-to-what-roles"></a>Перечисление какие пользователи принадлежат какие роли

Первым делом в этом учебнике заключается в создании веб-страницы, из которого пользователи могут назначаться ролям. Перед сами относятся с тем, как назначать пользователей ролям, давайте сначала сосредоточиться на том, как определить, какие пользователи принадлежат роли. Существует два способа для отображения сведений: «роли» или «пользователь». Мы делает возможным посетитель выберите роль, а затем отобразить их всех пользователей, которые принадлежат роли («по роли» отображение) или мы может выдать запрос посетитель выберите пользователя и отобразить их роли, назначенные этому пользователю («пользователем» отображение).

Представление «по роли» удобна, когда посетитель хочет знать, группы пользователей, принадлежащих к определенной роли; представление «пользователем» идеально подходит для посетителя, должно быть известно роли конкретного пользователя. Установим нашу страницу включения «пользователем» и «по роли» интерфейсов.

Начнем с создания интерфейса «пользователем». Этот интерфейс будет состоять из раскрывающегося списка и список флажков. Раскрывающегося списка будет заполняться набор пользователей в системе; флажки будут указаны роли. При выборе пользователя в раскрывающемся списке будет проверять эти роли, к которой принадлежит пользователь. Лицо, посетив страницу можно затем установите или снимите флажки, чтобы добавить или удалить выбранного пользователя из соответствующих ролей.

> [!NOTE]
> С помощью раскрывающегося списка в список учетных записей пользователей не является идеальным выбором для веб-сайтов, где могут существовать сотни учетных записей пользователей. Раскрывающегося списка позволяет пользователю выбрать один элемент из короткое списка параметров. Быстро становится громоздким по мере роста число элементов списка. При создании веб-сайт, будет иметь потенциально большое число учетных записей пользователей, можно рассмотреть возможность использования альтернативный пользовательский интерфейс, например выгружаемой GridView или которые можно использовать интерфейс, который перечисляет запросы на ввод посетитель выберите букву а затем только Показывает, этих пользователей, имена которых начинается с указанной буквы.


## <a name="step-1-building-the-by-user-user-interface"></a>Шаг 1: Создание пользовательского интерфейса «Пользователем»

Откройте `UsersAndRoles.aspx` страницы. В верхней части страницы, добавьте метки веб-элемент управления с именем `ActionStatus` и очистить его `Text` свойство. Мы будем использовать эту метку, чтобы отправить отзыв о действиях, выполненных, отображая сообщения вроде, «Tito пользователь был добавлен к роли администраторов» или «Цзисунь пользователь был удален из роли руководителями.» Для выполнения этих сообщений выделялись задать метки `CssClass` свойства «Важно!».

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample1.aspx)]

Добавьте следующее определение класса CSS для `Styles.css` таблицы стилей:

[!code-css[Main](assigning-roles-to-users-vb/samples/sample2.css)]

Это определение CSS указывает, что браузер, чтобы отобразить метку больших, красным шрифтом. Рисунок 1 демонстрирует этот эффект в конструкторе Visual Studio.


[![Свойство метки CssClass приводит к большой красный шрифт](assigning-roles-to-users-vb/_static/image2.png)](assigning-roles-to-users-vb/_static/image1.png)

**Рис. 1**: метка `CssClass` результаты свойства в большой, а красный цвет шрифта ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image3.png))


Затем добавьте DropDownList страницу, задайте его `ID` свойства `UserList`и задайте его `AutoPostBack` значение True. Мы будем использовать этот элемент DropDownList для перечисления всех пользователей в системе. Этот элемент DropDownList будет привязан к коллекции объектов MembershipUser. Поскольку мы хотим DropDownList для отображения Свойство UserName объекта MembershipUser (и используется в качестве значения элементов списка), задать DropDownList `DataTextField` и `DataValueField` свойства «Username».

Под DropDownList, добавьте повторитель с именем `UsersRoleList`. Это повторителя будут отображаться все роли в системе как ряд флажки. Определение повторителя `ItemTemplate` с помощью декларативной следующую разметку:

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample3.aspx)]

`ItemTemplate` Разметка включает в себя один флажок веб-элемент управления с именем `RoleCheckBox`. Этот флажок `AutoPostBack` свойство имеет значение True и `Text` привязано свойство `Container.DataItem`. Причина синтаксис привязки данных — просто `Container.DataItem` — так как платформа ролей возвращает список имен ролей в виде строкового массива, а этот массив строк, будет осуществляться привязка к повторителя. Полное описание того, почему этот синтаксис используется для отображения содержимого массива, привязанный к веб-управления выходит за рамки данного руководства. Дополнительные сведения по данному вопросу посвящены [привязка к веб-элементе управления данных массива скаляр](http://aspnet.4guysfromrolla.com/articles/082504-1.aspx).

На этом этапе вашей «пользователем» интерфейса должна выглядеть следующим образом:

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample4.aspx)]

Теперь готовы написать код, чтобы связать набор учетных записей пользователей в DropDownList и набор ролей для повторителя. В странице кода класса, добавьте метод с именем `BindUsersToUserList` и другое свойство с именем `BindRolesList`, используя следующий код:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample5.vb)]

`BindUsersToUserList` Метод извлекает все учетные записи пользователей в системе через [ `Membership.GetAllUsers` метод](https://msdn.microsoft.com/library/dy8swhya.aspx). Возвращает [ `MembershipUserCollection` объекта](https://msdn.microsoft.com/library/system.web.security.membershipusercollection.aspx), которое является коллекцией из [ `MembershipUser` экземпляры](https://msdn.microsoft.com/library/system.web.security.membershipuser.aspx). Затем эта коллекция привязывается к `UserList` DropDownList. `MembershipUser` Экземпляров этого состава коллекции содержат различные свойства, такие как `UserName`, `Email`, `CreationDate`, и `IsOnline`. Чтобы дать указание DropDownList для отображения значения `UserName` свойства, убедитесь, что `UserList` DropDownList `DataTextField` и `DataValueField` заданы свойства «Username».

> [!NOTE]
> `Membership.GetAllUsers` Метод имеет две перегрузки: та, которая не принимает входные параметры и возвращает всех пользователей и второй, принимает целочисленные значения для индекса страницы и размера страницы и возвращает только определенное подмножество пользователей. При наличии больших объемов учетные записи пользователей, отображаемых в элементе выгружаемой пользовательского интерфейса, вторую перегрузку может использоваться более эффективно страницу, то пользователи, так как он возвращает только нужного подмножества учетные записи пользователей, а не все из них.


`BindRolesToList` Метода начинается с вызова `Roles` класса [ `GetAllRoles` метод](https://msdn.microsoft.com/library/system.web.security.roles.getallroles.aspx), который возвращает массив строк, содержащий роли в системе. Этот массив строк, затем привязывается к повторителя.

Наконец мы должны вызывать эти два метода, при первой загрузке страницы. Добавьте следующий код в обработчик событий `Page_Load`.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample6.vb)]

Этот код в месте занять некоторое время, чтобы перейти на страницу с помощью браузера; экран должен выглядеть как на рис. Учетные записи пользователей будут заполнены все в раскрывающемся списке и под ней областью, каждая роль отображается как флажок. Так как мы устанавливаем `AutoPostBack` свойства DropDownList и CheckBoxes значение True, Изменение выбранного пользователя или устанавливая или снимая роль вызывает обратную передачу. Никакие действия не выполняются, тем не менее, поскольку у нас есть еще писать код для обработки этих действий. Мы исследуем в этом выпуске этих задач в следующих двух разделах.


[![На странице отображаются пользователи и роли](assigning-roles-to-users-vb/_static/image5.png)](assigning-roles-to-users-vb/_static/image4.png)

**На рисунке 2**: на странице отображаются пользователи и роли ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image6.png))


### <a name="checking-the-roles-the-selected-user-belongs-to"></a>Проверка роли выбранному пользователю принадлежит

При первой загрузке страницы или всякий раз, когда пользователь выбирает нового пользователя из раскрывающегося списка, необходимо обновить `UsersRoleList`флажки, чтобы флажок конкретной роли установлен только в том случае, если выбранный пользователь принадлежит к этой роли. Чтобы сделать это, создайте метод с именем `CheckRolesForSelectedUser` следующим кодом:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample7.vb)]

Приведенный выше код начинается с определения выбранного пользователя. Затем он использует класс ролей [ `GetRolesForUser(userName)` метод](https://msdn.microsoft.com/library/system.web.security.roles.getrolesforuser.aspx) для возврата набора указанного пользователя из роли в виде строкового массива. После этого выполняется перечисление элементов повторителя и каждый элемент `RoleCheckBox` флажок упоминается программными средствами. Этот флажок установлен только в том случае, если он соответствует роли, содержащихся в `selectedUsersRoles` массив строк.

> [!NOTE]
> `Linq.Enumerable.Contains(Of String)(...)` Синтаксис не будет компилироваться при использовании ASP.NET версии 2.0. `Contains(Of String)` Метод является частью [LINQ библиотеки](http://en.wikipedia.org/wiki/Language_Integrated_Query), которое является новым для ASP.NET 3.5. Если по-прежнему используется ASP.NET версии 2.0, используйте [ `Array.IndexOf(Of String)` метод](https://msdn.microsoft.com/library/eha9t187.aspx) вместо него.


`CheckRolesForSelectedUser` Метод должен вызываться в двух случаях: при первой загрузке страницы, а также при каждом `UserList` изменяется DropDownList выбранного индекса. Таким образом, этот метод из `Page_Load` обработчик событий (после вызовов `BindUsersToUserList` и `BindRolesToList`). Кроме того, создайте обработчик событий для DropDownList `SelectedIndexChanged` событий и вызвать этот метод из него.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample8.vb)]

Этот код в месте можно проверить страницы в браузере. Однако, поскольку `UsersAndRoles.aspx` страницы в настоящее время нет возможности назначать пользователей ролям, пользователи не имеют роли. Мы создадим интерфейс для назначения пользователям ролей позже, чтобы вы могли принимать, этот код работает программа word и убедитесь, что она делает это позже, или можно вручную добавить пользователей в роли путем вставки записей в `aspnet_UsersInRoles` таблицы для тестирования этого functi Теперь onality.

### <a name="assigning-and-removing-users-from-roles"></a>Назначение и удаление пользователей из ролей

Когда посетителя или снятии флажка в `UsersRoleList` повторителя, нам нужно добавить или удалить выбранного пользователя из соответствующей роли. Этот флажок `AutoPostBack` свойства установлено значение True, то вызывает обратную передачу в любое время в Повторителе флажок устанавливается или снимается. Иными словами, необходимо создать обработчик событий к флажку `CheckChanged` событий. Поскольку флажок находится в элементе управления повторителем, необходимо вручную добавить направляющее обработчика событий. Начните с добавления обработчика событий класс кода в качестве `Protected` метод, следующим образом:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample9.vb)]

Напишите код позже этот обработчик событий будет возвращена. Но сначала давайте завершения обработки направляющее события. Установки флажка в повторителя `ItemTemplate`, добавьте `OnCheckedChanged="RoleCheckBox_CheckChanged"`. Связывает этот синтаксис `RoleCheckBox_CheckChanged` обработчик событий `RoleCheckBox` `CheckedChanged` событие.

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample10.aspx)]

Наш последняя задача — для завершения `RoleCheckBox_CheckChanged` обработчика событий. Необходимо запустить с помощью ссылки на элемент управления CheckBox, вызвавшего событие, так как этот экземпляр флажок указывает, какую роль выполняет тот был флажком через его `Text` и `Checked` свойства. Используя эти сведения вместе с именем пользователя выбранного пользователя, мы добавить или удалить пользователя из роли с помощью `Roles` класса [ `AddUserToRole` ](https://msdn.microsoft.com/library/system.web.security.roles.addusertorole.aspx) или [ `RemoveUserFromRole` метод](https://msdn.microsoft.com/library/system.web.security.roles.removeuserfromrole.aspx).

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample11.vb)]

Приведенный выше код начинается с программного обращения флажок, вызвавшего событие, которое доступно через `sender` входного параметра. Если этот флажок установлен, выбранного пользователя добавляется в указанную роль, в противном случае они будут удалены из роли. В любом случае `ActionStatus` метка отображает сообщение суммирование только что выполненное действие.

Теперь пора проверить эту страницу через браузер. Выберите пользователя Tito, а затем добавьте Tito роли администраторов и руководителей.


[![Tito был добавлен для администраторов и руководителями ролей](assigning-roles-to-users-vb/_static/image8.png)](assigning-roles-to-users-vb/_static/image7.png)

**Рис. 3**: Tito был добавлен для администраторов и руководителями ролей ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image9.png))


Затем выберите пользователей Bruce из раскрывающегося списка. Обратная передача и флажки повторителя обновляются через `CheckRolesForSelectedUser`. Поскольку Bruce еще не принадлежат ни одной роли, не помечены два флажка. Затем добавьте Bruce руководителями роли.


[![Bruce был добавлен в роль руководителями](assigning-roles-to-users-vb/_static/image11.png)](assigning-roles-to-users-vb/_static/image10.png)

**Рис. 4**: Bruce был добавлен в роль руководителями ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image12.png))


Для дальнейшей проверки функциональности `CheckRolesForSelectedUser` метод, выберите пользователя, отличного от Tito или Bruce. Обратите внимание, как флажки автоматически флажок снят, означающее, что они не принадлежат ни одной роли. Вернитесь к Tito. Следует проверить флажков "Администраторы" или "Менеджер.

## <a name="step-2-building-the-by-roles-user-interface"></a>Шаг 2: Создание пользовательского интерфейса «,» роли

На этом этапе мы завершили интерфейса «пользователями» и приступить к решению интерфейс «с помощью ролей». Интерфейс «ролями» предлагает пользователю выбрать роль из раскрывающегося списка, а затем отображает набор пользователей, принадлежащих этой роли в элементе управления GridView.

Добавление другого элемента управления DropDownList для `UsersAndRoles.aspx page`. Это одна под элементом управления повторителем, назовите его `RoleList`и задайте его `AutoPostBack` значение True. Под, добавьте элемент управления GridView и назовите его `RolesUserList`. Это GridView будут перечислены пользователи, которые входят в выбранную роль. Присвоить свойству `AutoGenerateColumns` свойству значение False, добавьте TemplateField в сетку `Columns` коллекции и задайте его `HeaderText` свойства «Пользователи». Определение TemplateField `ItemTemplate` , чтобы он отображает значение выражения привязки данных `Container.DataItem` в `Text` свойства элемента управления Label с именем `UserNameLabel`.

После добавления и настройки GridView, ваш «по роли» интерфейса должна выглядеть следующим образом:

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample12.aspx)]

Нам нужно заполнить `RoleList` DropDownList с набор ролей в системе. Для этого обновления `BindRolesToList` метод так, чтобы он привязывает массив строк, возвращаемый `Roles.GetAllRoles` метод `RolesList` DropDownList (а также `UsersRoleList` повторителя).

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample13.vb)]

Две последние строки в `BindRolesToList` метод были добавлены в набор ролей, чтобы привязать `RoleList` управления DropDownList. Рис. 5 показан конечный результат, при просмотре через браузер — раскрывающегося списка, заполненный системные роли.


[![Роли отображаются в раскрывающемся списке RoleList](assigning-roles-to-users-vb/_static/image14.png)](assigning-roles-to-users-vb/_static/image13.png)

**Рис. 5**: роли выводятся в `RoleList` DropDownList ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image15.png))


### <a name="displaying-the-users-that-belong-to-the-selected-role"></a>Отображение пользователей, которые принадлежат выбранной роли

При первой загрузке страницы или при выборе новой роли из `RoleList` DropDownList, нам нужно показать список пользователей, принадлежащих этой роли в GridView. Создайте метод с именем `DisplayUsersBelongingToRole` используя следующий код:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample14.vb)]

Этот метод запускает путем получения выбранную роль из `RoleList` DropDownList. Затем он использует [ `Roles.GetUsersInRole(roleName)` метод](https://msdn.microsoft.com/library/system.web.security.roles.getusersinrole.aspx) для получения строкового массива имена пользователей, принадлежащих к этой роли. Этот массив затем привязывается к `RolesUserList` GridView.

Этот метод должен вызываться в двух случаях: при начальной загрузке страницы и выбранную роль `RoleList` DropDownList изменения. Поэтому обновлять `Page_Load` обработчик событий, чтобы этот метод вызывается после вызова `CheckRolesForSelectedUser`. Создайте обработчик событий для `RoleList` `SelectedIndexChanged` события и этот метод оттуда слишком.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample15.vb)]

С помощью этого кода в месте `RolesUserList` GridView отображать тех пользователей, которые принадлежат выбранной роли. Как показано на рис. 6, руководители роль состоит из двух элементов: Bruce и Tito.


[![GridView список тех пользователей, которые принадлежат выбранной роли](assigning-roles-to-users-vb/_static/image17.png)](assigning-roles-to-users-vb/_static/image16.png)

**Рис. 6**: GridView перечислены те пользователи, принадлежат выбранной роли ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image18.png))


### <a name="removing-users-from-the-selected-role"></a>Удаление пользователей из выбранной роли

Давайте дополнять `RolesUserList` GridView, чтобы он включал столбец «удалить» кнопок. Нажав кнопку «Удалить» для конкретного пользователя будут удалены из этой роли.

Начните с добавления поля кнопку Delete к GridView. Сделать это поле отображается как наиболее архивированного влево и изменить его `DeleteText` свойство из «Удалить» (по умолчанию), «Удалить».


[![Добавить](assigning-roles-to-users-vb/_static/image20.png)](assigning-roles-to-users-vb/_static/image19.png)

**Рис. 7**: добавить кнопку «Удалить» к GridView ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image21.png))


При нажатии кнопки «Удалить» выполняется обратная и GridView `RowDeleting` события. Нам необходимо создать обработчик событий для этого события и написать код, который удаляет пользователя из выбранной роли. Создайте обработчик событий и затем добавьте следующий код:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample16.vb)]

Начинается код, определяя имя выбранной роли. Затем программно ссылки `UserNameLabel` элемента управления, из которого «Удалить» кнопка была нажата, чтобы определить имя пользователя для удаления строки. Затем этот пользователь удаляется из роли через вызов `Roles.RemoveUserFromRole` метод. `RolesUserList` GridView обновляется и отображается сообщение через `ActionStatus` метки элемента управления.

> [!NOTE]
> Кнопка «Удалить» не требует каких-либо подтверждения от пользователя, прежде чем удалять пользователей из роли. Я приглашаю вас добавить некоторый уровень подтверждения пользователя. Одним из самых простых способов подтверждение действия является через диалоговое окно подтверждения на стороне клиента. Дополнительные сведения об этом приеме см. в разделе [Добавление подтверждения клиентских при удалении](https://asp.net/learn/data-access/tutorial-42-vb.aspx).


На рисунке 8 показана страница после удаления пользователя Tito из группы руководителей.


[![Увы Tito больше не администратора](assigning-roles-to-users-vb/_static/image23.png)](assigning-roles-to-users-vb/_static/image22.png)

**Рис. 8**: Увы, Tito больше не администратора ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image24.png))


### <a name="adding-new-users-to-the-selected-role"></a>Добавление новых пользователей в выбранной роли

Вместе с удаления пользователей из выбранной роли, посетитель на эту страницу, также следует предоставить для добавления пользователя к выбранной роли. Лучший интерфейс для добавления в выбранную роль пользователя зависит от количества учетных записей пользователей, которые предполагается наличие. Если веб-сайт размещается несколько десятков учетные или менее, здесь можно использовать DropDownList. Если могут быть тысячи учетные записи пользователей, может потребоваться включить пользовательский интерфейс, позволяющий посетитель для постраничного просмотра учетных записей, поиска конкретного счета или фильтрации учетных записей пользователей иным образом.

Для этой страницы воспользуемся очень простой интерфейс, который работает независимо от количества учетных записей пользователей в системе. А именно мы будем использовать текстовое поле запроса посетитель введите имя пользователя, которым желает добавить к выбранной роли. Если пользователь с таким именем не существует, или если пользователь уже является членом роли, мы будем сообщение в `ActionStatus` метки. Но если пользователь существует и не является членом роли, мы обновить сетку и добавить их к роли.

Добавьте текстовое поле и кнопку под GridView. Значение текстового поля `ID` для `UserNameToAddToRole` и задать свойству кнопки `ID` и `Text` свойства `AddUserToRoleButton` и «Добавление пользователя в роль», соответственно.

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample17.aspx)]

Создайте `Click` обработчик событий для `AddUserToRoleButton` и добавьте следующий код:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample18.vb)]

Большая часть кода в `Click` обработчик событий выполняет различные проверки правильности. Это гарантирует, что посетитель предоставленное имя пользователя в `UserNameToAddToRole` в текстовое поле, пользователь существует в системе, и они уже не входят в выбранную роль. Если любой из этих проверок завершается с ошибкой, соответствующее сообщение отображается в `ActionStatus` и выходе из обработчика событий. Если все проверки передачи, пользователь добавляется к роли с помощью `Roles.AddUserToRole` метод. После этого текстового поля `Text` свойство очищаются, GridView обновляется и `ActionStatus` метка отображается сообщение, указывающее, что указанный пользователь успешно добавлен к выбранной роли.

> [!NOTE]
> Чтобы убедиться, что указанный пользователь не входил в выбранную роль, мы используем [ `Roles.IsUserInRole(userName, roleName)` метод](https://msdn.microsoft.com/library/system.web.security.roles.isuserinrole.aspx), которая возвращает логическое значение, указывающее, ли *userName* является членом *roleName*. Мы будем использовать этот метод еще раз, в <a id="_msoanchor_2"> </a> [следующее руководство](role-based-authorization-vb.md) когда мы рассмотрим авторизации на основе ролей.


Перейдите на страницу с помощью браузера, а затем выберите роль руководителями из `RoleList` DropDownList. Попробуйте ввести неправильное имя пользователя — должно появиться сообщение о том, что пользователь не существует в системе.


[![Не удается добавить несуществующий пользователь к роли](assigning-roles-to-users-vb/_static/image26.png)](assigning-roles-to-users-vb/_static/image25.png)

**Рис. 9**: не удается добавить несуществующий пользователь к роли ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image27.png))


Теперь попробуйте добавить является допустимым пользователем. Продолжим и снова добавить Tito в роли Менеджер.


[![Tito еще раз является начальника!](assigning-roles-to-users-vb/_static/image29.png)](assigning-roles-to-users-vb/_static/image28.png)

**Рис. 10**: Tito еще раз является начальника!  ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image30.png))


## <a name="step-3-cross-updating-the-by-user-and-by-role-interfaces"></a>Шаг 3: Обновление между «По пользователю» или «роли», интерфейсы

`UsersAndRoles.aspx` Страница предоставляет два различных интерфейсов для управления пользователями и ролями. В настоящее время этих интерфейсов действовать независимо друг от друга, поэтому возможно, что изменения, внесенные в одном интерфейсе не отразится немедленно в других. Например, предположим, что посетитель страницы выбирает роли руководителями из `RoleList` DropDownList, в которой перечислены Bruce и Tito в качестве своих членов. Далее посетитель выбирает Tito из `UserList` DropDownList, проверяющее флажки «Администраторы» и «руководители в `UsersRoleList` повторителя. Если посетитель затем снимает роли начальника из повторителя, Tito удаляется из руководителей роли, но это изменение не отражается в интерфейсе «по роли». GridView по-прежнему будет отображаться Tito как член роли Менеджер.

Чтобы исправить это, необходимо обновить GridView всякий раз, когда роль устанавливается или снимается из `UsersRoleList` повторителя. Аналогичным образом нам нужно обновить повторителя всякий раз, когда пользователь удаляется или роли, добавляемый в интерфейсе «по роли».

В интерфейсе «пользователем» повторителя обновляется путем вызова `CheckRolesForSelectedUser` метод. Интерфейс «по роли», могут быть изменены в `RolesUserList` элемента GridView `RowDeleting` обработчик событий и `AddUserToRoleButton` кнопки `Click` обработчика событий. Таким образом, нам потребуется вызвать `CheckRolesForSelectedUser` метод в каждом из этих методов.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample19.vb)]

Аналогичным образом GridView в интерфейсе «по ролям» обновляется путем вызова `DisplayUsersBelongingToRole` метод и интерфейс «пользователем» изменяется посредством `RoleCheckBox_CheckChanged` обработчика событий. Таким образом, нам потребуется вызвать `DisplayUsersBelongingToRole` метод из этого обработчика событий.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample20.vb)]

Эти небольшие изменения «с пользователя», «роль» интерфейсы теперь правильно между обновления. Чтобы проверить это, перейдите на страницу с помощью браузера и выберите Tito и руководителей из `UserList` и `RoleList` элементами управления DropDownList, соответственно. Обратите внимание, как руководители роли снимите для Tito из повторителя в интерфейсе «пользователем», Tito автоматически удаляется из GridView в интерфейсе «по роли». Добавление Tito обратно к роли руководителями из интерфейса «по ролям» автоматически повторно проверяет руководителями флажок в интерфейсе «пользователем».

## <a name="step-4-customizing-the-createuserwizard-to-include-a-specify-roles-step"></a>Шаг 4: Настройка CreateUserWizard включаемых шаг «Укажите роли»

В <a id="_msoanchor_3"> </a> [ *Создание учетных записей пользователей* ](../membership/creating-user-accounts-vb.md) учебника мы узнали, как использовать элемент управления CreateUserWizard обеспечивает интерфейс для создания новой учетной записи пользователя. Элемент управления CreateUserWizard можно использовать одним из двух способов:

- Как средство для посетителей, для создания своей учетной записи на сайте и
- Как средство для администраторов создать новые учетные записи

В первом случае используйте посетитель входит на сайт и вводит CreateUserWizard, введя свои данные для регистрации на сайте. Во втором случае администратор создает новую учетную запись для другого пользователя.

При создании учетной записи администратором некоторые другие лица, бывает полезно позволить администратору указывать учетную запись пользователя принадлежит к роли. В <a id="_msoanchor_4"> </a> [ *хранение* *Дополнительные сведения о пользователе* ](../membership/storing-additional-user-information-vb.md) учебника мы узнали, как настройка CreateUserWizard путем добавления дополнительных `WizardSteps`. Давайте взглянем на как добавьте CreateUserWizard дополнительный шаг, чтобы указать роли нового пользователя.

Откройте `CreateUserWizardWithRoles.aspx` и добавьте элемент управления CreateUserWizard `RegisterUserWithRoles`. Задайте в качестве `ContinueDestinationPageUrl` свойства «~ / Default.aspx». Так как том, что администратор будет использовать этот элемент управления CreateUserWizard для создания новых учетных записей пользователей, задайте в качестве `LoginCreatedUser` свойству значение False. Это `LoginCreatedUser` свойство разрешение посетителя автоматически входит в систему как пользователь только что создан, и по умолчанию используется значение True. Мы присвойте ему значение False, так как администратор создает новую учетную запись мы хотим сохранять его в систему как себе.

Затем выберите «Добавить или удалить `WizardSteps`...» в смарт-теге CreateUserWizard и добавьте новый `WizardStep`, параметр его `ID` для `SpecifyRolesStep`. Переместить `SpecifyRolesStep WizardStep` , чтобы он поступает после шага «Вход на новой учетной записи», но перед этапом «Выполнено». Задать `WizardStep` `Title` свойства «Укажите роли», его `StepType` свойства `Step`и его `AllowReturn` свойству значение False.


[![Добавить](assigning-roles-to-users-vb/_static/image32.png)](assigning-roles-to-users-vb/_static/image31.png)

**Рис. 11**: добавление «Укажите ролей» `WizardStep` для CreateUserWizard ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image33.png))


После этого изменения вашего CreateUserWizard должен выглядеть следующим образом:

[!code-aspx[Main](assigning-roles-to-users-vb/samples/sample21.aspx)]

В «Укажите ролей» `WizardStep`, добавьте CheckBoxList с именем `RoleList.` этот CheckBoxList перечислит доступные роли, включение лица, посетив страницу проверить, какие роли только что созданный пользователь принадлежит.

Решена двух задач кодирования: сначала мы должны заполнить `RoleList` CheckBoxList с ролями в системе; во-вторых, необходимо добавить созданного пользователя к выбранным ролям, при перемещении из шага «Укажите роли» шаг «Завершить». В первой задаче можно достичь `Page_Load` обработчика событий. В следующем примере кода программным образом ссылки `RoleList` флажок на первом перейдите на страницу и привязывает к этому экземпляру роли в системе.

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample22.vb)]

Приведенный выше код должен выглядеть знакомы. В <a id="_msoanchor_5"> </a> [ *хранение* *Дополнительные сведения о пользователе* ](../membership/storing-additional-user-information-vb.md) мы использовали два учебника `FindControl` инструкций для ссылки на веб-элемент управления из внутри пользовательской `WizardStep`. И код, который привязывает роли CheckBoxList взято из ранее в этом учебнике.

Для выполнения второй задачи программирования, нам нужно знать о после завершения на шаге «Укажите ролей». Напомним, что имеет CreateUserWizard `ActiveStepChanged` событие, которое возникает при каждом перемещении посетителя от одного шага к другому. Здесь можно определить, достигла ли на шаге «Завершение»; в этом случае необходимо добавить пользователя к выбранным ролям.

Создайте обработчик событий для `ActiveStepChanged` событий и добавьте следующий код:

[!code-vb[Main](assigning-roles-to-users-vb/samples/sample23.vb)]

Если пользователь достиг только на шаге «Completed», обработчик событий перечисляет элементы `RoleList` CheckBoxList и только что созданного пользователя назначаются для выбранных ролей.

Посетите эту страницу через браузер. Первым шагом в CreateUserWizard является стандартной шаг «Вход на новой учетной записи», который запрашивает новое имя пользователя, пароль, электронной почты и другие сведения о ключе. Введите сведения, чтобы создать нового пользователя с именем Ванда.


[![Создайте нового пользователя с именем Ванда](assigning-roles-to-users-vb/_static/image35.png)](assigning-roles-to-users-vb/_static/image34.png)

**Рис. 12**: Создание нового пользователя с именем Ванда ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image36.png))


Нажмите кнопку «Создать пользователя». Автоматически вызывает CreateUserWizard `Membership.CreateUser` метод, создание новой учетной записи пользователя, а затем переходит к следующему шагу «укажите роли.» Здесь перечислены системные роли. Установите флажок "руководители" и нажмите кнопку Далее.


[![Включите Ванда роль руководителями](assigning-roles-to-users-vb/_static/image38.png)](assigning-roles-to-users-vb/_static/image37.png)

**Рис. 13**: включите Ванда роль менеджер ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image39.png))


Нажав кнопку Далее вызывает обратную передачу и обновления `ActiveStep` к действию «Завершено». В `ActiveStepChanged` обработчик событий, учетной записи пользователя создан недавно назначена роль руководителей. Чтобы проверить это, нужно вернуть `UsersAndRoles.aspx` и выберите руководителями из `RoleList` DropDownList. Как показано на рис. 14, руководители теперь состоят из трех пользователей: Bruce Tito и Ванда.


[![Bruce, Tito и Ванда являются все руководители](assigning-roles-to-users-vb/_static/image41.png)](assigning-roles-to-users-vb/_static/image40.png)

**Рис. 14**: Bruce, Tito и Ванда являются все руководители ([Просмотр полноразмерное изображение](assigning-roles-to-users-vb/_static/image42.png))


## <a name="summary"></a>Сводка

Framework ролей предоставляет методы для получения сведений о ролях и методы для определения, какие пользователи принадлежат к указанной роли конкретного пользователя. Кроме того существует несколько методов для добавления и удаления одного или нескольких пользователей для одной или нескольких ролей. В этом учебнике мы основное внимание уделено только два из этих методов: `AddUserToRole` и `RemoveUserFromRole`. Существуют дополнительные варианты для добавления нескольких пользователей одной роли и назначить несколько ролей для одного пользователя.

Этот учебник также включены взглянуть на расширение для включения управления CreateUserWizard `WizardStep` для указания роли только что созданный пользователь. Такого шага может помочь администратору позволяют упростить процесс создания учетных записей пользователей для новых пользователей.

На этом этапе мы увидели, как создавать и удалять роли и как добавлять и удалять пользователей из ролей. Но у нас есть еще рассмотрим применение авторизации на основе ролей. В <a id="_msoanchor_6"> </a> [следующие учебника](role-based-authorization-vb.md) мы рассмотрим определение правил авторизации URL-адрес для каждой роли, роли, также как ограничивать его функциональные возможности уровня страницы на основе ролей текущего вошедшего пользователя.

Программирование довольны!

### <a name="further-reading"></a>Дополнительные сведения

Дополнительные сведения по темам, рассматриваемые в этом учебнике см. в следующих ресурсах:

- [Обзор средства администрирования веб-сайта ASP.NET](https://msdn.microsoft.com/library/ms228053.aspx)
- [Проверка ASP. NET членства, ролей и профиля](http://aspnet.4guysfromrolla.com/articles/120705-1.aspx)
- [Последовательное собственные средства администрирования веб-сайта](http://aspnet.4guysfromrolla.com/articles/052307-1.aspx)

### <a name="about-the-author"></a>Об авторе

Скотт Митчелл, автор нескольких ASP/ASP.NET и основатель 4GuysFromRolla.com, работает с веб-технологиями Майкрософт с 1998 года. Скотт — независимый консультант, trainer и записи. Его последняя книга —  *[диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)*. Скотт может быть достигнута по [ mitchell@4guysfromrolla.com ](mailto:mitchell@4guysfromrolla.com) или через его блог по [http://ScottOnWriting.NET](http://scottonwriting.net/).

### <a name="special-thanks-to"></a>Особая благодарность

Этот учебник ряд прошел проверку многие полезные рецензентов. Основной рецензент этого учебника было Мерфи Тереза д. Объясняются моих последующих статей для MSDN? Если Да, напишите мне по[mitchell@4GuysFromRolla.com](mailto:mitchell@4GuysFromRolla.com)

>[!div class="step-by-step"]
[Назад](creating-and-managing-roles-vb.md)
[Вперед](role-based-authorization-vb.md)

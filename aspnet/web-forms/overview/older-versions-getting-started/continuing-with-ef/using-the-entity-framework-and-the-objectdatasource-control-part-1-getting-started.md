---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started
title: 'Использование Entity Framework 4.0 и управления ObjectDataSource, часть 1: Приступая к работе | Документы Microsoft'
author: tdykstra
description: Этот учебник ряд строится на веб-приложение Contoso университета, созданный Приступая к работе с рядами учебника Entity Framework. Если ё...
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/26/2011
ms.topic: article
ms.assetid: 244278c1-fec8-4255-8a8a-13bde491c4f5
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started
msc.type: authoredcontent
ms.openlocfilehash: 6584767418c898913777b3b1549a816679c8430d
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/06/2018
ms.locfileid: "30892086"
---
<a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-1-getting-started"></a><span data-ttu-id="d3cd5-104">Использование Entity Framework 4.0 и управления ObjectDataSource, часть 1: Приступая к работе</span><span class="sxs-lookup"><span data-stu-id="d3cd5-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 1: Getting Started</span></span>
====================
<span data-ttu-id="d3cd5-105">по [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="d3cd5-106">Этот учебник ряд основан на веб-приложение Contoso университета, созданный [Приступая к работе с Entity Framework 4.0](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) учебника рядов.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorial series.</span></span> <span data-ttu-id="d3cd5-107">Если не была завершена ранее учебники, в качестве отправной точки для этого учебника вы можете [загрузить приложение](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) , будет создана.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="d3cd5-108">Вы также можете [загрузить приложение](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) , создаваемый для завершения учебника ряда.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span>
> 
> <span data-ttu-id="d3cd5-109">Contoso университета примера веб-приложения показано, как для создания приложений веб-форм ASP.NET, с помощью Entity Framework 4.0 и Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-109">The Contoso University sample web application demonstrates how to create ASP.NET Web Forms applications using the Entity Framework 4.0 and Visual Studio 2010.</span></span> <span data-ttu-id="d3cd5-110">Образец приложения это веб-сайт для вымышленной компании Contoso университета.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-110">The sample application is a website for a fictional Contoso University.</span></span> <span data-ttu-id="d3cd5-111">На нем предусмотрены различные функции, в том числе прием учащихся, создание курсов и назначение преподавателей.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-111">It includes functionality such as student admission, course creation, and instructor assignments.</span></span>
> 
> <span data-ttu-id="d3cd5-112">Учебник показаны примеры на языке C#.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-112">The tutorial shows examples in C#.</span></span> <span data-ttu-id="d3cd5-113">[Загружаемые примеры](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) содержит код на C# и Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-113">The [downloadable sample](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) contains code in both C# and Visual Basic.</span></span>
> 
> ## <a name="database-first"></a><span data-ttu-id="d3cd5-114">Сначала базы данных</span><span class="sxs-lookup"><span data-stu-id="d3cd5-114">Database First</span></span>
> 
> <span data-ttu-id="d3cd5-115">Существует три способа, можно работать с данными в Entity Framework: *Database First*, *Model First*, и *Code First*.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-115">There are three ways you can work with data in the Entity Framework: *Database First*, *Model First*, and *Code First*.</span></span> <span data-ttu-id="d3cd5-116">Этот учебник предназначен для первой базы данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-116">This tutorial is for Database First.</span></span> <span data-ttu-id="d3cd5-117">Сведения о различиях между этими рабочими процессами и рекомендации о том, как выбирать наиболее подходящий для вашего сценария см. в разделе [процессов разработки Entity Framework](https://msdn.microsoft.com/library/ms178359.aspx#dbfmfcf).</span><span class="sxs-lookup"><span data-stu-id="d3cd5-117">For information about the differences between these workflows and guidance on how to choose the best one for your scenario, see [Entity Framework Development Workflows](https://msdn.microsoft.com/library/ms178359.aspx#dbfmfcf).</span></span>
> 
> ## <a name="web-forms"></a><span data-ttu-id="d3cd5-118">Веб-формы</span><span class="sxs-lookup"><span data-stu-id="d3cd5-118">Web Forms</span></span>
> 
> <span data-ttu-id="d3cd5-119">Как и ряда Приступая к работе этого учебника ряда использует модель веб-форм ASP.NET и предполагается, что вы знаете, как работать с веб-форм ASP.NET в Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-119">Like the Getting Started series, this tutorial series uses the ASP.NET Web Forms model and assumes you know how to work with ASP.NET Web Forms in Visual Studio.</span></span> <span data-ttu-id="d3cd5-120">Если отсутствует [Приступая к работе с веб-форм ASP.NET 4.5](../../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md).</span><span class="sxs-lookup"><span data-stu-id="d3cd5-120">If you don't, see [Getting Started with ASP.NET 4.5 Web Forms](../../getting-started/getting-started-with-aspnet-45-web-forms/introduction-and-overview.md).</span></span> <span data-ttu-id="d3cd5-121">Если вы предпочитаете работать с ASP.NET MVC, см. раздел [Приступая к работе с платформой Entity Framework, с помощью ASP.NET MVC](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span><span class="sxs-lookup"><span data-stu-id="d3cd5-121">If you prefer to work with the ASP.NET MVC framework, see [Getting Started with the Entity Framework using ASP.NET MVC](../../../../mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span>
> 
> ## <a name="software-versions"></a><span data-ttu-id="d3cd5-122">Версии программного обеспечения</span><span class="sxs-lookup"><span data-stu-id="d3cd5-122">Software versions</span></span>
> 
> | <span data-ttu-id="d3cd5-123">**В этом учебнике показано**</span><span class="sxs-lookup"><span data-stu-id="d3cd5-123">**Shown in the tutorial**</span></span> | <span data-ttu-id="d3cd5-124">**Также работает с**</span><span class="sxs-lookup"><span data-stu-id="d3cd5-124">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="d3cd5-125">Windows 7</span><span class="sxs-lookup"><span data-stu-id="d3cd5-125">Windows 7</span></span> | <span data-ttu-id="d3cd5-126">Windows 8</span><span class="sxs-lookup"><span data-stu-id="d3cd5-126">Windows 8</span></span> |
> | <span data-ttu-id="d3cd5-127">Visual Studio 2010</span><span class="sxs-lookup"><span data-stu-id="d3cd5-127">Visual Studio 2010</span></span> | <span data-ttu-id="d3cd5-128">Visual Studio 2010 Express для Web.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-128">Visual Studio 2010 Express for Web.</span></span> <span data-ttu-id="d3cd5-129">Учебник не тестировался с более поздними версиями Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-129">The tutorial has not been tested with later versions of Visual Studio.</span></span> <span data-ttu-id="d3cd5-130">Существует много различий в выбранных элементов меню, диалоговых окон и шаблоны.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-130">There are many differences in menu selections, dialog boxes, and templates.</span></span> |
> | <span data-ttu-id="d3cd5-131">.NET 4</span><span class="sxs-lookup"><span data-stu-id="d3cd5-131">.NET 4</span></span> | <span data-ttu-id="d3cd5-132">.NET 4.5 имеет обратную совместимость с .NET 4, но с .NET 4.5 не тестировался учебника.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-132">.NET 4.5 is backward compatible with .NET 4, but the tutorial has not been tested with .NET 4.5.</span></span> |
> | <span data-ttu-id="d3cd5-133">Entity Framework 4</span><span class="sxs-lookup"><span data-stu-id="d3cd5-133">Entity Framework 4</span></span> | <span data-ttu-id="d3cd5-134">Учебник не тестировался с более поздними версиями платформы Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-134">The tutorial has not been tested with later versions of Entity Framework.</span></span> <span data-ttu-id="d3cd5-135">Начиная с Entity Framework 5, по умолчанию используется EF `DbContext API` , впервые появилась в EF 4.1.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-135">Starting with Entity Framework 5, EF uses by default the `DbContext API` that was introduced with EF 4.1.</span></span> <span data-ttu-id="d3cd5-136">Элемент управления EntityDataSource была разработана для использования `ObjectContext` API.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-136">The EntityDataSource control was designed to use the `ObjectContext` API.</span></span> <span data-ttu-id="d3cd5-137">Дополнительные сведения об использовании управления EntityDataSource было управлять с помощью `DbContext` API, в разделе [этой записи блога](https://blogs.msdn.com/b/webdev/archive/2012/09/13/how-to-use-the-entitydatasource-control-with-entity-framework-code-first.aspx).</span><span class="sxs-lookup"><span data-stu-id="d3cd5-137">For information about how to use the EntityDataSource control with the `DbContext` API, see [this blog post](https://blogs.msdn.com/b/webdev/archive/2012/09/13/how-to-use-the-entitydatasource-control-with-entity-framework-code-first.aspx).</span></span> |
> 
> ## <a name="questions"></a><span data-ttu-id="d3cd5-138">Вопросы</span><span class="sxs-lookup"><span data-stu-id="d3cd5-138">Questions</span></span>
> 
> <span data-ttu-id="d3cd5-139">Если у вас есть вопросы, которые не связаны непосредственно для работы с учебником, их можно разместить [форум по ASP.NET Entity Framework](https://forums.asp.net/1227.aspx), [Entity Framework и LINQ to Entities форум](https://social.msdn.microsoft.com/forums/adodotnetentityframework/threads/), или [ StackOverflow.com](http://stackoverflow.com/).</span><span class="sxs-lookup"><span data-stu-id="d3cd5-139">If you have questions that are not directly related to the tutorial, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx), the [Entity Framework and LINQ to Entities forum](https://social.msdn.microsoft.com/forums/adodotnetentityframework/threads/), or [StackOverflow.com](http://stackoverflow.com/).</span></span>


<span data-ttu-id="d3cd5-140">`EntityDataSource` Управления позволяет создавать приложения, очень быстро, но обычно требуется сохранить значительный объем бизнес-логики и логики доступа к данным в вашей *.aspx* страниц.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-140">The `EntityDataSource` control enables you to create an application very quickly, but it typically requires you to keep a significant amount of business logic and data-access logic in your *.aspx* pages.</span></span> <span data-ttu-id="d3cd5-141">Если ожидается, что ваше приложение к росту сложности и требует текущего обслуживания, можно заранее вкладывать больше времени разработки для создания *n уровневые* или *многоуровневая* структуры приложения Это более простого в сопровождении.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-141">If you expect your application to grow in complexity and to require ongoing maintenance, you can invest more development time up front in order to create an *n-tier* or *layered* application structure that's more maintainable.</span></span> <span data-ttu-id="d3cd5-142">Для реализации этой архитектуры, отделить уровень представления из уровня бизнес-логики (уровень бизнес-ЛОГИКИ) и уровня доступа к данным (DAL).</span><span class="sxs-lookup"><span data-stu-id="d3cd5-142">To implement this architecture, you separate the presentation layer from the business logic layer (BLL) and the data access layer (DAL).</span></span> <span data-ttu-id="d3cd5-143">Один из способов реализации этой структуры является использование `ObjectDataSource` управления вместо `EntityDataSource` элемента управления.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-143">One way to implement this structure is to use the `ObjectDataSource` control instead of the `EntityDataSource` control.</span></span> <span data-ttu-id="d3cd5-144">При использовании `ObjectDataSource` управления, можно реализовать собственный код для доступа к данным, а затем вызовите его в *.aspx* страниц с помощью элемента управления, обладающей множеством одной и той же функции, как другие элементы управления источником данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-144">When you use the `ObjectDataSource` control, you implement your own data-access code and then invoke it in *.aspx* pages using a control that has many of the same features as other data-source controls.</span></span> <span data-ttu-id="d3cd5-145">Это позволяет сочетать преимущества многоуровневого подхода со всеми преимуществами управления веб-форм для доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-145">This lets you combine the advantages of an n-tier approach with the benefits of using a Web Forms control for data access.</span></span>

<span data-ttu-id="d3cd5-146">`ObjectDataSource` Управления обеспечивает большую гибкость, а также другие способы.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-146">The `ObjectDataSource` control gives you more flexibility in other ways as well.</span></span> <span data-ttu-id="d3cd5-147">Так, как написать собственный код доступа к данным, проще не только чтения, вставки, обновления или удаления определенного типа сущности, которые являются задачами, `EntityDataSource` элемент управления предназначен для выполнения.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-147">Because you write your own data-access code, it's easier to do more than just read, insert, update, or delete a specific entity type, which are the tasks that the `EntityDataSource` control is designed to perform.</span></span> <span data-ttu-id="d3cd5-148">Например можно выполнить вход каждый раз при обновлении сущности, архивировать данные при каждом удалении сущности или автоматически проверка и обновление связанных данных при необходимости при вставке строки со значением внешнего ключа.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-148">For example, you can perform logging every time an entity is updated, archive data whenever an entity is deleted, or automatically check and update related data as needed when inserting a row with a foreign key value.</span></span>

## <a name="business-logic-and-repository-classes"></a><span data-ttu-id="d3cd5-149">Бизнес-логики и классы репозитория</span><span class="sxs-lookup"><span data-stu-id="d3cd5-149">Business Logic and Repository Classes</span></span>

<span data-ttu-id="d3cd5-150">`ObjectDataSource` Работы элемента управления с помощью вызова класса, который создан.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-150">An `ObjectDataSource` control works by invoking a class that you create.</span></span> <span data-ttu-id="d3cd5-151">Класс содержит методы для извлечения и обновления данных и укажите имена этих методов для `ObjectDataSource` элемента управления в разметке.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-151">The class includes methods that retrieve and update data, and you provide the names of those methods to the `ObjectDataSource` control in markup.</span></span> <span data-ttu-id="d3cd5-152">Во время подготовки к просмотру или обратной передачи `ObjectDataSource` вызывает методы, которые вы указали.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-152">During rendering or postback processing, the `ObjectDataSource` calls the methods that you've specified.</span></span>

<span data-ttu-id="d3cd5-153">Помимо основные операции CRUD, класса, который создан для использования с `ObjectDataSource` управления может потребоваться выполнение бизнес-логики при `ObjectDataSource` чтения или обновления данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-153">Besides basic CRUD operations, the class that you create to use with the `ObjectDataSource` control might need to execute business logic when the `ObjectDataSource` reads or updates data.</span></span> <span data-ttu-id="d3cd5-154">Например при обновлении отдел может потребоваться убедитесь, что нет других отделов есть ту же администратора, так как один пользователь не может быть администратором более одного отдела.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-154">For example, when you update a department, you might need to validate that no other departments have the same administrator because one person cannot be administrator of more than one department.</span></span>

<span data-ttu-id="d3cd5-155">В некоторых `ObjectDataSource` документации, таких как [Общие сведения о классе ObjectDataSource](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.aspx), элемент управления вызывает класс, называемый *бизнес-объекта* бизнес-логики и логики доступа к данным .</span><span class="sxs-lookup"><span data-stu-id="d3cd5-155">In some `ObjectDataSource` documentation, such as the [ObjectDataSource Class overview](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.aspx), the control calls a class referred to as a *business object* that includes both business logic and data-access logic.</span></span> <span data-ttu-id="d3cd5-156">В этом учебнике вы создадите отдельные классы для бизнес-логики и логики доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-156">In this tutorial you will create separate classes for business logic and for data-access logic.</span></span> <span data-ttu-id="d3cd5-157">Класс, инкапсулирующий логики доступа к данным, называется *репозитория*.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-157">The class that encapsulates data-access logic is called a *repository*.</span></span> <span data-ttu-id="d3cd5-158">Бизнес логики класса включает бизнес логики методы и методы доступа к данным, но методы доступа к данным вызова репозитория для выполнения задач, доступ к данным.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-158">The business logic class includes both business-logic methods and data-access methods, but the data-access methods call the repository to perform data-access tasks.</span></span>

<span data-ttu-id="d3cd5-159">Также создается уровень абстракции между уровень бизнес-ЛОГИКИ и DAL, упрощающий автоматических модульных тестов для МЕТОДА.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-159">You will also create an abstraction layer between your BLL and DAL that facilitates automated unit testing of the BLL.</span></span> <span data-ttu-id="d3cd5-160">Этот уровень абстракции реализуется путем создания интерфейса и с помощью интерфейса, при создании экземпляра репозитория в классе бизнес логики.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-160">This abstraction layer is implemented by creating an interface and using the interface when you instantiate the repository in the business-logic class.</span></span> <span data-ttu-id="d3cd5-161">Это позволяет предоставить класс бизнес логики со ссылкой на любой объект, реализующий интерфейс репозитория.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-161">This makes it possible for you to provide the business-logic class with a reference to any object that implements the repository interface.</span></span> <span data-ttu-id="d3cd5-162">Для нормальной работы необходимо предоставить объект хранилища, который работает с платформой Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-162">For normal operation, you provide a repository object that works with the Entity Framework.</span></span> <span data-ttu-id="d3cd5-163">Для тестирования, необходимо предоставить объект хранилища, который работает с данными, хранящимися в результате которого можно легко управлять, например класс переменные, определенные в коллекции.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-163">For testing, you provide a repository object that works with data stored in a way that you can easily manipulate, such as class variables defined as collections.</span></span>

<span data-ttu-id="d3cd5-164">Разница между класс бизнес логики, который включает логики доступа к данным без репозитория, а вторая использует репозиторий на следующем рисунке.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-164">The following illustration shows the difference between a business-logic class that includes data-access logic without a repository and one that uses a repository.</span></span>

<span data-ttu-id="d3cd5-165">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-165">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image1.png)</span></span>

<span data-ttu-id="d3cd5-166">Сначала выполняется создание веб-страниц, в котором `ObjectDataSource` непосредственно в репозиторий привязан элемент управления, так как только он выполняет задачи базовый доступ к данным.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-166">You will begin by creating web pages in which the `ObjectDataSource` control is bound directly to a repository because it only performs basic data-access tasks.</span></span> <span data-ttu-id="d3cd5-167">В следующем уроке будет создать класс бизнес-логики с логикой проверки и привязать `ObjectDataSource` управления для этого класса, а не класс репозитория.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-167">In the next tutorial you will create a business logic class with validation logic and bind the `ObjectDataSource` control to that class instead of to the repository class.</span></span> <span data-ttu-id="d3cd5-168">Также вы создадите модульные тесты для логики проверки.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-168">You will also create unit tests for the validation logic.</span></span> <span data-ttu-id="d3cd5-169">В третьем учебнике этой серии вы добавите функций для применения сортировки и фильтрации.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-169">In the third tutorial in this series you will add sorting and filtering functionality to the application.</span></span>

<span data-ttu-id="d3cd5-170">Страницы, создайте в этом учебнике работать в `Departments` набора сущностей модели данных, созданную в [начало учебника ряда](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md).</span><span class="sxs-lookup"><span data-stu-id="d3cd5-170">The pages you create in this tutorial work with the `Departments` entity set of the data model that you created in the [Getting Started tutorial series](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md).</span></span>

<span data-ttu-id="d3cd5-171">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-171">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image3.png)</span></span>

<span data-ttu-id="d3cd5-172">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-172">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image5.png)</span></span>

## <a name="updating-the-database-and-the-data-model"></a><span data-ttu-id="d3cd5-173">Обновление базы данных и модели данных</span><span class="sxs-lookup"><span data-stu-id="d3cd5-173">Updating the Database and the Data Model</span></span>

<span data-ttu-id="d3cd5-174">Сначала этот учебник, делая два изменения в базе данных, для которых требуется соответствующих изменений в модель данных, созданную в [Приступая к работе с платформой Entity Framework и веб-форм](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) учебники.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-174">You will begin this tutorial by making two changes to the database, both of which require corresponding changes to the data model that you created in the [Getting Started with the Entity Framework and Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorials.</span></span> <span data-ttu-id="d3cd5-175">В одном из этих учебников внесены изменения в конструкторе вручную для синхронизации модели данных с базой данных после изменения базы данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-175">In one of those tutorials, you made changes in the designer manually to synchronize the data model with the database after a database change.</span></span> <span data-ttu-id="d3cd5-176">В этом учебнике будет использоваться конструктор **обновление из базы данных Model** средство для автоматического обновления данных модели.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-176">In this tutorial, you will use the designer's **Update Model From Database** tool to update the data model automatically.</span></span>

### <a name="adding-a-relationship-to-the-database"></a><span data-ttu-id="d3cd5-177">Добавление отношения к базе данных</span><span class="sxs-lookup"><span data-stu-id="d3cd5-177">Adding a Relationship to the Database</span></span>

<span data-ttu-id="d3cd5-178">В Visual Studio откройте веб-приложение Contoso университета, вы создали в [Приступая к работе с платформой Entity Framework и веб-форм](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) учебника рядов, а затем откройте `SchoolDiagram` диаграммы базы данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-178">In Visual Studio, open the Contoso University web application you created in the [Getting Started with the Entity Framework and Web Forms](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-1.md) tutorial series, and then open the `SchoolDiagram` database diagram.</span></span>

<span data-ttu-id="d3cd5-179">Если взглянуть на `Department` таблицы в схеме базы данных, вы увидите, что она имеет `Administrator` столбца.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-179">If you look at the `Department` table in the database diagram, you will see that it has an `Administrator` column.</span></span> <span data-ttu-id="d3cd5-180">Этот столбец является внешним ключом для `Person` таблицы, но не связи по внешнему ключу определен в базе данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-180">This column is a foreign key to the `Person` table, but no foreign key relationship is defined in the database.</span></span> <span data-ttu-id="d3cd5-181">Необходимо создать связь и обновление модели данных Entity Framework может автоматически обрабатывать эту связь.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-181">You need to create the relationship and update the data model so that the Entity Framework can automatically handle this relationship.</span></span>

<span data-ttu-id="d3cd5-182">В схеме базы данных, щелкните правой кнопкой мыши `Department` и выберите **связи**.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-182">In the database diagram, right-click the `Department` table, and select **Relationships**.</span></span>

<span data-ttu-id="d3cd5-183">[![Image80](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-183">[![Image80](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image7.png)</span></span>

<span data-ttu-id="d3cd5-184">В **связи по внешним ключам** выберите **добавить**, нажмите кнопку с многоточием для **Спецификация таблиц и столбцов**.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-184">In the **Foreign Key Relationships** box click **Add**, then click the ellipsis for **Tables and Columns Specification**.</span></span>

<span data-ttu-id="d3cd5-185">[![Image81](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-185">[![Image81](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image9.png)</span></span>

<span data-ttu-id="d3cd5-186">В **таблицы и столбцы** диалогового окна поле, задайте таблице первичного ключа и полю `Person` и `PersonID`и задать таблицы внешнего ключа и полю `Department` и `Administrator`.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-186">In the **Tables and Columns** dialog box, set the primary key table and field to `Person` and `PersonID`, and set the foreign key table and field to `Department` and `Administrator`.</span></span> <span data-ttu-id="d3cd5-187">(При этом имя связи изменится с `FK_Department_Department` для `FK_Department_Person`.)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-187">(When you do this, the relationship name will change from `FK_Department_Department` to `FK_Department_Person`.)</span></span>

<span data-ttu-id="d3cd5-188">[![Image82](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-188">[![Image82](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image11.png)</span></span>

<span data-ttu-id="d3cd5-189">Нажмите кнопку **ОК** в **таблицы и столбцы** щелкните **закрыть** в **связи по внешним ключам** и сохраните изменения.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-189">Click **OK** in the **Tables and Columns** box, click **Close** in the **Foreign Key Relationships** box, and save the changes.</span></span> <span data-ttu-id="d3cd5-190">Ответ на вопрос, следует ли сохранить `Person` и `Department` , нажмите **Да**.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-190">If you're asked if you want to save the `Person` and `Department` tables, click **Yes**.</span></span>

> [!NOTE]
> <span data-ttu-id="d3cd5-191">Если вы удалили `Person` строки, которые относятся к данным, уже имеется в `Administrator` столбца, не можно сохранить это изменение.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-191">If you've deleted `Person` rows that correspond to data that's already in the `Administrator` column, you will not be able to save this change.</span></span> <span data-ttu-id="d3cd5-192">В этом случае использовать редактор таблиц в **обозревателя серверов** , чтобы `Administrator` значение в каждой `Department` строка содержит идентификатор записи, которая действительно существует в `Person` таблицы.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-192">In that case, use the table editor in **Server Explorer** to make sure that the `Administrator` value in every `Department` row contains the ID of a record that actually exists in the `Person` table.</span></span>
> 
> <span data-ttu-id="d3cd5-193">После сохранения изменений, вы не сможете удалить строку из `Person` таблица, если этот пользователь является администратором отдела.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-193">After you save the change, you will not be able to delete a row from the `Person` table if that person is a department administrator.</span></span> <span data-ttu-id="d3cd5-194">В реальном приложении будет предоставлен сообщение об ошибке при ограничения базы данных не допускает удаления или указании каскадное удаление.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-194">In a production application, you would provide a specific error message when a database constraint prevents a deletion, or you would specify a cascading delete.</span></span> <span data-ttu-id="d3cd5-195">Пример указания каскадное удаление см. в разделе [платформа Entity Framework и ASP.NET — часть 2 Приступая к работе](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-2.md).</span><span class="sxs-lookup"><span data-stu-id="d3cd5-195">For an example of how to specify a cascading delete, see [The Entity Framework and ASP.NET – Getting Started Part 2](../getting-started-with-ef/the-entity-framework-and-aspnet-getting-started-part-2.md).</span></span>


### <a name="adding-a-view-to-the-database"></a><span data-ttu-id="d3cd5-196">Добавление представления в базу данных</span><span class="sxs-lookup"><span data-stu-id="d3cd5-196">Adding a View to the Database</span></span>

<span data-ttu-id="d3cd5-197">В новом *Departments.aspx* страницы, будет создана, необходимо предоставить список раскрывающегося списка инструкторов, с именами в формате «Фамилия, имя» так, чтобы пользователи могли выбирать Администраторы отдела.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-197">In the new *Departments.aspx* page that you will be creating, you want to provide a drop-down list of instructors, with names in "last, first" format so that users can select department administrators.</span></span> <span data-ttu-id="d3cd5-198">Для упрощения этого будет создано представление в базе данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-198">To make it easier to do that, you will create a view in the database.</span></span> <span data-ttu-id="d3cd5-199">Представление будет содержать только данные, необходимые для раскрывающегося списка: полное имя (правильно отформатированные) и ключа записи.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-199">The view will consist of just the data needed by the drop-down list: the full name (properly formatted) and the record key.</span></span>

<span data-ttu-id="d3cd5-200">В **обозревателя серверов**, разверните *файл School.mdf*, щелкните правой кнопкой мыши **представления** папки, а затем выберите **добавить новое представление**.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-200">In **Server Explorer**, expand *School.mdf*, right-click the **Views** folder, and select **Add New View**.</span></span>

<span data-ttu-id="d3cd5-201">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-201">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image13.png)</span></span>

<span data-ttu-id="d3cd5-202">Нажмите кнопку **закрыть** при **добавить таблицу** диалоговое окно появляется и вставьте следующую инструкцию SQL на панели SQL:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-202">Click **Close** when the **Add Table** dialog box appears, and paste the following SQL statement into the SQL pane:</span></span>

[!code-sql[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample1.sql)]

<span data-ttu-id="d3cd5-203">Сохранение представления как `vInstructorName`.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-203">Save the view as `vInstructorName`.</span></span>

### <a name="updating-the-data-model"></a><span data-ttu-id="d3cd5-204">Обновление модели данных</span><span class="sxs-lookup"><span data-stu-id="d3cd5-204">Updating the Data Model</span></span>

<span data-ttu-id="d3cd5-205">В *DAL* откройте *SchoolModel.edmx* файл, щелкните правой кнопкой мыши область конструктора и выберите **обновление модели из базы данных**.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-205">In the *DAL* folder, open the *SchoolModel.edmx* file, right-click the design surface, and select **Update Model from Database**.</span></span>

<span data-ttu-id="d3cd5-206">[![Image07](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-206">[![Image07](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image15.png)</span></span>

<span data-ttu-id="d3cd5-207">В **Выбор объектов базы данных** выберите **добавить** и выберите только что созданное представление.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-207">In the **Choose Your Database Objects** dialog box, select the **Add** tab and select the view you just created.</span></span>

<span data-ttu-id="d3cd5-208">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-208">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image17.png)</span></span>

<span data-ttu-id="d3cd5-209">Нажмите кнопку **Готово**.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-209">Click **Finish**.</span></span>

<span data-ttu-id="d3cd5-210">В конструкторе, вы видите, что средство создания `vInstructorName` сущности и новой связи между `Department` и `Person` сущности.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-210">In the designer, you see that the tool created a `vInstructorName` entity and a new association between the `Department` and `Person` entities.</span></span>

<span data-ttu-id="d3cd5-211">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-211">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image19.png)</span></span>

> [!NOTE]
> <span data-ttu-id="d3cd5-212">В **вывода** и **список ошибок** windows, может появиться предупреждающее сообщение, информирующее о том, что средство автоматически создается первичный ключ для нового `vInstructorName` представления.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-212">In the **Output** and **Error List** windows you might see a warning message informing you that the tool automatically created a primary key for the new `vInstructorName` view.</span></span> <span data-ttu-id="d3cd5-213">Это нормальная ситуация.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-213">This is expected behavior.</span></span>


<span data-ttu-id="d3cd5-214">При ссылке на новый `vInstructorName` сущности в коде, вы не хотите использовать префикса строчный символ «v» к нему правило базы данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-214">When you refer to the new `vInstructorName` entity in code, you don't want to use the database convention of prefixing a lower-case "v" to it.</span></span> <span data-ttu-id="d3cd5-215">Таким образом переименовании сущностью и сущностью, определенную в модели.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-215">Therefore, you will rename the entity and entity set in the model.</span></span>

<span data-ttu-id="d3cd5-216">Откройте **модели браузера**.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-216">Open the **Model Browser**.</span></span> <span data-ttu-id="d3cd5-217">Вы видите `vInstructorName` указано как тип сущности и представления.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-217">You see `vInstructorName` listed as an entity type and a view.</span></span>

<span data-ttu-id="d3cd5-218">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-218">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image21.png)</span></span>

<span data-ttu-id="d3cd5-219">В разделе **SchoolModel** (не **SchoolModel.Store**), щелкните правой кнопкой мыши **vInstructorName** и выберите **свойства**.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-219">Under **SchoolModel** (not **SchoolModel.Store**), right-click **vInstructorName** and select **Properties**.</span></span> <span data-ttu-id="d3cd5-220">В **свойства** измените **имя** «InstructorName» и измените свойства **имя набора сущностей** свойства «InstructorNames».</span><span class="sxs-lookup"><span data-stu-id="d3cd5-220">In the **Properties** window, change the **Name** property to "InstructorName" and change the **Entity Set Name** property to "InstructorNames".</span></span>

<span data-ttu-id="d3cd5-221">[![Image15](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image24.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-221">[![Image15](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image24.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image23.png)</span></span>

<span data-ttu-id="d3cd5-222">Сохраните и закройте модели данных и затем перестройте проект.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-222">Save and close the data model, and then rebuild the project.</span></span>

## <a name="using-a-repository-class-and-an-objectdatasource-control"></a><span data-ttu-id="d3cd5-223">С помощью класса репозитория и элемент управления ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="d3cd5-223">Using a Repository Class and an ObjectDataSource Control</span></span>

<span data-ttu-id="d3cd5-224">Создать новый файл класса в *DAL* папки, назовите его *SchoolRepository.cs*и замените существующий код следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-224">Create a new class file in the *DAL* folder, name it *SchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample2.cs)]

<span data-ttu-id="d3cd5-225">Этот код предоставляет одну `GetDepartments` метод, возвращающий все сущности в `Departments` набора сущностей.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-225">This code provides a single `GetDepartments` method that returns all of the entities in the `Departments` entity set.</span></span> <span data-ttu-id="d3cd5-226">Поскольку вам известно, что вам необходим доступ к `Person` свойство навигации для каждой строки получаемой, указать упреждающая загрузка для этого свойства с помощью `Include` метод.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-226">Because you know that you will be accessing the `Person` navigation property for every row returned, you specify eager loading for that property by using the `Include` method.</span></span> <span data-ttu-id="d3cd5-227">Класс также реализует `IDisposable` интерфейса, чтобы убедиться, что подключение к базе данных освобождается, когда удаляется объект.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-227">The class also implements the `IDisposable` interface to ensure that the database connection is released when the object is disposed.</span></span>

> [!NOTE]
> <span data-ttu-id="d3cd5-228">Распространенной практикой является создание класса репозитория для каждого типа сущности.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-228">A common practice is to create a repository class for each entity type.</span></span> <span data-ttu-id="d3cd5-229">В этом учебнике используется один класс репозиторий для нескольких типов сущностей.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-229">In this tutorial, one repository class for multiple entity types is used.</span></span> <span data-ttu-id="d3cd5-230">Дополнительные сведения о шаблон репозитория см. в записях в [блог группы Entity Framework](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) и [Джули Лерман блог](http://thedatafarm.com/blog/data-access/agile-ef4-repository-part-3-fine-tuning-the-repository/).</span><span class="sxs-lookup"><span data-stu-id="d3cd5-230">For more information about the repository pattern, see the posts in [the Entity Framework team's blog](https://blogs.msdn.com/b/adonet/archive/2009/06/16/using-repository-and-unit-of-work-patterns-with-entity-framework-4-0.aspx) and [Julie Lerman's blog](http://thedatafarm.com/blog/data-access/agile-ef4-repository-part-3-fine-tuning-the-repository/).</span></span>


<span data-ttu-id="d3cd5-231">`GetDepartments` Возвращает `IEnumerable` объекта, а не `IQueryable` объекта, для того чтобы убедиться, что возвращаемой коллекции можно использовать, даже после удаления самого объекта репозитория.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-231">The `GetDepartments` method returns an `IEnumerable` object rather than an `IQueryable` object in order to ensure that the returned collection is usable even after the repository object itself is disposed.</span></span> <span data-ttu-id="d3cd5-232">`IQueryable` Объекта может привести к доступ к базе данных каждый раз, когда осуществляется, но объект репозитория может быть удален при попытке элемента управления с привязкой к данным для отображения данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-232">An `IQueryable` object can cause database access whenever it's accessed, but the repository object might be disposed by the time a databound control attempts to render the data.</span></span> <span data-ttu-id="d3cd5-233">Может вернуть другой тип коллекции, такие как `IList` объекта вместо `IEnumerable` объекта.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-233">You could return another collection type, such as an `IList` object instead of an `IEnumerable` object.</span></span> <span data-ttu-id="d3cd5-234">Тем не менее, возвращая `IEnumerable` объекта гарантирует, такие как выполнение задачи обработки типичных только для чтения список `foreach` циклы и запросы LINQ, но нельзя добавить или удалить элементы из коллекции может подразумеваться, что такие изменения будет сохранить в базе данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-234">However, returning an `IEnumerable` object ensures that you can perform typical read-only list processing tasks such as `foreach` loops and LINQ queries, but you cannot add to or remove items in the collection, which might imply that such changes would be persisted to the database.</span></span>

<span data-ttu-id="d3cd5-235">Создание *Departments.aspx* страницы, использующей *Site.Master* главную страницу и добавьте следующую разметку в `Content` управления с именем `Content2`:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-235">Create a *Departments.aspx* page that uses the *Site.Master* master page, and add the following markup in the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample3.aspx)]

<span data-ttu-id="d3cd5-236">Эта разметка создает `ObjectDataSource` управления, использующий класс репозитория, который вы только что создали, и `GridView` элемента управления для отображения данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-236">This markup creates an `ObjectDataSource` control that uses the repository class you just created, and a `GridView` control to display the data.</span></span> <span data-ttu-id="d3cd5-237">`GridView` Элемент управления задает **изменить** и **удалить** команды, но не был добавлен код, чтобы еще поддерживается.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-237">The `GridView` control specifies **Edit** and **Delete** commands, but you haven't added code to support them yet.</span></span>

<span data-ttu-id="d3cd5-238">Используйте несколько столбцов `DynamicField` элементы управления, чтобы воспользоваться преимуществами данных автоматического форматирования и проверки функциональности.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-238">Several columns use `DynamicField` controls so that you can take advantage of automatic data formatting and validation functionality.</span></span> <span data-ttu-id="d3cd5-239">Для их работы, необходимо вызвать `EnableDynamicData` метод в `Page_Init` обработчика событий.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-239">For these to work, you will have to call the `EnableDynamicData` method in the `Page_Init` event handler.</span></span> <span data-ttu-id="d3cd5-240">(`DynamicControl` элементы не используются в `Administrator` поле, так как они не работают со свойствами навигации.)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-240">(`DynamicControl` controls are not used in the `Administrator` field because they don't work with navigation properties.)</span></span>

<span data-ttu-id="d3cd5-241">`Vertical-Align="Top"` Атрибутов может быть важно позже при добавлении столбца, имеющего вложенный `GridView` элемента управления в сетке.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-241">The `Vertical-Align="Top"` attributes will become important later when you add a column that has a nested `GridView` control to the grid.</span></span>

<span data-ttu-id="d3cd5-242">Откройте *Departments.aspx.cs* файл и добавьте следующее `using` инструкции:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-242">Open the *Departments.aspx.cs* file and add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample4.cs)]

<span data-ttu-id="d3cd5-243">Затем добавьте следующий обработчик для страницы `Init` событий:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-243">Then add the following handler for the page's `Init` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample5.cs)]

<span data-ttu-id="d3cd5-244">В *DAL* папки, создайте новый файл класса с именем *Department.cs* и замените существующий код следующим кодом:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-244">In the *DAL* folder, create a new class file named *Department.cs* and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample6.cs)]

<span data-ttu-id="d3cd5-245">Этот код добавляет метаданные в модель данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-245">This code adds metadata to the data model.</span></span> <span data-ttu-id="d3cd5-246">Указывает, что `Budget` свойство `Department` сущности фактически представляет валюту, несмотря на то, что его тип данных — `Decimal`, оно указывает, что значение должно быть между 0 и 1,000,000.00 $.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-246">It specifies that the `Budget` property of the `Department` entity actually represents currency although its data type is `Decimal`, and it specifies that the value must be between 0 and $1,000,000.00.</span></span> <span data-ttu-id="d3cd5-247">Также указывает, что `StartDate` свойства должен иметь формат даты в формате мм/дд/гггг.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-247">It also specifies that the `StartDate` property should be formatted as a date in the format mm/dd/yyyy.</span></span>

<span data-ttu-id="d3cd5-248">Запустите *Departments.aspx* страницы.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-248">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="d3cd5-249">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image26.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-249">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image26.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image25.png)</span></span>

<span data-ttu-id="d3cd5-250">Обратите внимание, что, несмотря на то, что не было указано в строке формата *Departments.aspx* разметку страницы для **бюджета** или **Дата начала** столбцы, по умолчанию, валюты и даты форматирование, примененных к ним, `DynamicField` элементов управления, используя метаданные, предоставленные в *Department.cs* файла.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-250">Notice that although you did not specify a format string in the *Departments.aspx* page markup for the **Budget** or **Start Date** columns, default currency and date formatting has been applied to them by the `DynamicField` controls, using the metadata that you supplied in the *Department.cs* file.</span></span>

## <a name="adding-insert-and-delete-functionality"></a><span data-ttu-id="d3cd5-251">Добавление Insert и Delete функциональные возможности</span><span class="sxs-lookup"><span data-stu-id="d3cd5-251">Adding Insert and Delete Functionality</span></span>

<span data-ttu-id="d3cd5-252">Откройте *SchoolRepository.cs*, добавьте следующий код для создания `Insert` метод и `Delete` метод.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-252">Open *SchoolRepository.cs*, add the following code in order to create an `Insert` method and a `Delete` method.</span></span> <span data-ttu-id="d3cd5-253">Код также содержит метод с именем `GenerateDepartmentID` , вычисляет следующей доступной записи значение ключа для использования `Insert` метод.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-253">The code also includes a method named `GenerateDepartmentID` that calculates the next available record key value for use by the `Insert` method.</span></span> <span data-ttu-id="d3cd5-254">Это необходимо, так как база данных не настроена для вычисления автоматически для `Department` таблицы.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-254">This is required because the database is not configured to calculate this automatically for the `Department` table.</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample7.cs)]

### <a name="the-attach-method"></a><span data-ttu-id="d3cd5-255">Attach-метод</span><span class="sxs-lookup"><span data-stu-id="d3cd5-255">The Attach Method</span></span>

<span data-ttu-id="d3cd5-256">`DeleteDepartment` Вызовы метода `Attach` метод, чтобы повторно установить ссылку, которая сохраняется в контексте объекта диспетчер состояния объекта между сущностями в памяти и базу данных строки, он представляет.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-256">The `DeleteDepartment` method calls the `Attach` method in order to re-establish the link that's maintained in the object context's object state manager between the entity in memory and the database row it represents.</span></span> <span data-ttu-id="d3cd5-257">Это должно произойти перед вызовом метода `SaveChanges` метод.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-257">This must occur before the method calls the `SaveChanges` method.</span></span>

<span data-ttu-id="d3cd5-258">Термин *контекста объекта* ссылается на класс Entity Framework, который является производным от `ObjectContext` класс, используемый для доступа к наборам сущностей и сущностей.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-258">The term *object context* refers to the Entity Framework class that derives from the `ObjectContext` class that you use to access your entity sets and entities.</span></span> <span data-ttu-id="d3cd5-259">В коде для данного проекта класс с именем `SchoolEntities`, а его экземпляр всегда совпадает с именем `context`.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-259">In the code for this project, the class is named `SchoolEntities`, and an instance of it is always named `context`.</span></span> <span data-ttu-id="d3cd5-260">Контекст объекта *диспетчер состояния объекта* — это класс, производный от `ObjectStateManager` класса.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-260">The object context's *object state manager* is a class that derives from the `ObjectStateManager` class.</span></span> <span data-ttu-id="d3cd5-261">Контакт объект использует диспетчер состояния объекта, для хранения объектов сущностей и для отслеживания ли каждый из них в соответствии с его соответствующей строки таблицы или строк в базе данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-261">The object contact uses the object state manager to store entity objects and to keep track of whether each one is in sync with its corresponding table row or rows in the database.</span></span>

<span data-ttu-id="d3cd5-262">При чтении сущности контекста объекта сохраняет его в диспетчер состояния объекта и отслеживает ли это представление объекта синхронизации с базой данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-262">When you read an entity, the object context stores it in the object state manager and keeps track of whether that representation of the object is in sync with the database.</span></span> <span data-ttu-id="d3cd5-263">Например при изменении значения свойства флаг имеет значение указывает, что свойство, которое вы изменили больше не является синхронизации с базой данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-263">For example, if you change a property value, a flag is set to indicate that the property you changed is no longer in sync with the database.</span></span> <span data-ttu-id="d3cd5-264">Затем при вызове `SaveChanges` метод контекст объекта знает, что делать в базе данных, так как диспетчер состояния объекта знает именно то, что текущее состояние сущности и состояние базы данных отличаются.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-264">Then when you call the `SaveChanges` method, the object context knows what to do in the database because the object state manager knows exactly what's different between the current state of the entity and the state of the database.</span></span>

<span data-ttu-id="d3cd5-265">Тем не менее этот процесс обычно не работает в веб-приложения, так как экземпляр контекста объекта, который считывает сущности, а также все его диспетчер состояния объекта, удаляется после подготовки страницы к просмотру.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-265">However, this process typically does not work in a web application, because the object context instance that reads an entity, along with everything in its object state manager, is disposed after a page is rendered.</span></span> <span data-ttu-id="d3cd5-266">Экземпляр контекста объекта, который необходимо применить изменения является новым, экземпляр которого создается для обработки обратной передачи.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-266">The object context instance that must apply changes is a new one that's instantiated for postback processing.</span></span> <span data-ttu-id="d3cd5-267">В случае использования `DeleteDepartment` метода `ObjectDataSource` управления повторно создает исходную версию сущности из значений в состоянии представления, но это повторно создать `Department` сущность не существует в диспетчер состояния объекта.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-267">In the case of the `DeleteDepartment` method, the `ObjectDataSource` control re-creates the original version of the entity for you from values in view state, but this re-created `Department` entity does not exist in the object state manager.</span></span> <span data-ttu-id="d3cd5-268">Если вызван `DeleteObject` метод в этой сущности будет создана повторно, вызов завершится ошибкой, так как контекст объекта не знаете, является ли сущность синхронизации с базой данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-268">If you called the `DeleteObject` method on this re-created entity, the call would fail because the object context does not know whether the entity is in sync with the database.</span></span> <span data-ttu-id="d3cd5-269">Однако, при вызове `Attach` метод повторно устанавливает же отслеживания между значениями и повторно созданной сущности в базе данных, изначально было выполнено автоматически после считывания в более ранней версии экземпляра контекста объекта сущности.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-269">However, calling the `Attach` method re-establishes the same tracking between the re-created entity and the values in the database that was originally done automatically when the entity was read in an earlier instance of the object context.</span></span>

<span data-ttu-id="d3cd5-270">Существуют ситуации, когда необходимо исключить из контекста объекта для отслеживания сущностей в диспетчер состояния объекта, и можно задать флаги, чтобы предотвратить это сделать.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-270">There are times when you don't want the object context to track entities in the object state manager, and you can set flags to prevent it from doing that.</span></span> <span data-ttu-id="d3cd5-271">В качестве примера отображаются на следующих занятиях рассматривается в этой серии.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-271">Examples of this are shown in later tutorials in this series.</span></span>

### <a name="the-savechanges-method"></a><span data-ttu-id="d3cd5-272">Метод SaveChanges</span><span class="sxs-lookup"><span data-stu-id="d3cd5-272">The SaveChanges Method</span></span>

<span data-ttu-id="d3cd5-273">Этот класс простой репозиторий рассмотрены основные принципы для выполнения операций CRUD.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-273">This simple repository class illustrates basic principles of how to perform CRUD operations.</span></span> <span data-ttu-id="d3cd5-274">В этом примере `SaveChanges` метод вызывается сразу после каждого обновления.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-274">In this example, the `SaveChanges` method is called immediately after each update.</span></span> <span data-ttu-id="d3cd5-275">В реальном приложении может потребоваться вызвать `SaveChanges` метод отдельный метод, чтобы получить больший контроль над при обновлении базы данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-275">In a production application you might want to call the `SaveChanges` method from a separate method to give you more control over when the database is updated.</span></span> <span data-ttu-id="d3cd5-276">(В конце следующем уроке вы найдете ссылку на технический документ, посвященный единицы работы шаблону, который является одним из подходов для координации соответствующие обновления.) Обратите внимание, что в примере `DeleteDepartment` метода не включает код для обработки конфликтов параллелизма; будет добавлен код, чтобы сделать это позднее в этом учебнике этой серии.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-276">(At the end of the next tutorial you will find a link to a white paper that discusses the unit of work pattern which is one approach to coordinating related updates.) Notice also that in the example, the `DeleteDepartment` method does not include code for handling concurrency conflicts; code to do that will be added in a later tutorial in this series.</span></span>

### <a name="retrieving-instructor-names-to-select-when-inserting"></a><span data-ttu-id="d3cd5-277">Получение инструктора имена для выбора при вставке</span><span class="sxs-lookup"><span data-stu-id="d3cd5-277">Retrieving Instructor Names to Select When Inserting</span></span>

<span data-ttu-id="d3cd5-278">Пользователи должны быть доступны для выбора администратор список инструкторов в раскрывающемся списке при создании нового подразделения.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-278">Users must be able to select an administrator from a list of instructors in a drop-down list when creating new departments.</span></span> <span data-ttu-id="d3cd5-279">Таким образом, добавьте следующий код в *SchoolRepository.cs* Создание метода на получение списка инструкторов, с помощью представления, созданного ранее:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-279">Therefore, add the following code to *SchoolRepository.cs* to create a method to retrieve the list of instructors using the view that you created earlier:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample8.cs)]

### <a name="creating-a-page-for-inserting-departments"></a><span data-ttu-id="d3cd5-280">Создание страницы для вставки отделов</span><span class="sxs-lookup"><span data-stu-id="d3cd5-280">Creating a Page for Inserting Departments</span></span>

<span data-ttu-id="d3cd5-281">Создание *DepartmentsAdd.aspx* страницы, использующей *Site.Master* страницы и добавьте следующую разметку в `Content` управления с именем `Content2`:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-281">Create a *DepartmentsAdd.aspx* page that uses the *Site.Master* page, and add the following markup in the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample9.aspx)]

<span data-ttu-id="d3cd5-282">Эта разметка создает два `ObjectDataSource` контролирует, один для вставки новых `Department` сущностей и один для извлечения имен инструктора `DropDownList` элемент управления, используемый для выбора Администраторы отдела.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-282">This markup creates two `ObjectDataSource` controls, one for inserting new `Department` entities and one for retrieving instructor names for the `DropDownList` control that's used for selecting department administrators.</span></span> <span data-ttu-id="d3cd5-283">Разметка создает `DetailsView` управления для ввода нового подразделения и он определяет обработчик для элемента управления `ItemInserting` событий, которые можно использовать `Administrator` значение внешнего ключа.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-283">The markup creates a `DetailsView` control for entering new departments, and it specifies a handler for the control's `ItemInserting` event so that you can set the `Administrator` foreign key value.</span></span> <span data-ttu-id="d3cd5-284">По окончании `ValidationSummary` элемента управления для отображения сообщений об ошибках.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-284">At the end is a `ValidationSummary` control to display error messages.</span></span>

<span data-ttu-id="d3cd5-285">Откройте *DepartmentsAdd.aspx.cs* и добавьте следующее `using` инструкции:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-285">Open *DepartmentsAdd.aspx.cs* and add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample10.cs)]

<span data-ttu-id="d3cd5-286">Добавьте следующую переменную классов и методов:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-286">Add the following class variable and methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample11.cs)]

<span data-ttu-id="d3cd5-287">`Page_Init` Метод включает функциональные возможности платформы динамических данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-287">The `Page_Init` method enables Dynamic Data functionality.</span></span> <span data-ttu-id="d3cd5-288">Обработчик `DropDownList` элемента управления `Init` событий сохраняет ссылку на элемент управления и обработчик для `DetailsView` элемента управления `Inserting` событий использует эту ссылку, чтобы получить `PersonID` значение выбранного инструктора и обновления `Administrator` свойство внешнего ключа из `Department` сущности.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-288">The handler for the `DropDownList` control's `Init` event saves a reference to the control, and the handler for the `DetailsView` control's `Inserting` event uses that reference to get the `PersonID` value of the selected instructor and update the `Administrator` foreign key property of the `Department` entity.</span></span>

<span data-ttu-id="d3cd5-289">Запустите страницу, добавьте сведения для нового подразделения и нажмите кнопку **вставить** ссылку.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-289">Run the page, add information for a new department, and then click the **Insert** link.</span></span>

<span data-ttu-id="d3cd5-290">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image28.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-290">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image28.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image27.png)</span></span>

<span data-ttu-id="d3cd5-291">Введите значения для другого новое подразделение.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-291">Enter values for another new department.</span></span> <span data-ttu-id="d3cd5-292">Введите число больше 1,000,000.00 в **бюджета** поля и вкладки в следующее поле.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-292">Enter a number greater than 1,000,000.00 in the **Budget** field and tab to the next field.</span></span> <span data-ttu-id="d3cd5-293">В этом поле отображается звездочка, и если навести указатель мыши на его может появиться сообщение об ошибке, введенного в метаданных для этого поля.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-293">An asterisk appears in the field, and if you hold the mouse pointer over it, you can see the error message that you entered in the metadata for that field.</span></span>

<span data-ttu-id="d3cd5-294">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image30.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-294">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image30.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image29.png)</span></span>

<span data-ttu-id="d3cd5-295">Нажмите кнопку **вставить**, и появляется сообщение об ошибке `ValidationSummary` элемента управления в нижней части страницы.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-295">Click **Insert**, and you see the error message displayed by the `ValidationSummary` control at the bottom of the page.</span></span>

<span data-ttu-id="d3cd5-296">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image32.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-296">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image32.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image31.png)</span></span>

<span data-ttu-id="d3cd5-297">Затем закройте окно браузера и откройте *Departments.aspx* страницы.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-297">Next, close the browser and open the *Departments.aspx* page.</span></span> <span data-ttu-id="d3cd5-298">Реализовать возможность удаления для *Departments.aspx* страницы путем добавления `DeleteMethod` атрибут `ObjectDataSource` управления и `DataKeyNames` атрибут `GridView` элемента управления.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-298">Add delete capability to the *Departments.aspx* page by adding a `DeleteMethod` attribute to the `ObjectDataSource` control, and a `DataKeyNames` attribute to the `GridView` control.</span></span> <span data-ttu-id="d3cd5-299">Открывающие теги для этих элементов управления, теперь будет выглядеть примерно так:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-299">The opening tags for these controls will now resemble the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample12.aspx)]

<span data-ttu-id="d3cd5-300">Запустите страницу.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-300">Run the page.</span></span>

<span data-ttu-id="d3cd5-301">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image34.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-301">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image34.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image33.png)</span></span>

<span data-ttu-id="d3cd5-302">Удаление подразделения, добавленный при выполнении *DepartmentsAdd.aspx* страницы.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-302">Delete the department you added when you ran the *DepartmentsAdd.aspx* page.</span></span>

## <a name="adding-update-functionality"></a><span data-ttu-id="d3cd5-303">Добавление функциональных возможностей обновления</span><span class="sxs-lookup"><span data-stu-id="d3cd5-303">Adding Update Functionality</span></span>

<span data-ttu-id="d3cd5-304">Откройте *SchoolRepository.cs* и добавьте следующее `Update` метод:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-304">Open *SchoolRepository.cs* and add the following `Update` method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample13.cs)]

<span data-ttu-id="d3cd5-305">При нажатии кнопки **обновление** в *Departments.aspx* страницы, `ObjectDataSource` управления создает два `Department` сущностей для передачи `UpdateDepartment` метод.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-305">When you click **Update** in the *Departments.aspx* page, the `ObjectDataSource` control creates two `Department` entities to pass to the `UpdateDepartment` method.</span></span> <span data-ttu-id="d3cd5-306">Одна из них содержит исходные значения, которые сохранены в состоянии представления, а другой содержит новые значения, которые были введены в `GridView` элемента управления.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-306">One contains the original values that have been stored in view state, and the other contains the new values that were entered in the `GridView` control.</span></span> <span data-ttu-id="d3cd5-307">Код в `UpdateDepartment` метод передает `Department` сущность, которая содержит исходные значения для `Attach` метод, чтобы установить отслеживания между сущностью и возможности базы данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-307">The code in the `UpdateDepartment` method passes the `Department` entity that has the original values to the `Attach` method in order to establish the tracking between the entity and what's in the database.</span></span> <span data-ttu-id="d3cd5-308">Затем код передает `Department` сущность, которая содержит новые значения для `ApplyCurrentValues` метод.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-308">Then the code passes the `Department` entity that has the new values to the `ApplyCurrentValues` method.</span></span> <span data-ttu-id="d3cd5-309">Контекст объекта сравнивает старое и новое значения.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-309">The object context compares the old and new values.</span></span> <span data-ttu-id="d3cd5-310">Если новое значение отличается от старое, контекст объекта изменяется значение свойства.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-310">If a new value is different from an old value, the object context changes the property value.</span></span> <span data-ttu-id="d3cd5-311">`SaveChanges` Обновляет только измененные столбцы в базе данных.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-311">The `SaveChanges` method then updates only the changed columns in the database.</span></span> <span data-ttu-id="d3cd5-312">(Тем не менее, если функции обновления для этой сущности были сопоставлены с хранимой процедурой, то вся строка будет обновлено независимо от того, что столбцы были изменены.)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-312">(However, if the update function for this entity were mapped to a stored procedure, the entire row would be updated regardless of which columns were changed.)</span></span>

<span data-ttu-id="d3cd5-313">Откройте *Departments.aspx* и добавьте следующие атрибуты, чтобы `DepartmentsObjectDataSource` управления:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-313">Open the *Departments.aspx* file and add the following attributes to the `DepartmentsObjectDataSource` control:</span></span>

- `UpdateMethod="UpdateDepartment"`
- `ConflictDetection="CompareAllValues"`   
 <span data-ttu-id="d3cd5-314">Это причины старые значения сохраняются в состоянии представления, чтобы их можно сравнивать с новыми значениями в `Update` метод.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-314">This causes old values to be stored in view state so that they can be compared with the new values in the `Update` method.</span></span>
- `OldValuesParameterFormatString="orig{0}"`   
 <span data-ttu-id="d3cd5-315">Это позволяет сообщить элемента управления, имя исходного значения параметра `origDepartment` .</span><span class="sxs-lookup"><span data-stu-id="d3cd5-315">This informs the control that the name of the original values parameter is `origDepartment` .</span></span>

<span data-ttu-id="d3cd5-316">Разметку для открывающего тега элемента `ObjectDataSource` теперь элемент управления похож на приведенный ниже:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-316">The markup for the opening tag of the `ObjectDataSource` control now resembles the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample14.aspx)]

<span data-ttu-id="d3cd5-317">Добавить `OnRowUpdating="DepartmentsGridView_RowUpdating"` атрибут `GridView` элемента управления.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-317">Add an `OnRowUpdating="DepartmentsGridView_RowUpdating"` attribute to the `GridView` control.</span></span> <span data-ttu-id="d3cd5-318">Который будет использоваться для задания `Administrator` значение свойства на основе строки пользователь выбирает в раскрывающемся списке.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-318">You will use this to set the `Administrator` property value based on the row the user selects in a drop-down list.</span></span> <span data-ttu-id="d3cd5-319">`GridView` Теперь открывающий тег приведенной в следующем примере:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-319">The `GridView` opening tag now resembles the following example:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample15.aspx)]

<span data-ttu-id="d3cd5-320">Добавить `EditItemTemplate` управления `Administrator` столбец `GridView` управления сразу же после `ItemTemplate` элемента управления для этого столбца:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-320">Add an `EditItemTemplate` control for the `Administrator` column to the `GridView` control, immediately after the `ItemTemplate` control for that column:</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample16.aspx)]

<span data-ttu-id="d3cd5-321">Это `EditItemTemplate` управления аналогичен `InsertItemTemplate` управления *DepartmentsAdd.aspx* страницы.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-321">This `EditItemTemplate` control is similar to the `InsertItemTemplate` control in the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="d3cd5-322">Различие заключается в том, что исходное значение элемента управления устанавливается с помощью `SelectedValue` атрибута.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-322">The difference is that the initial value of the control is set using the `SelectedValue` attribute.</span></span>

<span data-ttu-id="d3cd5-323">Прежде чем `GridView` управления, добавьте `ValidationSummary` управления, как описано в *DepartmentsAdd.aspx* страницы.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-323">Before the `GridView` control, add a `ValidationSummary` control as you did in the *DepartmentsAdd.aspx* page.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample17.aspx)]

<span data-ttu-id="d3cd5-324">Откройте *Departments.aspx.cs* и сразу после объявления разделяемого класса, добавьте следующий код, чтобы создать частное поле для ссылки на `DropDownList` управления:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-324">Open *Departments.aspx.cs* and immediately after the partial-class declaration, add the following code to create a private field to reference the `DropDownList` control:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample18.cs)]

<span data-ttu-id="d3cd5-325">Затем добавьте обработчики для `DropDownList` элемента управления `Init` событий и `GridView` элемента управления `RowUpdating` событий:</span><span class="sxs-lookup"><span data-stu-id="d3cd5-325">Then add handlers for the `DropDownList` control's `Init` event and the `GridView` control's `RowUpdating` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/samples/sample19.cs)]

<span data-ttu-id="d3cd5-326">Обработчик `Init` событий сохраняет ссылку на `DropDownList` элемента управления в поле класса.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-326">The handler for the `Init` event saves a reference to the `DropDownList` control in the class field.</span></span> <span data-ttu-id="d3cd5-327">Обработчик `RowUpdating` событий использует ссылку для получения значения, введенные пользователем и примените его к `Administrator` свойство `Department` сущности.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-327">The handler for the `RowUpdating` event uses the reference to get the value the user entered and apply it to the `Administrator` property of the `Department` entity.</span></span>

<span data-ttu-id="d3cd5-328">Используйте *DepartmentsAdd.aspx* страницы для добавления нового отдела, а затем запустите *Departments.aspx* и нажмите кнопку **изменить** на строку, которая была добавлена.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-328">Use the *DepartmentsAdd.aspx* page to add a new department, then run the *Departments.aspx* page and click **Edit** on the row that you added.</span></span>

> [!NOTE]
> <span data-ttu-id="d3cd5-329">Вы не сможете изменить строки, которые вы не добавляли (то есть, уже есть в базе данных), из-за недопустимых данных в базе данных. Администраторы для строк, которые были созданы с базой данных, являются учащихся.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-329">You will not be able to edit rows that you did not add (that is, that were already in the database), because of invalid data in the database; the administrators for the rows that were created with the database are students.</span></span> <span data-ttu-id="d3cd5-330">При попытке изменить один из них, вы получите страницу ошибки, который сообщает об ошибке `'InstructorsDropDownList' has a SelectedValue which is invalid because it does not exist in the list of items.`</span><span class="sxs-lookup"><span data-stu-id="d3cd5-330">If you try to edit one of them, you will get an error page that reports an error like `'InstructorsDropDownList' has a SelectedValue which is invalid because it does not exist in the list of items.`</span></span>


<span data-ttu-id="d3cd5-331">[![Image10](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image36.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-331">[![Image10](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image36.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image35.png)</span></span>

<span data-ttu-id="d3cd5-332">При вводе недопустимого **бюджета** сумму, а затем нажмите кнопку **обновление**, вы видите же звездочкой и сообщение об ошибке, в *Departments.aspx* страницы.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-332">If you enter an invalid **Budget** amount and then click **Update**, you see the same asterisk and error message that you saw in the *Departments.aspx* page.</span></span>

<span data-ttu-id="d3cd5-333">Измените значение поля или выберите другой администратор и нажмите кнопку **обновление**.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-333">Change a field value or select a different administrator and click **Update**.</span></span> <span data-ttu-id="d3cd5-334">Изменение отображается.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-334">The change is displayed.</span></span>

<span data-ttu-id="d3cd5-335">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image38.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="d3cd5-335">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image38.png)](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started/_static/image37.png)</span></span>

<span data-ttu-id="d3cd5-336">На этом завершается сведения об использовании `ObjectDataSource` элемента управления для основных CRUD (Создание, чтение, обновление и удаление) операций с платформой Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-336">This completes the introduction to using the `ObjectDataSource` control for basic CRUD (create, read, update, delete) operations with the Entity Framework.</span></span> <span data-ttu-id="d3cd5-337">После создания простого n уровневого приложения, но по-прежнему тесно связана бизнес-логики на уровень доступа к данным, что осложняет автоматическое тестирование модулей.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-337">You've built a simple n-tier application, but the business-logic layer is still tightly coupled to the data-access layer, which complicates automated unit testing.</span></span> <span data-ttu-id="d3cd5-338">В этом руководстве вы увидите, как реализовать шаблон репозитория для применения модульного тестирования.</span><span class="sxs-lookup"><span data-stu-id="d3cd5-338">In the following tutorial you'll see how to implement the repository pattern to facilitate unit testing.</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="d3cd5-339">Вперед</span><span class="sxs-lookup"><span data-stu-id="d3cd5-339">Next</span></span>](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests.md)

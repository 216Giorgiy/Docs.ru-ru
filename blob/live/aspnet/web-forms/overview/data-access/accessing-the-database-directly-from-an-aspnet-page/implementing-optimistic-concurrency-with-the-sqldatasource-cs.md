---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
title: "Реализация оптимистической блокировки в SqlDataSource (C#) | Документы Microsoft"
author: rick-anderson
description: "В этом учебнике мы просмотрите essentials управления оптимистичным параллелизмом и исследуйте его с помощью элемента управления SqlDataSource применение."
ms.author: aspnetcontent
manager: wpickett
ms.date: 02/20/2007
ms.topic: article
ms.assetid: df999966-ac48-460e-b82b-4877a57d6ab9
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
msc.type: authoredcontent
ms.openlocfilehash: 69ba9e47071956385e96a28372454a3ae93ccc89
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/10/2017
---
<a name="implementing-optimistic-concurrency-with-the-sqldatasource-c"></a><span data-ttu-id="39f6e-103">Реализация оптимистической блокировки в SqlDataSource (C#)</span><span class="sxs-lookup"><span data-stu-id="39f6e-103">Implementing Optimistic Concurrency with the SqlDataSource (C#)</span></span>
====================
<span data-ttu-id="39f6e-104">по [Скотт Митчелл](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="39f6e-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="39f6e-105">[Загрузить пример приложения](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) или [скачать PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="39f6e-105">[Download Sample App](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) or [Download PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span></span>

> <span data-ttu-id="39f6e-106">В этом учебнике мы просмотрите essentials управления оптимистичным параллелизмом и исследуйте его с помощью элемента управления SqlDataSource применение.</span><span class="sxs-lookup"><span data-stu-id="39f6e-106">In this tutorial we review the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource control.</span></span>


## <a name="introduction"></a><span data-ttu-id="39f6e-107">Вступление</span><span class="sxs-lookup"><span data-stu-id="39f6e-107">Introduction</span></span>

<span data-ttu-id="39f6e-108">В предыдущем учебнике мы рассмотрели, как добавить вставки, обновления и удаления возможности для управления SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="39f6e-108">In the preceding tutorial we examined how to add inserting, updating, and deleting capabilities to the SqlDataSource control.</span></span> <span data-ttu-id="39f6e-109">Иными словами, для обеспечения этих функций необходимо указать соответствующий `INSERT`, `UPDATE`, или `DELETE` инструкции SQL в элементе управления s `InsertCommand`, `UpdateCommand`, или `DeleteCommand` свойства, вместе с необходимым параметры в `InsertParameters`, `UpdateParameters`, и `DeleteParameters` коллекции.</span><span class="sxs-lookup"><span data-stu-id="39f6e-109">In short, to provide these features we needed to specify the corresponding `INSERT`, `UPDATE`, or `DELETE` SQL statement in the control s `InsertCommand`, `UpdateCommand`, or `DeleteCommand` properties, along with the appropriate parameters in the `InsertParameters`, `UpdateParameters`, and `DeleteParameters` collections.</span></span> <span data-ttu-id="39f6e-110">Хотя эти свойства и коллекции можно указать вручную, «мастер настройки источника данных s Дополнительно» предлагает сформировать `INSERT`, `UPDATE`, и `DELETE` на основе флажок инструкций, который будет автоматически создавать эти инструкции `SELECT` инструкции.</span><span class="sxs-lookup"><span data-stu-id="39f6e-110">While these properties and collections can be specified manually, the Configure Data Source wizard s Advanced button offers a Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox that will auto-create these statements based on the `SELECT` statement.</span></span>

<span data-ttu-id="39f6e-111">А также формирования `INSERT`, `UPDATE`, и `DELETE` флажок инструкций, в диалоговом окне Дополнительные параметры создания SQL включает параметр использования оптимистичного параллелизма (см. рис. 1).</span><span class="sxs-lookup"><span data-stu-id="39f6e-111">Along with the Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox, the Advanced SQL Generation Options dialog box includes a Use optimistic concurrency option (see Figure 1).</span></span> <span data-ttu-id="39f6e-112">Если флажок установлен, `WHERE` предложения в автоматически сформированного `UPDATE` и `DELETE` инструкции изменены для только обновления или удаления если базовой t изменялся данных базы данных были изменены с момента пользователя последней загрузки данных в сетку.</span><span class="sxs-lookup"><span data-stu-id="39f6e-112">When checked, the `WHERE` clauses in the autogenerated `UPDATE` and `DELETE` statements are modified to only perform the update or delete if the underlying database data hasn t been modified since the user last loaded the data into the grid.</span></span>


![Вы можете добавить поддержку оптимистичный параллелизм с расширенными диалоговое окно параметров создания SQL](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.gif)

<span data-ttu-id="39f6e-114">**Рис. 1**: вы можете добавить поддержку оптимистичный параллелизм с расширенными диалоговое окно параметров создания SQL</span><span class="sxs-lookup"><span data-stu-id="39f6e-114">**Figure 1**: You Can Add Optimistic Concurrency Support from the Advanced SQL Generation Options Dialog Box</span></span>


<span data-ttu-id="39f6e-115">В [реализации оптимистичного параллелизма](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) учебника мы рассмотрели основные принципы управления оптимистичным параллелизмом и как добавить его в элемент управления ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="39f6e-115">Back in the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial we examined the fundamentals of optimistic concurrency control and how to add it to the ObjectDataSource.</span></span> <span data-ttu-id="39f6e-116">В этом учебнике мы ретуширование основные моменты управления оптимистичным параллелизмом и исследуйте его с помощью SqlDataSource реализации.</span><span class="sxs-lookup"><span data-stu-id="39f6e-116">In this tutorial we'll retouch on the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource.</span></span>

## <a name="a-recap-of-optimistic-concurrency"></a><span data-ttu-id="39f6e-117">Повторение оптимистичного параллелизма</span><span class="sxs-lookup"><span data-stu-id="39f6e-117">A Recap of Optimistic Concurrency</span></span>

<span data-ttu-id="39f6e-118">Для веб-приложений, позволяющих нескольким одновременно работающих пользователей, чтобы изменить или удалить те же данные, существует вероятность того, что один пользователь может случайно перезаписан другой s изменения.</span><span class="sxs-lookup"><span data-stu-id="39f6e-118">For web applications that allow multiple, simultaneous users to edit or delete the same data, there exists a possibility that one user may accidentally overwrite another s changes.</span></span> <span data-ttu-id="39f6e-119">В [реализации оптимистичного параллелизма](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) учебника были предоставлены в следующем примере:</span><span class="sxs-lookup"><span data-stu-id="39f6e-119">In the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial I provided the following example:</span></span>

<span data-ttu-id="39f6e-120">Предположим, что два пользователя, Цзисунь и Сэм, одновременно открыли страницу приложения, позволяющего посетителям обновлять и удалять продукты с помощью элемента управления GridView.</span><span class="sxs-lookup"><span data-stu-id="39f6e-120">Imagine that two users, Jisun and Sam, were both visiting a page in an application that allowed visitors to update and delete products through a GridView control.</span></span> <span data-ttu-id="39f6e-121">В то время как нажмите кнопку редактирования для товара.</span><span class="sxs-lookup"><span data-stu-id="39f6e-121">Both click the Edit button for Chai around the same time.</span></span> <span data-ttu-id="39f6e-122">Цзисунь изменяет название продукта на Чай и нажатии кнопки "Обновить".</span><span class="sxs-lookup"><span data-stu-id="39f6e-122">Jisun changes the product name to Chai Tea and clicks the Update button.</span></span> <span data-ttu-id="39f6e-123">Конечным результатом становится `UPDATE` отправляемая базу данных, которая задает *все* полей обновляемый продукт s (несмотря на то, что Цзисунь изменил только одно поле `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="39f6e-123">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product s updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="39f6e-124">На данный момент времени базы данных содержит значения Чай, категория напитков жидкости экзотические поставщика, и так далее для этого продукта.</span><span class="sxs-lookup"><span data-stu-id="39f6e-124">At this point in time, the database has the values Chai Tea, the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="39f6e-125">Тем не менее, на экране s Sam GridView по-прежнему показывает название продукта в редактируемой строке GridView как Chai.</span><span class="sxs-lookup"><span data-stu-id="39f6e-125">However, the GridView on Sam s screen still shows the product name in the editable GridView row as Chai.</span></span> <span data-ttu-id="39f6e-126">Через несколько секунд после Цзисунь s изменения были зафиксированы, Сэм обновляет категорию для приправы и последнее обновление.</span><span class="sxs-lookup"><span data-stu-id="39f6e-126">A few seconds after Jisun s changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="39f6e-127">В результате `UPDATE` инструкции, отправляемые в базу данных, задает имя продукта Chai `CategoryID` соответствующий идентификатор категории приправы и т. д.</span><span class="sxs-lookup"><span data-stu-id="39f6e-127">This results in an `UPDATE` statement sent to the database that sets the product name to Chai, the `CategoryID` to the corresponding Condiments category ID, and so on.</span></span> <span data-ttu-id="39f6e-128">Изменения s Цзисунь названия продукта были перезаписаны.</span><span class="sxs-lookup"><span data-stu-id="39f6e-128">Jisun s changes to the product name have been overwritten.</span></span>

<span data-ttu-id="39f6e-129">На рисунке 2 показано это взаимодействие.</span><span class="sxs-lookup"><span data-stu-id="39f6e-129">Figure 2 illustrates this interaction.</span></span>


<span data-ttu-id="39f6e-130">[![Если два пользователя одновременно обновить запись существует s потенциальных для одного пользователя s изменений перезаписать другие устройства](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="39f6e-130">[![When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span></span>

<span data-ttu-id="39f6e-131">**На рисунке 2**: при двух пользователей одновременно обновление существует запись s потенциал для одного пользователя s изменений перезаписать другие устройства ([Просмотр полноразмерное изображение](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="39f6e-131">**Figure 2**: When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span></span>


<span data-ttu-id="39f6e-132">Чтобы предотвратить unfolding форму этот сценарий [управления параллелизмом](http://en.wikipedia.org/wiki/Concurrency_control) должен быть реализован.</span><span class="sxs-lookup"><span data-stu-id="39f6e-132">To prevent this scenario from unfolding, a form of [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) must be implemented.</span></span> <span data-ttu-id="39f6e-133">[Оптимистический параллелизм](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) фокус этого учебника работает на предположении, что конфликты параллелизма может быть и, большая часть времени, такой конфликт выиграл t возникнуть.</span><span class="sxs-lookup"><span data-stu-id="39f6e-133">[Optimistic concurrency](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) the focus of this tutorial works on the assumption that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won t arise.</span></span> <span data-ttu-id="39f6e-134">Таким образом Если конфликт возникает, управление оптимистичным параллелизмом просто пользователю сохранить их изменения могут t, поскольку другой пользователь изменил те же данные.</span><span class="sxs-lookup"><span data-stu-id="39f6e-134">Therefore, if a conflict does arise, optimistic concurrency control simply informs the user that their changes can t be saved because another user has modified the same data.</span></span>

> [!NOTE]
> <span data-ttu-id="39f6e-135">Для приложений, где предполагается, что будет много конфликтов параллелизма, или если такие конфликты не являются приемлемой то управление пессимистичным параллелизмом может использоваться вместо этого.</span><span class="sxs-lookup"><span data-stu-id="39f6e-135">For applications where it is assumed that there will be many concurrency conflicts or if such conflicts are not tolerable, then pessimistic concurrency control can be used instead.</span></span> <span data-ttu-id="39f6e-136">Обращаться к [реализации оптимистичного параллелизма](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) учебника более подробное описание на управление пессимистичным параллелизмом.</span><span class="sxs-lookup"><span data-stu-id="39f6e-136">Refer back to the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial for a more thorough discussion on pessimistic concurrency control.</span></span>


<span data-ttu-id="39f6e-137">Управление оптимистичным параллелизмом работает за счет того, что запись обновляемой или удаляемой имеет те же значения, как и при запуске процесса обновления или удаления.</span><span class="sxs-lookup"><span data-stu-id="39f6e-137">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="39f6e-138">Например при нажатии кнопки «изменить» в изменяемого элемента управления GridView, запись s чтение из базы данных и отображения значений в текстовые поля и другие веб-элементов управления.</span><span class="sxs-lookup"><span data-stu-id="39f6e-138">For example, when clicking the Edit button in an editable GridView, the record s values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="39f6e-139">Эти исходные значения сохраняются в GridView.</span><span class="sxs-lookup"><span data-stu-id="39f6e-139">These original values are saved by the GridView.</span></span> <span data-ttu-id="39f6e-140">Позже, после пользователь делает своих изменений и нажимает кнопку обновления `UPDATE` используется инструкция необходимо учитывать исходные и новые значения и обновить только базовой записи базы данных, если исходные значения, что пользователь начал редактирование совпадают со значениями в базе данных.</span><span class="sxs-lookup"><span data-stu-id="39f6e-140">Later, after the user makes her changes and clicks the Update button, the `UPDATE` statement used must take into account the original values plus the new values and only update the underlying database record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="39f6e-141">На рисунке 3 показана эта последовательность событий.</span><span class="sxs-lookup"><span data-stu-id="39f6e-141">Figure 3 depicts this sequence of events.</span></span>


<span data-ttu-id="39f6e-142">[![Для инструкции Update или Delete для успешного выполнения и установка исходных значений должно быть равно текущими значениями базы данных](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="39f6e-142">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span></span>

<span data-ttu-id="39f6e-143">**Рис. 3**: для обновления или удаления выполняются успешно, исходные значения должен быть равен текущими значениями базы данных ([Просмотр полноразмерное изображение](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="39f6e-143">**Figure 3**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span></span>


<span data-ttu-id="39f6e-144">Существуют различные подходы к реализации оптимистичного параллелизма (см. [в статье](http://www.eggheadcafe.com/articles/pbrombergresume.asp) s [Optmistic параллелизма обновление логики](http://www.eggheadcafe.com/articles/20050719.asp) для кратко рассмотрим несколько параметров).</span><span class="sxs-lookup"><span data-stu-id="39f6e-144">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp) s [Optmistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="39f6e-145">Метод, используемый в SqlDataSource (а также ADO.NET типизированные наборы данных, используемые в наших уровня доступа к данным) расширяет `WHERE` предложение сравнением всех исходных значений.</span><span class="sxs-lookup"><span data-stu-id="39f6e-145">The technique used by the SqlDataSource (as well as by the ADO.NET Typed DataSets used in our Data Access Layer) augments the `WHERE` clause to include a comparison of all of the original values.</span></span> <span data-ttu-id="39f6e-146">Следующие `UPDATE` инструкции, например, обновляет имя и цену продукта, только в том случае, если текущие значения базы данных равны значениям, которые изначально были получены при обновлении записи в GridView.</span><span class="sxs-lookup"><span data-stu-id="39f6e-146">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="39f6e-147">`@ProductName` И `@UnitPrice` параметры содержат новые значения, введенные пользователем, в то время как `@original_ProductName` и `@original_UnitPrice` содержат значения, которые изначально были загружены в GridView, если была нажата кнопка "Изменить":</span><span class="sxs-lookup"><span data-stu-id="39f6e-147">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample1.sql)]

<span data-ttu-id="39f6e-148">Как будет показано в этом учебнике, Включение управления оптимистичным параллелизмом с SqlDataSource — простая установка флажка.</span><span class="sxs-lookup"><span data-stu-id="39f6e-148">As we'll see in this tutorial, enabling optimistic concurrency control with the SqlDataSource is as simple as checking a checkbox.</span></span>

## <a name="step-1-creating-a-sqldatasource-that-supports-optimistic-concurrency"></a><span data-ttu-id="39f6e-149">Шаг 1: Создание SqlDataSource, который поддерживает оптимистичный параллелизм</span><span class="sxs-lookup"><span data-stu-id="39f6e-149">Step 1: Creating a SqlDataSource that Supports Optimistic Concurrency</span></span>

<span data-ttu-id="39f6e-150">Сначала откройте `OptimisticConcurrency.aspx` страницу `SqlDataSource` папки.</span><span class="sxs-lookup"><span data-stu-id="39f6e-150">Start by opening the `OptimisticConcurrency.aspx` page from the `SqlDataSource` folder.</span></span> <span data-ttu-id="39f6e-151">Перетащите элемент управления SqlDataSource из области элементов в конструктор, параметры его `ID` свойства `ProductsDataSourceWithOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="39f6e-151">Drag a SqlDataSource control from the Toolbox onto the Designer, settings its `ID` property to `ProductsDataSourceWithOptimisticConcurrency`.</span></span> <span data-ttu-id="39f6e-152">Затем щелкните по ссылке настройки источника данных из элемента управления s смарт-тег.</span><span class="sxs-lookup"><span data-stu-id="39f6e-152">Next, click on the Configure Data Source link from the control s smart tag.</span></span> <span data-ttu-id="39f6e-153">На первом экране мастера, выберите для работы с `NORTHWINDConnectionString` и нажмите кнопку Далее.</span><span class="sxs-lookup"><span data-stu-id="39f6e-153">From the first screen in the wizard, choose to work with the `NORTHWINDConnectionString` and click Next.</span></span>


<span data-ttu-id="39f6e-154">[![Выберите для работы с NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="39f6e-154">[![Choose to Work with the NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span></span>

<span data-ttu-id="39f6e-155">**Рис. 4**: выберите для работы с `NORTHWINDConnectionString` ([Просмотр полноразмерное изображение](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="39f6e-155">**Figure 4**: Choose to Work with the `NORTHWINDConnectionString` ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span></span>


<span data-ttu-id="39f6e-156">В этом примере мы будем добавлять GridView, который позволяет пользователям редактировать `Products` таблицы.</span><span class="sxs-lookup"><span data-stu-id="39f6e-156">For this example we'll be adding a GridView that enables users to edit the `Products` table.</span></span> <span data-ttu-id="39f6e-157">Таким образом, Настройка экрана инструкции Select, выберите `Products` таблицу из раскрывающегося списка и выберите `ProductID`, `ProductName`, `UnitPrice`, и `Discontinued` столбцов, как показано на рисунке 5.</span><span class="sxs-lookup"><span data-stu-id="39f6e-157">Therefore, from the Configure the Select Statement screen, choose the `Products` table from the drop-down list and select the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` columns, as shown in Figure 5.</span></span>


<span data-ttu-id="39f6e-158">[![Из таблицы Products возвращаемое ProductID, ProductName, UnitPrice и неподдерживаемые столбцы](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="39f6e-158">[![From the Products Table, Return the ProductID, ProductName, UnitPrice, and Discontinued Columns](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span></span>

<span data-ttu-id="39f6e-159">**Рис. 5**: от `Products` таблицы, возвращаемые `ProductID`, `ProductName`, `UnitPrice`, и `Discontinued` столбцы ([Просмотр полноразмерное изображение](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="39f6e-159">**Figure 5**: From the `Products` Table, Return the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` Columns ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span></span>


<span data-ttu-id="39f6e-160">После выбора столбцов, нажмите кнопку "Дополнительно", чтобы открыть диалоговое окно «Дополнительные параметры создания SQL».</span><span class="sxs-lookup"><span data-stu-id="39f6e-160">After picking the columns, click the Advanced button to bring up the Advanced SQL Generation Options dialog box.</span></span> <span data-ttu-id="39f6e-161">Проверьте формирования `INSERT`, `UPDATE`, и `DELETE` инструкций используйте флажки оптимистичного параллелизма и нажмите кнопку ОК (приведены обратно на рис. 1 снимок экрана).</span><span class="sxs-lookup"><span data-stu-id="39f6e-161">Check the Generate `INSERT`, `UPDATE`, and `DELETE` statements and Use optimistic concurrency checkboxes and click OK (refer back to Figure 1 for a screenshot).</span></span> <span data-ttu-id="39f6e-162">Завершите работу мастера, нажав кнопку Далее и Готово.</span><span class="sxs-lookup"><span data-stu-id="39f6e-162">Complete the wizard by clicking Next, then Finish.</span></span>

<span data-ttu-id="39f6e-163">После завершения работы мастера настройки источника данных теперь пора проверить итоговое `DeleteCommand` и `UpdateCommand` свойства и `DeleteParameters` и `UpdateParameters` коллекции.</span><span class="sxs-lookup"><span data-stu-id="39f6e-163">After completing the Configure Data Source wizard, take a moment to examine the resulting `DeleteCommand` and `UpdateCommand` properties and the `DeleteParameters` and `UpdateParameters` collections.</span></span> <span data-ttu-id="39f6e-164">Для этого проще всего щелкните на вкладке "источник" в левом нижнем углу для просмотра страницы s декларативного синтаксиса.</span><span class="sxs-lookup"><span data-stu-id="39f6e-164">The easiest way to do this is to click on the Source tab in the lower left corner to see the page s declarative syntax.</span></span> <span data-ttu-id="39f6e-165">Приведены `UpdateCommand` значение:</span><span class="sxs-lookup"><span data-stu-id="39f6e-165">There you will find an `UpdateCommand` value of:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample2.sql)]

<span data-ttu-id="39f6e-166">С семь параметров в `UpdateParameters` коллекции:</span><span class="sxs-lookup"><span data-stu-id="39f6e-166">With seven parameters in the `UpdateParameters` collection:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample3.aspx)]

<span data-ttu-id="39f6e-167">Аналогичным образом `DeleteCommand` свойство и `DeleteParameters` коллекции должен выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="39f6e-167">Similarly, the `DeleteCommand` property and `DeleteParameters` collection should look like the following:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample4.sql)]


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample5.aspx)]

<span data-ttu-id="39f6e-168">Помимо расширения `WHERE` предложения `UpdateCommand` и `DeleteCommand` свойства (и добавление дополнительных параметров в коллекции соответствующего параметра), выбрав использование оптимистичного параллелизма параметр регулирует двух других Свойства:</span><span class="sxs-lookup"><span data-stu-id="39f6e-168">In addition to augmenting the `WHERE` clauses of the `UpdateCommand` and `DeleteCommand` properties (and adding the additional parameters to the respective parameter collections), selecting the Use optimistic concurrency option adjusts two other properties:</span></span>

- <span data-ttu-id="39f6e-169">Изменения [ `ConflictDetection` свойство](https://msdn.microsoft.com/en-US/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) из `OverwriteChanges` (по умолчанию) для`CompareAllValues`</span><span class="sxs-lookup"><span data-stu-id="39f6e-169">Changes the [`ConflictDetection` property](https://msdn.microsoft.com/en-US/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) from `OverwriteChanges` (the default) to `CompareAllValues`</span></span>
- <span data-ttu-id="39f6e-170">Изменения [ `OldValuesParameterFormatString` свойство](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) из {0} (по умолчанию) исходный\_{0}.</span><span class="sxs-lookup"><span data-stu-id="39f6e-170">Changes the [`OldValuesParameterFormatString` property](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) from {0} (the default) to original\_{0} .</span></span>

<span data-ttu-id="39f6e-171">Когда данные веб-элемент управления вызывает SqlDataSource s `Update()` или `Delete()` метод, он передает исходные значения.</span><span class="sxs-lookup"><span data-stu-id="39f6e-171">When the data Web control invokes the SqlDataSource s `Update()` or `Delete()` method, it passes in the original values.</span></span> <span data-ttu-id="39f6e-172">Если SqlDataSource s `ConflictDetection` свойству `CompareAllValues`, эти исходные значения добавляются в команду.</span><span class="sxs-lookup"><span data-stu-id="39f6e-172">If the SqlDataSource s `ConflictDetection` property is set to `CompareAllValues`, these original values are added to the command.</span></span> <span data-ttu-id="39f6e-173">`OldValuesParameterFormatString` Свойство предоставляет шаблон именования, использовать эти исходные значения параметров.</span><span class="sxs-lookup"><span data-stu-id="39f6e-173">The `OldValuesParameterFormatString` property provides the naming pattern used for these original value parameters.</span></span> <span data-ttu-id="39f6e-174">Мастер настройки источника данных использует исходное\_{0} и имена каждого исходного параметра `UpdateCommand` и `DeleteCommand` свойства и `UpdateParameters` и `DeleteParameters` коллекций соответствующим образом.</span><span class="sxs-lookup"><span data-stu-id="39f6e-174">The Configure Data Source wizard uses original\_{0} and names each original parameter in the `UpdateCommand` and `DeleteCommand` properties and `UpdateParameters` and `DeleteParameters` collections accordingly.</span></span>

> [!NOTE]
> <span data-ttu-id="39f6e-175">Поскольку мы повторно не использует s управления SqlDataSource, вставка возможности, вы можете удалить `InsertCommand` свойство и его `InsertParameters` коллекции.</span><span class="sxs-lookup"><span data-stu-id="39f6e-175">Since we re not using the SqlDataSource control s inserting capabilities, feel free to remove the `InsertCommand` property and its `InsertParameters` collection.</span></span>


## <a name="correctly-handlingnullvalues"></a><span data-ttu-id="39f6e-176">Для правильной обработки`NULL`значения</span><span class="sxs-lookup"><span data-stu-id="39f6e-176">Correctly Handling`NULL`Values</span></span>

<span data-ttu-id="39f6e-177">К сожалению, расширенная `UPDATE` и `DELETE` сделать автоматически инструкций, созданных с помощью мастера настройки источника данных при использовании оптимистичного параллелизма *не* работают с записи, содержащие `NULL` значения.</span><span class="sxs-lookup"><span data-stu-id="39f6e-177">Unfortunately, the augmented `UPDATE` and `DELETE` statements autogenerated by the Configure Data Source wizard when using optimistic concurrency do *not* work with records that contain `NULL` values.</span></span> <span data-ttu-id="39f6e-178">Чтобы узнать, почему это происходит, попробуйте нашей s SqlDataSource `UpdateCommand`:</span><span class="sxs-lookup"><span data-stu-id="39f6e-178">To see why, consider our SqlDataSource s `UpdateCommand`:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample6.sql)]

<span data-ttu-id="39f6e-179">`UnitPrice` Столбца в `Products` таблица может иметь `NULL` значения.</span><span class="sxs-lookup"><span data-stu-id="39f6e-179">The `UnitPrice` column in the `Products` table can have `NULL` values.</span></span> <span data-ttu-id="39f6e-180">Если имеет определенную запись `NULL` значение для `UnitPrice`, `WHERE` часть предложения `[UnitPrice] = @original_UnitPrice` будет *всегда* возвращают значение False, так как `NULL = NULL` всегда возвращает значение False.</span><span class="sxs-lookup"><span data-stu-id="39f6e-180">If a particular record has a `NULL` value for `UnitPrice`, the `WHERE` clause portion `[UnitPrice] = @original_UnitPrice` will *always* evaluate to False because `NULL = NULL` always returns False.</span></span> <span data-ttu-id="39f6e-181">Таким образом, записи, содержащие `NULL` значения нельзя изменить или удалить, как `UPDATE` и `DELETE` инструкций `WHERE` предложений выиграл t возвращают все строки для обновления или удаления.</span><span class="sxs-lookup"><span data-stu-id="39f6e-181">Therefore, records that contain `NULL` values cannot be edited or deleted, as the `UPDATE` and `DELETE` statements `WHERE` clauses won t return any rows to update or delete.</span></span>

> [!NOTE]
> <span data-ttu-id="39f6e-182">В июне 2004 г. в ошибке сначала отправлены в корпорацию Майкрософт [SqlDataSource приводит к возникновению ошибки неверные инструкций SQL](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) и сообщается планируется исправить в следующей версии ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="39f6e-182">This bug was first reported to Microsoft in June of 2004 in [SqlDataSource Generates Incorrect SQL Statements](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) and is reportedly scheduled to be fixed in the next version of ASP.NET.</span></span>


<span data-ttu-id="39f6e-183">Чтобы устранить эту проблему, необходимо вручную обновить `WHERE` предложений в обоих `UpdateCommand` и `DeleteCommand` свойства **все** столбцы, которые могут иметь `NULL` значения.</span><span class="sxs-lookup"><span data-stu-id="39f6e-183">To fix this, we have to manually update the `WHERE` clauses in both the `UpdateCommand` and `DeleteCommand` properties for **all** columns that can have `NULL` values.</span></span> <span data-ttu-id="39f6e-184">Как правило, изменять `[ColumnName] = @original_ColumnName` для:</span><span class="sxs-lookup"><span data-stu-id="39f6e-184">In general, change `[ColumnName] = @original_ColumnName` to:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample7.sql)]

<span data-ttu-id="39f6e-185">Это изменение можно непосредственно через декларативная разметка через параметры UpdateQuery или DeleteQuery из окна свойств или обновление и удаление вкладок в списке укажите пользовательские инструкции SQL или параметр хранимых процедур в данных, Настройка Мастер источников.</span><span class="sxs-lookup"><span data-stu-id="39f6e-185">This modification can be made directly through the declarative markup, via the UpdateQuery or DeleteQuery options from the Properties window, or through the UPDATE and DELETE tabs in the Specify a custom SQL statement or stored procedure option in the Configure Data Source wizard.</span></span> <span data-ttu-id="39f6e-186">Опять же, это изменение должно быть выполнено для *каждого* столбца в `UpdateCommand` и `DeleteCommand` s `WHERE` предложение, которое может содержать `NULL` значения.</span><span class="sxs-lookup"><span data-stu-id="39f6e-186">Again, this modification must be made for *every* column in the `UpdateCommand` and `DeleteCommand` s `WHERE` clause that can contain `NULL` values.</span></span>

<span data-ttu-id="39f6e-187">Применение это в нашем примере результаты в следующий измененный `UpdateCommand` и `DeleteCommand` значения:</span><span class="sxs-lookup"><span data-stu-id="39f6e-187">Applying this to our example results in the following modified `UpdateCommand` and `DeleteCommand` values:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample8.sql)]

## <a name="step-2-adding-a-gridview-with-edit-and-delete-options"></a><span data-ttu-id="39f6e-188">Шаг 2: Добавление элемента управления GridView, изменить и удалить параметры</span><span class="sxs-lookup"><span data-stu-id="39f6e-188">Step 2: Adding a GridView with Edit and Delete Options</span></span>

<span data-ttu-id="39f6e-189">SqlDataSource настроен для поддержки оптимистичного параллелизма все, что остается только добавить страницу, которая использует такое управление параллелизмом данных веб-элемента управления.</span><span class="sxs-lookup"><span data-stu-id="39f6e-189">With the SqlDataSource configured to support optimistic concurrency, all that remains is to add a data Web control to the page that utilizes this concurrency control.</span></span> <span data-ttu-id="39f6e-190">В этом учебнике позволяют добавить GridView, предоставляет оба изменения и удаления функциональные возможности.</span><span class="sxs-lookup"><span data-stu-id="39f6e-190">For this tutorial, let s add a GridView that provides both edit and delete functionality.</span></span> <span data-ttu-id="39f6e-191">Для этого перетащите элемент управления GridView с панели элементов в область конструктора и задайте его `ID` для `Products`.</span><span class="sxs-lookup"><span data-stu-id="39f6e-191">To accomplish this, drag a GridView from the Toolbox onto the Designer and set its `ID` to `Products`.</span></span> <span data-ttu-id="39f6e-192">В смарт-теге s GridView, привяжите его к `ProductsDataSourceWithOptimisticConcurrency` элемент управления SqlDataSource, добавленный на шаге 1.</span><span class="sxs-lookup"><span data-stu-id="39f6e-192">From the GridView s smart tag, bind it to the `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource control added in Step 1.</span></span> <span data-ttu-id="39f6e-193">Наконец проверьте параметры Разрешить изменение и включить удаление из смарт-тега.</span><span class="sxs-lookup"><span data-stu-id="39f6e-193">Finally, check the Enable Editing and Enable Deleting options from the smart tag.</span></span>


<span data-ttu-id="39f6e-194">[![Привязка GridView SqlDataSource и включить изменения и удаления](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="39f6e-194">[![Bind the GridView to the SqlDataSource and Enable Editing and Deleting](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span></span>

<span data-ttu-id="39f6e-195">**Рис. 6**: привязка GridView SqlDataSource и разрешить изменение и удаление ([Просмотр полноразмерное изображение](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="39f6e-195">**Figure 6**: Bind the GridView to the SqlDataSource and Enable Editing and Deleting ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span></span>


<span data-ttu-id="39f6e-196">После добавления в GridView, настроить его внешний вид, удалив `ProductID` BoundField, изменение `ProductName` BoundField s `HeaderText` свойство с продуктом и обновление `UnitPrice` BoundField, чтобы его `HeaderText` свойство просто цена.</span><span class="sxs-lookup"><span data-stu-id="39f6e-196">After adding the GridView, configure its appearance by removing the `ProductID` BoundField, changing the `ProductName` BoundField s `HeaderText` property to Product, and updating the `UnitPrice` BoundField so that its `HeaderText` property is simply Price.</span></span> <span data-ttu-id="39f6e-197">В идеальном случае мы d улучшения интерфейса для включения RequiredFieldValidator для редактирования `ProductName` значение и CompareValidator для `UnitPrice` значение (чтобы убедиться, что он s числовое значение в правильном формате).</span><span class="sxs-lookup"><span data-stu-id="39f6e-197">Ideally, we d enhance the editing interface to include a RequiredFieldValidator for the `ProductName` value and a CompareValidator for the `UnitPrice` value (to ensure it s a properly formatted numeric value).</span></span> <span data-ttu-id="39f6e-198">Ссылаться на [Настройка интерфейса изменения данных](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) учебника для более подробное рассмотрение Настройка s GridView, интерфейс для редактирования.</span><span class="sxs-lookup"><span data-stu-id="39f6e-198">Refer to the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial for a more in-depth look at customizing the GridView s editing interface.</span></span>

> [!NOTE]
> <span data-ttu-id="39f6e-199">GridView, в который должна быть включена s состояния представления, так как исходные значения передаются из GridView в SqlDataSource хранится в состоянии представления.</span><span class="sxs-lookup"><span data-stu-id="39f6e-199">The GridView s view state must be enabled since the original values passed from the GridView to the SqlDataSource are stored in view state.</span></span>


<span data-ttu-id="39f6e-200">После внесения этих изменений в GridView, GridView и SqlDataSource должна выглядеть следующим образом:</span><span class="sxs-lookup"><span data-stu-id="39f6e-200">After making these modifications to the GridView, the GridView and SqlDataSource declarative markup should look similar to the following:</span></span>


[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample9.aspx)]

<span data-ttu-id="39f6e-201">Чтобы увидеть оптимистическое управление параллелизмом в действии, откройте два окна браузера и загрузить `OptimisticConcurrency.aspx` страницы как в среде.</span><span class="sxs-lookup"><span data-stu-id="39f6e-201">To see the optimistic concurrency control in action, open two browser windows and load the `OptimisticConcurrency.aspx` page in both.</span></span> <span data-ttu-id="39f6e-202">Нажмите кнопку Правка кнопки для первого продукта в обоих браузерах.</span><span class="sxs-lookup"><span data-stu-id="39f6e-202">Click on the Edit buttons for the first product in both browsers.</span></span> <span data-ttu-id="39f6e-203">В одном браузере названия продукта и нажмите кнопку обновления.</span><span class="sxs-lookup"><span data-stu-id="39f6e-203">In one browser, change the product name and click Update.</span></span> <span data-ttu-id="39f6e-204">Браузер выполнит обратную передачу, а GridView вернется в режим его до редактирования, отображение имени продукта для записи пользуйтесь кнопками.</span><span class="sxs-lookup"><span data-stu-id="39f6e-204">The browser will postback and the GridView will return to its pre-editing mode, showing the new product name for the record just edited.</span></span>

<span data-ttu-id="39f6e-205">Во втором окне браузера изменение цены (но оставить имя продукта, исходное значение) и нажмите кнопку обновления.</span><span class="sxs-lookup"><span data-stu-id="39f6e-205">In the second browser window, change the price (but leave the product name as its original value) and click Update.</span></span> <span data-ttu-id="39f6e-206">При обратной передаче возвращает сетки для режима до редактирования, но изменения цены не записывается.</span><span class="sxs-lookup"><span data-stu-id="39f6e-206">On postback, the grid returns to its pre-editing mode, but the change to the price is not recorded.</span></span> <span data-ttu-id="39f6e-207">Второй обозреватель показано совпадает со значением первое имя продукта с старая цена.</span><span class="sxs-lookup"><span data-stu-id="39f6e-207">The second browser shows the same value as the first one the new product name with the old price.</span></span> <span data-ttu-id="39f6e-208">Изменения, внесенные во второе окно браузера были потеряны.</span><span class="sxs-lookup"><span data-stu-id="39f6e-208">The changes made in the second browser window were lost.</span></span> <span data-ttu-id="39f6e-209">Кроме того изменения были потеряны довольно просто, как была не исключение или сообщение, указывающее, что нарушение параллелизма просто произошла.</span><span class="sxs-lookup"><span data-stu-id="39f6e-209">Moreover, the changes were lost rather quietly, as there was no exception or message indicating that a concurrency violation just occurred.</span></span>


<span data-ttu-id="39f6e-210">[![Изменения во второе окно браузера были автоматически удалены](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="39f6e-210">[![The Changes in the Second Browser Window Were Silently Lost](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span></span>

<span data-ttu-id="39f6e-211">**Рис. 7**: изменения в второй браузера окна были автоматически потеряны ([Просмотр полноразмерное изображение](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="39f6e-211">**Figure 7**: The Changes in the Second Browser Window Were Silently Lost ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span></span>


<span data-ttu-id="39f6e-212">Причина, почему второй браузера s изменения не были зафиксированы был, так как `UPDATE` инструкцию s `WHERE` предложения отфильтровываются все записи и таким образом, была не затронула ни одной строки.</span><span class="sxs-lookup"><span data-stu-id="39f6e-212">The reason why the second browser s changes were not committed was because the `UPDATE` statement s `WHERE` clause filtered out all records and therefore did not affect any rows.</span></span> <span data-ttu-id="39f6e-213">Разрешить s рассмотрим `UPDATE` инструкцию:</span><span class="sxs-lookup"><span data-stu-id="39f6e-213">Let s look at the `UPDATE` statement again:</span></span>


[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample10.sql)]

<span data-ttu-id="39f6e-214">Если второе окно браузера обновляет запись, исходное имя продукта указан в `WHERE` предложение t сопоставление с существующим именем product (поскольку он был изменен первый браузером).</span><span class="sxs-lookup"><span data-stu-id="39f6e-214">When the second browser window updates the record, the original product name specified in the `WHERE` clause doesn t match up with the existing product name (since it was changed by the first browser).</span></span> <span data-ttu-id="39f6e-215">Таким образом, инструкция `[ProductName] = @original_ProductName` возвращает False и `UPDATE` не влияет на какие-либо записи.</span><span class="sxs-lookup"><span data-stu-id="39f6e-215">Therefore, the statement `[ProductName] = @original_ProductName` returns False, and the `UPDATE` does not affect any records.</span></span>

> [!NOTE]
> <span data-ttu-id="39f6e-216">Удалите работает таким же образом.</span><span class="sxs-lookup"><span data-stu-id="39f6e-216">Delete works in the same manner.</span></span> <span data-ttu-id="39f6e-217">В двух окнах браузера откройте запускаются, изменив данного продукта с одной и затем сохранение ее изменения.</span><span class="sxs-lookup"><span data-stu-id="39f6e-217">With two browser windows open, start by editing a given product with one, and then saving its changes.</span></span> <span data-ttu-id="39f6e-218">После сохранения изменений в одном браузере, нажмите кнопку «Удалить» для того же продукта в других.</span><span class="sxs-lookup"><span data-stu-id="39f6e-218">After saving the changes in the one browser, click the Delete button for the same product in the other.</span></span> <span data-ttu-id="39f6e-219">Поскольку исходные значения пункт не совпадать в `DELETE` инструкцию s `WHERE` предложение, удаление автоматически завершается ошибкой.</span><span class="sxs-lookup"><span data-stu-id="39f6e-219">Since the original values don t match up in the `DELETE` statement s `WHERE` clause, the delete silently fails.</span></span>


<span data-ttu-id="39f6e-220">С точки зрения s конечного пользователя во второе окно браузера после нажатия кнопки "Обновить" сетки возвращает режиму до редактирования, но их изменения были потеряны.</span><span class="sxs-lookup"><span data-stu-id="39f6e-220">From the end user s perspective in the second browser window, after clicking the Update button the grid returns to the pre-editing mode, but their changes were lost.</span></span> <span data-ttu-id="39f6e-221">Тем не менее существует s не визуальную обратную связь, придерживайтесь t не существовал их изменения.</span><span class="sxs-lookup"><span data-stu-id="39f6e-221">However, there s no visual feedback that their changes didn t stick.</span></span> <span data-ttu-id="39f6e-222">В идеальном случае, если пользователь s изменения теряются, нарушение параллелизма, мы d уведомлением и, возможно, сохранить сетке в режиме редактирования.</span><span class="sxs-lookup"><span data-stu-id="39f6e-222">Ideally, if a user s changes are lost to a concurrency violation, we d notify them and, perhaps, keep the grid in edit mode.</span></span> <span data-ttu-id="39f6e-223">Позволяет увидеть, как это можно сделать s.</span><span class="sxs-lookup"><span data-stu-id="39f6e-223">Let s look at how to accomplish this.</span></span>

## <a name="step-3-determining-when-a-concurrency-violation-has-occurred"></a><span data-ttu-id="39f6e-224">Шаг 3: Определение, когда произошло нарушение параллелизма</span><span class="sxs-lookup"><span data-stu-id="39f6e-224">Step 3: Determining When a Concurrency Violation Has Occurred</span></span>

<span data-ttu-id="39f6e-225">Так как нарушение параллелизма отклоняет изменения, внесенные одним, было бы неплохо для оповещения пользователя, когда произошло нарушение параллелизма.</span><span class="sxs-lookup"><span data-stu-id="39f6e-225">Since a concurrency violation rejects the changes one has made, it would be nice to alert the user when a concurrency violation has occurred.</span></span> <span data-ttu-id="39f6e-226">Для оповещения пользователя, s позволяют добавить метки веб-элемент управления в верхней части страницы, с именем `ConcurrencyViolationMessage` которого `Text` свойство отображает следующее сообщение: предпринята попытка обновить или удалить запись, которая одновременно был обновлен другим пользователем.</span><span class="sxs-lookup"><span data-stu-id="39f6e-226">To alert the user, let s add a Label Web control to the top of the page named `ConcurrencyViolationMessage` whose `Text` property displays the following message: You have attempted to update or delete a record that was simultaneously updated by another user.</span></span> <span data-ttu-id="39f6e-227">Проверьте просмотрите изменений другого пользователя и затем повторить обновление или удаление.</span><span class="sxs-lookup"><span data-stu-id="39f6e-227">Please review the other user's changes and then redo your update or delete.</span></span> <span data-ttu-id="39f6e-228">Задать элемент управления Label s `CssClass` свойства на "Предупреждение", который является классом CSS, определенного в `Styles.css` красного, курсив, полужирный и большого шрифта, который отображает текст.</span><span class="sxs-lookup"><span data-stu-id="39f6e-228">Set the Label control s `CssClass` property to Warning, which is a CSS class defined in `Styles.css` that displays text in a red, italic, bold, and large font.</span></span> <span data-ttu-id="39f6e-229">Наконец, задайте для свойства Label s `Visible` и `EnableViewState` свойства `false`.</span><span class="sxs-lookup"><span data-stu-id="39f6e-229">Finally, set the Label s `Visible` and `EnableViewState` properties to `false`.</span></span> <span data-ttu-id="39f6e-230">При этом будут скрыты метки, за исключением только обратных передач, где мы явно задать ее `Visible` свойства `true`.</span><span class="sxs-lookup"><span data-stu-id="39f6e-230">This will hide the Label except for only those postbacks where we explicitly set its `Visible` property to `true`.</span></span>


<span data-ttu-id="39f6e-231">[![Добавьте элемент управления Label на страницу, чтобы отобразить предупреждение](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="39f6e-231">[![Add a Label Control to the Page to Display the Warning](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span></span>

<span data-ttu-id="39f6e-232">**Рис. 8**: добавьте элемент управления Label на страницу, чтобы отобразить предупреждение ([Просмотр полноразмерное изображение](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="39f6e-232">**Figure 8**: Add a Label Control to the Page to Display the Warning ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span></span>


<span data-ttu-id="39f6e-233">При выполнении обновления или удаления, GridView s `RowUpdated` и `RowDeleted` обработчики событий срабатывать после его источника данных было выполнено запрошенного update или delete.</span><span class="sxs-lookup"><span data-stu-id="39f6e-233">When performing an update or delete, the GridView s `RowUpdated` and `RowDeleted` event handlers fire after its data source control has performed the requested update or delete.</span></span> <span data-ttu-id="39f6e-234">Можно определить количество строк, затронутых операцией из этих обработчиков событий.</span><span class="sxs-lookup"><span data-stu-id="39f6e-234">We can determine how many rows were affected by the operation from these event handlers.</span></span> <span data-ttu-id="39f6e-235">Если ни одна строка не изменены, мы хотим отображать `ConcurrencyViolationMessage` метки.</span><span class="sxs-lookup"><span data-stu-id="39f6e-235">If zero rows were affected, we want to display the `ConcurrencyViolationMessage` Label.</span></span>

<span data-ttu-id="39f6e-236">Создайте обработчик событий для обоих `RowUpdated` и `RowDeleted` события и добавьте следующий код:</span><span class="sxs-lookup"><span data-stu-id="39f6e-236">Create an event handler for both the `RowUpdated` and `RowDeleted` events and add the following code:</span></span>


[!code-csharp[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample11.cs)]

<span data-ttu-id="39f6e-237">В обоих обработчиков событий проверьте `e.AffectedRows` свойства и, если он равен 0, значение `ConcurrencyViolationMessage` метки s `Visible` свойства `true`.</span><span class="sxs-lookup"><span data-stu-id="39f6e-237">In both event handlers we check the `e.AffectedRows` property and, if it equals 0, set the `ConcurrencyViolationMessage` Label s `Visible` property to `true`.</span></span> <span data-ttu-id="39f6e-238">В `RowUpdated` обработчика событий, мы также, чтобы оставаться в режиме редактирования, задав GridView `KeepInEditMode` значение true.</span><span class="sxs-lookup"><span data-stu-id="39f6e-238">In the `RowUpdated` event handler, we also instruct the GridView to stay in edit mode by setting the `KeepInEditMode` property to true.</span></span> <span data-ttu-id="39f6e-239">При этом необходимо повторно привязать данные к сетке, чтобы другие данные пользователя s загружается в интерфейс редактирования.</span><span class="sxs-lookup"><span data-stu-id="39f6e-239">In doing so, we need to rebind the data to the grid so that the other user s data is loaded into the editing interface.</span></span> <span data-ttu-id="39f6e-240">Это достигается путем вызова GridView s `DataBind()` метод.</span><span class="sxs-lookup"><span data-stu-id="39f6e-240">This is accomplished by calling the GridView s `DataBind()` method.</span></span>

<span data-ttu-id="39f6e-241">Как показано на рис. 9, с помощью этих двух обработчиков очень заметных сообщение отображается каждый раз, когда происходит нарушение параллелизма.</span><span class="sxs-lookup"><span data-stu-id="39f6e-241">As Figure 9 shows, with these two event handlers, a very noticeable message is displayed whenever a concurrency violation occurs.</span></span>


<span data-ttu-id="39f6e-242">[![Сообщение отображается в случае одновременного нарушения](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="39f6e-242">[![A Message is Displayed in the Face of a Concurrency Violation](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span></span>

<span data-ttu-id="39f6e-243">**Рис. 9**: сообщение при возникновении нарушение параллелизма ([Просмотр полноразмерное изображение](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="39f6e-243">**Figure 9**: A Message is Displayed in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span></span>


## <a name="summary"></a><span data-ttu-id="39f6e-244">Сводка</span><span class="sxs-lookup"><span data-stu-id="39f6e-244">Summary</span></span>

<span data-ttu-id="39f6e-245">При создании веб-приложение, где нескольких параллельных пользователей, изменить те же данные, важно рассмотреть варианты управления параллелизмом.</span><span class="sxs-lookup"><span data-stu-id="39f6e-245">When creating a web application where multiple, concurrent users may be editing the same data, it is important to consider concurrency control options.</span></span> <span data-ttu-id="39f6e-246">По умолчанию данные ASP.NET, веб-элементов управления и элементов управления источниками данных они не отражают любой элемент управления параллелизмом.</span><span class="sxs-lookup"><span data-stu-id="39f6e-246">By default, the ASP.NET data Web controls and data source controls do not employ any concurrency control.</span></span> <span data-ttu-id="39f6e-247">Как было показано в этом учебнике, реализация управления оптимистичным параллелизмом с SqlDataSource относительно легко и быстро.</span><span class="sxs-lookup"><span data-stu-id="39f6e-247">As we saw in this tutorial, implementing optimistic concurrency control with the SqlDataSource is relatively quick and easy.</span></span> <span data-ttu-id="39f6e-248">SqlDataSource обрабатывает большую часть подготовительная работа для вашего Добавление дополнить `WHERE` предложений, чтобы автоматически сформированного `UPDATE` и `DELETE` операторов, но возникла, несколько тонкостей при обработке `NULL` значения столбцов, как описано в Для правильной обработки `NULL` значения раздела.</span><span class="sxs-lookup"><span data-stu-id="39f6e-248">The SqlDataSource handles most of the legwork for your adding augmented `WHERE` clauses to the autogenerated `UPDATE` and `DELETE` statements but there are a few subtleties in handling `NULL` value columns, as discussed in the Correctly Handling `NULL` Values section.</span></span>

<span data-ttu-id="39f6e-249">Этот учебник завершает изучение SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="39f6e-249">This tutorial concludes our examination of the SqlDataSource.</span></span> <span data-ttu-id="39f6e-250">К работе с данными, с помощью многоуровневой архитектуры и ObjectDataSource возвращает оставшиеся учебные видеоматериалы.</span><span class="sxs-lookup"><span data-stu-id="39f6e-250">Our remaining tutorials will return to working with data using the ObjectDataSource and tiered architecture.</span></span>

<span data-ttu-id="39f6e-251">Программирование довольны!</span><span class="sxs-lookup"><span data-stu-id="39f6e-251">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="39f6e-252">Об авторе</span><span class="sxs-lookup"><span data-stu-id="39f6e-252">About the Author</span></span>

<span data-ttu-id="39f6e-253">[Скотт Митчелл](http://www.4guysfromrolla.com/ScottMitchell.shtml), автор семи ASP/ASP.NET и основателя из [4GuysFromRolla.com](http://www.4guysfromrolla.com), работает с веб-технологиями Майкрософт с 1998 года.</span><span class="sxs-lookup"><span data-stu-id="39f6e-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="39f6e-254">Скотт — независимый консультант, trainer и записи.</span><span class="sxs-lookup"><span data-stu-id="39f6e-254">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="39f6e-255">Его последняя книга — [ *диспетчерами учат самостоятельно ASP.NET 2.0 в течение 24 часов*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="39f6e-255">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="39f6e-256">Он может быть достигнута по [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) или через его блог, который можно найти в [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="39f6e-256">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="39f6e-257">[Назад](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
[Вперед](querying-data-with-the-sqldatasource-control-vb.md)</span><span class="sxs-lookup"><span data-stu-id="39f6e-257">[Previous](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
[Next](querying-data-with-the-sqldatasource-control-vb.md)</span></span>
